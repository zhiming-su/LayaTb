var window = $global.window;
var document = window.document;
var XMLHttpRequest = window.XMLHttpRequest;
var Laya = window.Laya;
var Config = window.Config;
var Config3D = window.Config3D;
var Laya3D = window.Laya3D;
var performance = window.performance;
var CANNON = window.CANNON;
"use strict";function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function set(e,t,n,i){return(set="undefined"!=typeof Reflect&&Reflect.set?Reflect.set:function(e,t,n,i){var a,r=_superPropBase(e,t);if(r){if((a=Object.getOwnPropertyDescriptor(r,t)).set)return a.set.call(i,n),!0;if(!a.writable)return!1}if(a=Object.getOwnPropertyDescriptor(i,t)){if(!a.writable)return!1;a.value=n,Object.defineProperty(i,t,a)}else _defineProperty(i,t,n);return!0})(e,t,n,i)}function _set(e,t,n,i,a){if(!set(e,t,n,i||e)&&a)throw new Error("failed to set property");return n}function _defineProperty(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function _get(e,t,n){return(_get="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var i=_superPropBase(e,t);if(i){var a=Object.getOwnPropertyDescriptor(i,t);return a.get?a.get.call(n):a.value}})(e,t,n||e)}function _superPropBase(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=_getPrototypeOf(e)););return e}function _possibleConstructorReturn(e,t){return!t||"object"!==_typeof(t)&&"function"!=typeof t?_assertThisInitialized(e):t}function _assertThisInitialized(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function _getPrototypeOf(e){return(_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&_setPrototypeOf(e,t)}function _setPrototypeOf(e,t){return(_setPrototypeOf=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function _createClass(e,t,n){return t&&_defineProperties(e.prototype,t),n&&_defineProperties(e,n),e}!function(e,t){var n=function(){function MathUtils3D(){_classCallCheck(this,MathUtils3D)}return _createClass(MathUtils3D,null,[{key:"isZero",value:function(e){return Math.abs(e)<MathUtils3D.zeroTolerance}},{key:"nearEqual",value:function(e,t){return!!MathUtils3D.isZero(e-t)}},{key:"fastInvSqrt",value:function(e){return MathUtils3D.isZero(e)?e:1/Math.sqrt(e)}}]),MathUtils3D}();n.zeroTolerance=1e-6,n.MaxValue=3.40282347e38,n.MinValue=-3.40282347e38,n.Deg2Rad=Math.PI/180;var i=function(){function Vector2(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;_classCallCheck(this,Vector2),this.x=e,this.y=t}return _createClass(Vector2,[{key:"setValue",value:function(e,t){this.x=e,this.y=t}},{key:"fromArray",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;this.x=e[t+0],this.y=e[t+1]}},{key:"toArray",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;e[t+0]=this.x,e[t+1]=this.y}},{key:"cloneTo",value:function(e){var t=e;t.x=this.x,t.y=this.y}},{key:"clone",value:function(){var e=new Vector2;return this.cloneTo(e),e}},{key:"forNativeElement",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;e?(this.elements=e,this.elements[0]=this.x,this.elements[1]=this.y):this.elements=new Float32Array([this.x,this.y]),Vector2.rewriteNumProperty(this,"x",0),Vector2.rewriteNumProperty(this,"y",1)}}],[{key:"scale",value:function(e,t,n){n.x=e.x*t,n.y=e.y*t}},{key:"dot",value:function(e,t){return e.x*t.x+e.y*t.y}},{key:"normalize",value:function(e,t){var n=e.x,i=e.y,a=n*n+i*i;a>0&&(a=1/Math.sqrt(a),t.x=n*a,t.y=i*a)}},{key:"scalarLength",value:function(e){var t=e.x,n=e.y;return Math.sqrt(t*t+n*n)}},{key:"rewriteNumProperty",value:function(e,t,n){Object.defineProperty(e,t,{get:function(){return this.elements[n]},set:function(e){this.elements[n]=e}})}}]),Vector2}();i.ZERO=new i(0,0),i.ONE=new i(1,1);var a=function(){function Vector4(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;_classCallCheck(this,Vector4),this.x=e,this.y=t,this.z=n,this.w=i}return _createClass(Vector4,[{key:"setValue",value:function(e,t,n,i){this.x=e,this.y=t,this.z=n,this.w=i}},{key:"fromArray",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;this.x=e[t+0],this.y=e[t+1],this.z=e[t+2],this.w=e[t+3]}},{key:"toArray",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;e[t+0]=this.x,e[t+1]=this.y,e[t+2]=this.z,e[t+3]=this.w}},{key:"cloneTo",value:function(e){var t=e;t.x=this.x,t.y=this.y,t.z=this.z,t.w=this.w}},{key:"clone",value:function(){var e=new Vector4;return this.cloneTo(e),e}},{key:"length",value:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}},{key:"lengthSquared",value:function(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}},{key:"forNativeElement",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;e?(this.elements=e,this.elements[0]=this.x,this.elements[1]=this.y,this.elements[2]=this.z,this.elements[3]=this.w):this.elements=new Float32Array([this.x,this.y,this.z,this.w]),i.rewriteNumProperty(this,"x",0),i.rewriteNumProperty(this,"y",1),i.rewriteNumProperty(this,"z",2),i.rewriteNumProperty(this,"w",3)}}],[{key:"lerp",value:function(e,t,n,i){var a=e.x,r=e.y,o=e.z,s=e.w;i.x=a+n*(t.x-a),i.y=r+n*(t.y-r),i.z=o+n*(t.z-o),i.w=s+n*(t.w-s)}},{key:"transformByM4x4",value:function(e,t,n){var i=e.x,a=e.y,r=e.z,o=e.w,s=t.elements;n.x=i*s[0]+a*s[4]+r*s[8]+o*s[12],n.y=i*s[1]+a*s[5]+r*s[9]+o*s[13],n.z=i*s[2]+a*s[6]+r*s[10]+o*s[14],n.w=i*s[3]+a*s[7]+r*s[11]+o*s[15]}},{key:"equals",value:function(e,t){return n.nearEqual(Math.abs(e.x),Math.abs(t.x))&&n.nearEqual(Math.abs(e.y),Math.abs(t.y))&&n.nearEqual(Math.abs(e.z),Math.abs(t.z))&&n.nearEqual(Math.abs(e.w),Math.abs(t.w))}},{key:"normalize",value:function(e,t){var n=e.length();if(n>0){var i=1/n;t.x=e.x*i,t.y=e.y*i,t.z=e.z*i,t.w=e.w*i}}},{key:"add",value:function(e,t,n){n.x=e.x+t.x,n.y=e.y+t.y,n.z=e.z+t.z,n.w=e.w+t.w}},{key:"subtract",value:function(e,t,n){n.x=e.x-t.x,n.y=e.y-t.y,n.z=e.z-t.z,n.w=e.w-t.w}},{key:"multiply",value:function(e,t,n){n.x=e.x*t.x,n.y=e.y*t.y,n.z=e.z*t.z,n.w=e.w*t.w}},{key:"scale",value:function(e,t,n){n.x=e.x*t,n.y=e.y*t,n.z=e.z*t,n.w=e.w*t}},{key:"Clamp",value:function(e,t,n,i){var a=e.x,r=e.y,o=e.z,s=e.w,l=t.x,u=t.y,c=t.z,h=t.w,_=n.x,d=n.y,f=n.z,m=n.w;a=(a=a>_?_:a)<l?l:a,r=(r=r>d?d:r)<u?u:r,o=(o=o>f?f:o)<c?c:o,s=(s=s>m?m:s)<h?h:s,i.x=a,i.y=r,i.z=o,i.w=s}},{key:"distanceSquared",value:function(e,t){var n=e.x-t.x,i=e.y-t.y,a=e.z-t.z,r=e.w-t.w;return n*n+i*i+a*a+r*r}},{key:"distance",value:function(e,t){var n=e.x-t.x,i=e.y-t.y,a=e.z-t.z,r=e.w-t.w;return Math.sqrt(n*n+i*i+a*a+r*r)}},{key:"dot",value:function(e,t){return e.x*t.x+e.y*t.y+e.z*t.z+e.w*t.w}},{key:"min",value:function(e,t,n){n.x=Math.min(e.x,t.x),n.y=Math.min(e.y,t.y),n.z=Math.min(e.z,t.z),n.w=Math.min(e.w,t.w)}},{key:"max",value:function(e,t,n){n.x=Math.max(e.x,t.x),n.y=Math.max(e.y,t.y),n.z=Math.max(e.z,t.z),n.w=Math.max(e.w,t.w)}}]),Vector4}();a.ZERO=new a,a.ONE=new a(1,1,1,1),a.UnitX=new a(1,0,0,0),a.UnitY=new a(0,1,0,0),a.UnitZ=new a(0,0,1,0),a.UnitW=new a(0,0,0,1);var r,o=function(){function Vector3(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;_classCallCheck(this,Vector3),this.x=e,this.y=t,this.z=n}return _createClass(Vector3,[{key:"setValue",value:function(e,t,n){this.x=e,this.y=t,this.z=n}},{key:"fromArray",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;this.x=e[t+0],this.y=e[t+1],this.z=e[t+2]}},{key:"toArray",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;e[t+0]=this.x,e[t+1]=this.y,e[t+2]=this.z}},{key:"cloneTo",value:function(e){var t=e;t.x=this.x,t.y=this.y,t.z=this.z}},{key:"clone",value:function(){var e=new Vector3;return this.cloneTo(e),e}},{key:"toDefault",value:function(){this.x=0,this.y=0,this.z=0}},{key:"forNativeElement",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;e?(this.elements=e,this.elements[0]=this.x,this.elements[1]=this.y,this.elements[2]=this.z):this.elements=new Float32Array([this.x,this.y,this.z]),i.rewriteNumProperty(this,"x",0),i.rewriteNumProperty(this,"y",1),i.rewriteNumProperty(this,"z",2)}}],[{key:"distanceSquared",value:function(e,t){var n=e.x-t.x,i=e.y-t.y,a=e.z-t.z;return n*n+i*i+a*a}},{key:"distance",value:function(e,t){var n=e.x-t.x,i=e.y-t.y,a=e.z-t.z;return Math.sqrt(n*n+i*i+a*a)}},{key:"min",value:function(e,t,n){n.x=Math.min(e.x,t.x),n.y=Math.min(e.y,t.y),n.z=Math.min(e.z,t.z)}},{key:"max",value:function(e,t,n){n.x=Math.max(e.x,t.x),n.y=Math.max(e.y,t.y),n.z=Math.max(e.z,t.z)}},{key:"transformQuat",value:function(e,t,n){var i=e.x,a=e.y,r=e.z,o=t.x,s=t.y,l=t.z,u=t.w,c=u*i+s*r-l*a,h=u*a+l*i-o*r,_=u*r+o*a-s*i,d=-o*i-s*a-l*r;n.x=c*u+d*-o+h*-l-_*-s,n.y=h*u+d*-s+_*-o-c*-l,n.z=_*u+d*-l+c*-s-h*-o}},{key:"scalarLength",value:function(e){var t=e.x,n=e.y,i=e.z;return Math.sqrt(t*t+n*n+i*i)}},{key:"scalarLengthSquared",value:function(e){var t=e.x,n=e.y,i=e.z;return t*t+n*n+i*i}},{key:"normalize",value:function(e,t){var n=e.x,i=e.y,a=e.z,r=n*n+i*i+a*a;r>0&&(r=1/Math.sqrt(r),t.x=n*r,t.y=i*r,t.z=a*r)}},{key:"multiply",value:function(e,t,n){n.x=e.x*t.x,n.y=e.y*t.y,n.z=e.z*t.z}},{key:"scale",value:function(e,t,n){n.x=e.x*t,n.y=e.y*t,n.z=e.z*t}},{key:"lerp",value:function(e,t,n,i){var a=e.x,r=e.y,o=e.z;i.x=a+n*(t.x-a),i.y=r+n*(t.y-r),i.z=o+n*(t.z-o)}},{key:"transformV3ToV3",value:function(e,t,n){var i=Vector3._tempVector4;Vector3.transformV3ToV4(e,t,i),n.x=i.x,n.y=i.y,n.z=i.z}},{key:"transformV3ToV4",value:function(e,t,n){var i=e.x,a=e.y,r=e.z,o=t.elements;n.x=i*o[0]+a*o[4]+r*o[8]+o[12],n.y=i*o[1]+a*o[5]+r*o[9]+o[13],n.z=i*o[2]+a*o[6]+r*o[10]+o[14],n.w=i*o[3]+a*o[7]+r*o[11]+o[15]}},{key:"TransformNormal",value:function(e,t,n){var i=e.x,a=e.y,r=e.z,o=t.elements;n.x=i*o[0]+a*o[4]+r*o[8],n.y=i*o[1]+a*o[5]+r*o[9],n.z=i*o[2]+a*o[6]+r*o[10]}},{key:"transformCoordinate",value:function(e,t,n){var i=e.x,a=e.y,r=e.z,o=t.elements,s=i*o[3]+a*o[7]+r*o[11]+o[15];n.x=(i*o[0]+a*o[4]+r*o[8]+o[12])/s,n.y=(i*o[1]+a*o[5]+r*o[9]+o[13])/s,n.z=(i*o[2]+a*o[6]+r*o[10]+o[14])/s}},{key:"Clamp",value:function(e,t,n,i){var a=e.x,r=e.y,o=e.z,s=t.x,l=t.y,u=t.z,c=n.x,h=n.y,_=n.z;a=(a=a>c?c:a)<s?s:a,r=(r=r>h?h:r)<l?l:r,o=(o=o>_?_:o)<u?u:o,i.x=a,i.y=r,i.z=o}},{key:"add",value:function(e,t,n){n.x=e.x+t.x,n.y=e.y+t.y,n.z=e.z+t.z}},{key:"subtract",value:function(e,t,n){n.x=e.x-t.x,n.y=e.y-t.y,n.z=e.z-t.z}},{key:"cross",value:function(e,t,n){var i=e.x,a=e.y,r=e.z,o=t.x,s=t.y,l=t.z;n.x=a*l-r*s,n.y=r*o-i*l,n.z=i*s-a*o}},{key:"dot",value:function(e,t){return e.x*t.x+e.y*t.y+e.z*t.z}},{key:"equals",value:function(e,t){return n.nearEqual(e.x,t.x)&&n.nearEqual(e.y,t.y)&&n.nearEqual(e.z,t.z)}}]),Vector3}();o._tempVector4=new a,o._ZERO=new o(0,0,0),o._ONE=new o(1,1,1),o._NegativeUnitX=new o(-1,0,0),o._UnitX=new o(1,0,0),o._UnitY=new o(0,1,0),o._UnitZ=new o(0,0,1),o._ForwardRH=new o(0,0,-1),o._ForwardLH=new o(0,0,1),o._Up=new o(0,1,0),(r=e.PBRRenderQuality||(e.PBRRenderQuality={}))[r.High=0]="High",r[r.Low=1]="Low";var s=function(){function Matrix3x3(){_classCallCheck(this,Matrix3x3);var e=this.elements=new Float32Array(9);e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1}return _createClass(Matrix3x3,[{key:"determinant",value:function(){var e=this.elements,t=e[0],n=e[1],i=e[2],a=e[3],r=e[4],o=e[5],s=e[6],l=e[7],u=e[8];return t*(u*r-o*l)+n*(-u*a+o*s)+i*(l*a-r*s)}},{key:"translate",value:function(e,t){var n=t.elements,i=this.elements,a=i[0],r=i[1],o=i[2],s=i[3],l=i[4],u=i[5],c=i[6],h=i[7],_=i[8],d=e.x,f=e.y;n[0]=a,n[1]=r,n[2]=o,n[3]=s,n[4]=l,n[5]=u,n[6]=d*a+f*s+c,n[7]=d*r+f*l+h,n[8]=d*o+f*u+_}},{key:"rotate",value:function(e,t){var n=t.elements,i=this.elements,a=i[0],r=i[1],o=i[2],s=i[3],l=i[4],u=i[5],c=i[6],h=i[7],_=i[8],d=Math.sin(e),f=Math.cos(e);n[0]=f*a+d*s,n[1]=f*r+d*l,n[2]=f*o+d*u,n[3]=f*s-d*a,n[4]=f*l-d*r,n[5]=f*u-d*o,n[6]=c,n[7]=h,n[8]=_}},{key:"scale",value:function(e,t){var n=t.elements,i=this.elements,a=e.x,r=e.y;n[0]=a*i[0],n[1]=a*i[1],n[2]=a*i[2],n[3]=r*i[3],n[4]=r*i[4],n[5]=r*i[5],n[6]=i[6],n[7]=i[7],n[8]=i[8]}},{key:"invert",value:function(e){var t=e.elements,n=this.elements,i=n[0],a=n[1],r=n[2],o=n[3],s=n[4],l=n[5],u=n[6],c=n[7],h=n[8],_=h*s-l*c,d=-h*o+l*u,f=c*o-s*u,m=i*_+a*d+r*f;m&&(m=1/m,t[0]=_*m,t[1]=(-h*a+r*c)*m,t[2]=(l*a-r*s)*m,t[3]=d*m,t[4]=(h*i-r*u)*m,t[5]=(-l*i+r*o)*m,t[6]=f*m,t[7]=(-c*i+a*u)*m,t[8]=(s*i-a*o)*m)}},{key:"transpose",value:function(e){var t=e.elements,n=this.elements;if(e===this){var i=n[1],a=n[2],r=n[5];t[1]=n[3],t[2]=n[6],t[3]=i,t[5]=n[7],t[6]=a,t[7]=r}else t[0]=n[0],t[1]=n[3],t[2]=n[6],t[3]=n[1],t[4]=n[4],t[5]=n[7],t[6]=n[2],t[7]=n[5],t[8]=n[8]}},{key:"identity",value:function(){var e=this.elements;e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1}},{key:"cloneTo",value:function(e){var t,n,i;if((n=this.elements)!==(i=e.elements))for(t=0;t<9;++t)i[t]=n[t]}},{key:"clone",value:function(){var e=new Matrix3x3;return this.cloneTo(e),e}}],[{key:"createRotationQuaternion",value:function(e,t){var n=e.x,i=e.y,a=e.z,r=e.w,o=n*n,s=i*i,l=a*a,u=n*i,c=a*r,h=a*n,_=i*r,d=i*a,f=n*r,m=t.elements;m[0]=1-2*(s+l),m[1]=2*(u+c),m[2]=2*(h-_),m[3]=2*(u-c),m[4]=1-2*(l+o),m[5]=2*(d+f),m[6]=2*(h+_),m[7]=2*(d-f),m[8]=1-2*(s+o)}},{key:"createFromTranslation",value:function(e,t){var n=t.elements;n[0]=1,n[1]=0,n[2]=0,n[3]=0,n[4]=1,n[5]=0,n[6]=e.x,n[7]=e.y,n[8]=1}},{key:"createFromRotation",value:function(e,t){var n=t.elements,i=Math.sin(e),a=Math.cos(e);n[0]=a,n[1]=i,n[2]=0,n[3]=-i,n[4]=a,n[5]=0,n[6]=0,n[7]=0,n[8]=1}},{key:"createFromScaling",value:function(e,t){var n=t.elements;n[0]=e.x,n[1]=0,n[2]=0,n[3]=0,n[4]=e.y,n[5]=0,n[6]=0,n[7]=0,n[8]=e.z}},{key:"createFromMatrix4x4",value:function(e,t){var n=e.elements,i=t.elements;i[0]=n[0],i[1]=n[1],i[2]=n[2],i[3]=n[4],i[4]=n[5],i[5]=n[6],i[6]=n[8],i[7]=n[9],i[8]=n[10]}},{key:"multiply",value:function(e,t,n){var i=e.elements,a=t.elements,r=n.elements,o=i[0],s=i[1],l=i[2],u=i[3],c=i[4],h=i[5],_=i[6],d=i[7],f=i[8],m=a[0],p=a[1],T=a[2],v=a[3],g=a[4],E=a[5],y=a[6],S=a[7],R=a[8];r[0]=m*o+p*u+T*_,r[1]=m*s+p*c+T*S,r[2]=m*l+p*h+T*f,r[3]=v*o+g*u+E*_,r[4]=v*s+g*c+E*d,r[5]=v*l+g*h+E*f,r[6]=y*o+S*u+R*_,r[7]=y*s+S*c+R*d,r[8]=y*l+S*h+R*f}},{key:"lookAt",value:function(e,t,n,i){o.subtract(e,t,Matrix3x3._tempV30),o.normalize(Matrix3x3._tempV30,Matrix3x3._tempV30),o.cross(n,Matrix3x3._tempV30,Matrix3x3._tempV31),o.normalize(Matrix3x3._tempV31,Matrix3x3._tempV31),o.cross(Matrix3x3._tempV30,Matrix3x3._tempV31,Matrix3x3._tempV32);var a=Matrix3x3._tempV30,r=Matrix3x3._tempV31,s=Matrix3x3._tempV32,l=i.elements;l[0]=r.x,l[3]=r.y,l[6]=r.z,l[1]=s.x,l[4]=s.y,l[7]=s.z,l[2]=a.x,l[5]=a.y,l[8]=a.z}}]),Matrix3x3}();s.DEFAULT=new s,s._tempV30=new o,s._tempV31=new o,s._tempV32=new o;var l=function ILaya3D(){_classCallCheck(this,ILaya3D)};l.Shader3D=null,l.Scene3D=null,l.MeshRenderStaticBatchManager=null,l.MeshRenderDynamicBatchManager=null,l.SubMeshDynamicBatch=null,l.Laya3D=null,l.Matrix4x4=null,l.Physics3D=null,l.ShadowLightType=null;var u=function(){function Quaternion(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1;_classCallCheck(this,Quaternion),this.x=e,this.y=t,this.z=n,this.w=i}return _createClass(Quaternion,[{key:"scaling",value:function(e,t){t.x=this.x*e,t.y=this.y*e,t.z=this.z*e,t.w=this.w*e}},{key:"normalize",value:function(e){var t=this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w;t>0&&(t=1/Math.sqrt(t),e.x=this.x*t,e.y=this.y*t,e.z=this.z*t,e.w=this.w*t)}},{key:"length",value:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}},{key:"rotateX",value:function(e,t){e*=.5;var n=Math.sin(e),i=Math.cos(e);t.x=this.x*i+this.w*n,t.y=this.y*i+this.z*n,t.z=this.z*i-this.y*n,t.w=this.w*i-this.x*n}},{key:"rotateY",value:function(e,t){e*=.5;var n=Math.sin(e),i=Math.cos(e);t.x=this.x*i-this.z*n,t.y=this.y*i+this.w*n,t.z=this.z*i+this.x*n,t.w=this.w*i-this.y*n}},{key:"rotateZ",value:function(e,t){e*=.5;var n=Math.sin(e),i=Math.cos(e);t.x=this.x*i+this.y*n,t.y=this.y*i-this.x*n,t.z=this.z*i+this.w*n,t.w=this.w*i-this.z*n}},{key:"getYawPitchRoll",value:function(e){o.transformQuat(o._ForwardRH,this,Quaternion.TEMPVector31),o.transformQuat(o._Up,this,Quaternion.TEMPVector32);var t=Quaternion.TEMPVector32;Quaternion.angleTo(o._ZERO,Quaternion.TEMPVector31,Quaternion.TEMPVector33);var n=Quaternion.TEMPVector33;n.x==Math.PI/2?(n.y=Quaternion.arcTanAngle(t.z,t.x),n.z=0):n.x==-Math.PI/2?(n.y=Quaternion.arcTanAngle(-t.z,-t.x),n.z=0):(l.Matrix4x4.createRotationY(-n.y,l.Matrix4x4.TEMPMatrix0),l.Matrix4x4.createRotationX(-n.x,l.Matrix4x4.TEMPMatrix1),o.transformCoordinate(Quaternion.TEMPVector32,l.Matrix4x4.TEMPMatrix0,Quaternion.TEMPVector32),o.transformCoordinate(Quaternion.TEMPVector32,l.Matrix4x4.TEMPMatrix1,Quaternion.TEMPVector32),n.z=Quaternion.arcTanAngle(t.y,-t.x)),n.y<=-Math.PI&&(n.y=Math.PI),n.z<=-Math.PI&&(n.z=Math.PI),n.y>=Math.PI&&n.z>=Math.PI&&(n.y=0,n.z=0,n.x=Math.PI-n.x);var i=e;i.x=n.y,i.y=n.x,i.z=n.z}},{key:"invert",value:function(e){var t=this.x,n=this.y,i=this.z,a=this.w,r=t*t+n*n+i*i+a*a,o=r?1/r:0;e.x=-t*o,e.y=-n*o,e.z=-i*o,e.w=a*o}},{key:"identity",value:function(){this.x=0,this.y=0,this.z=0,this.w=1}},{key:"fromArray",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;this.x=e[t+0],this.y=e[t+1],this.z=e[t+2],this.w=e[t+3]}},{key:"cloneTo",value:function(e){this!==e&&(e.x=this.x,e.y=this.y,e.z=this.z,e.w=this.w)}},{key:"clone",value:function(){var e=new Quaternion;return this.cloneTo(e),e}},{key:"equals",value:function(e){return n.nearEqual(this.x,e.x)&&n.nearEqual(this.y,e.y)&&n.nearEqual(this.z,e.z)&&n.nearEqual(this.w,e.w)}},{key:"lengthSquared",value:function(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}},{key:"forNativeElement",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;e?(this.elements=e,this.elements[0]=this.x,this.elements[1]=this.y,this.elements[2]=this.z,this.elements[3]=this.w):this.elements=new Float32Array([this.x,this.y,this.z,this.w]),i.rewriteNumProperty(this,"x",0),i.rewriteNumProperty(this,"y",1),i.rewriteNumProperty(this,"z",2),i.rewriteNumProperty(this,"w",3)}}],[{key:"createFromYawPitchRoll",value:function(e,t,n,i){var a=.5*n,r=.5*t,o=.5*e,s=Math.sin(a),l=Math.cos(a),u=Math.sin(r),c=Math.cos(r),h=Math.sin(o),_=Math.cos(o);i.x=_*u*l+h*c*s,i.y=h*c*l-_*u*s,i.z=_*c*s-h*u*l,i.w=_*c*l+h*u*s}},{key:"multiply",value:function(e,t,n){var i=e.x,a=e.y,r=e.z,o=e.w,s=t.x,l=t.y,u=t.z,c=t.w,h=a*u-r*l,_=r*s-i*u,d=i*l-a*s,f=i*s+a*l+r*u;n.x=i*c+s*o+h,n.y=a*c+l*o+_,n.z=r*c+u*o+d,n.w=o*c-f}},{key:"arcTanAngle",value:function(e,t){return 0==e?1==t?Math.PI/2:-Math.PI/2:e>0?Math.atan(t/e):e<0?t>0?Math.atan(t/e)+Math.PI:Math.atan(t/e)-Math.PI:0}},{key:"angleTo",value:function(e,t,n){o.subtract(t,e,Quaternion.TEMPVector30),o.normalize(Quaternion.TEMPVector30,Quaternion.TEMPVector30),n.x=Math.asin(Quaternion.TEMPVector30.y),n.y=Quaternion.arcTanAngle(-Quaternion.TEMPVector30.z,-Quaternion.TEMPVector30.x)}},{key:"createFromAxisAngle",value:function(e,t,n){t*=.5;var i=Math.sin(t);n.x=i*e.x,n.y=i*e.y,n.z=i*e.z,n.w=Math.cos(t)}},{key:"createFromMatrix4x4",value:function(e,t){var n,i,a=e.elements,r=a[0]+a[5]+a[10];r>0?(n=Math.sqrt(r+1),t.w=.5*n,n=.5/n,t.x=(a[6]-a[9])*n,t.y=(a[8]-a[2])*n,t.z=(a[1]-a[4])*n):a[0]>=a[5]&&a[0]>=a[10]?(i=.5/(n=Math.sqrt(1+a[0]-a[5]-a[10])),t.x=.5*n,t.y=(a[1]+a[4])*i,t.z=(a[2]+a[8])*i,t.w=(a[6]-a[9])*i):a[5]>a[10]?(i=.5/(n=Math.sqrt(1+a[5]-a[0]-a[10])),t.x=(a[4]+a[1])*i,t.y=.5*n,t.z=(a[9]+a[6])*i,t.w=(a[8]-a[2])*i):(i=.5/(n=Math.sqrt(1+a[10]-a[0]-a[5])),t.x=(a[8]+a[2])*i,t.y=(a[9]+a[6])*i,t.z=.5*n,t.w=(a[1]-a[4])*i)}},{key:"slerp",value:function(e,t,n,i){var a,r,o,s,l,u=e.x,c=e.y,h=e.z,_=e.w,d=t.x,f=t.y,m=t.z,p=t.w;return(r=u*d+c*f+h*m+_*p)<0&&(r=-r,d=-d,f=-f,m=-m,p=-p),1-r>1e-6?(a=Math.acos(r),o=Math.sin(a),s=Math.sin((1-n)*a)/o,l=Math.sin(n*a)/o):(s=1-n,l=n),i.x=s*u+l*d,i.y=s*c+l*f,i.z=s*h+l*m,i.w=s*_+l*p,i}},{key:"lerp",value:function(e,t,n,i){var a=1-n;Quaternion.dot(e,t)>=0?(i.x=a*e.x+n*t.x,i.y=a*e.y+n*t.y,i.z=a*e.z+n*t.z,i.w=a*e.w+n*t.w):(i.x=a*e.x-n*t.x,i.y=a*e.y-n*t.y,i.z=a*e.z-n*t.z,i.w=a*e.w-n*t.w),i.normalize(i)}},{key:"add",value:function(e,t,n){n.x=e.x+t.x,n.y=e.y+t.y,n.z=e.z+t.z,n.w=e.w+t.w}},{key:"dot",value:function(e,t){return e.x*t.x+e.y*t.y+e.z*t.z+e.w*t.w}},{key:"rotationLookAt",value:function(e,t,n){Quaternion.lookAt(o._ZERO,e,t,n)}},{key:"lookAt",value:function(e,t,n,i){s.lookAt(e,t,n,Quaternion._tempMatrix3x3),Quaternion.rotationMatrix(Quaternion._tempMatrix3x3,i)}},{key:"invert",value:function(e,t){var i=e.lengthSquared();n.isZero(i)||(i=1/i,t.x=-e.x*i,t.y=-e.y*i,t.z=-e.z*i,t.w=e.w*i)}},{key:"rotationMatrix",value:function(e,t){var n,i,a=e.elements,r=a[0],o=a[1],s=a[2],l=a[3],u=a[4],c=a[5],h=a[6],_=a[7],d=a[8],f=r+u+d;f>0?(n=Math.sqrt(f+1),t.w=.5*n,n=.5/n,t.x=(c-_)*n,t.y=(h-s)*n,t.z=(o-l)*n):r>=u&&r>=d?(i=.5/(n=Math.sqrt(1+r-u-d)),t.x=.5*n,t.y=(o+l)*i,t.z=(s+h)*i,t.w=(c-_)*i):u>d?(i=.5/(n=Math.sqrt(1+u-r-d)),t.x=(l+o)*i,t.y=.5*n,t.z=(_+c)*i,t.w=(h-s)*i):(i=.5/(n=Math.sqrt(1+d-r-u)),t.x=(h+s)*i,t.y=(_+c)*i,t.z=.5*n,t.w=(o-l)*i)}}]),Quaternion}();u.TEMPVector30=new o,u.TEMPVector31=new o,u.TEMPVector32=new o,u.TEMPVector33=new o,u._tempMatrix3x3=new s,u.DEFAULT=new u,u.NAN=new u(NaN,NaN,NaN,NaN);var c=function(){function Matrix4x4(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,r=arguments.length>5&&void 0!==arguments[5]?arguments[5]:1,o=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0,s=arguments.length>7&&void 0!==arguments[7]?arguments[7]:0,l=arguments.length>8&&void 0!==arguments[8]?arguments[8]:0,u=arguments.length>9&&void 0!==arguments[9]?arguments[9]:0,c=arguments.length>10&&void 0!==arguments[10]?arguments[10]:1,h=arguments.length>11&&void 0!==arguments[11]?arguments[11]:0,_=arguments.length>12&&void 0!==arguments[12]?arguments[12]:0,d=arguments.length>13&&void 0!==arguments[13]?arguments[13]:0,f=arguments.length>14&&void 0!==arguments[14]?arguments[14]:0,m=arguments.length>15&&void 0!==arguments[15]?arguments[15]:1,p=arguments.length>16&&void 0!==arguments[16]?arguments[16]:null;_classCallCheck(this,Matrix4x4);var T=this.elements=p||new Float32Array(16);T[0]=e,T[1]=t,T[2]=n,T[3]=i,T[4]=a,T[5]=r,T[6]=o,T[7]=s,T[8]=l,T[9]=u,T[10]=c,T[11]=h,T[12]=_,T[13]=d,T[14]=f,T[15]=m}return _createClass(Matrix4x4,[{key:"setRotation",value:function(e){var t=e.x,n=e.y,i=e.z,a=e.w,r=t*t,o=n*n,s=i*i,l=t*n,u=i*a,c=i*t,h=n*a,_=n*i,d=t*a,f=this.elements;f[0]=1-2*(o+s),f[1]=2*(l+u),f[2]=2*(c-h),f[4]=2*(l-u),f[5]=1-2*(s+r),f[6]=2*(_+d),f[8]=2*(c+h),f[9]=2*(_-d),f[10]=1-2*(o+r)}},{key:"setPosition",value:function(e){var t=this.elements;t[12]=e.x,t[13]=e.y,t[14]=e.z}},{key:"getElementByRowColumn",value:function(e,t){if(e<0||e>3)throw new Error("row Rows and columns for matrices run from 0 to 3, inclusive.");if(t<0||t>3)throw new Error("column Rows and columns for matrices run from 0 to 3, inclusive.");return this.elements[4*e+t]}},{key:"setElementByRowColumn",value:function(e,t,n){if(e<0||e>3)throw new Error("row Rows and columns for matrices run from 0 to 3, inclusive.");if(t<0||t>3)throw new Error("column Rows and columns for matrices run from 0 to 3, inclusive.");this.elements[4*e+t]=n}},{key:"equalsOtherMatrix",value:function(e){var t=this.elements,i=e.elements;return n.nearEqual(t[0],i[0])&&n.nearEqual(t[1],i[1])&&n.nearEqual(t[2],i[2])&&n.nearEqual(t[3],i[3])&&n.nearEqual(t[4],i[4])&&n.nearEqual(t[5],i[5])&&n.nearEqual(t[6],i[6])&&n.nearEqual(t[7],i[7])&&n.nearEqual(t[8],i[8])&&n.nearEqual(t[9],i[9])&&n.nearEqual(t[10],i[10])&&n.nearEqual(t[11],i[11])&&n.nearEqual(t[12],i[12])&&n.nearEqual(t[13],i[13])&&n.nearEqual(t[14],i[14])&&n.nearEqual(t[15],i[15])}},{key:"decomposeTransRotScale",value:function(e,t,n){var i=Matrix4x4._tempMatrix4x4;return this.decomposeTransRotMatScale(e,i,n)?(u.createFromMatrix4x4(i,t),!0):(t.identity(),!1)}},{key:"decomposeTransRotMatScale",value:function(e,t,i){var a=this.elements,r=e,s=t.elements,l=i;r.x=a[12],r.y=a[13],r.z=a[14];var u=a[0],c=a[1],h=a[2],_=a[4],d=a[5],f=a[6],m=a[8],p=a[9],T=a[10],v=l.x=Math.sqrt(u*u+c*c+h*h),g=l.y=Math.sqrt(_*_+d*d+f*f),E=l.z=Math.sqrt(m*m+p*p+T*T);if(n.isZero(v)||n.isZero(g)||n.isZero(E))return s[1]=s[2]=s[3]=s[4]=s[6]=s[7]=s[8]=s[9]=s[11]=s[12]=s[13]=s[14]=0,s[0]=s[5]=s[10]=s[15]=1,!1;var y=Matrix4x4._tempVector0;y.x=m/E,y.y=p/E,y.z=T/E;var S=Matrix4x4._tempVector1;S.x=u/v,S.y=c/v,S.z=h/v;var R=Matrix4x4._tempVector2;o.cross(y,S,R);var C=Matrix4x4._tempVector1;return o.cross(R,y,C),s[3]=s[7]=s[11]=s[12]=s[13]=s[14]=0,s[15]=1,s[0]=C.x,s[1]=C.y,s[2]=C.z,s[4]=R.x,s[5]=R.y,s[6]=R.z,s[8]=y.x,s[9]=y.y,s[10]=y.z,s[0]*u+s[1]*c+s[2]*h<0&&(l.x=-v),s[4]*_+s[5]*d+s[6]*f<0&&(l.y=-g),s[8]*m+s[9]*p+s[10]*T<0&&(l.z=-E),!0}},{key:"decomposeYawPitchRoll",value:function(e){var t=Math.asin(-this.elements[9]);e.y=t,Math.cos(t)>n.zeroTolerance?(e.z=Math.atan2(this.elements[1],this.elements[5]),e.x=Math.atan2(this.elements[8],this.elements[10])):(e.z=Math.atan2(-this.elements[4],this.elements[0]),e.x=0)}},{key:"normalize",value:function(){var e=this.elements,t=e[0],n=e[1],i=e[2],a=Math.sqrt(t*t+n*n+i*i);if(!a)return e[0]=0,e[1]=0,void(e[2]=0);1!=a&&(a=1/a,e[0]=t*a,e[1]=n*a,e[2]=i*a)}},{key:"transpose",value:function(){var e,t;return t=(e=this.elements)[1],e[1]=e[4],e[4]=t,t=e[2],e[2]=e[8],e[8]=t,t=e[3],e[3]=e[12],e[12]=t,t=e[6],e[6]=e[9],e[9]=t,t=e[7],e[7]=e[13],e[13]=t,t=e[11],e[11]=e[14],e[14]=t,this}},{key:"invert",value:function(e){var t=this.elements,n=e.elements,i=t[0],a=t[1],r=t[2],o=t[3],s=t[4],l=t[5],u=t[6],c=t[7],h=t[8],_=t[9],d=t[10],f=t[11],m=t[12],p=t[13],T=t[14],v=t[15],g=i*l-a*s,E=i*u-r*s,y=i*c-o*s,S=a*u-r*l,R=a*c-o*l,C=r*c-o*u,M=h*p-_*m,D=h*T-d*m,x=h*v-f*m,A=_*T-d*p,I=_*v-f*p,L=d*v-f*T,P=g*L-E*I+y*A+S*x-R*D+C*M;0!==Math.abs(P)&&(P=1/P,n[0]=(l*L-u*I+c*A)*P,n[1]=(r*I-a*L-o*A)*P,n[2]=(p*C-T*R+v*S)*P,n[3]=(d*R-_*C-f*S)*P,n[4]=(u*x-s*L-c*D)*P,n[5]=(i*L-r*x+o*D)*P,n[6]=(T*y-m*C-v*E)*P,n[7]=(h*C-d*y+f*E)*P,n[8]=(s*I-l*x+c*M)*P,n[9]=(a*x-i*I-o*M)*P,n[10]=(m*R-p*y+v*g)*P,n[11]=(_*y-h*R-f*g)*P,n[12]=(l*D-s*A-u*M)*P,n[13]=(i*A-a*D+r*M)*P,n[14]=(p*E-m*S-T*g)*P,n[15]=(h*S-_*E+d*g)*P)}},{key:"identity",value:function(){var e=this.elements;e[1]=e[2]=e[3]=e[4]=e[6]=e[7]=e[8]=e[9]=e[11]=e[12]=e[13]=e[14]=0,e[0]=e[5]=e[10]=e[15]=1}},{key:"cloneTo",value:function(e){var t,n,i;if((n=this.elements)!==(i=e.elements))for(t=0;t<16;++t)i[t]=n[t]}},{key:"clone",value:function(){var e=new Matrix4x4;return this.cloneTo(e),e}},{key:"getTranslationVector",value:function(e){var t=this.elements;e.x=t[12],e.y=t[13],e.z=t[14]}},{key:"setTranslationVector",value:function(e){var t=this.elements,n=e;t[12]=n.x,t[13]=n.y,t[14]=n.z}},{key:"getForward",value:function(e){var t=this.elements;e.x=-t[8],e.y=-t[9],e.z=-t[10]}},{key:"setForward",value:function(e){var t=this.elements;t[8]=-e.x,t[9]=-e.y,t[10]=-e.z}},{key:"getInvertFront",value:function(){this.decomposeTransRotScale(Matrix4x4._tempVector0,Matrix4x4._tempQuaternion,Matrix4x4._tempVector1);var e=Matrix4x4._tempVector1,t=e.x<0;return e.y<0&&(t=!t),e.z<0&&(t=!t),t}}],[{key:"createRotationX",value:function(e,t){var n=t.elements,i=Math.sin(e),a=Math.cos(e);n[1]=n[2]=n[3]=n[4]=n[7]=n[8]=n[11]=n[12]=n[13]=n[14]=0,n[0]=n[15]=1,n[5]=n[10]=a,n[6]=i,n[9]=-i}},{key:"createRotationY",value:function(e,t){var n=t.elements,i=Math.sin(e),a=Math.cos(e);n[1]=n[3]=n[4]=n[6]=n[7]=n[9]=n[11]=n[12]=n[13]=n[14]=0,n[5]=n[15]=1,n[0]=n[10]=a,n[2]=-i,n[8]=i}},{key:"createRotationZ",value:function(e,t){var n=t.elements,i=Math.sin(e),a=Math.cos(e);n[2]=n[3]=n[6]=n[7]=n[8]=n[9]=n[11]=n[12]=n[13]=n[14]=0,n[10]=n[15]=1,n[0]=n[5]=a,n[1]=i,n[4]=-i}},{key:"createRotationYawPitchRoll",value:function(e,t,n,i){u.createFromYawPitchRoll(e,t,n,Matrix4x4._tempQuaternion),Matrix4x4.createRotationQuaternion(Matrix4x4._tempQuaternion,i)}},{key:"createRotationAxis",value:function(e,t,n){var i=e.x,a=e.y,r=e.z,o=Math.cos(t),s=Math.sin(t),l=i*i,u=a*a,c=r*r,h=i*a,_=i*r,d=a*r,f=n.elements;f[3]=f[7]=f[11]=f[12]=f[13]=f[14]=0,f[15]=1,f[0]=l+o*(1-l),f[1]=h-o*h+s*r,f[2]=_-o*_-s*a,f[4]=h-o*h-s*r,f[5]=u+o*(1-u),f[6]=d-o*d+s*i,f[8]=_-o*_+s*a,f[9]=d-o*d-s*i,f[10]=c+o*(1-c)}},{key:"createRotationQuaternion",value:function(e,t){var n=t.elements,i=e.x,a=e.y,r=e.z,o=e.w,s=i*i,l=a*a,u=r*r,c=i*a,h=r*o,_=r*i,d=a*o,f=a*r,m=i*o;n[3]=n[7]=n[11]=n[12]=n[13]=n[14]=0,n[15]=1,n[0]=1-2*(l+u),n[1]=2*(c+h),n[2]=2*(_-d),n[4]=2*(c-h),n[5]=1-2*(u+s),n[6]=2*(f+m),n[8]=2*(_+d),n[9]=2*(f-m),n[10]=1-2*(l+s)}},{key:"createTranslate",value:function(e,t){var n=t.elements;n[4]=n[8]=n[1]=n[9]=n[2]=n[6]=n[3]=n[7]=n[11]=0,n[0]=n[5]=n[10]=n[15]=1,n[12]=e.x,n[13]=e.y,n[14]=e.z}},{key:"createScaling",value:function(e,t){var n=t.elements;n[0]=e.x,n[5]=e.y,n[10]=e.z,n[1]=n[4]=n[8]=n[12]=n[9]=n[13]=n[2]=n[6]=n[14]=n[3]=n[7]=n[11]=0,n[15]=1}},{key:"multiply",value:function(e,t,n){var i=t.elements,a=e.elements,r=n.elements,o=i[0],s=i[1],l=i[2],u=i[3],c=i[4],h=i[5],_=i[6],d=i[7],f=i[8],m=i[9],p=i[10],T=i[11],v=i[12],g=i[13],E=i[14],y=i[15],S=a[0],R=a[1],C=a[2],M=a[3],D=a[4],x=a[5],A=a[6],I=a[7],L=a[8],P=a[9],O=a[10],N=a[11],b=a[12],k=a[13],w=a[14],B=a[15];r[0]=o*S+s*D+l*L+u*b,r[1]=o*R+s*x+l*P+u*k,r[2]=o*C+s*A+l*O+u*w,r[3]=o*M+s*I+l*N+u*B,r[4]=c*S+h*D+_*L+d*b,r[5]=c*R+h*x+_*P+d*k,r[6]=c*C+h*A+_*O+d*w,r[7]=c*M+h*I+_*N+d*B,r[8]=f*S+m*D+p*L+T*b,r[9]=f*R+m*x+p*P+T*k,r[10]=f*C+m*A+p*O+T*w,r[11]=f*M+m*I+p*N+T*B,r[12]=v*S+g*D+E*L+y*b,r[13]=v*R+g*x+E*P+y*k,r[14]=v*C+g*A+E*O+y*w,r[15]=v*M+g*I+E*N+y*B}},{key:"multiplyForNative",value:function(e,n,i){t.LayaGL.instance.matrix4x4Multiply(e.elements,n.elements,i.elements)}},{key:"createFromQuaternion",value:function(e,t){var n=t.elements,i=e.x,a=e.y,r=e.z,o=e.w,s=i+i,l=a+a,u=r+r,c=i*s,h=a*s,_=a*l,d=r*s,f=r*l,m=r*u,p=o*s,T=o*l,v=o*u;n[0]=1-_-m,n[1]=h+v,n[2]=d-T,n[3]=0,n[4]=h-v,n[5]=1-c-m,n[6]=f+p,n[7]=0,n[8]=d+T,n[9]=f-p,n[10]=1-c-_,n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1}},{key:"createAffineTransformation",value:function(e,t,n,i){var a=i.elements,r=t.x,o=t.y,s=t.z,l=t.w,u=r+r,c=o+o,h=s+s,_=r*u,d=r*c,f=r*h,m=o*c,p=o*h,T=s*h,v=l*u,g=l*c,E=l*h,y=n.x,S=n.y,R=n.z;a[0]=(1-(m+T))*y,a[1]=(d+E)*y,a[2]=(f-g)*y,a[3]=0,a[4]=(d-E)*S,a[5]=(1-(_+T))*S,a[6]=(p+v)*S,a[7]=0,a[8]=(f+g)*R,a[9]=(p-v)*R,a[10]=(1-(_+m))*R,a[11]=0,a[12]=e.x,a[13]=e.y,a[14]=e.z,a[15]=1}},{key:"createLookAt",value:function(e,t,n,i){var a=i.elements,r=Matrix4x4._tempVector0,s=Matrix4x4._tempVector1,l=Matrix4x4._tempVector2;o.subtract(e,t,l),o.normalize(l,l),o.cross(n,l,r),o.normalize(r,r),o.cross(l,r,s),a[3]=a[7]=a[11]=0,a[15]=1,a[0]=r.x,a[4]=r.y,a[8]=r.z,a[1]=s.x,a[5]=s.y,a[9]=s.z,a[2]=l.x,a[6]=l.y,a[10]=l.z,a[12]=-o.dot(r,e),a[13]=-o.dot(s,e),a[14]=-o.dot(l,e)}},{key:"createPerspective",value:function(e,t,n,i,a){var r=1/Math.tan(.5*e),o=n/(r/t),s=n/r;Matrix4x4.createPerspectiveOffCenter(-o,o,-s,s,n,i,a)}},{key:"createPerspectiveOffCenter",value:function(e,t,n,i,a,r,o){var s=o.elements,l=r/(r-a);s[1]=s[2]=s[3]=s[4]=s[6]=s[7]=s[12]=s[13]=s[15]=0,s[0]=2*a/(t-e),s[5]=2*a/(i-n),s[8]=(e+t)/(t-e),s[9]=(i+n)/(i-n),s[10]=-l,s[11]=-1,s[14]=-a*l}},{key:"createOrthoOffCenter",value:function(e,t,n,i,a,r,o){var s=o.elements,l=1/(r-a);s[1]=s[2]=s[3]=s[4]=s[6]=s[8]=s[7]=s[9]=s[11]=0,s[15]=1,s[0]=2/(t-e),s[5]=2/(i-n),s[10]=-l,s[12]=(e+t)/(e-t),s[13]=(i+n)/(n-i),s[14]=-a*l}},{key:"billboard",value:function(e,t,i,a,r){o.subtract(e,t,Matrix4x4._tempVector0);var s=o.scalarLengthSquared(Matrix4x4._tempVector0);n.isZero(s)?(o.scale(a,-1,Matrix4x4._tempVector1),Matrix4x4._tempVector1.cloneTo(Matrix4x4._tempVector0)):o.scale(Matrix4x4._tempVector0,1/Math.sqrt(s),Matrix4x4._tempVector0),o.cross(i,Matrix4x4._tempVector0,Matrix4x4._tempVector2),o.normalize(Matrix4x4._tempVector2,Matrix4x4._tempVector2),o.cross(Matrix4x4._tempVector0,Matrix4x4._tempVector2,Matrix4x4._tempVector3);var l=Matrix4x4._tempVector2,u=Matrix4x4._tempVector3,c=Matrix4x4._tempVector0,h=e,_=r.elements;_[0]=l.x,_[1]=l.y,_[2]=l.z,_[3]=0,_[4]=u.x,_[5]=u.y,_[6]=u.z,_[7]=0,_[8]=c.x,_[9]=c.y,_[10]=c.z,_[11]=0,_[12]=h.x,_[13]=h.y,_[14]=h.z,_[15]=1}},{key:"translation",value:function(e,t){var n=t.elements;n[0]=n[5]=n[10]=n[15]=1,n[12]=e.x,n[13]=e.y,n[14]=e.z}}]),Matrix4x4}();c._tempMatrix4x4=new c,c.TEMPMatrix0=new c,c.TEMPMatrix1=new c,c._tempVector0=new o,c._tempVector1=new o,c._tempVector2=new o,c._tempVector3=new o,c._tempQuaternion=new u,c.DEFAULT=new c,c.ZERO=new c(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);var h=function(){function ColliderShape(){_classCallCheck(this,ColliderShape),this._scale=new o(1,1,1),this._centerMatrix=new c,this._attatched=!1,this._indexInCompound=-1,this._compoundParent=null,this._attatchedCollisionObject=null,this._referenceCount=0,this._localOffset=new o(0,0,0),this._localRotation=new u(0,0,0,1),this.needsCustomCollisionCallback=!1}return _createClass(ColliderShape,[{key:"_setScale",value:function(e){if(this._compoundParent)this.updateLocalTransformations();else{var t=l.Physics3D._bullet;t.btVector3_setValue(ColliderShape._btScale,e.x,e.y,e.z),t.btCollisionShape_setLocalScaling(this._btShape,ColliderShape._btScale)}}},{key:"_addReference",value:function(){this._referenceCount++}},{key:"_removeReference",value:function(){this._referenceCount--}},{key:"updateLocalTransformations",value:function(){if(this._compoundParent){var e=ColliderShape._tempVector30;o.multiply(this.localOffset,this._scale,e),ColliderShape._createAffineTransformation(e,this.localRotation,this._centerMatrix.elements)}else ColliderShape._createAffineTransformation(this.localOffset,this.localRotation,this._centerMatrix.elements)}},{key:"cloneTo",value:function(e){var t=e;this._localOffset.cloneTo(t.localOffset),this._localRotation.cloneTo(t.localRotation),t.localOffset=t.localOffset,t.localRotation=t.localRotation}},{key:"clone",value:function(){return null}},{key:"destroy",value:function(){this._btShape&&(l.Physics3D._bullet.btCollisionShape_destroy(this._btShape),this._btShape=null)}},{key:"type",get:function(){return this._type}},{key:"localOffset",get:function(){return this._localOffset},set:function(e){this._localOffset=e,this._compoundParent&&this._compoundParent._updateChildTransform(this)}},{key:"localRotation",get:function(){return this._localRotation},set:function(e){this._localRotation=e,this._compoundParent&&this._compoundParent._updateChildTransform(this)}}],[{key:"__init__",value:function(){var e=l.Physics3D._bullet;ColliderShape._btScale=e.btVector3_create(1,1,1),ColliderShape._btVector30=e.btVector3_create(0,0,0),ColliderShape._btQuaternion0=e.btQuaternion_create(0,0,0,1),ColliderShape._btTransform0=e.btTransform_create()}},{key:"_createAffineTransformation",value:function(e,t,n){var i=t.x,a=t.y,r=t.z,o=t.w,s=i+i,l=a+a,u=r+r,c=i*s,h=i*l,_=i*u,d=a*l,f=a*u,m=r*u,p=o*s,T=o*l,v=o*u;n[0]=1-(d+m),n[1]=h+v,n[2]=_-T,n[3]=0,n[4]=h-v,n[5]=1-(c+m),n[6]=f+p,n[7]=0,n[8]=_+T,n[9]=f-p,n[10]=1-(c+d),n[11]=0,n[12]=e.x,n[13]=e.y,n[14]=e.z,n[15]=1}}]),ColliderShape}();h.SHAPEORIENTATION_UPX=0,h.SHAPEORIENTATION_UPY=1,h.SHAPEORIENTATION_UPZ=2,h.SHAPETYPES_BOX=0,h.SHAPETYPES_SPHERE=1,h.SHAPETYPES_CYLINDER=2,h.SHAPETYPES_CAPSULE=3,h.SHAPETYPES_CONVEXHULL=4,h.SHAPETYPES_COMPOUND=5,h.SHAPETYPES_STATICPLANE=6,h.SHAPETYPES_CONE=7,h._tempVector30=new o;var _=function(e){function StaticPlaneColliderShape(e,t){var n;_classCallCheck(this,StaticPlaneColliderShape),(n=_possibleConstructorReturn(this,_getPrototypeOf(StaticPlaneColliderShape).call(this)))._normal=e,n._offset=t,n._type=h.SHAPETYPES_STATICPLANE;var i=l.Physics3D._bullet;return i.btVector3_setValue(StaticPlaneColliderShape._btNormal,-e.x,e.y,e.z),n._btShape=i.btStaticPlaneShape_create(StaticPlaneColliderShape._btNormal,t),n}return _inherits(StaticPlaneColliderShape,h),_createClass(StaticPlaneColliderShape,[{key:"clone",value:function(){var e=new StaticPlaneColliderShape(this._normal,this._offset);return this.cloneTo(e),e}}],[{key:"__init__",value:function(){StaticPlaneColliderShape._btNormal=l.Physics3D._bullet.btVector3_create(0,0,0)}}]),StaticPlaneColliderShape}(),d=function(e){function CompoundColliderShape(){var e;return _classCallCheck(this,CompoundColliderShape),(e=_possibleConstructorReturn(this,_getPrototypeOf(CompoundColliderShape).call(this)))._childColliderShapes=[],e._type=h.SHAPETYPES_COMPOUND,e._btShape=l.Physics3D._bullet.btCompoundShape_create(),e}return _inherits(CompoundColliderShape,h),_createClass(CompoundColliderShape,[{key:"_clearChildShape",value:function(e){e._attatched=!1,e._compoundParent=null,e._indexInCompound=-1}},{key:"_addReference",value:function(){}},{key:"_removeReference",value:function(){}},{key:"_updateChildTransform",value:function(e){var t=l.Physics3D._bullet,n=e.localOffset,i=e.localRotation,a=h._btVector30,r=h._btQuaternion0,o=h._btTransform0;t.btVector3_setValue(a,-n.x,n.y,n.z),t.btQuaternion_setValue(r,-i.x,i.y,i.z,-i.w),t.btTransform_setOrigin(o,a),t.btTransform_setRotation(o,r),t.btCompoundShape_updateChildTransform(this._btShape,e._indexInCompound,o,!0)}},{key:"addChildShape",value:function(e){if(e._attatched)throw"CompoundColliderShape: this shape has attatched to other entity.";e._attatched=!0,e._compoundParent=this,e._indexInCompound=this._childColliderShapes.length,this._childColliderShapes.push(e);var t=e.localOffset,n=e.localRotation,i=l.Physics3D._bullet;i.btVector3_setValue(CompoundColliderShape._btOffset,-t.x,t.y,t.z),i.btQuaternion_setValue(CompoundColliderShape._btRotation,-n.x,n.y,n.z,-n.w),i.btTransform_setOrigin(CompoundColliderShape._btTransform,CompoundColliderShape._btOffset),i.btTransform_setRotation(CompoundColliderShape._btTransform,CompoundColliderShape._btRotation);var a=i.btCollisionShape_getLocalScaling(this._btShape);i.btCollisionShape_setLocalScaling(this._btShape,CompoundColliderShape._btVector3One),i.btCompoundShape_addChildShape(this._btShape,CompoundColliderShape._btTransform,e._btShape),i.btCollisionShape_setLocalScaling(this._btShape,a),this._attatchedCollisionObject&&(this._attatchedCollisionObject.colliderShape=this)}},{key:"removeChildShape",value:function(e){if(e._compoundParent===this){var t=e._indexInCompound;this._clearChildShape(e);var n=this._childColliderShapes[this._childColliderShapes.length-1];n._indexInCompound=t,this._childColliderShapes[t]=n,this._childColliderShapes.pop(),l.Physics3D._bullet.btCompoundShape_removeChildShapeByIndex(this._btShape,t)}}},{key:"clearChildShape",value:function(){for(var e=0,t=this._childColliderShapes.length;e<t;e++)this._clearChildShape(this._childColliderShapes[e]),l.Physics3D._bullet.btCompoundShape_removeChildShapeByIndex(this._btShape,0);this._childColliderShapes.length=0}},{key:"getChildShapeCount",value:function(){return this._childColliderShapes.length}},{key:"cloneTo",value:function(e){var t=e;t.clearChildShape();for(var n=0,i=this._childColliderShapes.length;n<i;n++)t.addChildShape(this._childColliderShapes[n].clone())}},{key:"clone",value:function(){var e=new CompoundColliderShape;return this.cloneTo(e),e}},{key:"destroy",value:function(){_get(_getPrototypeOf(CompoundColliderShape.prototype),"destroy",this).call(this);for(var e=0,t=this._childColliderShapes.length;e<t;e++){var n=this._childColliderShapes[e];0===n._referenceCount&&n.destroy()}}}],[{key:"__init__",value:function(){var e=l.Physics3D._bullet;CompoundColliderShape._btVector3One=e.btVector3_create(1,1,1),CompoundColliderShape._btTransform=e.btTransform_create(),CompoundColliderShape._btOffset=e.btVector3_create(0,0,0),CompoundColliderShape._btRotation=e.btQuaternion_create(0,0,0,1)}}]),CompoundColliderShape}(),f=function(e){function Transform3D(e){var t;return _classCallCheck(this,Transform3D),(t=_possibleConstructorReturn(this,_getPrototypeOf(Transform3D).call(this)))._localPosition=new o(0,0,0),t._localRotation=new u(0,0,0,1),t._localScale=new o(1,1,1),t._localRotationEuler=new o(0,0,0),t._localMatrix=new c,t._position=new o(0,0,0),t._rotation=new u(0,0,0,1),t._scale=new o(1,1,1),t._rotationEuler=new o(0,0,0),t._worldMatrix=new c,t._children=null,t._parent=null,t._dummy=null,t._transformFlag=0,t._owner=e,t._children=[],t._setTransformFlag(Transform3D.TRANSFORM_LOCALQUATERNION|Transform3D.TRANSFORM_LOCALEULER|Transform3D.TRANSFORM_LOCALMATRIX,!1),t._setTransformFlag(Transform3D.TRANSFORM_WORLDPOSITION|Transform3D.TRANSFORM_WORLDQUATERNION|Transform3D.TRANSFORM_WORLDEULER|Transform3D.TRANSFORM_WORLDSCALE|Transform3D.TRANSFORM_WORLDMATRIX,!0),t}return _inherits(Transform3D,t.EventDispatcher),_createClass(Transform3D,[{key:"_getScaleMatrix",value:function(){var e=Transform3D._tempQuaternion0,t=Transform3D._tempMatrix3x30,n=Transform3D._tempMatrix3x31,i=Transform3D._tempMatrix3x32;return s.createFromMatrix4x4(this.worldMatrix,n),this.rotation.invert(e),s.createRotationQuaternion(e,t),s.multiply(t,n,i),i}},{key:"_setTransformFlag",value:function(e,t){t?this._transformFlag|=e:this._transformFlag&=~e}},{key:"_getTransformFlag",value:function(e){return 0!=(this._transformFlag&e)}},{key:"_setParent",value:function(e){if(this._parent!==e){if(this._parent){var t=this._parent._children,n=t.indexOf(this);t.splice(n,1)}e&&(e._children.push(this),e&&this._onWorldTransform()),this._parent=e}}},{key:"_onWorldPositionRotationTransform",value:function(){if(!(this._getTransformFlag(Transform3D.TRANSFORM_WORLDMATRIX)&&this._getTransformFlag(Transform3D.TRANSFORM_WORLDPOSITION)&&this._getTransformFlag(Transform3D.TRANSFORM_WORLDQUATERNION)&&this._getTransformFlag(Transform3D.TRANSFORM_WORLDEULER))){this._setTransformFlag(Transform3D.TRANSFORM_WORLDMATRIX|Transform3D.TRANSFORM_WORLDPOSITION|Transform3D.TRANSFORM_WORLDQUATERNION|Transform3D.TRANSFORM_WORLDEULER,!0),this.event(t.Event.TRANSFORM_CHANGED,this._transformFlag);for(var e=0,n=this._children.length;e<n;e++)this._children[e]._onWorldPositionRotationTransform()}}},{key:"_onWorldPositionScaleTransform",value:function(){if(!this._getTransformFlag(Transform3D.TRANSFORM_WORLDMATRIX)||!this._getTransformFlag(Transform3D.TRANSFORM_WORLDPOSITION)||!this._getTransformFlag(Transform3D.TRANSFORM_WORLDSCALE)){this._setTransformFlag(Transform3D.TRANSFORM_WORLDMATRIX|Transform3D.TRANSFORM_WORLDPOSITION|Transform3D.TRANSFORM_WORLDSCALE,!0),this.event(t.Event.TRANSFORM_CHANGED,this._transformFlag);for(var e=0,n=this._children.length;e<n;e++)this._children[e]._onWorldPositionScaleTransform()}}},{key:"_onWorldPositionTransform",value:function(){if(!this._getTransformFlag(Transform3D.TRANSFORM_WORLDMATRIX)||!this._getTransformFlag(Transform3D.TRANSFORM_WORLDPOSITION)){this._setTransformFlag(Transform3D.TRANSFORM_WORLDMATRIX|Transform3D.TRANSFORM_WORLDPOSITION,!0),this.event(t.Event.TRANSFORM_CHANGED,this._transformFlag);for(var e=0,n=this._children.length;e<n;e++)this._children[e]._onWorldPositionTransform()}}},{key:"_onWorldRotationTransform",value:function(){if(!this._getTransformFlag(Transform3D.TRANSFORM_WORLDMATRIX)||!this._getTransformFlag(Transform3D.TRANSFORM_WORLDQUATERNION)||!this._getTransformFlag(Transform3D.TRANSFORM_WORLDEULER)){this._setTransformFlag(Transform3D.TRANSFORM_WORLDMATRIX|Transform3D.TRANSFORM_WORLDQUATERNION|Transform3D.TRANSFORM_WORLDEULER,!0),this.event(t.Event.TRANSFORM_CHANGED,this._transformFlag);for(var e=0,n=this._children.length;e<n;e++)this._children[e]._onWorldPositionRotationTransform()}}},{key:"_onWorldScaleTransform",value:function(){if(!this._getTransformFlag(Transform3D.TRANSFORM_WORLDMATRIX)||!this._getTransformFlag(Transform3D.TRANSFORM_WORLDSCALE)){this._setTransformFlag(Transform3D.TRANSFORM_WORLDMATRIX|Transform3D.TRANSFORM_WORLDSCALE,!0),this.event(t.Event.TRANSFORM_CHANGED,this._transformFlag);for(var e=0,n=this._children.length;e<n;e++)this._children[e]._onWorldPositionScaleTransform()}}},{key:"_onWorldTransform",value:function(){if(!(this._getTransformFlag(Transform3D.TRANSFORM_WORLDMATRIX)&&this._getTransformFlag(Transform3D.TRANSFORM_WORLDPOSITION)&&this._getTransformFlag(Transform3D.TRANSFORM_WORLDQUATERNION)&&this._getTransformFlag(Transform3D.TRANSFORM_WORLDEULER)&&this._getTransformFlag(Transform3D.TRANSFORM_WORLDSCALE))){this._setTransformFlag(Transform3D.TRANSFORM_WORLDMATRIX|Transform3D.TRANSFORM_WORLDPOSITION|Transform3D.TRANSFORM_WORLDQUATERNION|Transform3D.TRANSFORM_WORLDEULER|Transform3D.TRANSFORM_WORLDSCALE,!0),this.event(t.Event.TRANSFORM_CHANGED,this._transformFlag);for(var e=0,n=this._children.length;e<n;e++)this._children[e]._onWorldTransform()}}},{key:"translate",value:function(e){!(arguments.length>1&&void 0!==arguments[1])||arguments[1]?(c.createFromQuaternion(this.localRotation,Transform3D._tempMatrix0),o.transformCoordinate(e,Transform3D._tempMatrix0,Transform3D._tempVector30),o.add(this.localPosition,Transform3D._tempVector30,this._localPosition),this.localPosition=this._localPosition):(o.add(this.position,e,this._position),this.position=this._position)}},{key:"rotate",value:function(e){var t,n=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];!(arguments.length>2&&void 0!==arguments[2])||arguments[2]?t=e:(o.scale(e,Math.PI/180,Transform3D._tempVector30),t=Transform3D._tempVector30),u.createFromYawPitchRoll(t.y,t.x,t.z,Transform3D._tempQuaternion0),n?(u.multiply(this._localRotation,Transform3D._tempQuaternion0,this._localRotation),this.localRotation=this._localRotation):(u.multiply(Transform3D._tempQuaternion0,this.rotation,this._rotation),this.rotation=this._rotation)}},{key:"getForward",value:function(e){var t=this.worldMatrix.elements;e.x=-t[8],e.y=-t[9],e.z=-t[10]}},{key:"getUp",value:function(e){var t=this.worldMatrix.elements;e.x=t[4],e.y=t[5],e.z=t[6]}},{key:"getRight",value:function(e){var t=this.worldMatrix.elements;e.x=t[0],e.y=t[1],e.z=t[2]}},{key:"lookAt",value:function(e,t){var i;if(arguments.length>2&&void 0!==arguments[2]&&arguments[2]){if(i=this._localPosition,Math.abs(i.x-e.x)<n.zeroTolerance&&Math.abs(i.y-e.y)<n.zeroTolerance&&Math.abs(i.z-e.z)<n.zeroTolerance)return;u.lookAt(this._localPosition,e,t,this._localRotation),this._localRotation.invert(this._localRotation),this.localRotation=this._localRotation}else{var a=this.position;if(i=a,Math.abs(i.x-e.x)<n.zeroTolerance&&Math.abs(i.y-e.y)<n.zeroTolerance&&Math.abs(i.z-e.z)<n.zeroTolerance)return;u.lookAt(a,e,t,this._rotation),this._rotation.invert(this._rotation),this.rotation=this._rotation}}},{key:"getWorldLossyScale",value:function(){if(this._getTransformFlag(Transform3D.TRANSFORM_WORLDSCALE)){if(null!==this._parent){var e=this._getScaleMatrix().elements;this._scale.x=e[0],this._scale.y=e[4],this._scale.z=e[8]}else this._localScale.cloneTo(this._scale);this._setTransformFlag(Transform3D.TRANSFORM_WORLDSCALE,!1)}return this._scale}},{key:"setWorldLossyScale",value:function(e){if(null!==this._parent){var t=Transform3D._tempMatrix3x33,n=Transform3D._tempMatrix3x33,i=n.elements,a=this._parent._getScaleMatrix();a.invert(a),s.createFromScaling(e,t),s.multiply(a,t,n),this._localScale.x=i[0],this._localScale.y=i[4],this._localScale.z=i[8]}else e.cloneTo(this._localScale);this.localScale=this._localScale,this._scale!==e&&e.cloneTo(this._scale),this._setTransformFlag(Transform3D.TRANSFORM_WORLDSCALE,!1)}},{key:"_isFrontFaceInvert",get:function(){var e=this.getWorldLossyScale(),t=e.x<0;return e.y<0&&(t=!t),e.z<0&&(t=!t),t}},{key:"owner",get:function(){return this._owner}},{key:"worldNeedUpdate",get:function(){return this._getTransformFlag(Transform3D.TRANSFORM_WORLDMATRIX)}},{key:"localPositionX",get:function(){return this._localPosition.x},set:function(e){this._localPosition.x=e,this.localPosition=this._localPosition}},{key:"localPositionY",get:function(){return this._localPosition.y},set:function(e){this._localPosition.y=e,this.localPosition=this._localPosition}},{key:"localPositionZ",get:function(){return this._localPosition.z},set:function(e){this._localPosition.z=e,this.localPosition=this._localPosition}},{key:"localPosition",get:function(){return this._localPosition},set:function(e){this._localPosition!==e&&e.cloneTo(this._localPosition),this._setTransformFlag(Transform3D.TRANSFORM_LOCALMATRIX,!0),this._onWorldPositionTransform()}},{key:"localRotationX",get:function(){return this.localRotation.x},set:function(e){this._localRotation.x=e,this.localRotation=this._localRotation}},{key:"localRotationY",get:function(){return this.localRotation.y},set:function(e){this._localRotation.y=e,this.localRotation=this._localRotation}},{key:"localRotationZ",get:function(){return this.localRotation.z},set:function(e){this._localRotation.z=e,this.localRotation=this._localRotation}},{key:"localRotationW",get:function(){return this.localRotation.w},set:function(e){this._localRotation.w=e,this.localRotation=this._localRotation}},{key:"localRotation",get:function(){if(this._getTransformFlag(Transform3D.TRANSFORM_LOCALQUATERNION)){var e=this._localRotationEuler;u.createFromYawPitchRoll(e.y/Transform3D._angleToRandin,e.x/Transform3D._angleToRandin,e.z/Transform3D._angleToRandin,this._localRotation),this._setTransformFlag(Transform3D.TRANSFORM_LOCALQUATERNION,!1)}return this._localRotation},set:function(e){this._localRotation!==e&&e.cloneTo(this._localRotation),this._localRotation.normalize(this._localRotation),this._setTransformFlag(Transform3D.TRANSFORM_LOCALEULER|Transform3D.TRANSFORM_LOCALMATRIX,!0),this._setTransformFlag(Transform3D.TRANSFORM_LOCALQUATERNION,!1),this._onWorldRotationTransform()}},{key:"localScaleX",get:function(){return this._localScale.x},set:function(e){this._localScale.x=e,this.localScale=this._localScale}},{key:"localScaleY",get:function(){return this._localScale.y},set:function(e){this._localScale.y=e,this.localScale=this._localScale}},{key:"localScaleZ",get:function(){return this._localScale.z},set:function(e){this._localScale.z=e,this.localScale=this._localScale}},{key:"localScale",get:function(){return this._localScale},set:function(e){this._localScale!==e&&e.cloneTo(this._localScale),this._setTransformFlag(Transform3D.TRANSFORM_LOCALMATRIX,!0),this._onWorldScaleTransform()}},{key:"localRotationEulerX",get:function(){return this.localRotationEuler.x},set:function(e){this._localRotationEuler.x=e,this.localRotationEuler=this._localRotationEuler}},{key:"localRotationEulerY",get:function(){return this.localRotationEuler.y},set:function(e){this._localRotationEuler.y=e,this.localRotationEuler=this._localRotationEuler}},{key:"localRotationEulerZ",get:function(){return this.localRotationEuler.z},set:function(e){this._localRotationEuler.z=e,this.localRotationEuler=this._localRotationEuler}},{key:"localRotationEuler",get:function(){if(this._getTransformFlag(Transform3D.TRANSFORM_LOCALEULER)){this._localRotation.getYawPitchRoll(Transform3D._tempVector30);var e=Transform3D._tempVector30,t=this._localRotationEuler;t.x=e.y*Transform3D._angleToRandin,t.y=e.x*Transform3D._angleToRandin,t.z=e.z*Transform3D._angleToRandin,this._setTransformFlag(Transform3D.TRANSFORM_LOCALEULER,!1)}return this._localRotationEuler},set:function(e){this._localRotationEuler!==e&&e.cloneTo(this._localRotationEuler),this._setTransformFlag(Transform3D.TRANSFORM_LOCALEULER,!1),this._setTransformFlag(Transform3D.TRANSFORM_LOCALQUATERNION|Transform3D.TRANSFORM_LOCALMATRIX,!0),this._onWorldRotationTransform()}},{key:"localMatrix",get:function(){return this._getTransformFlag(Transform3D.TRANSFORM_LOCALMATRIX)&&(c.createAffineTransformation(this._localPosition,this.localRotation,this._localScale,this._localMatrix),this._setTransformFlag(Transform3D.TRANSFORM_LOCALMATRIX,!1)),this._localMatrix},set:function(e){this._localMatrix!==e&&e.cloneTo(this._localMatrix),this._localMatrix.decomposeTransRotScale(this._localPosition,this._localRotation,this._localScale),this._setTransformFlag(Transform3D.TRANSFORM_LOCALEULER,!0),this._setTransformFlag(Transform3D.TRANSFORM_LOCALMATRIX,!1),this._onWorldTransform()}},{key:"position",get:function(){if(this._getTransformFlag(Transform3D.TRANSFORM_WORLDPOSITION)){if(null!=this._parent){var e=this.worldMatrix.elements;this._position.x=e[12],this._position.y=e[13],this._position.z=e[14]}else this._localPosition.cloneTo(this._position);this._setTransformFlag(Transform3D.TRANSFORM_WORLDPOSITION,!1)}return this._position},set:function(e){if(null!=this._parent){var t=Transform3D._tempMatrix0;this._parent.worldMatrix.invert(t),o.transformCoordinate(e,t,this._localPosition)}else e.cloneTo(this._localPosition);this.localPosition=this._localPosition,this._position!==e&&e.cloneTo(this._position),this._setTransformFlag(Transform3D.TRANSFORM_WORLDPOSITION,!1)}},{key:"rotation",get:function(){return this._getTransformFlag(Transform3D.TRANSFORM_WORLDQUATERNION)&&(null!=this._parent?u.multiply(this._parent.rotation,this.localRotation,this._rotation):this.localRotation.cloneTo(this._rotation),this._setTransformFlag(Transform3D.TRANSFORM_WORLDQUATERNION,!1)),this._rotation},set:function(e){null!=this._parent?(this._parent.rotation.invert(Transform3D._tempQuaternion0),u.multiply(Transform3D._tempQuaternion0,e,this._localRotation)):e.cloneTo(this._localRotation),this.localRotation=this._localRotation,e!==this._rotation&&e.cloneTo(this._rotation),this._setTransformFlag(Transform3D.TRANSFORM_WORLDQUATERNION,!1)}},{key:"rotationEuler",get:function(){if(this._getTransformFlag(Transform3D.TRANSFORM_WORLDEULER)){this.rotation.getYawPitchRoll(Transform3D._tempVector30);var e=Transform3D._tempVector30,t=this._rotationEuler;t.x=e.y*Transform3D._angleToRandin,t.y=e.x*Transform3D._angleToRandin,t.z=e.z*Transform3D._angleToRandin,this._setTransformFlag(Transform3D.TRANSFORM_WORLDEULER,!1)}return this._rotationEuler},set:function(e){u.createFromYawPitchRoll(e.y/Transform3D._angleToRandin,e.x/Transform3D._angleToRandin,e.z/Transform3D._angleToRandin,this._rotation),this.rotation=this._rotation,this._rotationEuler!==e&&e.cloneTo(this._rotationEuler),this._setTransformFlag(Transform3D.TRANSFORM_WORLDEULER,!1)}},{key:"worldMatrix",get:function(){return this._getTransformFlag(Transform3D.TRANSFORM_WORLDMATRIX)&&(null!=this._parent?c.multiply(this._parent.worldMatrix,this.localMatrix,this._worldMatrix):this.localMatrix.cloneTo(this._worldMatrix),this._setTransformFlag(Transform3D.TRANSFORM_WORLDMATRIX,!1)),this._worldMatrix},set:function(e){null===this._parent?e.cloneTo(this._localMatrix):(this._parent.worldMatrix.invert(this._localMatrix),c.multiply(this._localMatrix,e,this._localMatrix)),this.localMatrix=this._localMatrix,this._worldMatrix!==e&&e.cloneTo(this._worldMatrix),this._setTransformFlag(Transform3D.TRANSFORM_WORLDMATRIX,!1)}},{key:"scale",get:function(){return console.warn("Transfrm3D: discard function,please use getWorldLossyScale instead."),this.getWorldLossyScale()},set:function(e){console.warn("Transfrm3D: discard function,please use setWorldLossyScale instead."),this.setWorldLossyScale(e)}}]),Transform3D}();f._tempVector30=new o,f._tempQuaternion0=new u,f._tempMatrix0=new c,f._tempMatrix3x30=new s,f._tempMatrix3x31=new s,f._tempMatrix3x32=new s,f._tempMatrix3x33=new s,f.TRANSFORM_LOCALQUATERNION=1,f.TRANSFORM_LOCALEULER=2,f.TRANSFORM_LOCALMATRIX=4,f.TRANSFORM_WORLDPOSITION=8,f.TRANSFORM_WORLDQUATERNION=16,f.TRANSFORM_WORLDSCALE=32,f.TRANSFORM_WORLDMATRIX=64,f.TRANSFORM_WORLDEULER=128,f._angleToRandin=180/Math.PI;var m=function(){function Physics3DUtils(){_classCallCheck(this,Physics3DUtils)}return _createClass(Physics3DUtils,null,[{key:"setColliderCollision",value:function(e,t,n){}},{key:"getIColliderCollision",value:function(e,t){return!1}}]),Physics3DUtils}();m.COLLISIONFILTERGROUP_DEFAULTFILTER=1,m.COLLISIONFILTERGROUP_STATICFILTER=2,m.COLLISIONFILTERGROUP_KINEMATICFILTER=4,m.COLLISIONFILTERGROUP_DEBRISFILTER=8,m.COLLISIONFILTERGROUP_SENSORTRIGGER=16,m.COLLISIONFILTERGROUP_CHARACTERFILTER=32,m.COLLISIONFILTERGROUP_CUSTOMFILTER1=64,m.COLLISIONFILTERGROUP_CUSTOMFILTER2=128,m.COLLISIONFILTERGROUP_CUSTOMFILTER3=256,m.COLLISIONFILTERGROUP_CUSTOMFILTER4=512,m.COLLISIONFILTERGROUP_CUSTOMFILTER5=1024,m.COLLISIONFILTERGROUP_CUSTOMFILTER6=2048,m.COLLISIONFILTERGROUP_CUSTOMFILTER7=4096,m.COLLISIONFILTERGROUP_CUSTOMFILTER8=8192,m.COLLISIONFILTERGROUP_CUSTOMFILTER9=16384,m.COLLISIONFILTERGROUP_CUSTOMFILTER10=32768,m.COLLISIONFILTERGROUP_ALLFILTER=-1,m.gravity=new o(0,-9.81,0);var p=function(e){function BoxColliderShape(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1;_classCallCheck(this,BoxColliderShape),(e=_possibleConstructorReturn(this,_getPrototypeOf(BoxColliderShape).call(this)))._sizeX=t,e._sizeY=n,e._sizeZ=i,e._type=h.SHAPETYPES_BOX;var a=l.Physics3D._bullet;return a.btVector3_setValue(BoxColliderShape._btSize,t/2,n/2,i/2),e._btShape=a.btBoxShape_create(BoxColliderShape._btSize),e}return _inherits(BoxColliderShape,h),_createClass(BoxColliderShape,[{key:"clone",value:function(){var e=new BoxColliderShape(this._sizeX,this._sizeY,this._sizeZ);return this.cloneTo(e),e}},{key:"sizeX",get:function(){return this._sizeX}},{key:"sizeY",get:function(){return this._sizeY}},{key:"sizeZ",get:function(){return this._sizeZ}}],[{key:"__init__",value:function(){BoxColliderShape._btSize=l.Physics3D._bullet.btVector3_create(0,0,0)}}]),BoxColliderShape}(),T=function(e){function CapsuleColliderShape(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:.5,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1.25,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:h.SHAPEORIENTATION_UPY;_classCallCheck(this,CapsuleColliderShape),(e=_possibleConstructorReturn(this,_getPrototypeOf(CapsuleColliderShape).call(this)))._radius=t,e._length=n,e._orientation=i,e._type=h.SHAPETYPES_CAPSULE;var a=l.Physics3D._bullet;switch(i){case h.SHAPEORIENTATION_UPX:e._btShape=a.btCapsuleShapeX_create(t,n-2*t);break;case h.SHAPEORIENTATION_UPY:e._btShape=a.btCapsuleShape_create(t,n-2*t);break;case h.SHAPEORIENTATION_UPZ:e._btShape=a.btCapsuleShapeZ_create(t,n-2*t);break;default:throw"CapsuleColliderShape:unknown orientation."}return e}return _inherits(CapsuleColliderShape,h),_createClass(CapsuleColliderShape,[{key:"_setScale",value:function(e){var t=CapsuleColliderShape._tempVector30;switch(this.orientation){case h.SHAPEORIENTATION_UPX:t.x=e.x,t.y=t.z=Math.max(e.y,e.z);break;case h.SHAPEORIENTATION_UPY:t.y=e.y,t.x=t.z=Math.max(e.x,e.z);break;case h.SHAPEORIENTATION_UPZ:t.z=e.z,t.x=t.y=Math.max(e.x,e.y);break;default:throw"CapsuleColliderShape:unknown orientation."}_get(_getPrototypeOf(CapsuleColliderShape.prototype),"_setScale",this).call(this,t)}},{key:"clone",value:function(){var e=new CapsuleColliderShape(this._radius,this._length,this._orientation);return this.cloneTo(e),e}},{key:"radius",get:function(){return this._radius}},{key:"length",get:function(){return this._length}},{key:"orientation",get:function(){return this._orientation}}]),CapsuleColliderShape}();T._tempVector30=new o;var v=function(e){function ConeColliderShape(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:.5,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:h.SHAPEORIENTATION_UPY;_classCallCheck(this,ConeColliderShape),(e=_possibleConstructorReturn(this,_getPrototypeOf(ConeColliderShape).call(this)))._radius=1,e._height=.5,e._radius=t,e._height=n,e._orientation=i,e._type=h.SHAPETYPES_CYLINDER;var a=l.Physics3D._bullet;switch(i){case h.SHAPEORIENTATION_UPX:e._btShape=a.btConeShapeX_create(t,n);break;case h.SHAPEORIENTATION_UPY:e._btShape=a.btConeShape_create(t,n);break;case h.SHAPEORIENTATION_UPZ:e._btShape=a.btConeShapeZ_create(t,n);break;default:throw"ConeColliderShape:unknown orientation."}return e}return _inherits(ConeColliderShape,h),_createClass(ConeColliderShape,[{key:"clone",value:function(){var e=new ConeColliderShape(this._radius,this._height,this._orientation);return this.cloneTo(e),e}},{key:"radius",get:function(){return this._radius}},{key:"height",get:function(){return this._height}},{key:"orientation",get:function(){return this._orientation}}]),ConeColliderShape}(),g=function(e){function CylinderColliderShape(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:.5,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:h.SHAPEORIENTATION_UPY;_classCallCheck(this,CylinderColliderShape),(e=_possibleConstructorReturn(this,_getPrototypeOf(CylinderColliderShape).call(this)))._radius=1,e._height=.5,e._radius=t,e._height=n,e._orientation=i,e._type=h.SHAPETYPES_CYLINDER;var a=l.Physics3D._bullet;switch(i){case h.SHAPEORIENTATION_UPX:a.btVector3_setValue(CylinderColliderShape._btSize,n/2,t,t),e._btShape=a.btCylinderShapeX_create(CylinderColliderShape._btSize);break;case h.SHAPEORIENTATION_UPY:a.btVector3_setValue(CylinderColliderShape._btSize,t,n/2,t),e._btShape=a.btCylinderShape_create(CylinderColliderShape._btSize);break;case h.SHAPEORIENTATION_UPZ:a.btVector3_setValue(CylinderColliderShape._btSize,t,t,n/2),e._btShape=a.btCylinderShapeZ_create(CylinderColliderShape._btSize);break;default:throw"CapsuleColliderShape:unknown orientation."}return e}return _inherits(CylinderColliderShape,h),_createClass(CylinderColliderShape,[{key:"clone",value:function(){var e=new CylinderColliderShape(this._radius,this._height,this._orientation);return this.cloneTo(e),e}},{key:"radius",get:function(){return this._radius}},{key:"height",get:function(){return this._height}},{key:"orientation",get:function(){return this._orientation}}],[{key:"__init__",value:function(){CylinderColliderShape._btSize=l.Physics3D._bullet.btVector3_create(0,0,0)}}]),CylinderColliderShape}(),E=function(e){function MeshColliderShape(){var e;return _classCallCheck(this,MeshColliderShape),(e=_possibleConstructorReturn(this,_getPrototypeOf(MeshColliderShape).call(this)))._mesh=null,e._convex=!1,e}return _inherits(MeshColliderShape,h),_createClass(MeshColliderShape,[{key:"_setScale",value:function(e){if(this._compoundParent)this.updateLocalTransformations();else{var t=l.Physics3D._bullet;t.btVector3_setValue(h._btScale,e.x,e.y,e.z),t.btCollisionShape_setLocalScaling(this._btShape,h._btScale),t.btGImpactShapeInterface_updateBound(this._btShape)}}},{key:"cloneTo",value:function(e){var t=e;t.convex=this._convex,t.mesh=this._mesh,_get(_getPrototypeOf(MeshColliderShape.prototype),"cloneTo",this).call(this,e)}},{key:"clone",value:function(){var e=new MeshColliderShape;return this.cloneTo(e),e}},{key:"destroy",value:function(){this._btShape&&(l.Physics3D._bullet.btCollisionShape_destroy(this._btShape),this._btShape=null)}},{key:"mesh",get:function(){return this._mesh},set:function(e){if(this._mesh!==e){var t=l.Physics3D._bullet;this._mesh&&t.btCollisionShape_destroy(this._btShape),e&&(this._btShape=t.btGImpactMeshShape_create(e._getPhysicMesh()),t.btGImpactShapeInterface_updateBound(this._btShape)),this._mesh=e}}},{key:"convex",get:function(){return this._convex},set:function(e){this._convex=e}}]),MeshColliderShape}(),y=function(e){function SphereColliderShape(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:.5;return _classCallCheck(this,SphereColliderShape),(e=_possibleConstructorReturn(this,_getPrototypeOf(SphereColliderShape).call(this)))._radius=t,e._type=h.SHAPETYPES_SPHERE,e._btShape=l.Physics3D._bullet.btSphereShape_create(t),e}return _inherits(SphereColliderShape,h),_createClass(SphereColliderShape,[{key:"clone",value:function(){var e=new SphereColliderShape(this._radius);return this.cloneTo(e),e}},{key:"radius",get:function(){return this._radius}}]),SphereColliderShape}(),S=function(e){function PhysicsComponent(e,t){var n;return _classCallCheck(this,PhysicsComponent),(n=_possibleConstructorReturn(this,_getPrototypeOf(PhysicsComponent).call(this)))._restitution=0,n._friction=.5,n._rollingFriction=0,n._ccdMotionThreshold=0,n._ccdSweptSphereRadius=0,n._collisionGroup=m.COLLISIONFILTERGROUP_DEFAULTFILTER,n._canCollideWith=m.COLLISIONFILTERGROUP_ALLFILTER,n._colliderShape=null,n._transformFlag=2147483647,n._controlBySimulation=!1,n._enableProcessCollisions=!0,n._inPhysicUpdateListIndex=-1,n.canScaleShape=!0,n._collisionGroup=e,n._canCollideWith=t,PhysicsComponent._physicObjectsMap[n.id]=_assertThisInitialized(n),n}return _inherits(PhysicsComponent,t.Component),_createClass(PhysicsComponent,[{key:"_parseShape",value:function(e){var t=e.length;if(1===t){var n=PhysicsComponent._creatShape(e[0]);this.colliderShape=n}else{for(var i=new d,a=0;a<t;a++)n=PhysicsComponent._creatShape(e[a]),i.addChildShape(n);this.colliderShape=i}}},{key:"_onScaleChange",value:function(e){this._colliderShape._setScale(e)}},{key:"_onEnable",value:function(){this._simulation=this.owner._scene.physicsSimulation,l.Physics3D._bullet.btCollisionObject_setContactProcessingThreshold(this._btColliderObject,0),this._colliderShape&&(this._derivePhysicsTransformation(!0),this._addToSimulation())}},{key:"_onDisable",value:function(){this._colliderShape&&(this._removeFromSimulation(),-1!==this._inPhysicUpdateListIndex&&this._simulation._physicsUpdateList.remove(this)),this._simulation=null}},{key:"_onDestroy",value:function(){delete PhysicsComponent._physicObjectsMap[this.id],l.Physics3D._bullet.btCollisionObject_destroy(this._btColliderObject),this._colliderShape.destroy(),_get(_getPrototypeOf(PhysicsComponent.prototype),"_onDestroy",this).call(this),this._btColliderObject=null,this._colliderShape=null,this._simulation=null,this.owner.transform.off(t.Event.TRANSFORM_CHANGED,this,this._onTransformChanged)}},{key:"_isValid",value:function(){return this._simulation&&this._colliderShape&&this._enabled}},{key:"_parse",value:function(e){null!=e.collisionGroup&&(this.collisionGroup=e.collisionGroup),null!=e.canCollideWith&&(this.canCollideWith=e.canCollideWith),null!=e.ccdMotionThreshold&&(this.ccdMotionThreshold=e.ccdMotionThreshold),null!=e.ccdSweptSphereRadius&&(this.ccdSweptSphereRadius=e.ccdSweptSphereRadius)}},{key:"_setTransformFlag",value:function(e,t){t?this._transformFlag|=e:this._transformFlag&=~e}},{key:"_getTransformFlag",value:function(e){return 0!=(this._transformFlag&e)}},{key:"_addToSimulation",value:function(){}},{key:"_removeFromSimulation",value:function(){}},{key:"_derivePhysicsTransformation",value:function(e){var t=l.Physics3D._bullet,n=this._btColliderObject,i=t.btCollisionObject_getWorldTransform(n);this._innerDerivePhysicsTransformation(i,e),t.btCollisionObject_setWorldTransform(n,i)}},{key:"_innerDerivePhysicsTransformation",value:function(e,t){var n=l.Physics3D._bullet,i=this.owner._transform;if(t||this._getTransformFlag(f.TRANSFORM_WORLDPOSITION)){var a=this._colliderShape.localOffset,r=i.position,s=PhysicsComponent._btVector30;if(0!==a.x||0!==a.y||0!==a.z){var u=PhysicsComponent._tempVector30,c=i.worldMatrix;o.transformCoordinate(a,c,u),n.btVector3_setValue(s,-u.x,u.y,u.z)}else n.btVector3_setValue(s,-r.x,r.y,r.z);n.btTransform_setOrigin(e,s),this._setTransformFlag(f.TRANSFORM_WORLDPOSITION,!1)}if(t||this._getTransformFlag(f.TRANSFORM_WORLDQUATERNION)){var h=this._colliderShape.localRotation,_=PhysicsComponent._btQuaternion0,d=i.rotation;if(0!==h.x||0!==h.y||0!==h.z||1!==h.w){var m=PhysicsComponent._tempQuaternion0;PhysicsComponent.physicQuaternionMultiply(d.x,d.y,d.z,d.w,h,m),n.btQuaternion_setValue(_,-m.x,m.y,m.z,-m.w)}else n.btQuaternion_setValue(_,-d.x,d.y,d.z,-d.w);n.btTransform_setRotation(e,_),this._setTransformFlag(f.TRANSFORM_WORLDQUATERNION,!1)}(t||this._getTransformFlag(f.TRANSFORM_WORLDSCALE))&&(this._onScaleChange(i.getWorldLossyScale()),this._setTransformFlag(f.TRANSFORM_WORLDSCALE,!1))}},{key:"_updateTransformComponent",value:function(e){var t=l.Physics3D._bullet,n=this._colliderShape,i=n.localOffset,a=n.localRotation,r=this.owner._transform,s=r.position,u=r.rotation,c=t.btTransform_getOrigin(e),h=t.btTransform_getRotation(e),_=-t.btQuaternion_x(h),d=t.btQuaternion_y(h),f=t.btQuaternion_z(h),m=-t.btQuaternion_w(h);if(0!==a.x||0!==a.y||0!==a.z||1!==a.w){var p=PhysicsComponent._tempQuaternion0;a.invert(p),PhysicsComponent.physicQuaternionMultiply(_,d,f,m,p,u)}else u.x=_,u.y=d,u.z=f,u.w=m;if(r.rotation=u,0!==i.x||0!==i.y||0!==i.z){var T=t.btCollisionShape_getLocalScaling(n._btShape),v=PhysicsComponent._tempVector30;v.x=i.x*t.btVector3_x(T),v.y=i.y*t.btVector3_y(T),v.z=i.z*t.btVector3_z(T),o.transformQuat(v,u,v),s.x=-t.btVector3_x(c)-v.x,s.y=t.btVector3_y(c)-v.y,s.z=t.btVector3_z(c)-v.z}else s.x=-t.btVector3_x(c),s.y=t.btVector3_y(c),s.z=t.btVector3_z(c);r.position=s}},{key:"_onShapeChange",value:function(e){var t=this._btColliderObject,n=l.Physics3D._bullet,i=n.btCollisionObject_getCollisionFlags(t);e.needsCustomCollisionCallback?0==(i&PhysicsComponent.COLLISIONFLAGS_CUSTOM_MATERIAL_CALLBACK)&&n.btCollisionObject_setCollisionFlags(t,i|PhysicsComponent.COLLISIONFLAGS_CUSTOM_MATERIAL_CALLBACK):(i&PhysicsComponent.COLLISIONFLAGS_CUSTOM_MATERIAL_CALLBACK)>0&&n.btCollisionObject_setCollisionFlags(t,i^PhysicsComponent.COLLISIONFLAGS_CUSTOM_MATERIAL_CALLBACK)}},{key:"_onAdded",value:function(){this.enabled=this._enabled,this.restitution=this._restitution,this.friction=this._friction,this.rollingFriction=this._rollingFriction,this.ccdMotionThreshold=this._ccdMotionThreshold,this.ccdSweptSphereRadius=this._ccdSweptSphereRadius,this.owner.transform.on(t.Event.TRANSFORM_CHANGED,this,this._onTransformChanged)}},{key:"_onTransformChanged",value:function(e){!PhysicsComponent._addUpdateList&&this._controlBySimulation||(e&=f.TRANSFORM_WORLDPOSITION|f.TRANSFORM_WORLDQUATERNION|f.TRANSFORM_WORLDSCALE)&&(this._transformFlag|=e,this._isValid()&&-1===this._inPhysicUpdateListIndex&&this._simulation._physicsUpdateList.add(this))}},{key:"_cloneTo",value:function(e){var t=e;t.restitution=this._restitution,t.friction=this._friction,t.rollingFriction=this._rollingFriction,t.ccdMotionThreshold=this._ccdMotionThreshold,t.ccdSweptSphereRadius=this._ccdSweptSphereRadius,t.collisionGroup=this._collisionGroup,t.canCollideWith=this._canCollideWith,t.canScaleShape=this.canScaleShape,this._colliderShape&&(t.colliderShape=this._colliderShape.clone())}},{key:"restitution",get:function(){return this._restitution},set:function(e){this._restitution=e,this._btColliderObject&&l.Physics3D._bullet.btCollisionObject_setRestitution(this._btColliderObject,e)}},{key:"friction",get:function(){return this._friction},set:function(e){this._friction=e,this._btColliderObject&&l.Physics3D._bullet.btCollisionObject_setFriction(this._btColliderObject,e)}},{key:"rollingFriction",get:function(){return this._rollingFriction},set:function(e){this._rollingFriction=e,this._btColliderObject&&l.Physics3D._bullet.btCollisionObject_setRollingFriction(this._btColliderObject,e)}},{key:"ccdMotionThreshold",get:function(){return this._ccdMotionThreshold},set:function(e){this._ccdMotionThreshold=e,this._btColliderObject&&l.Physics3D._bullet.btCollisionObject_setCcdMotionThreshold(this._btColliderObject,e)}},{key:"ccdSweptSphereRadius",get:function(){return this._ccdSweptSphereRadius},set:function(e){this._ccdSweptSphereRadius=e,this._btColliderObject&&l.Physics3D._bullet.btCollisionObject_setCcdSweptSphereRadius(this._btColliderObject,e)}},{key:"isActive",get:function(){return!!this._btColliderObject&&l.Physics3D._bullet.btCollisionObject_isActive(this._btColliderObject)}},{key:"colliderShape",get:function(){return this._colliderShape},set:function(e){var t=this._colliderShape;if(t&&(t._attatched=!1,t._attatchedCollisionObject=null),this._colliderShape=e,e){if(e._attatched)throw"PhysicsComponent: this shape has attatched to other entity.";if(e._attatched=!0,e._attatchedCollisionObject=this,this._btColliderObject){l.Physics3D._bullet.btCollisionObject_setCollisionShape(this._btColliderObject,e._btShape);var n=this._simulation&&this._enabled;n&&t&&this._removeFromSimulation(),this._onShapeChange(e),n&&(this._derivePhysicsTransformation(!0),this._addToSimulation())}}else this._simulation&&this._enabled&&t&&this._removeFromSimulation()}},{key:"simulation",get:function(){return this._simulation}},{key:"collisionGroup",get:function(){return this._collisionGroup},set:function(e){this._collisionGroup!==e&&(this._collisionGroup=e,this._simulation&&this._colliderShape&&this._enabled&&(this._removeFromSimulation(),this._addToSimulation()))}},{key:"canCollideWith",get:function(){return this._canCollideWith},set:function(e){this._canCollideWith!==e&&(this._canCollideWith=e,this._simulation&&this._colliderShape&&this._enabled&&(this._removeFromSimulation(),this._addToSimulation()))}}],[{key:"__init__",value:function(){var e=l.Physics3D._bullet;PhysicsComponent._btVector30=e.btVector3_create(0,0,0),PhysicsComponent._btQuaternion0=e.btQuaternion_create(0,0,0,1)}},{key:"_createAffineTransformationArray",value:function(e,t,n,i,a,r,o,s,l){var u=i+i,c=a+a,h=r+r,_=i*u,d=i*c,f=i*h,m=a*c,p=a*h,T=r*h,v=o*u,g=o*c,E=o*h,y=s[0],S=s[1],R=s[2];l[0]=(1-(m+T))*y,l[1]=(d+E)*y,l[2]=(f-g)*y,l[3]=0,l[4]=(d-E)*S,l[5]=(1-(_+T))*S,l[6]=(p+v)*S,l[7]=0,l[8]=(f+g)*R,l[9]=(p-v)*R,l[10]=(1-(_+m))*R,l[11]=0,l[12]=e,l[13]=t,l[14]=n,l[15]=1}},{key:"_creatShape",value:function(e){var n;switch(e.type){case"BoxColliderShape":var i=e.size;n=i?new p(i[0],i[1],i[2]):new p;break;case"SphereColliderShape":n=new y(e.radius);break;case"CapsuleColliderShape":n=new T(e.radius,e.height,e.orientation);break;case"MeshColliderShape":var a=new E;e.mesh&&(a.mesh=t.Loader.getRes(e.mesh)),n=a;break;case"ConeColliderShape":n=new v(e.radius,e.height,e.orientation);break;case"CylinderColliderShape":n=new g(e.radius,e.height,e.orientation);break;default:throw"unknown shape type."}if(e.center){var r=n.localOffset;r.fromArray(e.center),n.localOffset=r}return n}},{key:"physicVector3TransformQuat",value:function(e,t,n,i,a,r){var o=e.x,s=e.y,l=e.z,u=a*o+n*l-i*s,c=a*s+i*o-t*l,h=a*l+t*s-n*o,_=-t*o-n*s-i*l;r.x=u*a+_*-t+c*-i-h*-n,r.y=c*a+_*-n+h*-t-u*-i,r.z=h*a+_*-i+u*-n-c*-t}},{key:"physicQuaternionMultiply",value:function(e,t,n,i,a,r){var o=a.x,s=a.y,l=a.z,u=a.w,c=t*l-n*s,h=n*o-e*l,_=e*s-t*o,d=e*o+t*s+n*l;r.x=e*u+o*i+c,r.y=t*u+s*i+h,r.z=n*u+l*i+_,r.w=i*u-d}}]),PhysicsComponent}();S.ACTIVATIONSTATE_ACTIVE_TAG=1,S.ACTIVATIONSTATE_ISLAND_SLEEPING=2,S.ACTIVATIONSTATE_WANTS_DEACTIVATION=3,S.ACTIVATIONSTATE_DISABLE_DEACTIVATION=4,S.ACTIVATIONSTATE_DISABLE_SIMULATION=5,S.COLLISIONFLAGS_STATIC_OBJECT=1,S.COLLISIONFLAGS_KINEMATIC_OBJECT=2,S.COLLISIONFLAGS_NO_CONTACT_RESPONSE=4,S.COLLISIONFLAGS_CUSTOM_MATERIAL_CALLBACK=8,S.COLLISIONFLAGS_CHARACTER_OBJECT=16,S.COLLISIONFLAGS_DISABLE_VISUALIZE_OBJECT=32,S.COLLISIONFLAGS_DISABLE_SPU_COLLISION_PROCESSING=64,S._tempVector30=new o,S._tempQuaternion0=new u,S._tempQuaternion1=new u,S._tempMatrix4x40=new c,S._physicObjectsMap={},S._addUpdateList=!0;var R=function(){function SingletonList(){_classCallCheck(this,SingletonList),this.elements=[],this.length=0}return _createClass(SingletonList,[{key:"_add",value:function(e){this.length===this.elements.length?this.elements.push(e):this.elements[this.length]=e}},{key:"add",value:function(e){this.length===this.elements.length?this.elements.push(e):this.elements[this.length]=e,this.length++}}]),SingletonList}(),C=function(e){function PhysicsUpdateList(){return _classCallCheck(this,PhysicsUpdateList),_possibleConstructorReturn(this,_getPrototypeOf(PhysicsUpdateList).call(this))}return _inherits(PhysicsUpdateList,R),_createClass(PhysicsUpdateList,[{key:"add",value:function(e){if(-1!==e._inPhysicUpdateListIndex)throw"PhysicsUpdateList:element has  in  PhysicsUpdateList.";this._add(e),e._inPhysicUpdateListIndex=this.length++}},{key:"remove",value:function(e){var t=e._inPhysicUpdateListIndex;if(this.length--,t!==this.length){var n=this.elements[this.length];this.elements[t]=n,n._inPhysicUpdateListIndex=t}e._inPhysicUpdateListIndex=-1}}]),PhysicsUpdateList}(),M=function ContactPoint(){_classCallCheck(this,ContactPoint),this._idCounter=0,this.colliderA=null,this.colliderB=null,this.distance=0,this.normal=new o,this.positionOnA=new o,this.positionOnB=new o,this._id=++this._idCounter},D=function HitResult(){_classCallCheck(this,HitResult),this.succeeded=!1,this.collider=null,this.point=new o,this.normal=new o,this.hitFraction=0},x=function(){function Collision(){_classCallCheck(this,Collision),this._lastUpdateFrame=-2147483648,this._updateFrame=-2147483648,this._isTrigger=!1,this.contacts=[]}return _createClass(Collision,[{key:"_setUpdateFrame",value:function(e){this._lastUpdateFrame=this._updateFrame,this._updateFrame=e}}]),Collision}(),A=function(){function CollisionTool(){_classCallCheck(this,CollisionTool),this._hitResultsPoolIndex=0,this._hitResultsPool=[],this._contactPonintsPoolIndex=0,this._contactPointsPool=[],this._collisionsPool=[],this._collisions={}}return _createClass(CollisionTool,[{key:"getHitResult",value:function(){var e=this._hitResultsPool[this._hitResultsPoolIndex++];return e||(e=new D,this._hitResultsPool.push(e)),e}},{key:"recoverAllHitResultsPool",value:function(){this._hitResultsPoolIndex=0}},{key:"getContactPoints",value:function(){var e=this._contactPointsPool[this._contactPonintsPoolIndex++];return e||(e=new M,this._contactPointsPool.push(e)),e}},{key:"recoverAllContactPointsPool",value:function(){this._contactPonintsPoolIndex=0}},{key:"getCollision",value:function(e,t){var n,i=e.id,a=t.id,r=this._collisions[i];return r&&(n=r[a]),n||(r||(r={},this._collisions[i]=r),(n=0===this._collisionsPool.length?new x:this._collisionsPool.pop())._colliderA=e,n._colliderB=t,r[a]=n),n}},{key:"recoverCollision",value:function(e){var t=e._colliderA.id,n=e._colliderB.id;this._collisions[t][n]=null,this._collisionsPool.push(e)}},{key:"garbageCollection",value:function(){for(var e in this._hitResultsPoolIndex=0,this._hitResultsPool.length=0,this._contactPonintsPoolIndex=0,this._contactPointsPool.length=0,this._collisionsPool.length=0,this._collisionsPool){var t=this._collisionsPool[e],n=!0;for(var i in t)t[i]?n=!1:delete t[i];n&&delete this._collisionsPool[e]}}}]),CollisionTool}(),I=function(){function PhysicsSimulation(e){_classCallCheck(this,PhysicsSimulation),this._gravity=new o(0,-10,0),this._btVector3Zero=l.Physics3D._bullet.btVector3_create(0,0,0),this._btDefaultQuaternion=l.Physics3D._bullet.btQuaternion_create(0,0,0,-1),this._collisionsUtils=new A,this._previousFrameCollisions=[],this._currentFrameCollisions=[],this._currentConstraint={},this._physicsUpdateList=new C,this._characters=[],this._updatedRigidbodies=0,this.maxSubSteps=1,this.fixedTimeStep=1/60,this.maxSubSteps=e.maxSubSteps,this.fixedTimeStep=e.fixedTimeStep;var t=l.Physics3D._bullet;this._btCollisionConfiguration=t.btDefaultCollisionConfiguration_create(),this._btDispatcher=t.btCollisionDispatcher_create(this._btCollisionConfiguration),this._btBroadphase=t.btDbvtBroadphase_create(),t.btOverlappingPairCache_setInternalGhostPairCallback(t.btDbvtBroadphase_getOverlappingPairCache(this._btBroadphase),t.btGhostPairCallback_create());var n=e.flags;if(n&PhysicsSimulation.PHYSICSENGINEFLAGS_COLLISIONSONLY)this._btCollisionWorld=new t.btCollisionWorld(this._btDispatcher,this._btBroadphase,this._btCollisionConfiguration);else{if(n&PhysicsSimulation.PHYSICSENGINEFLAGS_SOFTBODYSUPPORT)throw"PhysicsSimulation:SoftBody processing is not yet available";var i=t.btSequentialImpulseConstraintSolver_create();this._btDiscreteDynamicsWorld=t.btDiscreteDynamicsWorld_create(this._btDispatcher,this._btBroadphase,i,this._btCollisionConfiguration),this._btCollisionWorld=this._btDiscreteDynamicsWorld}this._btDiscreteDynamicsWorld&&(this._btSolverInfo=t.btDynamicsWorld_getSolverInfo(this._btDiscreteDynamicsWorld),this._btDispatchInfo=t.btCollisionWorld_getDispatchInfo(this._btDiscreteDynamicsWorld)),this._btClosestRayResultCallback=t.ClosestRayResultCallback_create(this._btVector3Zero,this._btVector3Zero),this._btAllHitsRayResultCallback=t.AllHitsRayResultCallback_create(this._btVector3Zero,this._btVector3Zero),this._btClosestConvexResultCallback=t.ClosestConvexResultCallback_create(this._btVector3Zero,this._btVector3Zero),this._btAllConvexResultCallback=t.AllConvexResultCallback_create(this._btVector3Zero,this._btVector3Zero),this.setHitsRayResultCallbackFlag(),t.btGImpactCollisionAlgorithm_RegisterAlgorithm(this._btDispatcher)}return _createClass(PhysicsSimulation,[{key:"_simulate",value:function(e){this._updatedRigidbodies=0;var t=l.Physics3D._bullet;this._btDiscreteDynamicsWorld?t.btDiscreteDynamicsWorld_stepSimulation(this._btDiscreteDynamicsWorld,e,this.maxSubSteps,this.fixedTimeStep):t.PerformDiscreteCollisionDetection(this._btCollisionWorld)}},{key:"_destroy",value:function(){var e=l.Physics3D._bullet;this._btDiscreteDynamicsWorld?(e.btCollisionWorld_destroy(this._btDiscreteDynamicsWorld),this._btDiscreteDynamicsWorld=null):(e.btCollisionWorld_destroy(this._btCollisionWorld),this._btCollisionWorld=null),e.btDbvtBroadphase_destroy(this._btBroadphase),this._btBroadphase=null,e.btCollisionDispatcher_destroy(this._btDispatcher),this._btDispatcher=null,e.btDefaultCollisionConfiguration_destroy(this._btCollisionConfiguration),this._btCollisionConfiguration=null}},{key:"_addPhysicsCollider",value:function(e,t,n){l.Physics3D._bullet.btCollisionWorld_addCollisionObject(this._btCollisionWorld,e._btColliderObject,t,n)}},{key:"_removePhysicsCollider",value:function(e){l.Physics3D._bullet.btCollisionWorld_removeCollisionObject(this._btCollisionWorld,e._btColliderObject)}},{key:"_addRigidBody",value:function(e,t,n){if(!this._btDiscreteDynamicsWorld)throw"Simulation:Cannot perform this action when the physics engine is set to CollisionsOnly";l.Physics3D._bullet.btDiscreteDynamicsWorld_addRigidBody(this._btCollisionWorld,e._btColliderObject,t,n)}},{key:"_removeRigidBody",value:function(e){if(!this._btDiscreteDynamicsWorld)throw"Simulation:Cannot perform this action when the physics engine is set to CollisionsOnly";l.Physics3D._bullet.btDiscreteDynamicsWorld_removeRigidBody(this._btCollisionWorld,e._btColliderObject)}},{key:"_addCharacter",value:function(e,t,n){if(!this._btDiscreteDynamicsWorld)throw"Simulation:Cannot perform this action when the physics engine is set to CollisionsOnly";var i=l.Physics3D._bullet;i.btCollisionWorld_addCollisionObject(this._btCollisionWorld,e._btColliderObject,t,n),i.btDynamicsWorld_addAction(this._btCollisionWorld,e._btKinematicCharacter)}},{key:"_removeCharacter",value:function(e){if(!this._btDiscreteDynamicsWorld)throw"Simulation:Cannot perform this action when the physics engine is set to CollisionsOnly";var t=l.Physics3D._bullet;t.btCollisionWorld_removeCollisionObject(this._btCollisionWorld,e._btColliderObject),t.btDynamicsWorld_removeAction(this._btCollisionWorld,e._btKinematicCharacter)}},{key:"raycastFromTo",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:m.COLLISIONFILTERGROUP_ALLFILTER,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:m.COLLISIONFILTERGROUP_ALLFILTER,r=l.Physics3D._bullet,o=this._btClosestRayResultCallback,s=PhysicsSimulation._btTempVector30,u=PhysicsSimulation._btTempVector31;if(r.btVector3_setValue(s,-e.x,e.y,e.z),r.btVector3_setValue(u,-t.x,t.y,t.z),r.ClosestRayResultCallback_set_m_rayFromWorld(o,s),r.ClosestRayResultCallback_set_m_rayToWorld(o,u),r.RayResultCallback_set_m_collisionFilterGroup(o,i),r.RayResultCallback_set_m_collisionFilterMask(o,a),r.RayResultCallback_set_m_collisionObject(o,null),r.RayResultCallback_set_m_closestHitFraction(o,1),r.btCollisionWorld_rayTest(this._btCollisionWorld,s,u,o),r.RayResultCallback_hasHit(o)){if(n){n.succeeded=!0,n.collider=S._physicObjectsMap[r.btCollisionObject_getUserIndex(r.RayResultCallback_get_m_collisionObject(o))],n.hitFraction=r.RayResultCallback_get_m_closestHitFraction(o);var c=r.ClosestRayResultCallback_get_m_hitPointWorld(o),h=n.point;h.x=-r.btVector3_x(c),h.y=r.btVector3_y(c),h.z=r.btVector3_z(c);var _=r.ClosestRayResultCallback_get_m_hitNormalWorld(o),d=n.normal;d.x=-r.btVector3_x(_),d.y=r.btVector3_y(_),d.z=r.btVector3_z(_)}return!0}return n&&(n.succeeded=!1),!1}},{key:"raycastAllFromTo",value:function(e,t,n){var i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:m.COLLISIONFILTERGROUP_ALLFILTER,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:m.COLLISIONFILTERGROUP_ALLFILTER,r=l.Physics3D._bullet,o=this._btAllHitsRayResultCallback,s=PhysicsSimulation._btTempVector30,u=PhysicsSimulation._btTempVector31;n.length=0,r.btVector3_setValue(s,-e.x,e.y,e.z),r.btVector3_setValue(u,-t.x,t.y,t.z),r.AllHitsRayResultCallback_set_m_rayFromWorld(o,s),r.AllHitsRayResultCallback_set_m_rayToWorld(o,u),r.RayResultCallback_set_m_collisionFilterGroup(o,i),r.RayResultCallback_set_m_collisionFilterMask(o,a);var c=r.AllHitsRayResultCallback_get_m_collisionObjects(o),h=r.AllHitsRayResultCallback_get_m_hitPointWorld(o),_=r.AllHitsRayResultCallback_get_m_hitNormalWorld(o),d=r.AllHitsRayResultCallback_get_m_hitFractions(o);r.tBtCollisionObjectArray_clear(c),r.tVector3Array_clear(h),r.tVector3Array_clear(_),r.tScalarArray_clear(d),r.btCollisionWorld_rayTest(this._btCollisionWorld,s,u,o);var f=r.tBtCollisionObjectArray_size(c);if(f>0){this._collisionsUtils.recoverAllHitResultsPool();for(var p=0;p<f;p++){var T=this._collisionsUtils.getHitResult();n.push(T),T.succeeded=!0,T.collider=S._physicObjectsMap[r.btCollisionObject_getUserIndex(r.tBtCollisionObjectArray_at(c,p))],T.hitFraction=r.tScalarArray_at(d,p);var v=r.tVector3Array_at(h,p),g=T.point;g.x=-r.btVector3_x(v),g.y=r.btVector3_y(v),g.z=r.btVector3_z(v);var E=r.tVector3Array_at(_,p),y=T.normal;y.x=-r.btVector3_x(E),y.y=r.btVector3_y(E),y.z=r.btVector3_z(E)}return!0}return!1}},{key:"rayCast",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:2147483647,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:m.COLLISIONFILTERGROUP_ALLFILTER,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:m.COLLISIONFILTERGROUP_ALLFILTER,r=e.origin,s=PhysicsSimulation._tempVector30;return o.normalize(e.direction,s),o.scale(s,n,s),o.add(r,s,s),this.raycastFromTo(r,s,t,i,a)}},{key:"rayCastAll",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:2147483647,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:m.COLLISIONFILTERGROUP_ALLFILTER,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:m.COLLISIONFILTERGROUP_ALLFILTER,r=e.origin,s=PhysicsSimulation._tempVector30;return o.normalize(e.direction,s),o.scale(s,n,s),o.add(r,s,s),this.raycastAllFromTo(r,s,t,i,a)}},{key:"shapeCast",value:function(e,t,n){var i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,r=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null,o=arguments.length>6&&void 0!==arguments[6]?arguments[6]:m.COLLISIONFILTERGROUP_ALLFILTER,s=arguments.length>7&&void 0!==arguments[7]?arguments[7]:m.COLLISIONFILTERGROUP_ALLFILTER,u=arguments.length>8&&void 0!==arguments[8]?arguments[8]:0,c=l.Physics3D._bullet,h=this._btClosestConvexResultCallback,_=PhysicsSimulation._btTempVector30,d=PhysicsSimulation._btTempVector31,f=PhysicsSimulation._btTempQuaternion0,p=PhysicsSimulation._btTempQuaternion1,T=PhysicsSimulation._btTempTransform0,v=PhysicsSimulation._btTempTransform1,g=e._btShape;if(c.btVector3_setValue(_,-t.x,t.y,t.z),c.btVector3_setValue(d,-n.x,n.y,n.z),c.ConvexResultCallback_set_m_collisionFilterGroup(h,o),c.ConvexResultCallback_set_m_collisionFilterMask(h,s),c.btTransform_setOrigin(T,_),c.btTransform_setOrigin(v,d),a?(c.btQuaternion_setValue(f,-a.x,a.y,a.z,-a.w),c.btTransform_setRotation(T,f)):c.btTransform_setRotation(T,this._btDefaultQuaternion),r?(c.btQuaternion_setValue(p,-r.x,r.y,r.z,-r.w),c.btTransform_setRotation(v,p)):c.btTransform_setRotation(v,this._btDefaultQuaternion),c.ClosestConvexResultCallback_set_m_hitCollisionObject(h,null),c.ConvexResultCallback_set_m_closestHitFraction(h,1),c.btCollisionWorld_convexSweepTest(this._btCollisionWorld,g,T,v,h,u),c.ConvexResultCallback_hasHit(h)){if(i){i.succeeded=!0,i.collider=S._physicObjectsMap[c.btCollisionObject_getUserIndex(c.ClosestConvexResultCallback_get_m_hitCollisionObject(h))],i.hitFraction=c.ConvexResultCallback_get_m_closestHitFraction(h);var E=c.ClosestConvexResultCallback_get_m_hitPointWorld(h),y=c.ClosestConvexResultCallback_get_m_hitNormalWorld(h),R=i.point,C=i.normal;R.x=-c.btVector3_x(E),R.y=c.btVector3_y(E),R.z=c.btVector3_z(E),C.x=-c.btVector3_x(y),C.y=c.btVector3_y(y),C.z=c.btVector3_z(y)}return!0}return i&&(i.succeeded=!1),!1}},{key:"shapeCastAll",value:function(e,t,n,i){var a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,r=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null,o=arguments.length>6&&void 0!==arguments[6]?arguments[6]:m.COLLISIONFILTERGROUP_ALLFILTER,s=arguments.length>7&&void 0!==arguments[7]?arguments[7]:m.COLLISIONFILTERGROUP_ALLFILTER,u=arguments.length>8&&void 0!==arguments[8]?arguments[8]:0,c=l.Physics3D._bullet,h=this._btAllConvexResultCallback,_=PhysicsSimulation._btTempVector30,d=PhysicsSimulation._btTempVector31,f=PhysicsSimulation._btTempQuaternion0,p=PhysicsSimulation._btTempQuaternion1,T=PhysicsSimulation._btTempTransform0,v=PhysicsSimulation._btTempTransform1,g=e._btShape;i.length=0,c.btVector3_setValue(_,-t.x,t.y,t.z),c.btVector3_setValue(d,-n.x,n.y,n.z),c.ConvexResultCallback_set_m_collisionFilterGroup(h,o),c.ConvexResultCallback_set_m_collisionFilterMask(h,s),c.btTransform_setOrigin(T,_),c.btTransform_setOrigin(v,d),a?(c.btQuaternion_setValue(f,-a.x,a.y,a.z,-a.w),c.btTransform_setRotation(T,f)):c.btTransform_setRotation(T,this._btDefaultQuaternion),r?(c.btQuaternion_setValue(p,-r.x,r.y,r.z,-r.w),c.btTransform_setRotation(v,p)):c.btTransform_setRotation(v,this._btDefaultQuaternion);var E=c.AllConvexResultCallback_get_m_collisionObjects(h),y=c.AllConvexResultCallback_get_m_hitPointWorld(h),R=c.AllConvexResultCallback_get_m_hitNormalWorld(h),C=c.AllConvexResultCallback_get_m_hitFractions(h);c.tVector3Array_clear(y),c.tVector3Array_clear(R),c.tScalarArray_clear(C),c.tBtCollisionObjectArray_clear(E),c.btCollisionWorld_convexSweepTest(this._btCollisionWorld,g,T,v,h,u);var M=c.tBtCollisionObjectArray_size(E);if(M>0){this._collisionsUtils.recoverAllHitResultsPool();for(var D=0;D<M;D++){var x=this._collisionsUtils.getHitResult();i.push(x),x.succeeded=!0,x.collider=S._physicObjectsMap[c.btCollisionObject_getUserIndex(c.tBtCollisionObjectArray_at(E,D))],x.hitFraction=c.tScalarArray_at(C,D);var A=c.tVector3Array_at(y,D),I=x.point;I.x=-c.btVector3_x(A),I.y=c.btVector3_y(A),I.z=c.btVector3_z(A);var L=c.tVector3Array_at(R,D),P=x.normal;P.x=-c.btVector3_x(L),P.y=c.btVector3_y(L),P.z=c.btVector3_z(L)}return!0}return!1}},{key:"addConstraint",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(!this._btDiscreteDynamicsWorld)throw"Cannot perform this action when the physics engine is set to CollisionsOnly";l.Physics3D._bullet.btCollisionWorld_addConstraint(this._btDiscreteDynamicsWorld,e._btConstraint,t),this._currentConstraint[e.id]=e}},{key:"removeConstraint",value:function(e){if(!this._btDiscreteDynamicsWorld)throw"Cannot perform this action when the physics engine is set to CollisionsOnly";l.Physics3D._bullet.btCollisionWorld_removeConstraint(this._btDiscreteDynamicsWorld,e._btConstraint),delete this._currentConstraint[e.id]}},{key:"setHitsRayResultCallbackFlag",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,t=l.Physics3D._bullet;t.RayResultCallback_set_m_flags(this._btAllHitsRayResultCallback,e),t.RayResultCallback_set_m_flags(this._btClosestRayResultCallback,e)}},{key:"_updatePhysicsTransformFromRender",value:function(){for(var e=this._physicsUpdateList.elements,t=0,n=this._physicsUpdateList.length;t<n;t++){var i=e[t];i._derivePhysicsTransformation(!1),i._inPhysicUpdateListIndex=-1}this._physicsUpdateList.length=0}},{key:"_updateCharacters",value:function(){for(var e=0,t=this._characters.length;e<t;e++){var n=this._characters[e];n._updateTransformComponent(l.Physics3D._bullet.btCollisionObject_getWorldTransform(n._btColliderObject))}}},{key:"_updateCollisions",value:function(){this._collisionsUtils.recoverAllContactPointsPool();var e=this._currentFrameCollisions;this._currentFrameCollisions=this._previousFrameCollisions,this._currentFrameCollisions.length=0,this._previousFrameCollisions=e;for(var n=t.Stat.loopCount,i=l.Physics3D._bullet,a=i.btDispatcher_getNumManifolds(this._btDispatcher),r=0;r<a;r++){var o,s=i.btDispatcher_getManifoldByIndexInternal(this._btDispatcher,r),u=S._physicObjectsMap[i.btCollisionObject_getUserIndex(i.btPersistentManifold_getBody0(s))],c=S._physicObjectsMap[i.btCollisionObject_getUserIndex(i.btPersistentManifold_getBody1(s))],h=null,_=null;if((u.isTrigger||c.isTrigger)&&(u.owner._needProcessTriggers||c.owner._needProcessTriggers))for(var d=i.btPersistentManifold_getNumContacts(s),f=0;f<d;f++){var m=i.btPersistentManifold_getContactPoint(s,f),p=i.btManifoldPoint_getDistance(m);if(p<=0){_=(h=this._collisionsUtils.getCollision(u,c)).contacts,(o=h._updateFrame!==n)&&(h._isTrigger=!0,_.length=0);break}}else if((u.owner._needProcessCollisions||c.owner._needProcessCollisions)&&(u._enableProcessCollisions||c._enableProcessCollisions))for(d=i.btPersistentManifold_getNumContacts(s),f=0;f<d;f++)if(m=i.btPersistentManifold_getContactPoint(s,f),(p=i.btManifoldPoint_getDistance(m))<=0){var T=this._collisionsUtils.getContactPoints();T.colliderA=u,T.colliderB=c,T.distance=p;var v=i.btManifoldPoint_get_m_normalWorldOnB(m),g=T.normal;g.x=-i.btVector3_x(v),g.y=i.btVector3_y(v),g.z=i.btVector3_z(v);var E=i.btManifoldPoint_get_m_positionWorldOnA(m),y=T.positionOnA;y.x=-i.btVector3_x(E),y.y=i.btVector3_y(E),y.z=i.btVector3_z(E);var R=i.btManifoldPoint_get_m_positionWorldOnB(m),C=T.positionOnB;C.x=-i.btVector3_x(R),C.y=i.btVector3_y(R),C.z=i.btVector3_z(R),h||(_=(h=this._collisionsUtils.getCollision(u,c)).contacts,(o=h._updateFrame!==n)&&(h._isTrigger=!1,_.length=0)),_.push(T)}h&&o&&(this._currentFrameCollisions.push(h),h._setUpdateFrame(n))}}},{key:"_eventScripts",value:function(){for(var e=t.Stat.loopCount,n=0,i=this._currentFrameCollisions.length;n<i;n++){var a=this._currentFrameCollisions[n],r=a._colliderA,o=a._colliderB;if(!r.destroyed&&!o.destroyed)if(e-a._lastUpdateFrame==1){var s=r.owner,l=s._scripts;if(l)if(a._isTrigger){if(s._needProcessTriggers)for(var u=0,c=l.length;u<c;u++)l[u].onTriggerStay(o)}else if(s._needProcessCollisions)for(u=0,c=l.length;u<c;u++)a.other=o,l[u].onCollisionStay(a);var h=o.owner,_=h._scripts;if(_)if(a._isTrigger){if(h._needProcessTriggers)for(u=0,c=_.length;u<c;u++)_[u].onTriggerStay(r)}else if(h._needProcessCollisions)for(u=0,c=_.length;u<c;u++)a.other=r,_[u].onCollisionStay(a)}else{if(l=(s=r.owner)._scripts)if(a._isTrigger){if(s._needProcessTriggers)for(u=0,c=l.length;u<c;u++)l[u].onTriggerEnter(o)}else if(s._needProcessCollisions)for(u=0,c=l.length;u<c;u++)a.other=o,l[u].onCollisionEnter(a);if(_=(h=o.owner)._scripts)if(a._isTrigger){if(h._needProcessTriggers)for(u=0,c=_.length;u<c;u++)_[u].onTriggerEnter(r)}else if(h._needProcessCollisions)for(u=0,c=_.length;u<c;u++)a.other=r,_[u].onCollisionEnter(a)}}for(n=0,i=this._previousFrameCollisions.length;n<i;n++){var d=this._previousFrameCollisions[n],f=d._colliderA,m=d._colliderB;if(!f.destroyed&&!m.destroyed&&e-d._updateFrame==1){if(this._collisionsUtils.recoverCollision(d),l=(s=f.owner)._scripts)if(d._isTrigger){if(s._needProcessTriggers)for(u=0,c=l.length;u<c;u++)l[u].onTriggerExit(m)}else if(s._needProcessCollisions)for(u=0,c=l.length;u<c;u++)d.other=m,l[u].onCollisionExit(d);if(_=(h=m.owner)._scripts)if(d._isTrigger){if(h._needProcessTriggers)for(u=0,c=_.length;u<c;u++)_[u].onTriggerExit(f)}else if(h._needProcessCollisions)for(u=0,c=_.length;u<c;u++)d.other=f,_[u].onCollisionExit(d)}}for(var p in this._currentConstraint){var T=this._currentConstraint[p],v=T.owner._scripts;if(T.enabled&&T._isBreakConstrained()&&v&&0!=v.length)for(n=0,i=v.length;n<i;n++)v[n].onJointBreak()}}},{key:"clearForces",value:function(){if(!this._btDiscreteDynamicsWorld)throw"Cannot perform this action when the physics engine is set to CollisionsOnly";l.Physics3D._bullet.btDiscreteDynamicsWorld_clearForces(this._btDiscreteDynamicsWorld)}},{key:"continuousCollisionDetection",get:function(){return l.Physics3D._bullet.btCollisionWorld_get_m_useContinuous(this._btDispatchInfo)},set:function(e){l.Physics3D._bullet.btCollisionWorld_set_m_useContinuous(this._btDispatchInfo,e)}},{key:"gravity",get:function(){if(!this._btDiscreteDynamicsWorld)throw"Simulation:Cannot perform this action when the physics engine is set to CollisionsOnly";return this._gravity},set:function(e){if(!this._btDiscreteDynamicsWorld)throw"Simulation:Cannot perform this action when the physics engine is set to CollisionsOnly";this._gravity=e;var t=l.Physics3D._bullet,n=PhysicsSimulation._btTempVector30;t.btVector3_setValue(n,-e.x,e.y,e.z),t.btDiscreteDynamicsWorld_setGravity(this._btDiscreteDynamicsWorld,n)}},{key:"speculativeContactRestitution",get:function(){if(!this._btDiscreteDynamicsWorld)throw"Simulation:Cannot Cannot perform this action when the physics engine is set to CollisionsOnly";return l.Physics3D._bullet.btDiscreteDynamicsWorld_getApplySpeculativeContactRestitution(this._btDiscreteDynamicsWorld)},set:function(e){if(!this._btDiscreteDynamicsWorld)throw"Simulation:Cannot Cannot perform this action when the physics engine is set to CollisionsOnly";l.Physics3D._bullet.btDiscreteDynamicsWorld_setApplySpeculativeContactRestitution(this._btDiscreteDynamicsWorld,e)}}],[{key:"__init__",value:function(){var e=l.Physics3D._bullet;PhysicsSimulation._btTempVector30=e.btVector3_create(0,0,0),PhysicsSimulation._btTempVector31=e.btVector3_create(0,0,0),PhysicsSimulation._btTempQuaternion0=e.btQuaternion_create(0,0,0,1),PhysicsSimulation._btTempQuaternion1=e.btQuaternion_create(0,0,0,1),PhysicsSimulation._btTempTransform0=e.btTransform_create(),PhysicsSimulation._btTempTransform1=e.btTransform_create()}},{key:"createConstraint",value:function(){}}]),PhysicsSimulation}();I.PHYSICSENGINEFLAGS_NONE=0,I.PHYSICSENGINEFLAGS_COLLISIONSONLY=1,I.PHYSICSENGINEFLAGS_SOFTBODYSUPPORT=2,I.PHYSICSENGINEFLAGS_MULTITHREADED=4,I.PHYSICSENGINEFLAGS_USEHARDWAREWHENPOSSIBLE=8,I.SOLVERMODE_RANDMIZE_ORDER=1,I.SOLVERMODE_FRICTION_SEPARATE=2,I.SOLVERMODE_USE_WARMSTARTING=4,I.SOLVERMODE_USE_2_FRICTION_DIRECTIONS=16,I.SOLVERMODE_ENABLE_FRICTION_DIRECTION_CACHING=32,I.SOLVERMODE_DISABLE_VELOCITY_DEPENDENT_FRICTION_DIRECTION=64,I.SOLVERMODE_CACHE_FRIENDLY=128,I.SOLVERMODE_SIMD=256,I.SOLVERMODE_INTERLEAVE_CONTACT_AND_FRICTION_CONSTRAINTS=512,I.SOLVERMODE_ALLOW_ZERO_LENGTH_FRICTION_DIRECTIONS=1024,I.HITSRAYRESULTCALLBACK_FLAG_NONE=0,I.HITSRAYRESULTCALLBACK_FLAG_FILTERBACKFACESS=1,I.HITSRAYRESULTCALLBACK_FLAG_KEEPUNFILIPPEDNORMAL=2,I.HITSRAYRESULTCALLBACK_FLAG_USESUBSIMPLEXCONVEXCASTRAYTEST=4,I.HITSRAYRESULTCALLBACK_FLAG_USEGJKCONVEXCASTRAYTEST=8,I.HITSRAYRESULTCALLBACK_FLAG_TERMINATOR=4294967295,I._tempVector30=new o,I.disableSimulation=!1;var L=function(){function TextureGenerator(){_classCallCheck(this,TextureGenerator)}return _createClass(TextureGenerator,null,[{key:"lightAttenTexture",value:function(e,t,n,i,a,r){var o=e/n,s=1/(1+25*o);o>=.64&&(o>1?s=0:s*=1-(o-.64)/.36),r[a]=Math.floor(255*s+.5)}},{key:"haloTexture",value:function(e,t,n,i,a,r){var o=(e-(n>>=1))/n,s=(t-(i>>=1))/i,l=o*o+s*s;l>1&&(l=1),r[a]=Math.floor(255*(1-l)+.5)}},{key:"_generateTexture2D",value:function(e,n,i,a){var r=0,o=0;switch(e.format){case t.TextureFormat.R8G8B8:o=3;break;case t.TextureFormat.R8G8B8A8:o=4;break;case t.TextureFormat.Alpha8:o=1;break;default:throw"GeneratedTexture._generateTexture: unkonw texture format."}for(var s=new Uint8Array(n*i*o),l=0;l<i;l++)for(var u=0;u<n;u++)a(u,l,n,i,r,s),r+=o;e.setPixels(s)}}]),TextureGenerator}(),P=function(){function Utils3D(){_classCallCheck(this,Utils3D)}return _createClass(Utils3D,null,[{key:"_createFloatTextureBuffer",value:function(e,n){var i=new t.Texture2D(e,n,t.TextureFormat.R32G32B32A32,!1,!1);return i.filterMode=t.FilterMode.Point,i.wrapModeU=t.WarpMode.Clamp,i.wrapModeV=t.WarpMode.Clamp,i.anisoLevel=0,i}},{key:"_convertToLayaVec3",value:function(e,t,n){var i=l.Physics3D._bullet;t.x=n?-i.btVector3_x(e):i.btVector3_x(e),t.y=i.btVector3_y(e),t.z=i.btVector3_z(e)}},{key:"_convertToBulletVec3",value:function(e,t,n){l.Physics3D._bullet.btVector3_setValue(t,n?-e.x:e.x,e.y,e.z)}},{key:"_rotationTransformScaleSkinAnimation",value:function(e,t,n,i,a,r,o,s,l,u,c,h){var _,d,f,m,p,T=Utils3D._tempArray16_0,v=Utils3D._tempArray16_1,g=Utils3D._tempArray16_2,E=i+i,y=a+a,S=r+r,R=i*E,C=a*E,M=a*y,D=r*E,x=r*y,A=r*S,I=o*E,L=o*y,P=o*S;for(T[15]=1,T[0]=1-M-A,T[1]=C+P,T[2]=D-L,T[4]=C-P,T[5]=1-R-A,T[6]=x+I,T[8]=D+L,T[9]=x-I,T[10]=1-R-M,v[15]=1,v[0]=s,v[5]=l,v[10]=u,_=0;_<4;_++)d=T[_],f=T[_+4],m=T[_+8],p=T[_+12],g[_]=d,g[_+4]=f,g[_+8]=m,g[_+12]=d*e+f*t+m*n+p;for(_=0;_<4;_++)d=g[_],f=g[_+4],m=g[_+8],p=g[_+12],c[_+h]=d*v[0]+f*v[1]+m*v[2]+p*v[3],c[_+h+4]=d*v[4]+f*v[5]+m*v[6]+p*v[7],c[_+h+8]=d*v[8]+f*v[9]+m*v[10]+p*v[11],c[_+h+12]=d*v[12]+f*v[13]+m*v[14]+p*v[15]}},{key:"_computeBoneAndAnimationDatasByBindPoseMatrxix",value:function(e,t,n,i,a,r){var o,s,l=0,u=0,c=e.length;for(o=0;o<c;l+=e[o].keyframeWidth,u+=16,o++)Utils3D._rotationTransformScaleSkinAnimation(t[l+0],t[l+1],t[l+2],t[l+3],t[l+4],t[l+5],t[l+6],t[l+7],t[l+8],t[l+9],i,u),0!=o&&(s=16*e[o].parentIndex,Utils3D.mulMatrixByArray(i,s,i,u,i,u));var h=n.length;for(o=0;o<h;o++)Utils3D.mulMatrixByArrayAndMatrixFast(i,16*r[o],n[o],a,16*o)}},{key:"_computeAnimationDatasByArrayAndMatrixFast",value:function(e,t,n,i){for(var a=0,r=e.length;a<r;a++)Utils3D.mulMatrixByArrayAndMatrixFast(t,16*i[a],e[a],n,16*a)}},{key:"_computeBoneAndAnimationDatasByBindPoseMatrxixOld",value:function(e,t,n,i,a){var r,o,s=0,l=0,u=e.length;for(r=0;r<u;s+=e[r].keyframeWidth,l+=16,r++)Utils3D._rotationTransformScaleSkinAnimation(t[s+7],t[s+8],t[s+9],t[s+3],t[s+4],t[s+5],t[s+6],t[s+0],t[s+1],t[s+2],i,l),0!=r&&(o=16*e[r].parentIndex,Utils3D.mulMatrixByArray(i,o,i,l,i,l));var c=n.length;for(r=0;r<c;r++){var h=16*r;Utils3D.mulMatrixByArrayAndMatrixFast(i,h,n[r],a,h)}}},{key:"_computeAnimationDatasByArrayAndMatrixFastOld",value:function(e,t,n){for(var i=e.length,a=0;a<i;a++){var r=16*a;Utils3D.mulMatrixByArrayAndMatrixFast(t,r,e[a],n,r)}}},{key:"_computeRootAnimationData",value:function(e,t,n){for(var i=0,a=0,r=0,o=e.length;i<o;a+=e[i].keyframeWidth,r+=16,i++)Utils3D.createAffineTransformationArray(t[a+0],t[a+1],t[a+2],t[a+3],t[a+4],t[a+5],t[a+6],t[a+7],t[a+8],t[a+9],n,r)}},{key:"transformVector3ArrayByQuat",value:function(e,t,n,i,a){var r=e[t],o=e[t+1],s=e[t+2],l=n.x,u=n.y,c=n.z,h=n.w,_=h*r+u*s-c*o,d=h*o+c*r-l*s,f=h*s+l*o-u*r,m=-l*r-u*o-c*s;i[a]=_*h+m*-l+d*-c-f*-u,i[a+1]=d*h+m*-u+f*-l-_*-c,i[a+2]=f*h+m*-c+_*-u-d*-l}},{key:"mulMatrixByArray",value:function(e,t,n,i,a,r){var o,s,l,u,c;if(a===n){for(n=Utils3D._tempArray16_3,o=0;o<16;++o)n[o]=a[r+o];i=0}for(o=0;o<4;o++)s=e[t+o],l=e[t+o+4],u=e[t+o+8],c=e[t+o+12],a[r+o]=s*n[i+0]+l*n[i+1]+u*n[i+2]+c*n[i+3],a[r+o+4]=s*n[i+4]+l*n[i+5]+u*n[i+6]+c*n[i+7],a[r+o+8]=s*n[i+8]+l*n[i+9]+u*n[i+10]+c*n[i+11],a[r+o+12]=s*n[i+12]+l*n[i+13]+u*n[i+14]+c*n[i+15]}},{key:"mulMatrixByArrayFast",value:function(e,t,n,i,a,r){var o,s,l,u,c;for(o=0;o<4;o++)s=e[t+o],l=e[t+o+4],u=e[t+o+8],c=e[t+o+12],a[r+o]=s*n[i+0]+l*n[i+1]+u*n[i+2]+c*n[i+3],a[r+o+4]=s*n[i+4]+l*n[i+5]+u*n[i+6]+c*n[i+7],a[r+o+8]=s*n[i+8]+l*n[i+9]+u*n[i+10]+c*n[i+11],a[r+o+12]=s*n[i+12]+l*n[i+13]+u*n[i+14]+c*n[i+15]}},{key:"mulMatrixByArrayAndMatrixFast",value:function(e,t,n,i,a){var r,o,s,l,u,c=n.elements,h=c[0],_=c[1],d=c[2],f=c[3],m=c[4],p=c[5],T=c[6],v=c[7],g=c[8],E=c[9],y=c[10],S=c[11],R=c[12],C=c[13],M=c[14],D=c[15],x=t,A=t+4,I=t+8,L=t+12,P=a,O=a+4,N=a+8,b=a+12;for(r=0;r<4;r++)o=e[x+r],s=e[A+r],l=e[I+r],u=e[L+r],i[P+r]=o*h+s*_+l*d+u*f,i[O+r]=o*m+s*p+l*T+u*v,i[N+r]=o*g+s*E+l*y+u*S,i[b+r]=o*R+s*C+l*M+u*D}},{key:"createAffineTransformationArray",value:function(e,t,n,i,a,r,o,s,l,u,c,h){var _=i+i,d=a+a,f=r+r,m=i*_,p=i*d,T=i*f,v=a*d,g=a*f,E=r*f,y=o*_,S=o*d,R=o*f;c[h+0]=(1-(v+E))*s,c[h+1]=(p+R)*s,c[h+2]=(T-S)*s,c[h+3]=0,c[h+4]=(p-R)*l,c[h+5]=(1-(m+E))*l,c[h+6]=(g+y)*l,c[h+7]=0,c[h+8]=(T+S)*u,c[h+9]=(g-y)*u,c[h+10]=(1-(m+v))*u,c[h+11]=0,c[h+12]=e,c[h+13]=t,c[h+14]=n,c[h+15]=1}},{key:"transformVector3ArrayToVector3ArrayCoordinate",value:function(e,t,n,i,a){var r=e[t+0],o=e[t+1],s=e[t+2],l=n.elements,u=r*l[3]+o*l[7]+s*l[11]+l[15];i[a]=r*l[0]+o*l[4]+s*l[8]+l[12]/u,i[a+1]=r*l[1]+o*l[5]+s*l[9]+l[13]/u,i[a+2]=r*l[2]+o*l[6]+s*l[10]+l[14]/u}},{key:"transformVector3ArrayToVector3ArrayNormal",value:function(e,t,n,i,a){var r=e[t+0],o=e[t+1],s=e[t+2],l=n.elements;i[a]=r*l[0]+o*l[4]+s*l[8],i[a+1]=r*l[1]+o*l[5]+s*l[9],i[a+2]=r*l[2]+o*l[6]+s*l[10]}},{key:"transformLightingMapTexcoordArray",value:function(e,t,n,i,a){i[a+0]=e[t+0]*n.x+n.z,i[a+1]=1-((1-e[t+1])*n.y+n.w)}},{key:"getURLVerion",value:function(e){var t=e.indexOf("?");return t>=0?e.substr(t):null}},{key:"_createAffineTransformationArray",value:function(e,t,n,i){var a=t.x,r=t.y,o=t.z,s=t.w,l=a+a,u=r+r,c=o+o,h=a*l,_=a*u,d=a*c,f=r*u,m=r*c,p=o*c,T=s*l,v=s*u,g=s*c,E=n.x,y=n.y,S=n.z;i[0]=(1-(f+p))*E,i[1]=(_+g)*E,i[2]=(d-v)*E,i[3]=0,i[4]=(_-g)*y,i[5]=(1-(h+p))*y,i[6]=(m+T)*y,i[7]=0,i[8]=(d+v)*S,i[9]=(m-T)*S,i[10]=(1-(h+f))*S,i[11]=0,i[12]=e.x,i[13]=e.y,i[14]=e.z,i[15]=1}},{key:"_mulMatrixArray",value:function(e,t,n,i,a){var r=t,o=e,s=i,l=r[n],u=r[n+1],c=r[n+2],h=r[n+3],_=r[n+4],d=r[n+5],f=r[n+6],m=r[n+7],p=r[n+8],T=r[n+9],v=r[n+10],g=r[n+11],E=r[n+12],y=r[n+13],S=r[n+14],R=r[n+15],C=o[0],M=o[1],D=o[2],x=o[3],A=o[4],I=o[5],L=o[6],P=o[7],O=o[8],N=o[9],b=o[10],k=o[11],w=o[12],B=o[13],V=o[14],F=o[15];s[a]=l*C+u*A+c*O+h*w,s[a+1]=l*M+u*I+c*N+h*B,s[a+2]=l*D+u*L+c*b+h*V,s[a+3]=l*x+u*P+c*k+h*F,s[a+4]=_*C+d*A+f*O+m*w,s[a+5]=_*M+d*I+f*N+m*B,s[a+6]=_*D+d*L+f*b+m*V,s[a+7]=_*x+d*P+f*k+m*F,s[a+8]=p*C+T*A+v*O+g*w,s[a+9]=p*M+T*I+v*N+g*B,s[a+10]=p*D+T*L+v*b+g*V,s[a+11]=p*x+T*P+v*k+g*F,s[a+12]=E*C+y*A+S*O+R*w,s[a+13]=E*M+y*I+S*N+R*B,s[a+14]=E*D+y*L+S*b+R*V,s[a+15]=E*x+y*P+S*k+R*F}},{key:"arcTanAngle",value:function(e,t){return 0==e?1==t?Math.PI/2:-Math.PI/2:e>0?Math.atan(t/e):e<0?t>0?Math.atan(t/e)+Math.PI:Math.atan(t/e)-Math.PI:0}},{key:"angleTo",value:function(e,t,n){o.subtract(t,e,u.TEMPVector30),o.normalize(u.TEMPVector30,u.TEMPVector30),n.x=Math.asin(u.TEMPVector30.y),n.y=Utils3D.arcTanAngle(-u.TEMPVector30.z,-u.TEMPVector30.x)}},{key:"transformQuat",value:function(e,t,n){var i=t,a=e.x,r=e.y,o=e.z,s=i[0],l=i[1],u=i[2],c=i[3],h=c*a+l*o-u*r,_=c*r+u*a-s*o,d=c*o+s*r-l*a,f=-s*a-l*r-u*o;n.x=h*c+f*-s+_*-u-d*-l,n.y=_*c+f*-l+d*-s-h*-u,n.z=d*c+f*-u+h*-l-_*-s}},{key:"quaternionWeight",value:function(e,t,n){n.x=e.x*t,n.y=e.y*t,n.z=e.z*t,n.w=e.w}},{key:"quaternionConjugate",value:function(e,t){t.x=-e.x,t.y=-e.y,t.z=-e.z,t.w=e.w}},{key:"scaleWeight",value:function(e,t,n){var i=e.x,a=e.y,r=e.z;n.x=i>0?Math.pow(Math.abs(i),t):-Math.pow(Math.abs(i),t),n.y=a>0?Math.pow(Math.abs(a),t):-Math.pow(Math.abs(a),t),n.z=r>0?Math.pow(Math.abs(r),t):-Math.pow(Math.abs(r),t)}},{key:"scaleBlend",value:function(e,t,n,i){var a=Utils3D._tempVector3_0,r=Utils3D._tempVector3_1;Utils3D.scaleWeight(e,1-n,a),Utils3D.scaleWeight(t,n,r);var o=n>.5?t:e;i.x=o.x>0?Math.abs(a.x*r.x):-Math.abs(a.x*r.x),i.y=o.y>0?Math.abs(a.y*r.y):-Math.abs(a.y*r.y),i.z=o.z>0?Math.abs(a.z*r.z):-Math.abs(a.z*r.z)}},{key:"matrix4x4MultiplyFFF",value:function(e,t,n){var i,a,r,o,s;if(n===t)for(t=new Float32Array(16),i=0;i<16;++i)t[i]=n[i];var l=t[0],u=t[1],c=t[2],h=t[3],_=t[4],d=t[5],f=t[6],m=t[7],p=t[8],T=t[9],v=t[10],g=t[11],E=t[12],y=t[13],S=t[14],R=t[15];for(i=0;i<4;i++)a=e[i],r=e[i+4],o=e[i+8],s=e[i+12],n[i]=a*l+r*u+o*c+s*h,n[i+4]=a*_+r*d+o*f+s*m,n[i+8]=a*p+r*T+o*v+s*g,n[i+12]=a*E+r*y+o*S+s*R}},{key:"matrix4x4MultiplyFFFForNative",value:function(e,n,i){t.LayaGL.instance.matrix4x4Multiply(e,n,i)}},{key:"matrix4x4MultiplyMFM",value:function(e,t,n){Utils3D.matrix4x4MultiplyFFF(e.elements,t,n.elements)}},{key:"_buildTexture2D",value:function(e,n,i,a){var r=arguments.length>4&&void 0!==arguments[4]&&arguments[4],o=new t.Texture2D(e,n,i,r,!0);return o.anisoLevel=1,o.filterMode=t.FilterMode.Point,L._generateTexture2D(o,e,n,a),o}},{key:"_drawBound",value:function(e,t,n){e.lineCount+12>e.maxLineCount&&(e.maxLineCount+=12);var i=Utils3D._tempVector3_0,a=Utils3D._tempVector3_1,r=t.min,o=t.max;i.setValue(r.x,r.y,r.z),a.setValue(o.x,r.y,r.z),e.addLine(i,a,n,n),i.setValue(r.x,r.y,r.z),a.setValue(r.x,r.y,o.z),e.addLine(i,a,n,n),i.setValue(o.x,r.y,r.z),a.setValue(o.x,r.y,o.z),e.addLine(i,a,n,n),i.setValue(r.x,r.y,o.z),a.setValue(o.x,r.y,o.z),e.addLine(i,a,n,n),i.setValue(r.x,r.y,r.z),a.setValue(r.x,o.y,r.z),e.addLine(i,a,n,n),i.setValue(r.x,r.y,o.z),a.setValue(r.x,o.y,o.z),e.addLine(i,a,n,n),i.setValue(o.x,r.y,r.z),a.setValue(o.x,o.y,r.z),e.addLine(i,a,n,n),i.setValue(o.x,r.y,o.z),a.setValue(o.x,o.y,o.z),e.addLine(i,a,n,n),i.setValue(r.x,o.y,r.z),a.setValue(o.x,o.y,r.z),e.addLine(i,a,n,n),i.setValue(r.x,o.y,r.z),a.setValue(r.x,o.y,o.z),e.addLine(i,a,n,n),i.setValue(o.x,o.y,r.z),a.setValue(o.x,o.y,o.z),e.addLine(i,a,n,n),i.setValue(r.x,o.y,o.z),a.setValue(o.x,o.y,o.z),e.addLine(i,a,n,n)}},{key:"_getHierarchyPath",value:function(e,t,n){n.length=0;for(var i=t;i!==e;){var a=i._parent;if(!a)return null;n.push(a.getChildIndex(i)),i=a}return n}},{key:"_getNodeByHierarchyPath",value:function(e,t){for(var n=e,i=t.length-1;i>=0;i--)n=n.getChildAt(t[i]);return n}}]),Utils3D}();P._tempVector3_0=new o,P._tempVector3_1=new o,P._tempArray16_0=new Float32Array(16),P._tempArray16_1=new Float32Array(16),P._tempArray16_2=new Float32Array(16),P._tempArray16_3=new Float32Array(16),P._compIdToNode=new Object;var O=function(e){function CharacterController(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:.1,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:m.COLLISIONFILTERGROUP_DEFAULTFILTER,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:m.COLLISIONFILTERGROUP_ALLFILTER;return _classCallCheck(this,CharacterController),(e=_possibleConstructorReturn(this,_getPrototypeOf(CharacterController).call(this,i,a)))._upAxis=new o(0,1,0),e._maxSlope=45,e._jumpSpeed=10,e._fallSpeed=55,e._gravity=new o(0,3*-9.8,0),e._btKinematicCharacter=null,e._stepHeight=t,n&&(e._upAxis=n),e._controlBySimulation=!0,e}return _inherits(CharacterController,S),_createClass(CharacterController,[{key:"_constructCharacter",value:function(){var e=l.Physics3D._bullet;this._btKinematicCharacter&&e.btKinematicCharacterController_destroy(this._btKinematicCharacter);var t=CharacterController._btTempVector30;e.btVector3_setValue(t,this._upAxis.x,this._upAxis.y,this._upAxis.z),this._btKinematicCharacter=e.btKinematicCharacterController_create(this._btColliderObject,this._colliderShape._btShape,this._stepHeight,t),this.fallSpeed=this._fallSpeed,this.maxSlope=this._maxSlope,this.jumpSpeed=this._jumpSpeed,this.gravity=this._gravity}},{key:"_onShapeChange",value:function(e){_get(_getPrototypeOf(CharacterController.prototype),"_onShapeChange",this).call(this,e),this._constructCharacter()}},{key:"_onAdded",value:function(){var e=l.Physics3D._bullet,t=e.btPairCachingGhostObject_create();e.btCollisionObject_setUserIndex(t,this.id),e.btCollisionObject_setCollisionFlags(t,S.COLLISIONFLAGS_CHARACTER_OBJECT),this._btColliderObject=t,this._colliderShape&&this._constructCharacter(),_get(_getPrototypeOf(CharacterController.prototype),"_onAdded",this).call(this)}},{key:"_addToSimulation",value:function(){this._simulation._characters.push(this),this._simulation._addCharacter(this,this._collisionGroup,this._canCollideWith)}},{key:"_removeFromSimulation",value:function(){this._simulation._removeCharacter(this);var e=this._simulation._characters;e.splice(e.indexOf(this),1)}},{key:"_cloneTo",value:function(e){_get(_getPrototypeOf(CharacterController.prototype),"_cloneTo",this).call(this,e);var t=e;t.stepHeight=this._stepHeight,t.upAxis=this._upAxis,t.maxSlope=this._maxSlope,t.jumpSpeed=this._jumpSpeed,t.fallSpeed=this._fallSpeed,t.gravity=this._gravity}},{key:"_onDestroy",value:function(){l.Physics3D._bullet.btKinematicCharacterController_destroy(this._btKinematicCharacter),_get(_getPrototypeOf(CharacterController.prototype),"_onDestroy",this).call(this),this._btKinematicCharacter=null}},{key:"move",value:function(e){var t=CharacterController._btVector30,n=l.Physics3D._bullet;n.btVector3_setValue(t,-e.x,e.y,e.z),n.btKinematicCharacterController_setWalkDirection(this._btKinematicCharacter,t)}},{key:"jump",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t=l.Physics3D._bullet,n=CharacterController._btVector30;e?(P._convertToBulletVec3(e,n,!0),t.btKinematicCharacterController_jump(this._btKinematicCharacter,n)):(t.btVector3_setValue(n,0,0,0),t.btKinematicCharacterController_jump(this._btKinematicCharacter,n))}},{key:"fallSpeed",get:function(){return this._fallSpeed},set:function(e){this._fallSpeed=e,l.Physics3D._bullet.btKinematicCharacterController_setFallSpeed(this._btKinematicCharacter,e)}},{key:"jumpSpeed",get:function(){return this._jumpSpeed},set:function(e){this._jumpSpeed=e,l.Physics3D._bullet.btKinematicCharacterController_setJumpSpeed(this._btKinematicCharacter,e)}},{key:"gravity",get:function(){return this._gravity},set:function(e){this._gravity=e;var t=l.Physics3D._bullet,n=CharacterController._btTempVector30;t.btVector3_setValue(n,-e.x,e.y,e.z),t.btKinematicCharacterController_setGravity(this._btKinematicCharacter,n)}},{key:"maxSlope",get:function(){return this._maxSlope},set:function(e){this._maxSlope=e,l.Physics3D._bullet.btKinematicCharacterController_setMaxSlope(this._btKinematicCharacter,e/180*Math.PI)}},{key:"isGrounded",get:function(){return l.Physics3D._bullet.btKinematicCharacterController_onGround(this._btKinematicCharacter)}},{key:"stepHeight",get:function(){return this._stepHeight},set:function(e){this._stepHeight=e,l.Physics3D._bullet.btKinematicCharacterController_setStepHeight(this._btKinematicCharacter,e)}},{key:"upAxis",get:function(){return this._upAxis},set:function(e){this._upAxis=e;var t=CharacterController._btTempVector30;P._convertToBulletVec3(e,t,!1),l.Physics3D._bullet.btKinematicCharacterController_setUp(this._btKinematicCharacter,t)}}],[{key:"__init__",value:function(){CharacterController._btTempVector30=l.Physics3D._bullet.btVector3_create(0,0,0)}}]),CharacterController}();O.UPAXIS_X=0,O.UPAXIS_Y=1,O.UPAXIS_Z=2;var N=function(e){function PhysicsTriggerComponent(e,t){var n;return _classCallCheck(this,PhysicsTriggerComponent),(n=_possibleConstructorReturn(this,_getPrototypeOf(PhysicsTriggerComponent).call(this,e,t)))._isTrigger=!1,n}return _inherits(PhysicsTriggerComponent,S),_createClass(PhysicsTriggerComponent,[{key:"_onAdded",value:function(){_get(_getPrototypeOf(PhysicsTriggerComponent.prototype),"_onAdded",this).call(this),this.isTrigger=this._isTrigger}},{key:"_cloneTo",value:function(e){_get(_getPrototypeOf(PhysicsTriggerComponent.prototype),"_cloneTo",this).call(this,e),e.isTrigger=this._isTrigger}},{key:"isTrigger",get:function(){return this._isTrigger},set:function(e){this._isTrigger=e;var t=l.Physics3D._bullet;if(this._btColliderObject){var n=t.btCollisionObject_getCollisionFlags(this._btColliderObject);e?0==(n&S.COLLISIONFLAGS_NO_CONTACT_RESPONSE)&&t.btCollisionObject_setCollisionFlags(this._btColliderObject,n|S.COLLISIONFLAGS_NO_CONTACT_RESPONSE):0!=(n&S.COLLISIONFLAGS_NO_CONTACT_RESPONSE)&&t.btCollisionObject_setCollisionFlags(this._btColliderObject,n^S.COLLISIONFLAGS_NO_CONTACT_RESPONSE)}}}]),PhysicsTriggerComponent}(),b=function(e){function Rigidbody3D(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:m.COLLISIONFILTERGROUP_DEFAULTFILTER,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:m.COLLISIONFILTERGROUP_ALLFILTER;return _classCallCheck(this,Rigidbody3D),(e=_possibleConstructorReturn(this,_getPrototypeOf(Rigidbody3D).call(this,t,n)))._isKinematic=!1,e._mass=1,e._gravity=new o(0,-10,0),e._angularDamping=0,e._linearDamping=0,e._overrideGravity=!1,e._totalTorque=new o(0,0,0),e._totalForce=new o(0,0,0),e._linearVelocity=new o,e._angularVelocity=new o,e._linearFactor=new o(1,1,1),e._angularFactor=new o(1,1,1),e._detectCollisions=!0,e._controlBySimulation=!0,e}return _inherits(Rigidbody3D,N),_createClass(Rigidbody3D,[{key:"_updateMass",value:function(e){if(this._btColliderObject&&this._colliderShape){var t=l.Physics3D._bullet;t.btCollisionShape_calculateLocalInertia(this._colliderShape._btShape,e,Rigidbody3D._btInertia),t.btRigidBody_setMassProps(this._btColliderObject,e,Rigidbody3D._btInertia),t.btRigidBody_updateInertiaTensor(this._btColliderObject)}}},{key:"_onScaleChange",value:function(e){_get(_getPrototypeOf(Rigidbody3D.prototype),"_onScaleChange",this).call(this,e),this._updateMass(this._isKinematic?0:this._mass)}},{key:"_derivePhysicsTransformation",value:function(e){var t=l.Physics3D._bullet,n=this._btColliderObject,i=t.btCollisionObject_getWorldTransform(n),a=Rigidbody3D._btTransform0;t.btTransform_equal(a,i),this._innerDerivePhysicsTransformation(a,e),t.btRigidBody_setCenterOfMassTransform(n,a)}},{key:"_onAdded",value:function(){var e=l.Physics3D._bullet,t=e.layaMotionState_create();e.layaMotionState_set_rigidBodyID(t,this._id),this._btLayaMotionState=t;var n=e.btRigidBodyConstructionInfo_create(0,t,null,Rigidbody3D._btVector3Zero),i=e.btRigidBody_create(n);e.btCollisionObject_setUserIndex(i,this.id),this._btColliderObject=i,_get(_getPrototypeOf(Rigidbody3D.prototype),"_onAdded",this).call(this),this.mass=this._mass,this.linearFactor=this._linearFactor,this.angularFactor=this._angularFactor,this.linearDamping=this._linearDamping,this.angularDamping=this._angularDamping,this.overrideGravity=this._overrideGravity,this.gravity=this._gravity,this.isKinematic=this._isKinematic,e.btRigidBodyConstructionInfo_destroy(n)}},{key:"_onEnable",value:function(){_get(_getPrototypeOf(Rigidbody3D.prototype),"_onEnable",this).call(this),this._constaintRigidbodyA&&this._constaintRigidbodyA.connectedBody._simulation&&(this._constaintRigidbodyA._createConstraint(),this._constaintRigidbodyA._onEnable()),this._constaintRigidbodyB&&this._constaintRigidbodyB.ownBody._simulation&&(this._constaintRigidbodyB._createConstraint(),this._constaintRigidbodyB._onEnable())}},{key:"_onShapeChange",value:function(e){if(_get(_getPrototypeOf(Rigidbody3D.prototype),"_onShapeChange",this).call(this,e),this._isKinematic)this._updateMass(0);else{var t=l.Physics3D._bullet;t.btRigidBody_setCenterOfMassTransform(this._btColliderObject,t.btCollisionObject_getWorldTransform(this._btColliderObject)),this._updateMass(this._mass)}}},{key:"_parse",value:function(e){if(null!=e.friction&&(this.friction=e.friction),null!=e.rollingFriction&&(this.rollingFriction=e.rollingFriction),null!=e.restitution&&(this.restitution=e.restitution),null!=e.isTrigger&&(this.isTrigger=e.isTrigger),null!=e.mass&&(this.mass=e.mass),null!=e.linearDamping&&(this.linearDamping=e.linearDamping),null!=e.angularDamping&&(this.angularDamping=e.angularDamping),null!=e.overrideGravity&&(this.overrideGravity=e.overrideGravity),null!=e.linearFactor){var t=this.linearFactor;t.fromArray(e.linearFactor),this.linearFactor=t}if(null!=e.angularFactor){var n=this.angularFactor;n.fromArray(e.angularFactor),this.angularFactor=n}e.gravity&&(this.gravity.fromArray(e.gravity),this.gravity=this.gravity),_get(_getPrototypeOf(Rigidbody3D.prototype),"_parse",this).call(this,e),this._parseShape(e.shapes),null!=e.isKinematic&&(this.isKinematic=e.isKinematic)}},{key:"_onDestroy",value:function(){l.Physics3D._bullet.btMotionState_destroy(this._btLayaMotionState),_get(_getPrototypeOf(Rigidbody3D.prototype),"_onDestroy",this).call(this),this._btLayaMotionState=null,this._gravity=null,this._totalTorque=null,this._linearVelocity=null,this._angularVelocity=null,this._linearFactor=null,this._angularFactor=null,this.constaintRigidbodyA&&this.constaintRigidbodyA._breakConstrained(),this.constaintRigidbodyB&&(this.constaintRigidbodyB.connectedBody=null,this.constaintRigidbodyB._onDisable())}},{key:"_addToSimulation",value:function(){this._simulation._addRigidBody(this,this._collisionGroup,this._detectCollisions?this._canCollideWith:0)}},{key:"_removeFromSimulation",value:function(){this._simulation._removeRigidBody(this)}},{key:"_cloneTo",value:function(e){_get(_getPrototypeOf(Rigidbody3D.prototype),"_cloneTo",this).call(this,e);var t=e;t.isKinematic=this._isKinematic,t.mass=this._mass,t.gravity=this._gravity,t.angularDamping=this._angularDamping,t.linearDamping=this._linearDamping,t.overrideGravity=this._overrideGravity,t.linearVelocity=this._linearVelocity,t.angularVelocity=this._angularVelocity,t.linearFactor=this._linearFactor,t.angularFactor=this._angularFactor,t.detectCollisions=this._detectCollisions}},{key:"applyForce",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if(null==this._btColliderObject)throw"Attempted to call a Physics function that is avaliable only when the Entity has been already added to the Scene.";var n=l.Physics3D._bullet,i=Rigidbody3D._btTempVector30;if(n.btVector3_setValue(i,-e.x,e.y,e.z),t){var a=Rigidbody3D._btTempVector31;n.btVector3_setValue(a,-t.x,t.y,t.z),n.btRigidBody_applyForce(this._btColliderObject,i,a)}else n.btRigidBody_applyCentralForce(this._btColliderObject,i)}},{key:"applyTorque",value:function(e){if(null==this._btColliderObject)throw"Attempted to call a Physics function that is avaliable only when the Entity has been already added to the Scene.";var t=l.Physics3D._bullet,n=Rigidbody3D._btTempVector30;t.btVector3_setValue(n,-e.x,e.y,e.z),t.btRigidBody_applyTorque(this._btColliderObject,n)}},{key:"applyImpulse",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if(null==this._btColliderObject)throw"Attempted to call a Physics function that is avaliable only when the Entity has been already added to the Scene.";var n=l.Physics3D._bullet;n.btVector3_setValue(Rigidbody3D._btImpulse,-e.x,e.y,e.z),t?(n.btVector3_setValue(Rigidbody3D._btImpulseOffset,-t.x,t.y,t.z),n.btRigidBody_applyImpulse(this._btColliderObject,Rigidbody3D._btImpulse,Rigidbody3D._btImpulseOffset)):n.btRigidBody_applyCentralImpulse(this._btColliderObject,Rigidbody3D._btImpulse)}},{key:"applyTorqueImpulse",value:function(e){if(null==this._btColliderObject)throw"Attempted to call a Physics function that is avaliable only when the Entity has been already added to the Scene.";var t=l.Physics3D._bullet,n=Rigidbody3D._btTempVector30;t.btVector3_setValue(n,-e.x,e.y,e.z),t.btRigidBody_applyTorqueImpulse(this._btColliderObject,n)}},{key:"wakeUp",value:function(){this._btColliderObject&&l.Physics3D._bullet.btCollisionObject_activate(this._btColliderObject,!1)}},{key:"clearForces",value:function(){var e=this._btColliderObject;if(null==e)throw"Attempted to call a Physics function that is avaliable only when the Entity has been already added to the Scene.";var t=l.Physics3D._bullet;t.btRigidBody_clearForces(e);var n=Rigidbody3D._btVector3Zero;t.btCollisionObject_setInterpolationLinearVelocity(e,n),t.btRigidBody_setLinearVelocity(e,n),t.btCollisionObject_setInterpolationAngularVelocity(e,n),t.btRigidBody_setAngularVelocity(e,n)}},{key:"mass",get:function(){return this._mass},set:function(e){e=Math.max(e,1e-7),this._mass=e,this._isKinematic||this._updateMass(e)}},{key:"isKinematic",get:function(){return this._isKinematic},set:function(e){this._isKinematic=e,this._controlBySimulation=!e;var t=l.Physics3D._bullet,n=!!(this._simulation&&this._enabled&&this._colliderShape);n&&this._removeFromSimulation();var i=this._btColliderObject,a=t.btCollisionObject_getCollisionFlags(i);e?(a|=S.COLLISIONFLAGS_KINEMATIC_OBJECT,t.btCollisionObject_setCollisionFlags(i,a),t.btCollisionObject_forceActivationState(this._btColliderObject,S.ACTIVATIONSTATE_DISABLE_DEACTIVATION),this._enableProcessCollisions=!1,this._updateMass(0)):((a&S.COLLISIONFLAGS_KINEMATIC_OBJECT)>0&&(a^=S.COLLISIONFLAGS_KINEMATIC_OBJECT),t.btCollisionObject_setCollisionFlags(i,a),t.btCollisionObject_setActivationState(this._btColliderObject,S.ACTIVATIONSTATE_ACTIVE_TAG),this._enableProcessCollisions=!0,this._updateMass(this._mass));var r=Rigidbody3D._btVector3Zero;t.btCollisionObject_setInterpolationLinearVelocity(i,r),t.btRigidBody_setLinearVelocity(i,r),t.btCollisionObject_setInterpolationAngularVelocity(i,r),t.btRigidBody_setAngularVelocity(i,r),n&&this._addToSimulation()}},{key:"linearDamping",get:function(){return this._linearDamping},set:function(e){this._linearDamping=e,this._btColliderObject&&l.Physics3D._bullet.btRigidBody_setDamping(this._btColliderObject,e,this._angularDamping)}},{key:"angularDamping",get:function(){return this._angularDamping},set:function(e){this._angularDamping=e,this._btColliderObject&&l.Physics3D._bullet.btRigidBody_setDamping(this._btColliderObject,this._linearDamping,e)}},{key:"overrideGravity",get:function(){return this._overrideGravity},set:function(e){this._overrideGravity=e;var t=l.Physics3D._bullet;if(this._btColliderObject){var n=t.btRigidBody_getFlags(this._btColliderObject);e?0==(n&Rigidbody3D._BT_DISABLE_WORLD_GRAVITY)&&t.btRigidBody_setFlags(this._btColliderObject,n|Rigidbody3D._BT_DISABLE_WORLD_GRAVITY):(n&Rigidbody3D._BT_DISABLE_WORLD_GRAVITY)>0&&t.btRigidBody_setFlags(this._btColliderObject,n^Rigidbody3D._BT_DISABLE_WORLD_GRAVITY)}}},{key:"gravity",get:function(){var e=l.Physics3D._bullet;return Rigidbody3D._btGravity=e.btRigidBody_getGravity(this._btColliderObject),P._convertToLayaVec3(Rigidbody3D._btGravity,this._gravity,!0),this._gravity},set:function(e){this._gravity=e;var t=l.Physics3D._bullet;t.btVector3_setValue(Rigidbody3D._btGravity,-e.x,e.y,e.z),t.btRigidBody_setGravity(this._btColliderObject,Rigidbody3D._btGravity)}},{key:"totalForce",get:function(){if(this._btColliderObject){var e=l.Physics3D._bullet.btRigidBody_getTotalForce(this._btColliderObject);return P._convertToLayaVec3(e,this._totalForce,!0),this._totalForce}return null}},{key:"linearFactor",get:function(){return this._linearFactor},set:function(e){this._linearFactor=e;var t=Rigidbody3D._btTempVector30;P._convertToBulletVec3(e,t,!1),l.Physics3D._bullet.btRigidBody_setLinearFactor(this._btColliderObject,t)}},{key:"linearVelocity",get:function(){return this._btColliderObject&&P._convertToLayaVec3(l.Physics3D._bullet.btRigidBody_getLinearVelocity(this._btColliderObject),this._linearVelocity,!0),this._linearVelocity},set:function(e){if(this._linearVelocity=e,this._btColliderObject){var t=Rigidbody3D._btTempVector30;P._convertToBulletVec3(e,t,!0),this.isSleeping&&this.wakeUp(),l.Physics3D._bullet.btRigidBody_setLinearVelocity(this._btColliderObject,t)}}},{key:"angularFactor",get:function(){return this._angularFactor},set:function(e){this._angularFactor=e;var t=Rigidbody3D._btTempVector30;P._convertToBulletVec3(e,t,!1),l.Physics3D._bullet.btRigidBody_setAngularFactor(this._btColliderObject,t)}},{key:"angularVelocity",get:function(){return this._btColliderObject&&P._convertToLayaVec3(l.Physics3D._bullet.btRigidBody_getAngularVelocity(this._btColliderObject),this._angularVelocity,!0),this._angularVelocity},set:function(e){if(this._angularVelocity=e,this._btColliderObject){var t=Rigidbody3D._btTempVector30;P._convertToBulletVec3(e,t,!0),this.isSleeping&&this.wakeUp(),l.Physics3D._bullet.btRigidBody_setAngularVelocity(this._btColliderObject,t)}}},{key:"totalTorque",get:function(){if(this._btColliderObject){var e=l.Physics3D._bullet.btRigidBody_getTotalTorque(this._btColliderObject);return P._convertToLayaVec3(e,this._totalTorque,!0),this._totalTorque}return null}},{key:"detectCollisions",get:function(){return this._detectCollisions},set:function(e){this._detectCollisions!==e&&(this._detectCollisions=e,this._colliderShape&&this._enabled&&this._simulation&&(this._simulation._removeRigidBody(this),this._simulation._addRigidBody(this,this._collisionGroup,e?this._canCollideWith:0)))}},{key:"isSleeping",get:function(){return!!this._btColliderObject&&l.Physics3D._bullet.btCollisionObject_getActivationState(this._btColliderObject)===S.ACTIVATIONSTATE_ISLAND_SLEEPING}},{key:"sleepLinearVelocity",get:function(){return l.Physics3D._bullet.btRigidBody_getLinearSleepingThreshold(this._btColliderObject)},set:function(e){var t=l.Physics3D._bullet;t.btRigidBody_setSleepingThresholds(this._btColliderObject,e,t.btRigidBody_getAngularSleepingThreshold(this._btColliderObject))}},{key:"sleepAngularVelocity",get:function(){return l.Physics3D._bullet.btRigidBody_getAngularSleepingThreshold(this._btColliderObject)},set:function(e){var t=l.Physics3D._bullet;t.btRigidBody_setSleepingThresholds(this._btColliderObject,t.btRigidBody_getLinearSleepingThreshold(this._btColliderObject),e)}},{key:"btColliderObject",get:function(){return this._btColliderObject}},{key:"constaintRigidbodyA",set:function(e){this._constaintRigidbodyA=e},get:function(){return this._constaintRigidbodyA}},{key:"constaintRigidbodyB",set:function(e){this._constaintRigidbodyB=e},get:function(){return this._constaintRigidbodyB}}],[{key:"__init__",value:function(){var e=l.Physics3D._bullet;Rigidbody3D._btTempVector30=e.btVector3_create(0,0,0),Rigidbody3D._btTempVector31=e.btVector3_create(0,0,0),Rigidbody3D._btVector3Zero=e.btVector3_create(0,0,0),Rigidbody3D._btInertia=e.btVector3_create(0,0,0),Rigidbody3D._btImpulse=e.btVector3_create(0,0,0),Rigidbody3D._btImpulseOffset=e.btVector3_create(0,0,0),Rigidbody3D._btGravity=e.btVector3_create(0,0,0),Rigidbody3D._btTransform0=e.btTransform_create()}}]),Rigidbody3D}();b.TYPE_STATIC=0,b.TYPE_DYNAMIC=1,b.TYPE_KINEMATIC=2,b._BT_DISABLE_WORLD_GRAVITY=1,b._BT_ENABLE_GYROPSCOPIC_FORCE=2;var k=function(){function Physics3D(){_classCallCheck(this,Physics3D)}return _createClass(Physics3D,null,[{key:"__bulletinit__",value:function(){this._bullet=window.Physics3D,this._bullet&&(_.__init__(),h.__init__(),d.__init__(),S.__init__(),I.__init__(),p.__init__(),g.__init__(),O.__init__(),b.__init__())}},{key:"__cannoninit__",value:function(){this._cannon=window.CANNON,this._cannon&&(t.CannonColliderShape.__init__(),t.CannonPhysicsComponent.__init__(),t.CannonPhysicsSimulation.__init__(),t.CannonBoxColliderShape.__init__(),t.CannonRigidbody3D.__init__())}}]),Physics3D}();k._bullet=null,k._cannon=null,k._enablePhysics=!1;var w=function(){function Config3D(){_classCallCheck(this,Config3D),this._defaultPhysicsMemory=16,this._maxLightCount=32,this._lightClusterCount=new o(12,12,12),this._editerEnvironment=!1,this.isAntialias=!0,this.isAlpha=!1,this.premultipliedAlpha=!0,this.isStencil=!0,this.enableMultiLight=!0,this.octreeCulling=!1,this.octreeInitialSize=64,this.octreeInitialCenter=new o(0,0,0),this.octreeMinNodeSize=2,this.octreeLooseness=1.25,this.debugFrustumCulling=!1,this.pbrRenderQuality=e.PBRRenderQuality.High,this.isUseCannonPhysicsEngine=!1,this._maxAreaLightCountPerClusterAverage=Math.min(4*Math.floor(2048/this._lightClusterCount.z-1),this._maxLightCount)}return _createClass(Config3D,[{key:"cloneTo",value:function(e){var t=e;t._defaultPhysicsMemory=this._defaultPhysicsMemory,t._editerEnvironment=this._editerEnvironment,t.isAntialias=this.isAntialias,t.isAlpha=this.isAlpha,t.premultipliedAlpha=this.premultipliedAlpha,t.isStencil=this.isStencil,t.octreeCulling=this.octreeCulling,this.octreeInitialCenter.cloneTo(t.octreeInitialCenter),t.octreeInitialSize=this.octreeInitialSize,t.octreeMinNodeSize=this.octreeMinNodeSize,t.octreeLooseness=this.octreeLooseness,t.debugFrustumCulling=this.debugFrustumCulling,t.maxLightCount=this.maxLightCount,t.enableMultiLight=this.enableMultiLight;var n=t.lightClusterCount;this.lightClusterCount.cloneTo(n),t.lightClusterCount=n,t.pbrRenderQuality=this.pbrRenderQuality}},{key:"clone",value:function(){var e=new Config3D;return this.cloneTo(e),e}},{key:"defaultPhysicsMemory",get:function(){return this._defaultPhysicsMemory},set:function(e){if(e<16)throw"defaultPhysicsMemory must large than 16M";this._defaultPhysicsMemory=e}},{key:"maxLightCount",get:function(){return this._maxLightCount},set:function(e){e>2048?(this._maxLightCount=2048,console.warn("Config3D: maxLightCount must less equal 2048.")):this._maxLightCount=e}},{key:"lightClusterCount",get:function(){return this._lightClusterCount},set:function(e){e.x>128||e.y>128||e.z>128?(this._lightClusterCount.setValue(Math.min(e.x,128),Math.min(e.y,128),Math.min(e.z,128)),console.warn("Config3D: lightClusterCount X and Y、Z must less equal 128.")):e.cloneTo(this._lightClusterCount);var t=4*Math.floor(2048/this._lightClusterCount.z-1);t<this._maxLightCount&&console.warn("Config3D: if the area light(PointLight、SpotLight) count is large than "+t+",maybe the far away culster will ingonre some light."),this._maxAreaLightCountPerClusterAverage=Math.min(t,this._maxLightCount)}}],[{key:"useCannonPhysics",get:function(){return Config3D._config.isUseCannonPhysicsEngine},set:function(e){Config3D._config.isUseCannonPhysicsEngine=e,e&&(k.__cannoninit__(),l.Scene3D.cannonPhysicsSettings||(l.Scene3D.cannonPhysicsSettings=new t.CannonPhysicsSettings))}}]),Config3D}();w._config=new w,window.Config3D=w;var B=function(){function KeyframeNode(){_classCallCheck(this,KeyframeNode),this._ownerPath=[],this._propertys=[],this._keyFrames=[]}return _createClass(KeyframeNode,[{key:"_setOwnerPathCount",value:function(e){this._ownerPath.length=e}},{key:"_setOwnerPathByIndex",value:function(e,t){this._ownerPath[e]=t}},{key:"_joinOwnerPath",value:function(e){return this._ownerPath.join(e)}},{key:"_setPropertyCount",value:function(e){this._propertys.length=e}},{key:"_setPropertyByIndex",value:function(e,t){this._propertys[e]=t}},{key:"_joinProperty",value:function(e){return this._propertys.join(e)}},{key:"_setKeyframeCount",value:function(e){this._keyFrames.length=e}},{key:"_setKeyframeByIndex",value:function(e,t){this._keyFrames[e]=t}},{key:"getOwnerPathByIndex",value:function(e){return this._ownerPath[e]}},{key:"getPropertyByIndex",value:function(e){return this._propertys[e]}},{key:"getKeyframeByIndex",value:function(e){return this._keyFrames[e]}},{key:"ownerPathCount",get:function(){return this._ownerPath.length}},{key:"propertyCount",get:function(){return this._propertys.length}},{key:"keyFramesCount",get:function(){return this._keyFrames.length}}]),KeyframeNode}(),V=function AnimationEvent(){_classCallCheck(this,AnimationEvent)},F=function(){function Keyframe(){_classCallCheck(this,Keyframe)}return _createClass(Keyframe,[{key:"cloneTo",value:function(e){e.time=this.time}},{key:"clone",value:function(){var e=new Keyframe;return this.cloneTo(e),e}}]),Keyframe}(),U=function(e){function FloatKeyframe(){return _classCallCheck(this,FloatKeyframe),_possibleConstructorReturn(this,_getPrototypeOf(FloatKeyframe).call(this))}return _inherits(FloatKeyframe,F),_createClass(FloatKeyframe,[{key:"cloneTo",value:function(e){_get(_getPrototypeOf(FloatKeyframe.prototype),"cloneTo",this).call(this,e);var t=e;t.inTangent=this.inTangent,t.outTangent=this.outTangent,t.value=this.value}}]),FloatKeyframe}(),G=function(e){function QuaternionKeyframe(){var e;return _classCallCheck(this,QuaternionKeyframe),(e=_possibleConstructorReturn(this,_getPrototypeOf(QuaternionKeyframe).call(this))).inTangent=new a,e.outTangent=new a,e.value=new u,e}return _inherits(QuaternionKeyframe,F),_createClass(QuaternionKeyframe,[{key:"cloneTo",value:function(e){_get(_getPrototypeOf(QuaternionKeyframe.prototype),"cloneTo",this).call(this,e);var t=e;this.inTangent.cloneTo(t.inTangent),this.outTangent.cloneTo(t.outTangent),this.value.cloneTo(t.value)}}]),QuaternionKeyframe}(),H=function(e){function Vector3Keyframe(){var e;return _classCallCheck(this,Vector3Keyframe),(e=_possibleConstructorReturn(this,_getPrototypeOf(Vector3Keyframe).call(this))).inTangent=new o,e.outTangent=new o,e.value=new o,e}return _inherits(Vector3Keyframe,F),_createClass(Vector3Keyframe,[{key:"cloneTo",value:function(e){_get(_getPrototypeOf(Vector3Keyframe.prototype),"cloneTo",this).call(this,e);var t=e;this.inTangent.cloneTo(t.inTangent),this.outTangent.cloneTo(t.outTangent),this.value.cloneTo(t.value)}}]),Vector3Keyframe}(),z=function(){function AnimationClipParser03(){_classCallCheck(this,AnimationClipParser03)}return _createClass(AnimationClipParser03,null,[{key:"READ_DATA",value:function(){AnimationClipParser03._DATA.offset=AnimationClipParser03._reader.getUint32(),AnimationClipParser03._DATA.size=AnimationClipParser03._reader.getUint32()}},{key:"READ_BLOCK",value:function(){for(var e=AnimationClipParser03._BLOCK.count=AnimationClipParser03._reader.getUint16(),t=AnimationClipParser03._BLOCK.blockStarts=[],n=AnimationClipParser03._BLOCK.blockLengths=[],i=0;i<e;i++)t.push(AnimationClipParser03._reader.getUint32()),n.push(AnimationClipParser03._reader.getUint32())}},{key:"READ_STRINGS",value:function(){var e=AnimationClipParser03._reader.getUint32(),t=AnimationClipParser03._reader.getUint16(),n=AnimationClipParser03._reader.pos;AnimationClipParser03._reader.pos=e+AnimationClipParser03._DATA.offset;for(var i=0;i<t;i++)AnimationClipParser03._strings[i]=AnimationClipParser03._reader.readUTFString();AnimationClipParser03._reader.pos=n}},{key:"parse",value:function(e,t){AnimationClipParser03._animationClip=e,AnimationClipParser03._reader=t,AnimationClipParser03.READ_DATA(),AnimationClipParser03.READ_BLOCK(),AnimationClipParser03.READ_STRINGS();for(var n=0,i=AnimationClipParser03._BLOCK.count;n<i;n++){var a=t.getUint16(),r=AnimationClipParser03._strings[a],o=AnimationClipParser03["READ_"+r];if(null==o)throw new Error("model file err,no this function:"+a+" "+r);o.call(null)}}},{key:"READ_ANIMATIONS",value:function(){var e,t,n,i=AnimationClipParser03._reader,a=[],r=i.getUint16();for(a.length=r,e=0;e<r;e++)a[e]=i.getFloat32();var o=AnimationClipParser03._animationClip;o.name=AnimationClipParser03._strings[i.getUint16()];var s=o._duration=i.getFloat32();o.islooping=!!i.getByte(),o._frameRate=i.getInt16();var l=i.getInt16(),u=o._nodes;u.count=l;var c=o._nodesMap={},h=o._nodesDic={};for(e=0;e<l;e++){n=new B,u.setNodeByIndex(e,n),n._indexInList=e;var _=n.type=i.getUint8(),d=i.getUint16();for(n._setOwnerPathCount(d),t=0;t<d;t++)n._setOwnerPathByIndex(t,AnimationClipParser03._strings[i.getUint16()]);var f=n._joinOwnerPath("/"),m=c[f];m||(c[f]=m=[]),m.push(n),n.propertyOwner=AnimationClipParser03._strings[i.getUint16()];var p=i.getUint16();for(n._setPropertyCount(p),t=0;t<p;t++)n._setPropertyByIndex(t,AnimationClipParser03._strings[i.getUint16()]);var T=f+"."+n.propertyOwner+"."+n._joinProperty(".");h[T]=n,n.fullPath=T;var v=i.getUint16();for(n._setKeyframeCount(v),t=0;t<v;t++)switch(_){case 0:var g=new U;n._setKeyframeByIndex(t,g),g.time=a[i.getUint16()],g.inTangent=i.getFloat32(),g.outTangent=i.getFloat32(),g.value=i.getFloat32();break;case 1:case 3:case 4:var E=new H;n._setKeyframeByIndex(t,E),E.time=a[i.getUint16()];var y=E.inTangent,S=E.outTangent,R=E.value;y.x=i.getFloat32(),y.y=i.getFloat32(),y.z=i.getFloat32(),S.x=i.getFloat32(),S.y=i.getFloat32(),S.z=i.getFloat32(),R.x=i.getFloat32(),R.y=i.getFloat32(),R.z=i.getFloat32();break;case 2:var C=new G;n._setKeyframeByIndex(t,C),C.time=a[i.getUint16()];var M=C.inTangent,D=C.outTangent,x=C.value;M.x=i.getFloat32(),M.y=i.getFloat32(),M.z=i.getFloat32(),M.w=i.getFloat32(),D.x=i.getFloat32(),D.y=i.getFloat32(),D.z=i.getFloat32(),D.w=i.getFloat32(),x.x=i.getFloat32(),x.y=i.getFloat32(),x.z=i.getFloat32(),x.w=i.getFloat32();break;default:throw"AnimationClipParser03:unknown type."}}var A=i.getUint16();for(e=0;e<A;e++){var I=new V;I.time=Math.min(s,i.getFloat32()),I.eventName=AnimationClipParser03._strings[i.getUint16()];var L=[],P=i.getUint16();for(P>0&&(I.params=L=[]),t=0;t<P;t++){switch(i.getByte()){case 0:L.push(!!i.getByte());break;case 1:L.push(i.getInt32());break;case 2:L.push(i.getFloat32());break;case 3:L.push(AnimationClipParser03._strings[i.getUint16()]);break;default:throw new Error("unknown type.")}}o.addEvent(I)}}}]),AnimationClipParser03}();z._strings=[],z._BLOCK={count:0},z._DATA={offset:0,size:0};var W=function(){function AnimationClipParser04(){_classCallCheck(this,AnimationClipParser04)}return _createClass(AnimationClipParser04,null,[{key:"READ_DATA",value:function(){AnimationClipParser04._DATA.offset=AnimationClipParser04._reader.getUint32(),AnimationClipParser04._DATA.size=AnimationClipParser04._reader.getUint32()}},{key:"READ_BLOCK",value:function(){for(var e=AnimationClipParser04._BLOCK.count=AnimationClipParser04._reader.getUint16(),t=AnimationClipParser04._BLOCK.blockStarts=[],n=AnimationClipParser04._BLOCK.blockLengths=[],i=0;i<e;i++)t.push(AnimationClipParser04._reader.getUint32()),n.push(AnimationClipParser04._reader.getUint32())}},{key:"READ_STRINGS",value:function(){var e=AnimationClipParser04._reader.getUint32(),t=AnimationClipParser04._reader.getUint16(),n=AnimationClipParser04._reader.pos;AnimationClipParser04._reader.pos=e+AnimationClipParser04._DATA.offset;for(var i=0;i<t;i++)AnimationClipParser04._strings[i]=AnimationClipParser04._reader.readUTFString();AnimationClipParser04._reader.pos=n}},{key:"parse",value:function(e,t,n){AnimationClipParser04._animationClip=e,AnimationClipParser04._reader=t,AnimationClipParser04._version=n,AnimationClipParser04.READ_DATA(),AnimationClipParser04.READ_BLOCK(),AnimationClipParser04.READ_STRINGS();for(var i=0,a=AnimationClipParser04._BLOCK.count;i<a;i++){var r=t.getUint16(),o=AnimationClipParser04._strings[r],s=AnimationClipParser04["READ_"+o];if(null==s)throw new Error("model file err,no this function:"+r+" "+o);s.call(null)}AnimationClipParser04._version=null,AnimationClipParser04._reader=null,AnimationClipParser04._animationClip=null}},{key:"READ_ANIMATIONS",value:function(){var e,n,i,a=AnimationClipParser04._reader,r=[],o=a.getUint16();for(r.length=o,e=0;e<o;e++)r[e]=a.getFloat32();var s=AnimationClipParser04._animationClip;s.name=AnimationClipParser04._strings[a.getUint16()];var l=s._duration=a.getFloat32();s.islooping=!!a.getByte(),s._frameRate=a.getInt16();var u=a.getInt16(),c=s._nodes;c.count=u;var h=s._nodesMap={},_=s._nodesDic={};for(e=0;e<u;e++){i=new B,c.setNodeByIndex(e,i),i._indexInList=e;var d=i.type=a.getUint8(),f=a.getUint16();for(i._setOwnerPathCount(f),n=0;n<f;n++)i._setOwnerPathByIndex(n,AnimationClipParser04._strings[a.getUint16()]);var m=i._joinOwnerPath("/"),p=h[m];p||(h[m]=p=[]),p.push(i),i.propertyOwner=AnimationClipParser04._strings[a.getUint16()];var T=a.getUint16();for(i._setPropertyCount(T),n=0;n<T;n++)i._setPropertyByIndex(n,AnimationClipParser04._strings[a.getUint16()]);var v=m+"."+i.propertyOwner+"."+i._joinProperty(".");_[v]=i,i.fullPath=v;var g=a.getUint16();switch(i._setKeyframeCount(g),AnimationClipParser04._version){case"LAYAANIMATION:04":for(n=0;n<g;n++)switch(d){case 0:var E=new U;i._setKeyframeByIndex(n,E),E.time=r[a.getUint16()],E.inTangent=a.getFloat32(),E.outTangent=a.getFloat32(),E.value=a.getFloat32();break;case 1:case 3:case 4:var y=new H;i._setKeyframeByIndex(n,y),y.time=r[a.getUint16()];var S=y.inTangent,R=y.outTangent,C=y.value;S.x=a.getFloat32(),S.y=a.getFloat32(),S.z=a.getFloat32(),R.x=a.getFloat32(),R.y=a.getFloat32(),R.z=a.getFloat32(),C.x=a.getFloat32(),C.y=a.getFloat32(),C.z=a.getFloat32();break;case 2:var M=new G;i._setKeyframeByIndex(n,M),M.time=r[a.getUint16()];var D=M.inTangent,x=M.outTangent,A=M.value;D.x=a.getFloat32(),D.y=a.getFloat32(),D.z=a.getFloat32(),D.w=a.getFloat32(),x.x=a.getFloat32(),x.y=a.getFloat32(),x.z=a.getFloat32(),x.w=a.getFloat32(),A.x=a.getFloat32(),A.y=a.getFloat32(),A.z=a.getFloat32(),A.w=a.getFloat32();break;default:throw"AnimationClipParser04:unknown type."}break;case"LAYAANIMATION:COMPRESSION_04":for(n=0;n<g;n++)switch(d){case 0:E=new U,i._setKeyframeByIndex(n,E),E.time=r[a.getUint16()],E.inTangent=t.HalfFloatUtils.convertToNumber(a.getUint16()),E.outTangent=t.HalfFloatUtils.convertToNumber(a.getUint16()),E.value=t.HalfFloatUtils.convertToNumber(a.getUint16());break;case 1:case 3:case 4:y=new H,i._setKeyframeByIndex(n,y),y.time=r[a.getUint16()],S=y.inTangent,R=y.outTangent,C=y.value,S.x=t.HalfFloatUtils.convertToNumber(a.getUint16()),S.y=t.HalfFloatUtils.convertToNumber(a.getUint16()),S.z=t.HalfFloatUtils.convertToNumber(a.getUint16()),R.x=t.HalfFloatUtils.convertToNumber(a.getUint16()),R.y=t.HalfFloatUtils.convertToNumber(a.getUint16()),R.z=t.HalfFloatUtils.convertToNumber(a.getUint16()),C.x=t.HalfFloatUtils.convertToNumber(a.getUint16()),C.y=t.HalfFloatUtils.convertToNumber(a.getUint16()),C.z=t.HalfFloatUtils.convertToNumber(a.getUint16());break;case 2:M=new G,i._setKeyframeByIndex(n,M),M.time=r[a.getUint16()],D=M.inTangent,x=M.outTangent,A=M.value,D.x=t.HalfFloatUtils.convertToNumber(a.getUint16()),D.y=t.HalfFloatUtils.convertToNumber(a.getUint16()),D.z=t.HalfFloatUtils.convertToNumber(a.getUint16()),D.w=t.HalfFloatUtils.convertToNumber(a.getUint16()),x.x=t.HalfFloatUtils.convertToNumber(a.getUint16()),x.y=t.HalfFloatUtils.convertToNumber(a.getUint16()),x.z=t.HalfFloatUtils.convertToNumber(a.getUint16()),x.w=t.HalfFloatUtils.convertToNumber(a.getUint16()),A.x=t.HalfFloatUtils.convertToNumber(a.getUint16()),A.y=t.HalfFloatUtils.convertToNumber(a.getUint16()),A.z=t.HalfFloatUtils.convertToNumber(a.getUint16()),A.w=t.HalfFloatUtils.convertToNumber(a.getUint16());break;default:throw"AnimationClipParser04:unknown type."}}}var I=a.getUint16();for(e=0;e<I;e++){var L=new V;L.time=Math.min(l,a.getFloat32()),L.eventName=AnimationClipParser04._strings[a.getUint16()];var P=[],O=a.getUint16();for(O>0&&(L.params=P=[]),n=0;n<O;n++){switch(a.getByte()){case 0:P.push(!!a.getByte());break;case 1:P.push(a.getInt32());break;case 2:P.push(a.getFloat32());break;case 3:P.push(AnimationClipParser04._strings[a.getUint16()]);break;default:throw new Error("unknown type.")}}s.addEvent(L)}}}]),AnimationClipParser04}();W._strings=[],W._BLOCK={count:0},W._DATA={offset:0,size:0};var X=function(){function KeyframeNodeList(){_classCallCheck(this,KeyframeNodeList),this._nodes=[]}return _createClass(KeyframeNodeList,[{key:"getNodeByIndex",value:function(e){return this._nodes[e]}},{key:"setNodeByIndex",value:function(e,t){this._nodes[e]=t}},{key:"count",get:function(){return this._nodes.length},set:function(e){this._nodes.length=e}}]),KeyframeNodeList}(),Y=function(e){function AnimationClip(){var e;return _classCallCheck(this,AnimationClip),(e=_possibleConstructorReturn(this,_getPrototypeOf(AnimationClip).call(this)))._duration=0,e._frameRate=0,e._nodes=new X,e.islooping=!1,e._animationEvents=[],e}return _inherits(AnimationClip,t.Resource),_createClass(AnimationClip,[{key:"duration",value:function(){return this._duration}},{key:"_hermiteInterpolate",value:function(e,t,n,i){var a=e.outTangent,r=t.inTangent;if(Number.isFinite(a)&&Number.isFinite(r)){var o=n*n,s=o*n,l=s-2*o+n,u=s-o,c=-2*s+3*o;return(2*s-3*o+1)*e.value+l*a*i+u*r*i+c*t.value}return e.value}},{key:"_hermiteInterpolateVector3",value:function(e,t,n,i,a){var r=e.value,o=e.outTangent,s=t.value,l=t.inTangent,u=n*n,c=u*n,h=2*c-3*u+1,_=c-2*u+n,d=c-u,f=-2*c+3*u,m=o.x,p=l.x;Number.isFinite(m)&&Number.isFinite(p)?a.x=h*r.x+_*m*i+d*p*i+f*s.x:a.x=r.x,m=o.y,p=l.y,Number.isFinite(m)&&Number.isFinite(p)?a.y=h*r.y+_*m*i+d*p*i+f*s.y:a.y=r.y,m=o.z,p=l.z,Number.isFinite(m)&&Number.isFinite(p)?a.z=h*r.z+_*m*i+d*p*i+f*s.z:a.z=r.z}},{key:"_hermiteInterpolateQuaternion",value:function(e,t,n,i,a){var r=e.value,o=e.outTangent,s=t.value,l=t.inTangent,u=n*n,c=u*n,h=2*c-3*u+1,_=c-2*u+n,d=c-u,f=-2*c+3*u,m=o.x,p=l.x;Number.isFinite(m)&&Number.isFinite(p)?a.x=h*r.x+_*m*i+d*p*i+f*s.x:a.x=r.x,m=o.y,p=l.y,Number.isFinite(m)&&Number.isFinite(p)?a.y=h*r.y+_*m*i+d*p*i+f*s.y:a.y=r.y,m=o.z,p=l.z,Number.isFinite(m)&&Number.isFinite(p)?a.z=h*r.z+_*m*i+d*p*i+f*s.z:a.z=r.z,m=o.w,p=l.w,Number.isFinite(m)&&Number.isFinite(p)?a.w=h*r.w+_*m*i+d*p*i+f*s.w:a.w=r.w}},{key:"_evaluateClipDatasRealTime",value:function(e,t,n,i,a,r){for(var o=0,s=e.count;o<s;o++){var l,c=e.getNodeByIndex(o),h=c.type,_=c._keyFrames,d=_.length,f=n[o];if(a)for(-1!==f&&t<_[f].time&&(f=-1,n[o]=f),l=f+1;l<d&&!(_[l].time>t);)f++,l++,n[o]=f;else for((l=f+1)!==d&&t>_[l].time&&(f=d-1,n[o]=f),l=f+1;f>-1&&!(_[f].time<t);)f--,l--,n[o]=f;var m=l===d;switch(h){case 0:if(-1!==f){var p=_[f];if(m)r[o]=p.value;else{var T,v=_[l],g=v.time-p.time;T=0!==g?(t-p.time)/g:0,r[o]=this._hermiteInterpolate(p,v,T,g)}}else r[o]=_[0].value;i&&(r[o]=r[o]-_[0].value);break;case 1:case 4:var E=r[o];if(this._evaluateFrameNodeVector3DatasRealTime(_,f,m,t,E),i){var y=_[0].value;E.x-=y.x,E.y-=y.y,E.z-=y.z}break;case 2:var S=r[o];if(this._evaluateFrameNodeQuaternionDatasRealTime(_,f,m,t,S),i){var R=AnimationClip._tempQuaternion0,C=_[0].value;P.quaternionConjugate(C,R),u.multiply(R,S,S)}break;case 3:E=r[o],this._evaluateFrameNodeVector3DatasRealTime(_,f,m,t,E),i&&(y=_[0].value,E.x/=y.x,E.y/=y.y,E.z/=y.z);break;default:throw"AnimationClip:unknown node type."}}}},{key:"_evaluateClipDatasRealTimeForNative",value:function(e,n,i,a){t.LayaGL.instance.evaluateClipDatasRealTime(e._nativeObj,n,i,a)}},{key:"_evaluateFrameNodeVector3DatasRealTime",value:function(e,t,n,i,a){if(-1!==t){var r=e[t];if(n){var o=r.value;a.x=o.x,a.y=o.y,a.z=o.z}else{var s,l=e[t+1],u=r.time,c=l.time-u;s=0!==c?(i-u)/c:0,this._hermiteInterpolateVector3(r,l,s,c,a)}}else{var h=e[0].value;a.x=h.x,a.y=h.y,a.z=h.z}}},{key:"_evaluateFrameNodeQuaternionDatasRealTime",value:function(e,t,n,i,a){if(-1!==t){var r=e[t];if(n){var o=r.value;a.x=o.x,a.y=o.y,a.z=o.z,a.w=o.w}else{var s,l=e[t+1],u=r.time,c=l.time-u;s=0!==c?(i-u)/c:0,this._hermiteInterpolateQuaternion(r,l,s,c,a)}}else{var h=e[0].value;a.x=h.x,a.y=h.y,a.z=h.z,a.w=h.w}}},{key:"_binarySearchEventIndex",value:function(e){for(var t,n=0,i=this._animationEvents.length-1;n<=i;){t=Math.floor((n+i)/2);var a=this._animationEvents[t].time;if(a==e)return t;a>e?i=t-1:n=t+1}return n}},{key:"addEvent",value:function(e){var t=this._binarySearchEventIndex(e.time);this._animationEvents.splice(t,0,e)}},{key:"_disposeResource",value:function(){this._nodes=null,this._nodesMap=null}}],[{key:"_parse",value:function(e){var n=new AnimationClip,i=new t.Byte(e),a=i.readUTFString();switch(a){case"LAYAANIMATION:03":z.parse(n,i);break;case"LAYAANIMATION:04":case"LAYAANIMATION:COMPRESSION_04":W.parse(n,i,a);break;default:throw"unknown animationClip version."}return n}},{key:"load",value:function(e,n){t.ILaya.loader.create(e,n,null,AnimationClip.ANIMATIONCLIP)}}]),AnimationClip}();Y.ANIMATIONCLIP="ANIMATIONCLIP",Y._tempQuaternion0=new u;var j=function(){function AnimatorPlayState(){_classCallCheck(this,AnimatorPlayState),this._currentState=null}return _createClass(AnimatorPlayState,[{key:"_resetPlayState",value:function(e,t){this._finish=!1,this._startPlayTime=e,this._elapsedTime=e,this._playEventIndex=0,this._lastIsFront=!0,this._normalizedTime=this._elapsedTime/t;var n=this._normalizedTime%1;this._normalizedPlayTime=n<0?n+1:n}},{key:"_cloneTo",value:function(e){e._finish=this._finish,e._startPlayTime=this._startPlayTime,e._elapsedTime=this._elapsedTime,e._normalizedTime=this._normalizedTime,e._normalizedPlayTime=this._normalizedPlayTime,e._playEventIndex=this._playEventIndex,e._lastIsFront=this._lastIsFront}},{key:"normalizedTime",get:function(){return this._normalizedTime}},{key:"duration",get:function(){return this._duration}},{key:"animatorState",get:function(){return this._currentState}}]),AnimatorPlayState}(),Z=function(){function AnimatorControllerLayer(e){_classCallCheck(this,AnimatorControllerLayer),this._referenceCount=0,this._playType=-1,this._crossDuration=-1,this._crossMark=0,this._crossNodesOwnersCount=0,this._crossNodesOwners=[],this._crossNodesOwnersIndicesMap={},this._srcCrossClipNodeIndices=[],this._destCrossClipNodeIndices=[],this._statesMap={},this._states=[],this._playStateInfo=new j,this._crossPlayStateInfo=new j,this.blendingMode=AnimatorControllerLayer.BLENDINGMODE_OVERRIDE,this.defaultWeight=1,this.playOnWake=!0,this.name=e}return _createClass(AnimatorControllerLayer,[{key:"_removeClip",value:function(e,t,n,i){var a=i._clip,r=e[n];if(e.splice(n,1),delete t[i.name],this._animator){var o=a._nodes,s=r._nodeOwners;a._removeReference();for(var l=0,u=o.count;l<u;l++)this._animator._removeKeyframeNodeOwner(s,o.getNodeByIndex(l))}}},{key:"_getReferenceCount",value:function(){return this._referenceCount}},{key:"_addReference",value:function(){for(var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,t=0,n=this._states.length;t<n;t++)this._states[t]._addReference(e);this._referenceCount+=e}},{key:"_removeReference",value:function(){for(var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,t=0,n=this._states.length;t<n;t++)this._states[t]._removeReference(e);this._referenceCount-=e}},{key:"_clearReference",value:function(){this._removeReference(-this._referenceCount)}},{key:"getCurrentPlayState",value:function(){return this._playStateInfo}},{key:"getAnimatorState",value:function(e){var t=this._statesMap[e];return t||null}},{key:"addState",value:function(e){var t=e.name;if(this._statesMap[t])throw"AnimatorControllerLayer:this stat's name has exist.";this._statesMap[t]=e,this._states.push(e),this._animator&&(e._clip._addReference(),this._animator._getOwnersByClip(e))}},{key:"removeState",value:function(e){for(var t=this._states,n=-1,i=0,a=t.length;i<a;i++)if(t[i]===e){n=i;break}-1!==n&&this._removeClip(t,this._statesMap,n,e)}},{key:"destroy",value:function(){this._clearReference(),this._statesMap=null,this._states=[],this._playStateInfo=null,this._crossPlayStateInfo=null,this._defaultState=null}},{key:"cloneTo",value:function(e){var t=e;t.name=this.name,t.blendingMode=this.blendingMode,t.defaultWeight=this.defaultWeight,t.playOnWake=this.playOnWake}},{key:"clone",value:function(){var e=new AnimatorControllerLayer(this.name);return this.cloneTo(e),e}},{key:"defaultState",get:function(){return this._defaultState},set:function(e){this._defaultState=e,this._statesMap[e.name]=e}}]),AnimatorControllerLayer}();Z.BLENDINGMODE_OVERRIDE=0,Z.BLENDINGMODE_ADDTIVE=1;var Q=function(){function AnimatorState(){_classCallCheck(this,AnimatorState),this._referenceCount=0,this._clip=null,this._nodeOwners=[],this._currentFrameIndices=null,this._realtimeDatas=[],this._scripts=null,this.speed=1,this.clipStart=0,this.clipEnd=1}return _createClass(AnimatorState,[{key:"_getReferenceCount",value:function(){return this._referenceCount}},{key:"_addReference",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;this._clip&&this._clip._addReference(e),this._referenceCount+=e}},{key:"_removeReference",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;this._clip&&this._clip._removeReference(e),this._referenceCount-=e}},{key:"_clearReference",value:function(){this._removeReference(-this._referenceCount)}},{key:"_resetFrameIndices",value:function(){for(var e=0,t=this._currentFrameIndices.length;e<t;e++)this._currentFrameIndices[e]=-1}},{key:"addScript",value:function(e){var t=new e;return this._scripts=this._scripts||[],this._scripts.push(t),t}},{key:"getScript",value:function(e){if(this._scripts)for(var t=0,n=this._scripts.length;t<n;t++){var i=this._scripts[t];if(i instanceof e)return i}return null}},{key:"getScripts",value:function(e){var t=null;if(this._scripts)for(var n=0,i=this._scripts.length;n<i;n++){var a=this._scripts[n];a instanceof e&&(t=t||[]).push(a)}return t}},{key:"cloneTo",value:function(e){var t=e;t.name=this.name,t.speed=this.speed,t.clipStart=this.clipStart,t.clipEnd=this.clipEnd,t.clip=this._clip}},{key:"clone",value:function(){var e=new AnimatorState;return this.cloneTo(e),e}},{key:"clip",get:function(){return this._clip},set:function(e){if(this._clip!==e){if(this._clip&&this._referenceCount>0&&this._clip._removeReference(this._referenceCount),e){var t=this._realtimeDatas,n=e._nodes,i=n.count;this._currentFrameIndices=new Int16Array(i),this._resetFrameIndices(),this._referenceCount>0&&e._addReference(this._referenceCount),this._realtimeDatas.length=i;for(var a=0;a<i;a++)switch(n.getNodeByIndex(a).type){case 0:break;case 1:case 3:case 4:t[a]=new o;break;case 2:t[a]=new u;break;default:throw"AnimationClipParser04:unknown type."}}this._clip=e}}}]),AnimatorState}(),q=function(){function KeyframeNodeOwner(){_classCallCheck(this,KeyframeNodeOwner),this.indexInList=-1,this.referenceCount=0,this.updateMark=-1,this.type=-1,this.fullPath=null,this.propertyOwner=null,this.property=null,this.defaultValue=null,this.value=null,this.crossFixedValue=null}return _createClass(KeyframeNodeOwner,[{key:"saveCrossFixedValue",value:function(){if(this.propertyOwner)switch(this.type){case 0:this.crossFixedValue=this.value;break;case 1:case 3:case 4:case 2:this.value.cloneTo(this.crossFixedValue);break;default:throw"Animator:unknown type."}}}]),KeyframeNodeOwner}(),K=function(e){function Animator(){var e;return _classCallCheck(this,Animator),(e=_possibleConstructorReturn(this,_getPrototypeOf(Animator).call(this)))._keyframeNodeOwners=[],e._linkAvatarSpritesData={},e._linkAvatarSprites=[],e._renderableSprites=[],e.cullingMode=Animator.CULLINGMODE_CULLCOMPLETELY,e._controllerLayers=[],e._linkSprites={},e._speed=1,e._keyframeNodeOwnerMap={},e._updateMark=0,e}return _inherits(Animator,t.Component),_createClass(Animator,[{key:"_linkToSprites",value:function(e){for(var t in e){for(var n=this.owner,i=e[t],a=0,r=i.length;a<r;a++){var o=i[a];if(""===o)break;if(!(n=n.getChildByName(o)))break}n&&this.linkSprite3DToAvatarNode(t,n)}}},{key:"_addKeyframeNodeOwner",value:function(e,t,n){var i=t._indexInList,a=t.fullPath,r=this._keyframeNodeOwnerMap[a];if(r)r.referenceCount++,e[i]=r;else{for(var o=n,s=0,l=t.propertyCount;s<l&&(o=o[t.getPropertyByIndex(s)]);s++);(r=this._keyframeNodeOwnerMap[a]=new q).fullPath=a,r.indexInList=this._keyframeNodeOwners.length,r.referenceCount=1,r.propertyOwner=n;var u=t.propertyCount,c=[];for(s=0;s<u;s++)c[s]=t.getPropertyByIndex(s);if(r.property=c,r.type=t.type,o)if(0===t.type)r.defaultValue=o;else{var h=new o.constructor;o.cloneTo(h),r.defaultValue=h,r.value=new o.constructor,r.crossFixedValue=new o.constructor}this._keyframeNodeOwners.push(r),e[i]=r}}},{key:"_removeKeyframeNodeOwner",value:function(e,t){var n=t.fullPath,i=this._keyframeNodeOwnerMap[n];i&&(i.referenceCount--,0===i.referenceCount&&(delete this._keyframeNodeOwnerMap[n],this._keyframeNodeOwners.splice(this._keyframeNodeOwners.indexOf(i),1)),e[t._indexInList]=null)}},{key:"_getOwnersByClip",value:function(e){var t=e._clip._nodes,n=t.count,i=e._nodeOwners;i.length=n;for(var a=0;a<n;a++){for(var r=t.getNodeByIndex(a),o=this._avatar?this._avatarNodeMap[this._avatar._rootNode.name]:this.owner,s=0,l=r.ownerPathCount;s<l;s++){var u=r.getOwnerPathByIndex(s);if(""===u)break;if(!(o=o.getChildByName(u)))break}if(o){var c=r.propertyOwner;c&&(o=o[c]),o&&this._addKeyframeNodeOwner(i,r,o)}}}},{key:"_updatePlayer",value:function(e,t,n,i){var a=e._clip._duration*(e.clipEnd-e.clipStart),r=t._elapsedTime,o=r+n;t._lastElapsedTime=r,t._elapsedTime=o;var s=o/a;t._normalizedTime=s;var l=s%1;t._normalizedPlayTime=l<0?l+1:l,t._duration=a;var u=e._scripts;if(!i&&o>=a){if(t._finish=!0,t._elapsedTime=a,t._normalizedPlayTime=1,u)for(var c=0,h=u.length;c<h;c++)u[c].onStateExit()}else if(u)for(c=0,h=u.length;c<h;c++)u[c].onStateUpdate()}},{key:"_eventScript",value:function(e,t,n,i,a){if(a)for(var r=t.length;n<r;n++){var o=t[n];if(!(o.time<=i))break;for(var s=0,l=e.length;s<l;s++){var u=e[s],c=u[o.eventName];c&&c.apply(u,o.params)}}else for(;n>=0&&(o=t[n]).time>=i;n--)for(s=0,l=e.length;s<l;s++)(c=(u=e[s])[o.eventName])&&c.apply(u,o.params);return n}},{key:"_updateEventScript",value:function(e,t){var n=this.owner._scripts;if(n){var i=e._clip,a=i._animationEvents,r=i._duration,o=t._elapsedTime,s=o%r,l=Math.abs(Math.floor(o/r)-Math.floor(t._lastElapsedTime/r)),u=t._elapsedTime>=t._lastElapsedTime;t._lastIsFront!==u&&(u?t._playEventIndex++:t._playEventIndex--,t._lastIsFront=u);var c=t._playEventIndex;if(u){var h=this._eventScript(n,a,t._playEventIndex,l>0?r:s,!0);c===t._playEventIndex&&(t._playEventIndex=h);for(var _=0,d=l-1;_<d;_++)this._eventScript(n,a,0,r,!0);l>0&&s>0&&(t._playEventIndex=this._eventScript(n,a,0,s,!0))}else{h=this._eventScript(n,a,t._playEventIndex,l>0?0:s,!1);c===t._playEventIndex&&(t._playEventIndex=h);var f=a.length-1;for(_=0,d=l-1;_<d;_++)this._eventScript(n,a,f,0,!1);l>0&&s>0&&(t._playEventIndex=this._eventScript(n,a,f,s,!1))}}}},{key:"_updateClipDatas",value:function(e,t,n){var i=e._clip,a=i._duration,r=e.clipStart*a+n._normalizedPlayTime*n._duration,o=e._currentFrameIndices,s=n._elapsedTime>n._lastElapsedTime;i._evaluateClipDatasRealTime(i._nodes,r,o,t,s,e._realtimeDatas)}},{key:"_applyFloat",value:function(e,t,n,i,a,r,o){if(n.updateMark===this._updateMark)if(i)e[t]+=a*o;else{var s=e[t];e[t]=s+a*(o-s)}else if(r)e[t]=i?n.defaultValue+o:o;else if(i)e[t]=n.defaultValue+a*o;else{var l=n.defaultValue;e[t]=l+a*(o-l)}}},{key:"_applyPositionAndRotationEuler",value:function(e,t,n,i,a,r){if(e.updateMark===this._updateMark)if(t)r.x+=n*a.x,r.y+=n*a.y,r.z+=n*a.z;else{var o=r.x,s=r.y,l=r.z;r.x=o+n*(a.x-o),r.y=s+n*(a.y-s),r.z=l+n*(a.z-l)}else if(i)if(t){var u=e.defaultValue;r.x=u.x+a.x,r.y=u.y+a.y,r.z=u.z+a.z}else r.x=a.x,r.y=a.y,r.z=a.z;else if(u=e.defaultValue,t)r.x=u.x+n*a.x,r.y=u.y+n*a.y,r.z=u.z+n*a.z;else{var c=u.x,h=u.y,_=u.z;r.x=c+n*(a.x-c),r.y=h+n*(a.y-h),r.z=_+n*(a.z-_)}}},{key:"_applyRotation",value:function(e,t,n,i,a,r){if(e.updateMark===this._updateMark)if(t){var o=Animator._tempQuaternion1;P.quaternionWeight(a,n,o),o.normalize(o),u.multiply(r,o,r)}else u.lerp(r,a,n,r);else if(i)if(t){var s=e.defaultValue;u.multiply(s,a,r)}else r.x=a.x,r.y=a.y,r.z=a.z,r.w=a.w;else s=e.defaultValue,t?(o=Animator._tempQuaternion1,P.quaternionWeight(a,n,o),o.normalize(o),u.multiply(s,o,r)):u.lerp(s,a,n,r)}},{key:"_applyScale",value:function(e,t,n,i,a,r){if(e.updateMark===this._updateMark)if(t){var o=Animator._tempVector31;P.scaleWeight(a,n,o),r.x=r.x*o.x,r.y=r.y*o.y,r.z=r.z*o.z}else P.scaleBlend(r,a,n,r);else if(i)if(t){var s=e.defaultValue;r.x=s.x*a.x,r.y=s.y*a.y,r.z=s.z*a.z}else r.x=a.x,r.y=a.y,r.z=a.z;else s=e.defaultValue,t?(o=Animator._tempVector31,P.scaleWeight(a,n,o),r.x=s.x*o.x,r.y=s.y*o.y,r.z=s.z*o.z):P.scaleBlend(s,a,n,r)}},{key:"_applyCrossData",value:function(e,t,n,i,a,r,o){var s=e.propertyOwner;if(s){switch(e.type){case 0:for(var l=e.property,c=l.length-1,h=0;h<c&&(s=s[l[h]]);h++);var _=a+o*(r-a);e.value=_,s&&this._applyFloat(s,l[c],e,t,n,i,_);break;case 1:var d=s.localPosition,f=e.value,m=a.x,p=a.y,T=a.z;f.x=m+o*(r.x-m),f.y=p+o*(r.y-p),f.z=T+o*(r.z-T),this._applyPositionAndRotationEuler(e,t,n,i,f,d),s.localPosition=d;break;case 2:var v=s.localRotation,g=e.value;u.lerp(a,r,o,g),this._applyRotation(e,t,n,i,g,v),s.localRotation=v;break;case 3:var E=s.localScale,y=e.value;P.scaleBlend(a,r,o,y),this._applyScale(e,t,n,i,y,E),s.localScale=E;break;case 4:var S=s.localRotationEuler,R=e.value;m=a.x,p=a.y,T=a.z,R.x=m+o*(r.x-m),R.y=p+o*(r.y-p),R.z=T+o*(r.z-T),this._applyPositionAndRotationEuler(e,t,n,i,R,S),s.localRotationEuler=S}e.updateMark=this._updateMark}}},{key:"_setClipDatasToNode",value:function(e,t,n,i){for(var a=e._realtimeDatas,r=e._clip._nodes,o=e._nodeOwners,s=0,l=r.count;s<l;s++){var u=o[s];if(u){var c=u.propertyOwner;if(c){switch(u.type){case 0:for(var h=u.property,_=h.length-1,d=0;d<_&&(c=c[h[d]]);d++);c&&this._applyFloat(c,h[_],u,t,n,i,a[s]);break;case 1:var f=c.localPosition;this._applyPositionAndRotationEuler(u,t,n,i,a[s],f),c.localPosition=f;break;case 2:var m=c.localRotation;this._applyRotation(u,t,n,i,a[s],m),c.localRotation=m;break;case 3:var p=c.localScale;this._applyScale(u,t,n,i,a[s],p),c.localScale=p;break;case 4:var T=c.localRotationEuler;this._applyPositionAndRotationEuler(u,t,n,i,a[s],T),c.localRotationEuler=T}u.updateMark=this._updateMark}}}}},{key:"_setCrossClipDatasToNode",value:function(e,t,n,i,a){for(var r=e._crossNodesOwners,o=e._crossNodesOwnersCount,s=e.blendingMode!==Z.BLENDINGMODE_OVERRIDE,l=e.defaultWeight,u=n._realtimeDatas,c=e._destCrossClipNodeIndices,h=n._nodeOwners,_=t._realtimeDatas,d=e._srcCrossClipNodeIndices,f=t._nodeOwners,m=0;m<o;m++){var p=r[m];if(p){var T=d[m],v=c[m],g=-1!==T?_[T]:h[v].defaultValue,E=-1!==v?u[v]:f[T].defaultValue;this._applyCrossData(p,s,l,a,g,E,i)}}}},{key:"_setFixedCrossClipDatasToNode",value:function(e,t,n,i){for(var a=e._crossNodesOwners,r=e._crossNodesOwnersCount,o=e.blendingMode!==Z.BLENDINGMODE_OVERRIDE,s=e.defaultWeight,l=t._realtimeDatas,u=e._destCrossClipNodeIndices,c=0;c<r;c++){var h=a[c];if(h){var _=u[c],d=h.crossFixedValue,f=-1!==_?l[_]:h.defaultValue;this._applyCrossData(h,o,s,i,d,f,n)}}}},{key:"_revertDefaultKeyframeNodes",value:function(e){for(var t=e._nodeOwners,n=0,i=t.length;n<i;n++){var a=t[n];if(a){var r=a.propertyOwner;if(r)switch(a.type){case 0:for(var o=a.property,s=o.length-1,l=0;l<s&&(r=r[o[l]]);l++);r[o[s]]=a.defaultValue;break;case 1:var u=r.localPosition,c=a.defaultValue;u.x=c.x,u.y=c.y,u.z=c.z,r.localPosition=u;break;case 2:var h=r.localRotation,_=a.defaultValue;h.x=_.x,h.y=_.y,h.z=_.z,h.w=_.w,r.localRotation=h;break;case 3:var d=r.localScale;c=a.defaultValue,d.x=c.x,d.y=c.y,d.z=c.z,r.localScale=d;break;case 4:var f=r.localRotationEuler;c=a.defaultValue,f.x=c.x,f.y=c.y,f.z=c.z,r.localRotationEuler=f;break;default:throw"Animator:unknown type."}}}}},{key:"_onAdded",value:function(){var e=this.owner._parent;this.owner._setHierarchyAnimator(this,e?e._hierarchyAnimator:null),this.owner._changeAnimatorToLinkSprite3DNoAvatar(this,!0,[])}},{key:"_onDestroy",value:function(){for(var e=0,t=this._controllerLayers.length;e<t;e++)this._controllerLayers[e]._removeReference();var n=this.owner._parent;this.owner._clearHierarchyAnimator(this,n?n._hierarchyAnimator:null)}},{key:"_onEnable",value:function(){this.owner._scene._animatorPool.add(this);for(var e=0,t=this._controllerLayers.length;e<t;e++){if(this._controllerLayers[e].playOnWake)this.getDefaultState(e)&&this.play(null,e,0)}}},{key:"_onDisable",value:function(){this.owner._scene._animatorPool.remove(this)}},{key:"_handleSpriteOwnersBySprite",value:function(e,t,n){for(var i=0,a=this._controllerLayers.length;i<a;i++)for(var r=this._controllerLayers[i]._states,o=0,s=r.length;o<s;o++){var l=r[o],u=l._clip,c=t.join("/"),h=u._nodesMap[c];if(h)for(var _=l._nodeOwners,d=0,f=h.length;d<f;d++)e?this._addKeyframeNodeOwner(_,h[d],n):this._removeKeyframeNodeOwner(_,h[d])}}},{key:"_parse",value:function(e){var n=e.avatar;if(n){this.avatar=t.Loader.getRes(n.path);var i=n.linkSprites;this._linkSprites=i,this._linkToSprites(i)}for(var a=e.playOnWake,r=e.layers,o=0;o<r.length;o++){var s=r[o],l=new Z(s.name);l.defaultWeight=0===o?1:s.weight;var u=s.blendingMode;u&&(l.blendingMode=u),this.addControllerLayer(l);for(var c=s.states,h=0,_=c.length;h<_;h++){var d=c[h],f=d.clipPath;if(f){var m,p=d.name;if(m=t.Loader.getRes(f)){var T=new Q;T.name=p,T.clip=m,l.addState(T),0===h&&(this.getControllerLayer(o).defaultState=T)}}}void 0!==a&&(l.playOnWake=a)}var v=e.cullingMode;void 0!==v&&(this.cullingMode=v)}},{key:"_update",value:function(){var e=this.owner._scene.timer._delta/1e3;if(0!==this._speed&&0!==e){var t;if(this.cullingMode===Animator.CULLINGMODE_CULLCOMPLETELY){t=!1;for(var n=0,i=this._renderableSprites.length;n<i;n++)if(this._renderableSprites[n]._render.isRender){t=!0;break}}else t=!0;for(this._updateMark++,n=0,i=this._controllerLayers.length;n<i;n++){var a=this._controllerLayers[n],r=a._playStateInfo,o=a._crossPlayStateInfo;switch(h=a.blendingMode!==Z.BLENDINGMODE_OVERRIDE,a._playType){case 0:var s=r._currentState,l=s._clip,u=this._speed*s.speed,c=r._finish;if(c||this._updatePlayer(s,r,e*u,l.islooping),t){var h=a.blendingMode!==Z.BLENDINGMODE_OVERRIDE;this._updateClipDatas(s,h,r),this._setClipDatasToNode(s,h,a.defaultWeight,0===n),c||this._updateEventScript(s,r)}break;case 1:l=(s=r._currentState)._clip;var _=a._crossPlayState,d=_._clip,f=a._crossDuration,m=o._startPlayTime,p=d._duration-m,T=f>p?p/f:1,v=this._speed*_.speed;this._updatePlayer(_,o,e*T*v,d.islooping);var g=(o._elapsedTime-m)/T/f;g>=1?t&&(this._updateClipDatas(_,h,o),this._setClipDatasToNode(_,h,a.defaultWeight,0===n),a._playType=0,r._currentState=_,o._cloneTo(r)):(r._finish||(u=this._speed*s.speed,this._updatePlayer(s,r,e*u,l.islooping),t&&this._updateClipDatas(s,h,r)),t&&(this._updateClipDatas(_,h,o),this._setCrossClipDatasToNode(a,s,_,g,0===n))),t&&(this._updateEventScript(s,r),this._updateEventScript(_,o));break;case 2:d=(_=a._crossPlayState)._clip,f=a._crossDuration,m=o._startPlayTime,T=f>(p=d._duration-m)?p/f:1,v=this._speed*_.speed,this._updatePlayer(_,o,e*T*v,d.islooping),t&&((g=(o._elapsedTime-m)/T/f)>=1?(this._updateClipDatas(_,h,o),this._setClipDatasToNode(_,h,1,0===n),a._playType=0,r._currentState=_,o._cloneTo(r)):(this._updateClipDatas(_,h,o),this._setFixedCrossClipDatasToNode(a,_,g,0===n)),this._updateEventScript(_,o))}}t&&this._avatar&&this._updateAvatarNodesToSprite()}}},{key:"_cloneTo",value:function(e){var t=e;t.avatar=this.avatar,t.cullingMode=this.cullingMode;for(var n=0,i=this._controllerLayers.length;n<i;n++){var a=this._controllerLayers[n];t.addControllerLayer(a.clone());for(var r=a._states,o=0,s=r.length;o<s;o++){var l=r[o].clone(),u=t.getControllerLayer(n);u.addState(l),0==o&&(u.defaultState=l)}}t._linkSprites=this._linkSprites,t._linkToSprites(this._linkSprites)}},{key:"getDefaultState",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return this._controllerLayers[e].defaultState}},{key:"addState",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;this._controllerLayers[t].addState(e),console.warn("Animator:this function is discard,please use animatorControllerLayer.addState() instead.")}},{key:"removeState",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;this._controllerLayers[t].removeState(e),console.warn("Animator:this function is discard,please use animatorControllerLayer.removeState() instead.")}},{key:"addControllerLayer",value:function(e){this._controllerLayers.push(e),e._animator=this,e._addReference();for(var t=e._states,n=0,i=t.length;n<i;n++)this._getOwnersByClip(t[n])}},{key:"getControllerLayer",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return this._controllerLayers[e]}},{key:"play",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Number.NEGATIVE_INFINITY,i=this._controllerLayers[t];if(i){var a=i.defaultState;if(!e&&!a)throw new Error("Animator:must have default clip value,please set clip property.");var r=i._playStateInfo,o=r._currentState,s=e?i._statesMap[e]:a,l=s._clip._duration,u=s._clip._duration*(s.clipEnd-s.clipStart);o!==s?(n!==Number.NEGATIVE_INFINITY?r._resetPlayState(l*n,u):r._resetPlayState(0,u),null!==o&&o!==s&&this._revertDefaultKeyframeNodes(o),i._playType=0,r._currentState=s):n!==Number.NEGATIVE_INFINITY&&(r._resetPlayState(l*n,u),i._playType=0);var c=s._scripts;if(c)for(var h=0,_=c.length;h<_;h++)c[h].onStateEnter()}else console.warn("Invalid layerIndex "+t+".")}},{key:"crossFade",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:Number.NEGATIVE_INFINITY,a=this._controllerLayers[n];if(a){var r=a._statesMap[e];if(r){var o=a._playType;if(-1===o)return void this.play(e,n,i);var s=a._crossPlayStateInfo,l=a._crossNodesOwners,u=a._crossNodesOwnersIndicesMap,c=a._playStateInfo._currentState,h=r._nodeOwners,_=a._destCrossClipNodeIndices,d=r._clip,f=d._nodes,m=d._nodesDic,p=0;switch(o){case 0:var T=c._nodeOwners,v=a._srcCrossClipNodeIndices,g=c._clip,E=g._nodes,y=g._nodesDic;a._playType=1;var S=++a._crossMark;p=a._crossNodesOwnersCount=0;for(var R=0,C=E.count;R<C;R++){var M=E.getNodeByIndex(R),D=M._indexInList,x=T[D];if(x){var A=M.fullPath;v[p]=D;var I=m[A];_[p]=I?I._indexInList:-1,u[A]=S,l[p]=x,p++}}for(R=0,C=f.count;R<C;R++){var L=(I=f.getNodeByIndex(R))._indexInList,P=h[L];if(P){var O=I.fullPath;y[O]||(v[p]=-1,_[p]=L,u[O]=S,l[p]=P,p++)}}break;case 1:case 2:for(a._playType=2,R=0,C=l.length;R<C;R++){var N=l[R];N.saveCrossFixedValue(),I=m[N.fullPath],_[R]=I?I._indexInList:-1}for(p=a._crossNodesOwnersCount,S=a._crossMark,R=0,C=f.count;R<C;R++)(P=h[L=(I=f.getNodeByIndex(R))._indexInList])&&u[O=I.fullPath]!==S&&(_[p]=L,u[O]=S,N=h[L],l[p]=N,N.saveCrossFixedValue(),p++)}a._crossNodesOwnersCount=p,a._crossPlayState=r,a._crossDuration=c._clip._duration*t,i!==Number.NEGATIVE_INFINITY?s._resetPlayState(d._duration*i,a._crossDuration):s._resetPlayState(0,a._crossDuration);var b=r._scripts;if(b)for(R=0,C=b.length;R<C;R++)b[R].onStateEnter()}else console.warn("Invalid name "+n+".")}else console.warn("Invalid layerIndex "+n+".")}},{key:"getCurrentAnimatorPlayState",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return this._controllerLayers[e]._playStateInfo}},{key:"_isLinkSpriteToAnimationNodeData",value:function(e,t,n){var i=this._linkAvatarSpritesData[t];if(n)i||(this._linkAvatarSpritesData[t]=i=[]),i.push(e);else{var a=i.indexOf(e);i.splice(a,1)}}},{key:"_getAvatarOwnersAndInitDatasAsync",value:function(){for(var e=0,t=this._controllerLayers.length;e<t;e++)for(var n=this._controllerLayers[e]._states,i=0,a=n.length;i<a;i++)this._getOwnersByClip(n[i]);for(var r in this._avatar._cloneDatasToAnimator(this),this._linkAvatarSpritesData){var o=this._linkAvatarSpritesData[r];if(o)for(var s=0,l=o.length;s<l;s++)this._isLinkSpriteToAnimationNode(o[s],r,!0)}}},{key:"_isLinkSpriteToAnimationNode",value:function(e,t,n){if(this._avatar){var i=this._avatarNodeMap[t];if(i)if(n){e._transform._dummy=i.transform,this._linkAvatarSprites.push(e);var a=i.transform,r=e.transform;if(!r.owner.isStatic&&a){var o=r.worldMatrix,s=this.owner._transform._parent;if(s)P.matrix4x4MultiplyMFM(s.worldMatrix,a.getWorldMatrix(),o);else for(var l=o.elements,u=a.getWorldMatrix(),c=0;c<16;c++)l[c]=u[c];r.worldMatrix=o}}else e._transform._dummy=null,this._linkAvatarSprites.splice(this._linkAvatarSprites.indexOf(e),1)}}},{key:"_updateAvatarNodesToSprite",value:function(){for(var e=0,t=this._linkAvatarSprites.length;e<t;e++){var n=this._linkAvatarSprites[e],i=n.transform._dummy,a=n.transform;if(!a.owner.isStatic&&i){var r=a.worldMatrix,o=this.owner._transform;P.matrix4x4MultiplyMFM(o.worldMatrix,i.getWorldMatrix(),r),a.worldMatrix=r}}}},{key:"linkSprite3DToAvatarNode",value:function(e,t){return this._isLinkSpriteToAnimationNodeData(t,e,!0),this._isLinkSpriteToAnimationNode(t,e,!0),!0}},{key:"unLinkSprite3DToAvatarNode",value:function(e){var t=e.transform._dummy;if(t){var n=t._owner.name;return this._isLinkSpriteToAnimationNodeData(e,n,!1),this._isLinkSpriteToAnimationNode(e,n,!1),!0}return!1}},{key:"_updateAnimationNodeWorldMatix",value:function(e,n,i,a,r){t.LayaGL.instance.updateAnimationNodeWorldMatix(e,n,i,r,a)}},{key:"speed",get:function(){return this._speed},set:function(e){this._speed=e}},{key:"avatar",get:function(){return this._avatar},set:function(e){if(this._avatar!==e)if(this._avatar=e,e)this._getAvatarOwnersAndInitDatasAsync(),this.owner._changeHierarchyAnimatorAvatar(this,e);else{var t=this.owner._parent;this.owner._changeHierarchyAnimatorAvatar(this,t?t._hierarchyAnimator._avatar:null)}}}],[{key:"_update",value:function(e){for(var t=e._animatorPool,n=t.elements,i=0,a=t.length;i<a;i++){var r=n[i];r&&r.enabled&&r._update()}}}]),Animator}();K._tempVector31=new o,K._tempQuaternion1=new u,K.CULLINGMODE_ALWAYSANIMATE=0,K.CULLINGMODE_CULLCOMPLETELY=2;var J=function RenderContext3D(){_classCallCheck(this,RenderContext3D),this.invertY=!1,this.configPipeLineMode="Forward"};J._instance=new J;var $=function(e){function RenderTexture(e,n){var i,a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:t.RenderTextureFormat.R8G8B8,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:t.RenderTextureDepthFormat.DEPTH_16;return _classCallCheck(this,RenderTexture),(i=_possibleConstructorReturn(this,_getPrototypeOf(RenderTexture).call(this,a,!1)))._inPool=!1,i._isCameraTarget=!1,i._glTextureType=t.LayaGL.instance.TEXTURE_2D,i._width=e,i._height=n,i._depthStencilFormat=r,i._mipmapCount=1,i._create(e,n),i}return _inherits(RenderTexture,t.BaseTexture),_createClass(RenderTexture,[{key:"_create",value:function(e,n){var i=t.LayaGL.instance,a=i,r=this._glTextureType,o=t.LayaGL.layaGPUInstance,s=o._isWebGL2,l=this._format;if(this._frameBuffer=i.createFramebuffer(),i.bindFramebuffer(i.FRAMEBUFFER,this._frameBuffer),l!==t.RenderTextureFormat.Depth&&l!==t.RenderTextureFormat.ShadowMap){switch(t.WebGLContext.bindTexture(i,r,this._glTexture),l){case t.RenderTextureFormat.R8G8B8:s?a.texStorage2D(r,this._mipmapCount,a.RGB8,e,n):i.texImage2D(r,0,i.RGB,e,n,0,i.RGB,i.UNSIGNED_BYTE,null);break;case t.RenderTextureFormat.R8G8B8A8:s?a.texStorage2D(r,this._mipmapCount,a.RGBA8,e,n):i.texImage2D(r,0,i.RGBA,e,n,0,i.RGBA,i.UNSIGNED_BYTE,null);break;case t.RenderTextureFormat.Alpha8:s?a.texStorage2D(r,0,a.R8,e,n):i.texImage2D(r,0,i.ALPHA,e,n,0,i.ALPHA,i.UNSIGNED_BYTE,null);break;case t.RenderTextureFormat.R16G16B16A16:s?a.texStorage2D(r,this._mipmapCount,a.RGBA16F,e,n):i.texImage2D(r,0,i.RGBA,e,n,0,i.RGBA,o._oesTextureHalfFloat.HALF_FLOAT_OES,null)}i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,i.TEXTURE_2D,this._glTexture,0)}if(l==t.RenderTextureFormat.Depth||l==t.RenderTextureFormat.ShadowMap){switch(t.WebGLContext.bindTexture(i,r,this._glTexture),this._depthStencilFormat){case t.RenderTextureDepthFormat.DEPTH_16:s?a.texStorage2D(r,this._mipmapCount,a.DEPTH_COMPONENT16,e,n):i.texImage2D(r,0,i.DEPTH_COMPONENT,e,n,0,i.DEPTH_COMPONENT,i.UNSIGNED_SHORT,null),i.framebufferTexture2D(i.FRAMEBUFFER,i.DEPTH_ATTACHMENT,i.TEXTURE_2D,this._glTexture,0);break;case t.RenderTextureDepthFormat.DEPTHSTENCIL_24_8:s?a.texStorage2D(r,this._mipmapCount,a.DEPTH24_STENCIL8,e,n):i.texImage2D(r,0,i.DEPTH_STENCIL,e,n,0,i.DEPTH_STENCIL,o._webgl_depth_texture.UNSIGNED_INT_24_8_WEBGL,null),i.framebufferTexture2D(i.FRAMEBUFFER,i.DEPTH_STENCIL_ATTACHMENT,i.TEXTURE_2D,this._glTexture,0);break;default:throw"RenderTexture: depth format RenderTexture must use depthFormat with DEPTH_16 and DEPTHSTENCIL_16_8."}s&&l==t.RenderTextureFormat.ShadowMap&&a.texParameteri(r,a.TEXTURE_COMPARE_MODE,a.COMPARE_REF_TO_TEXTURE)}else if(this._depthStencilFormat!==t.RenderTextureDepthFormat.DEPTHSTENCIL_NONE){switch(this._depthStencilBuffer=i.createRenderbuffer(),i.bindRenderbuffer(i.RENDERBUFFER,this._depthStencilBuffer),this._depthStencilFormat){case t.RenderTextureDepthFormat.DEPTH_16:i.renderbufferStorage(i.RENDERBUFFER,i.DEPTH_COMPONENT16,e,n),i.framebufferRenderbuffer(i.FRAMEBUFFER,i.DEPTH_ATTACHMENT,i.RENDERBUFFER,this._depthStencilBuffer);break;case t.RenderTextureDepthFormat.STENCIL_8:i.renderbufferStorage(i.RENDERBUFFER,i.STENCIL_INDEX8,e,n),i.framebufferRenderbuffer(i.FRAMEBUFFER,i.STENCIL_ATTACHMENT,i.RENDERBUFFER,this._depthStencilBuffer);break;case t.RenderTextureDepthFormat.DEPTHSTENCIL_24_8:i.renderbufferStorage(i.RENDERBUFFER,i.DEPTH_STENCIL,e,n),i.framebufferRenderbuffer(i.FRAMEBUFFER,i.DEPTH_STENCIL_ATTACHMENT,i.RENDERBUFFER,this._depthStencilBuffer);break;default:throw"RenderTexture: unkonw depth format."}i.bindRenderbuffer(i.RENDERBUFFER,null)}i.bindFramebuffer(i.FRAMEBUFFER,null),this._setWarpMode(i.TEXTURE_WRAP_S,this._wrapModeU),this._setWarpMode(i.TEXTURE_WRAP_T,this._wrapModeV),this._setFilterMode(this._filterMode),this._setAnisotropy(this._anisoLevel),this._readyed=!0,this._activeResource(),this._setGPUMemory(e*n*4)}},{key:"_start",value:function(){var e=t.LayaGL.instance;e.bindFramebuffer(e.FRAMEBUFFER,this._frameBuffer),RenderTexture._currentActive=this,this._isCameraTarget&&(J._instance.invertY=!0),this._readyed=!1}},{key:"_end",value:function(){var e=t.LayaGL.instance;e.bindFramebuffer(e.FRAMEBUFFER,null),RenderTexture._currentActive=null,this._isCameraTarget&&(J._instance.invertY=!1),this._readyed=!0}},{key:"getData",value:function(e,n,i,a,r){if(t.Render.isConchApp&&2==window.conchConfig.threadMode)throw"native 2 thread mode use getDataAsync";var o=t.LayaGL.instance;return o.bindFramebuffer(o.FRAMEBUFFER,this._frameBuffer),o.checkFramebufferStatus(o.FRAMEBUFFER)===o.FRAMEBUFFER_COMPLETE?(o.readPixels(e,n,i,a,o.RGBA,o.UNSIGNED_BYTE,r),o.bindFramebuffer(o.FRAMEBUFFER,null),r):(o.bindFramebuffer(o.FRAMEBUFFER,null),null)}},{key:"_disposeResource",value:function(){if(this._frameBuffer){var e=t.LayaGL.instance;e.deleteTexture(this._glTexture),e.deleteFramebuffer(this._frameBuffer),e.deleteRenderbuffer(this._depthStencilBuffer),this._glTexture=null,this._frameBuffer=null,this._depthStencilBuffer=null,this._setGPUMemory(0)}}},{key:"getDataAsync",value:function(e,n,i,a,r){var o=t.LayaGL.instance;o.bindFramebuffer(o.FRAMEBUFFER,this._frameBuffer),o.readPixelsAsync(e,n,i,a,o.RGBA,o.UNSIGNED_BYTE,function(e){r(new Uint8Array(e))}),o.bindFramebuffer(o.FRAMEBUFFER,null)}},{key:"depthStencilFormat",get:function(){return this._depthStencilFormat}},{key:"defaulteTexture",get:function(){return t.Texture2D.grayTexture}}],[{key:"createFromPool",value:function(e,n){for(var i,a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:t.RenderTextureFormat.R8G8B8,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:t.RenderTextureDepthFormat.DEPTH_16,o=0,s=RenderTexture._pool.length;o<s;o++)if((i=RenderTexture._pool[o])._width==e&&i._height==n&&i._format==a&&i._depthStencilFormat==r){i._inPool=!1;var l=RenderTexture._pool[s-1];return RenderTexture._pool[o]=l,RenderTexture._pool.length-=1,i}return(i=new RenderTexture(e,n,a,r)).lock=!0,i}},{key:"recoverToPool",value:function(e){e._inPool||(RenderTexture._pool.push(e),e._inPool=!0)}},{key:"currentActive",get:function(){return RenderTexture._currentActive}}]),RenderTexture}();$._pool=[];var ee=function(){function DefineDatas(){_classCallCheck(this,DefineDatas),this._mask=[],this._length=0}return _createClass(DefineDatas,[{key:"_intersectionDefineDatas",value:function(e){for(var t=e._mask,n=this._mask,i=this._length-1;i>=0;i--){var a=n[i]&t[i];0==a&&i==this._length-1?this._length--:n[i]=a}}},{key:"add",value:function(e){var t=e._index,n=t+1,i=this._mask,a=this._length;if(a<n){for(i.length<n&&(i.length=n);a<t;a++)i[a]=0;i[t]=e._value,this._length=n}else i[t]|=e._value}},{key:"remove",value:function(e){var t=e._index,n=this._mask,i=this._length-1;if(!(t>i)){var a=n[t]&~e._value;t==i&&0===a?this._length--:n[t]=a}}},{key:"addDefineDatas",value:function(e){var t=e._mask,n=e._length,i=this._mask,a=this._length;if(a<n){i.length=n;for(var r=0;r<a;r++)i[r]|=t[r];for(;r<n;r++)i[r]=t[r];this._length=n}else for(r=0;r<n;r++)i[r]|=t[r]}},{key:"removeDefineDatas",value:function(e){for(var t=e._mask,n=this._mask,i=this._length-1,a=Math.min(e._length,i);a>=0;a--){var r=n[a]&~t[a];a==i&&0===r?(i--,this._length--):n[a]=r}}},{key:"has",value:function(e){var t=e._index;return!(t>=this._length)&&0!=(this._mask[t]&e._value)}},{key:"clear",value:function(){this._length=0}},{key:"cloneTo",value:function(e){var t=e,n=t._mask,i=this._mask,a=this._length;n.length=a;for(var r=0;r<a;r++)n[r]=i[r];t._length=a}},{key:"clone",value:function(){var e=new DefineDatas;return this.cloneTo(e),e}}]),DefineDatas}(),te=function(e){function VertexBuffer3D(e,n){var i,a=arguments.length>2&&void 0!==arguments[2]&&arguments[2];_classCallCheck(this,VertexBuffer3D),(i=_possibleConstructorReturn(this,_getPrototypeOf(VertexBuffer3D).call(this)))._vertexDeclaration=null,i._float32Reader=null;var r=t.LayaGL.instance;return i._bufferUsage=n,i._bufferType=r.ARRAY_BUFFER,i._canRead=a,i._byteLength=e,i.bind(),r.bufferData(i._bufferType,i._byteLength,i._bufferUsage),a&&(i._buffer=new Uint8Array(e),i._float32Reader=new Float32Array(i._buffer.buffer)),i}return _inherits(VertexBuffer3D,t.Buffer),_createClass(VertexBuffer3D,[{key:"bind",value:function(){if(t.Buffer._bindedVertexBuffer!==this._glBuffer){var e=t.LayaGL.instance;return e.bindBuffer(e.ARRAY_BUFFER,this._glBuffer),t.Buffer._bindedVertexBuffer=this._glBuffer,!0}return!1}},{key:"orphanStorage",value:function(){this.bind(),t.LayaGL.instance.bufferData(this._bufferType,this._byteLength,this._bufferUsage)}},{key:"setData",value:function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:Number.MAX_SAFE_INTEGER;if(this.bind(),0!==i||a!==Number.MAX_SAFE_INTEGER){var r=new Uint8Array(e,i,a);t.LayaGL.instance.bufferSubData(this._bufferType,n,r),this._canRead&&this._buffer.set(r,n)}else t.LayaGL.instance.bufferSubData(this._bufferType,n,e),this._canRead&&this._buffer.set(new Uint8Array(e),n)}},{key:"getUint8Data",value:function(){if(this._canRead)return this._buffer;throw new Error("Can't read data from VertexBuffer with only write flag!")}},{key:"getFloat32Data",value:function(){if(this._canRead)return this._float32Reader;throw new Error("Can't read data from VertexBuffer with only write flag!")}},{key:"markAsUnreadbale",value:function(){this._canRead=!1,this._buffer=null,this._float32Reader=null}},{key:"destroy",value:function(){_get(_getPrototypeOf(VertexBuffer3D.prototype),"destroy",this).call(this),this._buffer=null,this._float32Reader=null,this._vertexDeclaration=null,this._byteLength=0}},{key:"vertexDeclaration",get:function(){return this._vertexDeclaration},set:function(e){this._vertexDeclaration=e}},{key:"canRead",get:function(){return this._canRead}}]),VertexBuffer3D}();te.DATATYPE_FLOAT32ARRAY=0,te.DATATYPE_UINT8ARRAY=1;var ne=function(){function VertexElementFormat(){_classCallCheck(this,VertexElementFormat)}return _createClass(VertexElementFormat,null,[{key:"__init__",value:function(){var e=t.LayaGL.instance;VertexElementFormat._elementInfos={single:[1,e.FLOAT,0],vector2:[2,e.FLOAT,0],vector3:[3,e.FLOAT,0],vector4:[4,e.FLOAT,0],color:[4,e.FLOAT,0],byte4:[4,e.UNSIGNED_BYTE,0],short2:[2,e.FLOAT,0],short4:[4,e.FLOAT,0],normalizedshort2:[2,e.FLOAT,0],normalizedshort4:[4,e.FLOAT,0],halfvector2:[2,e.FLOAT,0],halfvector4:[4,e.FLOAT,0]}}},{key:"getElementInfos",value:function(e){var t=VertexElementFormat._elementInfos[e];if(t)return t;throw"VertexElementFormat: this vertexElementFormat is not implement."}}]),VertexElementFormat}();ne.Single="single",ne.Vector2="vector2",ne.Vector3="vector3",ne.Vector4="vector4",ne.Color="color",ne.Byte4="byte4",ne.Short2="short2",ne.Short4="short4",ne.NormalizedShort2="normalizedshort2",ne.NormalizedShort4="normalizedshort4",ne.HalfVector2="halfvector2",ne.HalfVector4="halfvector4";var ie=function(){function ShaderData(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;_classCallCheck(this,ShaderData),this._ownerResource=null,this._data=null,this._defineDatas=new ee,this._runtimeCopyValues=[],this._ownerResource=e,this._initData()}return _createClass(ShaderData,[{key:"_initData",value:function(){this._data={}}},{key:"getData",value:function(){return this._data}},{key:"addDefine",value:function(e){this._defineDatas.add(e)}},{key:"removeDefine",value:function(e){this._defineDatas.remove(e)}},{key:"hasDefine",value:function(e){return this._defineDatas.has(e)}},{key:"clearDefine",value:function(){this._defineDatas.clear()}},{key:"getBool",value:function(e){return this._data[e]}},{key:"setBool",value:function(e,t){this._data[e]=t}},{key:"getInt",value:function(e){return this._data[e]}},{key:"setInt",value:function(e,t){this._data[e]=t}},{key:"getNumber",value:function(e){return this._data[e]}},{key:"setNumber",value:function(e,t){this._data[e]=t}},{key:"getVector2",value:function(e){return this._data[e]}},{key:"setVector2",value:function(e,t){this._data[e]=t}},{key:"getVector3",value:function(e){return this._data[e]}},{key:"setVector3",value:function(e,t){this._data[e]=t}},{key:"getVector",value:function(e){return this._data[e]}},{key:"setVector",value:function(e,t){this._data[e]=t}},{key:"getQuaternion",value:function(e){return this._data[e]}},{key:"setQuaternion",value:function(e,t){this._data[e]=t}},{key:"getMatrix4x4",value:function(e){return this._data[e]}},{key:"setMatrix4x4",value:function(e,t){this._data[e]=t}},{key:"getBuffer",value:function(e){return this._data[e]}},{key:"setBuffer",value:function(e,t){this._data[e]=t}},{key:"setTexture",value:function(e,t){var n=this._data[e];this._data[e]=t,this._ownerResource&&this._ownerResource.referenceCount>0&&(n&&n._removeReference(),t&&t._addReference())}},{key:"getTexture",value:function(e){return this._data[e]}},{key:"setAttribute",value:function(e,t){this._data[e]=t}},{key:"getAttribute",value:function(e){return this._data[e]}},{key:"getLength",value:function(){return this._data.length}},{key:"setLength",value:function(e){this._data.length=e}},{key:"cloneTo",value:function(e){var n=e,r=n._data;for(var s in this._data){var l=this._data[s];if(null!=l)if("number"==typeof l)r[s]=l;else if("number"==typeof l)r[s]=l;else if("boolean"==typeof l)r[s]=l;else if(l instanceof i){var u=r[s]||(r[s]=new i);l.cloneTo(u),r[s]=u}else if(l instanceof o){var h=r[s]||(r[s]=new o);l.cloneTo(h),r[s]=h}else if(l instanceof a){var _=r[s]||(r[s]=new a);l.cloneTo(_),r[s]=_}else if(l instanceof c){var d=r[s]||(r[s]=new c);l.cloneTo(d),r[s]=d}else l instanceof t.BaseTexture&&(r[s]=l)}this._defineDatas.cloneTo(n._defineDatas)}},{key:"clone",value:function(){var e=new ShaderData;return this.cloneTo(e),e}},{key:"cloneToForNative",value:function(e){var n=e;this._int32Data.length-n._int32Data.length>0&&n.needRenewArrayBufferForNative(this._int32Data.length),n._int32Data.set(this._int32Data,0);var r=n._nativeArray,s=this._nativeArray.length;r.length=s;for(var l=0;l<s;l++){var u=this._nativeArray[l];if(u)if("number"==typeof u)r[l]=u,n.setNumber(l,u);else if("number"==typeof u)r[l]=u,n.setInt(l,u);else if("boolean"==typeof u)r[l]=u,n.setBool(l,u);else if(u instanceof i){var h=r[l]||(r[l]=new i);u.cloneTo(h),r[l]=h,n.setVector2(l,h)}else if(u instanceof o){var _=r[l]||(r[l]=new o);u.cloneTo(_),r[l]=_,n.setVector3(l,_)}else if(u instanceof a){var d=r[l]||(r[l]=new a);u.cloneTo(d),r[l]=d,n.setVector(l,d)}else if(u instanceof c){var f=r[l]||(r[l]=new c);u.cloneTo(f),r[l]=f,n.setMatrix4x4(l,f)}else u instanceof t.BaseTexture&&(r[l]=u,n.setTexture(l,u))}this._defineDatas.cloneTo(n._defineDatas)}},{key:"_initDataForNative",value:function(){this._frameCount=-1,this._runtimeCopyValues.length=0,this._nativeArray=[],this._data=new ArrayBuffer(32),this._int32Data=new Int32Array(this._data),this._float32Data=new Float32Array(this._data),t.LayaGL.instance.createArrayBufferRef(this._data,t.LayaGL.ARRAY_BUFFER_TYPE_DATA,!0)}},{key:"needRenewArrayBufferForNative",value:function(e){if(e>=this._int32Data.length){var n=4*(e+1),i=this._int32Data,a=this._data.conchRef,r=this._data._ptrID;this._data=new ArrayBuffer(n),this._int32Data=new Int32Array(this._data),this._float32Data=new Float32Array(this._data),this._data.conchRef=a,this._data._ptrID=r,i&&this._int32Data.set(i,0);var o=t.LayaGL.instance;o.updateArrayBufferRef?o.updateArrayBufferRef(this._data._ptrID,a.isSyncToRender(),this._data):window.conch.updateArrayBufferRef(this._data._ptrID,a.isSyncToRender(),this._data)}}},{key:"getDataForNative",value:function(){return this._nativeArray}},{key:"getIntForNative",value:function(e){return this._int32Data[e]}},{key:"setIntForNative",value:function(e,t){this.needRenewArrayBufferForNative(e),this._int32Data[e]=t,this._nativeArray[e]=t}},{key:"getBoolForNative",value:function(e){return 1==this._int32Data[e]}},{key:"setBoolForNative",value:function(e,t){this.needRenewArrayBufferForNative(e),this._int32Data[e]=t?1:0,this._nativeArray[e]=t}},{key:"getNumberForNative",value:function(e){return this._float32Data[e]}},{key:"setNumberForNative",value:function(e,t){this.needRenewArrayBufferForNative(e),this._float32Data[e]=t,this._nativeArray[e]=t}},{key:"getMatrix4x4ForNative",value:function(e){return this._nativeArray[e]}},{key:"setMatrix4x4ForNative",value:function(e,t){this.needRenewArrayBufferForNative(e),this._nativeArray[e]=t;var n=this.setReferenceForNative(t.elements);this._int32Data[e]=n}},{key:"getVectorForNative",value:function(e){return this._nativeArray[e]}},{key:"setVectorForNative",value:function(e,t){this.needRenewArrayBufferForNative(e),this._nativeArray[e]=t,t.elements||t.forNativeElement();var n=this.setReferenceForNative(t.elements);this._int32Data[e]=n}},{key:"getVector2ForNative",value:function(e){return this._nativeArray[e]}},{key:"setVector2ForNative",value:function(e,t){this.needRenewArrayBufferForNative(e),this._nativeArray[e]=t,t.elements||t.forNativeElement();var n=this.setReferenceForNative(t.elements);this._int32Data[e]=n}},{key:"getVector3ForNative",value:function(e){return this._nativeArray[e]}},{key:"setVector3ForNative",value:function(e,t){this.needRenewArrayBufferForNative(e),this._nativeArray[e]=t,t.elements||t.forNativeElement();var n=this.setReferenceForNative(t.elements);this._int32Data[e]=n}},{key:"getQuaternionForNative",value:function(e){return this._nativeArray[e]}},{key:"setQuaternionForNative",value:function(e,t){this.needRenewArrayBufferForNative(e),this._nativeArray[e]=t,t.elements||t.forNativeElement();var n=this.setReferenceForNative(t.elements);this._int32Data[e]=n}},{key:"getBufferForNative",value:function(e){return this._nativeArray[e]}},{key:"setBufferForNative",value:function(e,t){this.needRenewArrayBufferForNative(e),this._nativeArray[e]=t;var n=this.setReferenceForNative(t);this._int32Data[e]=n}},{key:"getAttributeForNative",value:function(e){return this._nativeArray[e]}},{key:"setAttributeForNative",value:function(e,n){this._nativeArray[e]=n,n._ptrID||t.LayaGL.instance.createArrayBufferRef(n,t.LayaGL.ARRAY_BUFFER_TYPE_DATA,!0),t.LayaGL.instance.syncBufferToRenderThread(n),this._int32Data[e]=n._ptrID}},{key:"getTextureForNative",value:function(e){return this._nativeArray[e]}},{key:"setTextureForNative",value:function(e,t){if(t){this.needRenewArrayBufferForNative(e);var n=this._nativeArray[e];this._nativeArray[e]=t;var i=t._getSource()||t.defaulteTexture._getSource();this._int32Data[e]=i.id,this._ownerResource&&this._ownerResource.referenceCount>0&&(n&&n._removeReference(),t&&t._addReference())}}},{key:"setReferenceForNative",value:function(e){this.clearRuntimeCopyArray();var n=0,i=0;return ShaderData._SET_RUNTIME_VALUE_MODE_REFERENCE_?(t.LayaGL.instance.createArrayBufferRefs(e,t.LayaGL.ARRAY_BUFFER_TYPE_DATA,!0,t.LayaGL.ARRAY_BUFFER_REF_REFERENCE),n=0,i=e.getPtrID(n)):(t.LayaGL.instance.createArrayBufferRefs(e,t.LayaGL.ARRAY_BUFFER_TYPE_DATA,!0,t.LayaGL.ARRAY_BUFFER_REF_COPY),n=e.getRefNum()-1,i=e.getPtrID(n),this._runtimeCopyValues.push({obj:e,refID:n,ptrID:i})),t.LayaGL.instance.syncBufferToRenderThread(e,n),i}},{key:"clearRuntimeCopyArray",value:function(){var e=t.Stat.loopCount;if(this._frameCount!=e){this._frameCount=e;for(var n=0,i=this._runtimeCopyValues.length;n<i;n++){this._runtimeCopyValues[n].obj.clearRefNum()}this._runtimeCopyValues.length=0}}}],[{key:"setRuntimeValueMode",value:function(e){ShaderData._SET_RUNTIME_VALUE_MODE_REFERENCE_=e}}]),ShaderData}();ie._SET_RUNTIME_VALUE_MODE_REFERENCE_=!0;var ae=function(){function VertexDeclaration(e,t){_classCallCheck(this,VertexDeclaration),this._id=++VertexDeclaration._uniqueIDCounter,this._vertexElementsDic={},this._vertexStride=e,this._vertexElements=t;var n=t.length;this._shaderValues=new ie(null);for(var i=0;i<n;i++){var a=t[i],r=a._elementUsage;this._vertexElementsDic[r]=a;var o=new Int32Array(5),s=ne.getElementInfos(a._elementFormat);o[0]=s[0],o[1]=s[1],o[2]=s[2],o[3]=this._vertexStride,o[4]=a._offset,this._shaderValues.setAttribute(r,o)}}return _createClass(VertexDeclaration,[{key:"getVertexElementByIndex",value:function(e){return this._vertexElements[e]}},{key:"getVertexElementByUsage",value:function(e){return this._vertexElementsDic[e]}},{key:"id",get:function(){return this._id}},{key:"vertexStride",get:function(){return this._vertexStride}},{key:"vertexElementCount",get:function(){return this._vertexElements.length}}]),VertexDeclaration}();ae._uniqueIDCounter=1;var re=function(){function VertexElement(e,t,n){_classCallCheck(this,VertexElement),this._offset=e,this._elementFormat=t,this._elementUsage=n}return _createClass(VertexElement,[{key:"offset",get:function(){return this._offset}},{key:"elementFormat",get:function(){return this._elementFormat}},{key:"elementUsage",get:function(){return this._elementUsage}}]),VertexElement}(),oe=function(e){function BufferState(){return _classCallCheck(this,BufferState),_possibleConstructorReturn(this,_getPrototypeOf(BufferState).call(this))}return _inherits(BufferState,t.BufferStateBase),_createClass(BufferState,[{key:"applyVertexBuffer",value:function(e){if(t.BufferStateBase._curBindedBufferState!==this)throw"BufferState: must call bind() function first.";var n=t.LayaGL.instance,i=e.vertexDeclaration,a=i._shaderValues.getData();for(var r in this.vertexDeclaration=i,e.bind(),a){var o=parseInt(r),s=a[r];n.enableVertexAttribArray(o),n.vertexAttribPointer(o,s[0],s[1],!!s[2],s[3],s[4])}}},{key:"applyVertexBuffers",value:function(e){if(t.BufferStateBase._curBindedBufferState!==this)throw"BufferState: must call bind() function first.";for(var n=t.LayaGL.instance,i=0,a=e.length;i<a;i++){var r=e[i],o=r.vertexDeclaration._shaderValues.getData();for(var s in r.bind(),o){var l=parseInt(s),u=o[s];n.enableVertexAttribArray(l),n.vertexAttribPointer(l,u[0],u[1],!!u[2],u[3],u[4])}}}},{key:"applyInstanceVertexBuffer",value:function(e){if(t.LayaGL.layaGPUInstance.supportInstance()){if(t.BufferStateBase._curBindedBufferState!==this)throw"BufferState: must call bind() function first.";var n=t.LayaGL.instance,i=e.vertexDeclaration._shaderValues.getData();for(var a in e.bind(),i){var r=parseInt(a),o=i[a];n.enableVertexAttribArray(r),n.vertexAttribPointer(r,o[0],o[1],!!o[2],o[3],o[4]),t.LayaGL.layaGPUInstance.vertexAttribDivisor(r,1)}}}},{key:"applyIndexBuffer",value:function(e){if(t.BufferStateBase._curBindedBufferState!==this)throw"BufferState: must call bind() function first.";this._bindedIndexBuffer!==e&&(e._bindForVAO(),this._bindedIndexBuffer=e)}}]),BufferState}(),se=function(e){function ScreenQuad(){var e;_classCallCheck(this,ScreenQuad),(e=_possibleConstructorReturn(this,_getPrototypeOf(ScreenQuad).call(this)))._bufferState=new oe,e._bufferStateInvertUV=new oe;var n=t.LayaGL.instance;return e._vertexBuffer=new te(64,n.STATIC_DRAW,!1),e._vertexBuffer.vertexDeclaration=ScreenQuad._vertexDeclaration,e._vertexBuffer.setData(ScreenQuad._vertices.buffer),e._bufferState.bind(),e._bufferState.applyVertexBuffer(e._vertexBuffer),e._bufferState.unBind(),e._vertexBufferInvertUV=new te(64,n.STATIC_DRAW,!1),e._vertexBufferInvertUV.vertexDeclaration=ScreenQuad._vertexDeclaration,e._vertexBufferInvertUV.setData(ScreenQuad._verticesInvertUV.buffer),e._bufferStateInvertUV.bind(),e._bufferStateInvertUV.applyVertexBuffer(e._vertexBufferInvertUV),e._bufferStateInvertUV.unBind(),e._setGPUMemory(e._vertexBuffer._byteLength+e._vertexBufferInvertUV._byteLength),e}return _inherits(ScreenQuad,t.Resource),_createClass(ScreenQuad,[{key:"render",value:function(){var e=t.LayaGL.instance;this._bufferState.bind(),e.drawArrays(e.TRIANGLE_STRIP,0,4),t.Stat.renderBatches++}},{key:"renderInvertUV",value:function(){var e=t.LayaGL.instance;this._bufferStateInvertUV.bind(),e.drawArrays(e.TRIANGLE_STRIP,0,4),t.Stat.renderBatches++}},{key:"destroy",value:function(){_get(_getPrototypeOf(ScreenQuad.prototype),"destroy",this).call(this),this._bufferState.destroy(),this._vertexBuffer.destroy(),this._bufferStateInvertUV.destroy(),this._vertexBufferInvertUV.destroy(),this._setGPUMemory(0)}}],[{key:"__init__",value:function(){ScreenQuad._vertexDeclaration=new ae(16,[new re(0,ne.Vector4,ScreenQuad.SCREENQUAD_POSITION_UV)]),ScreenQuad.instance=new ScreenQuad,ScreenQuad.instance.lock=!0}}]),ScreenQuad}();se.SCREENQUAD_POSITION_UV=0,se._vertices=new Float32Array([1,1,1,1,1,-1,1,0,-1,1,0,1,-1,-1,0,0]),se._verticesInvertUV=new Float32Array([1,1,1,0,1,-1,1,1,-1,1,0,0,-1,-1,0,1]);var le=function(e){function ScreenTriangle(){var e;_classCallCheck(this,ScreenTriangle),(e=_possibleConstructorReturn(this,_getPrototypeOf(ScreenTriangle).call(this)))._bufferState=new oe,e._bufferStateInvertUV=new oe;var n=t.LayaGL.instance;return e._vertexBuffer=new te(48,n.STATIC_DRAW,!1),e._vertexBuffer.vertexDeclaration=ScreenTriangle._vertexDeclaration,e._vertexBuffer.setData(ScreenTriangle._vertices.buffer),e._bufferState.bind(),e._bufferState.applyVertexBuffer(e._vertexBuffer),e._bufferState.unBind(),e._vertexBufferInvertUV=new te(48,n.STATIC_DRAW,!1),e._vertexBufferInvertUV.vertexDeclaration=ScreenTriangle._vertexDeclaration,e._vertexBufferInvertUV.setData(ScreenTriangle._verticesInvertUV.buffer),e._bufferStateInvertUV.bind(),e._bufferStateInvertUV.applyVertexBuffer(e._vertexBufferInvertUV),e._bufferStateInvertUV.unBind(),e._setGPUMemory(e._vertexBuffer._byteLength+e._vertexBufferInvertUV._byteLength),e}return _inherits(ScreenTriangle,t.Resource),_createClass(ScreenTriangle,[{key:"render",value:function(){var e=t.LayaGL.instance;this._bufferState.bind(),e.drawArrays(e.TRIANGLES,0,3),t.Stat.renderBatches++}},{key:"renderInvertUV",value:function(){var e=t.LayaGL.instance;this._bufferStateInvertUV.bind(),e.drawArrays(e.TRIANGLES,0,3),t.Stat.renderBatches++}},{key:"destroy",value:function(){_get(_getPrototypeOf(ScreenTriangle.prototype),"destroy",this).call(this),this._bufferState.destroy(),this._vertexBuffer.destroy(),this._bufferStateInvertUV.destroy(),this._vertexBufferInvertUV.destroy(),this._setGPUMemory(0)}}],[{key:"__init__",value:function(){ScreenTriangle._vertexDeclaration=new ae(16,[new re(0,ne.Vector4,ScreenTriangle.SCREENTRIANGLE_POSITION_UV)]),ScreenTriangle.instance=new ScreenTriangle,ScreenTriangle.instance.lock=!0}}]),ScreenTriangle}();le.SCREENTRIANGLE_POSITION_UV=0,le._vertices=new Float32Array([-1,-1,0,0,-1,3,0,2,3,-1,2,0]),le._verticesInvertUV=new Float32Array([-1,-1,0,1,-1,3,0,-1,3,-1,2,1]);var ue=function ShaderDefine(e,t){_classCallCheck(this,ShaderDefine),this._index=e,this._value=t},ce=function(){function ShaderVariant(e,t,n,i){_classCallCheck(this,ShaderVariant),this._subShaderIndex=0,this._passIndex=0,this.setValue(e,t,n,i)}return _createClass(ShaderVariant,[{key:"setValue",value:function(e,t,n,i){if(!e)throw"ShaderVariantInfo:Shader can't be null.";var a=e.getSubShaderAt(t);if(!a)throw"ShaderVariantInfo:Shader don't have subShaderIndex of ".concat(t,".");var r=a._passes[n];if(!r)throw"ShaderVariantInfo:Shader don't have passIndex of ".concat(n,".");for(var o=r._validDefine,s=0,u=i.length;s<u;s++){var c=i[s];if(!o.has(l.Shader3D.getDefineByName(c)))throw"ShaderVariantInfo:Invalid defineName ".concat(c," in ").concat(e._name," subShaderIndex of ").concat(t," passIndex of ").concat(n,".")}this._shader=e,this._subShaderIndex=t,this._passIndex=n,this._defineNames=i}},{key:"equal",value:function(e){if(this._shader!==e._shader||this._subShaderIndex!==e._subShaderIndex||this._passIndex!==e._passIndex)return!1;var t=this._defineNames,n=e._defineNames;if(t.length!==n.length)return!1;for(var i=0,a=this._defineNames.length;i<a;i++)if(t[i]!==n[i])return!1;return!0}},{key:"clone",value:function(){return new ShaderVariant(this._shader,this._subShaderIndex,this._passIndex,this._defineNames.slice())}},{key:"shader",get:function(){return this._shader}},{key:"subShaderIndex",get:function(){return this._subShaderIndex}},{key:"passIndex",get:function(){return this._passIndex}},{key:"defineNames",get:function(){return this._defineNames}}]),ShaderVariant}(),he=function(){function ShaderVariantCollection(){_classCallCheck(this,ShaderVariantCollection),this._allCompiled=!1,this._variants=[]}return _createClass(ShaderVariantCollection,[{key:"add",value:function(e){for(var t=0,n=this._variants.length;t<n;t++)if(this._variants[t].equal(e))return!1;return this._variants.push(e.clone()),this._allCompiled=!1,!0}},{key:"remove",value:function(e){for(var t=0,n=this._variants.length;t<n;t++)if(this._variants[t].equal(e))return this._variants.splice(t,1),!0;return!1}},{key:"contatins",value:function(e){for(var t=0,n=this._variants.length;t<n;t++)if(this._variants[t].equal(e))return!0;return!1}},{key:"getByIndex",value:function(e){return this._variants[e]}},{key:"clear",value:function(){this._variants.length=0}},{key:"compile",value:function(){if(!this._allCompiled){for(var e=this._variants,t=0,n=e.length;t<n;t++){var i=e[t];l.Shader3D.compileShaderByDefineNames(i._shader._name,i._subShaderIndex,i._passIndex,i._defineNames)}this._allCompiled=!0}}},{key:"allCompiled",get:function(){return this._allCompiled}},{key:"variantCount",get:function(){return this._variants.length}}]),ShaderVariantCollection}(),_e=function(){function Shader3D(e,t,n,i,a){_classCallCheck(this,Shader3D),this._attributeMap=null,this._uniformMap=null,this._enableInstancing=!1,this._supportReflectionProbe=!1,this._subShaders=[],this._name=e,this._attributeMap=t,this._uniformMap=n,this._enableInstancing=i,this._supportReflectionProbe=a}return _createClass(Shader3D,[{key:"addSubShader",value:function(e){this._subShaders.push(e),e._owner=this}},{key:"getSubShaderAt",value:function(e){return this._subShaders[e]}},{key:"name",get:function(){return this._name}}],[{key:"_getNamesByDefineData",value:function(e,t){var n=Shader3D._maskMap,i=e._mask;t.length=0;for(var a=0,r=e._length;a<r;a++)for(var o=n[a],s=i[a],l=0;l<32;l++){var u=1<<l;if(s>0&&u>s)break;s&u&&t.push(o[u])}}},{key:"getDefineByName",value:function(e){var t=Shader3D._defineMap[e];if(!t){var n=Shader3D._maskMap,i=Shader3D._defineCounter,a=Math.floor(i/32),r=1<<i%32;t=new ue(a,r),Shader3D._defineMap[e]=t,a==n.length&&(n.length++,n[a]={}),n[a][r]=e,Shader3D._defineCounter++}return t}},{key:"propertyNameToID",value:function(e){if(null!=Shader3D._propertyNameMap[e])return Shader3D._propertyNameMap[e];var t=Shader3D._propertyNameCounter++;return Shader3D._propertyNameMap[e]=t,t}},{key:"addInclude",value:function(e,n){n=n.replace(t.ShaderCompile._clearCR,""),t.ShaderCompile.addInclude(e,n)}},{key:"compileShaderByDefineNames",value:function(e,t,n,i){var a=Shader3D.find(e);if(a){var r=a.getSubShaderAt(t);if(r){var o=r._passes[n];if(o){var s=Shader3D._compileDefineDatas;s.clear();for(var l=0,u=i.length;l<u;l++)s.add(Shader3D.getDefineByName(i[l]));o.withCompile(s)}else console.warn("Shader3D: unknown passIndex.")}else console.warn("Shader3D: unknown subShaderIndex.")}else console.warn("Shader3D: unknown shader name.")}},{key:"add",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,i=arguments.length>3&&void 0!==arguments[3]&&arguments[3],a=arguments.length>4&&void 0!==arguments[4]&&arguments[4];return Shader3D._preCompileShader[e]=new Shader3D(e,t,n,i,a)}},{key:"find",value:function(e){return Shader3D._preCompileShader[e]}},{key:"compileShader",value:function(e,t,n){var i=Shader3D.find(e);if(i){var a=i.getSubShaderAt(t);if(a){var r=a._passes[n];if(r){var o=Shader3D._compileDefineDatas,s=o._mask;s.length=0;for(var l=0,u=arguments.length<=3?0:arguments.length-3;l<u;l++)s.push(l+3<3||arguments.length<=l+3?void 0:arguments[l+3]);o._length=arguments.length<=3?0:arguments.length-3,r.withCompile(o)}else console.warn("Shader3D: unknown passIndex.")}else console.warn("Shader3D: unknown subShaderIndex.")}else console.warn("Shader3D: unknown shader name.")}}]),Shader3D}();_e._compileDefineDatas=new ee,_e.RENDER_STATE_CULL=0,_e.RENDER_STATE_BLEND=1,_e.RENDER_STATE_BLEND_SRC=2,_e.RENDER_STATE_BLEND_DST=3,_e.RENDER_STATE_BLEND_SRC_RGB=4,_e.RENDER_STATE_BLEND_DST_RGB=5,_e.RENDER_STATE_BLEND_SRC_ALPHA=6,_e.RENDER_STATE_BLEND_DST_ALPHA=7,_e.RENDER_STATE_BLEND_CONST_COLOR=8,_e.RENDER_STATE_BLEND_EQUATION=9,_e.RENDER_STATE_BLEND_EQUATION_RGB=10,_e.RENDER_STATE_BLEND_EQUATION_ALPHA=11,_e.RENDER_STATE_DEPTH_TEST=12,_e.RENDER_STATE_DEPTH_WRITE=13,_e.PERIOD_CUSTOM=0,_e.PERIOD_MATERIAL=1,_e.PERIOD_SPRITE=2,_e.PERIOD_CAMERA=3,_e.PERIOD_SCENE=4,_e._propertyNameCounter=0,_e._propertyNameMap={},_e._defineCounter=0,_e._defineMap={},_e._preCompileShader={},_e._maskMap=[],_e.debugMode=!1,_e.debugShaderVariantCollection=new he;var de=function(){function Command(){_classCallCheck(this,Command),this._commandBuffer=null}return _createClass(Command,[{key:"run",value:function(){}},{key:"recover",value:function(){this._commandBuffer=null}},{key:"setContext",value:function(e){this._context=e}}],[{key:"__init__",value:function(){Command._screenShaderData=new ie,Command._screenShader=_e.find("BlitScreen")}}]),Command}();de.SCREENTEXTURE_NAME="u_MainTex",de.SCREENTEXTUREOFFSETSCALE_NAME="u_OffsetScale",de.MAINTEXTURE_TEXELSIZE_NAME="u_MainTex_TexelSize",de.SCREENTEXTURE_ID=_e.propertyNameToID(de.SCREENTEXTURE_NAME),de.SCREENTEXTUREOFFSETSCALE_ID=_e.propertyNameToID(de.SCREENTEXTUREOFFSETSCALE_NAME),de.MAINTEXTURE_TEXELSIZE_ID=_e.propertyNameToID(de.MAINTEXTURE_TEXELSIZE_NAME);var fe=function(e){function BlitScreenQuadCMD(){var e;return _classCallCheck(this,BlitScreenQuadCMD),(e=_possibleConstructorReturn(this,_getPrototypeOf(BlitScreenQuadCMD).apply(this,arguments)))._source=null,e._dest=null,e._offsetScale=null,e._shader=null,e._shaderData=null,e._subShader=0,e._sourceTexelSize=new a,e._screenType=0,e._drawDefineCavans=!1,e}return _inherits(BlitScreenQuadCMD,de),_createClass(BlitScreenQuadCMD,[{key:"run",value:function(){var e;if(this._source)e=this._source;else{if(!this._commandBuffer._camera._internalRenderTexture)throw"camera internalRenderTexture is null,please set camera enableBuiltInRenderTexture";e=this._commandBuffer._camera._internalRenderTexture}var n=this._shader||de._screenShader,i=this._shaderData||de._screenShaderData,a=this._dest?this._dest:this._drawDefineCavans?this._dest:this._commandBuffer._camera._internalRenderTexture;t.LayaGL.instance.viewport(0,0,a?a.width:J.clientWidth,a?a.height:J.clientHeight),i.setTexture(de.SCREENTEXTURE_ID,e),i.setVector(de.SCREENTEXTUREOFFSETSCALE_ID,this._offsetScale||BlitScreenQuadCMD._defaultOffsetScale),this._sourceTexelSize.setValue(1/e.width,1/e.height,e.width,e.height),i.setVector(de.MAINTEXTURE_TEXELSIZE_ID,this._sourceTexelSize),$.currentActive&&$.currentActive._end(),a&&a._start();for(var r=n.getSubShaderAt(this._subShader)._passes,o=0,s=r.length;o<s;o++){var l=BlitScreenQuadCMD._compileDefine;i._defineDatas.cloneTo(l);var u=r[o].withCompile(l);switch(u.bind(),u.uploadUniforms(u._materialUniformParamsMap,i,!0),u.uploadRenderStateBlendDepth(i),u.uploadRenderStateFrontFace(i,!1,null),this._screenType){case BlitScreenQuadCMD._SCREENTYPE_QUAD:J._instance.invertY?se.instance.renderInvertUV():se.instance.render();break;case BlitScreenQuadCMD._SCREENTYPE_TRIANGLE:J._instance.invertY?le.instance.renderInvertUV():le.instance.render();break;default:throw"BlitScreenQuadCMD:unknown screen Type."}}a&&a._end()}},{key:"recover",value:function(){BlitScreenQuadCMD._pool.push(this),this._source=null,this._dest=null,this._offsetScale=null,this._shader=null,this._shaderData=null,this._drawDefineCavans=!1,_get(_getPrototypeOf(BlitScreenQuadCMD.prototype),"recover",this).call(this)}}],[{key:"create",value:function(e,t){var n,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,s=arguments.length>6&&void 0!==arguments[6]?arguments[6]:BlitScreenQuadCMD._SCREENTYPE_QUAD,l=arguments.length>7&&void 0!==arguments[7]?arguments[7]:null,u=arguments.length>8&&void 0!==arguments[8]&&arguments[8];return(n=BlitScreenQuadCMD._pool.length>0?BlitScreenQuadCMD._pool.pop():new BlitScreenQuadCMD)._source=e,n._dest=t,n._offsetScale=i,n._shader=a,n._shaderData=r,n._subShader=o,n._screenType=s,n._commandBuffer=l,n._drawDefineCavans=u,n}}]),BlitScreenQuadCMD}();fe._SCREENTYPE_QUAD=0,fe._SCREENTYPE_TRIANGLE=1,fe._compileDefine=new ee,fe._pool=[],fe._defaultOffsetScale=new a(0,0,1,1);var me,pe=function(e){function SetRenderTargetCMD(){var e;return _classCallCheck(this,SetRenderTargetCMD),(e=_possibleConstructorReturn(this,_getPrototypeOf(SetRenderTargetCMD).apply(this,arguments)))._renderTexture=null,e}return _inherits(SetRenderTargetCMD,de),_createClass(SetRenderTargetCMD,[{key:"run",value:function(){$.currentActive&&$.currentActive._end(),t.LayaGL.instance.viewport(0,0,this._renderTexture.width,this._renderTexture.height),this._renderTexture._start()}},{key:"recover",value:function(){SetRenderTargetCMD._pool.push(this),this._renderTexture=null}}],[{key:"create",value:function(e){var t;return(t=SetRenderTargetCMD._pool.length>0?SetRenderTargetCMD._pool.pop():new SetRenderTargetCMD)._renderTexture=e,t}}]),SetRenderTargetCMD}();pe._pool=[],(me=e.ShaderDataType||(e.ShaderDataType={}))[me.Int=0]="Int",me[me.Bool=1]="Bool",me[me.Number=2]="Number",me[me.Vector2=3]="Vector2",me[me.Vector3=4]="Vector3",me[me.Vector4=5]="Vector4",me[me.Quaternion=6]="Quaternion",me[me.Matrix4x4=7]="Matrix4x4",me[me.Buffer=8]="Buffer",me[me.Texture=9]="Texture";var Te=function(t){function SetShaderDataCMD(){var e;return _classCallCheck(this,SetShaderDataCMD),(e=_possibleConstructorReturn(this,_getPrototypeOf(SetShaderDataCMD).apply(this,arguments)))._shaderData=null,e._nameID=0,e._value=null,e._dataType=-1,e}return _inherits(SetShaderDataCMD,de),_createClass(SetShaderDataCMD,[{key:"run",value:function(){switch(this._dataType){case e.ShaderDataType.Int:this._shaderData.setInt(this._nameID,this._value);break;case e.ShaderDataType.Number:this._shaderData.setNumber(this._nameID,this._value);break;case e.ShaderDataType.Bool:this._shaderData.setBool(this._nameID,this._value);break;case e.ShaderDataType.Matrix4x4:this._shaderData.setMatrix4x4(this._nameID,this._value);break;case e.ShaderDataType.Quaternion:this._shaderData.setQuaternion(this._nameID,this._value);break;case e.ShaderDataType.Texture:this._shaderData.setTexture(this._nameID,this._value);break;case e.ShaderDataType.Vector4:this._shaderData.setVector(this._nameID,this._value);break;case e.ShaderDataType.Vector2:this._shaderData.setVector2(this._nameID,this._value);break;case e.ShaderDataType.Vector3:this._shaderData.setVector3(this._nameID,this._value);break;case e.ShaderDataType.Buffer:this._shaderData.setBuffer(this._nameID,this._value);break;default:throw"no type shaderValue on this CommendBuffer"}}},{key:"recover",value:function(){SetShaderDataCMD._pool.push(this),this._shaderData=null,this._nameID=0,this._value=null,this._dataType=-1}}],[{key:"create",value:function(e,t,n,i,a){var r;return(r=SetShaderDataCMD._pool.length>0?SetShaderDataCMD._pool.pop():new SetShaderDataCMD)._shaderData=e,r._nameID=t,r._value=n,r._dataType=i,r._commandBuffer=a,r}}]),SetShaderDataCMD}();Te._pool=[];var ve=function(e){function Sprite3D(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,n=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return _classCallCheck(this,Sprite3D),(e=_possibleConstructorReturn(this,_getPrototypeOf(Sprite3D).call(this)))._needProcessCollisions=!1,e._needProcessTriggers=!1,e._id=++Sprite3D._uniqueIDCounter,e._transform=new f(_assertThisInitialized(e)),e._isStatic=n,e.layer=0,e.name=t||"New Sprite3D",e}return _inherits(Sprite3D,t.Node),_createClass(Sprite3D,[{key:"_setCreateURL",value:function(e){this._url=t.URL.formatURL(e)}},{key:"_changeAnimatorsToLinkSprite3D",value:function(e,t,n){var i=this.getComponent(K);if(i&&(i.avatar||e._changeAnimatorToLinkSprite3DNoAvatar(i,t,n)),this._parent&&this._parent instanceof Sprite3D){n.unshift(this._parent.name);var a=this._parent;a._hierarchyAnimator&&a._changeAnimatorsToLinkSprite3D(e,t,n)}}},{key:"_setHierarchyAnimator",value:function(e,t){this._changeHierarchyAnimator(e),this._changeAnimatorAvatar(e.avatar);for(var n=0,i=this._children.length;n<i;n++){var a=this._children[n];a._hierarchyAnimator==t&&a._setHierarchyAnimator(e,t)}}},{key:"_clearHierarchyAnimator",value:function(e,t){this._changeHierarchyAnimator(t),this._changeAnimatorAvatar(t?t.avatar:null);for(var n=0,i=this._children.length;n<i;n++){var a=this._children[n];a._hierarchyAnimator==e&&a._clearHierarchyAnimator(e,t)}}},{key:"_changeHierarchyAnimatorAvatar",value:function(e,t){this._changeAnimatorAvatar(t);for(var n=0,i=this._children.length;n<i;n++){var a=this._children[n];a._hierarchyAnimator==e&&a._changeHierarchyAnimatorAvatar(e,t)}}},{key:"_changeAnimatorToLinkSprite3DNoAvatar",value:function(e,t,n){e._handleSpriteOwnersBySprite(t,n,this);for(var i=0,a=this._children.length;i<a;i++){var r=this._children[i],o=n.length;n.push(r.name),r._changeAnimatorToLinkSprite3DNoAvatar(e,t,n),n.splice(o,1)}}},{key:"_changeHierarchyAnimator",value:function(e){this._hierarchyAnimator=e}},{key:"_changeAnimatorAvatar",value:function(e){}},{key:"_onAdded",value:function(){if(this._parent instanceof Sprite3D){var e=this._parent;this.transform._setParent(e.transform),e._hierarchyAnimator&&(!this._hierarchyAnimator&&this._setHierarchyAnimator(e._hierarchyAnimator,null),e._changeAnimatorsToLinkSprite3D(this,!0,[this.name]))}_get(_getPrototypeOf(Sprite3D.prototype),"_onAdded",this).call(this)}},{key:"_onRemoved",value:function(){if(_get(_getPrototypeOf(Sprite3D.prototype),"_onRemoved",this).call(this),this._parent instanceof Sprite3D){var e=this._parent;this.transform._setParent(null),e._hierarchyAnimator&&(this._hierarchyAnimator==e._hierarchyAnimator&&this._clearHierarchyAnimator(e._hierarchyAnimator,null),e._changeAnimatorsToLinkSprite3D(this,!1,[this.name]))}}},{key:"_parse",value:function(e,t){if(void 0!==e.isStatic&&(this._isStatic=e.isStatic),void 0!==e.active&&(this.active=e.active),null!=e.name&&(this.name=e.name),void 0!==e.position){var n=this.transform.localPosition;n.fromArray(e.position),this.transform.localPosition=n}if(void 0!==e.rotationEuler){var i=this.transform.localRotationEuler;i.fromArray(e.rotationEuler),this.transform.localRotationEuler=i}if(void 0!==e.rotation){var a=this.transform.localRotation;a.fromArray(e.rotation),this.transform.localRotation=a}if(void 0!==e.scale){var r=this.transform.localScale;r.fromArray(e.scale),this.transform.localScale=r}null!=e.layer&&(this.layer=e.layer)}},{key:"_cloneTo",value:function(e,t,n){if(this.destroyed)throw new Error("Sprite3D: Can't be cloned if the Sprite3D has destroyed.");var i=e,a=this._transform,r=i._transform;i.name=this.name,i.destroyed=this.destroyed,i.active=this.active,r.localPosition=a.localPosition,r.localRotation=a.localRotation,r.localScale=a.localScale,i._isStatic=this._isStatic,i.layer=this.layer,_get(_getPrototypeOf(Sprite3D.prototype),"_cloneTo",this).call(this,i,t,n)}},{key:"clone",value:function(){var e=Sprite3D._createSprite3DInstance(this);return Sprite3D._parseSprite3DInstance(this,e,this,e),e}},{key:"destroy",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];this.destroyed||(_get(_getPrototypeOf(Sprite3D.prototype),"destroy",this).call(this,e),this._transform=null,this._scripts=null,this._url&&t.Loader.clearRes(this._url))}},{key:"_create",value:function(){return new Sprite3D}},{key:"id",get:function(){return this._id}},{key:"layer",get:function(){return this._layer},set:function(e){if(this._layer!==e){if(!(e>=0&&e<=30))throw new Error("Layer value must be 0-30.");this._layer=e}}},{key:"url",get:function(){return this._url}},{key:"isStatic",get:function(){return this._isStatic}},{key:"transform",get:function(){return this._transform}}],[{key:"__init__",value:function(){}},{key:"instantiate",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,r=e.clone();t&&t.addChild(r);var o=r.transform;if(n){var s=o.worldMatrix;e.transform.worldMatrix.cloneTo(s),o.worldMatrix=s}else i&&(o.position=i),a&&(o.rotation=a);return r}},{key:"load",value:function(e,n){t.Laya.loader.create(e,n,null,Sprite3D.HIERARCHY)}},{key:"_createSprite3DInstance",value:function(e){for(var t=e._create(),n=e._children,i=0,a=n.length;i<a;i++){var r=Sprite3D._createSprite3DInstance(n[i]);t.addChild(r)}return t}},{key:"_parseSprite3DInstance",value:function(e,t,n,i){for(var a=n._children,r=i._children,o=0,s=a.length;o<s;o++)Sprite3D._parseSprite3DInstance(e,t,a[o],r[o]);n._cloneTo(i,e,t)}}]),Sprite3D}();ve.HIERARCHY="HIERARCHY",ve.WORLDMATRIX=_e.propertyNameToID("u_WorldMat"),ve.MVPMATRIX=_e.propertyNameToID("u_MvpMatrix"),ve._uniqueIDCounter=0;var ge=function(e){function DrawMeshCMD(){var e;return _classCallCheck(this,DrawMeshCMD),(e=_possibleConstructorReturn(this,_getPrototypeOf(DrawMeshCMD).call(this)))._projectionViewWorldMatrix=new c,e._renderShaderValue=new ie,e._renderShaderValue=new ie(null),e}return _inherits(DrawMeshCMD,de),_createClass(DrawMeshCMD,[{key:"run",value:function(){var e=this._material._shader.getSubShaderAt(this._subShaderIndex);this.setContext(this._commandBuffer._context);var t=this._context,n=t.invertY,i=t.scene,a=t.cameraShaderValue,r=t.projectionViewMatrix;c.multiply(r,this._matrix,this._projectionViewWorldMatrix),this._renderShaderValue.setMatrix4x4(ve.WORLDMATRIX,this._matrix),this._renderShaderValue.setMatrix4x4(ve.MVPMATRIX,this._projectionViewWorldMatrix);for(var o=t.pipelineMode,s=e._passes,l=0,u=s.length;l<u;l++){var h=s[l];if(h._pipelineMode===o){var _=DrawMeshCMD._compileDefine;i._shaderValues._defineDatas.cloneTo(_),_.addDefineDatas(this._renderShaderValue._defineDatas),_.addDefineDatas(this._material._shaderValues._defineDatas);var d=t.shader=h.withCompile(_);d.bind(),d.uploadUniforms(d._sceneUniformParamsMap,i._shaderValues,!0),d.uploadUniforms(d._spriteUniformParamsMap,this._renderShaderValue,!0),d.uploadUniforms(d._cameraUniformParamsMap,a,!0);var f=this._material._shaderValues;d.uploadUniforms(d._materialUniformParamsMap,f,!0),d.uploadRenderStateBlendDepth(f),d.uploadRenderStateFrontFace(f,n,this._matrix.getInvertFront())}}var m,p=this._mesh._subMeshes;if(-1==this._subMeshIndex)for(var T=0,v=p.length;T<v;T++)(m=p[T])._prepareRender(t)&&m._render(t);else(m=(p=this._mesh._subMeshes)[this._subMeshIndex])._prepareRender(t)&&m._render(t)}},{key:"recover",value:function(){DrawMeshCMD._pool.push(this),this._renderShaderValue.clearDefine(),this._renderShaderValue._initData()}}],[{key:"create",value:function(e,t,n,i,a,r){var o;return(o=DrawMeshCMD._pool.length>0?DrawMeshCMD._pool.pop():new DrawMeshCMD)._mesh=e,o._matrix=t,o._material=n,o._subMeshIndex=i,o._subShaderIndex=a,o._commandBuffer=r,o}}]),DrawMeshCMD}();ge._pool=[],ge._compileDefine=new ee;var Ee=function(e){function ClearRenderTextureCMD(){var e;return _classCallCheck(this,ClearRenderTextureCMD),(e=_possibleConstructorReturn(this,_getPrototypeOf(ClearRenderTextureCMD).apply(this,arguments)))._clearColor=!1,e._clearDepth=!1,e._backgroundColor=new a,e._depth=1,e}return _inherits(ClearRenderTextureCMD,de),_createClass(ClearRenderTextureCMD,[{key:"run",value:function(){var e,n=t.LayaGL.instance,i=this._backgroundColor;this._clearColor&&(n.clearColor(i.x,i.y,i.z,i.w),e|=n.COLOR_BUFFER_BIT),this._clearDepth&&(n.clearDepth(this._depth),e|=n.DEPTH_BUFFER_BIT),(this._clearColor||this._clearDepth)&&n.clear(e)}},{key:"recover",value:function(){}}],[{key:"create",value:function(e,t,n){var i,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,r=arguments.length>4?arguments[4]:void 0;return(i=ClearRenderTextureCMD._pool.length>0?ClearRenderTextureCMD._pool.pop():new ClearRenderTextureCMD)._clearColor=e,i._clearDepth=t,n.cloneTo(i._backgroundColor),i._depth=a,i._commandBuffer=r,i}}]),ClearRenderTextureCMD}();Ee._pool=[];var ye=function ClusterData(){_classCallCheck(this,ClusterData),this.updateMark=-1,this.pointLightCount=0,this.spotLightCount=0,this.indices=[]},Se=function(){function Cluster(e,t,n,a){_classCallCheck(this,Cluster),this._updateMark=0,this._depthSliceParam=new i,this._xSlices=e,this._ySlices=t,this._zSlices=n;var r=e*t,o=n*(1+Math.ceil(a/4));this._clusterTexture=P._createFloatTextureBuffer(r,o),this._clusterTexture.lock=!0,this._clusterPixels=new Float32Array(r*o*4);for(var s=new Array(this._zSlices),l=0;l<this._zSlices;l++){s[l]=new Array(this._ySlices);for(var u=0;u<this._ySlices;u++){s[l][u]=new Array(this._xSlices);for(var c=0;c<this._xSlices;c++)s[l][u][c]=new ye}}this._clusterDatas=s}return _createClass(Cluster,[{key:"_placePointLightToClusters",value:function(e,t){for(var n=this._clusterDatas,i=this._updateMark,a=t.zMin,r=t.zMax;a<r;a++)for(var o=t.yMin,s=t.yMax;o<s;o++)for(var l=t.xMin,u=t.xMax;l<u;l++){var c=n[a][o][l];c.updateMark!=i&&(c.pointLightCount=0,c.spotLightCount=0,c.updateMark=i);var h=c.indices,_=c.pointLightCount++;_<h.length?h[_]=e:h.push(e)}}},{key:"_placeSpotLightToClusters",value:function(e,t){for(var n=this._clusterDatas,i=this._updateMark,a=t.zMin,r=t.zMax;a<r;a++)for(var o=t.yMin,s=t.yMax;o<s;o++)for(var l=t.xMin,u=t.xMax;l<u;l++){var c=n[a][o][l];c.updateMark!=i&&(c.pointLightCount=0,c.spotLightCount=0,c.updateMark=i);var h=c.indices,_=c.pointLightCount+c.spotLightCount++;_<h.length?h[_]=e:h.push(e)}}},{key:"_insertConePlane",value:function(e,t,n,i,a){var r=Cluster._tempVector36,s=Cluster._tempVector37;o.cross(a,t,r),o.cross(r,t,s),o.normalize(s,s);var l=n*Math.tan(i),u=e.x+n*t.x+l*s.x,c=e.y+n*t.y+l*s.y,h=e.z+n*t.z+l*s.z;return u*a.x+c*a.y+h*a.z<=0||e.x*a.x+e.y*a.y+e.z*a.z<=0}},{key:"_shrinkSphereLightZPerspective",value:function(e,t,n,i,a){var r=n.z,o=r-i,s=r+i;if(o>t||s<=e)return!1;var l=this._depthSliceParam;return a.zMin=Math.floor(Math.log2(Math.max(o,e))*l.x-l.y),a.zMax=Math.min(Math.ceil(Math.log2(s)*l.x-l.y),this._zSlices),!0}},{key:"_shrinkSpotLightZPerspective",value:function(e,t,n,i,a,r,o){var s=i.x,l=i.y,u=i.z,c=Math.tan(r)*a,h=n.x,_=n.y,d=n.z,f=s-h,m=l-_,p=u-d,T=f*f+m*m+p*p,v=Math.sqrt(1-p*p/T),g=Math.max(Math.min(d,u-v*c),n.z-a),E=Math.min(Math.max(d,u+v*c),n.z+a);if(g>t||E<=e)return!1;var y=this._depthSliceParam;return o.zMin=Math.floor(Math.log2(Math.max(g,e))*y.x-y.y),o.zMax=Math.min(Math.ceil(Math.log2(E)*y.x-y.y),this._zSlices),!0}},{key:"_shrinkSphereLightByBoundOrth",value:function(e,t,n,i,a,r,o){var s=a.z,l=s-r,u=s+r;if(l>i||u<=n)return!1;var c=a.x,h=c-r,_=c+r;if(h>e||_<=-e)return!1;var d=a.y,f=d-r,m=d+r;if(f>t||m<=-t)return!1;var p=this._xSlices,T=this._ySlices,v=this._depthSliceParam,g=2*e/p,E=2*t/T;return o.xMin=Math.max(Math.floor((h+e)/g),0),o.xMax=Math.min(Math.ceil((_+e)/g),p),o.yMin=Math.max(Math.floor((t-m)/E),0),o.yMax=Math.min(Math.ceil((t-f)/E),T),o.zMin=Math.floor(Math.log2(Math.max(l,n))*v.x-v.y),o.zMax=Math.min(Math.ceil(Math.log2(u)*v.x-v.y),this._zSlices),!0}},{key:"_shrinkSpotLightByBoundOrth",value:function(e,t,n,i,a,r,o,s,l){var u=r.x,c=r.y,h=r.z,_=Math.tan(s)*o,d=a.x,f=a.y,m=a.z,p=u-d,T=c-f,v=h-m,g=p*p+T*T+v*v,E=Math.sqrt(1-v*v/g),y=Math.max(Math.min(m,h-E*_),a.z-o),S=Math.min(Math.max(m,h+E*_),a.z+o);if(y>i||S<=n)return!1;var R=Math.sqrt(1-p*p/g),C=Math.max(Math.min(d,u-R*_),a.x-o),M=Math.min(Math.max(d,u+R*_),a.x+o);if(C>e||M<=-e)return!1;var D=Math.sqrt(1-T*T/g),x=Math.max(Math.min(f,c-D*_),a.y-o),A=Math.min(Math.max(f,c+D*_),a.y+o);if(x>t||A<=-t)return!1;var I=this._xSlices,L=this._ySlices,P=this._depthSliceParam,O=2*e/I,N=2*t/L;return l.xMin=Math.max(Math.floor((C+e)/O),0),l.xMax=Math.min(Math.ceil((M+e)/O),I),l.yMin=Math.max(Math.floor((t-A)/N),0),l.yMax=Math.min(Math.ceil((t-x)/N),L),l.zMin=Math.floor(Math.log2(Math.max(y,n))*P.x-P.y),l.zMax=Math.min(Math.ceil(Math.log2(S)*P.x-P.y),this._zSlices),!0}},{key:"_shrinkXYByRadiusPerspective",value:function(e,t,n,i,a){var r,o,s,l,u,c=e.x,h=e.y,_=e.z,d=this._ySlices+1;for(u=0;u<d;u++){if(h*(f=a[u]).y+_*f.z<t){o=Math.max(0,u-1);break}}if(u==d)return!1;for(l=this._ySlices,u=o+1;u<d;u++){if(h*(f=a[u]).y+_*f.z<=-t){l=Math.max(0,u);break}}for(d=this._xSlices+1,u=0;u<d;u++){if(c*(f=i[u]).x+_*f.z<t){r=Math.max(0,u-1);break}}for(s=this._xSlices,u=r+1;u<d;u++){var f;if(c*(f=i[u]).x+_*f.z<=-t){s=Math.max(0,u);break}}return n.xMin=r,n.xMax=s,n.yMin=o,n.yMax=l,!0}},{key:"_shrinkSpotXYByConePerspective",value:function(e,t,n,i,a,r,o){for(var s,l,u,c,h=Cluster._tempVector32,_=a.yMax+1,d=a.yMin+1;d<_;d++)if(this._insertConePlane(e,t,n,i,o[d])){l=Math.max(0,d-1);break}c=a.yMax;for(d=l+1;d<_;d++){var f=o[d];if(h.setValue(0,-f.y,-f.z),!this._insertConePlane(e,t,n,i,h)){c=Math.max(0,d);break}}_=a.xMax+1;for(d=a.xMin+1;d<_;d++)if(this._insertConePlane(e,t,n,i,r[d])){s=Math.max(0,d-1);break}u=a.xMax;for(d=s+1;d<_;d++){f=r[d];if(h.setValue(-f.x,0,-f.z),!this._insertConePlane(e,t,n,i,h)){u=Math.max(0,d);break}}a.xMin=s,a.xMax=u,a.yMin=l,a.yMax=c}},{key:"_updatePointLightPerspective",value:function(e,t,n,i,a,r,s){var l=Cluster._tempLightBound,u=Cluster._tempVector30;o.transformV3ToV3(i._transform.position,n,u),u.z*=-1,this._shrinkSphereLightZPerspective(e,t,u,i.range,l)&&this._shrinkXYByRadiusPerspective(u,i.range,l,r,s)&&this._placePointLightToClusters(a,l)}},{key:"_updateSpotLightPerspective",value:function(e,t,n,i,a,r,s){var l=Cluster._tempLightBound,u=Cluster._tempVector30,c=Cluster._tempVector31,h=Cluster._tempVector34,_=i._transform.position,d=i.range;i._transform.worldMatrix.getForward(c),o.normalize(c,c),o.scale(c,d,h),o.add(_,h,h),o.transformV3ToV3(_,n,u),o.transformV3ToV3(h,n,h),u.z*=-1,h.z*=-1;var f=i.spotAngle/2*Math.PI/180;if(this._shrinkSpotLightZPerspective(e,t,u,h,d,f,l)&&this._shrinkXYByRadiusPerspective(u,d,l,r,s)){var m=Cluster._tempVector33;m.x=h.x-u.x,m.y=h.y-u.y,m.z=h.z-u.z,o.normalize(m,m),this._shrinkSpotXYByConePerspective(u,m,d,f,l,r,s),this._placeSpotLightToClusters(a,l)}}},{key:"_updatePointLightOrth",value:function(e,t,n,i,a,r,s){var l=Cluster._tempLightBound,u=Cluster._tempVector30;o.transformV3ToV3(r._transform.position,a,u),u.z*=-1,this._shrinkSphereLightByBoundOrth(e,t,n,i,u,r.range,l)&&this._placePointLightToClusters(s,l)}},{key:"_updateSpotLightOrth",value:function(e,t,n,i,a,r,s){var l=Cluster._tempLightBound,u=Cluster._tempVector30,c=Cluster._tempVector31,h=Cluster._tempVector34,_=r._transform.position,d=r.range;r._transform.worldMatrix.getForward(c),o.normalize(c,c),o.scale(c,d,h),o.add(_,h,h),o.transformV3ToV3(_,a,u),o.transformV3ToV3(h,a,h),u.z*=-1,h.z*=-1;var f=r.spotAngle/2*Math.PI/180;this._shrinkSpotLightByBoundOrth(e,t,n,i,u,h,d,f,l)&&this._placeSpotLightToClusters(s,l)}},{key:"update",value:function(e,t){this._updateMark++;var n=e.nearPlane;this._depthSliceParam.x=w._config.lightClusterCount.z/Math.log2(e.farPlane/n),this._depthSliceParam.y=Math.log2(n)*this._depthSliceParam.x;var i=e.nearPlane,a=e.farPlane,r=e.viewMatrix,o=t._directionLights._length,s=t._pointLights,l=s._length,u=s._elements,c=t._spotLights,h=c._length,_=c._elements;if(e.orthographic){for(var d=e.orthographicVerticalSize/2,f=d*e.aspectRatio,m=0;m<l;m++,o++)this._updatePointLightOrth(f,d,i,a,r,u[m],o);for(m=0;m<h;m++,o++)this._updateSpotLightOrth(f,d,i,a,r,_[m],o)}else{e._updateClusterPlaneXY();var p=e._clusterXPlanes,T=e._clusterYPlanes;for(m=0;m<l;m++,o++)this._updatePointLightPerspective(i,a,r,u[m],o,p,T);for(m=0;m<h;m++,o++)this._updateSpotLightPerspective(i,a,r,_[m],o,p,T)}if(l+h>0){for(var v=this._xSlices,g=this._ySlices,E=this._zSlices,y=v*g*4,S=y*E,R=this._clusterPixels,C=R.length,M=this._clusterDatas,D=this._updateMark,x=!0,A=0;A<E;A++)for(var I=0;I<g;I++)for(var L=0;L<v;L++){var P=M[A][I][L],O=4*(L+I*v+A*v*g);if(P.updateMark!==D)R[O]=0,R[O+1]=0;else if(x){var N=P.indices,b=P.pointLightCount,k=P.spotLightCount,B=b+k;if(S+B<C){R[O]=b,R[O+1]=k,R[O+2]=Math.floor(S/y),R[O+3]=S%y;for(m=0;m<B;m++)R[S++]=N[m]}else{B=C-(S+B),b=Math.min(b,B),R[O]=b,R[O+1]=Math.min(k,B-b),R[O+2]=Math.floor(S/y),R[O+3]=S%y;for(m=0;m<B;m++)R[S++]=N[m];x=!1}}}var V=this._clusterTexture.width;this._clusterTexture.setSubPixels(0,0,V,Math.ceil(S/(4*V)),R)}}}]),Cluster}();Se._tempVector30=new o,Se._tempVector31=new o,Se._tempVector32=new o,Se._tempVector33=new o,Se._tempVector34=new o,Se._tempVector35=new o,Se._tempVector36=new o,Se._tempVector37=new o,Se._tempLightBound=new function LightBound(){_classCallCheck(this,LightBound)};var Re=function(){function Plane(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;_classCallCheck(this,Plane),this.normal=e,this.distance=t}return _createClass(Plane,[{key:"normalize",value:function(){var e=this.normal.x,t=this.normal.y,n=this.normal.z,i=1/Math.sqrt(e*e+t*t+n*n);this.normal.x=e*i,this.normal.y=t*i,this.normal.z=n*i,this.distance*=i}},{key:"cloneTo",value:function(e){var t=e;this.normal.cloneTo(t.normal),t.distance=this.distance}},{key:"clone",value:function(){var e=new Plane(new o);return this.cloneTo(e),e}}],[{key:"createPlaneBy3P",value:function(e,t,n,i){var a=t.x-e.x,r=t.y-e.y,o=t.z-e.z,s=n.x-e.x,l=n.y-e.y,u=n.z-e.z,c=r*u-o*l,h=o*s-a*u,_=a*l-r*s,d=1/Math.sqrt(c*c+h*h+_*_),f=c*d,m=h*d,p=_*d,T=i.normal;T.x=f,T.y=m,T.z=p,i.distance=-(f*e.x+m*e.y+p*e.z)}}]),Plane}();Re.PlaneIntersectionType_Back=0,Re.PlaneIntersectionType_Front=1,Re.PlaneIntersectionType_Intersecting=2;var Ce=function Ray(e,t){_classCallCheck(this,Ray),this.origin=e,this.direction=t},Me=function ContainmentType(){_classCallCheck(this,ContainmentType)};Me.Disjoint=0,Me.Contains=1,Me.Intersects=2;var De,xe=function(){function CollisionUtils(){_classCallCheck(this,CollisionUtils)}return _createClass(CollisionUtils,null,[{key:"distancePlaneToPoint",value:function(e,t){return o.dot(e.normal,t)-e.distance}},{key:"distanceBoxToPoint",value:function(e,t){var n=e.min,i=n.x,a=n.y,r=n.z,o=e.max,s=o.x,l=o.y,u=o.z,c=t.x,h=t.y,_=t.z,d=0;return c<i&&(d+=(i-c)*(i-c)),c>s&&(d+=(s-c)*(s-c)),h<a&&(d+=(a-h)*(a-h)),h>l&&(d+=(l-h)*(l-h)),_<r&&(d+=(r-_)*(r-_)),_>u&&(d+=(u-_)*(u-_)),Math.sqrt(d)}},{key:"distanceBoxToBox",value:function(e,t){var n,i=e.min,a=i.x,r=i.y,o=i.z,s=e.max,l=s.x,u=s.y,c=s.z,h=t.min,_=h.x,d=h.y,f=h.z,m=t.max,p=m.x,T=m.y,v=m.z,g=0;return a>p?g+=(n=a-p)*n:_>l&&(g+=(n=_-l)*n),r>T?g+=(n=r-T)*n:d>u&&(g+=(n=d-u)*n),o>v?g+=(n=o-v)*n:f>c&&(g+=(n=f-c)*n),Math.sqrt(g)}},{key:"distanceSphereToPoint",value:function(e,t){var n=Math.sqrt(o.distanceSquared(e.center,t));return n-=e.radius,Math.max(n,0)}},{key:"distanceSphereToSphere",value:function(e,t){var n=Math.sqrt(o.distanceSquared(e.center,t.center));return n-=e.radius+t.radius,Math.max(n,0)}},{key:"intersectsRayAndTriangleRD",value:function(e,t,i,a,r){var o=e.origin,s=o.x,l=o.y,u=o.z,c=e.direction,h=c.x,_=c.y,d=c.z,f=t.x,m=t.y,p=t.z,T=i.x,v=i.y,g=i.z,E=a.x,y=a.y,S=a.z,R=CollisionUtils._tempV30.x,C=CollisionUtils._tempV30.y,M=CollisionUtils._tempV30.z;R=T-f,C=v-m,M=g-p;var D=CollisionUtils._tempV31.x,x=CollisionUtils._tempV31.y,A=CollisionUtils._tempV31.z;D=E-f,x=y-m,A=S-p;var I=CollisionUtils._tempV32.x,L=CollisionUtils._tempV32.y,P=CollisionUtils._tempV32.z,O=R*(I=_*A-d*x)+C*(L=d*D-h*A)+M*(P=h*x-_*D);if(n.isZero(O))return!1;var N=1/O,b=CollisionUtils._tempV33.x,k=CollisionUtils._tempV33.y,w=CollisionUtils._tempV33.z,B=(b=s-f)*I+(k=l-m)*L+(w=u-p)*P;if((B*=N)<0||B>1)return!1;var V=CollisionUtils._tempV34.x,F=CollisionUtils._tempV34.y,U=CollisionUtils._tempV34.z,G=h*(V=k*M-w*C)+_*(F=w*R-b*M)+d*(U=b*C-k*R);if((G*=N)<0||B+G>1)return!1;var H=D*V+x*F+A*U;return!((H*=N)<0)}},{key:"intersectsRayAndTriangleRP",value:function(e,t,n,i,a){return CollisionUtils.intersectsRayAndTriangleRD(e,t,n,i,void 0)?(o.scale(e.direction,void 0,CollisionUtils._tempV30),o.add(e.origin,CollisionUtils._tempV30,a),!0):(a=o._ZERO,!1)}},{key:"intersectsRayAndPoint",value:function(e,t){o.subtract(e.origin,t,CollisionUtils._tempV30);var i=o.dot(CollisionUtils._tempV30,e.direction),a=o.dot(CollisionUtils._tempV30,CollisionUtils._tempV30)-n.zeroTolerance;return!(a>0&&i>0)&&!(i*i-a<0)}},{key:"intersectsRayAndRay",value:function(e,t,i){var a=e.origin,r=a.x,s=a.y,l=a.z,u=e.direction,c=u.x,h=u.y,_=u.z,d=t.origin,f=d.x,m=d.y,p=d.z,T=t.direction,v=T.x,g=T.y,E=T.z;o.cross(u,T,CollisionUtils._tempV30);var y=CollisionUtils._tempV30,S=o.scalarLength(CollisionUtils._tempV30);if(n.isZero(S)&&n.nearEqual(f,r)&&n.nearEqual(m,s)&&n.nearEqual(p,l))return!0;S*=S;var R=f-r,C=m-s,M=p-l,D=v,x=g,A=E,I=y.x,L=y.y,P=y.z,O=R*x*P+C*A*I+M*D*L-R*A*L-C*D*P-M*x*I;D=c,x=h,A=_;var N=O/S;o.scale(u,N,CollisionUtils._tempV30),o.scale(T,N,CollisionUtils._tempV31),o.add(a,CollisionUtils._tempV30,CollisionUtils._tempV32),o.add(d,CollisionUtils._tempV31,CollisionUtils._tempV33);var b=CollisionUtils._tempV32,k=CollisionUtils._tempV33;return!!(n.nearEqual(k.x,b.x)&&n.nearEqual(k.y,b.y)&&n.nearEqual(k.z,b.z))}},{key:"intersectsPlaneAndTriangle",value:function(e,t,n,i){var a=CollisionUtils.intersectsPlaneAndPoint(e,t),r=CollisionUtils.intersectsPlaneAndPoint(e,n),o=CollisionUtils.intersectsPlaneAndPoint(e,i);return a==Re.PlaneIntersectionType_Front&&r==Re.PlaneIntersectionType_Front&&o==Re.PlaneIntersectionType_Front?Re.PlaneIntersectionType_Front:a==Re.PlaneIntersectionType_Back&&r==Re.PlaneIntersectionType_Back&&o==Re.PlaneIntersectionType_Back?Re.PlaneIntersectionType_Back:Re.PlaneIntersectionType_Intersecting}},{key:"intersectsRayAndPlaneRD",value:function(e,t){var i=t.normal,a=o.dot(i,e.direction);if(Math.abs(a)<n.zeroTolerance)return-1;var r=o.dot(i,e.origin),s=(-t.distance-r)/a;if(s<0){if(s<-n.zeroTolerance)return-1;s=0}return s}},{key:"intersectsRayAndPlaneRP",value:function(e,t,n){var i=CollisionUtils.intersectsRayAndPlaneRD(e,t);if(-1==i)return n.setValue(0,0,0),!1;var a=CollisionUtils._tempV30;return o.scale(e.direction,i,a),o.add(e.origin,a,n),!0}},{key:"intersectsRayAndBoxRD",value:function(e,t){var i=e.origin,a=i.x,r=i.y,o=i.z,s=e.direction,l=s.x,u=s.y,c=s.z,h=t.min,_=h.x,d=h.y,f=h.z,m=t.max,p=m.x,T=m.y,v=m.z,g=0,E=n.MaxValue;if(n.isZero(l)){if(a<_||a>p)return-1}else{var y=1/l,S=(_-a)*y,R=(p-a)*y;if(S>R){var C=S;S=R,R=C}if((g=Math.max(S,g))>(E=Math.min(R,E)))return-1}if(n.isZero(u)){if(r<d||r>T)return-1}else{var M=1/u,D=(d-r)*M,x=(T-r)*M;if(D>x){var A=D;D=x,x=A}if((g=Math.max(D,g))>(E=Math.min(x,E)))return-1}if(n.isZero(c)){if(o<f||o>v)return-1}else{var I=1/c,L=(f-o)*I,P=(v-o)*I;if(L>P){var O=L;L=P,P=O}if((g=Math.max(L,g))>(E=Math.min(P,E)))return-1}return g}},{key:"intersectsRayAndBoxRP",value:function(e,t,n){var i=CollisionUtils.intersectsRayAndBoxRD(e,t);return-1===i?(o._ZERO.cloneTo(n),i):(o.scale(e.direction,i,CollisionUtils._tempV30),o.add(e.origin,CollisionUtils._tempV30,CollisionUtils._tempV31),CollisionUtils._tempV31.cloneTo(n),i)}},{key:"intersectsRayAndSphereRD",value:function(e,t){var n=t.radius;o.subtract(e.origin,t.center,CollisionUtils._tempV30);var i=o.dot(CollisionUtils._tempV30,e.direction),a=o.dot(CollisionUtils._tempV30,CollisionUtils._tempV30)-n*n;if(a>0&&i>0)return-1;var r=i*i-a;if(r<0)return-1;var s=-i-Math.sqrt(r);return s<0&&(s=0),s}},{key:"intersectsRayAndSphereRP",value:function(e,t,n){var i=CollisionUtils.intersectsRayAndSphereRD(e,t);return-1===i?(o._ZERO.cloneTo(n),i):(o.scale(e.direction,i,CollisionUtils._tempV30),o.add(e.origin,CollisionUtils._tempV30,CollisionUtils._tempV31),CollisionUtils._tempV31.cloneTo(n),i)}},{key:"intersectsSphereAndTriangle",value:function(e,t,n,i){var a=e.center,r=e.radius;return CollisionUtils.closestPointPointTriangle(a,t,n,i,CollisionUtils._tempV30),o.subtract(CollisionUtils._tempV30,a,CollisionUtils._tempV31),o.dot(CollisionUtils._tempV31,CollisionUtils._tempV31)<=r*r}},{key:"intersectsPlaneAndPoint",value:function(e,t){var n=o.dot(e.normal,t)+e.distance;return n>0?Re.PlaneIntersectionType_Front:n<0?Re.PlaneIntersectionType_Back:Re.PlaneIntersectionType_Intersecting}},{key:"intersectsPlaneAndPlane",value:function(e,t){o.cross(e.normal,t.normal,CollisionUtils._tempV30);var i=o.dot(CollisionUtils._tempV30,CollisionUtils._tempV30);return!n.isZero(i)}},{key:"intersectsPlaneAndPlaneRL",value:function(e,t,i){var a=e.normal,r=t.normal;o.cross(a,r,CollisionUtils._tempV34);var s=o.dot(CollisionUtils._tempV34,CollisionUtils._tempV34);return!n.isZero(s)&&(o.scale(r,e.distance,CollisionUtils._tempV30),o.scale(a,t.distance,CollisionUtils._tempV31),o.subtract(CollisionUtils._tempV30,CollisionUtils._tempV31,CollisionUtils._tempV32),o.cross(CollisionUtils._tempV32,CollisionUtils._tempV34,CollisionUtils._tempV33),o.normalize(CollisionUtils._tempV34,CollisionUtils._tempV34),!0)}},{key:"intersectsPlaneAndBox",value:function(e,t){var n=e.distance,i=e.normal,a=i.x,r=i.y,s=i.z,l=t.min,u=l.x,c=l.y,h=l.z,_=t.max,d=_.x,f=_.y,m=_.z;CollisionUtils._tempV30.x=a>0?u:d,CollisionUtils._tempV30.y=r>0?c:f,CollisionUtils._tempV30.z=s>0?h:m,CollisionUtils._tempV31.x=a>0?d:u,CollisionUtils._tempV31.y=r>0?f:c,CollisionUtils._tempV31.z=s>0?m:h;var p=o.dot(i,CollisionUtils._tempV30);return p+n>0?Re.PlaneIntersectionType_Front:(p=o.dot(i,CollisionUtils._tempV31))+n<0?Re.PlaneIntersectionType_Back:Re.PlaneIntersectionType_Intersecting}},{key:"intersectsPlaneAndSphere",value:function(e,t){var n=t.radius,i=o.dot(e.normal,t.center)+e.distance;return i>n?Re.PlaneIntersectionType_Front:i<-n?Re.PlaneIntersectionType_Back:Re.PlaneIntersectionType_Intersecting}},{key:"intersectsBoxAndBox",value:function(e,t){var n=e.min,i=e.max,a=t.min,r=t.max;return!(n.x>r.x||a.x>i.x)&&(!(n.y>r.y||a.y>i.y)&&!(n.z>r.z||a.z>i.z))}},{key:"intersectsBoxAndSphere",value:function(e,t){var n=t.center,i=t.radius,a=CollisionUtils._tempV30;return o.Clamp(n,e.min,e.max,a),o.distanceSquared(n,a)<=i*i}},{key:"intersectsSphereAndSphere",value:function(e,t){var n=e.radius+t.radius;return o.distanceSquared(e.center,t.center)<=n*n}},{key:"boxContainsPoint",value:function(e,t){var n=e.min,i=e.max;return n.x<=t.x&&i.x>=t.x&&n.y<=t.y&&i.y>=t.y&&n.z<=t.z&&i.z>=t.z?Me.Contains:Me.Disjoint}},{key:"boxContainsBox",value:function(e,t){var n=e.min,i=n.x,a=n.y,r=n.z,o=e.max,s=o.x,l=o.y,u=o.z,c=t.min,h=c.x,_=c.y,d=c.z,f=t.max,m=f.x,p=f.y,T=f.z;return s<h||i>m?Me.Disjoint:l<_||a>p?Me.Disjoint:u<d||r>T?Me.Disjoint:i<=h&&m<=s&&a<=_&&p<=l&&r<=d&&T<=u?Me.Contains:Me.Intersects}},{key:"boxContainsSphere",value:function(e,t){var n=e.min,i=n.x,a=n.y,r=n.z,s=e.max,l=s.x,u=s.y,c=s.z,h=t.center,_=h.x,d=h.y,f=h.z,m=t.radius;return o.Clamp(h,n,s,CollisionUtils._tempV30),o.distanceSquared(h,CollisionUtils._tempV30)>m*m?Me.Disjoint:i+m<=_&&_<=l-m&&l-i>m&&a+m<=d&&d<=u-m&&u-a>m&&r+m<=f&&f<=c-m&&c-r>m?Me.Contains:Me.Intersects}},{key:"sphereContainsPoint",value:function(e,t){return o.distanceSquared(t,e.center)<=e.radius*e.radius?Me.Contains:Me.Disjoint}},{key:"sphereContainsTriangle",value:function(e,t,n,i){var a=CollisionUtils.sphereContainsPoint(e,t),r=CollisionUtils.sphereContainsPoint(e,n),o=CollisionUtils.sphereContainsPoint(e,i);return a==Me.Contains&&r==Me.Contains&&o==Me.Contains?Me.Contains:CollisionUtils.intersectsSphereAndTriangle(e,t,n,i)?Me.Intersects:Me.Disjoint}},{key:"sphereContainsBox",value:function(e,t){var n=e.center,i=n.x,a=n.y,r=n.z,s=e.radius,l=t.min,u=l.x,c=l.y,h=l.z,_=t.max,d=_.x,f=_.y,m=_.z,p=CollisionUtils._tempV30;p.x,p.y,p.z;if(!CollisionUtils.intersectsBoxAndSphere(t,e))return Me.Disjoint;var T=s*s;return i-u,a-f,r-m,o.scalarLengthSquared(CollisionUtils._tempV30)>T?Me.Intersects:(i-d,a-f,r-m,o.scalarLengthSquared(CollisionUtils._tempV30)>T?Me.Intersects:(i-d,a-c,r-m,o.scalarLengthSquared(CollisionUtils._tempV30)>T?Me.Intersects:(i-u,a-c,r-m,o.scalarLengthSquared(CollisionUtils._tempV30)>T?Me.Intersects:(i-u,a-f,r-h,o.scalarLengthSquared(CollisionUtils._tempV30)>T?Me.Intersects:(i-d,a-f,r-h,o.scalarLengthSquared(CollisionUtils._tempV30)>T?Me.Intersects:(i-d,a-c,r-h,o.scalarLengthSquared(CollisionUtils._tempV30)>T?Me.Intersects:(i-u,a-c,r-h,o.scalarLengthSquared(CollisionUtils._tempV30)>T?Me.Intersects:Me.Contains)))))))}},{key:"sphereContainsSphere",value:function(e,t){var n=e.radius,i=t.radius,a=o.distance(e.center,t.center);return n+i<a?Me.Disjoint:n-i<a?Me.Intersects:Me.Contains}},{key:"closestPointPointTriangle",value:function(e,t,n,i,a){o.subtract(n,t,CollisionUtils._tempV30),o.subtract(i,t,CollisionUtils._tempV31),o.subtract(e,t,CollisionUtils._tempV32),o.subtract(e,n,CollisionUtils._tempV33),o.subtract(e,i,CollisionUtils._tempV34);var r=o.dot(CollisionUtils._tempV30,CollisionUtils._tempV32),s=o.dot(CollisionUtils._tempV31,CollisionUtils._tempV32),l=o.dot(CollisionUtils._tempV30,CollisionUtils._tempV33),u=o.dot(CollisionUtils._tempV31,CollisionUtils._tempV33),c=o.dot(CollisionUtils._tempV30,CollisionUtils._tempV34),h=o.dot(CollisionUtils._tempV31,CollisionUtils._tempV34);if(r<=0&&s<=0)t.cloneTo(a);else if(l>=0&&u<=l)n.cloneTo(a);else{var _=r*u-l*s;if(_<=0&&r>=0&&l<=0){var d=r/(r-l);return o.scale(CollisionUtils._tempV30,d,a),void o.add(t,a,a)}if(h>=0&&c<=h)i.cloneTo(a);else{var f=c*s-r*h;if(f<=0&&s>=0&&h<=0){var m=s/(s-h);return o.scale(CollisionUtils._tempV31,m,a),void o.add(t,a,a)}var p=l*h-c*u;if(p<=0&&u-l>=0&&c-h>=0){var T=(u-l)/(u-l+(c-h));return o.subtract(i,n,a),o.scale(a,T,a),void o.add(n,a,a)}var v=1/(p+f+_),g=f*v,E=_*v;o.scale(CollisionUtils._tempV30,g,CollisionUtils._tempV35),o.scale(CollisionUtils._tempV31,E,CollisionUtils._tempV36),o.add(CollisionUtils._tempV35,CollisionUtils._tempV36,a),o.add(t,a,a)}}}},{key:"closestPointPlanePoint",value:function(e,t,n){var i=e.normal,a=o.dot(i,t)-e.distance;o.scale(i,a,CollisionUtils._tempV30),o.subtract(t,CollisionUtils._tempV30,n)}},{key:"closestPointBoxPoint",value:function(e,t,n){o.max(t,e.min,CollisionUtils._tempV30),o.min(CollisionUtils._tempV30,e.max,n)}},{key:"closestPointSpherePoint",value:function(e,t,n){var i=e.center;o.subtract(t,i,n),o.normalize(n,n),o.scale(n,e.radius,n),o.add(n,i,n)}},{key:"closestPointSphereSphere",value:function(e,t,n){var i=e.center;o.subtract(t.center,i,n),o.normalize(n,n),o.scale(n,e.radius,n),o.add(n,i,n)}}]),CollisionUtils}();xe._tempV30=new o,xe._tempV31=new o,xe._tempV32=new o,xe._tempV33=new o,xe._tempV34=new o,xe._tempV35=new o,xe._tempV36=new o,(De=e.FrustumCorner||(e.FrustumCorner={}))[De.FarBottomLeft=0]="FarBottomLeft",De[De.FarTopLeft=1]="FarTopLeft",De[De.FarTopRight=2]="FarTopRight",De[De.FarBottomRight=3]="FarBottomRight",De[De.nearBottomLeft=4]="nearBottomLeft",De[De.nearTopLeft=5]="nearTopLeft",De[De.nearTopRight=6]="nearTopRight",De[De.nearBottomRight=7]="nearBottomRight",De[De.unknown=8]="unknown";var Ae=function(){function BoundFrustum(e){_classCallCheck(this,BoundFrustum),this._matrix=e,this._near=new Re(new o),this._far=new Re(new o),this._left=new Re(new o),this._right=new Re(new o),this._top=new Re(new o),this._bottom=new Re(new o),BoundFrustum.getPlanesFromMatrix(this._matrix,this._near,this._far,this._left,this._right,this._top,this._bottom)}return _createClass(BoundFrustum,[{key:"equalsBoundFrustum",value:function(e){return this._matrix.equalsOtherMatrix(e.matrix)}},{key:"equalsObj",value:function(e){if(e instanceof BoundFrustum){var t=e;return this.equalsBoundFrustum(t)}return!1}},{key:"getPlane",value:function(e){switch(e){case 0:return this._near;case 1:return this._far;case 2:return this._left;case 3:return this._right;case 4:return this._top;case 5:return this._bottom;default:return null}}},{key:"getCorners",value:function(t){BoundFrustum.get3PlaneInterPoint(this._near,this._bottom,this._right,t[e.FrustumCorner.nearBottomRight]),BoundFrustum.get3PlaneInterPoint(this._near,this._top,this._right,t[e.FrustumCorner.nearTopRight]),BoundFrustum.get3PlaneInterPoint(this._near,this._top,this._left,t[e.FrustumCorner.nearTopLeft]),BoundFrustum.get3PlaneInterPoint(this._near,this._bottom,this._left,t[e.FrustumCorner.nearBottomLeft]),BoundFrustum.get3PlaneInterPoint(this._far,this._bottom,this._right,t[e.FrustumCorner.FarBottomRight]),BoundFrustum.get3PlaneInterPoint(this._far,this._top,this._right,t[e.FrustumCorner.FarTopRight]),BoundFrustum.get3PlaneInterPoint(this._far,this._top,this._left,t[e.FrustumCorner.FarTopLeft]),BoundFrustum.get3PlaneInterPoint(this._far,this._bottom,this._left,t[e.FrustumCorner.FarBottomLeft])}},{key:"containsPoint",value:function(e){for(var t=Re.PlaneIntersectionType_Front,n=Re.PlaneIntersectionType_Front,i=0;i<6;i++){switch(i){case 0:n=xe.intersectsPlaneAndPoint(this._near,e);break;case 1:n=xe.intersectsPlaneAndPoint(this._far,e);break;case 2:n=xe.intersectsPlaneAndPoint(this._left,e);break;case 3:n=xe.intersectsPlaneAndPoint(this._right,e);break;case 4:n=xe.intersectsPlaneAndPoint(this._top,e);break;case 5:n=xe.intersectsPlaneAndPoint(this._bottom,e)}switch(n){case Re.PlaneIntersectionType_Back:return Me.Disjoint;case Re.PlaneIntersectionType_Intersecting:t=Re.PlaneIntersectionType_Intersecting}}switch(t){case Re.PlaneIntersectionType_Intersecting:return Me.Intersects;default:return Me.Contains}}},{key:"intersects",value:function(e){var t=e.min,n=e.max,i=t.x,a=t.y,r=t.z,o=n.x,s=n.y,l=n.z,u=this._near.normal;if(this._near.distance+u.x*(u.x<0?i:o)+u.y*(u.y<0?a:s)+u.z*(u.z<0?r:l)<0)return!1;var c=this._left.normal;if(this._left.distance+c.x*(c.x<0?i:o)+c.y*(c.y<0?a:s)+c.z*(c.z<0?r:l)<0)return!1;var h=this._right.normal;if(this._right.distance+h.x*(h.x<0?i:o)+h.y*(h.y<0?a:s)+h.z*(h.z<0?r:l)<0)return!1;var _=this._bottom.normal;if(this._bottom.distance+_.x*(_.x<0?i:o)+_.y*(_.y<0?a:s)+_.z*(_.z<0?r:l)<0)return!1;var d=this._top.normal;if(this._top.distance+d.x*(d.x<0?i:o)+d.y*(d.y<0?a:s)+d.z*(d.z<0?r:l)<0)return!1;var f=this._far.normal;return!(this._far.distance+f.x*(f.x<0?i:o)+f.y*(f.y<0?a:s)+f.z*(f.z<0?r:l)<0)}},{key:"containsBoundBox",value:function(e){for(var t=BoundFrustum._tempV30,n=BoundFrustum._tempV31,i=e.min,a=e.max,r=Me.Contains,o=0;o<6;o++){var s=this.getPlane(o),l=s.normal;if(l.x>=0?(t.x=a.x,n.x=i.x):(t.x=i.x,n.x=a.x),l.y>=0?(t.y=a.y,n.y=i.y):(t.y=i.y,n.y=a.y),l.z>=0?(t.z=a.z,n.z=i.z):(t.z=i.z,n.z=a.z),xe.intersectsPlaneAndPoint(s,t)===Re.PlaneIntersectionType_Back)return Me.Disjoint;xe.intersectsPlaneAndPoint(s,n)===Re.PlaneIntersectionType_Back&&(r=Me.Intersects)}return r}},{key:"containsBoundSphere",value:function(e){for(var t=Re.PlaneIntersectionType_Front,n=Re.PlaneIntersectionType_Front,i=0;i<6;i++){switch(i){case 0:n=xe.intersectsPlaneAndSphere(this._near,e);break;case 1:n=xe.intersectsPlaneAndSphere(this._far,e);break;case 2:n=xe.intersectsPlaneAndSphere(this._left,e);break;case 3:n=xe.intersectsPlaneAndSphere(this._right,e);break;case 4:n=xe.intersectsPlaneAndSphere(this._top,e);break;case 5:n=xe.intersectsPlaneAndSphere(this._bottom,e)}switch(n){case Re.PlaneIntersectionType_Back:return Me.Disjoint;case Re.PlaneIntersectionType_Intersecting:t=Re.PlaneIntersectionType_Intersecting}}switch(t){case Re.PlaneIntersectionType_Intersecting:return Me.Intersects;default:return Me.Contains}}},{key:"matrix",get:function(){return this._matrix},set:function(e){e.cloneTo(this._matrix),BoundFrustum.getPlanesFromMatrix(this._matrix,this._near,this._far,this._left,this._right,this._top,this._bottom)}},{key:"near",get:function(){return this._near}},{key:"far",get:function(){return this._far}},{key:"left",get:function(){return this._left}},{key:"right",get:function(){return this._right}},{key:"top",get:function(){return this._top}},{key:"bottom",get:function(){return this._bottom}}],[{key:"getPlanesFromMatrix",value:function(e,t,n,i,a,r,o){var s=e.elements,l=s[0],u=s[1],c=s[2],h=s[3],_=s[4],d=s[5],f=s[6],m=s[7],p=s[8],T=s[9],v=s[10],g=s[11],E=s[12],y=s[13],S=s[14],R=s[15],C=t.normal;C.x=c,C.y=f,C.z=v,t.distance=S,t.normalize();var M=n.normal;M.x=h-c,M.y=m-f,M.z=g-v,n.distance=R-S,n.normalize();var D=i.normal;D.x=h+l,D.y=m+_,D.z=g+p,i.distance=R+E,i.normalize();var x=a.normal;x.x=h-l,x.y=m-_,x.z=g-p,a.distance=R-E,a.normalize();var A=r.normal;A.x=h-u,A.y=m-d,A.z=g-T,r.distance=R-y,r.normalize();var I=o.normal;I.x=h+u,I.y=m+d,I.z=g+T,o.distance=R+y,o.normalize()}},{key:"get3PlaneInterPoint",value:function(e,t,n,i){var a=e.normal,r=t.normal,s=n.normal;o.cross(r,s,BoundFrustum._tempV30),o.cross(s,a,BoundFrustum._tempV31),o.cross(a,r,BoundFrustum._tempV32);var l=o.dot(a,BoundFrustum._tempV30),u=o.dot(r,BoundFrustum._tempV31),c=o.dot(s,BoundFrustum._tempV32);o.scale(BoundFrustum._tempV30,-e.distance/l,BoundFrustum._tempV33),o.scale(BoundFrustum._tempV31,-t.distance/u,BoundFrustum._tempV34),o.scale(BoundFrustum._tempV32,-n.distance/c,BoundFrustum._tempV35),o.add(BoundFrustum._tempV33,BoundFrustum._tempV34,BoundFrustum._tempV36),o.add(BoundFrustum._tempV35,BoundFrustum._tempV36,i)}}]),BoundFrustum}();Ae._tempV30=new o,Ae._tempV31=new o,Ae._tempV32=new o,Ae._tempV33=new o,Ae._tempV34=new o,Ae._tempV35=new o,Ae._tempV36=new o;var Ie=function(){function Viewport(e,t,n,i){_classCallCheck(this,Viewport),this.minDepth=0,this.maxDepth=1,this.x=e,this.y=t,this.width=n,this.height=i}return _createClass(Viewport,[{key:"project",value:function(e,t,n){o.transformV3ToV4(e,t,n);var i=n.x,a=n.y,r=n.z,s=n.w;1!==s&&(i/=s,a/=s,r/=s),n.x=.5*(i+1)*this.width+this.x,n.y=.5*(1-a)*this.height+this.y,n.z=r*(this.maxDepth-this.minDepth)+this.minDepth}},{key:"unprojectFromMat",value:function(e,t,n){var i=t.elements;n.x=(e.x-this.x)/this.width*2-1,n.y=-((e.y-this.y)/this.height*2-1),n.z=(e.z-this.minDepth)/(this.maxDepth-this.minDepth);var a=n.x*i[3]+n.y*i[7]+n.z*i[11]+i[15];o.transformV3ToV3(n,t,n),1!==a&&(n.x=n.x/a,n.y=n.y/a,n.z=n.z/a)}},{key:"unprojectFromWVP",value:function(e,t,n,i,a){c.multiply(t,n,Viewport._tempMatrix4x4),i&&c.multiply(Viewport._tempMatrix4x4,i,Viewport._tempMatrix4x4),Viewport._tempMatrix4x4.invert(Viewport._tempMatrix4x4),this.unprojectFromMat(e,Viewport._tempMatrix4x4,a)}},{key:"cloneTo",value:function(e){e.x=this.x,e.y=this.y,e.width=this.width,e.height=this.height,e.minDepth=this.minDepth,e.maxDepth=this.maxDepth}}]),Viewport}();Ie._tempMatrix4x4=new c;var Le,Pe=function(){function Picker(){_classCallCheck(this,Picker)}return _createClass(Picker,null,[{key:"calculateCursorRay",value:function(e,t,n,i,a,r){var s=e.x,l=e.y,u=Picker._tempVector30,c=u;c.x=s,c.y=l,c.z=t.minDepth;var h=Picker._tempVector31,_=h;_.x=s,_.y=l,_.z=t.maxDepth;var d=r.origin,f=Picker._tempVector32;t.unprojectFromWVP(u,n,i,a,d),t.unprojectFromWVP(h,n,i,a,f);var m=r.direction;m.x=f.x-d.x,m.y=f.y-d.y,m.z=f.z-d.z,o.normalize(r.direction,r.direction)}},{key:"rayIntersectsTriangle",value:function(e,t,n,i){var a=Picker._tempVector30,r=Picker._tempVector31;o.subtract(n,t,a),o.subtract(i,t,r);var s,l=Picker._tempVector32;if(o.cross(e.direction,r,l),(s=o.dot(a,l))>-Number.MIN_VALUE&&s<Number.MIN_VALUE)return Number.NaN;var u,c=1/s,h=Picker._tempVector33;if(o.subtract(e.origin,t,h),u=o.dot(h,l),(u*=c)<0||u>1)return Number.NaN;var _,d,f=Picker._tempVector34;return o.cross(h,a,f),_=o.dot(e.direction,f),(_*=c)<0||u+_>1?Number.NaN:(d=o.dot(r,f),(d*=c)<0?Number.NaN:d)}}]),Picker}();Pe._tempVector30=new o,Pe._tempVector31=new o,Pe._tempVector32=new o,Pe._tempVector33=new o,Pe._tempVector34=new o,(Le=e.IndexFormat||(e.IndexFormat={}))[Le.UInt8=0]="UInt8",Le[Le.UInt16=1]="UInt16",Le[Le.UInt32=2]="UInt32";var Oe=function(n){function IndexBuffer3D(n,i){var a,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:35044,o=arguments.length>3&&void 0!==arguments[3]&&arguments[3];switch(_classCallCheck(this,IndexBuffer3D),(a=_possibleConstructorReturn(this,_getPrototypeOf(IndexBuffer3D).call(this)))._indexType=n,a._indexCount=i,a._bufferUsage=r,a._bufferType=t.LayaGL.instance.ELEMENT_ARRAY_BUFFER,a._canRead=o,n){case e.IndexFormat.UInt32:a._indexTypeByteCount=4;break;case e.IndexFormat.UInt16:a._indexTypeByteCount=2;break;case e.IndexFormat.UInt8:a._indexTypeByteCount=1;break;default:throw new Error("unidentification index type.")}var s=a._indexTypeByteCount*i,l=t.BufferStateBase._curBindedBufferState;if(a._byteLength=s,l?l._bindedIndexBuffer===_assertThisInitialized(a)?t.LayaGL.instance.bufferData(a._bufferType,s,a._bufferUsage):(l.unBind(),a.bind(),t.LayaGL.instance.bufferData(a._bufferType,s,a._bufferUsage),l.bind()):(a.bind(),t.LayaGL.instance.bufferData(a._bufferType,s,a._bufferUsage)),o)switch(n){case e.IndexFormat.UInt32:a._buffer=new Uint32Array(i);break;case e.IndexFormat.UInt16:a._buffer=new Uint16Array(i);break;case e.IndexFormat.UInt8:a._buffer=new Uint8Array(i)}return a}return _inherits(IndexBuffer3D,t.Buffer),_createClass(IndexBuffer3D,[{key:"_bindForVAO",value:function(){if(!t.BufferStateBase._curBindedBufferState)throw"IndexBuffer3D: must bind current BufferState.";var e=t.LayaGL.instance;e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this._glBuffer)}},{key:"bind",value:function(){if(t.BufferStateBase._curBindedBufferState)throw"IndexBuffer3D: must unbind current BufferState.";if(t.Buffer._bindedIndexBuffer!==this._glBuffer){var e=t.LayaGL.instance;return e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this._glBuffer),t.Buffer._bindedIndexBuffer=this._glBuffer,!0}return!1}},{key:"setData",value:function(n){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:4294967295,o=this._indexTypeByteCount;if(0!==a||4294967295!==r)switch(this._indexType){case e.IndexFormat.UInt32:n=new Uint32Array(n.buffer,a*o,r);break;case e.IndexFormat.UInt16:n=new Uint16Array(n.buffer,a*o,r);break;case e.IndexFormat.UInt8:n=new Uint8Array(n.buffer,a*o,r)}var s=t.BufferStateBase._curBindedBufferState;if(s?s._bindedIndexBuffer===this?t.LayaGL.instance.bufferSubData(this._bufferType,i*o,n):(s.unBind(),this.bind(),t.LayaGL.instance.bufferSubData(this._bufferType,i*o,n),s.bind()):(this.bind(),t.LayaGL.instance.bufferSubData(this._bufferType,i*o,n)),this._canRead)if(0!==i||0!==a||4294967295!==r){var l=this._buffer.length-i;r>l&&(r=l);for(var u=0;u<r;u++)this._buffer[i+u]=n[u]}else this._buffer=n}},{key:"getData",value:function(){if(this._canRead)return this._buffer;throw new Error("Can't read data from VertexBuffer with only write flag!")}},{key:"destroy",value:function(){_get(_getPrototypeOf(IndexBuffer3D.prototype),"destroy",this).call(this),this._buffer=null,this._byteLength=0,this._indexCount=0}},{key:"indexType",get:function(){return this._indexType}},{key:"indexTypeByteCount",get:function(){return this._indexTypeByteCount}},{key:"indexCount",get:function(){return this._indexCount}},{key:"canRead",get:function(){return this._canRead}}]),IndexBuffer3D}(),Ne=function(){function VertexMesh(){_classCallCheck(this,VertexMesh)}return _createClass(VertexMesh,null,[{key:"__init__",value:function(){VertexMesh.instanceWorldMatrixDeclaration=new ae(64,[new re(0,ne.Vector4,VertexMesh.MESH_WORLDMATRIX_ROW0),new re(16,ne.Vector4,VertexMesh.MESH_WORLDMATRIX_ROW1),new re(32,ne.Vector4,VertexMesh.MESH_WORLDMATRIX_ROW2),new re(48,ne.Vector4,VertexMesh.MESH_WORLDMATRIX_ROW3)]),VertexMesh.instanceSimpleAnimatorDeclaration=new ae(16,[new re(0,ne.Vector4,VertexMesh.MESH_SIMPLEANIMATOR)])}},{key:"getVertexDeclaration",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],n=VertexMesh._vertexDeclarationMap[e+(t?"_0":"_1")];if(!n){for(var i=e.split(","),a=0,r=[],o=0,s=i.length;o<s;o++){var l;switch(i[o]){case"POSITION":l=new re(a,ne.Vector3,VertexMesh.MESH_POSITION0),a+=12;break;case"NORMAL":l=new re(a,ne.Vector3,VertexMesh.MESH_NORMAL0),a+=12;break;case"COLOR":l=new re(a,ne.Vector4,VertexMesh.MESH_COLOR0),a+=16;break;case"UV":l=new re(a,ne.Vector2,VertexMesh.MESH_TEXTURECOORDINATE0),a+=8;break;case"UV1":l=new re(a,ne.Vector2,VertexMesh.MESH_TEXTURECOORDINATE1),a+=8;break;case"BLENDWEIGHT":l=new re(a,ne.Vector4,VertexMesh.MESH_BLENDWEIGHT0),a+=16;break;case"BLENDINDICES":t?(l=new re(a,ne.Vector4,VertexMesh.MESH_BLENDINDICES0),a+=16):(l=new re(a,ne.Byte4,VertexMesh.MESH_BLENDINDICES0),a+=4);break;case"TANGENT":l=new re(a,ne.Vector4,VertexMesh.MESH_TANGENT0),a+=16;break;default:throw"VertexMesh: unknown vertex flag."}r.push(l)}n=new ae(a,r),VertexMesh._vertexDeclarationMap[e+(t?"_0":"_1")]=n}return n}}]),VertexMesh}();Ne.MESH_POSITION0=0,Ne.MESH_COLOR0=1,Ne.MESH_TEXTURECOORDINATE0=2,Ne.MESH_NORMAL0=3,Ne.MESH_TANGENT0=4,Ne.MESH_BLENDINDICES0=5,Ne.MESH_BLENDWEIGHT0=6,Ne.MESH_TEXTURECOORDINATE1=7,Ne.MESH_WORLDMATRIX_ROW0=8,Ne.MESH_WORLDMATRIX_ROW1=9,Ne.MESH_WORLDMATRIX_ROW2=10,Ne.MESH_WORLDMATRIX_ROW3=11,Ne.MESH_SIMPLEANIMATOR=12,Ne.MESH_CUSTOME0=12,Ne.MESH_CUSTOME1=13,Ne.MESH_CUSTOME2=14,Ne.MESH_CUSTOME3=15,Ne._vertexDeclarationMap={};var be=function(){function SkyMesh(){_classCallCheck(this,SkyMesh)}return _createClass(SkyMesh,[{key:"_render",value:function(e){}}]),SkyMesh}(),ke=function(n){function SkyBox(){var n;_classCallCheck(this,SkyBox),n=_possibleConstructorReturn(this,_getPrototypeOf(SkyBox).call(this));var i=t.LayaGL.instance,a=new Float32Array([-1,1,-1,1,1,-1,1,1,1,-1,1,1,-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,1]),r=new Uint8Array([0,1,2,2,3,0,4,7,6,6,5,4,0,3,7,7,4,0,1,5,6,6,2,1,3,2,6,6,7,3,0,4,5,5,1,0]),o=Ne.getVertexDeclaration("POSITION");n._vertexBuffer=new te(8*o.vertexStride,i.STATIC_DRAW,!1),n._vertexBuffer.vertexDeclaration=o,n._indexBuffer=new Oe(e.IndexFormat.UInt8,36,i.STATIC_DRAW,!1),n._vertexBuffer.setData(a.buffer),n._indexBuffer.setData(r);var s=new oe;return s.bind(),s.applyVertexBuffer(n._vertexBuffer),s.applyIndexBuffer(n._indexBuffer),s.unBind(),n._bufferState=s,n}return _inherits(SkyBox,be),_createClass(SkyBox,[{key:"_render",value:function(e){var n=t.LayaGL.instance;n.drawElements(n.TRIANGLES,36,n.UNSIGNED_BYTE,0),t.Stat.trianglesFaces+=12,t.Stat.renderBatches++}}],[{key:"__init__",value:function(){SkyBox.instance=new SkyBox}}]),SkyBox}(),we=function(){function SkyRenderer(){_classCallCheck(this,SkyRenderer),this._mesh=ke.instance}return _createClass(SkyRenderer,[{key:"_isAvailable",value:function(){return!(!this._material||!this._mesh)}},{key:"_render",value:function(e){if(this._material&&this._mesh){var n=t.LayaGL.instance,i=e.scene,a=e.cameraShaderValue,r=e.camera,s=ie._SET_RUNTIME_VALUE_MODE_REFERENCE_;t.ILaya.Render.supportWebGLPlusRendering&&ie.setRuntimeValueMode(!1),t.WebGLContext.setCullFace(n,!1),t.WebGLContext.setDepthFunc(n,n.LEQUAL),t.WebGLContext.setDepthMask(n,!1);var l=SkyRenderer._compileDefine;this._material._shaderValues._defineDatas.cloneTo(l);var u=e.shader=this._material._shader.getSubShaderAt(0)._passes[0].withCompile(l),h=u.bind(),_=t.Stat.loopCount!==u._uploadMark,d=u._uploadScene!==i||_;(d||h)&&(u.uploadUniforms(u._sceneUniformParamsMap,i._shaderValues,d),u._uploadScene=i);var f=u._uploadCameraShaderValue!==a||_;if(f||h){var m=SkyRenderer._tempMatrix0,p=SkyRenderer._tempMatrix1;r.viewMatrix.cloneTo(m),r.projectionMatrix.cloneTo(p),m.setTranslationVector(o._ZERO),r.orthographic&&c.createPerspective(r.fieldOfView,r.aspectRatio,r.nearPlane,r.farPlane,p);var T=1/Math.tan(3.1416*r.fieldOfView/180*.5);p.elements[0]=T/r.aspectRatio,p.elements[5]=T,p.elements[10]=1e-6-1,p.elements[11]=-1,p.elements[14]=-0,r._applyViewProject(e,m,p),u.uploadUniforms(u._cameraUniformParamsMap,a,f),u._uploadCameraShaderValue=a}var v=u._uploadMaterial!==this._material||_;(v||h)&&(u.uploadUniforms(u._materialUniformParamsMap,this._material._shaderValues,v),u._uploadMaterial=this._material),this._mesh._bufferState.bind(),this._mesh._render(e),t.ILaya.Render.supportWebGLPlusRendering&&ie.setRuntimeValueMode(s),t.WebGLContext.setDepthFunc(n,n.LESS),t.WebGLContext.setDepthMask(n,!0),r._applyViewProject(e,r.viewMatrix,r.projectionMatrix)}}},{key:"destroy",value:function(){this._material&&(this._material._removeReference(),this._material=null)}},{key:"material",get:function(){return this._material},set:function(e){this._material!==e&&(this._material&&this._material._removeReference(),e&&e._addReference(),this._material=e)}},{key:"mesh",get:function(){return this._mesh},set:function(e){this._mesh!==e&&(this._mesh=e)}}]),SkyRenderer}();we._tempMatrix0=new c,we._tempMatrix1=new c,we._compileDefine=new ee;var Be,Ve=function(e){function BaseCamera(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:.3,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1e3;return _classCallCheck(this,BaseCamera),(e=_possibleConstructorReturn(this,_getPrototypeOf(BaseCamera).call(this)))._skyRenderer=new we,e._forward=new o,e._up=new o,e.clearColor=new a(100/255,149/255,237/255,1),e._shaderValues=new ie(null),e._fieldOfView=60,e._useUserProjectionMatrix=!1,e._orthographic=!1,e._orthographicVerticalSize=10,e.renderingOrder=0,e._nearPlane=t,e._farPlane=n,e.cullingMask=2147483647,e.useOcclusionCulling=!0,e}return _inherits(BaseCamera,ve),_createClass(BaseCamera,[{key:"_sortCamerasByRenderingOrder",value:function(){if(this.displayedInStage)for(var e=this.scene._cameraPool,t=e.length-1,n=0;n<t;n++)if(e[n].renderingOrder>e[t].renderingOrder){var i=e[n];e[n]=e[t],e[t]=i}}},{key:"_calculateProjectionMatrix",value:function(){}},{key:"_onScreenSizeChanged",value:function(){this._calculateProjectionMatrix()}},{key:"_prepareCameraToRender",value:function(){var e=this._shaderValues;this.transform.getForward(this._forward),this.transform.getUp(this._up),e.setVector3(BaseCamera.CAMERAPOS,this.transform.position),e.setVector3(BaseCamera.CAMERADIRECTION,this._forward),e.setVector3(BaseCamera.CAMERAUP,this._up)}},{key:"render",value:function(){arguments.length>0&&void 0!==arguments[0]&&arguments[0],arguments.length>1&&void 0!==arguments[1]&&arguments[1]}},{key:"addLayer",value:function(e){this.cullingMask|=Math.pow(2,e)}},{key:"removeLayer",value:function(e){this.cullingMask&=~Math.pow(2,e)}},{key:"addAllLayers",value:function(){this.cullingMask=2147483647}},{key:"removeAllLayers",value:function(){this.cullingMask=0}},{key:"resetProjectionMatrix",value:function(){this._useUserProjectionMatrix=!1,this._calculateProjectionMatrix()}},{key:"_onActive",value:function(){this._scene._addCamera(this),_get(_getPrototypeOf(BaseCamera.prototype),"_onActive",this).call(this)}},{key:"_onInActive",value:function(){this._scene._removeCamera(this),_get(_getPrototypeOf(BaseCamera.prototype),"_onInActive",this).call(this)}},{key:"_parse",value:function(e,n){_get(_getPrototypeOf(BaseCamera.prototype),"_parse",this).call(this,e,n),this.orthographic=e.orthographic,void 0!==e.orthographicVerticalSize&&(this.orthographicVerticalSize=e.orthographicVerticalSize),void 0!==e.fieldOfView&&(this.fieldOfView=e.fieldOfView),this.nearPlane=e.nearPlane,this.farPlane=e.farPlane;var i=e.clearColor;this.clearColor=new a(i[0],i[1],i[2],i[3]);var r=e.skyboxMaterial;r&&(this._skyRenderer.material=t.Loader.getRes(r.path))}},{key:"destroy",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];this._skyRenderer.destroy(),this._skyRenderer=null,t.Laya.stage.off(t.Event.RESIZE,this,this._onScreenSizeChanged),_get(_getPrototypeOf(BaseCamera.prototype),"destroy",this).call(this,e)}},{key:"_create",value:function(){return new BaseCamera}},{key:"skyRenderer",get:function(){return this._skyRenderer}},{key:"fieldOfView",get:function(){return this._fieldOfView},set:function(e){this._fieldOfView=e,this._calculateProjectionMatrix()}},{key:"nearPlane",get:function(){return this._nearPlane},set:function(e){this._nearPlane=e,this._calculateProjectionMatrix()}},{key:"farPlane",get:function(){return this._farPlane},set:function(e){this._farPlane=e,this._calculateProjectionMatrix()}},{key:"orthographic",get:function(){return this._orthographic},set:function(e){this._orthographic=e,this._calculateProjectionMatrix()}},{key:"orthographicVerticalSize",get:function(){return this._orthographicVerticalSize},set:function(e){this._orthographicVerticalSize=e,this._calculateProjectionMatrix()}},{key:"renderingOrder",get:function(){return this._renderingOrder},set:function(e){this._renderingOrder=e,this._sortCamerasByRenderingOrder()}}]),BaseCamera}();Ve._tempMatrix4x40=new c,Ve.CAMERAPOS=_e.propertyNameToID("u_CameraPos"),Ve.VIEWMATRIX=_e.propertyNameToID("u_View"),Ve.PROJECTMATRIX=_e.propertyNameToID("u_Projection"),Ve.VIEWPROJECTMATRIX=_e.propertyNameToID("u_ViewProjection"),Ve.CAMERADIRECTION=_e.propertyNameToID("u_CameraDirection"),Ve.CAMERAUP=_e.propertyNameToID("u_CameraUp"),Ve.VIEWPORT=_e.propertyNameToID("u_Viewport"),Ve.PROJECTION_PARAMS=_e.propertyNameToID("u_ProjectionParams"),Ve.DEPTHTEXTURE=_e.propertyNameToID("u_CameraDepthTexture"),Ve.DEPTHNORMALSTEXTURE=_e.propertyNameToID("u_CameraDepthNormalsTexture"),Ve.DEPTHZBUFFERPARAMS=_e.propertyNameToID("u_ZBufferParams"),Ve.SHADERDEFINE_DEPTH=_e.getDefineByName("DEPTHMAP"),Ve.SHADERDEFINE_DEPTHNORMALS=_e.getDefineByName("DEPTHNORMALSMAP"),Ve.RENDERINGTYPE_DEFERREDLIGHTING="DEFERREDLIGHTING",Ve.RENDERINGTYPE_FORWARDRENDERING="FORWARDRENDERING",Ve._invertYScaleMatrix=new c(1,0,0,0,0,-1,0,0,0,0,1,0,0,0,0,1),Ve._invertYProjectionMatrix=new c,Ve._invertYProjectionViewMatrix=new c,Ve.CLEARFLAG_SOLIDCOLOR=0,Ve.CLEARFLAG_SKY=1,Ve.CLEARFLAG_DEPTHONLY=2,Ve.CLEARFLAG_NONE=3,(Be=e.ShadowMode||(e.ShadowMode={}))[Be.None=0]="None",Be[Be.Hard=1]="Hard",Be[Be.SoftLow=2]="SoftLow",Be[Be.SoftHigh=3]="SoftHigh";var Fe,Ue=function Scene3DShaderDeclaration(){_classCallCheck(this,Scene3DShaderDeclaration)};(Fe=e.LightType||(e.LightType={}))[Fe.Directional=0]="Directional",Fe[Fe.Spot=1]="Spot",Fe[Fe.Point=2]="Point";var Ge,He,ze=function(t){function LightSprite(){var t;return _classCallCheck(this,LightSprite),(t=_possibleConstructorReturn(this,_getPrototypeOf(LightSprite).call(this)))._shadowMode=e.ShadowMode.None,t._isAlternate=!1,t._shadowResolution=2048,t._shadowDistance=50,t._shadowDepthBias=1,t._shadowNormalBias=1,t._shadowNearPlane=.1,t._shadowStrength=1,t._lightWoldMatrix=new c,t._intensity=1,t._intensityColor=new o,t.color=new o(1,1,1),t._lightmapBakedType=LightSprite.LIGHTMAPBAKEDTYPE_REALTIME,t}return _inherits(LightSprite,ve),_createClass(LightSprite,[{key:"_parse",value:function(e,t){_get(_getPrototypeOf(LightSprite.prototype),"_parse",this).call(this,e,t);var n=e.color;this.color.fromArray(n),this.intensity=e.intensity,this.lightmapBakedType=e.lightmapBakedType}},{key:"_cloneTo",value:function(e,t,n){_get(_getPrototypeOf(LightSprite.prototype),"_cloneTo",this).call(this,e,t,n);var i=e;i.color=this.color.clone(),i.intensity=this.intensity,i.lightmapBakedType=this.lightmapBakedType}},{key:"_addToScene",value:function(){var e=this._scene,t=w._config.maxLightCount;e._lightCount<t?(e._lightCount++,this._addToLightQueue(),this._isAlternate=!1):(e._alternateLights.add(this),this._isAlternate=!0,console.warn("LightSprite:light count has large than maxLightCount,the latest added light will be ignore."))}},{key:"_removeFromScene",value:function(){var e=this._scene;if(this._isAlternate)e._alternateLights.remove(this);else if(e._lightCount--,this._removeFromLightQueue(),e._alternateLights._length>0){var t=e._alternateLights.shift();t._addToLightQueue(),t._isAlternate=!1,e._lightCount++}}},{key:"_addToLightQueue",value:function(){}},{key:"_removeFromLightQueue",value:function(){}},{key:"_onActive",value:function(){_get(_getPrototypeOf(LightSprite.prototype),"_onActive",this).call(this),this.lightmapBakedType!==LightSprite.LIGHTMAPBAKEDTYPE_BAKED&&this._addToScene()}},{key:"_onInActive",value:function(){_get(_getPrototypeOf(LightSprite.prototype),"_onInActive",this).call(this),this.lightmapBakedType!==LightSprite.LIGHTMAPBAKEDTYPE_BAKED&&this._removeFromScene()}},{key:"_create",value:function(){return new LightSprite}},{key:"intensity",get:function(){return this._intensity},set:function(e){this._intensity=e}},{key:"shadowMode",get:function(){return this._shadowMode},set:function(e){this._shadowMode=e}},{key:"shadowDistance",get:function(){return this._shadowDistance},set:function(e){this._shadowDistance=e}},{key:"shadowResolution",get:function(){return this._shadowResolution},set:function(e){this._shadowResolution=e}},{key:"shadowDepthBias",get:function(){return this._shadowDepthBias},set:function(e){this._shadowDepthBias=e}},{key:"shadowNormalBias",get:function(){return this._shadowNormalBias},set:function(e){this._shadowNormalBias=e}},{key:"shadowStrength",get:function(){return this._shadowStrength},set:function(e){this._shadowStrength=e}},{key:"shadowNearPlane",get:function(){return this._shadowNearPlane},set:function(e){this._shadowNearPlane=e}},{key:"lightmapBakedType",get:function(){return this._lightmapBakedType},set:function(e){this._lightmapBakedType!==e&&(this._lightmapBakedType=e,this.activeInHierarchy&&(e!==LightSprite.LIGHTMAPBAKEDTYPE_BAKED?this._addToScene():this._removeFromScene()))}},{key:"lightWorldMatrix",get:function(){var e=this.transform.position,t=this.transform.rotation;return c.createAffineTransformation(e,t,o._ONE,this._lightWoldMatrix),this._lightWoldMatrix}},{key:"diffuseColor",get:function(){return console.log("LightSprite: discard property,please use color property instead."),this.color},set:function(e){console.log("LightSprite: discard property,please use color property instead."),this.color=e}}]),LightSprite}();ze.LIGHTMAPBAKEDTYPE_REALTIME=0,ze.LIGHTMAPBAKEDTYPE_MIXED=1,ze.LIGHTMAPBAKEDTYPE_BAKED=2,(Ge=e.ShadowCascadesMode||(e.ShadowCascadesMode={}))[Ge.NoCascades=0]="NoCascades",Ge[Ge.TwoCascades=1]="TwoCascades",Ge[Ge.FourCascades=2]="FourCascades",function(e){e[e.Near=0]="Near",e[e.Far=1]="Far",e[e.Left=2]="Left",e[e.Right=3]="Right",e[e.Bottom=4]="Bottom",e[e.Top=5]="Top"}(He||(He={}));var We,Xe=function(){function ShadowUtils(){_classCallCheck(this,ShadowUtils)}return _createClass(ShadowUtils,null,[{key:"supportShadow",value:function(){return t.LayaGL.layaGPUInstance._isWebGL2||t.SystemUtils.supportRenderTextureFormat(t.RenderTextureFormat.Depth)}},{key:"init",value:function(){t.LayaGL.layaGPUInstance._isWebGL2?ShadowUtils._shadowTextureFormat=t.RenderTextureFormat.ShadowMap:ShadowUtils._shadowTextureFormat=t.RenderTextureFormat.Depth}},{key:"getTemporaryShadowTexture",value:function(e,n,i){var a=$.createFromPool(e,n,ShadowUtils._shadowTextureFormat,i);return a.filterMode=t.FilterMode.Bilinear,a.wrapModeU=t.WarpMode.Clamp,a.wrapModeV=t.WarpMode.Clamp,a}},{key:"getShadowBias",value:function(t,i,a,r){var o;t._lightType==e.LightType.Directional?o=2/i.elements[0]:t._lightType==e.LightType.Spot?o=Math.tan(.5*t.spotAngle*n.Deg2Rad)*t.range:(console.warn("ShadowUtils:Only spot and directional shadow casters are supported now."),o=0);var s=o/a,l=-t._shadowDepthBias*s,u=-t._shadowNormalBias*s;if(t.shadowMode==e.ShadowMode.SoftHigh){l*=2.5,u*=2.5}r.setValue(l,u,0,0)}},{key:"getCameraFrustumPlanes",value:function(e,t){Ae.getPlanesFromMatrix(e,t[He.Near],t[He.Far],t[He.Left],t[He.Right],t[He.Top],t[He.Bottom])}},{key:"getFarWithRadius",value:function(e,t){return Math.sqrt(e*e/t)}},{key:"getCascadesSplitDistance",value:function(t,n,i,a,r,o,s,l){l[0]=i;var u=a-i,c=Math.tan(.5*r),h=1+c*c*(o*o+1);switch(s){case e.ShadowCascadesMode.NoCascades:l[1]=ShadowUtils.getFarWithRadius(a,h);break;case e.ShadowCascadesMode.TwoCascades:l[1]=ShadowUtils.getFarWithRadius(i+u*t,h),l[2]=ShadowUtils.getFarWithRadius(a,h);break;case e.ShadowCascadesMode.FourCascades:l[1]=ShadowUtils.getFarWithRadius(i+u*n.x,h),l[2]=ShadowUtils.getFarWithRadius(i+u*n.y,h),l[3]=ShadowUtils.getFarWithRadius(i+u*n.z,h),l[4]=ShadowUtils.getFarWithRadius(a,h)}}},{key:"applySliceTransform",value:function(e,t,n,i,a){var r=ShadowUtils._tempMatrix0.elements,o=1/t,s=1/n;r[0]=e.resolution*o,r[5]=e.resolution*s,r[12]=e.offsetX*o,r[13]=e.offsetY*s,r[1]=r[2]=r[2]=r[4]=r[6]=r[7]=r[8]=r[9]=r[11]=r[14]=0,r[10]=r[15]=1;var l=16*i;P._mulMatrixArray(r,a,l,a,l)}},{key:"getDirectionLightShadowCullPlanes",value:function(t,n,i,a,r,s){var l=ShadowUtils._frustumCorners,u=ShadowUtils._backPlaneFaces,c=ShadowUtils._frustumPlaneNeighbors,h=ShadowUtils._frustumTwoPlaneCorners,_=ShadowUtils._edgePlanePoint2,d=s.cullPlanes,f=t[He.Near],m=t[He.Far],p=t[He.Left],T=t[He.Right],v=t[He.Bottom],g=t[He.Top],E=i[n]-a,y=ShadowUtils._adjustNearPlane,S=ShadowUtils._adjustFarPlane;f.normal.cloneTo(y.normal),m.normal.cloneTo(S.normal),y.distance=f.distance-E,S.distance=Math.min(-f.distance+s.sphereCenterZ+s.splitBoundSphere.radius,m.distance),Ae.get3PlaneInterPoint(y,v,T,l[e.FrustumCorner.nearBottomRight]),Ae.get3PlaneInterPoint(y,g,T,l[e.FrustumCorner.nearTopRight]),Ae.get3PlaneInterPoint(y,g,p,l[e.FrustumCorner.nearTopLeft]),Ae.get3PlaneInterPoint(y,v,p,l[e.FrustumCorner.nearBottomLeft]),Ae.get3PlaneInterPoint(S,v,T,l[e.FrustumCorner.FarBottomRight]),Ae.get3PlaneInterPoint(S,g,T,l[e.FrustumCorner.FarTopRight]),Ae.get3PlaneInterPoint(S,g,p,l[e.FrustumCorner.FarTopLeft]),Ae.get3PlaneInterPoint(S,v,p,l[e.FrustumCorner.FarBottomLeft]);for(var R=0,C=0;C<6;C++){var M;switch(C){case He.Near:M=y;break;case He.Far:M=S;break;default:M=t[C]}o.dot(M.normal,r)<0&&(M.cloneTo(d[R]),u[R]=C,R++)}var D=R;for(C=0;C<R;C++)for(var x=u[C],A=c[x],I=0;I<4;I++){for(var L=A[I],P=!0,O=0;O<R;O++)if(L==u[O]){P=!1;break}if(P){var N=h[x][L],b=l[N[0]],k=l[N[1]];o.add(b,r,_),Re.createPlaneBy3P(b,k,_,d[D++])}}s.cullPlaneCount=D}},{key:"getBoundSphereByFrustum",value:function(e,t,n,i,a,r,s){var l,u,c=Math.sqrt(1+i*i)*Math.tan(n/2),h=c*c,_=t-e,d=t+e;h>_/d?(l=t,u=t*c):(l=.5*d*(1+h),u=.5*Math.sqrt(_*_+2*(t*t+e*e)*h+d*d*h*h));var f=s.center;return s.radius=u,o.scale(r,l,f),o.add(a,f,f),l}},{key:"getMaxTileResolutionInAtlas",value:function(e,t,n){for(var i=Math.min(e,t),a=Math.floor(e/i)*Math.floor(t/i);a<n;)i=Math.floor(i>>1),a=Math.floor(e/i)*Math.floor(t/i);return i}},{key:"getDirectionalLightMatrices",value:function(e,t,n,i,a,r,s,l){var u=s.splitBoundSphere,h=u.center,_=u.radius,d=r/2,f=_*d/(d-ShadowUtils.atlasBorderSize),m=2*f,p=r/m,T=m/r,v=Math.ceil(o.dot(h,e)*p)*T,g=Math.ceil(o.dot(h,t)*p)*T,E=o.dot(h,n);h.x=e.x*v+t.x*g+n.x*E,h.y=e.y*v+t.y*g+n.y*E,h.z=e.z*v+t.z*g+n.z*E;var y=s.position,S=s.viewMatrix,R=s.projectionMatrix,C=s.viewProjectMatrix;s.resolution=r,s.offsetX=i%2*r,s.offsetY=Math.floor(i/2)*r,o.scale(n,_+a,y),o.subtract(h,y,y),c.createLookAt(y,h,e,S),c.createOrthoOffCenter(-f,f,-f,f,0,2*_+a,R),c.multiply(R,S,C),P._mulMatrixArray(ShadowUtils._shadowMapScaleOffsetMatrix.elements,C.elements,0,l,16*i)}},{key:"getSpotLightShadowData",value:function(e,t,n,i,a,r){var o=e.position=t.transform.position;e.resolution=n,r.setValue(1/n,1/n,n,n),e.offsetX=0,e.offsetY=0;var s=t.lightWorldMatrix,l=e.viewMatrix,u=e.projectionMatrix,h=e.viewProjectMatrix,_=e.cameraCullInfo.boundFrustum;s.invert(l),c.createPerspective(3.1416*t.spotAngle/180,1,.1,t.range,u),i.y=t.shadowStrength,c.multiply(u,l,h),_.matrix=h,h.cloneTo(a),e.cameraCullInfo.position=o}},{key:"prepareShadowReceiverShaderValues",value:function(e,t,n,i,a,r,o,s,l){if(r.setValue(1/t,1/n,t,n),o.setValue(e._shadowStrength,0,0,0),a>1){for(var u=16*a,c=64;u<c;u++)s[u]=0;for(u=0;u<a;u++){var h=i[u].splitBoundSphere,_=h.center,d=h.radius,f=4*u;l[f]=_.x,l[f+1]=_.y,l[f+2]=_.z,l[f+3]=d*d}for(u=4*a,c=16;u<c;u++)l[u]=0}}}]),ShadowUtils}();Xe._tempMatrix0=new c,Xe._shadowMapScaleOffsetMatrix=new c(.5,0,0,0,0,.5,0,0,0,0,1,0,.5,.5,0,1),Xe._frustumCorners=[new o,new o,new o,new o,new o,new o,new o,new o],Xe._adjustNearPlane=new Re(new o),Xe._adjustFarPlane=new Re(new o),Xe._backPlaneFaces=new Array(5),Xe._edgePlanePoint2=new o,Xe._frustumPlaneNeighbors=[[He.Left,He.Right,He.Top,He.Bottom],[He.Left,He.Right,He.Top,He.Bottom],[He.Near,He.Far,He.Top,He.Bottom],[He.Near,He.Far,He.Top,He.Bottom],[He.Near,He.Far,He.Left,He.Right],[He.Near,He.Far,He.Left,He.Right]],Xe._frustumTwoPlaneCorners=[[[e.FrustumCorner.unknown,e.FrustumCorner.unknown],[e.FrustumCorner.unknown,e.FrustumCorner.unknown],[e.FrustumCorner.nearBottomLeft,e.FrustumCorner.nearTopLeft],[e.FrustumCorner.nearTopRight,e.FrustumCorner.nearBottomRight],[e.FrustumCorner.nearBottomRight,e.FrustumCorner.nearBottomLeft],[e.FrustumCorner.nearTopLeft,e.FrustumCorner.nearTopRight]],[[e.FrustumCorner.unknown,e.FrustumCorner.unknown],[e.FrustumCorner.unknown,e.FrustumCorner.unknown],[e.FrustumCorner.FarTopLeft,e.FrustumCorner.FarBottomLeft],[e.FrustumCorner.FarBottomRight,e.FrustumCorner.FarTopRight],[e.FrustumCorner.FarBottomLeft,e.FrustumCorner.FarBottomRight],[e.FrustumCorner.FarTopRight,e.FrustumCorner.FarTopLeft]],[[e.FrustumCorner.nearTopLeft,e.FrustumCorner.nearBottomLeft],[e.FrustumCorner.FarBottomLeft,e.FrustumCorner.FarTopLeft],[e.FrustumCorner.unknown,e.FrustumCorner.unknown],[e.FrustumCorner.unknown,e.FrustumCorner.unknown],[e.FrustumCorner.nearBottomLeft,e.FrustumCorner.FarBottomLeft],[e.FrustumCorner.FarTopLeft,e.FrustumCorner.nearTopLeft]],[[e.FrustumCorner.nearBottomRight,e.FrustumCorner.nearTopRight],[e.FrustumCorner.FarTopRight,e.FrustumCorner.FarBottomRight],[e.FrustumCorner.unknown,e.FrustumCorner.unknown],[e.FrustumCorner.unknown,e.FrustumCorner.unknown],[e.FrustumCorner.FarBottomRight,e.FrustumCorner.nearBottomRight],[e.FrustumCorner.nearTopRight,e.FrustumCorner.FarTopRight]],[[e.FrustumCorner.nearBottomLeft,e.FrustumCorner.nearBottomRight],[e.FrustumCorner.FarBottomRight,e.FrustumCorner.FarBottomLeft],[e.FrustumCorner.FarBottomLeft,e.FrustumCorner.nearBottomLeft],[e.FrustumCorner.nearBottomRight,e.FrustumCorner.FarBottomRight],[e.FrustumCorner.unknown,e.FrustumCorner.unknown],[e.FrustumCorner.unknown,e.FrustumCorner.unknown]],[[e.FrustumCorner.nearTopRight,e.FrustumCorner.nearTopLeft],[e.FrustumCorner.FarTopLeft,e.FrustumCorner.FarTopRight],[e.FrustumCorner.nearTopLeft,e.FrustumCorner.FarTopLeft],[e.FrustumCorner.FarTopRight,e.FrustumCorner.nearTopRight],[e.FrustumCorner.unknown,e.FrustumCorner.unknown],[e.FrustumCorner.unknown,e.FrustumCorner.unknown]]],Xe.atlasBorderSize=4,(We=e.DepthTextureMode||(e.DepthTextureMode={}))[We.None=0]="None",We[We.Depth=1]="Depth",We[We.DepthNormals=2]="DepthNormals",We[We.MotionVectors=4]="MotionVectors";var Ye,je,Ze=function(){function DepthPass(){_classCallCheck(this,DepthPass),this._zBufferParams=new a}return _createClass(DepthPass,[{key:"update",value:function(n,i){switch(this._viewPort=n.viewport,this._camera=n,i){case e.DepthTextureMode.Depth:n.depthTexture=this._depthTexture=$.createFromPool(this._viewPort.width,this._viewPort.height,t.RenderTextureFormat.Depth,t.RenderTextureDepthFormat.DEPTH_16);break;case e.DepthTextureMode.DepthNormals:n.depthNormalTexture=this._depthNormalsTexture=$.createFromPool(this._viewPort.width,this._viewPort.height,t.RenderTextureFormat.R8G8B8A8,t.RenderTextureDepthFormat.DEPTH_16);break;case e.DepthTextureMode.MotionVectors:break;default:throw"there is UnDefined type of DepthTextureMode"}}},{key:"render",value:function(n,i){var a=n.scene;switch(i){case e.DepthTextureMode.Depth:var r=a._shaderValues;n.pipelineMode="ShadowCaster",ie.setRuntimeValueMode(!1),this._depthTexture._start(),r.setVector(DepthPass.DEFINE_SHADOW_BIAS,DepthPass.SHADOW_BIAS);var o=t.LayaGL.instance,s=this._viewPort.x,l=this._viewPort.y;o.enable(o.SCISSOR_TEST),o.viewport(s,l,this._viewPort.width,this._viewPort.height),o.scissor(s,l,this._viewPort.width,this._viewPort.height),o.clear(o.DEPTH_BUFFER_BIT),a._opaqueQueue._render(n),this._depthTexture._end(),ie.setRuntimeValueMode(!0),this._setupDepthModeShaderValue(i,this._camera),n.pipelineMode=n.configPipeLineMode;break;case e.DepthTextureMode.DepthNormals:r=a._shaderValues;n.pipelineMode="DepthNormal",ie.setRuntimeValueMode(!1),this._depthNormalsTexture._start();o=t.LayaGL.instance,s=this._viewPort.x,l=this._viewPort.y;o.enable(o.SCISSOR_TEST),o.viewport(s,l,this._viewPort.width,this._viewPort.height),o.scissor(s,l,this._viewPort.width,this._viewPort.height),o.clearColor(0,0,1,0),o.clear(o.DEPTH_BUFFER_BIT|o.COLOR_BUFFER_BIT),a._opaqueQueue._render(n),this._depthNormalsTexture._end(),ie.setRuntimeValueMode(!0),this._setupDepthModeShaderValue(i,this._camera),n.pipelineMode=n.configPipeLineMode;break;case e.DepthTextureMode.MotionVectors:break;default:throw"there is UnDefined type of DepthTextureMode"}}},{key:"_setupDepthModeShaderValue",value:function(t,n){switch(t){case e.DepthTextureMode.Depth:var i=n.farPlane,a=n.nearPlane;this._zBufferParams.setValue(1-i/a,i/a,(a-i)/(a*i),1/a),n._shaderValues.setVector(DepthPass.DEFINE_SHADOW_BIAS,DepthPass.SHADOW_BIAS),n._shaderValues.setTexture(DepthPass.DEPTHTEXTURE,this._depthTexture),n._shaderValues.setVector(DepthPass.DEPTHZBUFFERPARAMS,this._zBufferParams);break;case e.DepthTextureMode.DepthNormals:n._shaderValues.setTexture(DepthPass.DEPTHNORMALSTEXTURE,this._depthNormalsTexture);break;case e.DepthTextureMode.MotionVectors:break;default:throw"there is UnDefined type of DepthTextureMode"}}},{key:"cleanUp",value:function(){this._depthTexture&&$.recoverToPool(this._depthTexture),this._depthNormalsTexture&&$.recoverToPool(this._depthNormalsTexture),this._depthTexture=null,this._depthNormalsTexture=null}}]),DepthPass}();Ze.SHADOW_BIAS=new a,Ze.DEFINE_SHADOW_BIAS=_e.propertyNameToID("u_ShadowBias"),Ze.DEPTHTEXTURE=_e.propertyNameToID("u_CameraDepthTexture"),Ze.DEPTHNORMALSTEXTURE=_e.propertyNameToID("u_CameraDepthNormalsTexture"),Ze.DEPTHZBUFFERPARAMS=_e.propertyNameToID("u_ZBufferParams"),(Ye=e.CameraClearFlags||(e.CameraClearFlags={}))[Ye.SolidColor=0]="SolidColor",Ye[Ye.Sky=1]="Sky",Ye[Ye.DepthOnly=2]="DepthOnly",Ye[Ye.Nothing=3]="Nothing",(je=e.CameraEventFlags||(e.CameraEventFlags={}))[je.BeforeForwardOpaque=0]="BeforeForwardOpaque",je[je.BeforeSkyBox=2]="BeforeSkyBox",je[je.BeforeTransparent=4]="BeforeTransparent",je[je.BeforeImageEffect=6]="BeforeImageEffect",je[je.AfterEveryThing=8]="AfterEveryThing";var Qe=function(n){function Camera(){var n,r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.3,s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1e3;return _classCallCheck(this,Camera),(n=_possibleConstructorReturn(this,_getPrototypeOf(Camera).call(this,o,s)))._updateViewMatrix=!0,n._postProcess=null,n._enableHDR=!1,n._viewportParams=new a,n._projectionParams=new a,n._needBuiltInRenderTexture=!1,n._offScreenRenderTexture=null,n._internalRenderTexture=null,n._cameraEventCommandBuffer={},n._clusterPlaneCacheFlag=new i(-1,-1),n._screenOffsetScale=new a,n.enableRender=!0,n.clearFlag=e.CameraClearFlags.SolidColor,n._viewMatrix=new c,n._projectionMatrix=new c,n._projectionViewMatrix=new c,n._viewport=new Ie(0,0,0,0),n._normalizedViewport=new Ie(0,0,1,1),n._aspectRatio=r,n._boundFrustum=new Ae(new c),n._calculateProjectionMatrix(),t.Laya.stage.on(t.Event.RESIZE,_assertThisInitialized(n),n._onScreenSizeChanged),n.transform.on(t.Event.TRANSFORM_CHANGED,_assertThisInitialized(n),n._onTransformChanged),n}return _inherits(Camera,Ve),_createClass(Camera,[{key:"_calculationViewport",value:function(e,t,n){var i=e.x*t,a=e.y*n,r=i+Math.max(e.width*t,0),o=a+Math.max(e.height*n,0),s=Math.ceil(i),l=Math.ceil(a),u=Math.floor(r),c=Math.floor(o),h=s-i>=.5?Math.floor(i):s,_=l-a>=.5?Math.floor(a):l,d=r-u>=.5?Math.ceil(r):u,f=o-c>=.5?Math.ceil(o):c;this._viewport.x=h,this._viewport.y=_,this._viewport.width=d-h,this._viewport.height=f-_}},{key:"_calculateProjectionMatrix",value:function(){if(!this._useUserProjectionMatrix)if(this._orthographic){var e=.5*this.orthographicVerticalSize,t=e*this.aspectRatio;c.createOrthoOffCenter(-t,t,-e,e,this.nearPlane,this.farPlane,this._projectionMatrix)}else c.createPerspective(3.1416*this.fieldOfView/180,this.aspectRatio,this.nearPlane,this.farPlane,this._projectionMatrix)}},{key:"_isLayerVisible",value:function(e){return 0!=(Math.pow(2,e)&this.cullingMask)}},{key:"_onTransformChanged",value:function(e){(e&=f.TRANSFORM_WORLDMATRIX)&&(this._updateViewMatrix=!0)}},{key:"_parse",value:function(e,t){_get(_getPrototypeOf(Camera.prototype),"_parse",this).call(this,e,t);var n=e.clearFlag;void 0!==n&&(this.clearFlag=n);var i=e.viewport;this.normalizedViewport=new Ie(i[0],i[1],i[2],i[3]);var a=e.enableHDR;void 0!==a&&(this.enableHDR=a)}},{key:"_getCanvasWidth",value:function(){return this._offScreenRenderTexture?this._offScreenRenderTexture.width:J.clientWidth}},{key:"_getCanvasHeight",value:function(){return this._offScreenRenderTexture?this._offScreenRenderTexture.height:J.clientHeight}},{key:"_getRenderTexture",value:function(){return this._internalRenderTexture||this._offScreenRenderTexture}},{key:"_needInternalRenderTexture",value:function(){return!!(this._postProcess&&this._postProcess.enable||this._enableHDR||this._needBuiltInRenderTexture)}},{key:"_getRenderTextureFormat",value:function(){return this._enableHDR?t.RenderTextureFormat.R16G16B16A16:t.RenderTextureFormat.R8G8B8}},{key:"_prepareCameraToRender",value:function(){_get(_getPrototypeOf(Camera.prototype),"_prepareCameraToRender",this).call(this);var e=this.viewport;this._viewportParams.setValue(e.x,e.y,e.width,e.height),this._projectionParams.setValue(this._nearPlane,this._farPlane,J._instance.invertY?-1:1,1/this.farPlane),this._shaderValues.setVector(Ve.VIEWPORT,this._viewportParams),this._shaderValues.setVector(Ve.PROJECTION_PARAMS,this._projectionParams)}},{key:"_applyViewProject",value:function(e,t,n){var i,a=this._shaderValues;e.invertY?(c.multiply(Ve._invertYScaleMatrix,n,Ve._invertYProjectionMatrix),c.multiply(Ve._invertYProjectionMatrix,t,Ve._invertYProjectionViewMatrix),n=Ve._invertYProjectionMatrix,i=Ve._invertYProjectionViewMatrix):(c.multiply(n,t,this._projectionViewMatrix),i=this._projectionViewMatrix),e.viewMatrix=t,e.projectionMatrix=n,e.projectionViewMatrix=i,a.setMatrix4x4(Ve.VIEWMATRIX,t),a.setMatrix4x4(Ve.PROJECTMATRIX,n),a.setMatrix4x4(Ve.VIEWPROJECTMATRIX,i)}},{key:"_updateClusterPlaneXY",value:function(){var e=this.fieldOfView,t=this.aspectRatio;if(this._clusterPlaneCacheFlag.x!==e||this._clusterPlaneCacheFlag.y!==t){var n=w._config.lightClusterCount,i=n.x,a=n.y,r=i+1,s=a+1,l=this._clusterXPlanes,u=this._clusterYPlanes;if(!l){l=this._clusterXPlanes=new Array(r),u=this._clusterYPlanes=new Array(s);for(var c=0;c<r;c++)l[c]=new o;for(c=0;c<s;c++)u[c]=new o}var h=Math.tan(this.fieldOfView/2*Math.PI/180),_=this.aspectRatio*h,d=2*h/i,f=2*_/a;for(c=0;c<r;c++){var m=f*c-_,p=1/Math.sqrt(1+m*m);l[c].setValue(p,0,-m*p)}for(c=0;c<s;c++){m=h-d*c;var T=-1/Math.sqrt(1+m*m);u[c].setValue(0,T,-m*T)}this._clusterPlaneCacheFlag.x=e,this._clusterPlaneCacheFlag.y=t}}},{key:"_applyCommandBuffer",value:function(e,n){var i=t.LayaGL.instance,a=this._cameraEventCommandBuffer[e];a&&0!=a.length&&(a.forEach(function(e){e._context=n,e._apply()}),$.currentActive&&$.currentActive._end(),this._internalRenderTexture?this._internalRenderTexture._start():i.bindFramebuffer(i.FRAMEBUFFER,null),i.viewport(0,0,n.viewport.width,n.viewport.height))}},{key:"_renderShadowMap",value:function(t,n){var i,a=t._mainDirectionLight,r=a&&a.shadowMode!==e.ShadowMode.None&&Xe.supportShadow();r?(t._shaderValues.removeDefine(Ue.SHADERDEFINE_SHADOW_SPOT),t._shaderValues.addDefine(Ue.SHADERDEFINE_SHADOW),(i=l.Scene3D._shadowCasterPass).update(this,a,l.ShadowLightType.DirectionLight),i.render(n,t,l.ShadowLightType.DirectionLight)):t._shaderValues.removeDefine(Ue.SHADERDEFINE_SHADOW);var o=t._mainSpotLight,s=o&&o.shadowMode!==e.ShadowMode.None&&Xe.supportShadow();return s?(t._shaderValues.removeDefine(Ue.SHADERDEFINE_SHADOW),t._shaderValues.addDefine(Ue.SHADERDEFINE_SHADOW_SPOT),(i=l.Scene3D._shadowCasterPass).update(this,o,l.ShadowLightType.SpotLight),i.render(n,t,l.ShadowLightType.SpotLight)):t._shaderValues.removeDefine(Ue.SHADERDEFINE_SHADOW_SPOT),r&&t._shaderValues.addDefine(Ue.SHADERDEFINE_SHADOW),s&&t._shaderValues.addDefine(Ue.SHADERDEFINE_SHADOW_SPOT),r||s}},{key:"_preRenderMainPass",value:function(n,i,a,r){n.camera=this,n.cameraShaderValue=this._shaderValues,Camera._updateMark++,i._preRenderScript();var o=t.LayaGL.instance;if(a&&!this._offScreenRenderTexture&&(this.clearFlag==e.CameraClearFlags.DepthOnly||this.clearFlag==e.CameraClearFlags.Nothing))if(this._enableHDR){var s=$.createFromPool(r.width,r.height,t.RenderTextureFormat.R8G8B8,t.RenderTextureDepthFormat.DEPTH_16);s.filterMode=t.FilterMode.Bilinear,t.WebGLContext.bindTexture(o,o.TEXTURE_2D,s._getSource()),o.copyTexSubImage2D(o.TEXTURE_2D,0,0,0,r.x,J.clientHeight-(r.y+r.height),r.width,r.height);var l=fe.create(s,this._internalRenderTexture);l.run(),l.recover(),$.recoverToPool(s)}else t.WebGLContext.bindTexture(o,o.TEXTURE_2D,this._internalRenderTexture._getSource()),o.copyTexSubImage2D(o.TEXTURE_2D,0,0,0,r.x,J.clientHeight-(r.y+r.height),r.width,r.height)}},{key:"_renderMainPass",value:function(n,i,a,r,o,s){var u=t.LayaGL.instance,c=this._getRenderTexture();if(n.viewport=i,this._prepareCameraToRender(),w._config._multiLighting&&Se.instance.update(this,a),a._preCulling(n,this,r,o),0!=this.depthTextureMode&&(this._applyViewProject(n,this.viewMatrix,this._projectionMatrix),this._renderDepthMode(n)),c&&c._start(),this._applyViewProject(n,this.viewMatrix,this._projectionMatrix),a._clear(u,n),this._applyCommandBuffer(e.CameraEventFlags.BeforeForwardOpaque,n),a._renderScene(n,l.Scene3D.SCENERENDERFLAG_RENDERQPAQUE),this._applyCommandBuffer(e.CameraEventFlags.BeforeSkyBox,n),a._renderScene(n,l.Scene3D.SCENERENDERFLAG_SKYBOX),this._applyCommandBuffer(e.CameraEventFlags.BeforeTransparent,n),a._renderScene(n,l.Scene3D.SCENERENDERFLAG_RENDERTRANSPARENT),a._postRenderScript(),this._applyCommandBuffer(e.CameraEventFlags.BeforeImageEffect,n),c&&c._end(),s){if(this._postProcess&&this._postProcess.enable)this._postProcess._render(),this._postProcess._applyPostProcessCommandBuffers();else if(this._enableHDR||this._needBuiltInRenderTexture){var h=this._getCanvasWidth(),_=this._getCanvasHeight();this._screenOffsetScale.setValue(i.x/h,i.y/_,i.width/h,i.height/_);var d=fe.create(this._internalRenderTexture,this._offScreenRenderTexture?this._offScreenRenderTexture:null,this._screenOffsetScale,null,null,0,fe._SCREENTYPE_QUAD,null,!0);d.run(),d.recover()}$.recoverToPool(this._internalRenderTexture)}this._applyCommandBuffer(e.CameraEventFlags.AfterEveryThing,n)}},{key:"_renderDepthMode",value:function(t){var n=this._depthTextureMode;0!=(n&e.DepthTextureMode.Depth)&&(Camera.depthPass.update(this,e.DepthTextureMode.Depth),Camera.depthPass.render(t,e.DepthTextureMode.Depth)),0!=(n&e.DepthTextureMode.DepthNormals)&&(Camera.depthPass.update(this,e.DepthTextureMode.DepthNormals),Camera.depthPass.render(t,e.DepthTextureMode.DepthNormals))}},{key:"_aftRenderMainPass",value:function(e){e&&l.Scene3D._shadowCasterPass.cleanUp(),Camera.depthPass.cleanUp()}},{key:"render",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if(this.activeInHierarchy){var i=this.viewport,a=this._needInternalRenderTexture(),r=J._instance,o=r.scene=this._scene;r.pipelineMode=r.configPipeLineMode,a?(this._internalRenderTexture=$.createFromPool(i.width,i.height,this._getRenderTextureFormat(),t.RenderTextureDepthFormat.DEPTH_16),this._internalRenderTexture.filterMode=t.FilterMode.Bilinear):this._internalRenderTexture=null;var s=this._renderShadowMap(o,r);this._preRenderMainPass(r,o,a,i),this._renderMainPass(r,i,o,e,n,a),this._aftRenderMainPass(s)}}},{key:"viewportPointToRay",value:function(e,t){Pe.calculateCursorRay(e,this.viewport,this._projectionMatrix,this.viewMatrix,null,t)}},{key:"normalizedViewportPointToRay",value:function(e,t){var n=Camera._tempVector20,i=this.viewport;n.x=e.x*i.width,n.y=e.y*i.height,Pe.calculateCursorRay(n,this.viewport,this._projectionMatrix,this.viewMatrix,null,t)}},{key:"worldToViewportPoint",value:function(e,n){c.multiply(this._projectionMatrix,this._viewMatrix,this._projectionViewMatrix),this.viewport.project(e,this._projectionViewMatrix,n),n.x=n.x/t.Laya.stage.clientScaleX,n.y=n.y/t.Laya.stage.clientScaleY}},{key:"worldToNormalizedViewportPoint",value:function(e,n){c.multiply(this._projectionMatrix,this._viewMatrix,this._projectionViewMatrix),this.normalizedViewport.project(e,this._projectionViewMatrix,n),n.x=n.x/t.Laya.stage.clientScaleX,n.y=n.y/t.Laya.stage.clientScaleY}},{key:"convertScreenCoordToOrthographicCoord",value:function(e,n){if(this._orthographic){var i=J.clientWidth,a=J.clientHeight,r=this.orthographicVerticalSize*this.aspectRatio/i,s=this.orthographicVerticalSize/a;return n.x=(-i/2+e.x*t.Laya.stage.clientScaleX)*r,n.y=(a/2-e.y*t.Laya.stage.clientScaleY)*s,n.z=(this.nearPlane-this.farPlane)*(e.z+1)/2-this.nearPlane,o.transformCoordinate(n,this.transform.worldMatrix,n),!0}return!1}},{key:"destroy",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];this._offScreenRenderTexture=null,this.transform.off(t.Event.TRANSFORM_CHANGED,this,this._onTransformChanged),_get(_getPrototypeOf(Camera.prototype),"destroy",this).call(this,e)}},{key:"addCommandBuffer",value:function(e,t){var n=this._cameraEventCommandBuffer[e];n||(n=this._cameraEventCommandBuffer[e]=[]),n.indexOf(t)<0&&n.push(t),t._camera=this}},{key:"removeCommandBuffer",value:function(e,t){var n=this._cameraEventCommandBuffer[e];if(!n)throw"Camera:unknown event.";var i=n.indexOf(t);-1!=i&&n.splice(i,1)}},{key:"removeCommandBuffers",value:function(e){this._cameraEventCommandBuffer[e]&&(this._cameraEventCommandBuffer[e].length=0)}},{key:"_create",value:function(){return new Camera}},{key:"aspectRatio",get:function(){if(0===this._aspectRatio){var e=this.viewport;return e.width/e.height}return this._aspectRatio},set:function(e){if(e<0)throw new Error("Camera: the aspect ratio has to be a positive real number.");this._aspectRatio=e,this._calculateProjectionMatrix()}},{key:"viewport",get:function(){return this._offScreenRenderTexture?this._calculationViewport(this._normalizedViewport,this._offScreenRenderTexture.width,this._offScreenRenderTexture.height):this._calculationViewport(this._normalizedViewport,J.clientWidth,J.clientHeight),this._viewport},set:function(e){var t,n;this._offScreenRenderTexture?(t=this._offScreenRenderTexture.width,n=this._offScreenRenderTexture.height):(t=J.clientWidth,n=J.clientHeight),this._normalizedViewport.x=e.x/t,this._normalizedViewport.y=e.y/n,this._normalizedViewport.width=e.width/t,this._normalizedViewport.height=e.height/n,this._calculationViewport(this._normalizedViewport,t,n),this._calculateProjectionMatrix()}},{key:"normalizedViewport",get:function(){return this._normalizedViewport},set:function(e){var t,n;this._offScreenRenderTexture?(t=this._offScreenRenderTexture.width,n=this._offScreenRenderTexture.height):(t=J.clientWidth,n=J.clientHeight),this._normalizedViewport!==e&&e.cloneTo(this._normalizedViewport),this._calculationViewport(e,t,n),this._calculateProjectionMatrix()}},{key:"viewMatrix",get:function(){if(this._updateViewMatrix){var e=this.transform.getWorldLossyScale(),t=e.x,n=e.y,i=e.z,a=this._viewMatrix.elements;this.transform.worldMatrix.cloneTo(this._viewMatrix),a[0]/=t,a[1]/=t,a[2]/=t,a[4]/=n,a[5]/=n,a[6]/=n,a[8]/=i,a[9]/=i,a[10]/=i,this._viewMatrix.invert(this._viewMatrix),this._updateViewMatrix=!1}return this._viewMatrix}},{key:"projectionMatrix",get:function(){return this._projectionMatrix},set:function(e){this._projectionMatrix=e,this._useUserProjectionMatrix=!0}},{key:"projectionViewMatrix",get:function(){return c.multiply(this.projectionMatrix,this.viewMatrix,this._projectionViewMatrix),this._projectionViewMatrix}},{key:"boundFrustum",get:function(){return this._boundFrustum.matrix=this.projectionViewMatrix,this._boundFrustum}},{key:"renderTarget",get:function(){return this._offScreenRenderTexture},set:function(e){var t=this._offScreenRenderTexture;t!==e&&(t&&(t._isCameraTarget=!1),e&&(e._isCameraTarget=!0),this._offScreenRenderTexture=e,this._calculateProjectionMatrix())}},{key:"postProcess",get:function(){return this._postProcess},set:function(e){this._postProcess=e,e&&e&&e._init(this)}},{key:"enableHDR",get:function(){return this._enableHDR},set:function(e){!e||t.SystemUtils.supportRenderTextureFormat(t.RenderTextureFormat.R16G16B16A16)?this._enableHDR=e:console.warn("Camera:can't enable HDR in this device.")}},{key:"enableBuiltInRenderTexture",get:function(){return this._needBuiltInRenderTexture},set:function(e){this._needBuiltInRenderTexture=e}},{key:"depthTextureMode",get:function(){return this._depthTextureMode},set:function(e){this._depthTextureMode=e}},{key:"depthTexture",get:function(){return this._depthTexture},set:function(e){this._depthTexture=e}},{key:"depthNormalTexture",get:function(){return this._depthNormalsTexture},set:function(e){this._depthNormalsTexture=e}}],[{key:"drawRenderTextureByScene",value:function(e,n,i){e.renderTarget!=i&&(e.renderTarget&&$.recoverToPool(e.renderTarget),e.renderTarget=i);var a=e.viewport,r=e._needInternalRenderTexture(),o=J._instance;n=o.scene=n;o.pipelineMode=o.configPipeLineMode,r?(e._internalRenderTexture=$.createFromPool(a.width,a.height,e._getRenderTextureFormat(),t.RenderTextureDepthFormat.DEPTH_16),e._internalRenderTexture.filterMode=t.FilterMode.Bilinear):e._internalRenderTexture=null;var s=e._renderShadowMap(n,o);return e._preRenderMainPass(o,n,r,a),e._renderMainPass(o,a,n,null,null,r),e._aftRenderMainPass(s),e.renderTarget}}]),Camera}();Qe._tempVector20=new i,Qe._updateMark=0,Qe.depthPass=new Ze;var qe=function(){function RenderElement(){_classCallCheck(this,RenderElement),this.renderSubShader=null,this.renderType=RenderElement.RENDERTYPE_NORMAL}return _createClass(RenderElement,[{key:"getInvertFront",value:function(){return this._transform._isFrontFaceInvert}},{key:"setTransform",value:function(e){this._transform=e}},{key:"setGeometry",value:function(e){this._geometry=e}},{key:"addToOpaqueRenderQueue",value:function(e,t){t.elements.add(this)}},{key:"addToTransparentRenderQueue",value:function(e,t){t.elements.add(this),t.lastTransparentBatched=!1,t.lastTransparentRenderElement=this}},{key:"_update",value:function(e,t,n,i){var a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0;if(this.material){var r=this.material._shader.getSubShaderAt(0);if(this.renderSubShader=null,n)if(i){var o=r.getFlag(i);if(!o)return;for(var s=n._subShaders,l=0,u=s.length;l<u;l++){var c=s[l];if(o===c.getFlag(i)){this.renderSubShader=c;break}}if(!this.renderSubShader)return}else this.renderSubShader=n.getSubShaderAt(a);else this.renderSubShader=r;var h=e._getRenderQueue(this.material.renderQueue);h.isTransparent?this.addToTransparentRenderQueue(t,h):this.addToOpaqueRenderQueue(t,h)}}},{key:"_render",value:function(e){var t,n,i,a=e.invertY,r=Qe._updateMark,o=e.scene,s=e.cameraShaderValue,l=this._transform,u=this._geometry;e.renderElement=this,r!==this.render._updateMark||this.renderType!==this.render._updateRenderType?(this.render._renderUpdate(e,l),this.render._renderUpdateWithCamera(e,l),this.render._updateMark=r,this.render._updateRenderType=this.renderType):this.renderType==RenderElement.RENDERTYPE_INSTANCEBATCH&&(this.render._renderUpdate(e,l),this.render._renderUpdateWithCamera(e,l));var c=e.pipelineMode;if(u._prepareRender(e))for(var h=this.renderSubShader._passes,_=0,d=h.length;_<d;_++){var f=h[_];if(f._pipelineMode===c){var m=RenderElement._compileDefine;o._shaderValues._defineDatas.cloneTo(m),m.addDefineDatas(this.render._shaderValues._defineDatas),m.addDefineDatas(this.material._shaderValues._defineDatas);var p=e.shader=f.withCompile(m),T=p.bind(),v=r!==p._uploadMark,g=p._uploadScene!==o||v;(g||T)&&(p.uploadUniforms(p._sceneUniformParamsMap,o._shaderValues,g),p._uploadScene=o);var E=p._uploadRender!==this.render||p._uploadRenderType!==this.renderType||v;(E||T)&&(p.uploadUniforms(p._spriteUniformParamsMap,this.render._shaderValues,E),p._uploadRender=this.render,p._uploadRenderType=this.renderType);var y=p._uploadCameraShaderValue!==s||v;(y||T)&&(p.uploadUniforms(p._cameraUniformParamsMap,s,y),p._uploadCameraShaderValue=s);var S=p._uploadMaterial!==this.material||v;(S||T)&&(p.uploadUniforms(p._materialUniformParamsMap,this.material._shaderValues,S),p._uploadMaterial=this.material);var R=this.material._shaderValues;t!==this.material||n!==p?(p.uploadRenderStateBlendDepth(R),p.uploadRenderStateFrontFace(R,a,this.getInvertFront()),t=this.material,n=p,i=this.render):i!==this.render&&(p.uploadRenderStateFrontFace(R,a,this.getInvertFront()),i=this.render),u._render(e),p._uploadMark=r}}this.renderType!==RenderElement.RENDERTYPE_NORMAL&&this.render._revertBatchRenderUpdate(e)}},{key:"destroy",value:function(){this._transform=null,this._geometry=null,this.material=null,this.render=null}}]),RenderElement}();qe.RENDERTYPE_NORMAL=0,qe.RENDERTYPE_STATICBATCH=1,qe.RENDERTYPE_INSTANCEBATCH=2,qe.RENDERTYPE_VERTEXBATCH=3,qe._compileDefine=new ee;var Ke=function(e){function DrawRenderCMD(){return _classCallCheck(this,DrawRenderCMD),_possibleConstructorReturn(this,_getPrototypeOf(DrawRenderCMD).apply(this,arguments))}return _inherits(DrawRenderCMD,de),_createClass(DrawRenderCMD,[{key:"_elementRender",value:function(e,t){var n,i,a,r=t.invertY,o=Qe._updateMark,s=t.scene;this._render._scene=t.scene;var l=t.cameraShaderValue,u=e._transform,c=e._geometry;t.renderElement=e,o!==e.render._updateMark||e.renderType!==e.render._updateRenderType?(e.render._renderUpdate(t,u),e.render._renderUpdateWithCamera(t,u),e.render._updateMark=o,e.render._updateRenderType=e.renderType):e.renderType==qe.RENDERTYPE_INSTANCEBATCH&&(e.render._renderUpdate(t,u),e.render._renderUpdateWithCamera(t,u));var h=t.pipelineMode;if(c._prepareRender(t))for(var _=e.renderSubShader._passes,d=0,f=_.length;d<f;d++){var m=_[d];if(m._pipelineMode===h){var p=DrawRenderCMD._compileDefine;s._shaderValues._defineDatas.cloneTo(p),p.addDefineDatas(e.render._shaderValues._defineDatas),p.addDefineDatas(this._material._shaderValues._defineDatas);var T=t.shader=m.withCompile(p),v=T.bind(),g=o!==T._uploadMark,E=T._uploadScene!==s||g;(E||v)&&(T.uploadUniforms(T._sceneUniformParamsMap,s._shaderValues,E),T._uploadScene=s);var y=T._uploadRender!==e.render||T._uploadRenderType!==e.renderType||g;(y||v)&&(T.uploadUniforms(T._spriteUniformParamsMap,e.render._shaderValues,y),T._uploadRender=e.render,T._uploadRenderType=e.renderType);var S=T._uploadCameraShaderValue!==l||g;(S||v)&&(T.uploadUniforms(T._cameraUniformParamsMap,l,S),T._uploadCameraShaderValue=l);var R=T._uploadMaterial!==this._material||g;(R||v)&&(T.uploadUniforms(T._materialUniformParamsMap,this._material._shaderValues,R),T._uploadMaterial=this._material);var C=this._material._shaderValues;n!==this._material||i!==T?(T.uploadRenderStateBlendDepth(C),T.uploadRenderStateFrontFace(C,r,e.getInvertFront()),n=this._material,i=T,a=e.render):a!==e.render&&(T.uploadRenderStateFrontFace(C,r,e.getInvertFront()),a=e.render),c._render(t),T._uploadMark=o}}e.renderType!==qe.RENDERTYPE_NORMAL&&e.render._revertBatchRenderUpdate(t)}},{key:"run",value:function(){if(!this._material)throw"This render command material cannot be empty";this.setContext(this._commandBuffer._context);for(var e=this._context,t=(e.scene,this._render._renderElements),n=0,i=t.length;n<i;n++){var a=t[n];this._renderElementUpdate(a),this._elementRender(a,e)}}},{key:"_renderElementUpdate",value:function(e){this._material&&(e.renderSubShader=this._material._shader.getSubShaderAt(this._subShaderIndex))}},{key:"recover",value:function(){DrawRenderCMD._pool.push(this)}}],[{key:"create",value:function(e,t,n,i){var a;return(a=DrawRenderCMD._pool.length>0?DrawRenderCMD._pool.pop():new DrawRenderCMD)._render=e,a._material=t,a._subShaderIndex=n,a._commandBuffer=i,a}}]),DrawRenderCMD}();Ke._pool=[],Ke._compileDefine=new ee;var Je=function(t){function SetGlobalShaderDataCMD(){var e;return _classCallCheck(this,SetGlobalShaderDataCMD),(e=_possibleConstructorReturn(this,_getPrototypeOf(SetGlobalShaderDataCMD).apply(this,arguments)))._nameID=0,e._value=null,e._dataType=-1,e}return _inherits(SetGlobalShaderDataCMD,de),_createClass(SetGlobalShaderDataCMD,[{key:"run",value:function(){var t=this._commandBuffer._camera.scene._shaderValues;switch(this._dataType){case e.ShaderDataType.Int:t.setInt(this._nameID,this._value);break;case e.ShaderDataType.Number:t.setNumber(this._nameID,this._value);break;case e.ShaderDataType.Bool:t.setBool(this._nameID,this._value);break;case e.ShaderDataType.Matrix4x4:t.setMatrix4x4(this._nameID,this._value);break;case e.ShaderDataType.Quaternion:t.setQuaternion(this._nameID,this._value);break;case e.ShaderDataType.Texture:t.setTexture(this._nameID,this._value);break;case e.ShaderDataType.Vector4:t.setVector(this._nameID,this._value);break;case e.ShaderDataType.Vector2:t.setVector2(this._nameID,this._value);break;case e.ShaderDataType.Vector3:t.setVector3(this._nameID,this._value);break;case e.ShaderDataType.Buffer:t.setBuffer(this._nameID,this._value);break;default:throw"no type shaderValue on this CommendBuffer"}}},{key:"recover",value:function(){SetGlobalShaderDataCMD._pool.push(this),this._nameID=0,this._value=null,this._dataType=-1}}],[{key:"create",value:function(e,t,n,i){var a;return(a=SetGlobalShaderDataCMD._pool.length>0?SetGlobalShaderDataCMD._pool.pop():new SetGlobalShaderDataCMD)._nameID=e,a._value=t,a._dataType=n,a._commandBuffer=i,a}}]),SetGlobalShaderDataCMD}();Je._pool=[];var $e=function MeshSprite3DShaderDeclaration(){_classCallCheck(this,MeshSprite3DShaderDeclaration)},et=function(e){function DrawMeshInstancedCMD(){var e;_classCallCheck(this,DrawMeshInstancedCMD),(e=_possibleConstructorReturn(this,_getPrototypeOf(DrawMeshInstancedCMD).call(this)))._renderShaderValue=new ie(null);var n=t.LayaGL.instance;return e._instanceWorldMatrixData=new Float32Array(16*DrawMeshInstancedCMD.maxInstanceCount),e._instanceWorldMatrixBuffer=new te(4*e._instanceWorldMatrixData.length,n.DYNAMIC_DRAW),e._instanceWorldMatrixBuffer.vertexDeclaration=Ne.instanceWorldMatrixDeclaration,e}return _inherits(DrawMeshInstancedCMD,de),_createClass(DrawMeshInstancedCMD,[{key:"_setInstanceBuffer",value:function(){var e=this._instanceBufferState=new oe;e.bind(),e.applyVertexBuffer(this._mesh._vertexBuffer),e.applyInstanceVertexBuffer(this._instanceWorldMatrixBuffer);var t=this._instanceProperty._propertyMap;for(var n in t)e.applyInstanceVertexBuffer(t[n]._vertexBuffer);e.applyIndexBuffer(this._mesh._indexBuffer),e.unBind()}},{key:"_updateWorldMatrixBuffer",value:function(){for(var e=this._instanceWorldMatrixData,t=this._drawnums,n=0;n<t;n++)e.set(this._matrixs[n].elements,16*n);var i=this._instanceWorldMatrixBuffer;i.orphanStorage(),i.setData(e.buffer,0,0,64*t)}},{key:"_render",value:function(e){var n=t.LayaGL.instance,i=this._drawnums,a=e._indexCount;this._instanceBufferState.bind(),t.LayaGL.layaGPUInstance.drawElementsInstanced(n.TRIANGLES,a,n.UNSIGNED_SHORT,2*e._indexStart,i),t.Stat.renderBatches++,t.Stat.trianglesFaces+=a*i/3}},{key:"run",value:function(){var e=this._material._shader.getSubShaderAt(this._subShaderIndex);this.setContext(this._commandBuffer._context);var t=this._context,n=t.invertY,i=t.scene,a=t.cameraShaderValue,r=t.pipelineMode;this._renderShaderValue.addDefine($e.SHADERDEFINE_GPU_INSTANCE);for(var o=e._passes,s=0,l=o.length;s<l;s++){var u=o[s];if(u._pipelineMode===r){var c=DrawMeshInstancedCMD._compileDefine;i._shaderValues._defineDatas.cloneTo(c),c.addDefineDatas(this._renderShaderValue._defineDatas),c.addDefineDatas(this._material._shaderValues._defineDatas);var h=t.shader=u.withCompile(c);h.bind(),h.uploadUniforms(h._sceneUniformParamsMap,i._shaderValues,!0),h.uploadUniforms(h._spriteUniformParamsMap,this._renderShaderValue,!0),h.uploadUniforms(h._cameraUniformParamsMap,a,!0);var _=this._material._shaderValues;h.uploadUniforms(h._materialUniformParamsMap,_,!0),h.uploadRenderStateBlendDepth(_),h.uploadRenderStateFrontFace(_,n,!1)}}var d=this._instanceProperty._propertyMap;for(var f in d)d[f].updateVertexBufferData(this._drawnums);var m,p=this._mesh._subMeshes;if(-1==this._subMeshIndex)for(var T=0,v=p.length;T<v;T++)(m=p[T])._prepareRender(t)&&this._render(m);else(m=this._mesh._subMeshes[this._subMeshIndex])._prepareRender(t)&&this._render(m)}},{key:"setWorldMatrix",value:function(e){if(e.length<this._drawnums)throw"worldMatrixArray length is less then drawnums";this._matrixs=e,this._matrixs&&this._updateWorldMatrixBuffer()}},{key:"setDrawNums",value:function(e){if(this._matrixs&&this._matrixs.length<e)throw"worldMatrixArray length is less then drawnums";this._drawnums=e,this._matrixs&&this._updateWorldMatrixBuffer()}},{key:"recover",value:function(){DrawMeshInstancedCMD._pool.push(this),this._renderShaderValue.clearDefine(),this._renderShaderValue._initData(),this._instanceBufferState.destroy(),this._instanceBufferState=null}}],[{key:"create",value:function(e,t,n,i,a,r,o,s){var l;if(n&&n.length>1024||o>DrawMeshInstancedCMD.maxInstanceCount)throw"the number of renderings exceeds the maximum number of merges";return(l=DrawMeshInstancedCMD._pool.length>0?DrawMeshInstancedCMD._pool.pop():new DrawMeshInstancedCMD)._mesh=e,l._matrixs=n,l._material=i,l._subMeshIndex=t,l._subShaderIndex=a,l._commandBuffer=s,l._instanceProperty=r,l._drawnums=o,n||l._updateWorldMatrixBuffer(),l._setInstanceBuffer(),l}}]),DrawMeshInstancedCMD}();et._pool=[],et._compileDefine=new ee,et.maxInstanceCount=1024;var tt=function(){function CommandBuffer(){_classCallCheck(this,CommandBuffer),this._camera=null,this._commands=[]}return _createClass(CommandBuffer,[{key:"_apply",value:function(){for(var e=0,t=this._commands.length;e<t;e++)this._commands[e].run()}},{key:"setShaderDataTexture",value:function(t,n,i){this._commands.push(Te.create(t,n,i,e.ShaderDataType.Texture,this))}},{key:"setGlobalTexture",value:function(t,n){this._commands.push(Je.create(t,n,e.ShaderDataType.Texture,this))}},{key:"setShaderDataVector",value:function(t,n,i){this._commands.push(Te.create(t,n,i,e.ShaderDataType.Vector4,this))}},{key:"setGlobalVector",value:function(t,n){this._commands.push(Je.create(t,n,e.ShaderDataType.Vector4,this))}},{key:"setShaderDataVector3",value:function(t,n,i){this._commands.push(Te.create(t,n,i,e.ShaderDataType.Vector3,this))}},{key:"setGlobalVector3",value:function(t,n){this._commands.push(Je.create(t,n,e.ShaderDataType.Vector3,this))}},{key:"setShaderDataVector2",value:function(t,n,i){this._commands.push(Te.create(t,n,i,e.ShaderDataType.Vector2,this))}},{key:"setGlobalVector2",value:function(t,n){this._commands.push(Je.create(t,n,e.ShaderDataType.Vector2,this))}},{key:"setShaderDataNumber",value:function(t,n,i){this._commands.push(Te.create(t,n,i,e.ShaderDataType.Number,this))}},{key:"setGlobalNumber",value:function(t,n){this._commands.push(Je.create(t,n,e.ShaderDataType.Number,this))}},{key:"setShaderDataInt",value:function(t,n,i){this._commands.push(Te.create(t,n,i,e.ShaderDataType.Int,this))}},{key:"setGlobalInt",value:function(t,n){this._commands.push(Je.create(t,n,e.ShaderDataType.Int,this))}},{key:"setShaderDataMatrix",value:function(t,n,i){this._commands.push(Te.create(t,n,i,e.ShaderDataType.Matrix4x4,this))}},{key:"setGlobalMatrix",value:function(t,n){this._commands.push(Je.create(t,n,e.ShaderDataType.Matrix4x4,this))}},{key:"blitScreenQuad",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,r=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0;this._commands.push(fe.create(e,t,n,i,a,r,fe._SCREENTYPE_QUAD,this))}},{key:"blitScreenQuadByMaterial",value:function(e,t){var n,i,a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0;r&&(n=r._shader,i=r.shaderData),this._commands.push(fe.create(e,t,a,n,i,o,fe._SCREENTYPE_QUAD,this))}},{key:"blitScreenTriangle",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,r=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,o=arguments.length>6&&void 0!==arguments[6]&&arguments[6];this._commands.push(fe.create(e,t,n,i,a,r,fe._SCREENTYPE_TRIANGLE,this,o))}},{key:"setRenderTarget",value:function(e){this._commands.push(pe.create(e))}},{key:"clearRenderTarget",value:function(e,t,n){var i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1;this._commands.push(Ee.create(e,t,n,i,this))}},{key:"drawMesh",value:function(e,t,n,i,a){this._commands.push(ge.create(e,t,n,i,a,this))}},{key:"drawRender",value:function(e,t,n){this._commands.push(Ke.create(e,t,n,this))}},{key:"drawMeshInstance",value:function(e,n,i,a,r,o,s){if(!t.LayaGL.layaGPUInstance.supportInstance())return null;var l=et.create(e,n,i,a,r,o,s,this);return this._commands.push(l),l}},{key:"clear",value:function(){for(var e=0,t=this._commands.length;e<t;e++)this._commands[e].recover();this._commands.length=0}}]),CommandBuffer}(),nt=function PostProcessRenderContext(){_classCallCheck(this,PostProcessRenderContext),this.source=null,this.destination=null,this.camera=null,this.compositeShaderData=null,this.command=null,this.deferredReleaseTextures=[]},it=function(){function PostProcess(){_classCallCheck(this,PostProcess),this._compositeShader=_e.find("PostProcessComposite"),this._compositeShaderData=new ie,this._effects=[],this._enable=!0,this._context=null,this._context=new nt,this._context.compositeShaderData=this._compositeShaderData,this._context.command=new tt}return _createClass(PostProcess,[{key:"_init",value:function(e){this._context.camera=e,this._context.command._camera=e}},{key:"_render",value:function(){var e=ie._SET_RUNTIME_VALUE_MODE_REFERENCE_;t.ILaya.Render.supportWebGLPlusRendering&&ie.setRuntimeValueMode(!1);var n=this._context.camera,i=n.viewport,a=n._internalRenderTexture,r=a;this._context.command.clear(),this._context.source=r,this._context.destination=a,this._context.compositeShaderData.clearDefine(),this._context.compositeShaderData.setTexture(PostProcess.SHADERVALUE_AUTOEXPOSURETEX,t.Texture2D.whiteTexture);for(var o=0,s=this._effects.length;o<s;o++)this._effects[o].render(this._context);this._compositeShaderData.addDefine(PostProcess.SHADERDEFINE_FINALPASS);var l=n._offScreenRenderTexture,u=l||null;this._context.destination=u;var c=n._getCanvasWidth(),h=n._getCanvasHeight();n._screenOffsetScale.setValue(i.x/c,i.y/h,i.width/c,i.height/h),this._context.command.blitScreenTriangle(this._context.source,u,n._screenOffsetScale,this._compositeShader,this._compositeShaderData,0,!0),$.recoverToPool(r);var _=this._context.deferredReleaseTextures;for(o=0,s=_.length;o<s;o++)$.recoverToPool(_[o]);_.length=0,t.ILaya.Render.supportWebGLPlusRendering&&ie.setRuntimeValueMode(e)}},{key:"addEffect",value:function(e){this._effects.push(e)}},{key:"removeEffect",value:function(e){var t=this._effects.indexOf(e);-1!==t&&this._effects.splice(t,1)}},{key:"_applyPostProcessCommandBuffers",value:function(){this._context.command._apply()}},{key:"enable",get:function(){return this._enable},set:function(e){this._enable=e}}],[{key:"__init__",value:function(){PostProcess.SHADERDEFINE_BLOOM_LOW=_e.getDefineByName("BLOOM_LOW"),PostProcess.SHADERDEFINE_BLOOM=_e.getDefineByName("BLOOM"),PostProcess.SHADERDEFINE_FINALPASS=_e.getDefineByName("FINALPASS")}}]),PostProcess}();it.SHADERVALUE_MAINTEX=_e.propertyNameToID("u_MainTex"),it.SHADERVALUE_BLOOMTEX=_e.propertyNameToID("u_BloomTex"),it.SHADERVALUE_AUTOEXPOSURETEX=_e.propertyNameToID("u_AutoExposureTex"),it.SHADERVALUE_BLOOM_DIRTTEX=_e.propertyNameToID("u_Bloom_DirtTex"),it.SHADERVALUE_BLOOMTEX_TEXELSIZE=_e.propertyNameToID("u_BloomTex_TexelSize"),it.SHADERVALUE_BLOOM_DIRTTILEOFFSET=_e.propertyNameToID("u_Bloom_DirtTileOffset"),it.SHADERVALUE_BLOOM_SETTINGS=_e.propertyNameToID("u_Bloom_Settings"),it.SHADERVALUE_BLOOM_COLOR=_e.propertyNameToID("u_Bloom_Color");var at=function(e){function AnimationTransform3D(e){var t;return _classCallCheck(this,AnimationTransform3D),(t=_possibleConstructorReturn(this,_getPrototypeOf(AnimationTransform3D).call(this)))._owner=e,t._children=[],t._localMatrix=new Float32Array(16),t._localPosition=new o,t._localRotation=new u,t._localScale=new o,t._worldMatrix=new Float32Array(16),t._localQuaternionUpdate=!1,t._locaEulerlUpdate=!1,t._localUpdate=!1,t._worldUpdate=!0,t}return _inherits(AnimationTransform3D,t.EventDispatcher),_createClass(AnimationTransform3D,[{key:"_getlocalMatrix",value:function(){return this._localUpdate&&(P._createAffineTransformationArray(this._localPosition,this._localRotation,this._localScale,this._localMatrix),this._localUpdate=!1),this._localMatrix}},{key:"_onWorldTransform",value:function(){if(!this._worldUpdate){this._worldUpdate=!0,this.event(t.Event.TRANSFORM_CHANGED);for(var e=0,n=this._children.length;e<n;e++)this._children[e]._onWorldTransform()}}},{key:"getWorldMatrix",value:function(){if(this._worldUpdate){if(null!=this._parent)P.matrix4x4MultiplyFFF(this._parent.getWorldMatrix(),this._getlocalMatrix(),this._worldMatrix);else{var e=this._worldMatrix;e[1]=e[2]=e[3]=e[4]=e[6]=e[7]=e[8]=e[9]=e[11]=e[12]=e[13]=e[14]=0,e[0]=e[5]=e[10]=e[15]=1}this._worldUpdate=!1}return this._worldMatrix}},{key:"setParent",value:function(e){if(this._parent!==e){if(this._parent){var t=this._parent._children,n=t.indexOf(this);t.splice(n,1)}e&&(e._children.push(this),e&&this._onWorldTransform()),this._parent=e}}},{key:"localPosition",get:function(){return this._localPosition},set:function(e){this._localPosition=e,this._localUpdate=!0,this._onWorldTransform()}},{key:"localRotation",get:function(){if(this._localQuaternionUpdate){var e=this._localRotationEuler;u.createFromYawPitchRoll(e.y/AnimationTransform3D._angleToRandin,e.x/AnimationTransform3D._angleToRandin,e.z/AnimationTransform3D._angleToRandin,this._localRotation),this._localQuaternionUpdate=!1}return this._localRotation},set:function(e){this._localRotation=e,this._locaEulerlUpdate=!0,this._localQuaternionUpdate=!1,this._localUpdate=!0,this._onWorldTransform()}},{key:"localScale",get:function(){return this._localScale},set:function(e){this._localScale=e,this._localUpdate=!0,this._onWorldTransform()}},{key:"localRotationEuler",get:function(){if(this._locaEulerlUpdate){this._localRotation.getYawPitchRoll(AnimationTransform3D._tempVector3);var e=AnimationTransform3D._tempVector3,t=this._localRotationEuler;t.x=e.y*AnimationTransform3D._angleToRandin,t.y=e.x*AnimationTransform3D._angleToRandin,t.z=e.z*AnimationTransform3D._angleToRandin,this._locaEulerlUpdate=!1}return this._localRotationEuler},set:function(e){this._localRotationEuler=e,this._locaEulerlUpdate=!1,this._localQuaternionUpdate=!0,this._localUpdate=!0,this._onWorldTransform()}}]),AnimationTransform3D}();at._tempVector3=new o,at._angleToRandin=180/Math.PI;var rt=function(){function AnimationNode(){_classCallCheck(this,AnimationNode),this._parent=null,this.name=null,this._worldMatrixIndex=0,this._children=[],this.transform=new at(this)}return _createClass(AnimationNode,[{key:"addChild",value:function(e){e._parent=this,e.transform.setParent(this.transform),this._children.push(e)}},{key:"removeChild",value:function(e){var t=this._children.indexOf(e);-1!==t&&this._children.splice(t,1)}},{key:"getChildByName",value:function(e){for(var t=0,n=this._children.length;t<n;t++){var i=this._children[t];if(i.name===e)return i}return null}},{key:"getChildByIndex",value:function(e){return this._children[e]}},{key:"getChildCount",value:function(){return this._children.length}},{key:"cloneTo",value:function(e){var t=e;t.name=this.name;for(var n=0,i=this._children.length;n<i;n++){var a=this._children[n],r=a.clone();t.addChild(r);var o=a.transform,s=r.transform,l=s.localPosition,u=s.localRotation,c=s.localScale;o.localPosition.cloneTo(l),o.localRotation.cloneTo(u),o.localScale.cloneTo(c),s.localPosition=l,s.localRotation=u,s.localScale=c}}},{key:"clone",value:function(){var e=new AnimationNode;return this.cloneTo(e),e}},{key:"_cloneNative",value:function(e,t,n,i,a,r,o){var s=o._nativeCurCloneCount;a[s]=r;var l=new AnimationNode;return l._worldMatrixIndex=s,this._cloneToNative(l,e,t,n,i,a,s,o),l}},{key:"_cloneToNative",value:function(e,t,n,i,a,r,o,s){var l=e;l.name=this.name;for(var u=0,c=this._children.length;u<c;u++){var h=this._children[u];s._nativeCurCloneCount++;var _=h._cloneNative(t,n,i,a,r,o,s);l.addChild(_);var d=h.transform,f=_.transform,m=f.localPosition,p=f.localRotation,T=f.localScale;d.localPosition.cloneTo(m),d.localRotation.cloneTo(p),d.localScale.cloneTo(T),f.localPosition=m,f.localRotation=p,f.localScale=T}}}]),AnimationNode}(),ot=function(e){function Avatar(){var e;return _classCallCheck(this,Avatar),(e=_possibleConstructorReturn(this,_getPrototypeOf(Avatar).call(this)))._nativeNodeCount=0,e._nativeCurCloneCount=0,e}return _inherits(Avatar,t.Resource),_createClass(Avatar,[{key:"_initCloneToAnimator",value:function(e,t){t._avatarNodeMap[e.name]=e;for(var n=0,i=e.getChildCount();n<i;n++)this._initCloneToAnimator(e.getChildByIndex(n),t)}},{key:"_parseNode",value:function(e,t){var n=e.props.name;t.name=n;var i=e.props,a=t.transform,r=a.localPosition,o=a.localRotation,s=a.localScale;r.fromArray(i.translate),o.fromArray(i.rotation),s.fromArray(i.scale),a.localPosition=r,a.localRotation=o,a.localScale=s;for(var l=e.child,u=0,c=l.length;u<c;u++){var h=l[u],_=new rt;t.addChild(_),this._parseNode(h,_)}}},{key:"_cloneDatasToAnimator",value:function(e){var t;t=this._rootNode.clone();var n=this._rootNode.transform,i=t.transform,a=i.localPosition,r=i.localRotation,o=i.localScale;n.localPosition.cloneTo(a),n.localRotation.cloneTo(r),n.localScale.cloneTo(o),i.localPosition=a,i.localRotation=r,i.localScale=o,e._avatarNodeMap={},this._initCloneToAnimator(t,e)}},{key:"cloneTo",value:function(e){var t=e,n=this._rootNode.clone();t._rootNode=n}},{key:"clone",value:function(){var e=new Avatar;return this.cloneTo(e),e}},{key:"_cloneDatasToAnimatorNative",value:function(e){var t=new Float32Array(3*this._nativeNodeCount),n=new Float32Array(4*this._nativeNodeCount),i=new Float32Array(3*this._nativeNodeCount),a=new Float32Array(16*this._nativeNodeCount),r=new Int16Array(this._nativeNodeCount);e._animationNodeLocalPositions=t,e._animationNodeLocalRotations=n,e._animationNodeLocalScales=i,e._animationNodeWorldMatrixs=a,e._animationNodeParentIndices=r,this._nativeCurCloneCount=0;var o=this._rootNode._cloneNative(t,n,i,a,r,-1,this),s=this._rootNode.transform,l=o.transform,u=l.localPosition,c=l.localRotation,h=l.localScale;s.localPosition.cloneTo(u),s.localRotation.cloneTo(c),s.localScale.cloneTo(h),l.localPosition=u,l.localRotation=c,l.localScale=h,e._avatarNodeMap={},this._initCloneToAnimator(o,e)}}],[{key:"_parse",value:function(e){arguments.length>1&&void 0!==arguments[1]&&arguments[1],arguments.length>2&&void 0!==arguments[2]&&arguments[2];var t=new Avatar;if(t._rootNode=new rt,e.version){var n=e.rootNode;n&&t._parseNode(n,t._rootNode)}return t}},{key:"load",value:function(e,n){t.ILaya.loader.create(e,n,null,Avatar.AVATAR)}}]),Avatar}();ot.AVATAR="AVATAR";var st=function(e){function Material(){var e;return _classCallCheck(this,Material),(e=_possibleConstructorReturn(this,_getPrototypeOf(Material).call(this)))._shaderValues=new ie(_assertThisInitialized(e)),e.renderQueue=Material.RENDERQUEUE_OPAQUE,e._alphaTest=!1,e}return _inherits(Material,t.Resource),_createClass(Material,[{key:"_removeTetxureReference",value:function(){var e=this._shaderValues.getData();for(var n in e){var i=e[n];i&&i instanceof t.BaseTexture&&i._removeReference()}}},{key:"_disposeResource",value:function(){this._referenceCount>0&&this._removeTetxureReference(),this._shaderValues=null}},{key:"_addReference",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;_get(_getPrototypeOf(Material.prototype),"_addReference",this).call(this,e);var n=this._shaderValues.getData();for(var i in n){var a=n[i];a&&a instanceof t.BaseTexture&&a._addReference()}}},{key:"_removeReference",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;_get(_getPrototypeOf(Material.prototype),"_removeReference",this).call(this,e),this._removeTetxureReference()}},{key:"setShaderName",value:function(e){if(this._shader=_e.find(e),!this._shader)throw new Error("BaseMaterial: unknown shader name.")}},{key:"cloneTo",value:function(e){var t=e;t.name=this.name,t.renderQueue=this.renderQueue,this._shaderValues.cloneTo(t._shaderValues)}},{key:"clone",value:function(){var e=new Material;return this.cloneTo(e),e}},{key:"shaderData",get:function(){return this._shaderValues}},{key:"alphaTestValue",get:function(){return this._shaderValues.getNumber(Material.ALPHATESTVALUE)},set:function(e){this._shaderValues.setNumber(Material.ALPHATESTVALUE,e)}},{key:"alphaTest",get:function(){return this._alphaTest},set:function(e){this._alphaTest=e,e?this._shaderValues.addDefine(Material.SHADERDEFINE_ALPHATEST):this._shaderValues.removeDefine(Material.SHADERDEFINE_ALPHATEST)}},{key:"depthWrite",get:function(){return this._shaderValues.getBool(Material.DEPTH_WRITE)},set:function(e){this._shaderValues.setBool(Material.DEPTH_WRITE,e)}},{key:"cull",get:function(){return this._shaderValues.getInt(Material.CULL)},set:function(e){this._shaderValues.setInt(Material.CULL,e)}},{key:"blend",get:function(){return this._shaderValues.getInt(Material.BLEND)},set:function(e){this._shaderValues.setInt(Material.BLEND,e)}},{key:"blendSrc",get:function(){return this._shaderValues.getInt(Material.BLEND_SRC)},set:function(e){this._shaderValues.setInt(Material.BLEND_SRC,e)}},{key:"blendDst",get:function(){return this._shaderValues.getInt(Material.BLEND_DST)},set:function(e){this._shaderValues.setInt(Material.BLEND_DST,e)}},{key:"depthTest",get:function(){return this._shaderValues.getInt(Material.DEPTH_TEST)},set:function(e){this._shaderValues.setInt(Material.DEPTH_TEST,e)}},{key:"_defineDatas",get:function(){return this._shaderValues._defineDatas}}],[{key:"load",value:function(e,n){t.Laya.loader.create(e,n,null,Material.MATERIAL)}},{key:"__initDefine__",value:function(){Material.SHADERDEFINE_ALPHATEST=_e.getDefineByName("ALPHATEST")}},{key:"_parse",value:function(e){arguments.length>1&&void 0!==arguments[1]&&arguments[1],arguments.length>2&&void 0!==arguments[2]&&arguments[2];var n,r=e,s=r.props,l=s.type,u=t.ClassUtils.getRegClass(l);if(!u)throw"_getSprite3DHierarchyInnerUrls 错误: "+e.type+" 不是类";switch(n=new u,r.version){case"LAYAMATERIAL:01":case"LAYAMATERIAL:02":var c,h;for(var _ in s)switch(_){case"type":break;case"vectors":var d=s[_];for(c=0,h=d.length;c<h;c++){var f=d[c],m=f.value;switch(m.length){case 2:n[f.name]=new i(m[0],m[1]);break;case 3:n[f.name]=new o(m[0],m[1],m[2]);break;case 4:n[f.name]=new a(m[0],m[1],m[2],m[3]);break;default:throw new Error("BaseMaterial:unkonwn color length.")}}break;case"textures":var p=s[_];for(c=0,h=p.length;c<h;c++){var T=p[c],v=T.path;v&&(n[T.name]=t.Loader.getRes(v))}break;case"defines":var g=s[_];for(c=0,h=g.length;c<h;c++){var E=_e.getDefineByName(g[c]);n._shaderValues.addDefine(E)}break;case"renderStates":var y=s[_][0],S=n;S.blend=y.blend,S.cull=y.cull,S.depthTest=y.depthTest,S.depthWrite=y.depthWrite,S.blendSrc=y.srcBlend,S.blendDst=y.dstBlend;break;case"cull":n.cull=s[_];break;case"blend":n.blend=s[_];break;case"depthWrite":n.depthWrite=s[_];break;case"srcBlend":n.blendSrc=s[_];break;case"dstBlend":n.blendDst=s[_];break;default:n[_]=s[_]}break;default:throw new Error("BaseMaterial:unkonwn version.")}return n}}]),Material}();st.MATERIAL="MATERIAL",st.RENDERQUEUE_OPAQUE=2e3,st.RENDERQUEUE_ALPHATEST=2450,st.RENDERQUEUE_TRANSPARENT=3e3,st.ALPHATESTVALUE=_e.propertyNameToID("u_AlphaTestValue"),st.CULL=_e.propertyNameToID("s_Cull"),st.BLEND=_e.propertyNameToID("s_Blend"),st.BLEND_SRC=_e.propertyNameToID("s_BlendSrc"),st.BLEND_DST=_e.propertyNameToID("s_BlendDst"),st.DEPTH_TEST=_e.propertyNameToID("s_DepthTest"),st.DEPTH_WRITE=_e.propertyNameToID("s_DepthWrite");var lt=function(){function BaseMaterial(){_classCallCheck(this,BaseMaterial)}return _createClass(BaseMaterial,null,[{key:"load",value:function(e,n){t.Laya.loader.create(e,n,null,st.MATERIAL)}},{key:"__initDefine__",value:function(){BaseMaterial.SHADERDEFINE_ALPHATEST=st.SHADERDEFINE_ALPHATEST}}]),BaseMaterial}();lt.MATERIAL="MATERIAL",lt.RENDERQUEUE_OPAQUE=2e3,lt.RENDERQUEUE_ALPHATEST=2450,lt.RENDERQUEUE_TRANSPARENT=3e3,lt.ALPHATESTVALUE=_e.propertyNameToID("u_AlphaTestValue");var ut=function(){function RenderState(){_classCallCheck(this,RenderState),this.cull=RenderState.CULL_BACK,this.blend=RenderState.BLEND_DISABLE,this.srcBlend=RenderState.BLENDPARAM_ONE,this.dstBlend=RenderState.BLENDPARAM_ZERO,this.srcBlendRGB=RenderState.BLENDPARAM_ONE,this.dstBlendRGB=RenderState.BLENDPARAM_ZERO,this.srcBlendAlpha=RenderState.BLENDPARAM_ONE,this.dstBlendAlpha=RenderState.BLENDPARAM_ZERO,this.blendConstColor=new a(1,1,1,1),this.blendEquation=RenderState.BLENDEQUATION_ADD,this.blendEquationRGB=RenderState.BLENDEQUATION_ADD,this.blendEquationAlpha=RenderState.BLENDEQUATION_ADD,this.depthTest=RenderState.DEPTHTEST_LEQUAL,this.depthWrite=!0}return _createClass(RenderState,[{key:"cloneTo",value:function(e){var t=e;t.cull=this.cull,t.blend=this.blend,t.srcBlend=this.srcBlend,t.dstBlend=this.dstBlend,t.srcBlendRGB=this.srcBlendRGB,t.dstBlendRGB=this.dstBlendRGB,t.srcBlendAlpha=this.srcBlendAlpha,t.dstBlendAlpha=this.dstBlendAlpha,this.blendConstColor.cloneTo(t.blendConstColor),t.blendEquation=this.blendEquation,t.blendEquationRGB=this.blendEquationRGB,t.blendEquationAlpha=this.blendEquationAlpha,t.depthTest=this.depthTest,t.depthWrite=this.depthWrite}},{key:"clone",value:function(){var e=new RenderState;return this.cloneTo(e),e}}]),RenderState}();ut.CULL_NONE=0,ut.CULL_FRONT=1,ut.CULL_BACK=2,ut.BLEND_DISABLE=0,ut.BLEND_ENABLE_ALL=1,ut.BLEND_ENABLE_SEPERATE=2,ut.BLENDPARAM_ZERO=0,ut.BLENDPARAM_ONE=1,ut.BLENDPARAM_SRC_COLOR=768,ut.BLENDPARAM_ONE_MINUS_SRC_COLOR=769,ut.BLENDPARAM_DST_COLOR=774,ut.BLENDPARAM_ONE_MINUS_DST_COLOR=775,ut.BLENDPARAM_SRC_ALPHA=770,ut.BLENDPARAM_ONE_MINUS_SRC_ALPHA=771,ut.BLENDPARAM_DST_ALPHA=772,ut.BLENDPARAM_ONE_MINUS_DST_ALPHA=773,ut.BLENDPARAM_SRC_ALPHA_SATURATE=776,ut.BLENDEQUATION_ADD=32774,ut.BLENDEQUATION_SUBTRACT=32778,ut.BLENDEQUATION_REVERSE_SUBTRACT=32779,ut.DEPTHTEST_OFF=0,ut.DEPTHTEST_NEVER=512,ut.DEPTHTEST_LESS=513,ut.DEPTHTEST_EQUAL=514,ut.DEPTHTEST_LEQUAL=515,ut.DEPTHTEST_GREATER=516,ut.DEPTHTEST_NOTEQUAL=517,ut.DEPTHTEST_GEQUAL=518,ut.DEPTHTEST_ALWAYS=519;var ct=function(e){function BlinnPhongMaterial(){var e;_classCallCheck(this,BlinnPhongMaterial),(e=_possibleConstructorReturn(this,_getPrototypeOf(BlinnPhongMaterial).call(this)))._enableVertexColor=!1,e._enableTransmission=!1,e.setShaderName("BLINNPHONG"),e._albedoIntensity=1,e._albedoColor=new a(1,1,1,1);var t=e._shaderValues;return t.setVector(BlinnPhongMaterial.ALBEDOCOLOR,new a(1,1,1,1)),t.setVector(BlinnPhongMaterial.MATERIALSPECULAR,new a(1,1,1,1)),t.setNumber(BlinnPhongMaterial.SHININESS,.078125),t.setNumber(st.ALPHATESTVALUE,.5),t.setVector(BlinnPhongMaterial.TILINGOFFSET,new a(1,1,0,0)),e._enableLighting=!0,e.renderMode=BlinnPhongMaterial.RENDERMODE_OPAQUE,e}return _inherits(BlinnPhongMaterial,st),_createClass(BlinnPhongMaterial,[{key:"clone",value:function(){var e=new BlinnPhongMaterial;return this.cloneTo(e),e}},{key:"cloneTo",value:function(e){_get(_getPrototypeOf(BlinnPhongMaterial.prototype),"cloneTo",this).call(this,e);var t=e;t._enableLighting=this._enableLighting,t._albedoIntensity=this._albedoIntensity,t._enableVertexColor=this._enableVertexColor,this._albedoColor.cloneTo(t._albedoColor)}},{key:"_ColorR",get:function(){return this._albedoColor.x},set:function(e){this._albedoColor.x=e,this.albedoColor=this._albedoColor}},{key:"_ColorG",get:function(){return this._albedoColor.y},set:function(e){this._albedoColor.y=e,this.albedoColor=this._albedoColor}},{key:"_ColorB",get:function(){return this._albedoColor.z},set:function(e){this._albedoColor.z=e,this.albedoColor=this._albedoColor}},{key:"_ColorA",get:function(){return this._albedoColor.w},set:function(e){this._albedoColor.w=e,this.albedoColor=this._albedoColor}},{key:"_Color",get:function(){return this._shaderValues.getVector(BlinnPhongMaterial.ALBEDOCOLOR)},set:function(e){this.albedoColor=e}},{key:"_SpecColorR",get:function(){return this._shaderValues.getVector(BlinnPhongMaterial.MATERIALSPECULAR).x},set:function(e){this._shaderValues.getVector(BlinnPhongMaterial.MATERIALSPECULAR).x=e}},{key:"_SpecColorG",get:function(){return this._shaderValues.getVector(BlinnPhongMaterial.MATERIALSPECULAR).y},set:function(e){this._shaderValues.getVector(BlinnPhongMaterial.MATERIALSPECULAR).y=e}},{key:"_SpecColorB",get:function(){return this._shaderValues.getVector(BlinnPhongMaterial.MATERIALSPECULAR).z},set:function(e){this._shaderValues.getVector(BlinnPhongMaterial.MATERIALSPECULAR).z=e}},{key:"_SpecColorA",get:function(){return this._shaderValues.getVector(BlinnPhongMaterial.MATERIALSPECULAR).w},set:function(e){this._shaderValues.getVector(BlinnPhongMaterial.MATERIALSPECULAR).w=e}},{key:"_SpecColor",get:function(){return this._shaderValues.getVector(BlinnPhongMaterial.MATERIALSPECULAR)},set:function(e){this.specularColor=e}},{key:"_AlbedoIntensity",get:function(){return this._albedoIntensity},set:function(e){if(this._albedoIntensity!==e){var t=this._shaderValues.getVector(BlinnPhongMaterial.ALBEDOCOLOR);a.scale(this._albedoColor,e,t),this._albedoIntensity=e,this._shaderValues.setVector(BlinnPhongMaterial.ALBEDOCOLOR,t)}}},{key:"_Shininess",get:function(){return this._shaderValues.getNumber(BlinnPhongMaterial.SHININESS)},set:function(e){e=Math.max(0,Math.min(1,e)),this._shaderValues.setNumber(BlinnPhongMaterial.SHININESS,e)}},{key:"_MainTex_STX",get:function(){return this._shaderValues.getVector(BlinnPhongMaterial.TILINGOFFSET).x},set:function(e){var t=this._shaderValues.getVector(BlinnPhongMaterial.TILINGOFFSET);t.x=e,this.tilingOffset=t}},{key:"_MainTex_STY",get:function(){return this._shaderValues.getVector(BlinnPhongMaterial.TILINGOFFSET).y},set:function(e){var t=this._shaderValues.getVector(BlinnPhongMaterial.TILINGOFFSET);t.y=e,this.tilingOffset=t}},{key:"_MainTex_STZ",get:function(){return this._shaderValues.getVector(BlinnPhongMaterial.TILINGOFFSET).z},set:function(e){var t=this._shaderValues.getVector(BlinnPhongMaterial.TILINGOFFSET);t.z=e,this.tilingOffset=t}},{key:"_MainTex_STW",get:function(){return this._shaderValues.getVector(BlinnPhongMaterial.TILINGOFFSET).w},set:function(e){var t=this._shaderValues.getVector(BlinnPhongMaterial.TILINGOFFSET);t.w=e,this.tilingOffset=t}},{key:"_MainTex_ST",get:function(){return this._shaderValues.getVector(BlinnPhongMaterial.TILINGOFFSET)},set:function(e){this.tilingOffset=e}},{key:"_Cutoff",get:function(){return this.alphaTestValue},set:function(e){this.alphaTestValue=e}},{key:"renderMode",set:function(e){switch(e){case BlinnPhongMaterial.RENDERMODE_OPAQUE:this.alphaTest=!1,this.renderQueue=st.RENDERQUEUE_OPAQUE,this.depthWrite=!0,this.cull=ut.CULL_BACK,this.blend=ut.BLEND_DISABLE,this.depthTest=ut.DEPTHTEST_LESS;break;case BlinnPhongMaterial.RENDERMODE_CUTOUT:this.renderQueue=st.RENDERQUEUE_ALPHATEST,this.alphaTest=!0,this.depthWrite=!0,this.cull=ut.CULL_BACK,this.blend=ut.BLEND_DISABLE,this.depthTest=ut.DEPTHTEST_LESS;break;case BlinnPhongMaterial.RENDERMODE_TRANSPARENT:this.renderQueue=st.RENDERQUEUE_TRANSPARENT,this.alphaTest=!1,this.depthWrite=!1,this.cull=ut.CULL_BACK,this.blend=ut.BLEND_ENABLE_ALL,this.blendSrc=ut.BLENDPARAM_SRC_ALPHA,this.blendDst=ut.BLENDPARAM_ONE_MINUS_SRC_ALPHA,this.depthTest=ut.DEPTHTEST_LESS;break;default:throw new Error("Material:renderMode value error.")}}},{key:"enableVertexColor",get:function(){return this._enableVertexColor},set:function(e){this._enableVertexColor=e,e?this._shaderValues.addDefine(BlinnPhongMaterial.SHADERDEFINE_ENABLEVERTEXCOLOR):this._shaderValues.removeDefine(BlinnPhongMaterial.SHADERDEFINE_ENABLEVERTEXCOLOR)}},{key:"tilingOffsetX",get:function(){return this._MainTex_STX},set:function(e){this._MainTex_STX=e}},{key:"tilingOffsetY",get:function(){return this._MainTex_STY},set:function(e){this._MainTex_STY=e}},{key:"tilingOffsetZ",get:function(){return this._MainTex_STZ},set:function(e){this._MainTex_STZ=e}},{key:"tilingOffsetW",get:function(){return this._MainTex_STW},set:function(e){this._MainTex_STW=e}},{key:"tilingOffset",get:function(){return this._shaderValues.getVector(BlinnPhongMaterial.TILINGOFFSET)},set:function(e){e?this._shaderValues.setVector(BlinnPhongMaterial.TILINGOFFSET,e):this._shaderValues.getVector(BlinnPhongMaterial.TILINGOFFSET).setValue(1,1,0,0)}},{key:"albedoColorR",get:function(){return this._ColorR},set:function(e){this._ColorR=e}},{key:"albedoColorG",get:function(){return this._ColorG},set:function(e){this._ColorG=e}},{key:"albedoColorB",get:function(){return this._ColorB},set:function(e){this._ColorB=e}},{key:"albedoColorA",get:function(){return this._ColorA},set:function(e){this._ColorA=e}},{key:"albedoColor",get:function(){return this._albedoColor},set:function(e){var t=this._shaderValues.getVector(BlinnPhongMaterial.ALBEDOCOLOR);a.scale(e,this._albedoIntensity,t),this._albedoColor=e,this._shaderValues.setVector(BlinnPhongMaterial.ALBEDOCOLOR,t)}},{key:"albedoIntensity",get:function(){return this._albedoIntensity},set:function(e){this._AlbedoIntensity=e}},{key:"specularColorR",get:function(){return this._SpecColorR},set:function(e){this._SpecColorR=e}},{key:"specularColorG",get:function(){return this._SpecColorG},set:function(e){this._SpecColorG=e}},{key:"specularColorB",get:function(){return this._SpecColorB},set:function(e){this._SpecColorB=e}},{key:"specularColorA",get:function(){return this._SpecColorA},set:function(e){this._SpecColorA=e}},{key:"specularColor",get:function(){return this._shaderValues.getVector(BlinnPhongMaterial.MATERIALSPECULAR)},set:function(e){this._shaderValues.setVector(BlinnPhongMaterial.MATERIALSPECULAR,e)}},{key:"shininess",get:function(){return this._Shininess},set:function(e){this._Shininess=e}},{key:"albedoTexture",get:function(){return this._shaderValues.getTexture(BlinnPhongMaterial.ALBEDOTEXTURE)},set:function(e){e?this._shaderValues.addDefine(BlinnPhongMaterial.SHADERDEFINE_DIFFUSEMAP):this._shaderValues.removeDefine(BlinnPhongMaterial.SHADERDEFINE_DIFFUSEMAP),this._shaderValues.setTexture(BlinnPhongMaterial.ALBEDOTEXTURE,e)}},{key:"normalTexture",get:function(){return this._shaderValues.getTexture(BlinnPhongMaterial.NORMALTEXTURE)},set:function(e){e?this._shaderValues.addDefine(BlinnPhongMaterial.SHADERDEFINE_NORMALMAP):this._shaderValues.removeDefine(BlinnPhongMaterial.SHADERDEFINE_NORMALMAP),this._shaderValues.setTexture(BlinnPhongMaterial.NORMALTEXTURE,e)}},{key:"specularTexture",get:function(){return this._shaderValues.getTexture(BlinnPhongMaterial.SPECULARTEXTURE)},set:function(e){e?this._shaderValues.addDefine(BlinnPhongMaterial.SHADERDEFINE_SPECULARMAP):this._shaderValues.removeDefine(BlinnPhongMaterial.SHADERDEFINE_SPECULARMAP),this._shaderValues.setTexture(BlinnPhongMaterial.SPECULARTEXTURE,e)}},{key:"enableTransmission",get:function(){return this._enableTransmission},set:function(e){this._enableTransmission=e,e?this._shaderValues.addDefine(BlinnPhongMaterial.SHADERDEFINE_ENABLETRANSMISSION):this._shaderValues.removeDefine(BlinnPhongMaterial.SHADERDEFINE_ENABLETRANSMISSION)}},{key:"transmissionRate",get:function(){return this._shaderValues.getNumber(BlinnPhongMaterial.TRANSMISSIONRATE)}},{key:"transmissionRata",set:function(e){this._shaderValues.setNumber(BlinnPhongMaterial.TRANSMISSIONRATE,e)}},{key:"backDiffuse",get:function(){return this._shaderValues.getNumber(BlinnPhongMaterial.IBACKDIFFUSE)},set:function(e){this._shaderValues.setNumber(BlinnPhongMaterial.IBACKDIFFUSE,Math.max(e,1))}},{key:"backScale",get:function(){return this._shaderValues.getNumber(BlinnPhongMaterial.IBACKSCALE)},set:function(e){this._shaderValues.setNumber(BlinnPhongMaterial.IBACKSCALE,e)}},{key:"thinknessTexture",get:function(){return this._shaderValues.getTexture(BlinnPhongMaterial.THINKNESSTEXTURE)},set:function(e){e?this._shaderValues.addDefine(BlinnPhongMaterial.SHADERDEFINE_THICKNESSMAP):this._shaderValues.removeDefine(BlinnPhongMaterial.SHADERDEFINE_THICKNESSMAP),this._shaderValues.setTexture(BlinnPhongMaterial.THINKNESSTEXTURE,e)}},{key:"transmissionColor",get:function(){return this._shaderValues.getVector(BlinnPhongMaterial.TRANSMISSIONCOLOR)},set:function(e){this._shaderValues.setVector(BlinnPhongMaterial.TRANSMISSIONCOLOR,e)}}],[{key:"__initDefine__",value:function(){BlinnPhongMaterial.SHADERDEFINE_DIFFUSEMAP=_e.getDefineByName("DIFFUSEMAP"),BlinnPhongMaterial.SHADERDEFINE_NORMALMAP=_e.getDefineByName("NORMALMAP"),BlinnPhongMaterial.SHADERDEFINE_SPECULARMAP=_e.getDefineByName("SPECULARMAP"),BlinnPhongMaterial.SHADERDEFINE_ENABLEVERTEXCOLOR=_e.getDefineByName("ENABLEVERTEXCOLOR"),BlinnPhongMaterial.SHADERDEFINE_ENABLETRANSMISSION=_e.getDefineByName("ENABLETRANSMISSION"),BlinnPhongMaterial.SHADERDEFINE_THICKNESSMAP=_e.getDefineByName("THICKNESSMAP")}}]),BlinnPhongMaterial}();ct.RENDERMODE_OPAQUE=0,ct.RENDERMODE_CUTOUT=1,ct.RENDERMODE_TRANSPARENT=2,ct.ALBEDOTEXTURE=_e.propertyNameToID("u_DiffuseTexture"),ct.NORMALTEXTURE=_e.propertyNameToID("u_NormalTexture"),ct.SPECULARTEXTURE=_e.propertyNameToID("u_SpecularTexture"),ct.ALBEDOCOLOR=_e.propertyNameToID("u_DiffuseColor"),ct.MATERIALSPECULAR=_e.propertyNameToID("u_MaterialSpecular"),ct.SHININESS=_e.propertyNameToID("u_Shininess"),ct.TILINGOFFSET=_e.propertyNameToID("u_TilingOffset"),ct.TRANSMISSIONRATE=_e.propertyNameToID("u_TransmissionRate"),ct.IBACKDIFFUSE=_e.propertyNameToID("u_BackDiffuse"),ct.IBACKSCALE=_e.propertyNameToID("u_BackScale"),ct.THINKNESSTEXTURE=_e.propertyNameToID("u_ThinknessTexture"),ct.TRANSMISSIONCOLOR=_e.propertyNameToID("u_TransmissionColor");var ht=function(e){function EffectMaterial(){var e;return _classCallCheck(this,EffectMaterial),(e=_possibleConstructorReturn(this,_getPrototypeOf(EffectMaterial).call(this))).setShaderName("Effect"),e._color=new a(1,1,1,1),e._shaderValues.setVector(EffectMaterial.TILINGOFFSET,new a(1,1,0,0)),e._shaderValues.setVector(EffectMaterial.TINTCOLOR,new a(1,1,1,1)),e.renderMode=EffectMaterial.RENDERMODE_ADDTIVE,e}return _inherits(EffectMaterial,st),_createClass(EffectMaterial,[{key:"clone",value:function(){var e=new EffectMaterial;return this.cloneTo(e),e}},{key:"_TintColorR",get:function(){return this._color.x},set:function(e){this._color.x=e,this.color=this._color}},{key:"_TintColorG",get:function(){return this._color.y},set:function(e){this._color.y=e,this.color=this._color}},{key:"_TintColorB",get:function(){return this._color.z},set:function(e){this._color.z=e,this.color=this._color}},{key:"_TintColorA",get:function(){return this._color.w},set:function(e){this._color.w=e,this.color=this._color}},{key:"_TintColor",get:function(){return this._shaderValues.getVector(EffectMaterial.TINTCOLOR)},set:function(e){this.color=e}},{key:"_MainTex_STX",get:function(){return this._shaderValues.getVector(EffectMaterial.TILINGOFFSET).x},set:function(e){var t=this._shaderValues.getVector(EffectMaterial.TILINGOFFSET);t.x=e,this.tilingOffset=t}},{key:"_MainTex_STY",get:function(){return this._shaderValues.getVector(EffectMaterial.TILINGOFFSET).y},set:function(e){var t=this._shaderValues.getVector(EffectMaterial.TILINGOFFSET);t.y=e,this.tilingOffset=t}},{key:"_MainTex_STZ",get:function(){return this._shaderValues.getVector(EffectMaterial.TILINGOFFSET).z},set:function(e){var t=this._shaderValues.getVector(EffectMaterial.TILINGOFFSET);t.z=e,this.tilingOffset=t}},{key:"_MainTex_STW",get:function(){return this._shaderValues.getVector(EffectMaterial.TILINGOFFSET).w},set:function(e){var t=this._shaderValues.getVector(EffectMaterial.TILINGOFFSET);t.w=e,this.tilingOffset=t}},{key:"_MainTex_ST",get:function(){return this._shaderValues.getVector(EffectMaterial.TILINGOFFSET)},set:function(e){this.tilingOffset=e}},{key:"renderMode",set:function(e){switch(e){case EffectMaterial.RENDERMODE_ADDTIVE:this.renderQueue=st.RENDERQUEUE_TRANSPARENT,this.alphaTest=!1,this.depthWrite=!1,this.cull=ut.CULL_NONE,this.blend=ut.BLEND_ENABLE_ALL,this.blendSrc=ut.BLENDPARAM_SRC_ALPHA,this.blendDst=ut.BLENDPARAM_ONE,this.depthTest=ut.DEPTHTEST_LESS,this._shaderValues.addDefine(EffectMaterial.SHADERDEFINE_ADDTIVEFOG);break;case EffectMaterial.RENDERMODE_ALPHABLENDED:this.renderQueue=st.RENDERQUEUE_TRANSPARENT,this.alphaTest=!1,this.depthWrite=!1,this.cull=ut.CULL_NONE,this.blend=ut.BLEND_ENABLE_ALL,this.blendSrc=ut.BLENDPARAM_SRC_ALPHA,this.blendDst=ut.BLENDPARAM_ONE_MINUS_SRC_ALPHA,this.depthTest=ut.DEPTHTEST_LESS,this._shaderValues.removeDefine(EffectMaterial.SHADERDEFINE_ADDTIVEFOG);break;default:throw new Error("MeshEffectMaterial : renderMode value error.")}}},{key:"colorR",get:function(){return this._TintColorR},set:function(e){this._TintColorR=e}},{key:"colorG",get:function(){return this._TintColorG},set:function(e){this._TintColorG=e}},{key:"colorB",get:function(){return this._TintColorB},set:function(e){this._TintColorB=e}},{key:"colorA",get:function(){return this._TintColorA},set:function(e){this._TintColorA=e}},{key:"color",get:function(){return this._shaderValues.getVector(EffectMaterial.TINTCOLOR)},set:function(e){this._shaderValues.setVector(EffectMaterial.TINTCOLOR,e)}},{key:"texture",get:function(){return this._shaderValues.getTexture(EffectMaterial.MAINTEXTURE)},set:function(e){e?this._shaderValues.addDefine(EffectMaterial.SHADERDEFINE_MAINTEXTURE):this._shaderValues.removeDefine(EffectMaterial.SHADERDEFINE_MAINTEXTURE),this._shaderValues.setTexture(EffectMaterial.MAINTEXTURE,e)}},{key:"tilingOffsetX",get:function(){return this._MainTex_STX},set:function(e){this._MainTex_STX=e}},{key:"tilingOffsetY",get:function(){return this._MainTex_STY},set:function(e){this._MainTex_STY=e}},{key:"tilingOffsetZ",get:function(){return this._MainTex_STZ},set:function(e){this._MainTex_STZ=e}},{key:"tilingOffsetW",get:function(){return this._MainTex_STW},set:function(e){this._MainTex_STW=e}},{key:"tilingOffset",get:function(){return this._shaderValues.getVector(EffectMaterial.TILINGOFFSET)},set:function(e){e?this._shaderValues.setVector(EffectMaterial.TILINGOFFSET,e):this._shaderValues.getVector(EffectMaterial.TILINGOFFSET).setValue(1,1,0,0)}}],[{key:"__initDefine__",value:function(){EffectMaterial.SHADERDEFINE_MAINTEXTURE=_e.getDefineByName("MAINTEXTURE"),EffectMaterial.SHADERDEFINE_ADDTIVEFOG=_e.getDefineByName("ADDTIVEFOG")}}]),EffectMaterial}();ht.RENDERMODE_ADDTIVE=0,ht.RENDERMODE_ALPHABLENDED=1,ht.MAINTEXTURE=_e.propertyNameToID("u_AlbedoTexture"),ht.TINTCOLOR=_e.propertyNameToID("u_AlbedoColor"),ht.TILINGOFFSET=_e.propertyNameToID("u_TilingOffset");var _t,dt=function(e){function ExtendTerrainMaterial(){var e;return _classCallCheck(this,ExtendTerrainMaterial),(e=_possibleConstructorReturn(this,_getPrototypeOf(ExtendTerrainMaterial).call(this))).setShaderName("ExtendTerrain"),e.renderMode=ExtendTerrainMaterial.RENDERMODE_OPAQUE,e}return _inherits(ExtendTerrainMaterial,st),_createClass(ExtendTerrainMaterial,[{key:"_setDetailNum",value:function(e){switch(e){case 1:this._shaderValues.addDefine(ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM1),this._shaderValues.removeDefine(ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM2),this._shaderValues.removeDefine(ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM3),this._shaderValues.removeDefine(ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM4),this._shaderValues.removeDefine(ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM5);break;case 2:this._shaderValues.addDefine(ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM2),this._shaderValues.removeDefine(ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM1),this._shaderValues.removeDefine(ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM3),this._shaderValues.removeDefine(ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM4),this._shaderValues.removeDefine(ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM5);break;case 3:this._shaderValues.addDefine(ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM3),this._shaderValues.removeDefine(ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM1),this._shaderValues.removeDefine(ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM2),this._shaderValues.removeDefine(ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM4),this._shaderValues.removeDefine(ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM5);break;case 4:this._shaderValues.addDefine(ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM4),this._shaderValues.removeDefine(ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM1),this._shaderValues.removeDefine(ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM2),this._shaderValues.removeDefine(ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM3),this._shaderValues.removeDefine(ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM5);break;case 5:this._shaderValues.addDefine(ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM5),this._shaderValues.removeDefine(ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM1),this._shaderValues.removeDefine(ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM2),this._shaderValues.removeDefine(ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM3),this._shaderValues.removeDefine(ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM4)}}},{key:"clone",value:function(){var e=new ExtendTerrainMaterial;return this.cloneTo(e),e}},{key:"splatAlphaTexture",get:function(){return this._shaderValues.getTexture(ExtendTerrainMaterial.SPLATALPHATEXTURE)},set:function(e){this._shaderValues.setTexture(ExtendTerrainMaterial.SPLATALPHATEXTURE,e)}},{key:"diffuseTexture1",get:function(){return this._shaderValues.getTexture(ExtendTerrainMaterial.DIFFUSETEXTURE1)},set:function(e){this._shaderValues.setTexture(ExtendTerrainMaterial.DIFFUSETEXTURE1,e),this._setDetailNum(1)}},{key:"diffuseTexture2",get:function(){return this._shaderValues.getTexture(ExtendTerrainMaterial.DIFFUSETEXTURE2)},set:function(e){this._shaderValues.setTexture(ExtendTerrainMaterial.DIFFUSETEXTURE2,e),this._setDetailNum(2)}},{key:"diffuseTexture3",get:function(){return this._shaderValues.getTexture(ExtendTerrainMaterial.DIFFUSETEXTURE3)},set:function(e){this._shaderValues.setTexture(ExtendTerrainMaterial.DIFFUSETEXTURE3,e),this._setDetailNum(3)}},{key:"diffuseTexture4",get:function(){return this._shaderValues.getTexture(ExtendTerrainMaterial.DIFFUSETEXTURE4)},set:function(e){this._shaderValues.setTexture(ExtendTerrainMaterial.DIFFUSETEXTURE4,e),this._setDetailNum(4)}},{key:"diffuseTexture5",get:function(){return this._shaderValues.getTexture(ExtendTerrainMaterial.DIFFUSETEXTURE5)},set:function(e){this._shaderValues.setTexture(ExtendTerrainMaterial.DIFFUSETEXTURE5,e),this._setDetailNum(5)}},{key:"diffuseScaleOffset1",set:function(e){this._shaderValues.setVector(ExtendTerrainMaterial.DIFFUSESCALEOFFSET1,e)}},{key:"diffuseScaleOffset2",set:function(e){this._shaderValues.setVector(ExtendTerrainMaterial.DIFFUSESCALEOFFSET2,e)}},{key:"diffuseScaleOffset3",set:function(e){this._shaderValues.setVector(ExtendTerrainMaterial.DIFFUSESCALEOFFSET3,e)}},{key:"diffuseScaleOffset4",set:function(e){this._shaderValues.setVector(ExtendTerrainMaterial.DIFFUSESCALEOFFSET4,e)}},{key:"diffuseScaleOffset5",set:function(e){this._shaderValues.setVector(ExtendTerrainMaterial.DIFFUSESCALEOFFSET5,e)}},{key:"renderMode",set:function(e){switch(e){case ExtendTerrainMaterial.RENDERMODE_OPAQUE:this.renderQueue=st.RENDERQUEUE_OPAQUE,this.depthWrite=!0,this.cull=ut.CULL_BACK,this.blend=ut.BLEND_DISABLE,this.depthTest=ut.DEPTHTEST_LESS;break;case ExtendTerrainMaterial.RENDERMODE_TRANSPARENT:this.renderQueue=st.RENDERQUEUE_OPAQUE,this.depthWrite=!1,this.cull=ut.CULL_BACK,this.blend=ut.BLEND_ENABLE_ALL,this.blendSrc=ut.BLENDPARAM_SRC_ALPHA,this.blendDst=ut.BLENDPARAM_ONE_MINUS_SRC_ALPHA,this.depthTest=ut.DEPTHTEST_LEQUAL;break;default:throw new Error("ExtendTerrainMaterial:renderMode value error.")}}}],[{key:"__initDefine__",value:function(){ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM1=_e.getDefineByName("ExtendTerrain_DETAIL_NUM1"),ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM2=_e.getDefineByName("ExtendTerrain_DETAIL_NUM2"),ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM3=_e.getDefineByName("ExtendTerrain_DETAIL_NUM3"),ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM4=_e.getDefineByName("ExtendTerrain_DETAIL_NUM4"),ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM5=_e.getDefineByName("ExtendTerrain_DETAIL_NUM5")}}]),ExtendTerrainMaterial}();dt.RENDERMODE_OPAQUE=1,dt.RENDERMODE_TRANSPARENT=2,dt.SPLATALPHATEXTURE=_e.propertyNameToID("u_SplatAlphaTexture"),dt.DIFFUSETEXTURE1=_e.propertyNameToID("u_DiffuseTexture1"),dt.DIFFUSETEXTURE2=_e.propertyNameToID("u_DiffuseTexture2"),dt.DIFFUSETEXTURE3=_e.propertyNameToID("u_DiffuseTexture3"),dt.DIFFUSETEXTURE4=_e.propertyNameToID("u_DiffuseTexture4"),dt.DIFFUSETEXTURE5=_e.propertyNameToID("u_DiffuseTexture5"),dt.DIFFUSESCALEOFFSET1=_e.propertyNameToID("u_DiffuseScaleOffset1"),dt.DIFFUSESCALEOFFSET2=_e.propertyNameToID("u_DiffuseScaleOffset2"),dt.DIFFUSESCALEOFFSET3=_e.propertyNameToID("u_DiffuseScaleOffset3"),dt.DIFFUSESCALEOFFSET4=_e.propertyNameToID("u_DiffuseScaleOffset4"),dt.DIFFUSESCALEOFFSET5=_e.propertyNameToID("u_DiffuseScaleOffset5"),(_t=e.PBRRenderMode||(e.PBRRenderMode={}))[_t.Opaque=0]="Opaque",_t[_t.Cutout=1]="Cutout",_t[_t.Fade=2]="Fade",_t[_t.Transparent=3]="Transparent";var ft=function(t){function PBRMaterial(){var t;return _classCallCheck(this,PBRMaterial),(t=_possibleConstructorReturn(this,_getPrototypeOf(PBRMaterial).call(this)))._enableEmission=!1,t._shaderValues.setVector(PBRMaterial.ALBEDOCOLOR,new a(1,1,1,1)),t._shaderValues.setVector(PBRMaterial.EMISSIONCOLOR,new a(1,1,1,1)),t._shaderValues.setVector(PBRMaterial.TILINGOFFSET,new a(1,1,0,0)),t._shaderValues.setNumber(PBRMaterial.SMOOTHNESS,.5),t._shaderValues.setNumber(PBRMaterial.SMOOTHNESSSCALE,1),t._shaderValues.setNumber(PBRMaterial.OCCLUSIONSTRENGTH,1),t._shaderValues.setNumber(PBRMaterial.NORMALSCALE,1),t._shaderValues.setNumber(PBRMaterial.PARALLAXSCALE,.001),t._shaderValues.setNumber(st.ALPHATESTVALUE,.5),t.renderMode=e.PBRRenderMode.Opaque,t}return _inherits(PBRMaterial,st),_createClass(PBRMaterial,[{key:"albedoColor",get:function(){return this._shaderValues.getVector(PBRMaterial.ALBEDOCOLOR)},set:function(e){this._shaderValues.setVector(PBRMaterial.ALBEDOCOLOR,e)}},{key:"albedoTexture",get:function(){return this._shaderValues.getTexture(PBRMaterial.ALBEDOTEXTURE)},set:function(e){e?this._shaderValues.addDefine(PBRMaterial.SHADERDEFINE_ALBEDOTEXTURE):this._shaderValues.removeDefine(PBRMaterial.SHADERDEFINE_ALBEDOTEXTURE),this._shaderValues.setTexture(PBRMaterial.ALBEDOTEXTURE,e)}},{key:"normalTexture",get:function(){return this._shaderValues.getTexture(PBRMaterial.NORMALTEXTURE)},set:function(e){e?this._shaderValues.addDefine(PBRMaterial.SHADERDEFINE_NORMALTEXTURE):this._shaderValues.removeDefine(PBRMaterial.SHADERDEFINE_NORMALTEXTURE),this._shaderValues.setTexture(PBRMaterial.NORMALTEXTURE,e)}},{key:"normalTextureScale",get:function(){return this._shaderValues.getNumber(PBRMaterial.NORMALSCALE)},set:function(e){this._shaderValues.setNumber(PBRMaterial.NORMALSCALE,e)}},{key:"parallaxTexture",get:function(){return this._shaderValues.getTexture(PBRMaterial.PARALLAXTEXTURE)},set:function(e){e?this._shaderValues.addDefine(PBRMaterial.SHADERDEFINE_PARALLAXTEXTURE):this._shaderValues.removeDefine(PBRMaterial.SHADERDEFINE_PARALLAXTEXTURE),this._shaderValues.setTexture(PBRMaterial.PARALLAXTEXTURE,e)}},{key:"parallaxTextureScale",get:function(){return this._shaderValues.getNumber(PBRMaterial.PARALLAXSCALE)},set:function(e){this._shaderValues.setNumber(PBRMaterial.PARALLAXSCALE,Math.max(.005,Math.min(.08,e)))}},{key:"occlusionTexture",get:function(){return this._shaderValues.getTexture(PBRMaterial.OCCLUSIONTEXTURE)},set:function(e){e?this._shaderValues.addDefine(PBRMaterial.SHADERDEFINE_OCCLUSIONTEXTURE):this._shaderValues.removeDefine(PBRMaterial.SHADERDEFINE_OCCLUSIONTEXTURE),this._shaderValues.setTexture(PBRMaterial.OCCLUSIONTEXTURE,e)}},{key:"occlusionTextureStrength",get:function(){return this._shaderValues.getNumber(PBRMaterial.OCCLUSIONSTRENGTH)},set:function(e){this._shaderValues.setNumber(PBRMaterial.OCCLUSIONSTRENGTH,Math.max(0,Math.min(1,e)))}},{key:"smoothness",get:function(){return this._shaderValues.getNumber(PBRMaterial.SMOOTHNESS)},set:function(e){this._shaderValues.setNumber(PBRMaterial.SMOOTHNESS,Math.max(0,Math.min(1,e)))}},{key:"smoothnessTextureScale",get:function(){return this._shaderValues.getNumber(PBRMaterial.SMOOTHNESSSCALE)},set:function(e){this._shaderValues.setNumber(PBRMaterial.SMOOTHNESSSCALE,Math.max(0,Math.min(1,e)))}},{key:"enableEmission",get:function(){return this._enableEmission},set:function(e){e?this._shaderValues.addDefine(PBRMaterial.SHADERDEFINE_EMISSION):this._shaderValues.removeDefine(PBRMaterial.SHADERDEFINE_EMISSION),this._enableEmission=e}},{key:"emissionColor",get:function(){return this._shaderValues.getVector(PBRMaterial.EMISSIONCOLOR)},set:function(e){this._shaderValues.setVector(PBRMaterial.EMISSIONCOLOR,e)}},{key:"emissionTexture",get:function(){return this._shaderValues.getTexture(PBRMaterial.EMISSIONTEXTURE)},set:function(e){e?this._shaderValues.addDefine(PBRMaterial.SHADERDEFINE_EMISSIONTEXTURE):this._shaderValues.removeDefine(PBRMaterial.SHADERDEFINE_EMISSIONTEXTURE),this._shaderValues.setTexture(PBRMaterial.EMISSIONTEXTURE,e)}},{key:"tilingOffset",get:function(){return this._shaderValues.getVector(PBRMaterial.TILINGOFFSET)},set:function(e){e?this._shaderValues.setVector(PBRMaterial.TILINGOFFSET,e):this._shaderValues.getVector(PBRMaterial.TILINGOFFSET).setValue(1,1,0,0)}},{key:"renderMode",set:function(t){switch(t){case e.PBRRenderMode.Opaque:this.alphaTest=!1,this.renderQueue=st.RENDERQUEUE_OPAQUE,this.depthWrite=!0,this.cull=ut.CULL_BACK,this.blend=ut.BLEND_DISABLE,this.depthTest=ut.DEPTHTEST_LESS,this._shaderValues.removeDefine(PBRMaterial.SHADERDEFINE_TRANSPARENTBLEND);break;case e.PBRRenderMode.Cutout:this.renderQueue=st.RENDERQUEUE_ALPHATEST,this.alphaTest=!0,this.depthWrite=!0,this.cull=ut.CULL_BACK,this.blend=ut.BLEND_DISABLE,this.depthTest=ut.DEPTHTEST_LESS,this._shaderValues.removeDefine(PBRMaterial.SHADERDEFINE_TRANSPARENTBLEND);break;case e.PBRRenderMode.Fade:this.renderQueue=st.RENDERQUEUE_TRANSPARENT,this.alphaTest=!1,this.depthWrite=!1,this.cull=ut.CULL_BACK,this.blend=ut.BLEND_ENABLE_ALL,this.blendSrc=ut.BLENDPARAM_SRC_ALPHA,this.blendDst=ut.BLENDPARAM_ONE_MINUS_SRC_ALPHA,this.depthTest=ut.DEPTHTEST_LESS,this._shaderValues.removeDefine(PBRMaterial.SHADERDEFINE_TRANSPARENTBLEND);break;case e.PBRRenderMode.Transparent:this.renderQueue=st.RENDERQUEUE_TRANSPARENT,this.alphaTest=!1,this.depthWrite=!1,this.cull=ut.CULL_BACK,this.blend=ut.BLEND_ENABLE_ALL,this.blendSrc=ut.BLENDPARAM_ONE,this.blendDst=ut.BLENDPARAM_ONE_MINUS_SRC_ALPHA,this.depthTest=ut.DEPTHTEST_LESS,this._shaderValues.addDefine(PBRMaterial.SHADERDEFINE_TRANSPARENTBLEND);break;default:throw new Error("PBRMaterial:unknown renderMode value.")}}}],[{key:"__init__",value:function(){PBRMaterial.SHADERDEFINE_ALBEDOTEXTURE=_e.getDefineByName("ALBEDOTEXTURE"),PBRMaterial.SHADERDEFINE_NORMALTEXTURE=_e.getDefineByName("NORMALTEXTURE"),PBRMaterial.SHADERDEFINE_PARALLAXTEXTURE=_e.getDefineByName("PARALLAXTEXTURE"),PBRMaterial.SHADERDEFINE_OCCLUSIONTEXTURE=_e.getDefineByName("OCCLUSIONTEXTURE"),PBRMaterial.SHADERDEFINE_EMISSION=_e.getDefineByName("EMISSION"),PBRMaterial.SHADERDEFINE_EMISSIONTEXTURE=_e.getDefineByName("EMISSIONTEXTURE"),PBRMaterial.SHADERDEFINE_TRANSPARENTBLEND=_e.getDefineByName("TRANSPARENTBLEND"),PBRMaterial.SHADERDEFINE_LAYA_PBR_BRDF_HIGH=_e.getDefineByName("LAYA_PBR_BRDF_HIGH"),PBRMaterial.SHADERDEFINE_LAYA_PBR_BRDF_LOW=_e.getDefineByName("LAYA_PBR_BRDF_LOW")}}]),PBRMaterial}();ft.ALBEDOTEXTURE=_e.propertyNameToID("u_AlbedoTexture"),ft.ALBEDOCOLOR=_e.propertyNameToID("u_AlbedoColor"),ft.TILINGOFFSET=_e.propertyNameToID("u_TilingOffset"),ft.NORMALTEXTURE=_e.propertyNameToID("u_NormalTexture"),ft.NORMALSCALE=_e.propertyNameToID("u_NormalScale"),ft.SMOOTHNESS=_e.propertyNameToID("u_Smoothness"),ft.SMOOTHNESSSCALE=_e.propertyNameToID("u_SmoothnessScale"),ft.OCCLUSIONTEXTURE=_e.propertyNameToID("u_OcclusionTexture"),ft.OCCLUSIONSTRENGTH=_e.propertyNameToID("u_occlusionStrength"),ft.PARALLAXTEXTURE=_e.propertyNameToID("u_ParallaxTexture"),ft.PARALLAXSCALE=_e.propertyNameToID("u_ParallaxScale"),ft.EMISSIONTEXTURE=_e.propertyNameToID("u_EmissionTexture"),ft.EMISSIONCOLOR=_e.propertyNameToID("u_EmissionColor"),ft.renderQuality=e.PBRRenderQuality.High;var mt='#if defined(GL_FRAGMENT_PRECISION_HIGH)// 原来的写法会被我们自己的解析流程处理，而我们的解析是不认内置宏的，导致被删掉，所以改成 if defined 了\n\tprecision highp float;\n\tprecision highp int;\n#else\n\tprecision mediump float;\n\tprecision mediump int;\n#endif\n\n#include "Lighting.glsl";\n\nattribute vec4 a_Position;\nattribute vec3 a_Normal;\n\n#ifdef BONE\n\tconst int c_MaxBoneCount = 24;\n\tattribute vec4 a_BoneIndices;\n\tattribute vec4 a_BoneWeights;\n\tuniform mat4 u_Bones[c_MaxBoneCount];\n#endif\n\n#ifdef GPU_INSTANCE\n\tattribute mat4 a_WorldMat;\n#else\n\tuniform mat4 u_WorldMat;\n#endif\n\nuniform mat4 u_ViewProjection;\nuniform vec4 u_ProjectionParams;\n\n//传入法线\nvarying vec4 depthNormals;\n\n\nvec4 depthNormalsVertex()\n{\n\tmat4 worldMat;\n\t#ifdef GPU_INSTANCE\n\t\tworldMat = a_WorldMat;\n\t#else\n\t\tworldMat = u_WorldMat;\n\t#endif\n\t\n\t#ifdef BONE\n\t\tmat4 skinTransform;\n\t \t#ifdef SIMPLEBONE\n\t\t\tfloat currentPixelPos;\n\t\t\t#ifdef GPU_INSTANCE\n\t\t\t\tcurrentPixelPos = a_SimpleTextureParams.x+a_SimpleTextureParams.y;\n\t\t\t#else\n\t\t\t\tcurrentPixelPos = u_SimpleAnimatorParams.x+u_SimpleAnimatorParams.y;\n\t\t\t#endif\n\t\t\tfloat offset = 1.0/u_SimpleAnimatorTextureSize;\n\t\t\tskinTransform =  loadMatFromTexture(currentPixelPos,int(a_BoneIndices.x),offset) * a_BoneWeights.x;\n\t\t\tskinTransform += loadMatFromTexture(currentPixelPos,int(a_BoneIndices.y),offset) * a_BoneWeights.y;\n\t\t\tskinTransform += loadMatFromTexture(currentPixelPos,int(a_BoneIndices.z),offset) * a_BoneWeights.z;\n\t\t\tskinTransform += loadMatFromTexture(currentPixelPos,int(a_BoneIndices.w),offset) * a_BoneWeights.w;\n\t\t#else\n\t\t\tskinTransform =  u_Bones[int(a_BoneIndices.x)] * a_BoneWeights.x;\n\t\t\tskinTransform += u_Bones[int(a_BoneIndices.y)] * a_BoneWeights.y;\n\t\t\tskinTransform += u_Bones[int(a_BoneIndices.z)] * a_BoneWeights.z;\n\t\t\tskinTransform += u_Bones[int(a_BoneIndices.w)] * a_BoneWeights.w;\n\t\t#endif\n\t\tworldMat = worldMat * skinTransform;\n\t#endif\n\n\tvec4 positionWS = worldMat * a_Position;\n\n\tmat3 worldInvMat;\n\t#ifdef BONE\n\t\tworldInvMat=INVERSE_MAT(mat3(worldMat*skinTransform));\n\t#else\n\t\tworldInvMat=INVERSE_MAT(mat3(worldMat));\n\t#endif  \n\n\tvec3 normalWS = normalize(a_Normal*worldInvMat);//if no normalize will cause precision problem\n\n\tdepthNormals.xyz = normalWS;\n\tvec4 positionCS = u_ViewProjection * positionWS;\n\tdepthNormals.w = (positionCS.z * 2.0 - positionCS.w)*u_ProjectionParams.w;\n\t\n    return positionCS;\n}\n\nvoid main()\n{\n\tvec4 positionCS =  depthNormalsVertex();\n\tgl_Position=remapGLPositionZ(positionCS);\n}',pt='#if defined(GL_FRAGMENT_PRECISION_HIGH)// 原来的写法会被我们自己的解析流程处理，而我们的解析是不认内置宏的，导致被删掉，所以改成 if defined 了\n\tprecision highp float;\n\tprecision highp int;\n#else\n\tprecision mediump float;\n\tprecision mediump int;\n#endif\n#include "DepthNormalUtil.glsl";\n\nvarying vec4 depthNormals;\n\nvoid main()\n{\n\tgl_FragColor=depthNormalsFragment(depthNormals);\n}',Tt=function ShaderVariable(){_classCallCheck(this,ShaderVariable),this.textureID=-1},vt=function(e){function ShaderInstance(e,t,n,i,a){var r;return _classCallCheck(this,ShaderInstance),(r=_possibleConstructorReturn(this,_getPrototypeOf(ShaderInstance).call(this)))._stateParamsMap=[],r._uploadMark=-1,r._uploadRenderType=-1,r._vs=e,r._ps=t,r._attributeMap=n,r._uniformMap=i,r._shaderPass=a,r._globaluniformMap={},r._create(),r.lock=!0,r}return _inherits(ShaderInstance,t.Resource),_createClass(ShaderInstance,[{key:"_create",value:function(){var e=t.LayaGL.instance;for(var n in this._program=e.createProgram(),this._vshader=this._createShader(e,this._vs,e.VERTEX_SHADER),this._pshader=this._createShader(e,this._ps,e.FRAGMENT_SHADER),e.attachShader(this._program,this._vshader),e.attachShader(this._program,this._pshader),this._attributeMap)e.bindAttribLocation(this._program,this._attributeMap[n],n);if(e.linkProgram(this._program),!t.Render.isConchApp&&_e.debugMode&&!e.getProgramParameter(this._program,e.LINK_STATUS))throw e.getProgramInfoLog(this._program);var i=[],a=[],r=[],o=[],s=[];this._customUniformParamsMap=[];var l,u,c,h=e.getProgramParameter(this._program,e.ACTIVE_UNIFORMS);for(t.WebGLContext.useProgram(e,this._program),this._curActTexIndex=0,u=0;u<h;u++){var _=e.getActiveUniform(this._program,u),d=_.name;(l=new Tt).location=e.getUniformLocation(this._program,d),d.indexOf("[0]")>0?(l.name=d=d.substr(0,d.length-3),l.isArray=!0):(l.name=d,l.isArray=!1),l.type=_.type,this._addShaderUnifiormFun(l);var f=this._uniformMap[d];if(null!=f)switch(l.dataOffset=_e.propertyNameToID(d),f){case _e.PERIOD_CUSTOM:s.push(l);break;case _e.PERIOD_MATERIAL:o.push(l);break;case _e.PERIOD_SPRITE:r.push(l);break;case _e.PERIOD_CAMERA:a.push(l);break;case _e.PERIOD_SCENE:i.push(l);break;default:throw new Error("Shader3D: period is unkonw.")}else l.dataOffset=_e.propertyNameToID(d),this._globaluniformMap[d]=_e.PERIOD_SCENE,i.push(l)}for(this._sceneUniformParamsMap=t.LayaGL.instance.createCommandEncoder(4*i.length*5+4,64,!0),u=0,c=i.length;u<c;u++)this._sceneUniformParamsMap.addShaderUniform(i[u]);for(this._cameraUniformParamsMap=t.LayaGL.instance.createCommandEncoder(4*a.length*5+4,64,!0),u=0,c=a.length;u<c;u++)this._cameraUniformParamsMap.addShaderUniform(a[u]);for(this._spriteUniformParamsMap=t.LayaGL.instance.createCommandEncoder(4*r.length*5+4,64,!0),u=0,c=r.length;u<c;u++)this._spriteUniformParamsMap.addShaderUniform(r[u]);for(this._materialUniformParamsMap=t.LayaGL.instance.createCommandEncoder(4*o.length*5+4,64,!0),u=0,c=o.length;u<c;u++)this._materialUniformParamsMap.addShaderUniform(o[u]);for(this._customUniformParamsMap.length=s.length,u=0,c=s.length;u<c;u++){var m=s[u];this._customUniformParamsMap[m.dataOffset]=m}var p=this._shaderPass._stateMap;for(var T in p)this._stateParamsMap[p[T]]=_e.propertyNameToID(T)}},{key:"_getRenderState",value:function(e,t){var n=this._stateParamsMap[t];return null==n?null:e[n]}},{key:"_disposeResource",value:function(){t.LayaGL.instance.deleteShader(this._vshader),t.LayaGL.instance.deleteShader(this._pshader),t.LayaGL.instance.deleteProgram(this._program),this._vshader=this._pshader=this._program=null,this._setGPUMemory(0),this._curActTexIndex=0}},{key:"_addShaderUnifiormFun",value:function(e){var n=t.LayaGL.instance;e.caller=this;var i=e.isArray;switch(e.type){case n.BOOL:e.fun=this._uniform1i,e.uploadedValue=new Array(1);break;case n.INT:e.fun=i?this._uniform1iv:this._uniform1i,e.uploadedValue=new Array(1);break;case n.FLOAT:e.fun=i?this._uniform1fv:this._uniform1f,e.uploadedValue=new Array(1);break;case n.FLOAT_VEC2:e.fun=i?this._uniform_vec2v:this._uniform_vec2,e.uploadedValue=new Array(2);break;case n.FLOAT_VEC3:e.fun=i?this._uniform_vec3v:this._uniform_vec3,e.uploadedValue=new Array(3);break;case n.FLOAT_VEC4:e.fun=i?this._uniform_vec4v:this._uniform_vec4,e.uploadedValue=new Array(4);break;case n.FLOAT_MAT2:e.fun=this._uniformMatrix2fv;break;case n.FLOAT_MAT3:e.fun=this._uniformMatrix3fv;break;case n.FLOAT_MAT4:e.fun=i?this._uniformMatrix4fv:this._uniformMatrix4f;break;case n.SAMPLER_2D:case n.SAMPLER_2D_SHADOW:n.uniform1i(e.location,this._curActTexIndex),e.textureID=t.WebGLContext._glTextureIDs[this._curActTexIndex++],e.fun=this._uniform_sampler2D;break;case 35679:n.uniform1i(e.location,this._curActTexIndex),e.textureID=t.WebGLContext._glTextureIDs[this._curActTexIndex++],e.fun=this._uniform_sampler3D;break;case n.SAMPLER_CUBE:n.uniform1i(e.location,this._curActTexIndex),e.textureID=t.WebGLContext._glTextureIDs[this._curActTexIndex++],e.fun=this._uniform_samplerCube;break;default:throw new Error("compile shader err!")}}},{key:"_createShader",value:function(e,t,n){var i=e.createShader(n);if(e.shaderSource(i,t),e.compileShader(i),_e.debugMode&&!e.getShaderParameter(i,e.COMPILE_STATUS))throw e.getShaderInfoLog(i);return i}},{key:"_uniform1f",value:function(e,n){var i=e.uploadedValue;return i[0]!==n?(t.LayaGL.instance.uniform1f(e.location,i[0]=n),1):0}},{key:"_uniform1fv",value:function(e,n){if(n.length<4){var i=e.uploadedValue;return i[0]!==n[0]||i[1]!==n[1]||i[2]!==n[2]||i[3]!==n[3]?(t.LayaGL.instance.uniform1fv(e.location,n),i[0]=n[0],i[1]=n[1],i[2]=n[2],i[3]=n[3],1):0}return t.LayaGL.instance.uniform1fv(e.location,n),1}},{key:"_uniform_vec2",value:function(e,n){var i=e.uploadedValue;return i[0]!==n.x||i[1]!==n.y?(t.LayaGL.instance.uniform2f(e.location,i[0]=n.x,i[1]=n.y),1):0}},{key:"_uniform_vec2v",value:function(e,n){if(n.length<2){var i=e.uploadedValue;return i[0]!==n[0]||i[1]!==n[1]||i[2]!==n[2]||i[3]!==n[3]?(t.LayaGL.instance.uniform2fv(e.location,n),i[0]=n[0],i[1]=n[1],i[2]=n[2],i[3]=n[3],1):0}return t.LayaGL.instance.uniform2fv(e.location,n),1}},{key:"_uniform_vec3",value:function(e,n){var i=e.uploadedValue;return i[0]!==n.x||i[1]!==n.y||i[2]!==n.z?(t.LayaGL.instance.uniform3f(e.location,i[0]=n.x,i[1]=n.y,i[2]=n.z),1):0}},{key:"_uniform_vec3v",value:function(e,n){return t.LayaGL.instance.uniform3fv(e.location,n),1}},{key:"_uniform_vec4",value:function(e,n){var i=e.uploadedValue;return i[0]!==n.x||i[1]!==n.y||i[2]!==n.z||i[3]!==n.w?(t.LayaGL.instance.uniform4f(e.location,i[0]=n.x,i[1]=n.y,i[2]=n.z,i[3]=n.w),1):0}},{key:"_uniform_vec4v",value:function(e,n){return t.LayaGL.instance.uniform4fv(e.location,n),1}},{key:"_uniformMatrix2fv",value:function(e,n){return t.LayaGL.instance.uniformMatrix2fv(e.location,!1,n),1}},{key:"_uniformMatrix3fv",value:function(e,n){return t.LayaGL.instance.uniformMatrix3fv(e.location,!1,n),1}},{key:"_uniformMatrix4f",value:function(e,n){var i=n.elements;return t.LayaGL.instance.uniformMatrix4fv(e.location,!1,i),1}},{key:"_uniformMatrix4fv",value:function(e,n){return t.LayaGL.instance.uniformMatrix4fv(e.location,!1,n),1}},{key:"_uniform1i",value:function(e,n){var i=e.uploadedValue;return i[0]!==n?(t.LayaGL.instance.uniform1i(e.location,i[0]=n),1):0}},{key:"_uniform1iv",value:function(e,n){return t.LayaGL.instance.uniform1iv(e.location,n),1}},{key:"_uniform_ivec2",value:function(e,n){var i=e.uploadedValue;return i[0]!==n[0]||i[1]!==n[1]?(t.LayaGL.instance.uniform2i(e.location,i[0]=n[0],i[1]=n[1]),1):0}},{key:"_uniform_ivec2v",value:function(e,n){return t.LayaGL.instance.uniform2iv(e.location,n),1}},{key:"_uniform_vec3i",value:function(e,n){var i=e.uploadedValue;return i[0]!==n[0]||i[1]!==n[1]||i[2]!==n[2]?(t.LayaGL.instance.uniform3i(e.location,i[0]=n[0],i[1]=n[1],i[2]=n[2]),1):0}},{key:"_uniform_vec3vi",value:function(e,n){return t.LayaGL.instance.uniform3iv(e.location,n),1}},{key:"_uniform_vec4i",value:function(e,n){var i=e.uploadedValue;return i[0]!==n[0]||i[1]!==n[1]||i[2]!==n[2]||i[3]!==n[3]?(t.LayaGL.instance.uniform4i(e.location,i[0]=n[0],i[1]=n[1],i[2]=n[2],i[3]=n[3]),1):0}},{key:"_uniform_vec4vi",value:function(e,n){return t.LayaGL.instance.uniform4iv(e.location,n),1}},{key:"_uniform_sampler2D",value:function(e,n){var i=n._getSource()||n.defaulteTexture._getSource(),a=t.LayaGL.instance;return t.WebGLContext.activeTexture(a,e.textureID),t.WebGLContext.bindTexture(a,a.TEXTURE_2D,i),0}},{key:"_uniform_sampler3D",value:function(e,n){var i=n._getSource()||n.defaulteTexture._getSource(),a=t.LayaGL.instance;return t.WebGLContext.activeTexture(a,e.textureID),t.WebGLContext.bindTexture(a,WebGL2RenderingContext.TEXTURE_3D,i),0}},{key:"_uniform_samplerCube",value:function(e,n){var i=n._getSource()||n.defaulteTexture._getSource(),a=t.LayaGL.instance;return t.WebGLContext.activeTexture(a,e.textureID),t.WebGLContext.bindTexture(a,a.TEXTURE_CUBE_MAP,i),0}},{key:"bind",value:function(){return t.WebGLContext.useProgram(t.LayaGL.instance,this._program)}},{key:"uploadUniforms",value:function(e,n,i){t.Stat.shaderCall+=t.LayaGLRunner.uploadShaderUniforms(t.LayaGL.instance,e,n,i)}},{key:"uploadRenderStateBlendDepth",value:function(e){var n=t.LayaGL.instance,i=this._shaderPass.renderState,a=e.getData(),r=this._getRenderState(a,_e.RENDER_STATE_DEPTH_WRITE),o=this._getRenderState(a,_e.RENDER_STATE_DEPTH_TEST),s=this._getRenderState(a,_e.RENDER_STATE_BLEND);switch(null==r&&(r=i.depthWrite),null==o&&(o=i.depthTest),null==s&&(s=i.blend),t.WebGLContext.setDepthMask(n,r),o===ut.DEPTHTEST_OFF?t.WebGLContext.setDepthTest(n,!1):(t.WebGLContext.setDepthTest(n,!0),t.WebGLContext.setDepthFunc(n,o)),s){case ut.BLEND_DISABLE:t.WebGLContext.setBlend(n,!1);break;case ut.BLEND_ENABLE_ALL:var l=this._getRenderState(a,_e.RENDER_STATE_BLEND_EQUATION),u=this._getRenderState(a,_e.RENDER_STATE_BLEND_SRC),c=this._getRenderState(a,_e.RENDER_STATE_BLEND_DST);null==l&&(l=i.blendEquation),null==u&&(u=i.srcBlend),null==c&&(c=i.dstBlend),t.WebGLContext.setBlend(n,!0),t.WebGLContext.setBlendEquation(n,l),t.WebGLContext.setBlendFunc(n,u,c);break;case ut.BLEND_ENABLE_SEPERATE:var h=this._getRenderState(a,_e.RENDER_STATE_BLEND_EQUATION_RGB),_=this._getRenderState(a,_e.RENDER_STATE_BLEND_EQUATION_ALPHA),d=this._getRenderState(a,_e.RENDER_STATE_BLEND_SRC_RGB),f=this._getRenderState(a,_e.RENDER_STATE_BLEND_DST_RGB),m=this._getRenderState(a,_e.RENDER_STATE_BLEND_SRC_ALPHA),p=this._getRenderState(a,_e.RENDER_STATE_BLEND_DST_ALPHA);null==h&&(h=i.blendEquationRGB),null==_&&(_=i.blendEquationAlpha),null==d&&(d=i.srcBlendRGB),null==f&&(f=i.dstBlendRGB),null==m&&(m=i.srcBlendAlpha),null==p&&(p=i.dstBlendAlpha),t.WebGLContext.setBlend(n,!0),t.WebGLContext.setBlendEquationSeparate(n,h,_),t.WebGLContext.setBlendFuncSeperate(n,d,f,m,p)}}},{key:"uploadRenderStateFrontFace",value:function(e,n,i){var a,r=t.LayaGL.instance,o=this._shaderPass.renderState,s=e.getData(),l=this._getRenderState(s,_e.RENDER_STATE_CULL);switch(null==l&&(l=o.cull),l){case ut.CULL_NONE:t.WebGLContext.setCullFace(r,!1);break;case ut.CULL_FRONT:t.WebGLContext.setCullFace(r,!0),a=n?i?r.CCW:r.CW:i?r.CW:r.CCW,t.WebGLContext.setFrontFace(r,a);break;case ut.CULL_BACK:t.WebGLContext.setCullFace(r,!0),a=n?i?r.CW:r.CCW:i?r.CCW:r.CW,t.WebGLContext.setFrontFace(r,a)}}},{key:"uploadCustomUniform",value:function(e,n){t.Stat.shaderCall+=t.LayaGLRunner.uploadCustomUniform(t.LayaGL.instance,this._customUniformParamsMap,e,n)}},{key:"_uniformMatrix2fvForNative",value:function(e,n){return t.LayaGL.instance.uniformMatrix2fvEx(e.location,!1,n),1}},{key:"_uniformMatrix3fvForNative",value:function(e,n){return t.LayaGL.instance.uniformMatrix3fvEx(e.location,!1,n),1}},{key:"_uniformMatrix4fvForNative",value:function(e,n){return t.LayaGL.instance.uniformMatrix4fvEx(e.location,!1,n),1}}]),ShaderInstance}(),gt=function(e){function SimpleSingletonList(){return _classCallCheck(this,SimpleSingletonList),_possibleConstructorReturn(this,_getPrototypeOf(SimpleSingletonList).call(this))}return _inherits(SimpleSingletonList,R),_createClass(SimpleSingletonList,[{key:"add",value:function(e){if(-1!==e._getIndexInList())throw"SimpleSingletonList:"+e+" has  in  SingletonList.";this._add(e),e._setIndexInList(this.length++)}},{key:"remove",value:function(e){var t=e._getIndexInList();if(this.length--,t!==this.length){var n=this.elements[this.length];this.elements[t]=n,n._setIndexInList(t)}e._setIndexInList(-1)}},{key:"clear",value:function(){for(var e=this.elements,t=0,n=this.length;t<n;t++)e[t]._setIndexInList(-1);this.length=0}}]),SimpleSingletonList}(),Et=function(){function Color(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1;_classCallCheck(this,Color),this.r=e,this.g=t,this.b=n,this.a=i}return _createClass(Color,[{key:"toLinear",value:function(e){e.r=Color.gammaToLinearSpace(this.r),e.g=Color.gammaToLinearSpace(this.g),e.b=Color.gammaToLinearSpace(this.b)}},{key:"toGamma",value:function(e){e.r=Color.linearToGammaSpace(this.r),e.g=Color.linearToGammaSpace(this.g),e.b=Color.linearToGammaSpace(this.b)}},{key:"cloneTo",value:function(e){var t=e;t.r=this.r,t.g=this.g,t.b=this.b,t.a=this.a}},{key:"clone",value:function(){var e=new Color;return this.cloneTo(e),e}},{key:"forNativeElement",value:function(){}}],[{key:"gammaToLinearSpace",value:function(e){return e<=.04045?e/12.92:e<1?Math.pow((e+.055)/1.055,2.4):Math.pow(e,2.4)}},{key:"linearToGammaSpace",value:function(e){return e<=0?0:e<=.0031308?12.92*e:e<=1?1.055*Math.pow(e,.41666)-.055:Math.pow(e,.41666)}}]),Color}();Et.RED=new Et(1,0,0,1),Et.GREEN=new Et(0,1,0,1),Et.BLUE=new Et(0,0,1,1),Et.CYAN=new Et(0,1,1,1),Et.YELLOW=new Et(1,.92,.016,1),Et.MAGENTA=new Et(1,0,1,1),Et.GRAY=new Et(.5,.5,.5,1),Et.WHITE=new Et(1,1,1,1),Et.BLACK=new Et(0,0,0,1);var yt=function CameraCullInfo(){_classCallCheck(this,CameraCullInfo)},St=function ShadowCullInfo(){_classCallCheck(this,ShadowCullInfo)},Rt=function(){function FrustumCulling(){_classCallCheck(this,FrustumCulling)}return _createClass(FrustumCulling,null,[{key:"__init__",value:function(){}},{key:"_drawTraversalCullingBound",value:function(e,t){for(var n=e.elements,i=0,a=e.length;i<a;i++){var r=FrustumCulling._tempColor0;r.r=0,r.g=1,r.b=0,r.a=1,P._drawBound(t,n[i].bounds._getBoundBox(),r)}}},{key:"_traversalCulling",value:function(e,n,i,a,r,s,l){for(var u=a.elements,c=e.boundFrustum,h=e.position,_=e.cullingMask,d=t.Stat.loopCount,f=0,m=a.length;f<m;f++){var p=u[f];if((l?p._castShadow&&p._enable:0!=(Math.pow(2,p._owner._layer)&_)&&p._enable)&&(t.Stat.frustumCulling++,!e.useOcclusionCulling||p._needRender(c,i))){p._renderMark=d,p._distanceForSort=o.distance(p.bounds.getCenter(),h);for(var T=p._renderElements,v=0,g=T.length;v<g;v++)T[v]._update(n,i,r,s)}}}},{key:"renderObjectCulling",value:function(e,t,n,i,a,r){var o=t._opaqueQueue,s=t._transparentQueue,l=t._renders;t._clearRenderQueue();var u=t._octree;if(u&&(u.updateMotionObjects(),u.shrinkRootIfPossible(),u.getCollidingWithFrustum(e,n,i,a,r)),FrustumCulling._traversalCulling(e,t,n,l,i,a,r),FrustumCulling.debugFrustumCulling){var c=t._debugTool;c.clear(),u&&(u.drawAllBounds(c),u.drawAllObjects(c)),FrustumCulling._drawTraversalCullingBound(l,c)}var h=o.elements.length;h>0&&o._quickSort(0,h-1),(h=s.elements.length)>0&&s._quickSort(0,h-1)}},{key:"cullingShadow",value:function(e,n,i){var a=n._renders;n._clearRenderQueue();for(var r=n._opaqueQueue,s=e.position,l=e.cullPlaneCount,u=e.cullPlanes,c=a.elements,h=t.Stat.loopCount,_=0,d=a.length;_<d;_++){var f=c[_];if(f._castShadow&&f._enable){t.Stat.frustumCulling++;for(var m=f.bounds,p=m.getMin(),T=m.getMax(),v=p.x,g=p.y,E=p.z,y=T.x,S=T.y,R=T.z,C=!0,M=0;M<l;M++){var D=u[M],x=D.normal;if(D.distance+x.x*(x.x<0?v:y)+x.y*(x.y<0?g:S)+x.z*(x.z<0?E:R)<0){C=!1;break}}if(C){f._renderMark=h,f._distanceForSort=o.distance(m.getCenter(),s);for(var A=f._renderElements,I=(M=0,A.length);M<I;M++)A[M]._update(n,i,null,null)}}}return r.elements.length>0}},{key:"cullingSpotShadow",value:function(e,n,i){var a=n._renders;n._clearRenderQueue();for(var r=n._opaqueQueue,s=a.elements,l=t.Stat.loopCount,u=0,c=a.length;u<c;u++){var h=s[u];if(h._castShadow&&h._enable&&h._needRender(e.boundFrustum,i)){var _=h.bounds;h._renderMark=l,h._distanceForSort=o.distance(_.getCenter(),e.position);for(var d=h._renderElements,f=0,m=d.length;f<m;f++)d[f]._update(n,i,null,null)}}return r.elements.length>0}},{key:"renderObjectCullingNative",value:function(e,n,i,a,r,s){var l,u,c,h=n._opaqueQueue,_=n._transparentQueue;n._clearRenderQueue();var d=a.length,f=a.elements;for(l=0;l<d;l++)f[l].bounds,f[l]._updateForNative&&f[l]._updateForNative(i);FrustumCulling.cullingNative(e._boundFrustumBuffer,FrustumCulling._cullingBuffer,n._cullingBufferIndices,d,n._cullingBufferResult);var m=t.Stat.loopCount,p=i.camera._transform.position;for(l=0;l<d;l++){var T=f[l];if(!e.useOcclusionCulling||e._isLayerVisible(T._owner._layer)&&T._enable&&n._cullingBufferResult[l]){T._renderMark=m,T._distanceForSort=o.distance(T.bounds.getCenter(),p);var v=T._renderElements;for(u=0,c=v.length;u<c;u++){v[u]._update(n,i,r,s)}}}var g=h.elements.length;g>0&&h._quickSort(0,g-1),(g=_.elements.length)>0&&_._quickSort(0,g-1)}},{key:"cullingNative",value:function(e,n,i,a,r){return t.LayaGL.instance.culling(e,n,i,a,r)}}]),FrustumCulling}();Rt._tempColor0=new Et,Rt._cameraCullInfo=new yt,Rt._shadowCullInfo=new St,Rt.debugFrustumCulling=!1;var Ct=function(){function SphericalHarmonicsL2(){_classCallCheck(this,SphericalHarmonicsL2),this._coefficients=new Float32Array(27)}return _createClass(SphericalHarmonicsL2,[{key:"getCoefficient",value:function(e,t){return this._coefficients[9*e+t]}},{key:"setCoefficient",value:function(e,t,n){this._coefficients[9*e+t]=n}},{key:"setCoefficients",value:function(e,t,n,i,a,r,o,s,l,u){var c=9*e;this._coefficients[c]=t,this._coefficients[++c]=n,this._coefficients[++c]=i,this._coefficients[++c]=a,this._coefficients[++c]=r,this._coefficients[++c]=o,this._coefficients[++c]=s,this._coefficients[++c]=l,this._coefficients[++c]=u}},{key:"cloneTo",value:function(e){if(this!==e)for(var t=this._coefficients,n=e._coefficients,i=0;i<27;i++)n[i]=t[i]}}]),SphericalHarmonicsL2}();Ct._default=new Ct;var Mt=function MouseTouch(){_classCallCheck(this,MouseTouch),this._pressedSprite=null,this._pressedLoopCount=-1,this.sprite=null,this.mousePositionX=0,this.mousePositionY=0},Dt=function(){function Touch(){_classCallCheck(this,Touch),this._indexInList=-1,this._identifier=-1,this._position=new i}return _createClass(Touch,[{key:"_getIndexInList",value:function(){return this._indexInList}},{key:"_setIndexInList",value:function(e){this._indexInList=e}},{key:"identifier",get:function(){return this._identifier}},{key:"position",get:function(){return this._position}}]),Touch}(),xt=function(){function Input3D(){var e=this;_classCallCheck(this,Input3D),this._eventList=[],this._mouseTouch=new Mt,this._touchPool=[],this._touches=new gt,this._multiTouchEnabled=!0,this._pushEventList=function(t){t.cancelable&&t.preventDefault(),e._eventList.push(t)}.bind(this)}return _createClass(Input3D,[{key:"__init__",value:function(e,t){this._scene=t,e.oncontextmenu=function(e){return!1}}},{key:"_onCanvasEvent",value:function(e){e.addEventListener("mousedown",this._pushEventList),e.addEventListener("mouseup",this._pushEventList,!0),e.addEventListener("mousemove",this._pushEventList,!0),e.addEventListener("touchstart",this._pushEventList),e.addEventListener("touchend",this._pushEventList,!0),e.addEventListener("touchmove",this._pushEventList,!0),e.addEventListener("touchcancel",this._pushEventList,!0)}},{key:"_offCanvasEvent",value:function(e){e.removeEventListener("mousedown",this._pushEventList),e.removeEventListener("mouseup",this._pushEventList,!0),e.removeEventListener("mousemove",this._pushEventList,!0),e.removeEventListener("touchstart",this._pushEventList),e.removeEventListener("touchend",this._pushEventList,!0),e.removeEventListener("touchmove",this._pushEventList,!0),e.removeEventListener("touchcancel",this._pushEventList,!0),this._eventList.length=0,this._touches.clear()}},{key:"touchCount",value:function(){return this._touches.length}},{key:"_getTouch",value:function(e,t){var n=this._touchPool[e];return 0==t&&n&&-1!=n._getIndexInList()?null:1==t&&n&&-1==n._getIndexInList()?null:(n||(n=new Dt,this._touchPool[e]=n,n._identifier=e),n)}},{key:"_mouseTouchDown",value:function(){var e=this._mouseTouch,n=e.sprite;if(e._pressedSprite=n,e._pressedLoopCount=t.Stat.loopCount,n){var i=n._scripts;if(i)for(var a=0,r=i.length;a<r;a++)i[a].onMouseDown()}}},{key:"_mouseTouchUp",value:function(){var e,t,n=this._mouseTouch,i=n._pressedSprite;n._pressedSprite=null,n._pressedLoopCount=-1;var a=n.sprite;if(a&&a===i){var r=a._scripts;if(r)for(e=0,t=r.length;e<t;e++)r[e].onMouseClick()}if(i){var o=i._scripts;if(o)for(e=0,t=o.length;e<t;e++)o[e].onMouseUp()}}},{key:"_mouseTouchRayCast",value:function(t){var n=Input3D._tempHitResult0,i=Input3D._tempVector20,a=Input3D._tempRay0;n.succeeded=!1;var r=this._mouseTouch.mousePositionX,o=this._mouseTouch.mousePositionY;i.x=r,i.y=o;for(var s=t.length-1;s>=0;s--){var l=t[s],u=l.viewport;if(i.x>=u.x&&i.y>=u.y&&i.x<=u.width&&i.y<=u.height)if(l.viewportPointToRay(i,a),this._scene._physicsSimulation.rayCast(a,n)||l.clearFlag===e.CameraClearFlags.SolidColor||l.clearFlag===e.CameraClearFlags.Sky)break}var c=this._mouseTouch,h=c.sprite;if(n.succeeded){var _=n.collider.owner;c.sprite=_;var d=_._scripts;if(h!==_&&d)for(var f=0,m=d.length;f<m;f++)d[f].onMouseEnter()}else c.sprite=null;if(h&&h!==_){var p=h._scripts;if(p)for(f=0,m=p.length;f<m;f++)p[f].onMouseOut()}}},{key:"_changeTouches",value:function(e,n){for(var i=0,a=0,r=this._touches.length,o=0,s=e.length;o<s;o++){var l=e[o],u=l.identifier;if(this._multiTouchEnabled||0===this._touches.length||0!=n){var c=this._getTouch(u,n);if(1!=n||c){var h=this._touchPool[u]._position,_=Input3D._tempPoint;_.setTo(l.pageX,l.pageY),t.ILaya.stage._canvasTransform.invertTransformPoint(_);var d=_.x,f=_.y;switch(n){case 0:c&&this._touches.add(c),i+=d,a+=f;break;case 1:c&&this._touches.remove(c),i-=d,a-=f;break;case 2:i=d-h.x,a=f-h.y}h.x=d,h.y=f}}}var m=this._touches.length;0===m?(this._mouseTouch.mousePositionX=0,this._mouseTouch.mousePositionY=0):(this._mouseTouch.mousePositionX=(this._mouseTouch.mousePositionX*r+i)/m,this._mouseTouch.mousePositionY=(this._mouseTouch.mousePositionY*r+a)/m)}},{key:"_update",value:function(){var e,n,i,a,r=k._enablePhysics&&!I.disableSimulation;n=this._eventList.length;var o=this._scene._cameraPool;if(n>0){var s=!1;for(e=0;e<n;e++){var l=this._eventList[e];switch(l.type){case"mousedown":r&&this._mouseTouchDown();break;case"mouseup":r&&this._mouseTouchUp();break;case"mousemove":var u=Input3D._tempPoint;u.setTo(l.pageX,l.pageY),t.ILaya.stage._canvasTransform.invertTransformPoint(u),this._mouseTouch.mousePositionX=u.x,this._mouseTouch.mousePositionY=u.y,r&&(s=!0);break;case"touchstart":var c=this._touches.length;this._changeTouches(l.changedTouches,0),r&&(!w._config.isUseCannonPhysicsEngine&&this._mouseTouchRayCast(o),0===c&&this._mouseTouchDown());break;case"touchend":case"touchcancel":this._changeTouches(l.changedTouches,1),r&&0===this._touches.length&&this._mouseTouchUp();break;case"touchmove":this._changeTouches(l.changedTouches,2),r&&(s=!0);break;default:throw"Input3D:unkonwn event type."}}s&&!w._config.isUseCannonPhysicsEngine&&this._mouseTouchRayCast(o),this._eventList.length=0}if(r){var h=this._mouseTouch,_=h._pressedSprite;if(_&&t.Stat.loopCount>h._pressedLoopCount){var d=_._scripts;if(d)for(i=0,a=d.length;i<a;i++)d[i].onMouseDrag()}var f=h.sprite;if(f){var m=f._scripts;if(m)for(i=0,a=m.length;i<a;i++)m[i].onMouseOver()}}}},{key:"getTouch",value:function(e){return e<this._touches.length?this._touches.elements[e]:null}},{key:"multiTouchEnabled",get:function(){return this._multiTouchEnabled},set:function(e){this._multiTouchEnabled=e}}]),Input3D}();xt._tempPoint=new t.Point,xt._tempVector20=new i,xt._tempRay0=new Ce(new o,new o),xt._tempHitResult0=new D;var At,It=function PhysicsSettings(){_classCallCheck(this,PhysicsSettings),this.flags=0,this.maxSubSteps=1,this.fixedTimeStep=1/60},Lt=function(){function VertexPositionTexture0(e,t){_classCallCheck(this,VertexPositionTexture0),this._position=e,this._textureCoordinate0=t}return _createClass(VertexPositionTexture0,[{key:"position",get:function(){return this._position}},{key:"textureCoordinate0",get:function(){return this._textureCoordinate0}},{key:"vertexDeclaration",get:function(){return VertexPositionTexture0._vertexDeclaration}}],[{key:"__init__",value:function(){VertexPositionTexture0._vertexDeclaration=new ae(20,[new re(0,ne.Vector3,Ne.MESH_POSITION0),new re(12,ne.Vector2,Ne.MESH_TEXTURECOORDINATE0)])}},{key:"vertexDeclaration",get:function(){return VertexPositionTexture0._vertexDeclaration}}]),VertexPositionTexture0}(),Pt=function(n){function SkyDome(){var n,i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:48,a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:48;_classCallCheck(this,SkyDome),n=_possibleConstructorReturn(this,_getPrototypeOf(SkyDome).call(this));var r=t.LayaGL.instance;n._stacks=i,n._slices=a;for(var o=Lt.vertexDeclaration,s=o.vertexStride/4,l=(n._stacks+1)*(n._slices+1),u=3*n._stacks*(n._slices+1)*2,c=new Float32Array(l*s),h=new Uint16Array(u),_=Math.PI/n._stacks,d=2*Math.PI/n._slices,f=0,m=0,p=0,T=0;T<n._stacks+1;T++)for(var v=Math.sin(T*_),g=Math.cos(T*_),E=0;E<n._slices+1;E++){var y=v*Math.sin(E*d),S=v*Math.cos(E*d);c[m+0]=y*SkyDome._radius,c[m+1]=g*SkyDome._radius,c[m+2]=S*SkyDome._radius,c[m+3]=-E/n._slices+.75,c[m+4]=T/n._stacks,m+=s,T!=n._stacks-1&&(h[p++]=f+1,h[p++]=f,h[p++]=f+(n._slices+1),h[p++]=f+(n._slices+1),h[p++]=f,h[p++]=f+n._slices,f++)}n._vertexBuffer=new te(4*c.length,r.STATIC_DRAW,!1),n._vertexBuffer.vertexDeclaration=o,n._indexBuffer=new Oe(e.IndexFormat.UInt16,h.length,r.STATIC_DRAW,!1),n._vertexBuffer.setData(c.buffer),n._indexBuffer.setData(h);var R=new oe;return R.bind(),R.applyVertexBuffer(n._vertexBuffer),R.applyIndexBuffer(n._indexBuffer),R.unBind(),n._bufferState=R,n}return _inherits(SkyDome,be),_createClass(SkyDome,[{key:"_render",value:function(e){var n=t.LayaGL.instance,i=this._indexBuffer.indexCount;n.drawElements(n.TRIANGLES,i,n.UNSIGNED_SHORT,0),t.Stat.trianglesFaces+=i/3,t.Stat.renderBatches++}},{key:"stacks",get:function(){return this._stacks}},{key:"slices",get:function(){return this._slices}}],[{key:"__init__",value:function(){SkyDome.instance=new SkyDome}}]),SkyDome}();Pt._radius=1,(At=e.TextureCubeFace||(e.TextureCubeFace={}))[At.PositiveX=0]="PositiveX",At[At.NegativeX=1]="NegativeX",At[At.PositiveY=2]="PositiveY",At[At.NegativeY=3]="NegativeY",At[At.PositiveZ=4]="PositiveZ",At[At.NegativeZ=5]="NegativeZ";var Ot=function(n){function TextureCube(e){var n,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:t.TextureFormat.R8G8B8,a=arguments.length>2&&void 0!==arguments[2]&&arguments[2];_classCallCheck(this,TextureCube),(n=_possibleConstructorReturn(this,_getPrototypeOf(TextureCube).call(this,i,a)))._glTextureType=t.LayaGL.instance.TEXTURE_CUBE_MAP,n._width=e,n._height=e;var r=t.LayaGL.instance;if(n._setWarpMode(r.TEXTURE_WRAP_S,n._wrapModeU),n._setWarpMode(r.TEXTURE_WRAP_T,n._wrapModeV),n._setFilterMode(n._filterMode),n._setAnisotropy(n._anisoLevel),n._mipmap){n._mipmapCount=Math.ceil(Math.log2(e))+1;for(var o=0;o<n._mipmapCount;o++)n._setPixels([],o,Math.max(e>>o,1),Math.max(e>>o,1));n._setGPUMemory(e*e*4*(1+1/3)*6)}else n._mipmapCount=1,n._setGPUMemory(e*e*4*6);return n}return _inherits(TextureCube,t.BaseTexture),_createClass(TextureCube,[{key:"_setPixels",value:function(e,n,i,a){var r=t.LayaGL.instance,o=this._getGLFormat();t.WebGLContext.bindTexture(r,this._glTextureType,this._glTexture),this.format===t.TextureFormat.R8G8B8?(r.pixelStorei(r.UNPACK_ALIGNMENT,1),r.texImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_Z,n,o,i,a,0,o,r.UNSIGNED_BYTE,e[0]),r.texImage2D(r.TEXTURE_CUBE_MAP_NEGATIVE_Z,n,o,i,a,0,o,r.UNSIGNED_BYTE,e[1]),r.texImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X,n,o,i,a,0,o,r.UNSIGNED_BYTE,e[2]),r.texImage2D(r.TEXTURE_CUBE_MAP_NEGATIVE_X,n,o,i,a,0,o,r.UNSIGNED_BYTE,e[3]),r.texImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_Y,n,o,i,a,0,o,r.UNSIGNED_BYTE,e[4]),r.texImage2D(r.TEXTURE_CUBE_MAP_NEGATIVE_Y,n,o,i,a,0,o,r.UNSIGNED_BYTE,e[5]),r.pixelStorei(r.UNPACK_ALIGNMENT,4)):(r.texImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_Z,n,o,i,a,0,o,r.UNSIGNED_BYTE,e[0]),r.texImage2D(r.TEXTURE_CUBE_MAP_NEGATIVE_Z,n,o,i,a,0,o,r.UNSIGNED_BYTE,e[1]),r.texImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X,n,o,i,a,0,o,r.UNSIGNED_BYTE,e[2]),r.texImage2D(r.TEXTURE_CUBE_MAP_NEGATIVE_X,n,o,i,a,0,o,r.UNSIGNED_BYTE,e[3]),r.texImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_Y,n,o,i,a,0,o,r.UNSIGNED_BYTE,e[4]),r.texImage2D(r.TEXTURE_CUBE_MAP_NEGATIVE_Y,n,o,i,a,0,o,r.UNSIGNED_BYTE,e[5]))}},{key:"setSixSideImageSources",value:function(e){for(var n,i,a=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=0;r<6;r++){var o=e[r];if(!o)return void console.log("TextureCube: image Source can't be null.");var s=o.width,l=o.height;if(r>0&&n!==s)return void console.log("TextureCube: each side image's width and height must same.");if((n=s)!==(i=l))return void console.log("TextureCube: each side image's width and height must same.")}this._width=n,this._height=i;var u=t.LayaGL.instance;t.WebGLContext.bindTexture(u,this._glTextureType,this._glTexture);var c=this._getGLFormat();if(t.Render.isConchApp){if(1==a)for(var h=0;h<6;h++)e[h].setPremultiplyAlpha(a);u.texImage2D(u.TEXTURE_CUBE_MAP_POSITIVE_Z,0,u.RGBA,u.RGBA,u.UNSIGNED_BYTE,e[0]),u.texImage2D(u.TEXTURE_CUBE_MAP_NEGATIVE_Z,0,u.RGBA,u.RGBA,u.UNSIGNED_BYTE,e[1]),u.texImage2D(u.TEXTURE_CUBE_MAP_POSITIVE_X,0,u.RGBA,u.RGBA,u.UNSIGNED_BYTE,e[2]),u.texImage2D(u.TEXTURE_CUBE_MAP_NEGATIVE_X,0,u.RGBA,u.RGBA,u.UNSIGNED_BYTE,e[3]),u.texImage2D(u.TEXTURE_CUBE_MAP_POSITIVE_Y,0,u.RGBA,u.RGBA,u.UNSIGNED_BYTE,e[4]),u.texImage2D(u.TEXTURE_CUBE_MAP_NEGATIVE_Y,0,u.RGBA,u.RGBA,u.UNSIGNED_BYTE,e[5])}else a&&u.pixelStorei(u.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),u.texImage2D(u.TEXTURE_CUBE_MAP_POSITIVE_Z,0,c,c,u.UNSIGNED_BYTE,e[0]),u.texImage2D(u.TEXTURE_CUBE_MAP_NEGATIVE_Z,0,c,c,u.UNSIGNED_BYTE,e[1]),u.texImage2D(u.TEXTURE_CUBE_MAP_POSITIVE_X,0,c,c,u.UNSIGNED_BYTE,e[2]),u.texImage2D(u.TEXTURE_CUBE_MAP_NEGATIVE_X,0,c,c,u.UNSIGNED_BYTE,e[3]),u.texImage2D(u.TEXTURE_CUBE_MAP_POSITIVE_Y,0,c,c,u.UNSIGNED_BYTE,e[4]),u.texImage2D(u.TEXTURE_CUBE_MAP_NEGATIVE_Y,0,c,c,u.UNSIGNED_BYTE,e[5]),a&&u.pixelStorei(u.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1);this._mipmap&&this._isPot(n)&&this._isPot(i)?(u.generateMipmap(this._glTextureType),this._setGPUMemory(n*i*4*(1+1/3)*6)):this._setGPUMemory(n*i*4*6),this._setWarpMode(u.TEXTURE_WRAP_S,this._wrapModeU),this._setWarpMode(u.TEXTURE_WRAP_T,this._wrapModeV),this._setFilterMode(this._filterMode),this._readyed=!0,this._activeResource()}},{key:"setSixSidePixels",value:function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;if(!e)throw new Error("TextureCube:pixels can't be null.");var i=Math.max(this._width>>n,1),a=Math.max(this._height>>n,1),r=i*a*this._getFormatByteCount();if(e[0].length<r)throw"TextureCube:pixels length should at least "+r+".";if(this._setPixels(e,n,i,a),0===n){var o=t.LayaGL.instance;this._setWarpMode(o.TEXTURE_WRAP_S,this._wrapModeU),this._setWarpMode(o.TEXTURE_WRAP_T,this._wrapModeV)}this._readyed=!0,this._activeResource()}},{key:"setImageSource",value:function(n,i){var a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=this._width,o=this._height;if(!i||r===i.width&&o===i.height){var s=t.LayaGL.instance;t.WebGLContext.bindTexture(s,this._glTextureType,this._glTexture);var l=this._getGLFormat();switch(n){case e.TextureCubeFace.NegativeX:s.texImage2D(s.TEXTURE_CUBE_MAP_NEGATIVE_X,a,l,l,s.UNSIGNED_BYTE,i);break;case e.TextureCubeFace.PositiveX:s.texImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X,a,l,l,s.UNSIGNED_BYTE,i);break;case e.TextureCubeFace.NegativeY:s.texImage2D(s.TEXTURE_CUBE_MAP_NEGATIVE_Y,a,l,l,s.UNSIGNED_BYTE,i);break;case e.TextureCubeFace.PositiveY:s.texImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_Y,a,l,l,s.UNSIGNED_BYTE,i);break;case e.TextureCubeFace.NegativeZ:s.texImage2D(s.TEXTURE_CUBE_MAP_NEGATIVE_Z,a,l,l,s.UNSIGNED_BYTE,i);break;case e.TextureCubeFace.PositiveZ:s.texImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_Z,a,l,l,s.UNSIGNED_BYTE,i)}this._mipmap&&this._isPot(r)&&this._isPot(o)?(s.generateMipmap(this._glTextureType),this._setGPUMemory(r*o*4*(1+1/3)*6)):this._setGPUMemory(r*o*4*6),this._setWarpMode(s.TEXTURE_WRAP_S,this._wrapModeU),this._setWarpMode(s.TEXTURE_WRAP_T,this._wrapModeV),this._setFilterMode(this._filterMode),this._readyed=!0}else console.log("TextureCube: imageSource's width and height must same.")}},{key:"defaulteTexture",get:function(){return TextureCube.grayTexture}}],[{key:"__init__",value:function(){var e=new TextureCube(1,t.TextureFormat.R8G8B8,!1),n=new TextureCube(1,t.TextureFormat.R8G8B8,!1),i=new Uint8Array(3);i[0]=0,i[1]=0,i[2]=0,e.setSixSidePixels([i,i,i,i,i,i]),e.lock=!0,i[0]=128,i[1]=128,i[2]=128,n.setSixSidePixels([i,i,i,i,i,i]),n.lock=!0,TextureCube._grayTexture=n,TextureCube._blackTexture=e}},{key:"_parse",value:function(e){arguments.length>1&&void 0!==arguments[1]&&arguments[1];var t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,n=t?new TextureCube(0,t[0],t[1]):new TextureCube(0);return n.setSixSideImageSources(e),n}},{key:"_parseBin",value:function(e){arguments.length>1&&void 0!==arguments[1]&&arguments[1];var t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,n=t?new TextureCube(0,t[0],t[1]):new TextureCube(0);return n.setSixSideImageSources(e),n}},{key:"load",value:function(e,n){var i=t.LoaderManager.createMap[t.Utils.getFilecompatibleExtension(e)]?t.Utils.getFilecompatibleExtension(e):t.Utils.getFileExtension(e),a=t.LoaderManager.createMap[i]?t.LoaderManager.createMap[i][0]:null;t.ILaya.loader.create(e,n,null,a)}},{key:"blackTexture",get:function(){return TextureCube._blackTexture}},{key:"grayTexture",get:function(){return TextureCube._grayTexture}}]),TextureCube}();Ot.TEXTURECUBE="TEXTURECUBE",Ot.TEXTURECUBEBIN="TEXTURECUBEBIN";var Nt=function(){function LightQueue(){_classCallCheck(this,LightQueue),this._length=0,this._elements=[]}return _createClass(LightQueue,[{key:"add",value:function(e){this._length===this._elements.length?this._elements.push(e):this._elements[this._length]=e,this._length++}},{key:"remove",value:function(e){var t=this._elements.indexOf(e);if(this._length--,t!==this._length){var n=this._elements[this._length];this._elements[t]=n}}},{key:"shift",value:function(){return this._length--,this._elements.shift()}},{key:"getBrightestLight",value:function(){for(var e,t=-1,n=this._elements,i=0;i<this._length;i++){var a=n[i]._intensity;t<a&&(t=a,e=i)}return e}},{key:"normalLightOrdering",value:function(e){var t=this._elements[0];this._elements[0]=this._elements[e],this._elements[e]=t}}]),LightQueue}(),bt=function(e){function AlternateLightQueue(){return _classCallCheck(this,AlternateLightQueue),_possibleConstructorReturn(this,_getPrototypeOf(AlternateLightQueue).apply(this,arguments))}return _inherits(AlternateLightQueue,Nt),_createClass(AlternateLightQueue,[{key:"remove",value:function(e){var t=this._elements.indexOf(e);this._elements.splice(t,1),this._length--}}]),AlternateLightQueue}(),kt=function(e){function PixelLineMaterial(){var e;return _classCallCheck(this,PixelLineMaterial),(e=_possibleConstructorReturn(this,_getPrototypeOf(PixelLineMaterial).call(this))).setShaderName("LineShader"),e._shaderValues.setVector(PixelLineMaterial.COLOR,new a(1,1,1,1)),e}return _inherits(PixelLineMaterial,st),_createClass(PixelLineMaterial,[{key:"clone",value:function(){var e=new PixelLineMaterial;return this.cloneTo(e),e}},{key:"color",get:function(){return this._shaderValues.getVector(PixelLineMaterial.COLOR)},set:function(e){this._shaderValues.setVector(PixelLineMaterial.COLOR,e)}}],[{key:"__initDefine__",value:function(){}}]),PixelLineMaterial}();kt.COLOR=_e.propertyNameToID("u_Color");var wt=function(){function BoundBox(e,t){_classCallCheck(this,BoundBox),this.min=e,this.max=t}return _createClass(BoundBox,[{key:"_rotateExtents",value:function(e,t,n){var i=e.x,a=e.y,r=e.z,o=t.elements;n.x=Math.abs(o[0]*i)+Math.abs(o[4]*a)+Math.abs(o[8]*r),n.y=Math.abs(o[1]*i)+Math.abs(o[5]*a)+Math.abs(o[9]*r),n.z=Math.abs(o[2]*i)+Math.abs(o[6]*a)+Math.abs(o[10]*r)}},{key:"getCorners",value:function(e){e.length=8;var t=this.min.x,n=this.min.y,i=this.min.z,a=this.max.x,r=this.max.y,s=this.max.z;e[0]=new o(t,r,s),e[1]=new o(a,r,s),e[2]=new o(a,n,s),e[3]=new o(t,n,s),e[4]=new o(t,r,i),e[5]=new o(a,r,i),e[6]=new o(a,n,i),e[7]=new o(t,n,i)}},{key:"getCenter",value:function(e){o.add(this.min,this.max,e),o.scale(e,.5,e)}},{key:"getExtent",value:function(e){o.subtract(this.max,this.min,e),o.scale(e,.5,e)}},{key:"setCenterAndExtent",value:function(e,t){o.subtract(e,t,this.min),o.add(e,t,this.max)}},{key:"tranform",value:function(e,t){var n=BoundBox._tempVector30,i=BoundBox._tempVector31;this.getCenter(n),this.getExtent(i),o.transformCoordinate(n,e,n),this._rotateExtents(i,e,i),t.setCenterAndExtent(n,i)}},{key:"toDefault",value:function(){this.min.toDefault(),this.max.toDefault()}},{key:"cloneTo",value:function(e){var t=e;this.min.cloneTo(t.min),this.max.cloneTo(t.max)}},{key:"clone",value:function(){var e=new BoundBox(new o,new o);return this.cloneTo(e),e}}],[{key:"createfromPoints",value:function(e,t){if(null==e)throw new Error("points");var n=t.min,i=t.max;n.x=Number.MAX_VALUE,n.y=Number.MAX_VALUE,n.z=Number.MAX_VALUE,i.x=-Number.MAX_VALUE,i.y=-Number.MAX_VALUE,i.z=-Number.MAX_VALUE;for(var a=0,r=e.length;a<r;++a)o.min(n,e[a],n),o.max(i,e[a],i)}},{key:"merge",value:function(e,t,n){o.min(e.min,t.min,n.min),o.max(e.max,t.max,n.max)}}]),BoundBox}();wt._tempVector30=new o,wt._tempVector31=new o;var Bt=function(){function Bounds(e,t){_classCallCheck(this,Bounds),this._updateFlag=0,this._center=new o,this._extent=new o,this._boundBox=new wt(new o,new o),e.cloneTo(this._boundBox.min),t.cloneTo(this._boundBox.max),this._setUpdateFlag(Bounds._UPDATE_CENTER|Bounds._UPDATE_EXTENT,!0)}return _createClass(Bounds,[{key:"setMin",value:function(e){var t=this._boundBox.min;e!==t&&e.cloneTo(t),this._setUpdateFlag(Bounds._UPDATE_CENTER|Bounds._UPDATE_EXTENT,!0),this._setUpdateFlag(Bounds._UPDATE_MIN,!1)}},{key:"getMin",value:function(){var e=this._boundBox.min;return this._getUpdateFlag(Bounds._UPDATE_MIN)&&(this._getMin(this.getCenter(),this.getExtent(),e),this._setUpdateFlag(Bounds._UPDATE_MIN,!1)),e}},{key:"setMax",value:function(e){var t=this._boundBox.max;e!==t&&e.cloneTo(t),this._setUpdateFlag(Bounds._UPDATE_CENTER|Bounds._UPDATE_EXTENT,!0),this._setUpdateFlag(Bounds._UPDATE_MAX,!1)}},{key:"getMax",value:function(){var e=this._boundBox.max;return this._getUpdateFlag(Bounds._UPDATE_MAX)&&(this._getMax(this.getCenter(),this.getExtent(),e),this._setUpdateFlag(Bounds._UPDATE_MAX,!1)),e}},{key:"setCenter",value:function(e){e!==this._center&&e.cloneTo(this._center),this._setUpdateFlag(Bounds._UPDATE_MIN|Bounds._UPDATE_MAX,!0),this._setUpdateFlag(Bounds._UPDATE_CENTER,!1)}},{key:"getCenter",value:function(){return this._getUpdateFlag(Bounds._UPDATE_CENTER)&&(this._getCenter(this.getMin(),this.getMax(),this._center),this._setUpdateFlag(Bounds._UPDATE_CENTER,!1)),this._center}},{key:"setExtent",value:function(e){e!==this._extent&&e.cloneTo(this._extent),this._setUpdateFlag(Bounds._UPDATE_MIN|Bounds._UPDATE_MAX,!0),this._setUpdateFlag(Bounds._UPDATE_EXTENT,!1)}},{key:"getExtent",value:function(){return this._getUpdateFlag(Bounds._UPDATE_EXTENT)&&(this._getExtent(this.getMin(),this.getMax(),this._extent),this._setUpdateFlag(Bounds._UPDATE_EXTENT,!1)),this._extent}},{key:"_getUpdateFlag",value:function(e){return 0!=(this._updateFlag&e)}},{key:"_setUpdateFlag",value:function(e,t){t?this._updateFlag|=e:this._updateFlag&=~e}},{key:"_getCenter",value:function(e,t,n){o.add(e,t,n),o.scale(n,.5,n)}},{key:"_getExtent",value:function(e,t,n){o.subtract(t,e,n),o.scale(n,.5,n)}},{key:"_getMin",value:function(e,t,n){o.subtract(e,t,n)}},{key:"_getMax",value:function(e,t,n){o.add(e,t,n)}},{key:"_rotateExtents",value:function(e,t,n){var i=e.x,a=e.y,r=e.z,o=t.elements;n.x=Math.abs(o[0]*i)+Math.abs(o[4]*a)+Math.abs(o[8]*r),n.y=Math.abs(o[1]*i)+Math.abs(o[5]*a)+Math.abs(o[9]*r),n.z=Math.abs(o[2]*i)+Math.abs(o[6]*a)+Math.abs(o[10]*r)}},{key:"_tranform",value:function(e,t){var n=t._center,i=t._extent;o.transformCoordinate(this.getCenter(),e,n),this._rotateExtents(this.getExtent(),e,i),t._boundBox.setCenterAndExtent(n,i),t._updateFlag=0}},{key:"_getBoundBox",value:function(){if(this._updateFlag&Bounds._UPDATE_MIN){var e=this._boundBox.min;this._getMin(this.getCenter(),this.getExtent(),e),this._setUpdateFlag(Bounds._UPDATE_MIN,!1)}if(this._updateFlag&Bounds._UPDATE_MAX){var t=this._boundBox.max;this._getMax(this.getCenter(),this.getExtent(),t),this._setUpdateFlag(Bounds._UPDATE_MAX,!1)}return this._boundBox}},{key:"calculateBoundsintersection",value:function(e){var t=this.getMax(),n=this.getMin(),i=e.getMax(),a=e.getMin(),r=Bounds.TEMP_VECTOR3_MAX0,o=Bounds.TEMP_VECTOR3_MAX1,s=this.getExtent(),l=e.getExtent();return r.setValue(Math.max(t.x,i.x)-Math.min(n.x,a.x),Math.max(t.y,i.y)-Math.min(n.y,a.y),Math.max(t.z,i.z)-Math.min(n.z,a.z)),o.setValue(2*(s.x+l.x),2*(s.y+l.y),2*(s.z+l.z)),r.x>o.x?-1:r.y>o.y?-1:r.z>o.z?-1:(o.x-r.x)*(o.y-r.y)*(o.z-r.z)}},{key:"cloneTo",value:function(e){var t=e;this.getMin().cloneTo(t._boundBox.min),this.getMax().cloneTo(t._boundBox.max),this.getCenter().cloneTo(t._center),this.getExtent().cloneTo(t._extent),t._updateFlag=0}},{key:"clone",value:function(){var e=new Bounds(new o,new o);return this.cloneTo(e),e}}]),Bounds}();Bt._UPDATE_MIN=1,Bt._UPDATE_MAX=2,Bt._UPDATE_CENTER=4,Bt._UPDATE_EXTENT=8,Bt.TEMP_VECTOR3_MAX0=new o,Bt.TEMP_VECTOR3_MAX1=new o;var Vt=function(){function GeometryElement(){_classCallCheck(this,GeometryElement),this._destroyed=!1}return _createClass(GeometryElement,[{key:"_getType",value:function(){throw"GeometryElement:must override it."}},{key:"_prepareRender",value:function(e){return!0}},{key:"_render",value:function(e){throw"GeometryElement:must override it."}},{key:"destroy",value:function(){this._destroyed||(this._destroyed=!0)}},{key:"destroyed",get:function(){return this._destroyed}}]),GeometryElement}();Vt._typeCounter=0;var Ft=function(){function PixelLineVertex(){_classCallCheck(this,PixelLineVertex)}return _createClass(PixelLineVertex,[{key:"vertexDeclaration",get:function(){return PixelLineVertex._vertexDeclaration}}],[{key:"__init__",value:function(){PixelLineVertex._vertexDeclaration=new ae(28,[new re(0,ne.Vector3,Ne.MESH_POSITION0),new re(12,ne.Vector4,Ne.MESH_COLOR0)])}},{key:"vertexDeclaration",get:function(){return PixelLineVertex._vertexDeclaration}}]),PixelLineVertex}(),Ut=function(e){function PixelLineFilter(e,n){var i;_classCallCheck(this,PixelLineFilter),(i=_possibleConstructorReturn(this,_getPrototypeOf(PixelLineFilter).call(this)))._floatCountPerVertices=7,i._minUpdate=Number.MAX_VALUE,i._maxUpdate=Number.MIN_VALUE,i._bufferState=new oe,i._floatBound=new Float32Array(6),i._calculateBound=!1,i._maxLineCount=0,i._lineCount=0;var a=2*n;i._owner=e,i._maxLineCount=n,i._vertices=new Float32Array(a*i._floatCountPerVertices),i._vertexBuffer=new te(Ft.vertexDeclaration.vertexStride*a,t.LayaGL.instance.STATIC_DRAW,!1),i._vertexBuffer.vertexDeclaration=Ft.vertexDeclaration,i._bufferState.bind(),i._bufferState.applyVertexBuffer(i._vertexBuffer),i._bufferState.unBind();var r=PixelLineFilter._tempVector0,o=PixelLineFilter._tempVector1;return r.setValue(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),o.setValue(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),i._bounds=new Bt(r,o),i}return _inherits(PixelLineFilter,Vt),_createClass(PixelLineFilter,[{key:"_getType",value:function(){return PixelLineFilter._type}},{key:"_resizeLineData",value:function(e){var n=2*e,i=this._vertices;this._vertexBuffer.destroy(),this._maxLineCount=e;var a=n*this._floatCountPerVertices;this._vertices=new Float32Array(a),this._vertexBuffer=new te(Ft.vertexDeclaration.vertexStride*n,t.LayaGL.instance.STATIC_DRAW,!1),this._vertexBuffer.vertexDeclaration=Ft.vertexDeclaration,a<i.length?(this._vertices.set(new Float32Array(i.buffer,0,a)),this._vertexBuffer.setData(this._vertices.buffer,0,0,4*a)):(this._vertices.set(i),this._vertexBuffer.setData(this._vertices.buffer,0,0,4*i.length)),this._bufferState.bind(),this._bufferState.applyVertexBuffer(this._vertexBuffer),this._bufferState.unBind()}},{key:"_updateLineVertices",value:function(e,t,n,i,a){t&&(this._vertices[e+0]=t.x,this._vertices[e+1]=t.y,this._vertices[e+2]=t.z),i&&(this._vertices[e+3]=i.r,this._vertices[e+4]=i.g,this._vertices[e+5]=i.b,this._vertices[e+6]=i.a),n&&(this._vertices[e+7]=n.x,this._vertices[e+8]=n.y,this._vertices[e+9]=n.z),a&&(this._vertices[e+10]=a.r,this._vertices[e+11]=a.g,this._vertices[e+12]=a.b,this._vertices[e+13]=a.a),this._minUpdate=Math.min(this._minUpdate,e),this._maxUpdate=Math.max(this._maxUpdate,e+2*this._floatCountPerVertices);var r=this._bounds,s=this._floatBound,l=r.getMin(),u=r.getMax();o.min(l,t,l),o.min(l,n,l),o.max(u,t,u),o.max(u,n,u),r.setMin(l),r.setMax(u),s[0]=l.x,s[1]=l.y,s[2]=l.z,s[3]=u.x,s[4]=u.y,s[5]=u.z}},{key:"_reCalculateBound",value:function(){if(this._calculateBound){var e=this._vertices,t=PixelLineFilter._tempVector0,n=PixelLineFilter._tempVector1;t.setValue(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),n.setValue(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);for(var i=0;i<2*this._lineCount;++i){var a=this._floatCountPerVertices*i,r=e[a+0],o=e[a+1],s=e[a+2];t.x=Math.min(r,t.x),t.y=Math.min(o,t.y),t.z=Math.min(s,t.z),n.x=Math.max(r,n.x),n.y=Math.max(o,n.y),n.z=Math.max(s,n.z)}this._bounds.setMin(t),this._bounds.setMax(n);var l=this._floatBound;l[0]=t.x,l[1]=t.y,l[2]=t.z,l[3]=n.x,l[4]=n.y,l[5]=n.z,this._calculateBound=!1}}},{key:"_removeLineData",value:function(e){var t=2*this._floatCountPerVertices,n=e+1,i=e*t,a=this._vertices,r=new Float32Array(a.buffer,n*t*4,(this._lineCount-n)*t);a.set(r,i),this._minUpdate=Math.min(this._minUpdate,i),this._maxUpdate=Math.max(this._maxUpdate,i+r.length),this._lineCount--;var o=this._floatBound,s=a[i],l=a[i+1],u=a[i+2],c=a[i+7],h=a[i+8],_=a[i+9],d=o[0],f=o[1],m=o[2],p=o[3],T=o[4],v=o[5];s!==d&&s!==p&&l!==f&&l!==T&&u!==m&&u!==v&&c!==d&&c!==p&&h!==f&&h!==T&&_!==m&&_!==v||(this._calculateBound=!0)}},{key:"_updateLineData",value:function(e,t,n,i,a){var r=2*this._floatCountPerVertices;this._updateLineVertices(e*r,t,n,i,a)}},{key:"_updateLineDatas",value:function(e,t){for(var n=2*this._floatCountPerVertices,i=t.length,a=0;a<i;a++){var r=t[a];this._updateLineVertices((e+a)*n,r.startPosition,r.endPosition,r.startColor,r.endColor)}}},{key:"_getLineData",value:function(e,t){var n=t.startPosition,i=t.startColor,a=t.endPosition,r=t.endColor,o=this._vertices,s=e*this._floatCountPerVertices*2;n.x=o[s+0],n.y=o[s+1],n.z=o[s+2],i.r=o[s+3],i.g=o[s+4],i.b=o[s+5],i.a=o[s+6],a.x=o[s+7],a.y=o[s+8],a.z=o[s+9],r.r=o[s+10],r.g=o[s+11],r.b=o[s+12],r.a=o[s+13]}},{key:"_prepareRender",value:function(e){return!0}},{key:"_render",value:function(e){if(this._minUpdate!==Number.MAX_VALUE&&this._maxUpdate!==Number.MIN_VALUE&&(this._vertexBuffer.setData(this._vertices.buffer,4*this._minUpdate,4*this._minUpdate,4*(this._maxUpdate-this._minUpdate)),this._minUpdate=Number.MAX_VALUE,this._maxUpdate=Number.MIN_VALUE),this._lineCount>0){this._bufferState.bind();var n=t.LayaGL.instance;n.drawArrays(n.LINES,0,2*this._lineCount),t.Stat.renderBatches++}}},{key:"destroy",value:function(){this._destroyed||(_get(_getPrototypeOf(PixelLineFilter.prototype),"destroy",this).call(this),this._bufferState.destroy(),this._vertexBuffer.destroy(),this._bufferState=null,this._vertexBuffer=null,this._vertices=null)}}]),PixelLineFilter}();Ut._tempVector0=new o,Ut._tempVector1=new o,Ut._type=Vt._typeCounter++;var Gt=function(e){function RenderableSprite3D(e){return _classCallCheck(this,RenderableSprite3D),_possibleConstructorReturn(this,_getPrototypeOf(RenderableSprite3D).call(this,e))}return _inherits(RenderableSprite3D,ve),_createClass(RenderableSprite3D,[{key:"_onInActive",value:function(){_get(_getPrototypeOf(RenderableSprite3D.prototype),"_onInActive",this).call(this),this._scene._removeRenderObject(this._render)}},{key:"_onActive",value:function(){_get(_getPrototypeOf(RenderableSprite3D.prototype),"_onActive",this).call(this),this._scene._addRenderObject(this._render)}},{key:"_onActiveInScene",value:function(){if(_get(_getPrototypeOf(RenderableSprite3D.prototype),"_onActiveInScene",this).call(this),l.Laya3D._editerEnvironment){var e=this._scene,t=new a;e._allotPickColorByID(this.id,t),e._pickIdToSprite[this.id]=this,this._render._shaderValues.setVector(RenderableSprite3D.PICKCOLOR,t)}}},{key:"_addToInitStaticBatchManager",value:function(){}},{key:"_setBelongScene",value:function(e){_get(_getPrototypeOf(RenderableSprite3D.prototype),"_setBelongScene",this).call(this,e),this._render._setBelongScene(e)}},{key:"_setUnBelongScene",value:function(){this._render._shaderValues.removeDefine(RenderableSprite3D.SAHDERDEFINE_LIGHTMAP),_get(_getPrototypeOf(RenderableSprite3D.prototype),"_setUnBelongScene",this).call(this)}},{key:"_changeHierarchyAnimator",value:function(e){if(this._hierarchyAnimator){var t=this._hierarchyAnimator._renderableSprites;t.splice(t.indexOf(this),1)}e&&e._renderableSprites.push(this),_get(_getPrototypeOf(RenderableSprite3D.prototype),"_changeHierarchyAnimator",this).call(this,e)}},{key:"destroy",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];_get(_getPrototypeOf(RenderableSprite3D.prototype),"destroy",this).call(this,e),this._render._destroy(),this._render=null}},{key:"_create",value:function(){return new RenderableSprite3D(this.name)}}],[{key:"__init__",value:function(){RenderableSprite3D.SHADERDEFINE_RECEIVE_SHADOW=_e.getDefineByName("RECEIVESHADOW"),RenderableSprite3D.SAHDERDEFINE_LIGHTMAP=_e.getDefineByName("LIGHTMAP"),RenderableSprite3D.SHADERDEFINE_LIGHTMAP_DIRECTIONAL=_e.getDefineByName("LIGHTMAP_DIRECTIONAL")}}]),RenderableSprite3D}();Gt.LIGHTMAPSCALEOFFSET=_e.propertyNameToID("u_LightmapScaleOffset"),Gt.LIGHTMAP=_e.propertyNameToID("u_LightMap"),Gt.LIGHTMAP_DIRECTION=_e.propertyNameToID("u_LightMapDirection"),Gt.PICKCOLOR=_e.propertyNameToID("u_PickColor"),Gt.REFLECTIONTEXTURE=_e.propertyNameToID("u_ReflectTexture"),Gt.REFLECTIONCUBE_HDR_PARAMS=_e.propertyNameToID("u_ReflectCubeHDRParams"),Gt.REFLECTIONCUBE_PROBEPOSITION=_e.propertyNameToID("u_SpecCubeProbePosition"),Gt.REFLECTIONCUBE_PROBEBOXMAX=_e.propertyNameToID("u_SpecCubeBoxMax"),Gt.REFLECTIONCUBE_PROBEBOXMIN=_e.propertyNameToID("u_SpecCubeBoxMin");var Ht=function BatchMark(){_classCallCheck(this,BatchMark),this.updateMark=-1,this.indexInList=-1,this.batched=!1},zt=function(e){function SubMeshInstanceBatch(){var e;_classCallCheck(this,SubMeshInstanceBatch),(e=_possibleConstructorReturn(this,_getPrototypeOf(SubMeshInstanceBatch).call(this))).instanceWorldMatrixData=new Float32Array(16*SubMeshInstanceBatch.maxInstanceCount),e.instanceSimpleAnimatorData=new Float32Array(4*SubMeshInstanceBatch.maxInstanceCount);var n=t.LayaGL.instance;return e.instanceWorldMatrixBuffer=new te(4*e.instanceWorldMatrixData.length,n.DYNAMIC_DRAW),e.instanceWorldMatrixBuffer.vertexDeclaration=Ne.instanceWorldMatrixDeclaration,e.instanceSimpleAnimatorBuffer=new te(4*e.instanceSimpleAnimatorData.length,n.DYNAMIC_DRAW),e.instanceSimpleAnimatorBuffer.vertexDeclaration=Ne.instanceSimpleAnimatorDeclaration,e}return _inherits(SubMeshInstanceBatch,Vt),_createClass(SubMeshInstanceBatch,[{key:"_render",value:function(e){var n=t.LayaGL.instance,i=e.renderElement,a=i.instanceSubMesh,r=i.instanceBatchElementList.length,o=a._indexCount;a._mesh._instanceBufferState.bind(),t.LayaGL.layaGPUInstance.drawElementsInstanced(n.TRIANGLES,o,n.UNSIGNED_SHORT,2*a._indexStart,r),t.Stat.renderBatches++,t.Stat.savedRenderBatches+=r-1,t.Stat.trianglesFaces+=o*r/3}}],[{key:"__init__",value:function(){SubMeshInstanceBatch.instance=new SubMeshInstanceBatch}}]),SubMeshInstanceBatch}();zt.maxInstanceCount=1024;var Wt=function(e){function SubMeshRenderElement(){var e;return _classCallCheck(this,SubMeshRenderElement),(e=_possibleConstructorReturn(this,_getPrototypeOf(SubMeshRenderElement).call(this)))._dynamicWorldPositionNormalNeedUpdate=!0,e}return _inherits(SubMeshRenderElement,qe),_createClass(SubMeshRenderElement,[{key:"_onWorldMatrixChanged",value:function(){this._dynamicWorldPositionNormalNeedUpdate=!0}},{key:"_computeWorldPositionsAndNormals",value:function(e,t,n,i){if(this._dynamicWorldPositionNormalNeedUpdate){for(var a=this._geometry,r=a._vertexBuffer,o=r.vertexDeclaration.vertexStride/4,s=r.getFloat32Data(),l=this._transform.worldMatrix,u=this._transform.rotation,c=a._indices,h=0;h<i;h++){var _=(n?c[h]:h)*o,d=3*h;P.transformVector3ArrayToVector3ArrayCoordinate(s,_+e,l,this._dynamicWorldPositions,d),-1!==t&&P.transformVector3ArrayByQuat(s,_+t,u,this._dynamicWorldNormals,d)}this._dynamicWorldPositionNormalNeedUpdate=!1}}},{key:"setTransform",value:function(e){this._transform!==e&&(this._transform&&this._transform.off(t.Event.TRANSFORM_CHANGED,this,this._onWorldMatrixChanged),e&&e.on(t.Event.TRANSFORM_CHANGED,this,this._onWorldMatrixChanged),this._dynamicWorldPositionNormalNeedUpdate=!0,this._transform=e)}},{key:"setGeometry",value:function(e){if(this._geometry!==e){var t=e,n=t._mesh;if(n){var i=n._subMeshes.length>1,a=i?t._indexCount:n._vertexCount;if(a<=l.SubMeshDynamicBatch.maxAllowVertexCount){var r=3*a;this._dynamicVertexBatch=!0,this._dynamicWorldPositions=new Float32Array(r),this._dynamicWorldNormals=new Float32Array(r),this._dynamicVertexCount=a,this._dynamicMultiSubMesh=i}else this._dynamicVertexBatch=!1}this._geometry=e}}},{key:"addToOpaqueRenderQueue",value:function(e,n){var i=this.staticBatch,a=n.elements,r=a.elements;if(!i||this.render._probReflection&&!this.render._probReflection._isScene)if(this.renderSubShader._owner._enableInstancing&&t.LayaGL.layaGPUInstance.supportInstance()&&this.render.lightmapIndex<0&&(!this.render._probReflection||this.render._probReflection._isScene)){var o=this._geometry,s=l.MeshRenderDynamicBatchManager.instance,u=s.getInstanceBatchOpaquaMark(this.render.receiveShadow,this.material.id,o._id,this._transform._isFrontFaceInvert);if(s._updateCountMark===u.updateMark){var c=u.indexInList;if(u.batched){var h=r[c].instanceBatchElementList;h.length===zt.maxInstanceCount?(u.updateMark=s._updateCountMark,u.indexInList=a.length,u.batched=!1,a.add(this)):h.add(this)}else{var _=r[c],d=_.render,f=s._getBatchRenderElementFromPool();f.renderType=qe.RENDERTYPE_INSTANCEBATCH,f.setGeometry(zt.instance),f.material=_.material,f.setTransform(null),f.render=d,f.instanceSubMesh=o,f.renderSubShader=_.renderSubShader;var m=f.instanceBatchElementList;m.length=0,m.add(_),m.add(this),r[c]=f,u.batched=!0}}else u.updateMark=s._updateCountMark,u.indexInList=a.length,u.batched=!1,a.add(this)}else if(this._dynamicVertexBatch){var p=this._geometry._vertexBuffer.vertexDeclaration,T=l.MeshRenderDynamicBatchManager.instance,v=T.getVertexBatchOpaquaMark(this.render.lightmapIndex+1,this.render.receiveShadow,this.material.id,p.id);if(T._updateCountMark===v.updateMark){var g=v.indexInList;if(v.batched)r[g].vertexBatchElementList.add(this);else{var E=r[g],y=E.render,S=T._getBatchRenderElementFromPool();S.renderType=qe.RENDERTYPE_VERTEXBATCH,S.setGeometry(l.SubMeshDynamicBatch.instance),S.material=E.material,S.setTransform(null),S.render=y,S.vertexBatchVertexDeclaration=p,S.renderSubShader=E.renderSubShader;var R=S.vertexBatchElementList;R.length=0,R.add(E),R.add(this),r[g]=S,v.batched=!0}}else v.updateMark=T._updateCountMark,v.indexInList=a.length,v.batched=!1,a.add(this)}else a.add(this);else{var C=l.MeshRenderStaticBatchManager.instance,M=C.getBatchOpaquaMark(this.render.lightmapIndex+1,this.render.receiveShadow,this.material.id,i._batchID);if(C._updateCountMark===M.updateMark){var D=M.indexInList;if(M.batched)r[D].staticBatchElementList.add(this);else{var x=r[D],A=x.render,I=C._getBatchRenderElementFromPool();I.renderType=qe.RENDERTYPE_STATICBATCH,I.setGeometry(i),I.material=x.material;var L=i.batchOwner,P=L?L._transform:null;I.setTransform(P),I.render=A,I.renderSubShader=x.renderSubShader;var O=I.staticBatchElementList;O.length=0,O.add(x),O.add(this),r[D]=I,M.batched=!0}}else M.updateMark=C._updateCountMark,M.indexInList=a.length,M.batched=!1,a.add(this)}}},{key:"addToTransparentRenderQueue",value:function(e,n){var i=this.staticBatch,a=n.elements,r=a.elements;if(i){var o=l.MeshRenderStaticBatchManager.instance,s=n.lastTransparentRenderElement;if(s){var u=s.render;if(s._geometry._getType()!==this._geometry._getType()||s.staticBatch!==i||s.material!==this.material||u.receiveShadow!==this.render.receiveShadow||u.lightmapIndex!==this.render.lightmapIndex)a.add(this),n.lastTransparentBatched=!1;else{if(n.lastTransparentBatched)r[a.length-1].staticBatchElementList.add(this);else{var c=o._getBatchRenderElementFromPool();c.renderType=qe.RENDERTYPE_STATICBATCH,c.setGeometry(i),c.material=s.material;var h=i.batchOwner,_=h?h._transform:null;c.setTransform(_),c.render=this.render,c.renderSubShader=s.renderSubShader;var d=c.staticBatchElementList;d.length=0,d.add(s),d.add(this),r[a.length-1]=c}n.lastTransparentBatched=!0}}else a.add(this),n.lastTransparentBatched=!1}else if(this.renderSubShader._owner._enableInstancing&&t.LayaGL.layaGPUInstance.supportInstance()&&this.render.lightmapIndex<0&&(!this.render._probReflection||this.render._probReflection._isScene)){var f=this._geometry,m=l.MeshRenderDynamicBatchManager.instance,p=n.lastTransparentRenderElement;if(p){var T=p.render;if(p._geometry._getType()!==this._geometry._getType()||p._geometry!==f||p.material!==this.material||T.receiveShadow!==this.render.receiveShadow)a.add(this),n.lastTransparentBatched=!1;else if(n.lastTransparentBatched){var v=r[a.length-1].instanceBatchElementList;v.length===zt.maxInstanceCount?(a.add(this),n.lastTransparentBatched=!1):(v.add(this),n.lastTransparentBatched=!0)}else{var g=m._getBatchRenderElementFromPool();g.renderType=qe.RENDERTYPE_INSTANCEBATCH,g.setGeometry(zt.instance),g.material=p.material,g.setTransform(null),g.render=this.render,g.instanceSubMesh=f,g.renderSubShader=p.renderSubShader;var E=g.instanceBatchElementList;E.length=0,E.add(p),E.add(this),r[a.length-1]=g,n.lastTransparentBatched=!0}}else a.add(this),n.lastTransparentBatched=!1}else if(this._dynamicVertexBatch){var y=this._geometry._vertexBuffer.vertexDeclaration,S=l.MeshRenderDynamicBatchManager.instance,R=n.lastTransparentRenderElement;if(R){var C=R.render;if(R._dynamicVertexBatch&&R._geometry._getType()===this._geometry._getType()&&R._geometry._vertexBuffer._vertexDeclaration===y&&R.material===this.material&&C.receiveShadow===this.render.receiveShadow&&C.lightmapIndex===this.render.lightmapIndex){if(n.lastTransparentBatched)r[a.length-1].vertexBatchElementList.add(this);else{var M=S._getBatchRenderElementFromPool();M.renderType=qe.RENDERTYPE_VERTEXBATCH,M.setGeometry(l.SubMeshDynamicBatch.instance),M.material=R.material,M.setTransform(null),M.render=this.render,M.vertexBatchVertexDeclaration=y,M.renderSubShader=R.renderSubShader;var D=M.vertexBatchElementList;D.length=0,D.add(R),D.add(this),r[a.length-1]=M}n.lastTransparentBatched=!0}else a.add(this),n.lastTransparentBatched=!1}else a.add(this),n.lastTransparentBatched=!1}else a.add(this);n.lastTransparentRenderElement=this}},{key:"getInvertFront",value:function(){switch(this.renderType){case qe.RENDERTYPE_NORMAL:return this._transform._isFrontFaceInvert;case qe.RENDERTYPE_STATICBATCH:case qe.RENDERTYPE_VERTEXBATCH:return!1;case qe.RENDERTYPE_INSTANCEBATCH:return this.instanceBatchElementList.elements[0]._transform._isFrontFaceInvert;default:throw"SubMeshRenderElement: unknown renderType"}}},{key:"destroy",value:function(){_get(_getPrototypeOf(SubMeshRenderElement.prototype),"destroy",this).call(this),this._dynamicWorldPositions=null,this._dynamicWorldNormals=null,this.staticBatch=null,this.staticBatchElementList=null,this.vertexBatchElementList=null,this.vertexBatchVertexDeclaration=null}}]),SubMeshRenderElement}(),Xt=function(){function StaticBatchManager(){_classCallCheck(this,StaticBatchManager),this._initBatchSprites=[],this._staticBatches={},this._batchRenderElementPoolIndex=0,this._batchRenderElementPool=[]}return _createClass(StaticBatchManager,[{key:"_partition",value:function(e,t,n){for(var i=e[Math.floor((n+t)/2)];t<=n;){for(;this._compare(e[t],i)<0;)t++;for(;this._compare(e[n],i)>0;)n--;if(t<n){var a=e[t];e[t]=e[n],e[n]=a,t++,n--}else if(t===n){t++;break}}return t}},{key:"_quickSort",value:function(e,t,n){if(e.length>1){var i=this._partition(e,t,n),a=i-1;t<a&&this._quickSort(e,t,a),i<n&&this._quickSort(e,i,n)}}},{key:"_compare",value:function(e,t){throw"StaticBatch:must override this function."}},{key:"_initStaticBatchs",value:function(e){throw"StaticBatch:must override this function."}},{key:"_getBatchRenderElementFromPool",value:function(){throw"StaticBatch:must override this function."}},{key:"_addBatchSprite",value:function(e){this._initBatchSprites.push(e)}},{key:"_clear",value:function(){this._batchRenderElementPoolIndex=0}},{key:"_garbageCollection",value:function(){throw"StaticBatchManager: must override it."}},{key:"dispose",value:function(){this._staticBatches=null}}],[{key:"_addToStaticBatchQueue",value:function(e,t){e instanceof Gt&&t.push(e);for(var n=0,i=e.numChildren;n<i;n++)StaticBatchManager._addToStaticBatchQueue(e._children[n],t)}},{key:"_registerManager",value:function(e){StaticBatchManager._managers.push(e)}},{key:"combine",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;t||(t=[],e&&StaticBatchManager._addToStaticBatchQueue(e,t));var n=t.length;if(n>0){for(var i=0;i<n;i++){var a=t[i];a.destroyed||(a._render._isPartOfStaticBatch?console.warn("StaticBatchManager: Sprite "+a.name+" has a part of Static Batch,it will be ignore."):a._addToInitStaticBatchManager())}for(var r=0,o=StaticBatchManager._managers.length;r<o;r++){StaticBatchManager._managers[r]._initStaticBatchs(e)}}}}]),StaticBatchManager}();Xt._managers=[];var Yt=function(n){function SubMeshStaticBatch(e,t){var n;return _classCallCheck(this,SubMeshStaticBatch),(n=_possibleConstructorReturn(this,_getPrototypeOf(SubMeshStaticBatch).call(this)))._bufferState=new oe,n._batchID=SubMeshStaticBatch._batchIDCounter++,n._batchElements=[],n._currentBatchVertexCount=0,n._currentBatchIndexCount=0,n._vertexDeclaration=t,n.batchOwner=e,n}return _inherits(SubMeshStaticBatch,Vt),_createClass(SubMeshStaticBatch,[{key:"_getStaticBatchBakedVertexs",value:function(e,t,n,i,a,r){var o,s=r._vertexBuffer,l=s.vertexDeclaration,u=l.getVertexElementByUsage(Ne.MESH_POSITION0)._offset/4,h=l.getVertexElementByUsage(Ne.MESH_NORMAL0),_=h?h._offset/4:-1,d=l.getVertexElementByUsage(Ne.MESH_COLOR0),f=d?d._offset/4:-1,m=l.getVertexElementByUsage(Ne.MESH_TEXTURECOORDINATE0),p=m?m._offset/4:-1,T=l.getVertexElementByUsage(Ne.MESH_TEXTURECOORDINATE1),v=T?T._offset/4:-1,g=l.getVertexElementByUsage(Ne.MESH_TANGENT0),E=g?g._offset/4:-1,y=l.vertexStride/4,S=s.getFloat32Data();n?(n.worldMatrix.invert(SubMeshStaticBatch._tempMatrix4x40),o=SubMeshStaticBatch._tempMatrix4x41,c.multiply(SubMeshStaticBatch._tempMatrix4x40,i.worldMatrix,o)):o=i.worldMatrix;var R=SubMeshStaticBatch._tempMatrix4x42;o.invert(R),R.transpose();var C=SubMeshStaticBatch._tempQuaternion0;o.decomposeTransRotScale(SubMeshStaticBatch._tempVector30,C,SubMeshStaticBatch._tempVector31);for(var M=a.lightmapScaleOffset,D=r.vertexCount,x=0;x<D;x++){var A,I,L=x*y,O=18*(x+t);P.transformVector3ArrayToVector3ArrayCoordinate(S,L+u,o,e,O+0),-1!==_&&P.transformVector3ArrayToVector3ArrayNormal(S,L+_,R,e,O+3);var N=O+6;if(-1!==f){var b=L+f;for(A=0,I=4;A<I;A++)e[N+A]=S[b+A]}else for(A=0,I=4;A<I;A++)e[N+A]=1;if(-1!==p){var k=L+p;e[O+10]=S[k],e[O+11]=S[k+1]}if(M&&(-1!==v?P.transformLightingMapTexcoordArray(S,L+v,M,e,O+12):P.transformLightingMapTexcoordArray(S,L+p,M,e,O+12)),-1!==E){var w=L+E;P.transformVector3ArrayToVector3ArrayNormal(S,w,R,e,O+14),e[O+17]=S[w+3]}}return D}},{key:"addTest",value:function(e){var t=e.meshFilter.sharedMesh.vertexCount;return!(this._currentBatchVertexCount+t>SubMeshStaticBatch.maxBatchVertexCount)}},{key:"add",value:function(e){var t=e.meshFilter.sharedMesh,n=t.vertexCount;this._batchElements.push(e);var i=e._render;i._isPartOfStaticBatch=!0,i._staticBatch=this;for(var a=i._renderElements,r=0,o=a.length;r<o;r++)a[r].staticBatch=this;this._currentBatchIndexCount+=t._indexBuffer.indexCount,this._currentBatchVertexCount+=n}},{key:"remove",value:function(e){var t=e.meshFilter.sharedMesh,n=this._batchElements.indexOf(e);if(-1!==n){this._batchElements.splice(n,1);for(var i=e._render._renderElements,a=0,r=i.length;a<r;a++)i[a].staticBatch=null;this._currentBatchIndexCount=this._currentBatchIndexCount-t._indexBuffer.indexCount,this._currentBatchVertexCount=this._currentBatchVertexCount-t.vertexCount,e._render._isPartOfStaticBatch=!1}}},{key:"finishInit",value:function(){this._vertexBuffer&&(this._vertexBuffer.destroy(),this._indexBuffer.destroy(),t.Resource._addGPUMemory(-(this._vertexBuffer._byteLength+this._indexBuffer._byteLength)));var n=t.LayaGL.instance,i=0,a=0,r=this.batchOwner,o=this._vertexDeclaration.vertexStride/4,s=new Float32Array(o*this._currentBatchVertexCount),l=new Uint16Array(this._currentBatchIndexCount);this._vertexBuffer=new te(this._vertexDeclaration.vertexStride*this._currentBatchVertexCount,n.STATIC_DRAW),this._vertexBuffer.vertexDeclaration=this._vertexDeclaration,this._indexBuffer=new Oe(e.IndexFormat.UInt16,this._currentBatchIndexCount,n.STATIC_DRAW);for(var u=0,c=this._batchElements.length;u<c;u++){for(var h,_=this._batchElements[u],d=_.meshFilter.sharedMesh,f=this._getStaticBatchBakedVertexs(s,i,r?r._transform:null,_._transform,_._render,d),m=d._indexBuffer.getData(),p=i,T=a+m.length,v=_._render._renderElements,g=0,E=d.subMeshCount;g<E;g++){var y=d._subMeshes[g],S=a+y._indexStart,R=v[g];R.staticBatchIndexStart=S,R.staticBatchIndexEnd=S+y._indexCount}if(l.set(m,a),r?_._transform._isFrontFaceInvert!==r.transform._isFrontFaceInvert:_._transform._isFrontFaceInvert)for(h=a;h<T;h+=3){l[h]=p+l[h];var C=l[h+1],M=l[h+2];l[h+1]=p+M,l[h+2]=p+C}else for(h=a;h<T;h+=3)l[h]=p+l[h],l[h+1]=p+l[h+1],l[h+2]=p+l[h+2];a+=m.length,i+=f}this._vertexBuffer.setData(s.buffer),this._indexBuffer.setData(l);var D=this._vertexBuffer._byteLength+this._indexBuffer._byteLength;t.Resource._addGPUMemory(D),this._bufferState.bind(),this._bufferState.applyVertexBuffer(this._vertexBuffer),this._bufferState.applyIndexBuffer(this._indexBuffer),this._bufferState.unBind()}},{key:"_render",value:function(e){this._bufferState.bind();for(var n=t.LayaGL.instance,i=e.renderElement.staticBatchElementList,a=i.elements,r=0,o=0,s=i.length,l=1;l<s;l++){if(a[l-1].staticBatchIndexEnd!==a[l].staticBatchIndexStart){var u=a[r].staticBatchIndexStart,c=a[o].staticBatchIndexEnd-u;n.drawElements(n.TRIANGLES,c,n.UNSIGNED_SHORT,2*u),r=++o,t.Stat.trianglesFaces+=c/3}else o++}u=a[r].staticBatchIndexStart,c=a[o].staticBatchIndexEnd-u,n.drawElements(n.TRIANGLES,c,n.UNSIGNED_SHORT,2*u),t.Stat.renderBatches++,t.Stat.savedRenderBatches+=s-1,t.Stat.trianglesFaces+=c/3}},{key:"dispose",value:function(){var e=this._vertexBuffer._byteLength+this._indexBuffer._byteLength;t.Resource._addGPUMemory(-e),this._batchElements=null,this.batchOwner=null,this._vertexDeclaration=null,this._bufferState.destroy(),this._vertexBuffer.destroy(),this._indexBuffer.destroy(),this._vertexBuffer=null,this._indexBuffer=null,this._bufferState=null}}]),SubMeshStaticBatch}();Yt._tempVector30=new o,Yt._tempVector31=new o,Yt._tempQuaternion0=new u,Yt._tempMatrix4x40=new c,Yt._tempMatrix4x41=new c,Yt._tempMatrix4x42=new c,Yt.maxBatchVertexCount=65535,Yt._batchIDCounter=0;var jt,Zt=function(e){function MeshRenderStaticBatchManager(){var e;return _classCallCheck(this,MeshRenderStaticBatchManager),(e=_possibleConstructorReturn(this,_getPrototypeOf(MeshRenderStaticBatchManager).call(this)))._opaqueBatchMarks=[],e._updateCountMark=0,e}return _inherits(MeshRenderStaticBatchManager,Xt),_createClass(MeshRenderStaticBatchManager,[{key:"_compare",value:function(e,t){var n=e._render,i=t._render,a=e.meshFilter.sharedMesh,r=t.meshFilter.sharedMesh,o=n.lightmapIndex-i.lightmapIndex;if(0===o){var s=(n.receiveShadow?1:0)-(i.receiveShadow?1:0);if(0===s){var l=n.sharedMaterial&&i.sharedMaterial?n.sharedMaterial.id-i.sharedMaterial.id:0;if(0===l){var u=a._vertexBuffer.vertexDeclaration.id-r._vertexBuffer.vertexDeclaration.id;return 0===u?r._indexBuffer.indexCount-a._indexBuffer.indexCount:u}return l}return s}return o}},{key:"_getBatchRenderElementFromPool",value:function(){var e=this._batchRenderElementPool[this._batchRenderElementPoolIndex++];return e||(e=new Wt,this._batchRenderElementPool[this._batchRenderElementPoolIndex-1]=e,e.staticBatchElementList=new R),e}},{key:"_getStaticBatch",value:function(e,t,n){var i=e[n];return i||(i=e[n]=new Yt(t,MeshRenderStaticBatchManager._verDec),this._staticBatches[i._batchID]=i),i}},{key:"_initStaticBatchs",value:function(e){var t=this._initBatchSprites;this._quickSort(t,0,t.length-1);for(var n,i=[],a=!1,r=0,o=0,s=t.length;o<s;o++){var l=t[o];if(a)n.addTest(l)?n.add(l):(a=!1,r++);else o!==s-1&&((n=this._getStaticBatch(i,e,r)).add(l),a=!0)}for(o=0,s=i.length;o<s;o++){var u=i[o];u&&u.finishInit()}this._initBatchSprites.length=0}},{key:"_removeRenderSprite",value:function(e){var t=e._render,n=t._staticBatch,i=n._batchElements,a=i.indexOf(e);if(-1!==a){i.splice(a,1),t._staticBatch=null;for(var r=t._renderElements,o=0,s=r.length;o<s;o++)r[o].staticBatch=null}0===i.length&&(delete this._staticBatches[n._batchID],n.dispose())}},{key:"_clear",value:function(){_get(_getPrototypeOf(MeshRenderStaticBatchManager.prototype),"_clear",this).call(this),this._updateCountMark++}},{key:"_garbageCollection",value:function(){for(var e in this._staticBatches){var t=this._staticBatches[e];0===t._batchElements.length&&(t.dispose(),delete this._staticBatches[e])}}},{key:"getBatchOpaquaMark",value:function(e,t,n,i){var a=t?1:0,r=this._opaqueBatchMarks[e]||(this._opaqueBatchMarks[e]=[]),o=r[a]||(r[a]=[]),s=o[n]||(o[n]=[]);return s[i]||(s[i]=new Ht)}}],[{key:"__init__",value:function(){MeshRenderStaticBatchManager._verDec=Ne.getVertexDeclaration("POSITION,NORMAL,COLOR,UV,UV1,TANGENT")}}]),MeshRenderStaticBatchManager}();Zt.instance=new Zt,(jt=e.ReflectionProbeMode||(e.ReflectionProbeMode={}))[jt.off=0]="off",jt[jt.simple=1]="simple";var Qt=function(e){function ReflectionProbe(){var e;return _classCallCheck(this,ReflectionProbe),(e=_possibleConstructorReturn(this,_getPrototypeOf(ReflectionProbe).call(this)))._boxProjection=!1,e._size=new o,e._offset=new o,e._reflectionHDRParams=new a,e._reflectionDecodeFormat=t.TextureDecodeFormat.Normal,e._isScene=!1,e}return _inherits(ReflectionProbe,ve),_createClass(ReflectionProbe,[{key:"_parse",value:function(e,n){_get(_getPrototypeOf(ReflectionProbe.prototype),"_parse",this).call(this,e,n),this._boxProjection=e.boxProjection,this._importance=e.importance,this._reflectionTexture=t.Loader.getRes(e.reflection);var i=this.transform.position;this._size.fromArray(e.boxSize),o.scale(this._size,.5,ReflectionProbe.TEMPVECTOR3),this._offset.fromArray(e.boxOffset);var a=new o,r=new o;o.add(i,ReflectionProbe.TEMPVECTOR3,r),o.add(r,this._offset,r),o.subtract(i,ReflectionProbe.TEMPVECTOR3,a),o.add(a,this._offset,a),this._reflectionDecodeFormat=e.reflectionDecodingFormat,this.intensity=e.intensity,this._bounds?(this._bounds.setMin(a),this._bounds.setMax(r)):this.bounds=new Bt(a,r)}},{key:"_setIndexInReflectionList",value:function(e){this._indexInReflectProbList=e}},{key:"_getIndexInReflectionList",value:function(){return this._indexInReflectProbList}},{key:"_onActive",value:function(){_get(_getPrototypeOf(ReflectionProbe.prototype),"_onActive",this).call(this),this._reflectionTexture&&this.scene._reflectionProbeManager.add(this)}},{key:"_onInActive",value:function(){_get(_getPrototypeOf(ReflectionProbe.prototype),"_onInActive",this).call(this),this.reflectionTexture&&this.scene._reflectionProbeManager.remove(this)}},{key:"destroy",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];this.destroyed||(_get(_getPrototypeOf(ReflectionProbe.prototype),"destroy",this).call(this,e),this._reflectionTexture&&this._reflectionTexture._removeReference(),this._reflectionTexture=null,this._bounds=null)}},{key:"_cloneTo",value:function(e,t,n){var i=e;i.bounds=this.bounds,i.boxProjection=this.boxProjection,i.importance=this.importance,i._size=this._size,i._offset=this._offset,i.intensity=this.intensity,i.reflectionHDRParams=this.reflectionHDRParams,_get(_getPrototypeOf(ReflectionProbe.prototype),"_cloneTo",this).call(this,e,t,n)}},{key:"boxProjection",get:function(){return this._boxProjection},set:function(e){this._boxProjection=e}},{key:"importance",get:function(){return this._importance},set:function(e){this._importance=e}},{key:"intensity",get:function(){return this._intensity},set:function(e){e=Math.max(Math.min(e,1),0),this._reflectionHDRParams.x=e,this._reflectionDecodeFormat==t.TextureDecodeFormat.RGBM&&(this._reflectionHDRParams.x*=5),this._intensity=e}},{key:"reflectionTexture",get:function(){return this._reflectionTexture},set:function(e){this._reflectionTexture=e,this._reflectionTexture._addReference()}},{key:"bounds",get:function(){return this._bounds},set:function(e){this._bounds=e}},{key:"boundsMax",get:function(){return this._bounds.getMax()}},{key:"boundsMin",get:function(){return this._bounds.getMin()}},{key:"probePosition",get:function(){return this.transform.position}},{key:"reflectionHDRParams",get:function(){return this._reflectionHDRParams},set:function(e){this._reflectionHDRParams=e}}]),ReflectionProbe}();Qt.TEMPVECTOR3=new o,Qt.defaultTextureHDRDecodeValues=new a(1,1,0,0);var qt=function(n){function BaseRender(n){var i;return _classCallCheck(this,BaseRender),(i=_possibleConstructorReturn(this,_getPrototypeOf(BaseRender).call(this)))._lightmapScaleOffset=new a(1,1,0,0),i._indexInList=-1,i._indexInCastShadowList=-1,i._boundsChange=!0,i._castShadow=!1,i._supportOctree=!0,i._sharedMaterials=[],i._renderMark=-1,i._indexInOctreeMotionList=-1,i._reflectionMode=e.ReflectionProbeMode.simple,i._updateMark=-1,i._updateRenderType=-1,i._isPartOfStaticBatch=!1,i._staticBatch=null,i._id=++BaseRender._uniqueIDCounter,i._indexInCastShadowList=-1,i._bounds=new Bt(o._ZERO,o._ZERO),i._renderElements=[],i._owner=n,i._enable=!0,i._materialsInstance=[],i._shaderValues=new ie(null),i.lightmapIndex=-1,i.receiveShadow=!1,i.sortingFudge=0,n&&i._owner.transform.on(t.Event.TRANSFORM_CHANGED,_assertThisInitialized(i),i._onWorldMatNeedChange),i}return _inherits(BaseRender,t.EventDispatcher),_createClass(BaseRender,[{key:"_getOctreeNode",value:function(){return this._octreeNode}},{key:"_setOctreeNode",value:function(e){e||-1!==this._indexInOctreeMotionList&&this._octreeNode._octree.removeMotionObject(this),this._octreeNode=e}},{key:"_getIndexInMotionList",value:function(){return this._indexInOctreeMotionList}},{key:"_setIndexInMotionList",value:function(e){this._indexInOctreeMotionList=e}},{key:"_changeMaterialReference",value:function(e,t){e&&e._removeReference(),t._addReference()}},{key:"_getInstanceMaterial",value:function(e,t){var n=e.clone();return n.name=n.name+"(Instance)",this._materialsInstance[t]=!0,this._changeMaterialReference(this._sharedMaterials[t],n),this._sharedMaterials[t]=n,n}},{key:"_isSupportReflection",value:function(){this._surportReflectionProbe=!1;for(var e=this._sharedMaterials,t=0,n=e.length;t<n;t++){var i=e[t];this._surportReflectionProbe=this._surportReflectionProbe||i&&i._shader._supportReflectionProbe}}},{key:"_addReflectionProbeUpdate",value:function(){this._surportReflectionProbe&&1==this._reflectionMode&&this._scene._reflectionProbeManager.addMotionObject(this)}},{key:"_applyLightMapParams",value:function(){var e=this._scene.lightmaps,t=this._shaderValues,n=this._lightmapIndex;if(n>=0&&n<e.length){var i=e[n];t.setTexture(Gt.LIGHTMAP,i.lightmapColor),t.addDefine(Gt.SAHDERDEFINE_LIGHTMAP),i.lightmapDirection?(t.setTexture(Gt.LIGHTMAP_DIRECTION,i.lightmapDirection),t.addDefine(Gt.SHADERDEFINE_LIGHTMAP_DIRECTIONAL)):t.removeDefine(Gt.SHADERDEFINE_LIGHTMAP_DIRECTIONAL)}else t.removeDefine(Gt.SAHDERDEFINE_LIGHTMAP),t.removeDefine(Gt.SHADERDEFINE_LIGHTMAP_DIRECTIONAL)}},{key:"_onWorldMatNeedChange",value:function(e){this._boundsChange=!0,this._octreeNode&&(e&=f.TRANSFORM_WORLDPOSITION|f.TRANSFORM_WORLDQUATERNION|f.TRANSFORM_WORLDSCALE)&&-1===this._indexInOctreeMotionList&&this._octreeNode._octree.addMotionObject(this),this._addReflectionProbeUpdate()}},{key:"_calculateBoundingBox",value:function(){throw"BaseRender: must override it."}},{key:"_getIndexInList",value:function(){return this._indexInList}},{key:"_setIndexInList",value:function(e){this._indexInList=e}},{key:"_setBelongScene",value:function(e){this._scene=e}},{key:"_needRender",value:function(e,t){return!0}},{key:"_OctreeNoRender",value:function(){}},{key:"_renderUpdate",value:function(e,t){}},{key:"_renderUpdateWithCamera",value:function(e,t){}},{key:"_revertBatchRenderUpdate",value:function(e){}},{key:"_destroy",value:function(){-1!==this._indexInOctreeMotionList&&this._octreeNode._octree.removeMotionObject(this),this.offAll();var e=0,t=0;for(e=0,t=this._renderElements.length;e<t;e++)this._renderElements[e].destroy();for(e=0,t=this._sharedMaterials.length;e<t;e++)this._sharedMaterials[e].destroyed||this._sharedMaterials[e]._removeReference();this._renderElements=null,this._owner=null,this._sharedMaterials=null,this._bounds=null,this._lightmapScaleOffset=null}},{key:"markAsUnStatic",value:function(){this._isPartOfStaticBatch&&(Zt.instance._removeRenderSprite(this._owner),this._isPartOfStaticBatch=!1)}},{key:"id",get:function(){return this._id}},{key:"lightmapIndex",get:function(){return this._lightmapIndex},set:function(e){this._lightmapIndex=e}},{key:"lightmapScaleOffset",get:function(){return this._lightmapScaleOffset},set:function(e){if(!e)throw"BaseRender: lightmapScaleOffset can't be null.";this._lightmapScaleOffset=e,this._shaderValues.setVector(Gt.LIGHTMAPSCALEOFFSET,e)}},{key:"enable",get:function(){return this._enable},set:function(e){this._enable=!!e}},{key:"material",get:function(){var e=this._sharedMaterials[0];if(e&&!this._materialsInstance[0]){var t=this._getInstanceMaterial(e,0),n=this._renderElements[0];n&&(n.material=t)}return this._sharedMaterials[0]},set:function(e){this.sharedMaterial=e,this._isSupportReflection()}},{key:"materials",get:function(){for(var e=0,t=this._sharedMaterials.length;e<t;e++)if(!this._materialsInstance[e]){var n=this._getInstanceMaterial(this._sharedMaterials[e],e),i=this._renderElements[e];i&&(i.material=n)}return this._sharedMaterials.slice()},set:function(e){this.sharedMaterials=e,this._isSupportReflection()}},{key:"sharedMaterial",get:function(){return this._sharedMaterials[0]},set:function(e){var t=this._sharedMaterials[0];if(t!==e){this._sharedMaterials[0]=e,this._materialsInstance[0]=!1,this._changeMaterialReference(t,e);var n=this._renderElements[0];n&&(n.material=e)}this._isSupportReflection()}},{key:"sharedMaterials",get:function(){return this._sharedMaterials.slice()},set:function(e){for(var t=this._materialsInstance,n=this._sharedMaterials,i=0,a=n.length;i<a;i++){var r=n[i];r&&r._removeReference()}if(!e)throw new Error("BaseRender: shadredMaterials value can't be null.");var o=e.length;for(t.length=o,n.length=o,i=0;i<o;i++){r=n[i];var s=e[i];if(r!==s){t[i]=!1;var l=this._renderElements[i];l&&(l.material=s)}s&&s._addReference(),n[i]=s}this._isSupportReflection()}},{key:"bounds",get:function(){return this._boundsChange&&(this._calculateBoundingBox(),this._boundsChange=!1),this._bounds}},{key:"receiveShadow",set:function(e){this._receiveShadow!==e&&(this._receiveShadow=e,e?this._shaderValues.addDefine(Gt.SHADERDEFINE_RECEIVE_SHADOW):this._shaderValues.removeDefine(Gt.SHADERDEFINE_RECEIVE_SHADOW))},get:function(){return this._receiveShadow}},{key:"castShadow",get:function(){return this._castShadow},set:function(e){this._castShadow=e}},{key:"isPartOfStaticBatch",get:function(){return this._isPartOfStaticBatch}},{key:"isRender",get:function(){return-1==this._renderMark||this._renderMark==t.Stat.loopCount-1}},{key:"reflectionMode",set:function(e){this._reflectionMode=e},get:function(){return this._reflectionMode}}]),BaseRender}();qt._tempBoundBoxCorners=[new o,new o,new o,new o,new o,new o,new o,new o],qt._uniqueIDCounter=0,qt._defaultLightmapScaleOffset=new a(1,1,0,0);var Kt=function(e){function PixelLineRenderer(e){var t;return _classCallCheck(this,PixelLineRenderer),(t=_possibleConstructorReturn(this,_getPrototypeOf(PixelLineRenderer).call(this,e)))._projectionViewWorldMatrix=new c,t}return _inherits(PixelLineRenderer,qt),_createClass(PixelLineRenderer,[{key:"_calculateBoundingBox",value:function(){var e=this._owner.transform.worldMatrix,t=this._owner._geometryFilter;t._reCalculateBound(),t._bounds._tranform(e,this._bounds)}},{key:"_renderUpdateWithCamera",value:function(e,t){var n=e.projectionViewMatrix,i=this._shaderValues;if(t){var a=t.worldMatrix;i.setMatrix4x4(ve.WORLDMATRIX,a),c.multiply(n,a,this._projectionViewWorldMatrix),i.setMatrix4x4(ve.MVPMATRIX,this._projectionViewWorldMatrix)}else i.setMatrix4x4(ve.WORLDMATRIX,c.DEFAULT),i.setMatrix4x4(ve.MVPMATRIX,n)}}]),PixelLineRenderer}(),Jt=function(e){function PixelLineSprite3D(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:2,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return _classCallCheck(this,PixelLineSprite3D),(e=_possibleConstructorReturn(this,_getPrototypeOf(PixelLineSprite3D).call(this,n)))._isRenderActive=!1,e._isInRenders=!1,e._geometryFilter=new Ut(_assertThisInitialized(e),t),e._render=new Kt(_assertThisInitialized(e)),e._changeRenderObjects(0,kt.defaultMaterial),e}return _inherits(PixelLineSprite3D,Gt),_createClass(PixelLineSprite3D,[{key:"_onInActive",value:function(){t.Stat.spriteCount--,0!=this._geometryFilter._lineCount&&this._isRenderActive&&(this._scene._removeRenderObject(this._render),this._isInRenders=!1),this._isRenderActive=!1}},{key:"_onActive",value:function(){t.Stat.spriteCount++,this._isRenderActive=!0,0!=this._geometryFilter._lineCount&&(this._scene._addRenderObject(this._render),this._isInRenders=!0)}},{key:"_changeRenderObjects",value:function(e,t){var n=this._render._renderElements;t||(t=kt.defaultMaterial);var i=n[e];i||(i=n[e]=new qe),i.setTransform(this._transform),i.setGeometry(this._geometryFilter),i.render=this._render,i.material=t}},{key:"addLine",value:function(e,t,n,i){if(this._geometryFilter._lineCount===this._geometryFilter._maxLineCount)throw"PixelLineSprite3D: lineCount has equal with maxLineCount.";this._geometryFilter._updateLineData(this._geometryFilter._lineCount++,e,t,n,i),this._isRenderActive&&!this._isInRenders&&this._geometryFilter._lineCount>0&&(this._scene._addRenderObject(this._render),this._isInRenders=!0)}},{key:"addLines",value:function(e){var t=this._geometryFilter._lineCount,n=e.length;if(t+n>this._geometryFilter._maxLineCount)throw"PixelLineSprite3D: lineCount plus lines count must less than maxLineCount.";this._geometryFilter._updateLineDatas(t,e),this._geometryFilter._lineCount+=n,this._isRenderActive&&!this._isInRenders&&this._geometryFilter._lineCount>0&&(this._scene._addRenderObject(this._render),this._isInRenders=!0)}},{key:"removeLine",value:function(e){if(!(e<this._geometryFilter._lineCount))throw"PixelLineSprite3D: index must less than lineCount.";this._geometryFilter._removeLineData(e),this._isRenderActive&&this._isInRenders&&0==this._geometryFilter._lineCount&&(this._scene._removeRenderObject(this._render),this._isInRenders=!1)}},{key:"setLine",value:function(e,t,n,i,a){if(!(e<this._geometryFilter._lineCount))throw"PixelLineSprite3D: index must less than lineCount.";this._geometryFilter._updateLineData(e,t,n,i,a)}},{key:"getLine",value:function(e,t){if(!(e<this.lineCount))throw"PixelLineSprite3D: index must less than lineCount.";this._geometryFilter._getLineData(e,t)}},{key:"clear",value:function(){this._geometryFilter._lineCount=0,this._isRenderActive&&this._isInRenders&&(this._scene._removeRenderObject(this._render),this._isInRenders=!1)}},{key:"_create",value:function(){return new PixelLineSprite3D}},{key:"maxLineCount",get:function(){return this._geometryFilter._maxLineCount},set:function(e){this._geometryFilter._resizeLineData(e),this._geometryFilter._lineCount=Math.min(this._geometryFilter._lineCount,e)}},{key:"lineCount",get:function(){return this._geometryFilter._lineCount},set:function(e){if(e>this.maxLineCount)throw"PixelLineSprite3D: lineCount can't large than maxLineCount";this._geometryFilter._lineCount=e}},{key:"pixelLineRenderer",get:function(){return this._render}}]),PixelLineSprite3D}(),$t=function(){function RenderQueue(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];_classCallCheck(this,RenderQueue),this.isTransparent=!1,this.elements=new R,this.lastTransparentRenderElement=null,this.lastTransparentBatched=!1,this.isTransparent=e}return _createClass(RenderQueue,[{key:"_compare",value:function(e,t){var n=e.material.renderQueue-t.material.renderQueue;return 0===n?(this.isTransparent?t.render._distanceForSort-e.render._distanceForSort:e.render._distanceForSort-t.render._distanceForSort)+t.render.sortingFudge-e.render.sortingFudge:n}},{key:"_partitionRenderObject",value:function(e,t){for(var n=this.elements.elements,i=n[Math.floor((t+e)/2)];e<=t;){for(;this._compare(n[e],i)<0;)e++;for(;this._compare(n[t],i)>0;)t--;if(e<t){var a=n[e];n[e]=n[t],n[t]=a,e++,t--}else if(e===t){e++;break}}return e}},{key:"_quickSort",value:function(e,t){if(this.elements.length>1){var n=this._partitionRenderObject(e,t),i=n-1;e<i&&this._quickSort(e,i),n<t&&this._quickSort(n,t)}}},{key:"_render",value:function(e){for(var t=this.elements.elements,n=0,i=this.elements.length;n<i;n++)t[n]._render(e)}},{key:"clear",value:function(){this.elements.length=0,this.lastTransparentRenderElement=null,this.lastTransparentBatched=!1}}]),RenderQueue}(),en=function(){function BoundsOctreeNode(e,t,n,i){_classCallCheck(this,BoundsOctreeNode),this._bounds=new wt(new o,new o),this._objects=[],this._isContaion=!1,this.center=new o,this.baseLength=0,this._setValues(e,t,n,i)}return _createClass(BoundsOctreeNode,[{key:"_setValues",value:function(e,t,n,i){this._octree=e,this._parent=t,this.baseLength=n,i.cloneTo(this.center);var a=this._bounds.min,r=this._bounds.max,o=e._looseness*n/2;a.setValue(i.x-o,i.y-o,i.z-o),r.setValue(i.x+o,i.y+o,i.z+o)}},{key:"_getChildBound",value:function(e){if(null!=this._children&&this._children[e])return this._children[e]._bounds;var t=this.baseLength/4,n=this.baseLength/2*this._octree._looseness/2,i=BoundsOctreeNode._tempBoundBox,a=i.min,r=i.max;switch(e){case 0:a.x=this.center.x-t-n,a.y=this.center.y+t-n,a.z=this.center.z-t-n,r.x=this.center.x-t+n,r.y=this.center.y+t+n,r.z=this.center.z-t+n;break;case 1:a.x=this.center.x+t-n,a.y=this.center.y+t-n,a.z=this.center.z-t-n,r.x=this.center.x+t+n,r.y=this.center.y+t+n,r.z=this.center.z-t+n;break;case 2:a.x=this.center.x-t-n,a.y=this.center.y+t-n,a.z=this.center.z+t-n,r.x=this.center.x-t+n,r.y=this.center.y+t+n,r.z=this.center.z+t+n;break;case 3:a.x=this.center.x+t-n,a.y=this.center.y+t-n,a.z=this.center.z+t-n,r.x=this.center.x+t+n,r.y=this.center.y+t+n,r.z=this.center.z+t+n;break;case 4:a.x=this.center.x-t-n,a.y=this.center.y-t-n,a.z=this.center.z-t-n,r.x=this.center.x-t+n,r.y=this.center.y-t+n,r.z=this.center.z-t+n;break;case 5:a.x=this.center.x+t-n,a.y=this.center.y-t-n,a.z=this.center.z-t-n,r.x=this.center.x+t+n,r.y=this.center.y-t+n,r.z=this.center.z-t+n;break;case 6:a.x=this.center.x-t-n,a.y=this.center.y-t-n,a.z=this.center.z+t-n,r.x=this.center.x-t+n,r.y=this.center.y-t+n,r.z=this.center.z+t+n;break;case 7:a.x=this.center.x+t-n,a.y=this.center.y-t-n,a.z=this.center.z+t-n,r.x=this.center.x+t+n,r.y=this.center.y-t+n,r.z=this.center.z+t+n}return i}},{key:"_getChildCenter",value:function(e){if(null!=this._children)return this._children[e].center;var t=this.baseLength/4,n=BoundsOctreeNode._tempVector30;switch(e){case 0:n.x=this.center.x-t,n.y=this.center.y+t,n.z=this.center.z-t;break;case 1:n.x=this.center.x+t,n.y=this.center.y+t,n.z=this.center.z-t;break;case 2:n.x=this.center.x-t,n.y=this.center.y+t,n.z=this.center.z+t;break;case 3:n.x=this.center.x+t,n.y=this.center.y+t,n.z=this.center.z+t;break;case 4:n.x=this.center.x-t,n.y=this.center.y-t,n.z=this.center.z-t;break;case 5:n.x=this.center.x+t,n.y=this.center.y-t,n.z=this.center.z-t;break;case 6:n.x=this.center.x-t,n.y=this.center.y-t,n.z=this.center.z+t;break;case 7:n.x=this.center.x+t,n.y=this.center.y-t,n.z=this.center.z+t}return n}},{key:"_getChild",value:function(e){var t=this.baseLength/4;switch(this._children||(this._children=[]),e){case 0:return this._children[0]||(this._children[0]=new BoundsOctreeNode(this._octree,this,this.baseLength/2,new o(this.center.x+-t,this.center.y+t,this.center.z-t)));case 1:return this._children[1]||(this._children[1]=new BoundsOctreeNode(this._octree,this,this.baseLength/2,new o(this.center.x+t,this.center.y+t,this.center.z-t)));case 2:return this._children[2]||(this._children[2]=new BoundsOctreeNode(this._octree,this,this.baseLength/2,new o(this.center.x-t,this.center.y+t,this.center.z+t)));case 3:return this._children[3]||(this._children[3]=new BoundsOctreeNode(this._octree,this,this.baseLength/2,new o(this.center.x+t,this.center.y+t,this.center.z+t)));case 4:return this._children[4]||(this._children[4]=new BoundsOctreeNode(this._octree,this,this.baseLength/2,new o(this.center.x-t,this.center.y-t,this.center.z-t)));case 5:return this._children[5]||(this._children[5]=new BoundsOctreeNode(this._octree,this,this.baseLength/2,new o(this.center.x+t,this.center.y-t,this.center.z-t)));case 6:return this._children[6]||(this._children[6]=new BoundsOctreeNode(this._octree,this,this.baseLength/2,new o(this.center.x-t,this.center.y-t,this.center.z+t)));case 7:return this._children[7]||(this._children[7]=new BoundsOctreeNode(this._octree,this,this.baseLength/2,new o(this.center.x+t,this.center.y-t,this.center.z+t)));default:throw"BoundsOctreeNode: unknown index."}}},{key:"_shouldMerge",value:function(){for(var e=this._objects.length,t=0;t<8;t++){var n=this._children[t];if(n){if(null!=n._children)return!1;e+=n._objects.length}}return e<=BoundsOctreeNode._NUM_OBJECTS_ALLOWED}},{key:"_mergeChildren",value:function(){for(var e=0;e<8;e++){var t=this._children[e];if(t){t._parent=null;for(var n=t._objects,i=n.length-1;i>=0;i--){var a=n[i];this._objects.push(a),a._setOctreeNode(this)}}}this._children=null}},{key:"_merge",value:function(){if(null===this._children){var e=this._parent;e&&e._shouldMerge()&&(e._mergeChildren(),e._merge())}}},{key:"_checkAddNode",value:function(e){if(null==this._children){if(this._objects.length<BoundsOctreeNode._NUM_OBJECTS_ALLOWED||this.baseLength/2<this._octree._minSize)return this;for(var t=this._objects.length-1;t>=0;t--){var n=this._objects[t],i=this._bestFitChild(n.bounds.getCenter());BoundsOctreeNode._encapsulates(this._getChildBound(i),n.bounds._getBoundBox())&&(this._objects.splice(this._objects.indexOf(n),1),this._getChild(i)._add(n))}}var a=this._bestFitChild(e.bounds.getCenter());return BoundsOctreeNode._encapsulates(this._getChildBound(a),e.bounds._getBoundBox())?this._getChild(a)._checkAddNode(e):this}},{key:"_add",value:function(e){var t=this._checkAddNode(e);t._objects.push(e),e._setOctreeNode(t)}},{key:"_remove",value:function(e){var t=this._objects.indexOf(e);this._objects.splice(t,1),e._setOctreeNode(null),this._merge()}},{key:"_addUp",value:function(e){return xe.boxContainsBox(this._bounds,e.bounds._getBoundBox())===Me.Contains?(this._add(e),!0):!!this._parent&&this._parent._addUp(e)}},{key:"_getCollidingWithFrustum",value:function(e,n,i,a,r,s){var l=e.boundFrustum,u=e.position,c=e.cullingMask;if(i){var h=l.containsBoundBox(this._bounds);if(t.Stat.octreeNodeCulling++,h===Me.Disjoint){for(var _=0,d=this._objects.length;_<d;_++)this._objects[_]._OctreeNoRender();return}i=h===Me.Intersects}this._isContaion=!i;var f=n.scene,m=t.Stat.loopCount;for(_=0,d=this._objects.length;_<d;_++){var p=this._objects[_];if(s?p._castShadow&&p._enable:0!=(Math.pow(2,p._owner._layer)&c)&&p._enable){if(i&&(t.Stat.frustumCulling++,!p._needRender(l,n)))continue;p._renderMark=m,p._distanceForSort=o.distance(p.bounds.getCenter(),u);for(var T=p._renderElements,v=0,g=T.length;v<g;v++){T[v]._update(f,n,a,r)}}}if(null!=this._children)for(_=0;_<8;_++){var E=this._children[_];E&&E._getCollidingWithFrustum(e,n,i,a,r,s)}}},{key:"_getCollidingWithBoundBox",value:function(e,t,n){if(t){var i=xe.boxContainsBox(this._bounds,e);if(i===Me.Disjoint)return;t=i===Me.Intersects}if(t)for(var a=0,r=this._objects.length;a<r;a++){var o=this._objects[a];xe.intersectsBoxAndBox(o.bounds._getBoundBox(),e)&&n.push(o)}if(null!=this._children)for(a=0;a<8;a++){this._children[a]._getCollidingWithBoundBox(e,t,n)}}},{key:"_bestFitChild",value:function(e){return(e.x<=this.center.x?0:1)+(e.y>=this.center.y?0:4)+(e.z<=this.center.z?0:2)}},{key:"_update",value:function(e){if(xe.boxContainsBox(this._bounds,e.bounds._getBoundBox())===Me.Contains){var t=this._checkAddNode(e);if(t!==e._getOctreeNode()){t._objects.push(e),e._setOctreeNode(t);var n=this._objects.indexOf(e);this._objects.splice(n,1),this._merge()}return!0}if(this._parent){var i=this._parent._addUp(e);return i&&(n=this._objects.indexOf(e),this._objects.splice(n,1),this._merge()),i}return!1}},{key:"add",value:function(e){return!!BoundsOctreeNode._encapsulates(this._bounds,e.bounds._getBoundBox())&&(this._add(e),!0)}},{key:"remove",value:function(e){return e._getOctreeNode()===this&&(this._remove(e),!0)}},{key:"update",value:function(e){return e._getOctreeNode()===this&&this._update(e)}},{key:"shrinkIfPossible",value:function(e){if(this.baseLength<2*e)return this;for(var t=-1,n=0,i=this._objects.length;n<i;n++){var a=this._objects[n],r=this._bestFitChild(a.bounds.getCenter());if(0!=n&&r!=t)return this;var o=this._getChildBound(r);if(!BoundsOctreeNode._encapsulates(o,a.bounds._getBoundBox()))return this;0==n&&(t=r)}if(null==this._children){if(-1!=t){var s=this._getChildCenter(t);this._setValues(this._octree,null,this.baseLength/2,s)}return this}var l=!1;for(n=0,i=this._children.length;n<i;n++){var u=this._children[n];if(u&&u.hasAnyObjects()){if(l)return this;if(t>=0&&t!=n)return this;l=!0,t=n}}if(-1!=t){var c=this._children[t];return c._parent=null,c}return this}},{key:"hasAnyObjects",value:function(){if(this._objects.length>0)return!0;if(null!=this._children)for(var e=0;e<8;e++){var t=this._children[e];if(t&&t.hasAnyObjects())return!0}return!1}},{key:"getCollidingWithBoundBox",value:function(e,t){this._getCollidingWithBoundBox(e,!0,t)}},{key:"getCollidingWithRay",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Number.MAX_VALUE,i=xe.intersectsRayAndBoxRD(e,this._bounds);if(!(-1==i||i>n)){for(var a=0,r=this._objects.length;a<r;a++){var o=this._objects[a];-1!==(i=xe.intersectsRayAndBoxRD(e,o.bounds._getBoundBox()))&&i<=n&&t.push(o)}if(null!=this._children)for(a=0;a<8;a++){this._children[a].getCollidingWithRay(e,t,n)}}}},{key:"getCollidingWithFrustum",value:function(e,t,n,i,a){this._getCollidingWithFrustum(e,t,!0,n,i,a)}},{key:"isCollidingWithBoundBox",value:function(e){if(!xe.intersectsBoxAndBox(this._bounds,e))return!1;for(var t=0,n=this._objects.length;t<n;t++){var i=this._objects[t];if(xe.intersectsBoxAndBox(i.bounds._getBoundBox(),e))return!0}if(null!=this._children)for(t=0;t<8;t++){if(this._children[t].isCollidingWithBoundBox(e))return!0}return!1}},{key:"isCollidingWithRay",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Number.MAX_VALUE,n=xe.intersectsRayAndBoxRD(e,this._bounds);if(-1==n||n>t)return!1;for(var i=0,a=this._objects.length;i<a;i++){var r=this._objects[i];if(-1!==(n=xe.intersectsRayAndBoxRD(e,r.bounds._getBoundBox()))&&n<=t)return!0}if(null!=this._children)for(i=0;i<8;i++){if(this._children[i].isCollidingWithRay(e,t))return!0}return!1}},{key:"getBound",value:function(){return this._bounds}},{key:"drawAllBounds",value:function(e,t,n){if(null!==this._children||0!=this._objects.length){t++;var i=BoundsOctreeNode._tempColor0;if(this._isContaion)i.r=0,i.g=0,i.b=1;else{var a=n?t/n:0;i.r=1-a,i.g=a,i.b=0}if(i.a=.3,P._drawBound(e,this._bounds,i),null!=this._children)for(var r=0;r<8;r++){var o=this._children[r];o&&o.drawAllBounds(e,t,n)}}}},{key:"drawAllObjects",value:function(e,t,n){t++;var i=BoundsOctreeNode._tempColor0;if(this._isContaion)i.r=0,i.g=0,i.b=1;else{var a=n?t/n:0;i.r=1-a,i.g=a,i.b=0}i.a=1;for(var r=0,o=this._objects.length;r<o;r++)P._drawBound(e,this._objects[r].bounds._getBoundBox(),i);if(null!=this._children)for(r=0;r<8;r++){var s=this._children[r];s&&s.drawAllObjects(e,t,n)}}}],[{key:"_encapsulates",value:function(e,t){return xe.boxContainsBox(e,t)==Me.Contains}}]),BoundsOctreeNode}();en._tempVector30=new o,en._tempColor0=new Et,en._tempBoundBox=new wt(new o,new o),en._NUM_OBJECTS_ALLOWED=8;var tn=function(e){function OctreeMotionList(){return _classCallCheck(this,OctreeMotionList),_possibleConstructorReturn(this,_getPrototypeOf(OctreeMotionList).call(this))}return _inherits(OctreeMotionList,R),_createClass(OctreeMotionList,[{key:"add",value:function(e){if(-1!==e._getIndexInMotionList())throw"OctreeMotionList:element has  in  PhysicsUpdateList.";this._add(e),e._setIndexInMotionList(this.length++)}},{key:"remove",value:function(e){var t=e._getIndexInMotionList();if(this.length--,t!==this.length){var n=this.elements[this.length];this.elements[t]=n,n._setIndexInMotionList(t)}e._setIndexInMotionList(-1)}}]),OctreeMotionList}(),nn=function(){function BoundsOctree(e,t,n,i){_classCallCheck(this,BoundsOctree),this._motionObjects=new tn,this.count=0,n>e&&(console.warn("Minimum node size must be at least as big as the initial world size. Was: "+n+" Adjusted to: "+e),n=e),this._initialSize=e,this._minSize=n,this._looseness=Math.min(Math.max(i,1),2),this._rootNode=new en(this,null,e,t)}return _createClass(BoundsOctree,[{key:"_getMaxDepth",value:function(e,t){t++;var n=e._children;if(null!=n)for(var i=t,a=0,r=n.length;a<r;a++){var o=n[a];o&&(t=Math.max(this._getMaxDepth(o,i),t))}return t}},{key:"_grow",value:function(e){var t=e.x>=0?1:-1,n=e.y>=0?1:-1,i=e.z>=0?1:-1,a=this._rootNode,r=this._rootNode.baseLength/2,s=2*this._rootNode.baseLength,l=this._rootNode.center,u=new o(l.x+t*r,l.y+n*r,l.z+i*r);if(this._rootNode=new en(this,null,s,u),a.hasAnyObjects()){for(var c=this._rootNode._bestFitChild(a.center),h=[],_=0;_<8;_++)_==c&&(a._parent=this._rootNode,h[_]=a);this._rootNode._children=h}}},{key:"add",value:function(e){for(var t=0;!this._rootNode.add(e);){var n=BoundsOctree._tempVector30;if(o.subtract(e.bounds.getCenter(),this._rootNode.center,n),this._grow(n),++t>20)throw"Aborted Add operation as it seemed to be going on forever ("+(t-1)+") attempts at growing the octree."}this.count++}},{key:"remove",value:function(e){var t=e._getOctreeNode().remove(e);return t&&this.count--,t}},{key:"update",value:function(e){var t=0,n=e._getOctreeNode();if(n){for(;!n._update(e);){var i=BoundsOctree._tempVector30;if(o.subtract(e.bounds.getCenter(),this._rootNode.center,i),this._grow(i),++t>20)throw"Aborted Add operation as it seemed to be going on forever ("+(t-1)+") attempts at growing the octree."}return!0}return!1}},{key:"shrinkRootIfPossible",value:function(){this._rootNode=this._rootNode.shrinkIfPossible(this._initialSize)}},{key:"addMotionObject",value:function(e){this._motionObjects.add(e)}},{key:"removeMotionObject",value:function(e){this._motionObjects.remove(e)}},{key:"updateMotionObjects",value:function(){for(var e=this._motionObjects.elements,t=0,n=this._motionObjects.length;t<n;t++){var i=e[t];this.update(i),i._setIndexInMotionList(-1)}this._motionObjects.length=0}},{key:"isCollidingWithBoundBox",value:function(e){return this._rootNode.isCollidingWithBoundBox(e)}},{key:"isCollidingWithRay",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Number.MAX_VALUE;return this._rootNode.isCollidingWithRay(e,t)}},{key:"getCollidingWithBoundBox",value:function(e,t){this._rootNode.getCollidingWithBoundBox(e,t)}},{key:"getCollidingWithRay",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Number.MAX_VALUE;this._rootNode.getCollidingWithRay(e,t,n)}},{key:"getCollidingWithFrustum",value:function(e,t,n,i,a){this._rootNode.getCollidingWithFrustum(e,t,n,i,a)}},{key:"getMaxBounds",value:function(){return this._rootNode.getBound()}},{key:"drawAllBounds",value:function(e){var t=this._getMaxDepth(this._rootNode,-1);this._rootNode.drawAllBounds(e,-1,t)}},{key:"drawAllObjects",value:function(e){var t=this._getMaxDepth(this._rootNode,-1);this._rootNode.drawAllObjects(e,-1,t)}}]),BoundsOctree}();nn._tempVector30=new o;var an=function Lightmap(){_classCallCheck(this,Lightmap)},rn=function(){function BoundSphere(e,t){_classCallCheck(this,BoundSphere),this.center=e,this.radius=t}return _createClass(BoundSphere,[{key:"toDefault",value:function(){this.center.toDefault(),this.radius=0}},{key:"intersectsRayDistance",value:function(e){return xe.intersectsRayAndSphereRD(e,this)}},{key:"intersectsRayPoint",value:function(e,t){return xe.intersectsRayAndSphereRP(e,this,t)}},{key:"cloneTo",value:function(e){var t=e;this.center.cloneTo(t.center),t.radius=this.radius}},{key:"clone",value:function(){var e=new BoundSphere(new o,0);return this.cloneTo(e),e}}],[{key:"createFromSubPoints",value:function(e,t,n,i){if(null==e)throw new Error("points");if(t<0||t>=e.length)throw new Error("start"+t+"Must be in the range [0, "+(e.length-1)+"]");if(n<0||t+n>e.length)throw new Error("count"+n+"Must be in the range <= "+e.length+"}");var a=t+n,r=BoundSphere._tempVector3;r.x=0,r.y=0,r.z=0;for(var s=t;s<a;++s)o.add(e[s],r,r);var l=i.center;o.scale(r,1/n,l);var u=0;for(s=t;s<a;++s){var c=o.distanceSquared(l,e[s]);c>u&&(u=c)}i.radius=Math.sqrt(u)}},{key:"createfromPoints",value:function(e,t){if(null==e)throw new Error("points");BoundSphere.createFromSubPoints(e,0,e.length,t)}}]),BoundSphere}();rn._tempVector3=new o;var on,sn=function ShadowSliceData(){_classCallCheck(this,ShadowSliceData),this.cameraShaderValue=new ie,this.position=new o,this.viewMatrix=new c,this.projectionMatrix=new c,this.viewProjectMatrix=new c,this.cullPlanes=[new Re(new o),new Re(new o),new Re(new o),new Re(new o),new Re(new o),new Re(new o),new Re(new o),new Re(new o),new Re(new o),new Re(new o)],this.splitBoundSphere=new rn(new o,0)},ln=function ShadowSpotData(){_classCallCheck(this,ShadowSpotData),this.cameraShaderValue=new ie,this.position=new o,this.viewMatrix=new c,this.projectionMatrix=new c,this.viewProjectMatrix=new c,this.cameraCullInfo=new yt};(on=e.ShadowLightType||(e.ShadowLightType={}))[on.DirectionLight=0]="DirectionLight",on[on.SpotLight=1]="SpotLight",on[on.PointLight=2]="PointLight";var un=function(){function ShadowCasterPass(){_classCallCheck(this,ShadowCasterPass),this._shadowBias=new a,this._shadowParams=new a,this._shadowMapSize=new a,this._shadowSpotMapSize=new a,this._shadowMatrices=new Float32Array(16*ShadowCasterPass._maxCascades),this._shadowSpotMatrices=new c,this._splitBoundSpheres=new Float32Array(4*ShadowCasterPass._maxCascades),this._cascadeCount=0,this._shadowMapWidth=0,this._shadowMapHeight=0,this._shadowSliceDatas=[new sn,new sn,new sn,new sn],this._shadowSpotData=new ln,this._lightUp=new o,this._lightSide=new o,this._lightForward=new o,this._shadowSpotData.cameraCullInfo.boundFrustum=new Ae(new c)}return _createClass(ShadowCasterPass,[{key:"_setupShadowCasterShaderValues",value:function(t,n,i,a,r,o,s){switch(n.setVector(ShadowCasterPass.SHADOW_BIAS,o),s){case e.LightType.Directional:n.setVector3(ShadowCasterPass.SHADOW_LIGHT_DIRECTION,a);break;case e.LightType.Spot:n.setVector(ShadowCasterPass.SHADOW_PARAMS,r);break;case e.LightType.Point:}var l=i.cameraShaderValue;l.setMatrix4x4(Ve.VIEWMATRIX,i.viewMatrix),l.setMatrix4x4(Ve.PROJECTMATRIX,i.projectionMatrix),l.setMatrix4x4(Ve.VIEWPROJECTMATRIX,i.viewProjectMatrix),t.viewMatrix=i.viewMatrix,t.projectionMatrix=i.projectionMatrix,t.projectionViewMatrix=i.viewProjectMatrix}},{key:"_setupShadowReceiverShaderValues",value:function(t){var n=this._light;switch(n.shadowCascadesMode!==e.ShadowCascadesMode.NoCascades?t.addDefine(Ue.SHADERDEFINE_SHADOW_CASCADE):t.removeDefine(Ue.SHADERDEFINE_SHADOW_CASCADE),n.shadowMode){case e.ShadowMode.Hard:t.removeDefine(Ue.SHADERDEFINE_SHADOW_SOFT_SHADOW_LOW),t.removeDefine(Ue.SHADERDEFINE_SHADOW_SOFT_SHADOW_HIGH);break;case e.ShadowMode.SoftLow:t.addDefine(Ue.SHADERDEFINE_SHADOW_SOFT_SHADOW_LOW),t.removeDefine(Ue.SHADERDEFINE_SHADOW_SOFT_SHADOW_HIGH);break;case e.ShadowMode.SoftHigh:t.addDefine(Ue.SHADERDEFINE_SHADOW_SOFT_SHADOW_HIGH),t.removeDefine(Ue.SHADERDEFINE_SHADOW_SOFT_SHADOW_LOW)}t.setTexture(ShadowCasterPass.SHADOW_MAP,this._shadowDirectLightMap),t.setBuffer(ShadowCasterPass.SHADOW_MATRICES,this._shadowMatrices),t.setVector(ShadowCasterPass.SHADOW_MAP_SIZE,this._shadowMapSize),t.setVector(ShadowCasterPass.SHADOW_PARAMS,this._shadowParams),t.setBuffer(ShadowCasterPass.SHADOW_SPLIT_SPHERES,this._splitBoundSpheres)}},{key:"_setupSpotShadowReceiverShaderValues",value:function(t){switch(this._light.shadowMode){case e.ShadowMode.Hard:t.removeDefine(Ue.SHADERDEFINE_SHADOW_SPOT_SOFT_SHADOW_HIGH),t.removeDefine(Ue.SHADERDEFINE_SHADOW_SPOT_SOFT_SHADOW_LOW);break;case e.ShadowMode.SoftLow:t.addDefine(Ue.SHADERDEFINE_SHADOW_SPOT_SOFT_SHADOW_LOW),t.removeDefine(Ue.SHADERDEFINE_SHADOW_SPOT_SOFT_SHADOW_HIGH);break;case e.ShadowMode.SoftHigh:t.addDefine(Ue.SHADERDEFINE_SHADOW_SPOT_SOFT_SHADOW_HIGH),t.removeDefine(Ue.SHADERDEFINE_SHADOW_SPOT_SOFT_SHADOW_LOW)}t.setTexture(ShadowCasterPass.SHADOW_SPOTMAP,this._shadowSpotLightMap),t.setMatrix4x4(ShadowCasterPass.SHADOW_SPOTMATRICES,this._shadowSpotMatrices),t.setVector(ShadowCasterPass.SHADOW_SPOTMAP_SIZE,this._shadowSpotMapSize),t.setVector(ShadowCasterPass.SHADOW_PARAMS,this._shadowParams)}},{key:"update",value:function(t,i,a){switch(a){case e.ShadowLightType.DirectionLight:this._light=i;var r=(D=ShadowCasterPass._tempMatrix0).elements,s=this._lightUp,l=this._lightSide,u=this._lightForward;c.createFromQuaternion(i._transform.rotation,D),l.setValue(r[0],r[1],r[2]),s.setValue(r[4],r[5],r[6]),u.setValue(-r[8],-r[9],-r[10]);var h,_,d,f,m=i._shadowResolution,p=i._shadowCascadesMode;p==e.ShadowCascadesMode.NoCascades?(h=1,_=m,d=m,f=m):(h=p==e.ShadowCascadesMode.TwoCascades?2:4,d=2*(_=Xe.getMaxTileResolutionInAtlas(m,m,h)),f=p==e.ShadowCascadesMode.TwoCascades?_:2*_),this._cascadeCount=h,this._shadowMapWidth=d,this._shadowMapHeight=f;var T=ShadowCasterPass._cascadesSplitDistance,v=ShadowCasterPass._frustumPlanes,g=t.nearPlane,E=Math.min(t.farPlane,i._shadowDistance),y=this._shadowMatrices,S=this._splitBoundSpheres;Xe.getCascadesSplitDistance(i._shadowTwoCascadeSplits,i._shadowFourCascadeSplits,g,E,t.fieldOfView*n.Deg2Rad,t.aspectRatio,p,T),Xe.getCameraFrustumPlanes(t.projectionViewMatrix,v);var R=ShadowCasterPass._tempVector30;t._transform.getForward(R),o.normalize(R,R);for(var C=0;C<h;C++){var M=this._shadowSliceDatas[C];M.sphereCenterZ=Xe.getBoundSphereByFrustum(T[C],T[C+1],t.fieldOfView*n.Deg2Rad,t.aspectRatio,t._transform.position,R,M.splitBoundSphere),Xe.getDirectionLightShadowCullPlanes(v,C,T,g,u,M),Xe.getDirectionalLightMatrices(s,l,u,C,i._shadowNearPlane,_,M,y),h>1&&Xe.applySliceTransform(M,d,f,C,y)}Xe.prepareShadowReceiverShaderValues(i,d,f,this._shadowSliceDatas,h,this._shadowMapSize,this._shadowParams,y,S);break;case e.ShadowLightType.SpotLight:this._light=i;var D=ShadowCasterPass._tempMatrix0,x=(u=this._lightForward,this._light._shadowResolution);this._shadowMapWidth=x,this._shadowMapHeight=x;var A=this._shadowSpotData;Xe.getSpotLightShadowData(A,this._light,x,this._shadowParams,this._shadowSpotMatrices,this._shadowSpotMapSize);break;case e.ShadowLightType.PointLight:break;default:throw"There is no shadow of this type"}}},{key:"render",value:function(n,i,a){switch(a){case e.ShadowLightType.DirectionLight:var r=i._shaderValues;n.pipelineMode="ShadowCaster",ie.setRuntimeValueMode(!1),(p=this._shadowDirectLightMap=Xe.getTemporaryShadowTexture(this._shadowMapWidth,this._shadowMapHeight,t.RenderTextureDepthFormat.DEPTH_16))._start();for(var o=this._light,s=0,l=this._cascadeCount;s<l;s++){var u=this._shadowSliceDatas[s];Xe.getShadowBias(o,u.projectionMatrix,u.resolution,this._shadowBias),this._setupShadowCasterShaderValues(n,r,u,this._lightForward,this._shadowParams,this._shadowBias,e.LightType.Directional);var c=Rt._shadowCullInfo;c.position=u.position,c.cullPlanes=u.cullPlanes,c.cullPlaneCount=u.cullPlaneCount,c.cullSphere=u.splitBoundSphere,c.direction=this._lightForward;var h=Rt.cullingShadow(c,i,n);n.cameraShaderValue=u.cameraShaderValue,Qe._updateMark++;var _=t.LayaGL.instance,d=u.resolution,f=u.offsetX,m=u.offsetY;_.enable(_.SCISSOR_TEST),_.viewport(f,m,d,d),_.scissor(f,m,d,d),_.clear(_.DEPTH_BUFFER_BIT),h&&(_.scissor(f+1,m+1,d-2,d-2),i._opaqueQueue._render(n))}p._end(),this._setupShadowReceiverShaderValues(r),ie.setRuntimeValueMode(!0),n.pipelineMode=n.configPipeLineMode;break;case e.ShadowLightType.SpotLight:r=i._shaderValues;n.pipelineMode="ShadowCaster",ie.setRuntimeValueMode(!1);var p,T=this._light;(p=this._shadowSpotLightMap=Xe.getTemporaryShadowTexture(this._shadowMapWidth,this._shadowMapHeight,t.RenderTextureDepthFormat.DEPTH_16))._start();var v=this._shadowSpotData;Xe.getShadowBias(T,v.projectionMatrix,v.resolution,this._shadowBias),this._setupShadowCasterShaderValues(n,r,v,this._light.transform.position,this._shadowParams,this._shadowBias,e.LightType.Spot);h=Rt.cullingSpotShadow(v.cameraCullInfo,i,n);n.cameraShaderValue=v.cameraShaderValue,Qe._updateMark++,(_=t.LayaGL.instance).enable(_.SCISSOR_TEST),_.viewport(v.offsetX,v.offsetY,v.resolution,v.resolution),_.scissor(v.offsetX,v.offsetY,v.resolution,v.resolution),_.clear(_.DEPTH_BUFFER_BIT),h&&(_.scissor(v.offsetX,v.offsetY,v.resolution,v.resolution),i._opaqueQueue._render(n)),p._end(),this._setupSpotShadowReceiverShaderValues(r),ie.setRuntimeValueMode(!0),n.pipelineMode=n.configPipeLineMode;break;case e.ShadowLightType.PointLight:break;default:throw"There is no shadow of this type"}}},{key:"cleanUp",value:function(){this._shadowDirectLightMap&&$.recoverToPool(this._shadowDirectLightMap),this._shadowSpotLightMap&&$.recoverToPool(this._shadowSpotLightMap),this._shadowDirectLightMap=null,this._shadowSpotLightMap=null,this._light=null}}]),ShadowCasterPass}();un._tempVector30=new o,un._tempMatrix0=new c,un.SHADOW_BIAS=_e.propertyNameToID("u_ShadowBias"),un.SHADOW_LIGHT_DIRECTION=_e.propertyNameToID("u_ShadowLightDirection"),un.SHADOW_SPLIT_SPHERES=_e.propertyNameToID("u_ShadowSplitSpheres"),un.SHADOW_MATRICES=_e.propertyNameToID("u_ShadowMatrices"),un.SHADOW_MAP_SIZE=_e.propertyNameToID("u_ShadowMapSize"),un.SHADOW_MAP=_e.propertyNameToID("u_ShadowMap"),un.SHADOW_PARAMS=_e.propertyNameToID("u_ShadowParams"),un.SHADOW_SPOTMAP_SIZE=_e.propertyNameToID("u_SpotShadowMapSize"),un.SHADOW_SPOTMAP=_e.propertyNameToID("u_SpotShadowMap"),un.SHADOW_SPOTMATRICES=_e.propertyNameToID("u_SpotViewProjectMatrix"),un._maxCascades=4,un._cascadesSplitDistance=new Array(un._maxCascades+1),un._frustumPlanes=new Array(new Re(new o),new Re(new o),new Re(new o),new Re(new o),new Re(new o),new Re(new o));var cn=function(){function DynamicBatchManager(){_classCallCheck(this,DynamicBatchManager),this._batchRenderElementPool=[]}return _createClass(DynamicBatchManager,[{key:"_clear",value:function(){this._batchRenderElementPoolIndex=0}},{key:"_getBatchRenderElementFromPool",value:function(){throw"StaticBatch:must override this function."}},{key:"dispose",value:function(){}}],[{key:"_registerManager",value:function(e){DynamicBatchManager._managers.push(e)}}]),DynamicBatchManager}();cn._managers=[];var hn,_n=function(e){function ReflectionProbeList(){return _classCallCheck(this,ReflectionProbeList),_possibleConstructorReturn(this,_getPrototypeOf(ReflectionProbeList).call(this))}return _inherits(ReflectionProbeList,R),_createClass(ReflectionProbeList,[{key:"add",value:function(e){this._add(e),e._setIndexInReflectionList(this.length++)}},{key:"remove",value:function(e){var t=e._getIndexInReflectionList();if(this.length--,t!==this.length){var n=this.elements[this.length];this.elements[t]=n,n._setIndexInReflectionList(t)}e._setIndexInReflectionList(-1)}}]),ReflectionProbeList}(),dn=function(){function ReflectionProbeManager(){_classCallCheck(this,ReflectionProbeManager),this._reflectionProbes=new _n,this._motionObjects=new R,this._needUpdateAllRender=!1,this._sceneReflectionProbe=new Qt,this._sceneReflectionProbe.bounds=new Bt(new o(0,0,0),new o(0,0,0)),this._sceneReflectionProbe.boxProjection=!1,this._sceneReflectionProbe._isScene=!0}return _createClass(ReflectionProbeManager,[{key:"_updateMotionObjects",value:function(e){if(0!=this._reflectionProbes.length){for(var t,n,i=this._reflectionProbes.elements,a=0,r=e.bounds,o=0,s=this._reflectionProbes.length;o<s;o++){var l=i[o];if(t){if(t.importance>l.importance)continue;if((n=r.calculateBoundsintersection(l.bounds))<a&&t.importance==l.importance)continue}else if((n=r.calculateBoundsintersection(l.bounds))<a)continue;t=l,a=n}!t&&this._sceneReflectionProbe&&(t=this._sceneReflectionProbe),e._probReflection=t}else e._probReflection=this._sceneReflectionProbe}},{key:"add",value:function(e){this._reflectionProbes.add(e),this._needUpdateAllRender=!0}},{key:"remove",value:function(e){this._reflectionProbes.remove(e),this._needUpdateAllRender=!0}},{key:"addMotionObject",value:function(e){this._motionObjects.add(e)}},{key:"update",value:function(){for(var e=this._motionObjects.elements,t=0,n=this._motionObjects.length;t<n;t++)this._updateMotionObjects(e[t]);this.clearMotionObjects()}},{key:"updateAllRenderObjects",value:function(e){for(var t=e.elements,n=0,i=e.length;n<i;n++)this._updateMotionObjects(t[n]);this._needUpdateAllRender=!1}},{key:"clearMotionObjects",value:function(){this._motionObjects.length=0}},{key:"destroy",value:function(){}},{key:"sceneReflectionProbe",set:function(e){this._sceneReflectionProbe.reflectionTexture=e}},{key:"sceneReflectionCubeHDRParam",set:function(e){this._sceneReflectionProbe.reflectionHDRParams=e}}]),ReflectionProbeManager}();(hn=e.AmbientMode||(e.AmbientMode={}))[hn.SolidColor=0]="SolidColor",hn[hn.SphericalHarmonics=1]="SphericalHarmonics";var fn=function(n){function Scene3D(){var n;_classCallCheck(this,Scene3D),(n=_possibleConstructorReturn(this,_getPrototypeOf(Scene3D).call(this)))._lightCount=0,n._pointLights=new Nt,n._spotLights=new Nt,n._directionLights=new Nt,n._alternateLights=new bt,n._lightmaps=[],n._skyRenderer=new we,n._input=new xt,n._timer=t.ILaya.timer,n._time=0,n._shCoefficients=new Array(7),n._ambientMode=e.AmbientMode.SolidColor,n._ambientSphericalHarmonics=new Ct,n._ambientSphericalHarmonicsIntensity=1,n._reflectionDecodeFormat=t.TextureDecodeFormat.Normal,n._reflectionIntensity=1,n._collsionTestList=[],n._renders=new gt,n._opaqueQueue=new $t(!1),n._transparentQueue=new $t(!0),n._cameraPool=[],n._animatorPool=new gt,n._scriptPool=new Array,n._tempScriptPool=new Array,n._needClearScriptPool=!1,n._reflectionCubeHDRParams=new a,n._reflectionProbeManager=new dn,n.currentCreationLayer=Math.pow(2,0),n.enableLight=!0,n._key=new t.SubmitKey,n._pickIdToSprite=new Object,n._reflectionMode=0,!w._config.isUseCannonPhysicsEngine&&k._bullet?n._physicsSimulation=new I(Scene3D.physicsSettings):k._cannon&&(n._cannonPhysicsSimulation=new t.CannonPhysicsSimulation(Scene3D.cannonPhysicsSettings)),n._shaderValues=new ie(null),n.enableFog=!1,n.fogStart=300,n.fogRange=1e3,n.fogColor=new o(.7,.7,.7),n.ambientColor=new o(.212,.227,.259),n.reflectionIntensity=1,n.reflection=Ot.blackTexture;for(var i=0;i<7;i++)n._shCoefficients[i]=new a;if(n._reflectionProbeManager.sceneReflectionCubeHDRParam=n._reflectionCubeHDRParams,n._scene=_assertThisInitialized(n),n._input.__init__(t.Render.canvas,_assertThisInitialized(n)),Scene3D.octreeCulling&&(n._octree=new nn(Scene3D.octreeInitialSize,Scene3D.octreeInitialCenter,Scene3D.octreeMinNodeSize,Scene3D.octreeLooseness)),Rt.debugFrustumCulling){n._debugTool=new Jt;var r=new kt;r.renderQueue=st.RENDERQUEUE_TRANSPARENT,r.alphaTest=!1,r.depthWrite=!1,r.cull=ut.CULL_BACK,r.blend=ut.BLEND_ENABLE_ALL,r.blendSrc=ut.BLENDPARAM_SRC_ALPHA,r.blendDst=ut.BLENDPARAM_ONE_MINUS_SRC_ALPHA,r.depthTest=ut.DEPTHTEST_LESS,n._debugTool.pixelLineRenderer.sharedMaterial=r}return n}return _inherits(Scene3D,t.Sprite),_createClass(Scene3D,[{key:"_applySHCoefficients",value:function(e,t){for(var n=this._shCoefficients,i=0;i<3;i++){var a=n[i],r=n[i+3];a.setValue(e.getCoefficient(i,3)*t,e.getCoefficient(i,1)*t,e.getCoefficient(i,2)*t,(e.getCoefficient(i,0)-e.getCoefficient(i,6))*t),r.setValue(e.getCoefficient(i,4)*t,e.getCoefficient(i,5)*t,3*e.getCoefficient(i,6)*t,e.getCoefficient(i,7)*t)}n[6].setValue(e.getCoefficient(0,8)*t,e.getCoefficient(1,8)*t,e.getCoefficient(2,8)*t,1);var o=this._shaderValues;o.setVector(Scene3D.AMBIENTSHAR,n[0]),o.setVector(Scene3D.AMBIENTSHAG,n[1]),o.setVector(Scene3D.AMBIENTSHAB,n[2]),o.setVector(Scene3D.AMBIENTSHBR,n[3]),o.setVector(Scene3D.AMBIENTSHBG,n[4]),o.setVector(Scene3D.AMBIENTSHBB,n[5]),o.setVector(Scene3D.AMBIENTSHC,n[6])}},{key:"_update",value:function(){var e=this.timer._delta/1e3;this._time+=e,this._shaderValues.setNumber(Scene3D.TIME,this._time);var n=this._physicsSimulation;if(!k._enablePhysics||I.disableSimulation||w._config.isUseCannonPhysicsEngine||(n._updatePhysicsTransformFromRender(),S._addUpdateList=!1,n._simulate(e),n._updateCharacters(),S._addUpdateList=!0,n._updateCollisions(),n._eventScripts()),k._cannon&&w._config.isUseCannonPhysicsEngine){var i=this._cannonPhysicsSimulation;i._updatePhysicsTransformFromRender(),t.CannonPhysicsComponent._addUpdateList=!1,i._simulate(e),t.CannonPhysicsComponent._addUpdateList=!0,i._updateCollisions(),i._eventScripts()}this._input._update(),this._clearScript(),this._updateScript(),K._update(this),t.VideoTexture._update(),this._reflectionProbeManager._needUpdateAllRender?this._reflectionProbeManager.updateAllRenderObjects(this._renders):this._reflectionProbeManager.update(),this._lateUpdateScript()}},{key:"_binarySearchIndexInCameraPool",value:function(e){for(var t,n=0,i=this._cameraPool.length-1;n<=i;){t=Math.floor((n+i)/2);var a=this._cameraPool[t]._renderingOrder;if(a==e._renderingOrder)return t;a>e._renderingOrder?i=t-1:n=t+1}return n}},{key:"_allotPickColorByID",value:function(e,t){var n=Math.floor(e/65025);e-=255*n*255;var i=Math.floor(e/255),a=e-=255*i;t.x=n/255,t.y=i/255,t.z=a/255,t.w=1}},{key:"_searchIDByPickColor",value:function(e){return 255*e.x*255+255*e.y+e.z}},{key:"onEnable",value:function(){this._input._onCanvasEvent(t.Render.canvas)}},{key:"onDisable",value:function(){this._input._offCanvasEvent(t.Render.canvas)}},{key:"_setCreateURL",value:function(e){this._url=t.URL.formatURL(e)}},{key:"_getGroup",value:function(){return this._group}},{key:"_setGroup",value:function(e){this._group=e}},{key:"_clearScript",value:function(){if(this._needClearScriptPool){for(var e=this._scriptPool,t=0,n=e.length;t<n;t++){var i=e[t];i&&(i._indexInPool=this._tempScriptPool.length,this._tempScriptPool.push(i))}this._scriptPool=this._tempScriptPool,e.length=0,this._tempScriptPool=e,this._needClearScriptPool=!1}}},{key:"_updateScript",value:function(){for(var e=this._scriptPool,t=0,n=e.length;t<n;t++){var i=e[t];i&&i.enabled&&i.onUpdate()}}},{key:"_lateUpdateScript",value:function(){for(var e=this._scriptPool,t=0,n=e.length;t<n;t++){var i=e[t];i&&i.enabled&&i.onLateUpdate()}}},{key:"_onActive",value:function(){_get(_getPrototypeOf(Scene3D.prototype),"_onActive",this).call(this),t.ILaya.stage._scene3Ds.push(this)}},{key:"_onInActive",value:function(){_get(_getPrototypeOf(Scene3D.prototype),"_onInActive",this).call(this);var e=t.ILaya.stage._scene3Ds;e.splice(e.indexOf(this),1)}},{key:"_prepareSceneToRender",value:function(){var e=this._shaderValues;if(w._config._multiLighting){var t=Scene3D._lightTexture,n=Scene3D._lightPixles,i=t.width,a=4*i,r=0,s=this._directionLights._length,l=this._directionLights._elements;if(s>0){var u=this._directionLights.getBrightestLight();this._mainDirectionLight=l[u],this._directionLights.normalLightOrdering(u);for(var c=0;c<s;c++,r++){var h=(S=l[c])._direction,_=S._intensityColor,d=a*r;o.scale(S.color,S._intensity,_),S.transform.worldMatrix.getForward(h),o.normalize(h,h),n[d]=_.x,n[d+1]=_.y,n[d+2]=_.z,n[d+4]=h.x,n[d+5]=h.y,n[d+6]=h.z,0==c&&(e.setVector3(Scene3D.SUNLIGHTDIRCOLOR,_),e.setVector3(Scene3D.SUNLIGHTDIRECTION,h))}e.addDefine(Ue.SHADERDEFINE_DIRECTIONLIGHT)}else e.removeDefine(Ue.SHADERDEFINE_DIRECTIONLIGHT);var f=this._pointLights._length;if(f>0){var m=this._pointLights._elements,p=this._pointLights.getBrightestLight();this._mainPointLight=m[p],this._pointLights.normalLightOrdering(p);for(c=0;c<f;c++,r++){var T=(R=m[c]).transform.position;_=R._intensityColor,d=a*r;o.scale(R.color,R._intensity,_),n[d]=_.x,n[d+1]=_.y,n[d+2]=_.z,n[d+3]=R.range,n[d+4]=T.x,n[d+5]=T.y,n[d+6]=T.z}e.addDefine(Ue.SHADERDEFINE_POINTLIGHT)}else e.removeDefine(Ue.SHADERDEFINE_POINTLIGHT);var v=this._spotLights._length;if(v>0){var g=this._spotLights._elements,E=this._spotLights.getBrightestLight();this._mainSpotLight=g[E],this._spotLights.normalLightOrdering(E);for(c=0;c<v;c++,r++){var y=g[c];h=y._direction,T=y.transform.position,_=y._intensityColor,d=a*r;o.scale(y.color,y._intensity,_),y.transform.worldMatrix.getForward(h),o.normalize(h,h),n[d]=_.x,n[d+1]=_.y,n[d+2]=_.z,n[d+3]=y.range,n[d+4]=T.x,n[d+5]=T.y,n[d+6]=T.z,n[d+7]=y.spotAngle*Math.PI/180,n[d+8]=h.x,n[d+9]=h.y,n[d+10]=h.z}e.addDefine(Ue.SHADERDEFINE_SPOTLIGHT)}else e.removeDefine(Ue.SHADERDEFINE_SPOTLIGHT);r>0&&t.setSubPixels(0,0,i,r,n,0),e.setTexture(Scene3D.LIGHTBUFFER,t),e.setInt(Scene3D.DIRECTIONLIGHTCOUNT,this._directionLights._length),e.setTexture(Scene3D.CLUSTERBUFFER,Se.instance._clusterTexture)}else{if(this._directionLights._length>0){var S=this._directionLights._elements[0];this._mainDirectionLight=S,o.scale(S.color,S._intensity,S._intensityColor),S.transform.worldMatrix.getForward(S._direction),o.normalize(S._direction,S._direction),e.setVector3(Scene3D.LIGHTDIRCOLOR,S._intensityColor),e.setVector3(Scene3D.LIGHTDIRECTION,S._direction),e.setVector3(Scene3D.SUNLIGHTDIRCOLOR,S._intensityColor),e.setVector3(Scene3D.SUNLIGHTDIRECTION,S._direction),e.addDefine(Ue.SHADERDEFINE_DIRECTIONLIGHT)}else e.removeDefine(Ue.SHADERDEFINE_DIRECTIONLIGHT);if(this._pointLights._length>0){var R=this._pointLights._elements[0];this._mainPointLight=R,o.scale(R.color,R._intensity,R._intensityColor),e.setVector3(Scene3D.POINTLIGHTCOLOR,R._intensityColor),e.setVector3(Scene3D.POINTLIGHTPOS,R.transform.position),e.setNumber(Scene3D.POINTLIGHTRANGE,R.range),e.addDefine(Ue.SHADERDEFINE_POINTLIGHT)}else e.removeDefine(Ue.SHADERDEFINE_POINTLIGHT);if(this._spotLights._length>0){var C=this._spotLights._elements[0];this._mainSpotLight=C,o.scale(C.color,C._intensity,C._intensityColor),e.setVector3(Scene3D.SPOTLIGHTCOLOR,C._intensityColor),e.setVector3(Scene3D.SPOTLIGHTPOS,C.transform.position),C.transform.worldMatrix.getForward(C._direction),o.normalize(C._direction,C._direction),e.setVector3(Scene3D.SPOTLIGHTDIRECTION,C._direction),e.setNumber(Scene3D.SPOTLIGHTRANGE,C.range),e.setNumber(Scene3D.SPOTLIGHTSPOTANGLE,C.spotAngle*Math.PI/180),e.addDefine(Ue.SHADERDEFINE_SPOTLIGHT)}else e.removeDefine(Ue.SHADERDEFINE_SPOTLIGHT)}}},{key:"_addScript",value:function(e){var t=this._scriptPool;e._indexInPool=t.length,t.push(e)}},{key:"_removeScript",value:function(e){this._scriptPool[e._indexInPool]=null,e._indexInPool=-1,this._needClearScriptPool=!0}},{key:"_preRenderScript",value:function(){for(var e=this._scriptPool,t=0,n=e.length;t<n;t++){var i=e[t];i&&i.enabled&&i.onPreRender()}}},{key:"_postRenderScript",value:function(){for(var e=this._scriptPool,t=0,n=e.length;t<n;t++){var i=e[t];i&&i.enabled&&i.onPostRender()}}},{key:"_addCamera",value:function(e){for(var t=this._binarySearchIndexInCameraPool(e),n=e._renderingOrder,i=this._cameraPool.length;t<i&&this._cameraPool[t]._renderingOrder<=n;)t++;this._cameraPool.splice(t,0,e)}},{key:"_removeCamera",value:function(e){this._cameraPool.splice(this._cameraPool.indexOf(e),1)}},{key:"_preCulling",value:function(e,t,n,i){var a=Rt._cameraCullInfo;a.position=t._transform.position,a.cullingMask=t.cullingMask,a.boundFrustum=t.boundFrustum,a.useOcclusionCulling=t.useOcclusionCulling,Rt.renderObjectCulling(a,this,e,n,i,!1)}},{key:"_clear",value:function(n,i){var a,r,o,s=i.viewport,l=i.camera,u=l._getRenderTexture(),c=s.width,h=s.height;l._needInternalRenderTexture()?(a=0,r=0):(a=s.x,r=l._getCanvasHeight()-s.y-h),n.viewport(a,r,c,h);var _=l.clearFlag;switch(_!==e.CameraClearFlags.Sky||l.skyRenderer._isAvailable()||this._skyRenderer._isAvailable()||(_=e.CameraClearFlags.SolidColor),_){case e.CameraClearFlags.SolidColor:var d=l.clearColor;if(n.enable(n.SCISSOR_TEST),n.scissor(a,r,c,h),d?n.clearColor(d.x,d.y,d.z,d.w):n.clearColor(0,0,0,0),u)switch(o=n.COLOR_BUFFER_BIT,u.depthStencilFormat){case t.RenderTextureDepthFormat.DEPTH_16:o|=n.DEPTH_BUFFER_BIT;break;case t.RenderTextureDepthFormat.STENCIL_8:o|=n.STENCIL_BUFFER_BIT;break;case t.RenderTextureDepthFormat.DEPTHSTENCIL_24_8:o|=n.DEPTH_BUFFER_BIT,o|=n.STENCIL_BUFFER_BIT}else o=n.COLOR_BUFFER_BIT|n.DEPTH_BUFFER_BIT;t.WebGLContext.setDepthMask(n,!0),n.clear(o),n.disable(n.SCISSOR_TEST);break;case e.CameraClearFlags.Sky:case e.CameraClearFlags.DepthOnly:if(n.enable(n.SCISSOR_TEST),n.scissor(a,r,c,h),u)switch(u.depthStencilFormat){case t.RenderTextureDepthFormat.DEPTH_16:o=n.DEPTH_BUFFER_BIT;break;case t.RenderTextureDepthFormat.STENCIL_8:o=n.STENCIL_BUFFER_BIT;break;case t.RenderTextureDepthFormat.DEPTHSTENCIL_24_8:o=n.DEPTH_BUFFER_BIT|n.STENCIL_BUFFER_BIT}else o=n.DEPTH_BUFFER_BIT;t.WebGLContext.setDepthMask(n,!0),n.clear(o),n.disable(n.SCISSOR_TEST);break;case e.CameraClearFlags.Nothing:break;default:throw new Error("Scene3D:camera clearFlag invalid.")}}},{key:"_renderScene",value:function(t,n){var i=t.camera;switch(n){case Scene3D.SCENERENDERFLAG_RENDERQPAQUE:this._opaqueQueue._render(t);break;case Scene3D.SCENERENDERFLAG_SKYBOX:i.clearFlag===e.CameraClearFlags.Sky&&(i.skyRenderer._isAvailable()?i.skyRenderer._render(t):this._skyRenderer._isAvailable()&&this._skyRenderer._render(t));break;case Scene3D.SCENERENDERFLAG_RENDERTRANSPARENT:if(this._transparentQueue._render(t),Rt.debugFrustumCulling)for(var a=this._debugTool._render._renderElements,r=0,o=a.length;r<o;r++)a[r]._update(this,t,null,null),a[r]._render(t)}}},{key:"_parse",value:function(e,n){var i=e.lightmaps;if(i){for(var a=i.length,r=new Array(a),o=0;o<a;o++){var s=new an,l=i[o];l.path?s.lightmapColor=t.Loader.getRes(l.path):(s.lightmapColor=t.Loader.getRes(l.color.path),l.direction&&(s.lightmapDirection=t.Loader.getRes(l.direction.path))),r[o]=s}this.lightmaps=r}var u=e.ambientColor;if(u){var c=this.ambientColor;c.fromArray(u),this.ambientColor=c}var h=e.sky;if(h)switch(this._skyRenderer.material=t.Loader.getRes(h.material.path),h.mesh){case"SkyBox":this._skyRenderer.mesh=ke.instance;break;case"SkyDome":this._skyRenderer.mesh=Pt.instance;break;default:this.skyRenderer.mesh=ke.instance}this.enableFog=e.enableFog,this.fogStart=e.fogStart,this.fogRange=e.fogRange;var _=e.fogColor;if(_){var d=this.fogColor;d.fromArray(_),this.fogColor=d}var f=e.ambientSphericalHarmonics;if(f){var m=this.ambientSphericalHarmonics;for(o=0;o<3;o++){var p=9*o;m.setCoefficients(o,f[p],f[p+1],f[p+2],f[p+3],f[p+4],f[p+5],f[p+6],f[p+7],f[p+8])}this.ambientSphericalHarmonics=m}var T=e.reflection;null!=T&&(this.reflection=t.Loader.getRes(T));var v=e.reflectionDecodingFormat;null!=v&&(this.reflectionDecodingFormat=v);var g=e.ambientMode;null!=g&&(this.ambientMode=g);var E=e.ambientSphericalHarmonicsIntensity;null!=E&&(this.ambientSphericalHarmonicsIntensity=E);var y=e.reflectionIntensity;null!=y&&(this.reflectionIntensity=y)}},{key:"_addRenderObject",value:function(e){this._octree&&e._supportOctree?this._octree.add(e):this._renders.add(e),e._addReflectionProbeUpdate()}},{key:"_removeRenderObject",value:function(e){this._octree&&e._supportOctree?this._octree.remove(e):this._renders.remove(e)}},{key:"_getRenderQueue",value:function(e){return e<=2500?this._opaqueQueue:this._transparentQueue}},{key:"_clearRenderQueue",value:function(){this._opaqueQueue.clear(),this._transparentQueue.clear();for(var e=Xt._managers,t=0,n=e.length;t<n;t++)e[t]._clear();var i=cn._managers;for(t=0,n=i.length;t<n;t++)i[t]._clear()}},{key:"destroy",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];if(!this.destroyed){_get(_getPrototypeOf(Scene3D.prototype),"destroy",this).call(this,e),this._skyRenderer.destroy(),this._skyRenderer=null,this._directionLights=null,this._pointLights=null,this._spotLights=null,this._alternateLights=null,this._shaderValues=null,this._renders=null,this._cameraPool=null,this._octree=null,this._physicsSimulation&&this._physicsSimulation._destroy(),this._reflection._removeReference(),this._reflection=null;var n=this._lightmaps;if(n)for(var i=0,a=n.length;i<a;i++){var r=n[i];r.lightmapColor&&r.lightmapColor._removeReference(),r.lightmapDirection&&r.lightmapDirection._removeReference()}this._lightmaps=null,this._reflectionProbeManager.destroy(),t.Loader.clearRes(this.url)}}},{key:"render",value:function(e){e._curSubmit=t.SubmitBase.RENDERBASE,this._children.length>0&&e.addRenderObject(this)}},{key:"renderSubmit",value:function(){var e,n,i;for(this._prepareSceneToRender(),e=0,i=(n=this._cameraPool.length)-1;e<n;e++){t.Render.supportWebGLPlusRendering&&ie.setRuntimeValueMode(e==i);var a=this._cameraPool[e];a.enableRender&&a.render()}return t.Context.set2DRenderConfig(),1}},{key:"getRenderType",value:function(){return 0}},{key:"releaseRender",value:function(){}},{key:"reUse",value:function(e,t){return 0}},{key:"setGlobalShaderValue",value:function(t,n,i){var a=_e.propertyNameToID(t);switch(n){case e.ShaderDataType.Int:this._shaderValues.setInt(a,i);break;case e.ShaderDataType.Number:this._shaderValues.setNumber(a,i);break;case e.ShaderDataType.Bool:this._shaderValues.setBool(a,i);break;case e.ShaderDataType.Matrix4x4:this._shaderValues.setMatrix4x4(a,i);break;case e.ShaderDataType.Quaternion:this._shaderValues.setQuaternion(a,i);break;case e.ShaderDataType.Texture:this._shaderValues.setTexture(a,i);break;case e.ShaderDataType.Vector4:this._shaderValues.setVector(a,i);break;case e.ShaderDataType.Vector2:this._shaderValues.setVector2(a,i);break;case e.ShaderDataType.Vector3:this._shaderValues.setVector3(a,i);break;case e.ShaderDataType.Buffer:this._shaderValues.setBuffer(a,i)}}},{key:"setlightmaps",value:function(e){for(var t=this._lightmaps,n=0,i=t.length;n<i;n++)t[n].lightmapColor._removeReference();if(!e)throw new Error("Scene3D: value value can't be null.");var a=e.length;for(t.length=a,n=0;n<a;n++){var r=e[n];r._addReference(),t[n]||(t[n]=new an),t[n].lightmapColor=r}}},{key:"getlightmaps",value:function(){for(var e=new Array(this._lightmaps.length),t=0;t<this._lightmaps.length;t++)e[t]=this._lightmaps[t].lightmapColor;return e}},{key:"url",get:function(){return this._url}},{key:"enableFog",get:function(){return this._enableFog},set:function(e){this._enableFog!==e&&(this._enableFog=e,e?this._shaderValues.addDefine(Ue.SHADERDEFINE_FOG):this._shaderValues.removeDefine(Ue.SHADERDEFINE_FOG))}},{key:"fogColor",get:function(){return this._shaderValues.getVector3(Scene3D.FOGCOLOR)},set:function(e){this._shaderValues.setVector3(Scene3D.FOGCOLOR,e)}},{key:"fogStart",get:function(){return this._shaderValues.getNumber(Scene3D.FOGSTART)},set:function(e){this._shaderValues.setNumber(Scene3D.FOGSTART,e)}},{key:"fogRange",get:function(){return this._shaderValues.getNumber(Scene3D.FOGRANGE)},set:function(e){this._shaderValues.setNumber(Scene3D.FOGRANGE,e)}},{key:"ambientMode",get:function(){return this._ambientMode},set:function(t){if(this._ambientMode!==t){switch(t){case e.AmbientMode.SolidColor:this._shaderValues.removeDefine(Ue.SHADERDEFINE_GI_AMBIENT_SH);break;case e.AmbientMode.SphericalHarmonics:this._shaderValues.addDefine(Ue.SHADERDEFINE_GI_AMBIENT_SH);break;default:throw"Scene3D: unknown ambientMode."}this._ambientMode=t}}},{key:"ambientColor",get:function(){return this._shaderValues.getVector3(Scene3D.AMBIENTCOLOR)},set:function(e){this._shaderValues.setVector3(Scene3D.AMBIENTCOLOR,e)}},{key:"ambientSphericalHarmonics",get:function(){return this._ambientSphericalHarmonics},set:function(e){var t=e||Ct._default;this._applySHCoefficients(t,Math.pow(this._ambientSphericalHarmonicsIntensity,2.2)),this._ambientSphericalHarmonics!=e&&e.cloneTo(this._ambientSphericalHarmonics)}},{key:"ambientSphericalHarmonicsIntensity",get:function(){return this._ambientSphericalHarmonicsIntensity},set:function(e){if(e=Math.max(Math.min(e,8),0),this._ambientSphericalHarmonicsIntensity!==e){var t=this._ambientSphericalHarmonics||Ct._default;this._applySHCoefficients(t,Math.pow(e,2.2)),this._ambientSphericalHarmonicsIntensity=e}}},{key:"reflection",get:function(){return this._reflection},set:function(e){e=e||Ot.blackTexture,this._reflection!=e&&(e._addReference(),this._reflectionProbeManager.sceneReflectionProbe=e,this._reflection=e,this._reflectionProbeManager._needUpdateAllRender=!0)}},{key:"reflectionDecodingFormat",get:function(){return this._reflectionDecodeFormat},set:function(e){this._reflectionDecodeFormat!=e&&(this._reflectionCubeHDRParams.x=this._reflectionIntensity,this._reflectionDecodeFormat==t.TextureDecodeFormat.RGBM&&(this._reflectionCubeHDRParams.x*=5),this._reflectionDecodeFormat=e,this._reflectionProbeManager.sceneReflectionCubeHDRParam=this._reflectionCubeHDRParams)}},{key:"reflectionIntensity",get:function(){return this._reflectionIntensity},set:function(e){e=Math.max(Math.min(e,1),0),this._reflectionCubeHDRParams.x=e,this._reflectionDecodeFormat==t.TextureDecodeFormat.RGBM&&(this._reflectionCubeHDRParams.x*=5),this._reflectionIntensity=e,this._reflectionProbeManager.sceneReflectionCubeHDRParam=this._reflectionCubeHDRParams}},{key:"skyRenderer",get:function(){return this._skyRenderer}},{key:"physicsSimulation",get:function(){return this._physicsSimulation}},{key:"cannonPhysicsSimulation",get:function(){return this._cannonPhysicsSimulation}},{key:"timer",get:function(){return this._timer},set:function(e){this._timer=e}},{key:"input",get:function(){return this._input}},{key:"lightmaps",get:function(){return this._lightmaps.slice()},set:function(e){var t=this._lightmaps;if(t)for(var n=0,i=t.length;n<i;n++){(r=t[n]).lightmapColor._removeReference(),r.lightmapDirection._removeReference()}if(e){var a=e.length;for(t.length=a,n=0;n<a;n++){var r;(r=e[n]).lightmapColor&&r.lightmapColor._addReference(),r.lightmapDirection&&r.lightmapDirection._addReference(),t[n]=r}}else t.length=0}},{key:"customReflection",get:function(){return this._reflection},set:function(e){this._reflection!=e&&(e._addReference(),this._reflectionProbeManager.sceneReflectionProbe=e,this._reflection=e)}},{key:"reflectionMode",get:function(){return this._reflectionMode},set:function(e){this._reflectionMode=e}}],[{key:"__init__",value:function(){var n=w._config;if(n._multiLighting){var i=n.maxLightCount,a=n.lightClusterCount;Se.instance=new Se(a.x,a.y,a.z,Math.min(n.maxLightCount,n._maxAreaLightCountPerClusterAverage)),Scene3D._lightTexture=P._createFloatTextureBuffer(4,i),Scene3D._lightTexture.lock=!0,Scene3D._lightPixles=new Float32Array(4*i*4)}Ue.SHADERDEFINE_FOG=_e.getDefineByName("FOG"),Ue.SHADERDEFINE_DIRECTIONLIGHT=_e.getDefineByName("DIRECTIONLIGHT"),Ue.SHADERDEFINE_POINTLIGHT=_e.getDefineByName("POINTLIGHT"),Ue.SHADERDEFINE_SPOTLIGHT=_e.getDefineByName("SPOTLIGHT"),Ue.SHADERDEFINE_SHADOW=_e.getDefineByName("SHADOW"),Ue.SHADERDEFINE_SHADOW_CASCADE=_e.getDefineByName("SHADOW_CASCADE"),Ue.SHADERDEFINE_SHADOW_SOFT_SHADOW_LOW=_e.getDefineByName("SHADOW_SOFT_SHADOW_LOW"),Ue.SHADERDEFINE_SHADOW_SOFT_SHADOW_HIGH=_e.getDefineByName("SHADOW_SOFT_SHADOW_HIGH"),Ue.SHADERDEFINE_GI_AMBIENT_SH=_e.getDefineByName("GI_AMBIENT_SH"),Ue.SHADERDEFINE_SHADOW_SPOT=_e.getDefineByName("SHADOW_SPOT"),Ue.SHADERDEFINE_SHADOW_SPOT_SOFT_SHADOW_LOW=_e.getDefineByName("SHADOW_SPOT_SOFT_SHADOW_LOW"),Ue.SHADERDEFINE_SHADOW_SPOT_SOFT_SHADOW_HIGH=_e.getDefineByName("SHADOW_SPOT_SOFT_SHADOW_HIGH");var r=w._config,o=Scene3D._configDefineValues;switch(r._multiLighting||o.add(_e.SHADERDEFINE_LEGACYSINGALLIGHTING),t.LayaGL.layaGPUInstance._isWebGL2?o.add(_e.SHADERDEFINE_GRAPHICS_API_GLES3):o.add(_e.SHADERDEFINE_GRAPHICS_API_GLES2),r.pbrRenderQuality){case e.PBRRenderQuality.High:o.add(ft.SHADERDEFINE_LAYA_PBR_BRDF_HIGH);break;case e.PBRRenderQuality.Low:o.add(ft.SHADERDEFINE_LAYA_PBR_BRDF_LOW);break;default:throw"Scene3D:unknown shader quality."}r.isUseCannonPhysicsEngine?Scene3D.cannonPhysicsSettings=new t.CannonPhysicsSettings:Scene3D.physicsSettings=new It}},{key:"load",value:function(e,n,i){t.ILaya.loader.create(e,n,i,Scene3D.HIERARCHY)}}]),Scene3D}();fn._shadowCasterPass=new un,fn.HIERARCHY="HIERARCHY",fn.octreeCulling=!1,fn.octreeInitialSize=64,fn.octreeInitialCenter=new o(0,0,0),fn.octreeMinNodeSize=2,fn.octreeLooseness=1.25,fn.REFLECTIONMODE_SKYBOX=0,fn.REFLECTIONMODE_CUSTOM=1,fn.SCENERENDERFLAG_RENDERQPAQUE=0,fn.SCENERENDERFLAG_SKYBOX=1,fn.SCENERENDERFLAG_RENDERTRANSPARENT=2,fn.FOGCOLOR=_e.propertyNameToID("u_FogColor"),fn.FOGSTART=_e.propertyNameToID("u_FogStart"),fn.FOGRANGE=_e.propertyNameToID("u_FogRange"),fn.DIRECTIONLIGHTCOUNT=_e.propertyNameToID("u_DirationLightCount"),fn.LIGHTBUFFER=_e.propertyNameToID("u_LightBuffer"),fn.CLUSTERBUFFER=_e.propertyNameToID("u_LightClusterBuffer"),fn.SUNLIGHTDIRECTION=_e.propertyNameToID("u_SunLight.direction"),fn.SUNLIGHTDIRCOLOR=_e.propertyNameToID("u_SunLight.color"),fn.AMBIENTSHAR=_e.propertyNameToID("u_AmbientSHAr"),fn.AMBIENTSHAG=_e.propertyNameToID("u_AmbientSHAg"),fn.AMBIENTSHAB=_e.propertyNameToID("u_AmbientSHAb"),fn.AMBIENTSHBR=_e.propertyNameToID("u_AmbientSHBr"),fn.AMBIENTSHBG=_e.propertyNameToID("u_AmbientSHBg"),fn.AMBIENTSHBB=_e.propertyNameToID("u_AmbientSHBb"),fn.AMBIENTSHC=_e.propertyNameToID("u_AmbientSHC"),fn.LIGHTDIRECTION=_e.propertyNameToID("u_DirectionLight.direction"),fn.LIGHTDIRCOLOR=_e.propertyNameToID("u_DirectionLight.color"),fn.POINTLIGHTPOS=_e.propertyNameToID("u_PointLight.position"),fn.POINTLIGHTRANGE=_e.propertyNameToID("u_PointLight.range"),fn.POINTLIGHTATTENUATION=_e.propertyNameToID("u_PointLight.attenuation"),fn.POINTLIGHTCOLOR=_e.propertyNameToID("u_PointLight.color"),fn.SPOTLIGHTPOS=_e.propertyNameToID("u_SpotLight.position"),fn.SPOTLIGHTDIRECTION=_e.propertyNameToID("u_SpotLight.direction"),fn.SPOTLIGHTSPOTANGLE=_e.propertyNameToID("u_SpotLight.spot"),fn.SPOTLIGHTRANGE=_e.propertyNameToID("u_SpotLight.range"),fn.SPOTLIGHTCOLOR=_e.propertyNameToID("u_SpotLight.color"),fn.AMBIENTCOLOR=_e.propertyNameToID("u_AmbientColor"),fn.TIME=_e.propertyNameToID("u_Time"),fn._configDefineValues=new ee;var mn=function(e){function ShaderPass(e,t,n,i){var a;for(var r in _classCallCheck(this,ShaderPass),(a=_possibleConstructorReturn(this,_getPrototypeOf(ShaderPass).call(this,t,n,null)))._cacheSharders={},a._cacheShaderHierarchy=1,a._renderState=new ut,a._validDefine=new ee,a._tags={},a._owner=e,a._stateMap=i,a.defs)a._validDefine.add(_e.getDefineByName(r));return a}return _inherits(ShaderPass,t.ShaderCompile),_createClass(ShaderPass,[{key:"_compileToTree",value:function(e,n,i,a,r){var o,s,l,u,c,h,_,d,f,m,p;for(f=i;f<n.length;f++)if(!((l=n[f]).length<1)&&0!==(h=l.indexOf("//"))){if(h>=0&&(l=l.substr(0,h)),o=d||new t.ShaderNode(a),d=null,o.text=l,o.noCompile=!0,(h=l.indexOf("#"))>=0){for(u="#",p=h+1,m=l.length;p<m;p++){var T=l.charAt(p);if(" "===T||"\t"===T||"?"===T)break;u+=T}switch(o.name=u,u){case"#ifdef":case"#ifndef":if(o.src=l,o.noCompile=null!=l.match(/[!&|()=<>]/),o.noCompile?console.log("function():Boolean{return "+l.substr(h+o.name.length)+"}"):(_=l.replace(/^\s*/,"").split(/\s+/),o.setCondition(_[1],"#ifdef"===u?t.ShaderCompile.IFDEF_YES:t.ShaderCompile.IFDEF_ELSE),o.text="//"+o.text),o.setParent(e),e=o,r)for(_=l.substr(p).split(t.ShaderCompile._splitToWordExps3),p=0;p<_.length;p++)(l=_[p]).length&&(r[l]=!0);continue;case"#if":case"#elif":if(o.src=l,o.noCompile=!0,"#elif"==u&&((s=(e=e.parent).childs[e.childs.length-1]).text=s.src,s.noCompile=!0,s.condition=null),o.setParent(e),e=o,r)for(_=l.substr(p).split(t.ShaderCompile._splitToWordExps3),p=0;p<_.length;p++)(l=_[p]).length&&"defined"!=l&&(r[l]=!0);continue;case"#else":o.src=l,s=(e=e.parent).childs[e.childs.length-1],o.noCompile=s.noCompile,o.noCompile||(o.condition=s.condition,o.conditionType=s.conditionType==t.ShaderCompile.IFDEF_YES?t.ShaderCompile.IFDEF_ELSE:t.ShaderCompile.IFDEF_YES,o.text="//"+o.text+" "+s.text+" "+o.conditionType),o.setParent(e),e=o;continue;case"#endif":s=(e=e.parent).childs[e.childs.length-1],o.noCompile=s.noCompile,o.noCompile||(o.text="//"+o.text),o.setParent(e);continue;case"#include":_=t.ShaderCompile.splitToWords(l,null);var v=t.ShaderCompile.includes[_[1]];if(!v)throw"ShaderCompile error no this include file:"+_[1];if((h=_[0].indexOf("?"))<0){o.setParent(e),l=v.getWith("with"==_[2]?_[3]:null),this._compileToTree(o,l.split("\n"),0,a,r),o.text="";continue}o.setCondition(_[0].substr(h+1),t.ShaderCompile.IFDEF_YES),o.text=v.getWith("with"==_[2]?_[3]:null);break;case"#import":c=(_=t.ShaderCompile.splitToWords(l,null))[1],a.push({node:o,file:t.ShaderCompile.includes[c],ofs:o.text.length});continue}}else{if((s=e.childs[e.childs.length-1])&&!s.name){a.length>0&&t.ShaderCompile.splitToWords(l,s),d=o,s.text+="\n"+l;continue}a.length>0&&t.ShaderCompile.splitToWords(l,o)}o.setParent(e)}}},{key:"_resizeCacheShaderMap",value:function(e,t,n){var i=this._cacheShaderHierarchy-1;if(t==i){for(var a in e)for(var r=e[a],o=0,s=n-i;o<s;o++)o==s-1?e[0]=r:e=e[0==o?a:0]={};this._cacheShaderHierarchy=n}else for(var a in e)this._resizeCacheShaderMap(e[a],++t,n)}},{key:"_addDebugShaderVariantCollection",value:function(e,t,n){var i=_e._debugShaderVariantInfo,a=this._owner,r=a._owner,o=e._mask;_e._getNamesByDefineData(e,t),n.length=o.length;for(var s=0,l=o.length;s<l;s++)n[s]=o[s];i?i.setValue(r,r._subShaders.indexOf(a),a._passes.indexOf(this),t):_e._debugShaderVariantInfo=i=new ce(r,r._subShaders.indexOf(a),a._passes.indexOf(this),t),_e.debugShaderVariantCollection.add(i)}},{key:"withCompile",value:function(e){var n,i=ShaderPass._debugDefineString,a=ShaderPass._debugDefineMask;e._intersectionDefineDatas(this._validDefine),_e.debugMode&&(n=e._length,this._addDebugShaderVariantCollection(e,i,a)),e.addDefineDatas(fn._configDefineValues);var r=this._cacheSharders,o=e._length;o>this._cacheShaderHierarchy&&(this._resizeCacheShaderMap(r,0,o),this._cacheShaderHierarchy=o);for(var s=e._mask,l=e._length-1,u=this._cacheShaderHierarchy-1,c=0;c<u;c++){var h=l<c?0:s[c],_=r[h];_||(r[h]=_={}),r=_}var d=l<u?0:s[u],f=r[d];if(f)return f;var m=ShaderPass._defineString;_e._getNamesByDefineData(e,m);var p,T,v=w._config,g=v.lightClusterCount,E={},y="";t.WebGL._isWebGL2?(p="#version 300 es\n\n\t\t\t\t#define attribute in\n\t\t\t\t#define varying out\n\t\t\t\t#define texture2D texture\n",T="#version 300 es\n\n\t\t\t\t#define varying in\n\t\t\t\tout highp vec4 pc_fragColor;\n\t\t\t\t#define gl_FragColor pc_fragColor\n\t\t\t\t#define gl_FragDepthEXT gl_FragDepth\n\t\t\t\t#define texture2D texture\n\t\t\t\t#define textureCube texture\n\t\t\t\t#define texture2DProj textureProj\n\t\t\t\t#define texture2DLodEXT textureLod\n\t\t\t\t#define texture2DProjLodEXT textureProjLod\n\t\t\t\t#define textureCubeLodEXT textureLod\n\t\t\t\t#define texture2DGradEXT textureGrad\n\t\t\t\t#define texture2DProjGradEXT textureProjGrad\n\t\t\t\t#define textureCubeGradEXT textureGrad\n"):(p="",T="#ifdef GL_EXT_shader_texture_lod\n\t\t\t\t\t#extension GL_EXT_shader_texture_lod : enable\n\t\t\t\t#endif\n\t\t\t\t#if !defined(GL_EXT_shader_texture_lod)\n\t\t\t\t\t#define texture1DLodEXT texture1D\n\t\t\t\t\t#define texture2DLodEXT texture2D\n\t\t\t\t\t#define texture2DProjLodEXT texture2DProj\n\t\t\t\t\t#define texture3DLodEXT texture3D\n\t\t\t\t\t#define textureCubeLodEXT textureCube\n\t\t\t\t#endif\n"),y+="#define MAX_LIGHT_COUNT "+v.maxLightCount+"\n",y+="#define MAX_LIGHT_COUNT_PER_CLUSTER "+v._maxAreaLightCountPerClusterAverage+"\n",y+="#define CLUSTER_X_COUNT "+g.x+"\n",y+="#define CLUSTER_Y_COUNT "+g.y+"\n",y+="#define CLUSTER_Z_COUNT "+g.z+"\n",y+="#define SHADER_CAPAILITY_LEVEL "+t.SystemUtils._shaderCapailityLevel+"\n";c=0;for(var S=m.length;c<S;c++){var R=m[c];y+="#define "+R+"\n",E[R]=!0}var C=this._VS.toscript(E,[]),M="";0==C[0].indexOf("#version")&&(M=C[0]+"\n",C.shift());var D=this._PS.toscript(E,[]),x="";if(0==D[0].indexOf("#version")&&(x=D[0]+"\n",D.shift()),f=new vt(M+p+y+C.join("\n"),x+T+y+D.join("\n"),this._owner._attributeMap,this._owner._uniformMap||this._owner._owner._uniformMap,this),r[d]=f,_e.debugMode){var A="",I="";for(c=0,S=n;c<S;c++)I+=c==S-1?a[c]:a[c]+",";for(c=0,S=i.length;c<S;c++)A+=c==S-1?i[c]:i[c]+",";console.log("%cLayaAir: Shader Compile Information---ShaderName:"+this._owner._owner._name+" SubShaderIndex:"+this._owner._owner._subShaders.indexOf(this._owner)+" PassIndex:"+this._owner._passes.indexOf(this)+" DefineMask:["+I+"] DefineNames:["+A+"]","color:green")}return f}},{key:"setTag",value:function(e,t){t?this._tags[e]=t:delete this._tags[e]}},{key:"getTag",value:function(e){return this._tags[e]}},{key:"renderState",get:function(){return this._renderState}}]),ShaderPass}();mn._defineString=[],mn._debugDefineString=[],mn._debugDefineMask=[];var pn,Tn=function(){function SubShader(e,t){_classCallCheck(this,SubShader),this._flags={},this._passes=[],this._attributeMap=e,this._uniformMap=t}return _createClass(SubShader,[{key:"setFlag",value:function(e,t){t?this._flags[e]=t:delete this._flags[e]}},{key:"getFlag",value:function(e){return this._flags[e]}},{key:"addShaderPass",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"Forward",a=new mn(this,e,t,n);return a._pipelineMode=i,this._passes.push(a),a}}]),SubShader}();(pn=e.PBRSpecularSmoothnessSource||(e.PBRSpecularSmoothnessSource={}))[pn.SpecularTextureAlpha=0]="SpecularTextureAlpha",pn[pn.AlbedoTextureAlpha=1]="AlbedoTextureAlpha";var vn=function(e){function PBRSpecularMaterial(){var e;return _classCallCheck(this,PBRSpecularMaterial),(e=_possibleConstructorReturn(this,_getPrototypeOf(PBRSpecularMaterial).call(this))).setShaderName("PBRSpecular"),e._shaderValues.setVector(PBRSpecularMaterial.SPECULARCOLOR,new a(.2,.2,.2,1)),e}return _inherits(PBRSpecularMaterial,ft),_createClass(PBRSpecularMaterial,[{key:"clone",value:function(){var e=new PBRSpecularMaterial;return this.cloneTo(e),e}},{key:"specularTexture",get:function(){return this._shaderValues.getTexture(PBRSpecularMaterial.SPECULARTEXTURE)},set:function(e){e?this._shaderValues.addDefine(PBRSpecularMaterial.SHADERDEFINE_SPECULARGLOSSTEXTURE):this._shaderValues.removeDefine(PBRSpecularMaterial.SHADERDEFINE_SPECULARGLOSSTEXTURE),this._shaderValues.setTexture(PBRSpecularMaterial.SPECULARTEXTURE,e)}},{key:"specularColor",get:function(){return this._shaderValues.getVector(PBRSpecularMaterial.SPECULARCOLOR)},set:function(e){this._shaderValues.setVector(PBRSpecularMaterial.SPECULARCOLOR,e)}}],[{key:"__init__",value:function(){PBRSpecularMaterial.SHADERDEFINE_SPECULARGLOSSTEXTURE=_e.getDefineByName("SPECULARGLOSSTEXTURE"),PBRSpecularMaterial.SHADERDEFINE_SMOOTHNESSSOURCE_ALBEDOTEXTURE_ALPHA=_e.getDefineByName("SMOOTHNESSSOURCE_ALBEDOTEXTURE_ALPHA");var e={a_Position:Ne.MESH_POSITION0,a_Normal:Ne.MESH_NORMAL0,a_Tangent0:Ne.MESH_TANGENT0,a_Texcoord0:Ne.MESH_TEXTURECOORDINATE0,a_Texcoord1:Ne.MESH_TEXTURECOORDINATE1,a_BoneWeights:Ne.MESH_BLENDWEIGHT0,a_BoneIndices:Ne.MESH_BLENDINDICES0,a_WorldMat:Ne.MESH_WORLDMATRIX_ROW0},t={u_Bones:_e.PERIOD_CUSTOM,u_MvpMatrix:_e.PERIOD_SPRITE,u_WorldMat:_e.PERIOD_SPRITE,u_LightmapScaleOffset:_e.PERIOD_SPRITE,u_LightMap:_e.PERIOD_SPRITE,u_LightMapDirection:_e.PERIOD_SPRITE,u_SimpleAnimatorTexture:_e.PERIOD_SPRITE,u_SimpleAnimatorParams:_e.PERIOD_SPRITE,u_SimpleAnimatorTextureSize:_e.PERIOD_SPRITE,u_ReflectCubeHDRParams:_e.PERIOD_SPRITE,u_ReflectTexture:_e.PERIOD_SPRITE,u_SpecCubeProbePosition:_e.PERIOD_SPRITE,u_SpecCubeBoxMax:_e.PERIOD_SPRITE,u_SpecCubeBoxMin:_e.PERIOD_SPRITE,u_CameraPos:_e.PERIOD_CAMERA,u_View:_e.PERIOD_CAMERA,u_ProjectionParams:_e.PERIOD_CAMERA,u_Viewport:_e.PERIOD_CAMERA,u_ViewProjection:_e.PERIOD_CAMERA,u_AlphaTestValue:_e.PERIOD_MATERIAL,u_AlbedoColor:_e.PERIOD_MATERIAL,u_EmissionColor:_e.PERIOD_MATERIAL,u_AlbedoTexture:_e.PERIOD_MATERIAL,u_NormalTexture:_e.PERIOD_MATERIAL,u_ParallaxTexture:_e.PERIOD_MATERIAL,u_OcclusionTexture:_e.PERIOD_MATERIAL,u_EmissionTexture:_e.PERIOD_MATERIAL,u_Smoothness:_e.PERIOD_MATERIAL,u_SmoothnessScale:_e.PERIOD_MATERIAL,u_occlusionStrength:_e.PERIOD_MATERIAL,u_NormalScale:_e.PERIOD_MATERIAL,u_ParallaxScale:_e.PERIOD_MATERIAL,u_TilingOffset:_e.PERIOD_MATERIAL,u_SpecGlossTexture:_e.PERIOD_MATERIAL,u_SpecularColor:_e.PERIOD_MATERIAL,u_AmbientColor:_e.PERIOD_SCENE,u_FogStart:_e.PERIOD_SCENE,u_FogRange:_e.PERIOD_SCENE,u_FogColor:_e.PERIOD_SCENE,u_DirationLightCount:_e.PERIOD_SCENE,u_LightBuffer:_e.PERIOD_SCENE,u_LightClusterBuffer:_e.PERIOD_SCENE,u_ShadowBias:_e.PERIOD_SCENE,u_ShadowLightDirection:_e.PERIOD_SCENE,u_ShadowMap:_e.PERIOD_SCENE,u_ShadowParams:_e.PERIOD_SCENE,u_ShadowSplitSpheres:_e.PERIOD_SCENE,u_ShadowMatrices:_e.PERIOD_SCENE,u_ShadowMapSize:_e.PERIOD_SCENE,u_SpotShadowMap:_e.PERIOD_SCENE,u_SpotViewProjectMatrix:_e.PERIOD_SCENE,u_ShadowLightPosition:_e.PERIOD_SCENE,u_AmbientSHAr:_e.PERIOD_SCENE,u_AmbientSHAg:_e.PERIOD_SCENE,u_AmbientSHAb:_e.PERIOD_SCENE,u_AmbientSHBr:_e.PERIOD_SCENE,u_AmbientSHBg:_e.PERIOD_SCENE,u_AmbientSHBb:_e.PERIOD_SCENE,u_AmbientSHC:_e.PERIOD_SCENE,"u_DirectionLight.direction":_e.PERIOD_SCENE,"u_DirectionLight.color":_e.PERIOD_SCENE,"u_PointLight.position":_e.PERIOD_SCENE,"u_PointLight.range":_e.PERIOD_SCENE,"u_PointLight.color":_e.PERIOD_SCENE,"u_SpotLight.position":_e.PERIOD_SCENE,"u_SpotLight.direction":_e.PERIOD_SCENE,"u_SpotLight.range":_e.PERIOD_SCENE,"u_SpotLight.spot":_e.PERIOD_SCENE,"u_SpotLight.color":_e.PERIOD_SCENE},n={s_Cull:_e.RENDER_STATE_CULL,s_Blend:_e.RENDER_STATE_BLEND,s_BlendSrc:_e.RENDER_STATE_BLEND_SRC,s_BlendDst:_e.RENDER_STATE_BLEND_DST,s_DepthTest:_e.RENDER_STATE_DEPTH_TEST,s_DepthWrite:_e.RENDER_STATE_DEPTH_WRITE},i=_e.add("PBRSpecular",e,t,!0,!0),a=new Tn(e,t);i.addSubShader(a),a.addShaderPass('#include "PBRVSInput.glsl";\n#include "Lighting.glsl";\n#include "PBRVertex.glsl";\n\nvoid main()\n{\n\tvertexForward();\n\tgl_Position=remapGLPositionZ(gl_Position);\n}','#if defined(GL_FRAGMENT_PRECISION_HIGH)// 原来的写法会被我们自己的解析流程处理，而我们的解析是不认内置宏的，导致被删掉，所以改成 if defined 了\n\tprecision highp float;\n\tprecision highp int;\n#else\n\tprecision mediump float;\n\tprecision mediump int;\n#endif\n\n#define SETUP_BRDF_INPUT specularSetup\n\n#include "Lighting.glsl";\n#include "PBRFSInput.glsl";\n#include "LayaPBRBRDF.glsl";\n#include "GlobalIllumination.glsl";\n#include "Shadow.glsl"\n#include "PBRCore.glsl";\n\nvoid main()\n{\n\tfragmentForward();\n}',n,"Forward"),a.addShaderPass('#include "ShadowCasterVS.glsl"\n\nvoid main()\n{\n\tvec4 positionCS =  shadowCasterVertex();\n\tgl_Position=remapGLPositionZ(positionCS);\n}','#if defined(GL_FRAGMENT_PRECISION_HIGH)// 原来的写法会被我们自己的解析流程处理，而我们的解析是不认内置宏的，导致被删掉，所以改成 if defined 了\n\tprecision highp float;\n\tprecision highp int;\n#else\n\tprecision mediump float;\n\tprecision mediump int;\n#endif\n\n#include "ShadowCasterFS.glsl"\n\nvoid main()\n{\n\tgl_FragColor=shadowCasterFragment();\n}',n,"ShadowCaster"),a.addShaderPass(mt,pt,n,"DepthNormal")}}]),PBRSpecularMaterial}();vn.SPECULARTEXTURE=_e.propertyNameToID("u_SpecGlossTexture"),vn.SPECULARCOLOR=_e.propertyNameToID("u_SpecularColor");var gn;(gn=e.PBRMetallicSmoothnessSource||(e.PBRMetallicSmoothnessSource={}))[gn.MetallicGlossTextureAlpha=0]="MetallicGlossTextureAlpha",gn[gn.AlbedoTextureAlpha=1]="AlbedoTextureAlpha";var En=function(e){function PBRStandardMaterial(){var e;return _classCallCheck(this,PBRStandardMaterial),(e=_possibleConstructorReturn(this,_getPrototypeOf(PBRStandardMaterial).call(this)))._smoothnessSource=0,e.setShaderName("PBR"),e._shaderValues.setNumber(PBRStandardMaterial.METALLIC,0),e}return _inherits(PBRStandardMaterial,ft),_createClass(PBRStandardMaterial,[{key:"clone",value:function(){var e=new PBRStandardMaterial;return this.cloneTo(e),e}},{key:"metallicGlossTexture",get:function(){return this._shaderValues.getTexture(PBRStandardMaterial.METALLICGLOSSTEXTURE)},set:function(e){e?this._shaderValues.addDefine(PBRStandardMaterial.SHADERDEFINE_METALLICGLOSSTEXTURE):this._shaderValues.removeDefine(PBRStandardMaterial.SHADERDEFINE_METALLICGLOSSTEXTURE),this._shaderValues.setTexture(PBRStandardMaterial.METALLICGLOSSTEXTURE,e)}},{key:"metallic",get:function(){return this._shaderValues.getNumber(PBRStandardMaterial.METALLIC)},set:function(e){this._shaderValues.setNumber(PBRStandardMaterial.METALLIC,Math.max(0,Math.min(1,e)))}},{key:"smoothnessSource",get:function(){return this._smoothnessSource},set:function(e){e?this._shaderValues.addDefine(PBRStandardMaterial.SHADERDEFINE_SMOOTHNESSSOURCE_ALBEDOTEXTURE_ALPHA):this._shaderValues.removeDefine(PBRStandardMaterial.SHADERDEFINE_SMOOTHNESSSOURCE_ALBEDOTEXTURE_ALPHA),this._smoothnessSource=e}}],[{key:"__init__",value:function(){PBRStandardMaterial.SHADERDEFINE_METALLICGLOSSTEXTURE=_e.getDefineByName("METALLICGLOSSTEXTURE"),PBRStandardMaterial.SHADERDEFINE_SMOOTHNESSSOURCE_ALBEDOTEXTURE_ALPHA=_e.getDefineByName("SMOOTHNESSSOURCE_ALBEDOTEXTURE_ALPHA");var e={a_Position:Ne.MESH_POSITION0,a_Normal:Ne.MESH_NORMAL0,a_Tangent0:Ne.MESH_TANGENT0,a_Texcoord0:Ne.MESH_TEXTURECOORDINATE0,a_Texcoord1:Ne.MESH_TEXTURECOORDINATE1,a_BoneWeights:Ne.MESH_BLENDWEIGHT0,a_BoneIndices:Ne.MESH_BLENDINDICES0,a_WorldMat:Ne.MESH_WORLDMATRIX_ROW0},t={u_Bones:_e.PERIOD_CUSTOM,u_MvpMatrix:_e.PERIOD_SPRITE,u_WorldMat:_e.PERIOD_SPRITE,u_LightmapScaleOffset:_e.PERIOD_SPRITE,u_LightMap:_e.PERIOD_SPRITE,u_LightMapDirection:_e.PERIOD_SPRITE,u_SimpleAnimatorTexture:_e.PERIOD_SPRITE,u_SimpleAnimatorParams:_e.PERIOD_SPRITE,u_SimpleAnimatorTextureSize:_e.PERIOD_SPRITE,u_ReflectCubeHDRParams:_e.PERIOD_SPRITE,u_ReflectTexture:_e.PERIOD_SPRITE,u_SpecCubeProbePosition:_e.PERIOD_SPRITE,u_SpecCubeBoxMax:_e.PERIOD_SPRITE,u_SpecCubeBoxMin:_e.PERIOD_SPRITE,u_CameraPos:_e.PERIOD_CAMERA,u_View:_e.PERIOD_CAMERA,u_ProjectionParams:_e.PERIOD_CAMERA,u_Viewport:_e.PERIOD_CAMERA,u_ViewProjection:_e.PERIOD_CAMERA,u_AlphaTestValue:_e.PERIOD_MATERIAL,u_AlbedoColor:_e.PERIOD_MATERIAL,u_EmissionColor:_e.PERIOD_MATERIAL,u_AlbedoTexture:_e.PERIOD_MATERIAL,u_NormalTexture:_e.PERIOD_MATERIAL,u_ParallaxTexture:_e.PERIOD_MATERIAL,u_OcclusionTexture:_e.PERIOD_MATERIAL,u_EmissionTexture:_e.PERIOD_MATERIAL,u_Smoothness:_e.PERIOD_MATERIAL,u_SmoothnessScale:_e.PERIOD_MATERIAL,u_occlusionStrength:_e.PERIOD_MATERIAL,u_NormalScale:_e.PERIOD_MATERIAL,u_ParallaxScale:_e.PERIOD_MATERIAL,u_TilingOffset:_e.PERIOD_MATERIAL,u_MetallicGlossTexture:_e.PERIOD_MATERIAL,u_Metallic:_e.PERIOD_MATERIAL,u_AmbientColor:_e.PERIOD_SCENE,u_FogStart:_e.PERIOD_SCENE,u_FogRange:_e.PERIOD_SCENE,u_FogColor:_e.PERIOD_SCENE,u_DirationLightCount:_e.PERIOD_SCENE,u_LightBuffer:_e.PERIOD_SCENE,u_LightClusterBuffer:_e.PERIOD_SCENE,u_ShadowBias:_e.PERIOD_SCENE,u_ShadowLightDirection:_e.PERIOD_SCENE,u_ShadowMap:_e.PERIOD_SCENE,u_ShadowParams:_e.PERIOD_SCENE,u_ShadowSplitSpheres:_e.PERIOD_SCENE,u_ShadowMatrices:_e.PERIOD_SCENE,u_ShadowMapSize:_e.PERIOD_SCENE,u_SpotShadowMap:_e.PERIOD_SCENE,u_SpotViewProjectMatrix:_e.PERIOD_SCENE,u_ShadowLightPosition:_e.PERIOD_SCENE,u_AmbientSHAr:_e.PERIOD_SCENE,u_AmbientSHAg:_e.PERIOD_SCENE,u_AmbientSHAb:_e.PERIOD_SCENE,u_AmbientSHBr:_e.PERIOD_SCENE,u_AmbientSHBg:_e.PERIOD_SCENE,u_AmbientSHBb:_e.PERIOD_SCENE,u_AmbientSHC:_e.PERIOD_SCENE,"u_DirectionLight.direction":_e.PERIOD_SCENE,"u_DirectionLight.color":_e.PERIOD_SCENE,"u_PointLight.position":_e.PERIOD_SCENE,"u_PointLight.range":_e.PERIOD_SCENE,"u_PointLight.color":_e.PERIOD_SCENE,"u_SpotLight.position":_e.PERIOD_SCENE,"u_SpotLight.direction":_e.PERIOD_SCENE,"u_SpotLight.range":_e.PERIOD_SCENE,"u_SpotLight.spot":_e.PERIOD_SCENE,"u_SpotLight.color":_e.PERIOD_SCENE},n={s_Cull:_e.RENDER_STATE_CULL,s_Blend:_e.RENDER_STATE_BLEND,s_BlendSrc:_e.RENDER_STATE_BLEND_SRC,s_BlendDst:_e.RENDER_STATE_BLEND_DST,s_DepthTest:_e.RENDER_STATE_DEPTH_TEST,s_DepthWrite:_e.RENDER_STATE_DEPTH_WRITE},i=_e.add("PBR",e,t,!0,!0),a=new Tn(e,t);i.addSubShader(a),a.addShaderPass('#if defined(GL_FRAGMENT_PRECISION_HIGH)// 原来的写法会被我们自己的解析流程处理，而我们的解析是不认内置宏的，导致被删掉，所以改成 if defined 了\n\tprecision highp float;\n\tprecision highp int;\n#else\n\tprecision mediump float;\n\tprecision mediump int;\n#endif\n#include "Lighting.glsl";\n#include "LayaUtile.glsl"\n#include "Shadow.glsl"\n#include "PBRVSInput.glsl";\n#include "PBRVertex.glsl";\n\nvoid main()\n{\n\tvertexForward();\n\tgl_Position=remapGLPositionZ(gl_Position);\n}','#if defined(GL_FRAGMENT_PRECISION_HIGH)// 原来的写法会被我们自己的解析流程处理，而我们的解析是不认内置宏的，导致被删掉，所以改成 if defined 了\n\tprecision highp float;\n\tprecision highp int;\n#else\n\tprecision mediump float;\n\tprecision mediump int;\n#endif\n\n#include "Lighting.glsl";\n#include "Shadow.glsl"\n#include "PBRFSInput.glsl";\n#include "LayaPBRBRDF.glsl";\n#include "GlobalIllumination.glsl";\n#include "PBRCore.glsl";\n\nvoid main()\n{\n\tfragmentForward();\n}',n,"Forward"),a.addShaderPass('#include "ShadowCasterVS.glsl"\n\nvoid main()\n{\n\tvec4 positionCS =  shadowCasterVertex();\n\tgl_Position=remapGLPositionZ(positionCS);\n}','#if defined(GL_FRAGMENT_PRECISION_HIGH)// 原来的写法会被我们自己的解析流程处理，而我们的解析是不认内置宏的，导致被删掉，所以改成 if defined 了\n\tprecision highp float;\n\tprecision highp int;\n#else\n\tprecision mediump float;\n\tprecision mediump int;\n#endif\n\n#include "ShadowCasterFS.glsl"\n\nvoid main()\n{\n\tgl_FragColor=shadowCasterFragment();\n}',n,"ShadowCaster"),a.addShaderPass(mt,pt,n,"DepthNormal")}}]),PBRStandardMaterial}();En.METALLICGLOSSTEXTURE=_e.propertyNameToID("u_MetallicGlossTexture"),En.METALLIC=_e.propertyNameToID("u_Metallic");var yn=function(e){function SkyBoxMaterial(){var e;return _classCallCheck(this,SkyBoxMaterial),(e=_possibleConstructorReturn(this,_getPrototypeOf(SkyBoxMaterial).call(this))).setShaderName("SkyBox"),e.tintColor=new a(.5,.5,.5,.5),e.exposure=1,e.rotation=0,e}return _inherits(SkyBoxMaterial,st),_createClass(SkyBoxMaterial,[{key:"clone",value:function(){var e=new SkyBoxMaterial;return this.cloneTo(e),e}},{key:"tintColor",get:function(){return this._shaderValues.getVector(SkyBoxMaterial.TINTCOLOR)},set:function(e){this._shaderValues.setVector(SkyBoxMaterial.TINTCOLOR,e)}},{key:"exposure",get:function(){return this._shaderValues.getNumber(SkyBoxMaterial.EXPOSURE)},set:function(e){this._shaderValues.setNumber(SkyBoxMaterial.EXPOSURE,e)}},{key:"rotation",get:function(){return this._shaderValues.getNumber(SkyBoxMaterial.ROTATION)},set:function(e){this._shaderValues.setNumber(SkyBoxMaterial.ROTATION,e)}},{key:"textureCube",get:function(){return this._shaderValues.getTexture(SkyBoxMaterial.TEXTURECUBE)},set:function(e){this._shaderValues.setTexture(SkyBoxMaterial.TEXTURECUBE,e)}}],[{key:"__initDefine__",value:function(){}}]),SkyBoxMaterial}();yn.TINTCOLOR=_e.propertyNameToID("u_TintColor"),yn.EXPOSURE=_e.propertyNameToID("u_Exposure"),yn.ROTATION=_e.propertyNameToID("u_Rotation"),yn.TEXTURECUBE=_e.propertyNameToID("u_CubeTexture");var Sn=function(e){function SkyProceduralMaterial(){var e;return _classCallCheck(this,SkyProceduralMaterial),(e=_possibleConstructorReturn(this,_getPrototypeOf(SkyProceduralMaterial).call(this))).setShaderName("SkyBoxProcedural"),e.sunDisk=SkyProceduralMaterial.SUN_HIGH_QUALITY,e.sunSize=.04,e.sunSizeConvergence=5,e.atmosphereThickness=1,e.skyTint=new a(.5,.5,.5,1),e.groundTint=new a(.369,.349,.341,1),e.exposure=1.3,e}return _inherits(SkyProceduralMaterial,st),_createClass(SkyProceduralMaterial,[{key:"clone",value:function(){var e=new SkyProceduralMaterial;return this.cloneTo(e),e}},{key:"sunDisk",get:function(){return this._sunDisk},set:function(e){switch(e){case SkyProceduralMaterial.SUN_HIGH_QUALITY:this._shaderValues.removeDefine(SkyProceduralMaterial.SHADERDEFINE_SUN_SIMPLE),this._shaderValues.addDefine(SkyProceduralMaterial.SHADERDEFINE_SUN_HIGH_QUALITY);break;case SkyProceduralMaterial.SUN_SIMPLE:this._shaderValues.removeDefine(SkyProceduralMaterial.SHADERDEFINE_SUN_HIGH_QUALITY),this._shaderValues.addDefine(SkyProceduralMaterial.SHADERDEFINE_SUN_SIMPLE);break;case SkyProceduralMaterial.SUN_NODE:this._shaderValues.removeDefine(SkyProceduralMaterial.SHADERDEFINE_SUN_HIGH_QUALITY),this._shaderValues.removeDefine(SkyProceduralMaterial.SHADERDEFINE_SUN_SIMPLE);break;default:throw"SkyBoxProceduralMaterial: unknown sun value."}this._sunDisk=e}},{key:"sunSize",get:function(){return this._shaderValues.getNumber(SkyProceduralMaterial.SUNSIZE)},set:function(e){e=Math.min(Math.max(0,e),1),this._shaderValues.setNumber(SkyProceduralMaterial.SUNSIZE,e)}},{key:"sunSizeConvergence",get:function(){return this._shaderValues.getNumber(SkyProceduralMaterial.SUNSIZECONVERGENCE)},set:function(e){e=Math.min(Math.max(0,e),20),this._shaderValues.setNumber(SkyProceduralMaterial.SUNSIZECONVERGENCE,e)}},{key:"atmosphereThickness",get:function(){return this._shaderValues.getNumber(SkyProceduralMaterial.ATMOSPHERETHICKNESS)},set:function(e){e=Math.min(Math.max(0,e),5),this._shaderValues.setNumber(SkyProceduralMaterial.ATMOSPHERETHICKNESS,e)}},{key:"skyTint",get:function(){return this._shaderValues.getVector(SkyProceduralMaterial.SKYTINT)},set:function(e){this._shaderValues.setVector(SkyProceduralMaterial.SKYTINT,e)}},{key:"groundTint",get:function(){return this._shaderValues.getVector(SkyProceduralMaterial.GROUNDTINT)},set:function(e){this._shaderValues.setVector(SkyProceduralMaterial.GROUNDTINT,e)}},{key:"exposure",get:function(){return this._shaderValues.getNumber(SkyProceduralMaterial.EXPOSURE)},set:function(e){e=Math.min(Math.max(0,e),8),this._shaderValues.setNumber(SkyProceduralMaterial.EXPOSURE,e)}}],[{key:"__initDefine__",value:function(){SkyProceduralMaterial.SHADERDEFINE_SUN_HIGH_QUALITY=_e.getDefineByName("SUN_HIGH_QUALITY"),SkyProceduralMaterial.SHADERDEFINE_SUN_SIMPLE=_e.getDefineByName("SUN_SIMPLE")}}]),SkyProceduralMaterial}();Sn.SUN_NODE=0,Sn.SUN_SIMPLE=1,Sn.SUN_HIGH_QUALITY=2,Sn.SUNSIZE=_e.propertyNameToID("u_SunSize"),Sn.SUNSIZECONVERGENCE=_e.propertyNameToID("u_SunSizeConvergence"),Sn.ATMOSPHERETHICKNESS=_e.propertyNameToID("u_AtmosphereThickness"),Sn.SKYTINT=_e.propertyNameToID("u_SkyTint"),Sn.GROUNDTINT=_e.propertyNameToID("u_GroundTint"),Sn.EXPOSURE=_e.propertyNameToID("u_Exposure");var Rn=function(e){function UnlitMaterial(){var e;return _classCallCheck(this,UnlitMaterial),(e=_possibleConstructorReturn(this,_getPrototypeOf(UnlitMaterial).call(this)))._albedoColor=new a(1,1,1,1),e._albedoIntensity=1,e._enableVertexColor=!1,e.setShaderName("Unlit"),e._shaderValues.setVector(UnlitMaterial.ALBEDOCOLOR,new a(1,1,1,1)),e._shaderValues.setVector(UnlitMaterial.TILINGOFFSET,new a(1,1,0,0)),e.renderMode=UnlitMaterial.RENDERMODE_OPAQUE,e}return _inherits(UnlitMaterial,st),_createClass(UnlitMaterial,[{key:"clone",value:function(){var e=new UnlitMaterial;return this.cloneTo(e),e}},{key:"_ColorR",get:function(){return this._albedoColor.x},set:function(e){this._albedoColor.x=e,this.albedoColor=this._albedoColor}},{key:"_ColorG",get:function(){return this._albedoColor.y},set:function(e){this._albedoColor.y=e,this.albedoColor=this._albedoColor}},{key:"_ColorB",get:function(){return this._albedoColor.z},set:function(e){this._albedoColor.z=e,this.albedoColor=this._albedoColor}},{key:"_ColorA",get:function(){return this._albedoColor.w},set:function(e){this._albedoColor.w=e,this.albedoColor=this._albedoColor}},{key:"_Color",get:function(){return this._shaderValues.getVector(UnlitMaterial.ALBEDOCOLOR)},set:function(e){this.albedoColor=e}},{key:"_AlbedoIntensity",get:function(){return this._albedoIntensity},set:function(e){if(this._albedoIntensity!==e){var t=this._shaderValues.getVector(UnlitMaterial.ALBEDOCOLOR);a.scale(this._albedoColor,e,t),this._albedoIntensity=e,this._shaderValues.setVector(UnlitMaterial.ALBEDOCOLOR,t)}}},{key:"_MainTex_STX",get:function(){return this._shaderValues.getVector(UnlitMaterial.TILINGOFFSET).x},set:function(e){var t=this._shaderValues.getVector(UnlitMaterial.TILINGOFFSET);t.x=e,this.tilingOffset=t}},{key:"_MainTex_STY",get:function(){return this._shaderValues.getVector(UnlitMaterial.TILINGOFFSET).y},set:function(e){var t=this._shaderValues.getVector(UnlitMaterial.TILINGOFFSET);t.y=e,this.tilingOffset=t}},{key:"_MainTex_STZ",get:function(){return this._shaderValues.getVector(UnlitMaterial.TILINGOFFSET).z},set:function(e){var t=this._shaderValues.getVector(UnlitMaterial.TILINGOFFSET);t.z=e,this.tilingOffset=t}},{key:"_MainTex_STW",get:function(){return this._shaderValues.getVector(UnlitMaterial.TILINGOFFSET).w},set:function(e){var t=this._shaderValues.getVector(UnlitMaterial.TILINGOFFSET);t.w=e,this.tilingOffset=t}},{key:"_MainTex_ST",get:function(){return this._shaderValues.getVector(UnlitMaterial.TILINGOFFSET)},set:function(e){this.tilingOffset=e}},{key:"_Cutoff",get:function(){return this.alphaTestValue},set:function(e){this.alphaTestValue=e}},{key:"albedoColorR",get:function(){return this._ColorR},set:function(e){this._ColorR=e}},{key:"albedoColorG",get:function(){return this._ColorG},set:function(e){this._ColorG=e}},{key:"albedoColorB",get:function(){return this._ColorB},set:function(e){this._ColorB=e}},{key:"albedoColorA",get:function(){return this._ColorA},set:function(e){this._ColorA=e}},{key:"albedoColor",get:function(){return this._albedoColor},set:function(e){var t=this._shaderValues.getVector(UnlitMaterial.ALBEDOCOLOR);a.scale(e,this._albedoIntensity,t),this._albedoColor=e,this._shaderValues.setVector(UnlitMaterial.ALBEDOCOLOR,t)}},{key:"albedoIntensity",get:function(){return this._albedoIntensity},set:function(e){this._AlbedoIntensity=e}},{key:"albedoTexture",get:function(){return this._shaderValues.getTexture(UnlitMaterial.ALBEDOTEXTURE)},set:function(e){e?this._shaderValues.addDefine(UnlitMaterial.SHADERDEFINE_ALBEDOTEXTURE):this._shaderValues.removeDefine(UnlitMaterial.SHADERDEFINE_ALBEDOTEXTURE),this._shaderValues.setTexture(UnlitMaterial.ALBEDOTEXTURE,e)}},{key:"tilingOffsetX",get:function(){return this._MainTex_STX},set:function(e){this._MainTex_STX=e}},{key:"tilingOffsetY",get:function(){return this._MainTex_STY},set:function(e){this._MainTex_STY=e}},{key:"tilingOffsetZ",get:function(){return this._MainTex_STZ},set:function(e){this._MainTex_STZ=e}},{key:"tilingOffsetW",get:function(){return this._MainTex_STW},set:function(e){this._MainTex_STW=e}},{key:"tilingOffset",get:function(){return this._shaderValues.getVector(UnlitMaterial.TILINGOFFSET)},set:function(e){e?this._shaderValues.setVector(UnlitMaterial.TILINGOFFSET,e):this._shaderValues.getVector(UnlitMaterial.TILINGOFFSET).setValue(1,1,0,0)}},{key:"enableVertexColor",get:function(){return this._enableVertexColor},set:function(e){this._enableVertexColor=e,e?this._shaderValues.addDefine(UnlitMaterial.SHADERDEFINE_ENABLEVERTEXCOLOR):this._shaderValues.removeDefine(UnlitMaterial.SHADERDEFINE_ENABLEVERTEXCOLOR)}},{key:"renderMode",set:function(e){switch(e){case UnlitMaterial.RENDERMODE_OPAQUE:this.alphaTest=!1,this.renderQueue=st.RENDERQUEUE_OPAQUE,this.depthWrite=!0,this.cull=ut.CULL_BACK,this.blend=ut.BLEND_DISABLE,this.depthTest=ut.DEPTHTEST_LESS;break;case UnlitMaterial.RENDERMODE_CUTOUT:this.renderQueue=st.RENDERQUEUE_ALPHATEST,this.alphaTest=!0,this.depthWrite=!0,this.cull=ut.CULL_BACK,this.blend=ut.BLEND_DISABLE,this.depthTest=ut.DEPTHTEST_LESS;break;case UnlitMaterial.RENDERMODE_TRANSPARENT:this.renderQueue=st.RENDERQUEUE_TRANSPARENT,this.alphaTest=!1,this.depthWrite=!1,this.cull=ut.CULL_BACK,this.blend=ut.BLEND_ENABLE_ALL,this.blendSrc=ut.BLENDPARAM_SRC_ALPHA,this.blendDst=ut.BLENDPARAM_ONE_MINUS_SRC_ALPHA,this.depthTest=ut.DEPTHTEST_LESS;break;default:throw new Error("UnlitMaterial : renderMode value error.")}}}],[{key:"__initDefine__",value:function(){UnlitMaterial.SHADERDEFINE_ALBEDOTEXTURE=_e.getDefineByName("ALBEDOTEXTURE"),UnlitMaterial.SHADERDEFINE_ENABLEVERTEXCOLOR=_e.getDefineByName("ENABLEVERTEXCOLOR")}}]),UnlitMaterial}();Rn.RENDERMODE_OPAQUE=0,Rn.RENDERMODE_CUTOUT=1,Rn.RENDERMODE_TRANSPARENT=2,Rn.RENDERMODE_ADDTIVE=3,Rn.ALBEDOTEXTURE=_e.propertyNameToID("u_AlbedoTexture"),Rn.ALBEDOCOLOR=_e.propertyNameToID("u_AlbedoColor"),Rn.TILINGOFFSET=_e.propertyNameToID("u_TilingOffset");var Cn=function(e){function WaterPrimaryMaterial(){var e;return _classCallCheck(this,WaterPrimaryMaterial),(e=_possibleConstructorReturn(this,_getPrototypeOf(WaterPrimaryMaterial).call(this))).setShaderName("WaterPrimary"),e._shaderValues.setVector(WaterPrimaryMaterial.HORIZONCOLOR,new a(.172,.463,.435,0)),e._shaderValues.setNumber(WaterPrimaryMaterial.WAVESCALE,.15),e._shaderValues.setVector(WaterPrimaryMaterial.WAVESPEED,new a(19,9,-16,-7)),e}return _inherits(WaterPrimaryMaterial,st),_createClass(WaterPrimaryMaterial,[{key:"clone",value:function(){var e=new WaterPrimaryMaterial;return this.cloneTo(e),e}},{key:"horizonColor",get:function(){return this._shaderValues.getVector(WaterPrimaryMaterial.HORIZONCOLOR)},set:function(e){this._shaderValues.setVector(WaterPrimaryMaterial.HORIZONCOLOR,e)}},{key:"mainTexture",get:function(){return this._shaderValues.getTexture(WaterPrimaryMaterial.MAINTEXTURE)},set:function(e){e?this._shaderValues.addDefine(WaterPrimaryMaterial.SHADERDEFINE_MAINTEXTURE):this._shaderValues.removeDefine(WaterPrimaryMaterial.SHADERDEFINE_MAINTEXTURE),this._shaderValues.setTexture(WaterPrimaryMaterial.MAINTEXTURE,e)}},{key:"normalTexture",get:function(){return this._shaderValues.getTexture(WaterPrimaryMaterial.NORMALTEXTURE)},set:function(e){e?this._shaderValues.addDefine(WaterPrimaryMaterial.SHADERDEFINE_NORMALTEXTURE):this._shaderValues.removeDefine(WaterPrimaryMaterial.SHADERDEFINE_NORMALTEXTURE),this._shaderValues.setTexture(WaterPrimaryMaterial.NORMALTEXTURE,e)}},{key:"waveScale",get:function(){return this._shaderValues.getNumber(WaterPrimaryMaterial.WAVESCALE)},set:function(e){this._shaderValues.setNumber(WaterPrimaryMaterial.WAVESCALE,e)}},{key:"waveSpeed",get:function(){return this._shaderValues.getVector(WaterPrimaryMaterial.WAVESPEED)},set:function(e){this._shaderValues.setVector(WaterPrimaryMaterial.WAVESPEED,e)}}],[{key:"__initDefine__",value:function(){WaterPrimaryMaterial.SHADERDEFINE_MAINTEXTURE=_e.getDefineByName("MAINTEXTURE"),WaterPrimaryMaterial.SHADERDEFINE_NORMALTEXTURE=_e.getDefineByName("NORMALTEXTURE")}}]),WaterPrimaryMaterial}();Cn.HORIZONCOLOR=_e.propertyNameToID("u_HorizonColor"),Cn.MAINTEXTURE=_e.propertyNameToID("u_MainTexture"),Cn.NORMALTEXTURE=_e.propertyNameToID("u_NormalTexture"),Cn.WAVESCALE=_e.propertyNameToID("u_WaveScale"),Cn.WAVESPEED=_e.propertyNameToID("u_WaveSpeed");var Mn=function(t){function MeshRenderer(e){var t;return _classCallCheck(this,MeshRenderer),(t=_possibleConstructorReturn(this,_getPrototypeOf(MeshRenderer).call(this,e)))._revertStaticBatchDefineUV1=!1,t._projectionViewWorldMatrix=new c,t}return _inherits(MeshRenderer,qt),_createClass(MeshRenderer,[{key:"_createRenderElement",value:function(){return new Wt}},{key:"_onMeshChange",value:function(e){if(e){var t=e.subMeshCount;this._renderElements.length=t;for(var n=0;n<t;n++){var i=this._renderElements[n];if(!i){var a=this.sharedMaterials[n];(i=this._renderElements[n]=this._createRenderElement()).setTransform(this._owner._transform),i.render=this,i.material=a||ct.defaultMaterial}i.setGeometry(e.getSubMesh(n))}}else this._renderElements.length=0;this._boundsChange=!0}},{key:"_calculateBoundingBox",value:function(){var e=this._owner.meshFilter.sharedMesh;if(e){var t=this._owner.transform.worldMatrix;e.bounds._tranform(t,this._bounds)}}},{key:"_needRender",value:function(e,t){return!e||e.intersects(this.bounds._getBoundBox())}},{key:"_renderUpdate",value:function(t,n){this._applyLightMapParams();var i=t.renderElement;switch(i.renderType){case qe.RENDERTYPE_NORMAL:this._shaderValues.setMatrix4x4(ve.WORLDMATRIX,n.worldMatrix);break;case qe.RENDERTYPE_STATICBATCH:n?this._shaderValues.setMatrix4x4(ve.WORLDMATRIX,n.worldMatrix):this._shaderValues.setMatrix4x4(ve.WORLDMATRIX,c.DEFAULT),this._shaderValues.hasDefine($e.SHADERDEFINE_UV1)?this._revertStaticBatchDefineUV1=!1:(this._shaderValues.addDefine($e.SHADERDEFINE_UV1),this._revertStaticBatchDefineUV1=!0),this._shaderValues.setVector(Gt.LIGHTMAPSCALEOFFSET,qt._defaultLightmapScaleOffset);break;case qe.RENDERTYPE_VERTEXBATCH:this._shaderValues.setMatrix4x4(ve.WORLDMATRIX,c.DEFAULT);break;case qe.RENDERTYPE_INSTANCEBATCH:for(var a=zt.instance.instanceWorldMatrixData,r=i.instanceBatchElementList,o=r.elements,s=r.length,l=0;l<s;l++)a.set(o[l]._transform.worldMatrix.elements,16*l);var u=zt.instance.instanceWorldMatrixBuffer;u.orphanStorage(),u.setData(a.buffer,0,0,16*s*4),this._shaderValues.addDefine($e.SHADERDEFINE_GPU_INSTANCE)}this._probReflection&&(this._reflectionMode==e.ReflectionProbeMode.off?(this._shaderValues.removeDefine($e.SHADERDEFINE_SPECCUBE_BOX_PROJECTION),this._shaderValues.setVector(Gt.REFLECTIONCUBE_HDR_PARAMS,Qt.defaultTextureHDRDecodeValues),this._shaderValues.setTexture(Gt.REFLECTIONTEXTURE,Ot.blackTexture)):(this._probReflection.boxProjection?(this._shaderValues.addDefine($e.SHADERDEFINE_SPECCUBE_BOX_PROJECTION),this._shaderValues.setVector3(Gt.REFLECTIONCUBE_PROBEPOSITION,this._probReflection.probePosition),this._shaderValues.setVector3(Gt.REFLECTIONCUBE_PROBEBOXMAX,this._probReflection.boundsMax),this._shaderValues.setVector3(Gt.REFLECTIONCUBE_PROBEBOXMIN,this._probReflection.boundsMin)):this._shaderValues.removeDefine($e.SHADERDEFINE_SPECCUBE_BOX_PROJECTION),this._shaderValues.setTexture(Gt.REFLECTIONTEXTURE,this._probReflection.reflectionTexture),this._shaderValues.setVector(Gt.REFLECTIONCUBE_HDR_PARAMS,this._probReflection.reflectionHDRParams)))}},{key:"_renderUpdateWithCamera",value:function(e,t){var n=e.projectionViewMatrix;if(n)switch(e.renderElement.renderType){case qe.RENDERTYPE_NORMAL:case qe.RENDERTYPE_STATICBATCH:case qe.RENDERTYPE_VERTEXBATCH:t?(c.multiply(n,t.worldMatrix,this._projectionViewWorldMatrix),this._shaderValues.setMatrix4x4(ve.MVPMATRIX,this._projectionViewWorldMatrix)):this._shaderValues.setMatrix4x4(ve.MVPMATRIX,n)}}},{key:"_revertBatchRenderUpdate",value:function(e){switch(e.renderElement.renderType){case qe.RENDERTYPE_STATICBATCH:this._revertStaticBatchDefineUV1&&this._shaderValues.removeDefine($e.SHADERDEFINE_UV1),this._shaderValues.setVector(Gt.LIGHTMAPSCALEOFFSET,this.lightmapScaleOffset);break;case qe.RENDERTYPE_INSTANCEBATCH:this._shaderValues.removeDefine($e.SHADERDEFINE_GPU_INSTANCE)}}},{key:"_destroy",value:function(){this._isPartOfStaticBatch&&Zt.instance._removeRenderSprite(this._owner),_get(_getPrototypeOf(MeshRenderer.prototype),"_destroy",this).call(this)}}]),MeshRenderer}(),Dn=function(){function MeshFilter(e){_classCallCheck(this,MeshFilter),this._owner=e}return _createClass(MeshFilter,[{key:"_getMeshDefine",value:function(e,t){t.length=0;for(var n=0,i=e._subMeshes.length;n<i;n++)for(var a=e.getSubMesh(n)._vertexBuffer._vertexDeclaration._vertexElements,r=0,o=a.length;r<o;r++){switch(a[r]._elementUsage){case Ne.MESH_COLOR0:t.push($e.SHADERDEFINE_COLOR);break;case Ne.MESH_TEXTURECOORDINATE0:t.push($e.SHADERDEFINE_UV0);break;case Ne.MESH_TEXTURECOORDINATE1:t.push($e.SHADERDEFINE_UV1)}}}},{key:"destroy",value:function(){this._owner=null,this._sharedMesh&&(this._sharedMesh._removeReference(),this._sharedMesh=null)}},{key:"sharedMesh",get:function(){return this._sharedMesh},set:function(e){if(this._sharedMesh!==e){var t=this._owner._render._shaderValues,n=this._sharedMesh;if(n){n._removeReference(),this._getMeshDefine(n,MeshFilter._meshVerticeDefine);for(var i=0,a=MeshFilter._meshVerticeDefine.length;i<a;i++)t.removeDefine(MeshFilter._meshVerticeDefine[i])}if(e){e._addReference(),this._getMeshDefine(e,MeshFilter._meshVerticeDefine);for(i=0,a=MeshFilter._meshVerticeDefine.length;i<a;i++)t.addDefine(MeshFilter._meshVerticeDefine[i])}this._owner._render._onMeshChange(e),this._sharedMesh=e}}}]),MeshFilter}();Dn._meshVerticeDefine=[];var xn=function(n){function SubMeshDynamicBatch(){var n;_classCallCheck(this,SubMeshDynamicBatch),(n=_possibleConstructorReturn(this,_getPrototypeOf(SubMeshDynamicBatch).call(this)))._bufferState=new oe;var i=t.LayaGL.instance,a=Ne.getVertexDeclaration("POSITION,NORMAL,COLOR,UV,UV1,TANGENT").vertexStride*SubMeshDynamicBatch.maxIndicesCount;n._vertices=new Float32Array(a/4),n._vertexBuffer=new te(a,i.DYNAMIC_DRAW),n._indices=new Int16Array(SubMeshDynamicBatch.maxIndicesCount),n._indexBuffer=new Oe(e.IndexFormat.UInt16,n._indices.length,i.DYNAMIC_DRAW);var r=n._vertexBuffer._byteLength+n._indexBuffer._byteLength;return t.Resource._addMemory(r,r),n}return _inherits(SubMeshDynamicBatch,Vt),_createClass(SubMeshDynamicBatch,[{key:"_getBatchVertices",value:function(e,t,n,i,a){var r=e.vertexStride/4,o=a._vertexBuffer.getFloat32Data(),s=i._dynamicMultiSubMesh,l=i._dynamicVertexCount;i._computeWorldPositionsAndNormals(this._positionOffset,this._normalOffset,s,l);for(var u=i._dynamicWorldPositions,c=i._dynamicWorldNormals,h=a._indices,_=0;_<l;_++){var d=(s?h[_]:_)*r,f=(_+n)*r,m=3*_,p=f+this._positionOffset;t[p]=u[m],t[p+1]=u[m+1],t[p+2]=u[m+2],-1!==this._normalOffset&&(t[p=f+this._normalOffset]=c[m],t[p+1]=c[m+1],t[p+2]=c[m+2]),-1!==this._colorOffset&&(p=f+this._colorOffset,m=d+this._colorOffset,t[p]=o[m],t[p+1]=o[m+1],t[p+2]=o[m+2],t[p+3]=o[m+3]),-1!==this._uv0Offset&&(p=f+this._uv0Offset,m=d+this._uv0Offset,t[p]=o[m],t[p+1]=o[m+1]),-1!==this._sTangentOffset&&(p=f+this._sTangentOffset,m=d+this._sTangentOffset,t[p]=o[m],t[p+1]=o[m+1],t[p+2]=o[m+2],t[p+3]=o[m+3],p=f+this._sTangentOffset,m=d+this._sTangentOffset,t[p]=o[m],t[p+1]=o[m+1],t[p+2]=o[m+2],t[p+3]=o[m+3])}}},{key:"_getBatchIndices",value:function(e,t,n,i,a,r){var o,s,l,u=a._indices,c=i._isFrontFaceInvert;if(r)if(c)for(o=0,s=u.length;o<s;o+=3){var h=n+o;e[l=t+o]=h,e[l+1]=h+2,e[l+2]=h+1}else for(o=0,s=u.length;o<s;o+=3)h=n+o,e[l=t+o]=h,e[l+1]=h+1,e[l+2]=h+2;else if(c)for(o=0,s=u.length;o<s;o+=3)e[l=t+o]=n+u[o],e[l+1]=n+u[o+2],e[l+2]=n+u[o+1];else for(o=0,s=u.length;o<s;o+=3)e[l=t+o]=n+u[o],e[l+1]=n+u[o+1],e[l+2]=n+u[o+2]}},{key:"_flush",value:function(e,n){var i=t.LayaGL.instance;this._vertexBuffer.setData(this._vertices.buffer,0,0,e*this._bufferState.vertexDeclaration.vertexStride),this._indexBuffer.setData(this._indices,0,0,n),i.drawElements(i.TRIANGLES,n,i.UNSIGNED_SHORT,0)}},{key:"_prepareRender",value:function(e){var t=e.renderElement.vertexBatchVertexDeclaration;this._bufferState=l.MeshRenderDynamicBatchManager.instance._getBufferState(t),this._positionOffset=t.getVertexElementByUsage(Ne.MESH_POSITION0)._offset/4;var n=t.getVertexElementByUsage(Ne.MESH_NORMAL0);this._normalOffset=n?n._offset/4:-1;var i=t.getVertexElementByUsage(Ne.MESH_COLOR0);this._colorOffset=i?i._offset/4:-1;var a=t.getVertexElementByUsage(Ne.MESH_TEXTURECOORDINATE0);this._uv0Offset=a?a._offset/4:-1;var r=t.getVertexElementByUsage(Ne.MESH_TEXTURECOORDINATE1);this._uv1Offset=r?r._offset/4:-1;var o=t.getVertexElementByUsage(Ne.MESH_TANGENT0);return this._sTangentOffset=o?o._offset/4:-1,!0}},{key:"_render",value:function(e){this._bufferState.bind();for(var n=e.renderElement,i=n.vertexBatchVertexDeclaration,a=n.vertexBatchElementList,r=0,o=0,s=0,l=a.length,u=a.elements,c=0;c<l;c++){var h=u[c],_=h._geometry,d=_._indexCount;o+d>SubMeshDynamicBatch.maxIndicesCount&&(this._flush(r,o),s++,t.Stat.trianglesFaces+=o/3,r=o=0);var f=h._transform;this._getBatchVertices(i,this._vertices,r,h,_),this._getBatchIndices(this._indices,o,r,f,_,h._dynamicMultiSubMesh),r+=h._dynamicVertexCount,o+=d}this._flush(r,o),s++,t.Stat.renderBatches+=s,t.Stat.savedRenderBatches+=l-s,t.Stat.trianglesFaces+=o/3}}],[{key:"__init__",value:function(){SubMeshDynamicBatch.instance=new SubMeshDynamicBatch}}]),SubMeshDynamicBatch}();xn.maxAllowVertexCount=10,xn.maxAllowAttribueCount=900,xn.maxIndicesCount=32e3;var An=function(e){function MeshRenderDynamicBatchManager(){var e;return _classCallCheck(this,MeshRenderDynamicBatchManager),(e=_possibleConstructorReturn(this,_getPrototypeOf(MeshRenderDynamicBatchManager).call(this)))._instanceBatchOpaqueMarks=[],e._vertexBatchOpaqueMarks=[],e._cacheBufferStates=[],e._updateCountMark=0,e}return _inherits(MeshRenderDynamicBatchManager,cn),_createClass(MeshRenderDynamicBatchManager,[{key:"getInstanceBatchOpaquaMark",value:function(e,t,n,i){var a=this._instanceBatchOpaqueMarks[e?0:1]||(this._instanceBatchOpaqueMarks[e?0:1]=[]),r=a[t]||(a[t]=[]),o=r[n]||(r[n]=[]);return o[i?1:0]||(o[i?1:0]=new Ht)}},{key:"getVertexBatchOpaquaMark",value:function(e,t,n,i){var a=this._vertexBatchOpaqueMarks[e]||(this._vertexBatchOpaqueMarks[e]=[]),r=a[t?0:1]||(a[t?0:1]=[]),o=r[n]||(r[n]=[]);return o[i]||(o[i]=new Ht)}},{key:"_getBufferState",value:function(e){var t=this._cacheBufferStates[e.id];if(!t){var n=xn.instance;(t=new oe).bind();var i=n._vertexBuffer;i.vertexDeclaration=e,t.applyVertexBuffer(i),t.applyIndexBuffer(n._indexBuffer),t.unBind(),this._cacheBufferStates[e.id]=t}return t}},{key:"_getBatchRenderElementFromPool",value:function(){var e=this._batchRenderElementPool[this._batchRenderElementPoolIndex++];return e||(e=new Wt,this._batchRenderElementPool[this._batchRenderElementPoolIndex-1]=e,e.vertexBatchElementList=new R,e.instanceBatchElementList=new R),e}},{key:"_clear",value:function(){_get(_getPrototypeOf(MeshRenderDynamicBatchManager.prototype),"_clear",this).call(this),this._updateCountMark++}}]),MeshRenderDynamicBatchManager}();An.instance=new An;var In=function(e){function MeshSprite3D(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return _classCallCheck(this,MeshSprite3D),(e=_possibleConstructorReturn(this,_getPrototypeOf(MeshSprite3D).call(this,n)))._meshFilter=new Dn(_assertThisInitialized(e)),e._render=new Mn(_assertThisInitialized(e)),t&&(e._meshFilter.sharedMesh=t),e}return _inherits(MeshSprite3D,Gt),_createClass(MeshSprite3D,[{key:"_parse",value:function(e,n){_get(_getPrototypeOf(MeshSprite3D.prototype),"_parse",this).call(this,e,n);var i=this.meshRenderer,r=e.lightmapIndex;null!=r&&(i.lightmapIndex=r);var o=e.lightmapScaleOffset;o&&(i.lightmapScaleOffset=new a(o[0],o[1],o[2],o[3])),null!=e.meshPath&&(this.meshFilter.sharedMesh=t.Loader.getRes(e.meshPath)),null!=e.enableRender&&(i.enable=e.enableRender),null!=e.receiveShadows&&(i.receiveShadow=e.receiveShadows),null!=e.castShadow&&(i.castShadow=e.castShadow);var s=e.materials;if(s){var l=i.sharedMaterials,u=s.length;l.length=u;for(var c=0;c<u;c++)l[c]=t.Loader.getRes(s[c].path);i.sharedMaterials=l}}},{key:"_addToInitStaticBatchManager",value:function(){this.meshFilter.sharedMesh&&Zt.instance._addBatchSprite(this)}},{key:"_cloneTo",value:function(e,t,n){var i=e;i._meshFilter.sharedMesh=this._meshFilter.sharedMesh;var a=this._render,r=i._render;r.enable=a.enable,r.sharedMaterials=a.sharedMaterials,r.castShadow=a.castShadow;var o=a.lightmapScaleOffset;o&&(r.lightmapScaleOffset=o.clone()),r.lightmapIndex=a.lightmapIndex,r.receiveShadow=a.receiveShadow,r.sortingFudge=a.sortingFudge,_get(_getPrototypeOf(MeshSprite3D.prototype),"_cloneTo",this).call(this,e,t,n)}},{key:"destroy",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];this.destroyed||(_get(_getPrototypeOf(MeshSprite3D.prototype),"destroy",this).call(this,e),this._meshFilter.destroy())}},{key:"_create",value:function(){return new MeshSprite3D}},{key:"meshFilter",get:function(){return this._meshFilter}},{key:"meshRenderer",get:function(){return this._render}}],[{key:"__init__",value:function(){$e.SHADERDEFINE_UV0=_e.getDefineByName("UV"),$e.SHADERDEFINE_COLOR=_e.getDefineByName("COLOR"),$e.SHADERDEFINE_UV1=_e.getDefineByName("UV1"),$e.SHADERDEFINE_GPU_INSTANCE=_e.getDefineByName("GPU_INSTANCE"),$e.SHADERDEFINE_SPECCUBE_BOX_PROJECTION=_e.getDefineByName("SPECCUBE_BOX_PROJECTION"),Xt._registerManager(Zt.instance),cn._registerManager(An.instance)}}]),MeshSprite3D}(),Ln=function GradientMode(){_classCallCheck(this,GradientMode)};Ln.Blend=0,Ln.Fixed=1;var Pn,On=function(){function Gradient(e,t){_classCallCheck(this,Gradient),this._mode=0,this._maxColorRGBKeysCount=0,this._maxColorAlphaKeysCount=0,this._colorRGBKeysCount=0,this._colorAlphaKeysCount=0,this._alphaElements=null,this._rgbElements=null,this._maxColorRGBKeysCount=e,this._maxColorAlphaKeysCount=t,this._rgbElements=new Float32Array(4*e),this._alphaElements=new Float32Array(2*t)}return _createClass(Gradient,[{key:"addColorRGB",value:function(e,t){if(this._colorRGBKeysCount<this._maxColorRGBKeysCount){var n=4*this._colorRGBKeysCount;this._rgbElements[n]=e,this._rgbElements[n+1]=t.r,this._rgbElements[n+2]=t.g,this._rgbElements[n+3]=t.b,this._colorRGBKeysCount++}else console.warn("Gradient:warning:data count must lessEqual than "+this._maxColorRGBKeysCount)}},{key:"addColorAlpha",value:function(e,t){if(this._colorAlphaKeysCount<this._maxColorAlphaKeysCount){var n=2*this._colorAlphaKeysCount;this._alphaElements[n]=e,this._alphaElements[n+1]=t,this._colorAlphaKeysCount++}else console.warn("Gradient:warning:data count must lessEqual than "+this._maxColorAlphaKeysCount)}},{key:"updateColorRGB",value:function(e,t,n){if(e<this._colorRGBKeysCount){var i=4*e;this._rgbElements[i]=t,this._rgbElements[i+1]=n.r,this._rgbElements[i+2]=n.g,this._rgbElements[i+3]=n.b}else console.warn("Gradient:warning:index must lessEqual than colorRGBKeysCount:"+this._colorRGBKeysCount)}},{key:"updateColorAlpha",value:function(e,t,n){if(e<this._colorAlphaKeysCount){var i=2*e;this._alphaElements[i]=t,this._alphaElements[i+1]=n}else console.warn("Gradient:warning:index must lessEqual than colorAlphaKeysCount:"+this._colorAlphaKeysCount)}},{key:"evaluateColorRGB",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,i=arguments.length>3&&void 0!==arguments[3]&&arguments[3];e=Math.min(Math.max(e,0),1);var a=this._rgbElements,r=n;if(i)for(var o=r;o>=0;o--){var s=4*o;if(e===(d=a[s]))return t.r=a[s+1],t.g=a[s+2],t.b=a[s+3],r;switch(this._mode){case Ln.Blend:if(e>d){if(e>(_=a[s+4]))throw"Gradient:wrong startSearchIndex.";var l=_-d,u=_-e,c=e-d;return t.r=(u*a[s+1]+c*a[s+5])/l,t.g=(u*a[s+2]+c*a[s+6])/l,t.b=(u*a[s+3]+c*a[s+7])/l,r}r--;continue;case Ln.Fixed:if(e>d){if(e>a[s+4])throw"Gradient:wrong startSearchIndex.";return t.r=a[s+5],t.g=a[s+6],t.b=a[s+7],r}r--;continue;default:throw"Gradient:unknown mode."}}else{o=0;for(var h=this._rgbElements.length;o<h;o++){var _;if(e===(_=a[s=4*o]))return t.r=a[s+1],t.g=a[s+2],t.b=a[s+3],r;switch(this._mode){case Ln.Blend:if(e<_){var d;if(e<(d=a[s-4]))throw"Gradient:wrong startSearchIndex.";l=_-d,u=_-e,c=e-d;return t.r=(u*a[s-3]+c*a[s+1])/l,t.g=(u*a[s-2]+c*a[s+2])/l,t.b=(u*a[s-1]+c*a[s+3])/l,r}r++;continue;case Ln.Fixed:if(e<_){if(e<a[s-4])throw"Gradient:wrong startSearchIndex.";return t.r=a[s+1],t.g=a[s+2],t.b=a[s+3],r}r++;continue;default:throw"Gradient:unknown mode."}}}return r}},{key:"evaluateColorAlpha",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,i=arguments.length>3&&void 0!==arguments[3]&&arguments[3];e=Math.min(Math.max(e,0),1);var a=this._alphaElements,r=n;if(i)for(var o=r;o>=0;o--){if(e===(d=a[h=2*o]))return t.a=a[h+1],r;switch(this._mode){case Ln.Blend:if(e>d){if(e>(_=a[h+2]))throw"Gradient:wrong startSearchIndex.";var s=_-d,l=_-e,u=e-d;return t.a=(l*a[h+1]+u*a[h+3])/s,r}r--;continue;case Ln.Fixed:if(e>d){if(e>a[h+2])throw"Gradient:wrong startSearchIndex.";return t.a=a[h+3],r}r--;continue;default:throw"Gradient:unknown mode."}}else{o=r;for(var c=this._alphaElements.length;o<c;o++){var h,_;if(e===(_=a[h=2*o]))return t.a=a[h+1],r;switch(this._mode){case Ln.Blend:if(e<_){var d;if(e<(d=a[h-2]))throw"Gradient:wrong startSearchIndex.";s=_-d,l=_-e,u=e-d;return t.a=(l*a[h-1]+u*a[h+1])/s,r}r++;continue;case Ln.Fixed:if(e<_){if(e<a[h-2])throw"Gradient:wrong startSearchIndex.";return t.a=a[h+1],r}r++;continue;default:throw"Gradient:unknown mode."}}}return r}},{key:"cloneTo",value:function(e){var t,n,i=e;i._colorAlphaKeysCount=this._colorAlphaKeysCount;var a=i._alphaElements;for(t=0,n=this._alphaElements.length;t<n;t++)a[t]=this._alphaElements[t];i._colorRGBKeysCount=this._colorRGBKeysCount;var r=i._rgbElements;for(t=0,n=this._rgbElements.length;t<n;t++)r[t]=this._rgbElements[t]}},{key:"clone",value:function(){var e=new Gradient(this._maxColorRGBKeysCount,this._maxColorAlphaKeysCount);return this.cloneTo(e),e}},{key:"mode",get:function(){return this._mode},set:function(e){this._mode=e}},{key:"colorRGBKeysCount",get:function(){return this._colorRGBKeysCount}},{key:"colorAlphaKeysCount",get:function(){return this._colorAlphaKeysCount}},{key:"maxColorRGBKeysCount",get:function(){return this._maxColorRGBKeysCount}},{key:"maxColorAlphaKeysCount",get:function(){return this._maxColorAlphaKeysCount}}]),Gradient}(),Nn=function(){function Burst(e,t,n){_classCallCheck(this,Burst),this._time=e,this._minCount=t,this._maxCount=n}return _createClass(Burst,[{key:"cloneTo",value:function(e){var t=e;t._time=this._time,t._minCount=this._minCount,t._maxCount=this._maxCount}},{key:"clone",value:function(){var e=new Burst(this._time,this._minCount,this._maxCount);return this.cloneTo(e),e}},{key:"time",get:function(){return this._time}},{key:"minCount",get:function(){return this._minCount}},{key:"maxCount",get:function(){return this._maxCount}}]),Burst}(),bn=function(){function GradientColor(){_classCallCheck(this,GradientColor),this._type=0,this._constant=null,this._constantMin=null,this._constantMax=null,this._gradient=null,this._gradientMin=null,this._gradientMax=null}return _createClass(GradientColor,[{key:"cloneTo",value:function(e){var t=e;t._type=this._type,this._constant.cloneTo(t._constant),this._constantMin.cloneTo(t._constantMin),this._constantMax.cloneTo(t._constantMax),this._gradient.cloneTo(t._gradient),this._gradientMin.cloneTo(t._gradientMin),this._gradientMax.cloneTo(t._gradientMax)}},{key:"clone",value:function(){var e=new GradientColor;return this.cloneTo(e),e}},{key:"type",get:function(){return this._type}},{key:"constant",get:function(){return this._constant}},{key:"constantMin",get:function(){return this._constantMin}},{key:"constantMax",get:function(){return this._constantMax}},{key:"gradient",get:function(){return this._gradient}},{key:"gradientMin",get:function(){return this._gradientMin}},{key:"gradientMax",get:function(){return this._gradientMax}}],[{key:"createByConstant",value:function(e){var t=new GradientColor;return t._type=0,t._constant=e,t}},{key:"createByGradient",value:function(e){var t=new GradientColor;return t._type=1,t._gradient=e,t}},{key:"createByRandomTwoConstant",value:function(e,t){var n=new GradientColor;return n._type=2,n._constantMin=e,n._constantMax=t,n}},{key:"createByRandomTwoGradient",value:function(e,t){var n=new GradientColor;return n._type=3,n._gradientMin=e,n._gradientMax=t,n}}]),GradientColor}(),kn=function(){function ColorOverLifetime(e){_classCallCheck(this,ColorOverLifetime),this._color=e}return _createClass(ColorOverLifetime,[{key:"cloneTo",value:function(e){var t=e;this._color.cloneTo(t._color),t.enable=this.enable}},{key:"clone",value:function(){var e;switch(this._color.type){case 0:e=bn.createByConstant(this._color.constant.clone());break;case 1:e=bn.createByGradient(this._color.gradient.clone());break;case 2:e=bn.createByRandomTwoConstant(this._color.constantMin.clone(),this._color.constantMax.clone());break;case 3:e=bn.createByRandomTwoGradient(this._color.gradientMin.clone(),this._color.gradientMax.clone())}var t=new ColorOverLifetime(e);return t.enable=this.enable,t}},{key:"color",get:function(){return this._color}}]),ColorOverLifetime}(),wn=function(){function FrameOverTime(){_classCallCheck(this,FrameOverTime),this._type=0,this._constant=0,this._overTime=null,this._constantMin=0,this._constantMax=0,this._overTimeMin=null,this._overTimeMax=null}return _createClass(FrameOverTime,[{key:"cloneTo",value:function(e){var t=e;t._type=this._type,t._constant=this._constant,this._overTime&&this._overTime.cloneTo(t._overTime),t._constantMin=this._constantMin,t._constantMax=this._constantMax,this._overTimeMin&&this._overTimeMin.cloneTo(t._overTimeMin),this._overTimeMax&&this._overTimeMax.cloneTo(t._overTimeMax)}},{key:"clone",value:function(){var e=new FrameOverTime;return this.cloneTo(e),e}},{key:"type",get:function(){return this._type}},{key:"constant",get:function(){return this._constant}},{key:"frameOverTimeData",get:function(){return this._overTime}},{key:"constantMin",get:function(){return this._constantMin}},{key:"constantMax",get:function(){return this._constantMax}},{key:"frameOverTimeDataMin",get:function(){return this._overTimeMin}},{key:"frameOverTimeDataMax",get:function(){return this._overTimeMax}}],[{key:"createByConstant",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=new FrameOverTime;return t._type=0,t._constant=e,t}},{key:"createByOverTime",value:function(e){var t=new FrameOverTime;return t._type=1,t._overTime=e,t}},{key:"createByRandomTwoConstant",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=new FrameOverTime;return n._type=2,n._constantMin=e,n._constantMax=t,n}},{key:"createByRandomTwoOverTime",value:function(e,t){var n=new FrameOverTime;return n._type=3,n._overTimeMin=e,n._overTimeMax=t,n}}]),FrameOverTime}(),Bn=function(){function GradientAngularVelocity(){_classCallCheck(this,GradientAngularVelocity),this._type=0,this._separateAxes=!1,this._constant=0,this._constantSeparate=null,this._gradient=null,this._gradientX=null,this._gradientY=null,this._gradientZ=null,this._gradientW=null,this._constantMin=0,this._constantMax=0,this._constantMinSeparate=null,this._constantMaxSeparate=null,this._gradientMin=null,this._gradientMax=null,this._gradientXMin=null,this._gradientXMax=null,this._gradientYMin=null,this._gradientYMax=null,this._gradientZMin=null,this._gradientZMax=null,this._gradientWMin=null,this._gradientWMax=null}return _createClass(GradientAngularVelocity,[{key:"cloneTo",value:function(e){var t=e;t._type=this._type,t._separateAxes=this._separateAxes,t._constant=this._constant,this._constantSeparate.cloneTo(t._constantSeparate),this._gradient.cloneTo(t._gradient),this._gradientX.cloneTo(t._gradientX),this._gradientY.cloneTo(t._gradientY),this._gradientZ.cloneTo(t._gradientZ),t._constantMin=this._constantMin,t._constantMax=this._constantMax,this._constantMinSeparate.cloneTo(t._constantMinSeparate),this._constantMaxSeparate.cloneTo(t._constantMaxSeparate),this._gradientMin.cloneTo(t._gradientMin),this._gradientMax.cloneTo(t._gradientMax),this._gradientXMin.cloneTo(t._gradientXMin),this._gradientXMax.cloneTo(t._gradientXMax),this._gradientYMin.cloneTo(t._gradientYMin),this._gradientYMax.cloneTo(t._gradientYMax),this._gradientZMin.cloneTo(t._gradientZMin),this._gradientZMax.cloneTo(t._gradientZMax)}},{key:"clone",value:function(){var e=new GradientAngularVelocity;return this.cloneTo(e),e}},{key:"type",get:function(){return this._type}},{key:"separateAxes",get:function(){return this._separateAxes}},{key:"constant",get:function(){return this._constant}},{key:"constantSeparate",get:function(){return this._constantSeparate}},{key:"gradient",get:function(){return this._gradient}},{key:"gradientX",get:function(){return this._gradientX}},{key:"gradientY",get:function(){return this._gradientY}},{key:"gradientZ",get:function(){return this._gradientZ}},{key:"gradientW",get:function(){return this._gradientW}},{key:"constantMin",get:function(){return this._constantMin}},{key:"constantMax",get:function(){return this._constantMax}},{key:"constantMinSeparate",get:function(){return this._constantMinSeparate}},{key:"constantMaxSeparate",get:function(){return this._constantMaxSeparate}},{key:"gradientMin",get:function(){return this._gradientMin}},{key:"gradientMax",get:function(){return this._gradientMax}},{key:"gradientXMin",get:function(){return this._gradientXMin}},{key:"gradientXMax",get:function(){return this._gradientXMax}},{key:"gradientYMin",get:function(){return this._gradientYMin}},{key:"gradientYMax",get:function(){return this._gradientYMax}},{key:"gradientZMin",get:function(){return this._gradientZMin}},{key:"gradientZMax",get:function(){return this._gradientZMax}},{key:"gradientWMin",get:function(){return this._gradientWMin}},{key:"gradientWMax",get:function(){return this._gradientWMax}}],[{key:"createByConstant",value:function(e){var t=new GradientAngularVelocity;return t._type=0,t._separateAxes=!1,t._constant=e,t}},{key:"createByConstantSeparate",value:function(e){var t=new GradientAngularVelocity;return t._type=0,t._separateAxes=!0,t._constantSeparate=e,t}},{key:"createByGradient",value:function(e){var t=new GradientAngularVelocity;return t._type=1,t._separateAxes=!1,t._gradient=e,t}},{key:"createByGradientSeparate",value:function(e,t,n){var i=new GradientAngularVelocity;return i._type=1,i._separateAxes=!0,i._gradientX=e,i._gradientY=t,i._gradientZ=n,i}},{key:"createByRandomTwoConstant",value:function(e,t){var n=new GradientAngularVelocity;return n._type=2,n._separateAxes=!1,n._constantMin=e,n._constantMax=t,n}},{key:"createByRandomTwoConstantSeparate",value:function(e,t){var n=new GradientAngularVelocity;return n._type=2,n._separateAxes=!0,n._constantMinSeparate=e,n._constantMaxSeparate=t,n}},{key:"createByRandomTwoGradient",value:function(e,t){var n=new GradientAngularVelocity;return n._type=3,n._separateAxes=!1,n._gradientMin=e,n._gradientMax=t,n}},{key:"createByRandomTwoGradientSeparate",value:function(e,t,n,i,a,r,o,s){var l=new GradientAngularVelocity;return l._type=3,l._separateAxes=!0,l._gradientXMin=e,l._gradientXMax=t,l._gradientYMin=n,l._gradientYMax=i,l._gradientZMin=a,l._gradientZMax=r,l._gradientWMin=o,l._gradientWMax=s,l}}]),GradientAngularVelocity}(),Vn=function(){function GradientDataInt(){_classCallCheck(this,GradientDataInt),this._currentLength=0,this._elements=new Float32Array(8)}return _createClass(GradientDataInt,[{key:"add",value:function(e,t){this._currentLength<8?(6===this._currentLength&&1!==e&&(e=1,console.log("Warning:the forth key is  be force set to 1.")),this._elements[this._currentLength++]=e,this._elements[this._currentLength++]=t):console.log("Warning:data count must lessEqual than 4")}},{key:"cloneTo",value:function(e){var t=e;t._currentLength=this._currentLength;for(var n=t._elements,i=0,a=this._elements.length;i<a;i++)n[i]=this._elements[i]}},{key:"clone",value:function(){var e=new GradientDataInt;return this.cloneTo(e),e}},{key:"gradientCount",get:function(){return this._currentLength/2}}]),GradientDataInt}(),Fn=function(){function GradientDataNumber(){_classCallCheck(this,GradientDataNumber),this._currentLength=0,this._elements=new Float32Array(8)}return _createClass(GradientDataNumber,[{key:"add",value:function(e,t){this._currentLength<8?(6===this._currentLength&&1!==e&&(e=1,console.log("GradientDataNumber warning:the forth key is  be force set to 1.")),this._elements[this._currentLength++]=e,this._elements[this._currentLength++]=t):console.log("GradientDataNumber warning:data count must lessEqual than 4")}},{key:"getKeyByIndex",value:function(e){return this._elements[2*e]}},{key:"getValueByIndex",value:function(e){return this._elements[2*e+1]}},{key:"getAverageValue",value:function(){for(var e=0,t=0,n=0,i=this._currentLength-2;n<i;n+=2){var a=this._elements[n+1];a+=this._elements[n+3],e+=a*=this._elements[n+2]-this._elements[n],t++}return e/t}},{key:"cloneTo",value:function(e){var t=e;t._currentLength=this._currentLength;for(var n=t._elements,i=0,a=this._elements.length;i<a;i++)n[i]=this._elements[i]}},{key:"clone",value:function(){var e=new GradientDataNumber;return this.cloneTo(e),e}},{key:"gradientCount",get:function(){return this._currentLength/2}}]),GradientDataNumber}(),Un=function(){function GradientSize(){_classCallCheck(this,GradientSize),this._type=0,this._separateAxes=!1,this._gradient=null,this._gradientX=null,this._gradientY=null,this._gradientZ=null,this._constantMin=0,this._constantMax=0,this._constantMinSeparate=null,this._constantMaxSeparate=null,this._gradientMin=null,this._gradientMax=null,this._gradientXMin=null,this._gradientXMax=null,this._gradientYMin=null,this._gradientYMax=null,this._gradientZMin=null,this._gradientZMax=null}return _createClass(GradientSize,[{key:"getMaxSizeInGradient",value:function(){var e,t,n=arguments.length>0&&void 0!==arguments[0]&&arguments[0],i=-Number.MAX_VALUE;switch(this._type){case 0:if(this._separateAxes){for(e=0,t=this._gradientX.gradientCount;e<t;e++)i=Math.max(i,this._gradientX.getValueByIndex(e));for(e=0,t=this._gradientY.gradientCount;e<t;e++)i=Math.max(i,this._gradientY.getValueByIndex(e));if(n)for(e=0,t=this._gradientZ.gradientCount;e<t;e++)i=Math.max(i,this._gradientZ.getValueByIndex(e))}else for(e=0,t=this._gradient.gradientCount;e<t;e++)i=Math.max(i,this._gradient.getValueByIndex(e));break;case 1:this._separateAxes?(i=Math.max(this._constantMinSeparate.x,this._constantMaxSeparate.x),i=Math.max(i,this._constantMinSeparate.y),n&&(i=i=Math.max(i,this._constantMaxSeparate.z))):i=Math.max(this._constantMin,this._constantMax);break;case 2:if(this._separateAxes){for(e=0,t=this._gradientXMin.gradientCount;e<t;e++)i=Math.max(i,this._gradientXMin.getValueByIndex(e));for(e=0,t=this._gradientXMax.gradientCount;e<t;e++)i=Math.max(i,this._gradientXMax.getValueByIndex(e));for(e=0,t=this._gradientYMin.gradientCount;e<t;e++)i=Math.max(i,this._gradientYMin.getValueByIndex(e));for(e=0,t=this._gradientZMax.gradientCount;e<t;e++)i=Math.max(i,this._gradientZMax.getValueByIndex(e));if(n){for(e=0,t=this._gradientZMin.gradientCount;e<t;e++)i=Math.max(i,this._gradientZMin.getValueByIndex(e));for(e=0,t=this._gradientZMax.gradientCount;e<t;e++)i=Math.max(i,this._gradientZMax.getValueByIndex(e))}}else{for(e=0,t=this._gradientMin.gradientCount;e<t;e++)i=Math.max(i,this._gradientMin.getValueByIndex(e));for(e=0,t=this._gradientMax.gradientCount;e<t;e++)i=Math.max(i,this._gradientMax.getValueByIndex(e))}}return i}},{key:"cloneTo",value:function(e){var t=e;t._type=this._type,t._separateAxes=this._separateAxes,this._gradient.cloneTo(t._gradient),this._gradientX.cloneTo(t._gradientX),this._gradientY.cloneTo(t._gradientY),this._gradientZ.cloneTo(t._gradientZ),t._constantMin=this._constantMin,t._constantMax=this._constantMax,this._constantMinSeparate.cloneTo(t._constantMinSeparate),this._constantMaxSeparate.cloneTo(t._constantMaxSeparate),this._gradientMin.cloneTo(t._gradientMin),this._gradientMax.cloneTo(t._gradientMax),this._gradientXMin.cloneTo(t._gradientXMin),this._gradientXMax.cloneTo(t._gradientXMax),this._gradientYMin.cloneTo(t._gradientYMin),this._gradientYMax.cloneTo(t._gradientYMax),this._gradientZMin.cloneTo(t._gradientZMin),this._gradientZMax.cloneTo(t._gradientZMax)}},{key:"clone",value:function(){var e=new GradientSize;return this.cloneTo(e),e}},{key:"type",get:function(){return this._type}},{key:"separateAxes",get:function(){return this._separateAxes}},{key:"gradient",get:function(){return this._gradient}},{key:"gradientX",get:function(){return this._gradientX}},{key:"gradientY",get:function(){return this._gradientY}},{key:"gradientZ",get:function(){return this._gradientZ}},{key:"constantMin",get:function(){return this._constantMin}},{key:"constantMax",get:function(){return this._constantMax}},{key:"constantMinSeparate",get:function(){return this._constantMinSeparate}},{key:"constantMaxSeparate",get:function(){return this._constantMaxSeparate}},{key:"gradientMin",get:function(){return this._gradientMin}},{key:"gradientMax",get:function(){return this._gradientMax}},{key:"gradientXMin",get:function(){return this._gradientXMin}},{key:"gradientXMax",get:function(){return this._gradientXMax}},{key:"gradientYMin",get:function(){return this._gradientYMin}},{key:"gradientYMax",get:function(){return this._gradientYMax}},{key:"gradientZMin",get:function(){return this._gradientZMin}},{key:"gradientZMax",get:function(){return this._gradientZMax}}],[{key:"createByGradient",value:function(e){var t=new GradientSize;return t._type=0,t._separateAxes=!1,t._gradient=e,t}},{key:"createByGradientSeparate",value:function(e,t,n){var i=new GradientSize;return i._type=0,i._separateAxes=!0,i._gradientX=e,i._gradientY=t,i._gradientZ=n,i}},{key:"createByRandomTwoConstant",value:function(e,t){var n=new GradientSize;return n._type=1,n._separateAxes=!1,n._constantMin=e,n._constantMax=t,n}},{key:"createByRandomTwoConstantSeparate",value:function(e,t){var n=new GradientSize;return n._type=1,n._separateAxes=!0,n._constantMinSeparate=e,n._constantMaxSeparate=t,n}},{key:"createByRandomTwoGradient",value:function(e,t){var n=new GradientSize;return n._type=2,n._separateAxes=!1,n._gradientMin=e,n._gradientMax=t,n}},{key:"createByRandomTwoGradientSeparate",value:function(e,t,n,i,a,r){var o=new GradientSize;return o._type=2,o._separateAxes=!0,o._gradientXMin=e,o._gradientXMax=t,o._gradientYMin=n,o._gradientYMax=i,o._gradientZMin=a,o._gradientZMax=r,o}}]),GradientSize}(),Gn=function(){function GradientVelocity(){_classCallCheck(this,GradientVelocity),this._type=0,this._constant=null,this._gradientX=null,this._gradientY=null,this._gradientZ=null,this._constantMin=null,this._constantMax=null,this._gradientXMin=null,this._gradientXMax=null,this._gradientYMin=null,this._gradientYMax=null,this._gradientZMin=null,this._gradientZMax=null}return _createClass(GradientVelocity,[{key:"cloneTo",value:function(e){var t=e;t._type=this._type,this._constant.cloneTo(t._constant),this._gradientX.cloneTo(t._gradientX),this._gradientY.cloneTo(t._gradientY),this._gradientZ.cloneTo(t._gradientZ),this._constantMin.cloneTo(t._constantMin),this._constantMax.cloneTo(t._constantMax),this._gradientXMin.cloneTo(t._gradientXMin),this._gradientXMax.cloneTo(t._gradientXMax),this._gradientYMin.cloneTo(t._gradientYMin),this._gradientYMax.cloneTo(t._gradientYMax),this._gradientZMin.cloneTo(t._gradientZMin),this._gradientZMax.cloneTo(t._gradientZMax)}},{key:"clone",value:function(){var e=new GradientVelocity;return this.cloneTo(e),e}},{key:"type",get:function(){return this._type}},{key:"constant",get:function(){return this._constant}},{key:"gradientX",get:function(){return this._gradientX}},{key:"gradientY",get:function(){return this._gradientY}},{key:"gradientZ",get:function(){return this._gradientZ}},{key:"constantMin",get:function(){return this._constantMin}},{key:"constantMax",get:function(){return this._constantMax}},{key:"gradientXMin",get:function(){return this._gradientXMin}},{key:"gradientXMax",get:function(){return this._gradientXMax}},{key:"gradientYMin",get:function(){return this._gradientYMin}},{key:"gradientYMax",get:function(){return this._gradientYMax}},{key:"gradientZMin",get:function(){return this._gradientZMin}},{key:"gradientZMax",get:function(){return this._gradientZMax}}],[{key:"createByConstant",value:function(e){var t=new GradientVelocity;return t._type=0,t._constant=e,t}},{key:"createByGradient",value:function(e,t,n){var i=new GradientVelocity;return i._type=1,i._gradientX=e,i._gradientY=t,i._gradientZ=n,i}},{key:"createByRandomTwoConstant",value:function(e,t){var n=new GradientVelocity;return n._type=2,n._constantMin=e,n._constantMax=t,n}},{key:"createByRandomTwoGradient",value:function(e,t,n,i,a,r){var o=new GradientVelocity;return o._type=3,o._gradientXMin=e,o._gradientXMax=t,o._gradientYMin=n,o._gradientYMax=i,o._gradientZMin=a,o._gradientZMax=r,o}}]),GradientVelocity}(),Hn=function(){function RotationOverLifetime(e){_classCallCheck(this,RotationOverLifetime),this._angularVelocity=e}return _createClass(RotationOverLifetime,[{key:"cloneTo",value:function(e){var t=e;this._angularVelocity.cloneTo(t._angularVelocity),t.enable=this.enable}},{key:"clone",value:function(){var e;switch(this._angularVelocity.type){case 0:e=this._angularVelocity.separateAxes?Bn.createByConstantSeparate(this._angularVelocity.constantSeparate.clone()):Bn.createByConstant(this._angularVelocity.constant);break;case 1:e=this._angularVelocity.separateAxes?Bn.createByGradientSeparate(this._angularVelocity.gradientX.clone(),this._angularVelocity.gradientY.clone(),this._angularVelocity.gradientZ.clone()):Bn.createByGradient(this._angularVelocity.gradient.clone());break;case 2:e=this._angularVelocity.separateAxes?Bn.createByRandomTwoConstantSeparate(this._angularVelocity.constantMinSeparate.clone(),this._angularVelocity.constantMaxSeparate.clone()):Bn.createByRandomTwoConstant(this._angularVelocity.constantMin,this._angularVelocity.constantMax);break;case 3:e=this._angularVelocity.separateAxes?Bn.createByRandomTwoGradientSeparate(this._angularVelocity.gradientXMin.clone(),this._angularVelocity.gradientYMin.clone(),this._angularVelocity.gradientZMin.clone(),this._angularVelocity.gradientWMin.clone(),this._angularVelocity.gradientXMax.clone(),this._angularVelocity.gradientYMax.clone(),this._angularVelocity.gradientZMax.clone(),this._angularVelocity.gradientWMax.clone()):Bn.createByRandomTwoGradient(this._angularVelocity.gradientMin.clone(),this._angularVelocity.gradientMax.clone())}var t=new RotationOverLifetime(e);return t.enable=this.enable,t}},{key:"angularVelocity",get:function(){return this._angularVelocity}}]),RotationOverLifetime}();(Pn=e.ParticleSystemShapeType||(e.ParticleSystemShapeType={}))[Pn.Box=0]="Box",Pn[Pn.Circle=1]="Circle",Pn[Pn.Cone=2]="Cone",Pn[Pn.Hemisphere=3]="Hemisphere",Pn[Pn.Sphere=4]="Sphere";var zn=function(){function BaseShape(){_classCallCheck(this,BaseShape),this.enable=!0,this.randomDirection=0}return _createClass(BaseShape,[{key:"_getShapeBoundBox",value:function(e){throw new Error("BaseShape: must override it.")}},{key:"_getSpeedBoundBox",value:function(e){throw new Error("BaseShape: must override it.")}},{key:"generatePositionAndDirection",value:function(e,t){arguments.length>2&&void 0!==arguments[2]&&arguments[2],arguments.length>3&&void 0!==arguments[3]&&arguments[3];throw new Error("BaseShape: must override it.")}},{key:"_calculateProceduralBounds",value:function(e,t,n){this._getShapeBoundBox(e);var i=e.min,a=e.max;o.multiply(i,t,i),o.multiply(a,t,a);var r=new wt(new o,new o);this.randomDirection?(r.min=new o(-1,-1,-1),r.max=new o(1,1,1)):this._getSpeedBoundBox(r);var s=new wt(new o,new o),l=s.min,u=s.max;o.scale(r.min,n.y,l),o.scale(r.max,n.y,u),o.add(e.min,l,l),o.add(e.max,u,u),o.min(e.min,l,e.min),o.max(e.max,l,e.max);var c=new wt(new o,new o),h=c.min,_=c.max;o.scale(r.min,n.x,h),o.scale(r.max,n.x,_),o.min(c.min,_,l),o.max(c.min,_,u),o.min(e.min,l,e.min),o.max(e.max,l,e.max)}},{key:"cloneTo",value:function(e){e.enable=this.enable}},{key:"clone",value:function(){var e=new BaseShape;return this.cloneTo(e),e}}]),BaseShape}(),Wn=function(){function ShapeUtils(){_classCallCheck(this,ShapeUtils)}return _createClass(ShapeUtils,null,[{key:"_randomPointUnitArcCircle",value:function(e,t){var n,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;n=i?i.getFloat()*e:Math.random()*e,t.x=Math.cos(n),t.y=Math.sin(n)}},{key:"_randomPointInsideUnitArcCircle",value:function(e,t){var n,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;ShapeUtils._randomPointUnitArcCircle(e,t,i),n=i?Math.pow(i.getFloat(),.5):Math.pow(Math.random(),.5),t.x=t.x*n,t.y=t.y*n}},{key:"_randomPointUnitCircle",value:function(e){var t,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;t=n?n.getFloat()*Math.PI*2:Math.random()*Math.PI*2,e.x=Math.cos(t),e.y=Math.sin(t)}},{key:"_randomPointInsideUnitCircle",value:function(e){var t,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;ShapeUtils._randomPointUnitCircle(e),t=n?Math.pow(n.getFloat(),.5):Math.pow(Math.random(),.5),e.x=e.x*t,e.y=e.y*t}},{key:"_randomPointUnitSphere",value:function(e){var t,n,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;i?(t=e.z=2*i.getFloat()-1,n=i.getFloat()*Math.PI*2):(t=e.z=2*Math.random()-1,n=Math.random()*Math.PI*2);var a=Math.sqrt(1-t*t);e.x=a*Math.cos(n),e.y=a*Math.sin(n)}},{key:"_randomPointInsideUnitSphere",value:function(e){var t,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;ShapeUtils._randomPointUnitSphere(e),t=n?Math.pow(n.getFloat(),1/3):Math.pow(Math.random(),1/3),e.x=e.x*t,e.y=e.y*t,e.z=e.z*t}},{key:"_randomPointInsideHalfUnitBox",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;t?(e.x=t.getFloat()-.5,e.y=t.getFloat()-.5,e.z=t.getFloat()-.5):(e.x=Math.random()-.5,e.y=Math.random()-.5,e.z=Math.random()-.5)}}]),ShapeUtils}(),Xn=function(t){function BoxShape(){var t;return _classCallCheck(this,BoxShape),(t=_possibleConstructorReturn(this,_getPrototypeOf(BoxShape).call(this))).shapeType=e.ParticleSystemShapeType.Box,t.x=1,t.y=1,t.z=1,t}return _inherits(BoxShape,zn),_createClass(BoxShape,[{key:"_getShapeBoundBox",value:function(e){var t=e.min;t.x=.5*-this.x,t.y=.5*-this.y,t.z=.5*-this.z;var n=e.max;n.x=.5*this.x,n.y=.5*this.y,n.z=.5*this.z}},{key:"_getSpeedBoundBox",value:function(e){var t=e.min;t.x=0,t.y=0,t.z=0;var n=e.max;n.x=0,n.y=1,n.z=0}},{key:"generatePositionAndDirection",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;n?(n.seed=i[16],Wn._randomPointInsideHalfUnitBox(e,n),i[16]=n.seed):Wn._randomPointInsideHalfUnitBox(e),e.x=this.x*e.x,e.y=this.y*e.y,e.z=this.z*e.z,this.randomDirection?n?(n.seed=i[17],Wn._randomPointUnitSphere(t,n),i[17]=n.seed):Wn._randomPointUnitSphere(t):(t.x=0,t.y=0,t.z=1)}},{key:"cloneTo",value:function(e){_get(_getPrototypeOf(BoxShape.prototype),"cloneTo",this).call(this,e);var t=e;t.x=this.x,t.y=this.y,t.z=this.z,t.randomDirection=this.randomDirection}},{key:"clone",value:function(){var e=new BoxShape;return this.cloneTo(e),e}}]),BoxShape}(),Yn=function(t){function CircleShape(){var t;return _classCallCheck(this,CircleShape),(t=_possibleConstructorReturn(this,_getPrototypeOf(CircleShape).call(this))).shapeType=e.ParticleSystemShapeType.Circle,t.radius=1,t.arc=2*Math.PI,t.emitFromEdge=!1,t}return _inherits(CircleShape,zn),_createClass(CircleShape,[{key:"_getShapeBoundBox",value:function(e){var t=e.min;t.x=t.z=-this.radius,t.y=0;var n=e.max;n.x=n.z=this.radius,n.y=0}},{key:"_getSpeedBoundBox",value:function(e){var t=e.min;t.x=t.y=-1,t.z=0;var n=e.max;n.x=n.y=1,n.z=0}},{key:"generatePositionAndDirection",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,a=CircleShape._tempPositionPoint;n?(n.seed=i[16],this.emitFromEdge?Wn._randomPointUnitArcCircle(this.arc,CircleShape._tempPositionPoint,n):Wn._randomPointInsideUnitArcCircle(this.arc,CircleShape._tempPositionPoint,n),i[16]=n.seed):this.emitFromEdge?Wn._randomPointUnitArcCircle(this.arc,CircleShape._tempPositionPoint):Wn._randomPointInsideUnitArcCircle(this.arc,CircleShape._tempPositionPoint),e.x=-a.x,e.y=a.y,e.z=0,o.scale(e,this.radius,e),this.randomDirection?n?(n.seed=i[17],Wn._randomPointUnitSphere(t,n),i[17]=n.seed):Wn._randomPointUnitSphere(t):e.cloneTo(t)}},{key:"cloneTo",value:function(e){_get(_getPrototypeOf(CircleShape.prototype),"cloneTo",this).call(this,e);var t=e;t.radius=this.radius,t.arc=this.arc,t.emitFromEdge=this.emitFromEdge,t.randomDirection=this.randomDirection}},{key:"clone",value:function(){var e=new CircleShape;return this.cloneTo(e),e}}]),CircleShape}();Yn._tempPositionPoint=new i;var jn=function(t){function ConeShape(){var t;return _classCallCheck(this,ConeShape),(t=_possibleConstructorReturn(this,_getPrototypeOf(ConeShape).call(this))).shapeType=e.ParticleSystemShapeType.Cone,t.angle=25/180*Math.PI,t.radius=1,t.length=5,t.emitType=0,t}return _inherits(ConeShape,zn),_createClass(ConeShape,[{key:"_getShapeBoundBox",value:function(e){var t=this.radius+this.length*Math.sin(this.angle),n=this.length*Math.cos(this.angle),i=e.min;i.x=i.y=-t,i.z=0;var a=e.max;a.x=a.y=t,a.z=n}},{key:"_getSpeedBoundBox",value:function(e){var t=Math.sin(this.angle),n=e.min;n.x=n.y=-t,n.z=0;var i=e.max;i.x=i.y=t,i.z=1}},{key:"generatePositionAndDirection",value:function(e,t){var n,i,a,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,l=ConeShape._tempPositionPoint,u=Math.cos(this.angle),c=Math.sin(this.angle);switch(this.emitType){case 0:r?(r.seed=s[16],Wn._randomPointInsideUnitCircle(ConeShape._tempPositionPoint,r),s[16]=r.seed):Wn._randomPointInsideUnitCircle(ConeShape._tempPositionPoint),n=l.x,i=l.y,e.x=n*this.radius,e.y=i*this.radius,e.z=0,this.randomDirection?(r?(r.seed=s[17],Wn._randomPointInsideUnitCircle(ConeShape._tempDirectionPoint,r),s[17]=r.seed):Wn._randomPointInsideUnitCircle(ConeShape._tempDirectionPoint),a=ConeShape._tempDirectionPoint,t.x=a.x*c,t.y=a.y*c):(t.x=n*c,t.y=i*c),t.z=u;break;case 1:r?(r.seed=s[16],Wn._randomPointUnitCircle(ConeShape._tempPositionPoint,r),s[16]=r.seed):Wn._randomPointUnitCircle(ConeShape._tempPositionPoint),n=l.x,i=l.y,e.x=n*this.radius,e.y=i*this.radius,e.z=0,this.randomDirection?(r?(r.seed=s[17],Wn._randomPointInsideUnitCircle(ConeShape._tempDirectionPoint,r),s[17]=r.seed):Wn._randomPointInsideUnitCircle(ConeShape._tempDirectionPoint),a=ConeShape._tempDirectionPoint,t.x=a.x*c,t.y=a.y*c):(t.x=n*c,t.y=i*c),t.z=u;break;case 2:r?(r.seed=s[16],Wn._randomPointInsideUnitCircle(ConeShape._tempPositionPoint,r)):Wn._randomPointInsideUnitCircle(ConeShape._tempPositionPoint),n=l.x,i=l.y,e.x=n*this.radius,e.y=i*this.radius,e.z=0,t.x=n*c,t.y=i*c,t.z=u,o.normalize(t,t),r?(o.scale(t,this.length*r.getFloat(),t),s[16]=r.seed):o.scale(t,this.length*Math.random(),t),o.add(e,t,e),this.randomDirection&&(r?(r.seed=s[17],Wn._randomPointUnitSphere(t,r),s[17]=r.seed):Wn._randomPointUnitSphere(t));break;case 3:r?(r.seed=s[16],Wn._randomPointUnitCircle(ConeShape._tempPositionPoint,r)):Wn._randomPointUnitCircle(ConeShape._tempPositionPoint),n=l.x,i=l.y,e.x=n*this.radius,e.y=i*this.radius,e.z=0,t.x=n*c,t.y=i*c,t.z=u,o.normalize(t,t),r?(o.scale(t,this.length*r.getFloat(),t),s[16]=r.seed):o.scale(t,this.length*Math.random(),t),o.add(e,t,e),this.randomDirection&&(r?(r.seed=s[17],Wn._randomPointUnitSphere(t,r),s[17]=r.seed):Wn._randomPointUnitSphere(t));break;default:throw new Error("ConeShape:emitType is invalid.")}}},{key:"cloneTo",value:function(e){_get(_getPrototypeOf(ConeShape.prototype),"cloneTo",this).call(this,e);var t=e;t.angle=this.angle,t.radius=this.radius,t.length=this.length,t.emitType=this.emitType,t.randomDirection=this.randomDirection}},{key:"clone",value:function(){var e=new ConeShape;return this.cloneTo(e),e}}]),ConeShape}();jn._tempPositionPoint=new i,jn._tempDirectionPoint=new i;var Zn=function(t){function HemisphereShape(){var t;return _classCallCheck(this,HemisphereShape),(t=_possibleConstructorReturn(this,_getPrototypeOf(HemisphereShape).call(this))).shapeType=e.ParticleSystemShapeType.Hemisphere,t.radius=1,t.emitFromShell=!1,t}return _inherits(HemisphereShape,zn),_createClass(HemisphereShape,[{key:"_getShapeBoundBox",value:function(e){var t=e.min;t.x=t.y=t.z=-this.radius;var n=e.max;n.x=n.y=this.radius,n.z=0}},{key:"_getSpeedBoundBox",value:function(e){var t=e.min;t.x=t.y=-1,t.z=0;var n=e.max;n.x=n.y=n.z=1}},{key:"generatePositionAndDirection",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;n?(n.seed=i[16],this.emitFromShell?Wn._randomPointUnitSphere(e,n):Wn._randomPointInsideUnitSphere(e,n),i[16]=n.seed):this.emitFromShell?Wn._randomPointUnitSphere(e):Wn._randomPointInsideUnitSphere(e),o.scale(e,this.radius,e);var a=e.z;a<0&&(e.z=-1*a),this.randomDirection?n?(n.seed=i[17],Wn._randomPointUnitSphere(t,n),i[17]=n.seed):Wn._randomPointUnitSphere(t):e.cloneTo(t)}},{key:"cloneTo",value:function(e){_get(_getPrototypeOf(HemisphereShape.prototype),"cloneTo",this).call(this,e);var t=e;t.radius=this.radius,t.emitFromShell=this.emitFromShell,t.randomDirection=this.randomDirection}},{key:"clone",value:function(){var e=new HemisphereShape;return this.cloneTo(e),e}}]),HemisphereShape}(),Qn=function(t){function SphereShape(){var t;return _classCallCheck(this,SphereShape),(t=_possibleConstructorReturn(this,_getPrototypeOf(SphereShape).call(this))).shapeType=e.ParticleSystemShapeType.Sphere,t.radius=1,t.emitFromShell=!1,t}return _inherits(SphereShape,zn),_createClass(SphereShape,[{key:"_getShapeBoundBox",value:function(e){var t=e.min;t.x=t.y=t.z=-this.radius;var n=e.max;n.x=n.y=n.z=this.radius}},{key:"_getSpeedBoundBox",value:function(e){var t=e.min;t.x=t.y=t.z=-1;var n=e.max;n.x=n.y=n.z=1}},{key:"generatePositionAndDirection",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;n?(n.seed=i[16],this.emitFromShell?Wn._randomPointUnitSphere(e,n):Wn._randomPointInsideUnitSphere(e,n),i[16]=n.seed):this.emitFromShell?Wn._randomPointUnitSphere(e):Wn._randomPointInsideUnitSphere(e),o.scale(e,this.radius,e),this.randomDirection?n?(n.seed=i[17],Wn._randomPointUnitSphere(t,n),i[17]=n.seed):Wn._randomPointUnitSphere(t):e.cloneTo(t)}},{key:"cloneTo",value:function(e){_get(_getPrototypeOf(SphereShape.prototype),"cloneTo",this).call(this,e);var t=e;t.radius=this.radius,t.emitFromShell=this.emitFromShell,t.randomDirection=this.randomDirection}},{key:"clone",value:function(){var e=new SphereShape;return this.cloneTo(e),e}}]),SphereShape}(),qn=function(){function SizeOverLifetime(e){_classCallCheck(this,SizeOverLifetime),this._size=e}return _createClass(SizeOverLifetime,[{key:"cloneTo",value:function(e){var t=e;this._size.cloneTo(t._size),t.enable=this.enable}},{key:"clone",value:function(){var e;switch(this._size.type){case 0:e=this._size.separateAxes?Un.createByGradientSeparate(this._size.gradientX.clone(),this._size.gradientY.clone(),this._size.gradientZ.clone()):Un.createByGradient(this._size.gradient.clone());break;case 1:e=this._size.separateAxes?Un.createByRandomTwoConstantSeparate(this._size.constantMinSeparate.clone(),this._size.constantMaxSeparate.clone()):Un.createByRandomTwoConstant(this._size.constantMin,this._size.constantMax);break;case 2:e=this._size.separateAxes?Un.createByRandomTwoGradientSeparate(this._size.gradientXMin.clone(),this._size.gradientYMin.clone(),this._size.gradientZMin.clone(),this._size.gradientXMax.clone(),this._size.gradientYMax.clone(),this._size.gradientZMax.clone()):Un.createByRandomTwoGradient(this._size.gradientMin.clone(),this._size.gradientMax.clone())}var t=new SizeOverLifetime(e);return t.enable=this.enable,t}},{key:"size",get:function(){return this._size}}]),SizeOverLifetime}(),Kn=function(){function StartFrame(){_classCallCheck(this,StartFrame),this._type=0,this._constant=0,this._constantMin=0,this._constantMax=0}return _createClass(StartFrame,[{key:"cloneTo",value:function(e){var t=e;t._type=this._type,t._constant=this._constant,t._constantMin=this._constantMin,t._constantMax=this._constantMax}},{key:"clone",value:function(){var e=new StartFrame;return this.cloneTo(e),e}},{key:"type",get:function(){return this._type}},{key:"constant",get:function(){return this._constant}},{key:"constantMin",get:function(){return this._constantMin}},{key:"constantMax",get:function(){return this._constantMax}}],[{key:"createByConstant",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=new StartFrame;return t._type=0,t._constant=e,t}},{key:"createByRandomTwoConstant",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=new StartFrame;return n._type=1,n._constantMin=e,n._constantMax=t,n}}]),StartFrame}(),Jn=function(){function TextureSheetAnimation(e,t){_classCallCheck(this,TextureSheetAnimation),this.type=0,this.randomRow=!1,this.rowIndex=0,this.cycles=0,this.enableUVChannels=0,this.enable=!1,this.tiles=new i(1,1),this.type=0,this.randomRow=!0,this.rowIndex=0,this.cycles=1,this.enableUVChannels=1,this._frame=e,this._startFrame=t}return _createClass(TextureSheetAnimation,[{key:"cloneTo",value:function(e){var t=e;this.tiles.cloneTo(t.tiles),t.type=this.type,t.randomRow=this.randomRow,t.rowIndex=this.rowIndex,t.cycles=this.cycles,t.enableUVChannels=this.enableUVChannels,t.enable=this.enable,this._frame.cloneTo(t._frame),this._startFrame.cloneTo(t._startFrame)}},{key:"clone",value:function(){var e,t;switch(this._frame.type){case 0:e=wn.createByConstant(this._frame.constant);break;case 1:e=wn.createByOverTime(this._frame.frameOverTimeData.clone());break;case 2:e=wn.createByRandomTwoConstant(this._frame.constantMin,this._frame.constantMax);break;case 3:e=wn.createByRandomTwoOverTime(this._frame.frameOverTimeDataMin.clone(),this._frame.frameOverTimeDataMax.clone())}switch(this._startFrame.type){case 0:t=Kn.createByConstant(this._startFrame.constant);break;case 1:t=Kn.createByRandomTwoConstant(this._startFrame.constantMin,this._startFrame.constantMax)}var n=new TextureSheetAnimation(e,t);return this.cloneTo(n),n}},{key:"frame",get:function(){return this._frame}},{key:"startFrame",get:function(){return this._startFrame}}]),TextureSheetAnimation}(),$n=function(){function VelocityOverLifetime(e){_classCallCheck(this,VelocityOverLifetime),this.enable=!1,this.space=0,this._velocity=e}return _createClass(VelocityOverLifetime,[{key:"cloneTo",value:function(e){var t=e;this._velocity.cloneTo(t._velocity),t.enable=this.enable,t.space=this.space}},{key:"clone",value:function(){var e;switch(this._velocity.type){case 0:e=Gn.createByConstant(this._velocity.constant.clone());break;case 1:e=Gn.createByGradient(this._velocity.gradientX.clone(),this._velocity.gradientY.clone(),this._velocity.gradientZ.clone());break;case 2:e=Gn.createByRandomTwoConstant(this._velocity.constantMin.clone(),this._velocity.constantMax.clone());break;case 3:e=Gn.createByRandomTwoGradient(this._velocity.gradientXMin.clone(),this._velocity.gradientXMax.clone(),this._velocity.gradientYMin.clone(),this._velocity.gradientYMax.clone(),this._velocity.gradientZMin.clone(),this._velocity.gradientZMax.clone())}var t=new VelocityOverLifetime(e);return t.enable=this.enable,t.space=this.space,t}},{key:"velocity",get:function(){return this._velocity}}]),VelocityOverLifetime}(),ei=function ShuriKenParticle3DShaderDeclaration(){_classCallCheck(this,ShuriKenParticle3DShaderDeclaration)};ei.WORLDPOSITION=_e.propertyNameToID("u_WorldPosition"),ei.WORLDROTATION=_e.propertyNameToID("u_WorldRotation"),ei.POSITIONSCALE=_e.propertyNameToID("u_PositionScale"),ei.SIZESCALE=_e.propertyNameToID("u_SizeScale"),ei.SCALINGMODE=_e.propertyNameToID("u_ScalingMode"),ei.GRAVITY=_e.propertyNameToID("u_Gravity"),ei.THREEDSTARTROTATION=_e.propertyNameToID("u_ThreeDStartRotation"),ei.STRETCHEDBILLBOARDLENGTHSCALE=_e.propertyNameToID("u_StretchedBillboardLengthScale"),ei.STRETCHEDBILLBOARDSPEEDSCALE=_e.propertyNameToID("u_StretchedBillboardSpeedScale"),ei.SIMULATIONSPACE=_e.propertyNameToID("u_SimulationSpace"),ei.CURRENTTIME=_e.propertyNameToID("u_CurrentTime"),ei.VOLVELOCITYCONST=_e.propertyNameToID("u_VOLVelocityConst"),ei.VOLVELOCITYGRADIENTX=_e.propertyNameToID("u_VOLVelocityGradientX"),ei.VOLVELOCITYGRADIENTY=_e.propertyNameToID("u_VOLVelocityGradientY"),ei.VOLVELOCITYGRADIENTZ=_e.propertyNameToID("u_VOLVelocityGradientZ"),ei.VOLVELOCITYCONSTMAX=_e.propertyNameToID("u_VOLVelocityConstMax"),ei.VOLVELOCITYGRADIENTXMAX=_e.propertyNameToID("u_VOLVelocityGradientMaxX"),ei.VOLVELOCITYGRADIENTYMAX=_e.propertyNameToID("u_VOLVelocityGradientMaxY"),ei.VOLVELOCITYGRADIENTZMAX=_e.propertyNameToID("u_VOLVelocityGradientMaxZ"),ei.VOLSPACETYPE=_e.propertyNameToID("u_VOLSpaceType"),ei.COLOROVERLIFEGRADIENTALPHAS=_e.propertyNameToID("u_ColorOverLifeGradientAlphas"),ei.COLOROVERLIFEGRADIENTCOLORS=_e.propertyNameToID("u_ColorOverLifeGradientColors"),ei.MAXCOLOROVERLIFEGRADIENTALPHAS=_e.propertyNameToID("u_MaxColorOverLifeGradientAlphas"),ei.MAXCOLOROVERLIFEGRADIENTCOLORS=_e.propertyNameToID("u_MaxColorOverLifeGradientColors"),ei.SOLSIZEGRADIENT=_e.propertyNameToID("u_SOLSizeGradient"),ei.SOLSIZEGRADIENTX=_e.propertyNameToID("u_SOLSizeGradientX"),ei.SOLSIZEGRADIENTY=_e.propertyNameToID("u_SOLSizeGradientY"),ei.SOLSizeGradientZ=_e.propertyNameToID("u_SOLSizeGradientZ"),ei.SOLSizeGradientMax=_e.propertyNameToID("u_SOLSizeGradientMax"),ei.SOLSIZEGRADIENTXMAX=_e.propertyNameToID("u_SOLSizeGradientMaxX"),ei.SOLSIZEGRADIENTYMAX=_e.propertyNameToID("u_SOLSizeGradientMaxY"),ei.SOLSizeGradientZMAX=_e.propertyNameToID("u_SOLSizeGradientMaxZ"),ei.ROLANGULARVELOCITYCONST=_e.propertyNameToID("u_ROLAngularVelocityConst"),ei.ROLANGULARVELOCITYCONSTSEPRARATE=_e.propertyNameToID("u_ROLAngularVelocityConstSeprarate"),ei.ROLANGULARVELOCITYGRADIENT=_e.propertyNameToID("u_ROLAngularVelocityGradient"),ei.ROLANGULARVELOCITYGRADIENTX=_e.propertyNameToID("u_ROLAngularVelocityGradientX"),ei.ROLANGULARVELOCITYGRADIENTY=_e.propertyNameToID("u_ROLAngularVelocityGradientY"),ei.ROLANGULARVELOCITYGRADIENTZ=_e.propertyNameToID("u_ROLAngularVelocityGradientZ"),ei.ROLANGULARVELOCITYCONSTMAX=_e.propertyNameToID("u_ROLAngularVelocityConstMax"),ei.ROLANGULARVELOCITYCONSTMAXSEPRARATE=_e.propertyNameToID("u_ROLAngularVelocityConstMaxSeprarate"),ei.ROLANGULARVELOCITYGRADIENTMAX=_e.propertyNameToID("u_ROLAngularVelocityGradientMax"),ei.ROLANGULARVELOCITYGRADIENTXMAX=_e.propertyNameToID("u_ROLAngularVelocityGradientMaxX"),ei.ROLANGULARVELOCITYGRADIENTYMAX=_e.propertyNameToID("u_ROLAngularVelocityGradientMaxY"),ei.ROLANGULARVELOCITYGRADIENTZMAX=_e.propertyNameToID("u_ROLAngularVelocityGradientMaxZ"),ei.ROLANGULARVELOCITYGRADIENTWMAX=_e.propertyNameToID("u_ROLAngularVelocityGradientMaxW"),ei.TEXTURESHEETANIMATIONCYCLES=_e.propertyNameToID("u_TSACycles"),ei.TEXTURESHEETANIMATIONSUBUVLENGTH=_e.propertyNameToID("u_TSASubUVLength"),ei.TEXTURESHEETANIMATIONGRADIENTUVS=_e.propertyNameToID("u_TSAGradientUVs"),ei.TEXTURESHEETANIMATIONGRADIENTMAXUVS=_e.propertyNameToID("u_TSAMaxGradientUVs");var ti=function(e){function ShurikenParticleMaterial(){var e;return _classCallCheck(this,ShurikenParticleMaterial),(e=_possibleConstructorReturn(this,_getPrototypeOf(ShurikenParticleMaterial).call(this))).setShaderName("PARTICLESHURIKEN"),e._color=new a(1,1,1,1),e._shaderValues.setVector(ShurikenParticleMaterial.TILINGOFFSET,new a(1,1,0,0)),e.renderMode=ShurikenParticleMaterial.RENDERMODE_ALPHABLENDED,e}return _inherits(ShurikenParticleMaterial,st),_createClass(ShurikenParticleMaterial,[{key:"clone",value:function(){var e=new ShurikenParticleMaterial;return this.cloneTo(e),e}},{key:"_TintColor",get:function(){return this.color},set:function(e){this.color=e}},{key:"_TintColorR",get:function(){return this._color.x},set:function(e){this._color.x=e,this.color=this._color}},{key:"_TintColorG",get:function(){return this._color.y},set:function(e){this._color.y=e,this.color=this._color}},{key:"_TintColorB",get:function(){return this._color.z},set:function(e){this._color.z=e,this.color=this._color}},{key:"_TintColorA",get:function(){return this._color.w},set:function(e){this._color.w=e,this.color=this._color}},{key:"_MainTex_ST",get:function(){return this._shaderValues.getVector(ShurikenParticleMaterial.TILINGOFFSET)},set:function(e){var t=this._shaderValues.getVector(ShurikenParticleMaterial.TILINGOFFSET);t.setValue(e.x,e.y,e.z,e.w),this.tilingOffset=t}},{key:"_MainTex_STX",get:function(){return this._shaderValues.getVector(ShurikenParticleMaterial.TILINGOFFSET).x},set:function(e){var t=this._shaderValues.getVector(ShurikenParticleMaterial.TILINGOFFSET);t.x=e,this.tilingOffset=t}},{key:"_MainTex_STY",get:function(){return this._shaderValues.getVector(ShurikenParticleMaterial.TILINGOFFSET).y},set:function(e){var t=this._shaderValues.getVector(ShurikenParticleMaterial.TILINGOFFSET);t.y=e,this.tilingOffset=t}},{key:"_MainTex_STZ",get:function(){return this._shaderValues.getVector(ShurikenParticleMaterial.TILINGOFFSET).z},set:function(e){var t=this._shaderValues.getVector(ShurikenParticleMaterial.TILINGOFFSET);t.z=e,this.tilingOffset=t}},{key:"_MainTex_STW",get:function(){return this._shaderValues.getVector(ShurikenParticleMaterial.TILINGOFFSET).w},set:function(e){var t=this._shaderValues.getVector(ShurikenParticleMaterial.TILINGOFFSET);t.w=e,this.tilingOffset=t}},{key:"renderMode",set:function(e){switch(e){case ShurikenParticleMaterial.RENDERMODE_ADDTIVE:this.renderQueue=st.RENDERQUEUE_TRANSPARENT,this.depthWrite=!1,this.cull=ut.CULL_NONE,this.blend=ut.BLEND_ENABLE_ALL,this.blendSrc=ut.BLENDPARAM_SRC_ALPHA,this.blendDst=ut.BLENDPARAM_ONE,this.alphaTest=!1,this._shaderValues.addDefine(ShurikenParticleMaterial.SHADERDEFINE_ADDTIVEFOG);break;case ShurikenParticleMaterial.RENDERMODE_ALPHABLENDED:this.renderQueue=st.RENDERQUEUE_TRANSPARENT,this.depthWrite=!1,this.cull=ut.CULL_NONE,this.blend=ut.BLEND_ENABLE_ALL,this.blendSrc=ut.BLENDPARAM_SRC_ALPHA,this.blendDst=ut.BLENDPARAM_ONE_MINUS_SRC_ALPHA,this.alphaTest=!1,this._shaderValues.removeDefine(ShurikenParticleMaterial.SHADERDEFINE_ADDTIVEFOG);break;default:throw new Error("ShurikenParticleMaterial : renderMode value error.")}}},{key:"colorR",get:function(){return this._TintColorR},set:function(e){this._TintColorR=e}},{key:"colorG",get:function(){return this._TintColorG},set:function(e){this._TintColorG=e}},{key:"colorB",get:function(){return this._TintColorB},set:function(e){this._TintColorB=e}},{key:"colorA",get:function(){return this._TintColorA},set:function(e){this._TintColorA=e}},{key:"color",get:function(){return this._shaderValues.getVector(ShurikenParticleMaterial.TINTCOLOR)},set:function(e){e?this._shaderValues.addDefine(ShurikenParticleMaterial.SHADERDEFINE_TINTCOLOR):this._shaderValues.removeDefine(ShurikenParticleMaterial.SHADERDEFINE_TINTCOLOR),this._shaderValues.setVector(ShurikenParticleMaterial.TINTCOLOR,e)}},{key:"tilingOffsetX",get:function(){return this._MainTex_STX},set:function(e){this._MainTex_STX=e}},{key:"tilingOffsetY",get:function(){return this._MainTex_STY},set:function(e){this._MainTex_STY=e}},{key:"tilingOffsetZ",get:function(){return this._MainTex_STZ},set:function(e){this._MainTex_STZ=e}},{key:"tilingOffsetW",get:function(){return this._MainTex_STW},set:function(e){this._MainTex_STW=e}},{key:"tilingOffset",get:function(){return this._shaderValues.getVector(ShurikenParticleMaterial.TILINGOFFSET)},set:function(e){e?this._shaderValues.setVector(ShurikenParticleMaterial.TILINGOFFSET,e):this._shaderValues.getVector(ShurikenParticleMaterial.TILINGOFFSET).setValue(1,1,0,0)}},{key:"texture",get:function(){return this._shaderValues.getTexture(ShurikenParticleMaterial.DIFFUSETEXTURE)},set:function(e){e?this._shaderValues.addDefine(ShurikenParticleMaterial.SHADERDEFINE_DIFFUSEMAP):this._shaderValues.removeDefine(ShurikenParticleMaterial.SHADERDEFINE_DIFFUSEMAP),this._shaderValues.setTexture(ShurikenParticleMaterial.DIFFUSETEXTURE,e)}}],[{key:"__initDefine__",value:function(){ShurikenParticleMaterial.SHADERDEFINE_DIFFUSEMAP=_e.getDefineByName("DIFFUSEMAP"),ShurikenParticleMaterial.SHADERDEFINE_TINTCOLOR=_e.getDefineByName("TINTCOLOR"),ShurikenParticleMaterial.SHADERDEFINE_ADDTIVEFOG=_e.getDefineByName("ADDTIVEFOG")}}]),ShurikenParticleMaterial}();ti.RENDERMODE_ALPHABLENDED=0,ti.RENDERMODE_ADDTIVE=1,ti.DIFFUSETEXTURE=_e.propertyNameToID("u_texture"),ti.TINTCOLOR=_e.propertyNameToID("u_Tintcolor"),ti.TILINGOFFSET=_e.propertyNameToID("u_TilingOffset");var ni=function(e){function ShurikenParticleRenderer(e){var t;return _classCallCheck(this,ShurikenParticleRenderer),(t=_possibleConstructorReturn(this,_getPrototypeOf(ShurikenParticleRenderer).call(this,e)))._finalGravity=new o,t._mesh=null,t.stretchedBillboardCameraSpeedScale=0,t.stretchedBillboardSpeedScale=0,t.stretchedBillboardLengthScale=2,t.renderMode=0,t._supportOctree=!1,t}return _inherits(ShurikenParticleRenderer,qt),_createClass(ShurikenParticleRenderer,[{key:"_calculateBoundingBox",value:function(){var e=this._owner.particleSystem;if(e._useCustomBounds)e.customBounds._tranform(this._owner.transform.worldMatrix,this._bounds);else if(e._simulationSupported()){if(e._generateBounds(),e._bounds._tranform(this._owner.transform.worldMatrix,this._bounds),0!=e.gravityModifier){var t=this._bounds.getMax(),n=this._bounds.getMin(),i=e._gravityOffset;t.y-=i.x,n.y-=i.y,this._bounds.setMax(t),this._bounds.setMin(n)}}else{(n=this._bounds.getMin()).setValue(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),this._bounds.setMin(n),(t=this._bounds.getMax()).setValue(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._bounds.setMax(t)}}},{key:"_needRender",value:function(e,t){return!e||!!e.intersects(this.bounds._getBoundBox())&&!!this._owner.particleSystem.isAlive}},{key:"_renderUpdate",value:function(e,t){var n=this._owner.particleSystem,i=this._shaderValues,a=this._owner.transform;switch(n.simulationSpace){case 0:break;case 1:i.setVector3(ei.WORLDPOSITION,a.position),i.setQuaternion(ei.WORLDROTATION,a.rotation);break;default:throw new Error("ShurikenParticleMaterial: SimulationSpace value is invalid.")}switch(n.scaleMode){case 0:var r=a.getWorldLossyScale();i.setVector3(ei.POSITIONSCALE,r),i.setVector3(ei.SIZESCALE,r);break;case 1:var s=a.localScale;i.setVector3(ei.POSITIONSCALE,s),i.setVector3(ei.SIZESCALE,s);break;case 2:i.setVector3(ei.POSITIONSCALE,a.getWorldLossyScale()),i.setVector3(ei.SIZESCALE,o._ONE)}o.scale(m.gravity,n.gravityModifier,this._finalGravity),i.setVector3(ei.GRAVITY,this._finalGravity),i.setInt(ei.SIMULATIONSPACE,n.simulationSpace),i.setBool(ei.THREEDSTARTROTATION,n.threeDStartRotation),i.setInt(ei.SCALINGMODE,n.scaleMode),i.setNumber(ei.STRETCHEDBILLBOARDLENGTHSCALE,this.stretchedBillboardLengthScale),i.setNumber(ei.STRETCHEDBILLBOARDSPEEDSCALE,this.stretchedBillboardSpeedScale),i.setNumber(ei.CURRENTTIME,n._currentTime)}},{key:"_destroy",value:function(){_get(_getPrototypeOf(ShurikenParticleRenderer.prototype),"_destroy",this).call(this),this._mesh&&(this._mesh._removeReference(),this._mesh=null)}},{key:"renderMode",get:function(){return this._renderMode},set:function(e){if(this._renderMode!==e){var t=this._shaderValues;switch(this._renderMode){case 0:t.removeDefine(ei.SHADERDEFINE_RENDERMODE_BILLBOARD);break;case 1:t.removeDefine(ei.SHADERDEFINE_RENDERMODE_STRETCHEDBILLBOARD);break;case 2:t.removeDefine(ei.SHADERDEFINE_RENDERMODE_HORIZONTALBILLBOARD);break;case 3:t.removeDefine(ei.SHADERDEFINE_RENDERMODE_VERTICALBILLBOARD);break;case 4:t.removeDefine(ei.SHADERDEFINE_RENDERMODE_MESH)}switch(this._renderMode=e,e){case 0:t.addDefine(ei.SHADERDEFINE_RENDERMODE_BILLBOARD);break;case 1:t.addDefine(ei.SHADERDEFINE_RENDERMODE_STRETCHEDBILLBOARD);break;case 2:t.addDefine(ei.SHADERDEFINE_RENDERMODE_HORIZONTALBILLBOARD);break;case 3:t.addDefine(ei.SHADERDEFINE_RENDERMODE_VERTICALBILLBOARD);break;case 4:t.addDefine(ei.SHADERDEFINE_RENDERMODE_MESH);break;default:throw new Error("ShurikenParticleRender: unknown renderMode Value.")}var n=this._owner.particleSystem;n&&n._initBufferDatas()}}},{key:"mesh",get:function(){return this._mesh},set:function(e){this._mesh!==e&&(this._mesh&&this._mesh._removeReference(),this._mesh=e,e&&e._addReference(),this._owner.particleSystem._initBufferDatas())}},{key:"bounds",get:function(){return this._boundsChange&&(this._calculateBoundingBox(),this._boundsChange=!1),this._bounds}}]),ShurikenParticleRenderer}(),ii=function VertexShuriKenParticle(){_classCallCheck(this,VertexShuriKenParticle)};ii.PARTICLE_CORNERTEXTURECOORDINATE0=5,ii.PARTICLE_POSITION0=1,ii.PARTICLE_COLOR0=2,ii.PARTICLE_TEXTURECOORDINATE0=3,ii.PARTICLE_SHAPEPOSITIONSTARTLIFETIME=4,ii.PARTICLE_DIRECTIONTIME=0,ii.PARTICLE_STARTCOLOR0=6,ii.PARTICLE_ENDCOLOR0=7,ii.PARTICLE_STARTSIZE=8,ii.PARTICLE_STARTROTATION=9,ii.PARTICLE_STARTSPEED=10,ii.PARTICLE_RANDOM0=11,ii.PARTICLE_RANDOM1=12,ii.PARTICLE_SIMULATIONWORLDPOSTION=13,ii.PARTICLE_SIMULATIONWORLDROTATION=14;var ai=function(e){function VertexShurikenParticleBillboard(e,t,n,i,a,r,o,s,l,u,c,h,_,d){var f;return _classCallCheck(this,VertexShurikenParticleBillboard),(f=_possibleConstructorReturn(this,_getPrototypeOf(VertexShurikenParticleBillboard).call(this)))._cornerTextureCoordinate=e,f._positionStartLifeTime=t,f._velocity=n,f._startColor=i,f._startSize=a,f._startRotation0=r,f._startRotation1=o,f._startRotation2=s,f._startLifeTime=l,f._time=u,f._startSpeed=c,f._randoms0=h,f._randoms1=_,f._simulationWorldPostion=d,f}return _inherits(VertexShurikenParticleBillboard,ii),_createClass(VertexShurikenParticleBillboard,[{key:"cornerTextureCoordinate",get:function(){return this._cornerTextureCoordinate}},{key:"positionStartLifeTime",get:function(){return this._positionStartLifeTime}},{key:"velocity",get:function(){return this._velocity}},{key:"startColor",get:function(){return this._startColor}},{key:"startSize",get:function(){return this._startSize}},{key:"startRotation0",get:function(){return this._startRotation0}},{key:"startRotation1",get:function(){return this._startRotation1}},{key:"startRotation2",get:function(){return this._startRotation2}},{key:"startLifeTime",get:function(){return this._startLifeTime}},{key:"time",get:function(){return this._time}},{key:"startSpeed",get:function(){return this._startSpeed}},{key:"random0",get:function(){return this._randoms0}},{key:"random1",get:function(){return this._randoms1}},{key:"simulationWorldPostion",get:function(){return this._simulationWorldPostion}}],[{key:"__init__",value:function(){VertexShurikenParticleBillboard._vertexDeclaration=new ae(152,[new re(0,ne.Vector4,ii.PARTICLE_CORNERTEXTURECOORDINATE0),new re(16,ne.Vector4,ii.PARTICLE_SHAPEPOSITIONSTARTLIFETIME),new re(32,ne.Vector4,ii.PARTICLE_DIRECTIONTIME),new re(48,ne.Vector4,ii.PARTICLE_STARTCOLOR0),new re(64,ne.Vector3,ii.PARTICLE_STARTSIZE),new re(76,ne.Vector3,ii.PARTICLE_STARTROTATION),new re(88,ne.Single,ii.PARTICLE_STARTSPEED),new re(92,ne.Vector4,ii.PARTICLE_RANDOM0),new re(108,ne.Vector4,ii.PARTICLE_RANDOM1),new re(124,ne.Vector3,ii.PARTICLE_SIMULATIONWORLDPOSTION),new re(136,ne.Vector4,ii.PARTICLE_SIMULATIONWORLDROTATION)])}},{key:"vertexDeclaration",get:function(){return VertexShurikenParticleBillboard._vertexDeclaration}}]),VertexShurikenParticleBillboard}(),ri=function(e){function VertexShurikenParticleMesh(e,t,n,i,a,r,o,s,l,u,c,h,_,d){var f;return _classCallCheck(this,VertexShurikenParticleMesh),(f=_possibleConstructorReturn(this,_getPrototypeOf(VertexShurikenParticleMesh).call(this)))._cornerTextureCoordinate=e,f._positionStartLifeTime=t,f._velocity=n,f._startColor=i,f._startSize=a,f._startRotation0=r,f._startRotation1=o,f._startRotation2=s,f._startLifeTime=l,f._time=u,f._startSpeed=c,f._randoms0=h,f._randoms1=_,f._simulationWorldPostion=d,f}return _inherits(VertexShurikenParticleMesh,ii),_createClass(VertexShurikenParticleMesh,[{key:"cornerTextureCoordinate",get:function(){return this._cornerTextureCoordinate}},{key:"position",get:function(){return this._positionStartLifeTime}},{key:"velocity",get:function(){return this._velocity}},{key:"startColor",get:function(){return this._startColor}},{key:"startSize",get:function(){return this._startSize}},{key:"startRotation0",get:function(){return this._startRotation0}},{key:"startRotation1",get:function(){return this._startRotation1}},{key:"startRotation2",get:function(){return this._startRotation2}},{key:"startLifeTime",get:function(){return this._startLifeTime}},{key:"time",get:function(){return this._time}},{key:"startSpeed",get:function(){return this._startSpeed}},{key:"random0",get:function(){return this._randoms0}},{key:"random1",get:function(){return this._randoms1}},{key:"simulationWorldPostion",get:function(){return this._simulationWorldPostion}}],[{key:"__init__",value:function(){VertexShurikenParticleMesh._vertexDeclaration=new ae(172,[new re(0,ne.Vector3,ii.PARTICLE_POSITION0),new re(12,ne.Vector4,ii.PARTICLE_COLOR0),new re(28,ne.Vector2,ii.PARTICLE_TEXTURECOORDINATE0),new re(36,ne.Vector4,ii.PARTICLE_SHAPEPOSITIONSTARTLIFETIME),new re(52,ne.Vector4,ii.PARTICLE_DIRECTIONTIME),new re(68,ne.Vector4,ii.PARTICLE_STARTCOLOR0),new re(84,ne.Vector3,ii.PARTICLE_STARTSIZE),new re(96,ne.Vector3,ii.PARTICLE_STARTROTATION),new re(108,ne.Single,ii.PARTICLE_STARTSPEED),new re(112,ne.Vector4,ii.PARTICLE_RANDOM0),new re(128,ne.Vector4,ii.PARTICLE_RANDOM1),new re(144,ne.Vector3,ii.PARTICLE_SIMULATIONWORLDPOSTION),new re(156,ne.Vector4,ii.PARTICLE_SIMULATIONWORLDROTATION)])}},{key:"vertexDeclaration",get:function(){return VertexShurikenParticleMesh._vertexDeclaration}}]),VertexShurikenParticleMesh}(),oi=function(){function Rand(e){_classCallCheck(this,Rand),this._temp=new Uint32Array(1),this.seeds=new Uint32Array(4),this.seeds[0]=e,this.seeds[1]=1812433253*this.seeds[0]+1,this.seeds[2]=1812433253*this.seeds[1]+1,this.seeds[3]=1812433253*this.seeds[2]+1}return _createClass(Rand,[{key:"getUint",value:function(){return this._temp[0]=this.seeds[0]^this.seeds[0]<<11,this.seeds[0]=this.seeds[1],this.seeds[1]=this.seeds[2],this.seeds[2]=this.seeds[3],this.seeds[3]=this.seeds[3]^this.seeds[3]>>>19^this._temp[0]^this._temp[0]>>>8,this.seeds[3]}},{key:"getFloat",value:function(){return this.getUint(),(8388607&this.seeds[3])*(1/8388607)}},{key:"getSignedFloat",value:function(){return 2*this.getFloat()-1}},{key:"seed",get:function(){return this.seeds[0]},set:function(e){this.seeds[0]=e,this.seeds[1]=1812433253*this.seeds[0]+1,this.seeds[2]=1812433253*this.seeds[1]+1,this.seeds[3]=1812433253*this.seeds[2]+1}}],[{key:"getFloatFromInt",value:function(e){return 1/8388607*(8388607&e)}},{key:"getByteFromInt",value:function(e){return(8388607&e)>>>15}}]),Rand}(),si=function(){function Emission(){_classCallCheck(this,Emission),this._emissionRate=10,this._destroyed=!1,this._bursts=[]}return _createClass(Emission,[{key:"destroy",value:function(){this._bursts=null,this._destroyed=!0}},{key:"getBurstsCount",value:function(){return this._bursts.length}},{key:"getBurstByIndex",value:function(e){return this._bursts[e]}},{key:"addBurst",value:function(e){var t=this._bursts.length;if(t>0)for(var n=0;n<t;n++)this._bursts[n].time>e.time&&this._bursts.splice(n,0,e);this._bursts.push(e)}},{key:"removeBurst",value:function(e){var t=this._bursts.indexOf(e);-1!==t&&this._bursts.splice(t,1)}},{key:"removeBurstByIndex",value:function(e){this._bursts.splice(e,1)}},{key:"clearBurst",value:function(){this._bursts.length=0}},{key:"cloneTo",value:function(e){var t=e,n=t._bursts;n.length=this._bursts.length;for(var i=0,a=this._bursts.length;i<a;i++){var r=n[i];r?this._bursts[i].cloneTo(r):n[i]=this._bursts[i].clone()}t._emissionRate=this._emissionRate,t.enable=this.enable}},{key:"clone",value:function(){var e=new Emission;return this.cloneTo(e),e}},{key:"emissionRate",set:function(e){if(e<0)throw new Error("ParticleBaseShape:emissionRate value must large or equal than 0.");this._emissionRate=e},get:function(){return this._emissionRate}},{key:"destroyed",get:function(){return this._destroyed}}]),Emission}(),li=function(){function ShurikenParticleData(){_classCallCheck(this,ShurikenParticleData)}return _createClass(ShurikenParticleData,null,[{key:"_getStartLifetimeFromGradient",value:function(e,n){for(var i=1,a=e.gradientCount;i<a;i++){var r=e.getKeyByIndex(i);if(r>=n){var o=e.getKeyByIndex(i-1),s=(n-o)/(r-o);return t.MathUtil.lerp(e.getValueByIndex(i-1),e.getValueByIndex(i),s)}}throw new Error("ShurikenParticleData: can't get value foam startLifeTimeGradient.")}},{key:"_randomInvertRoationArray",value:function(e,t,n,i,a){var r;i?(i.seed=a[6],r=i.getFloat(),a[6]=i.seed):r=Math.random(),r<n?(t.x=-e.x,t.y=-e.y,t.z=-e.z):(t.x=e.x,t.y=e.y,t.z=e.z)}},{key:"_randomInvertRoation",value:function(e,t,n,i){var a;return n?(n.seed=i[6],a=n.getFloat(),i[6]=n.seed):a=Math.random(),a<t&&(e=-e),e}},{key:"create",value:function(e,n){var i=e.autoRandomSeed,r=e._rand,o=e._randomSeeds;switch(e.startColorType){case 0:var s=e.startColorConstant;ShurikenParticleData.startColor.x=s.x,ShurikenParticleData.startColor.y=s.y,ShurikenParticleData.startColor.z=s.z,ShurikenParticleData.startColor.w=s.w;break;case 2:i?a.lerp(e.startColorConstantMin,e.startColorConstantMax,Math.random(),ShurikenParticleData.startColor):(r.seed=o[3],a.lerp(e.startColorConstantMin,e.startColorConstantMax,r.getFloat(),ShurikenParticleData.startColor),o[3]=r.seed)}var l=e.colorOverLifetime;if(l&&l.enable){var u=l.color;switch(u.type){case 0:ShurikenParticleData.startColor.x=ShurikenParticleData.startColor.x*u.constant.x,ShurikenParticleData.startColor.y=ShurikenParticleData.startColor.y*u.constant.y,ShurikenParticleData.startColor.z=ShurikenParticleData.startColor.z*u.constant.z,ShurikenParticleData.startColor.w=ShurikenParticleData.startColor.w*u.constant.w;break;case 2:var c;i?c=Math.random():(r.seed=o[10],c=r.getFloat(),o[10]=r.seed);var h=u.constantMin,_=u.constantMax;ShurikenParticleData.startColor.x=ShurikenParticleData.startColor.x*t.MathUtil.lerp(h.x,_.x,c),ShurikenParticleData.startColor.y=ShurikenParticleData.startColor.y*t.MathUtil.lerp(h.y,_.y,c),ShurikenParticleData.startColor.z=ShurikenParticleData.startColor.z*t.MathUtil.lerp(h.z,_.z,c),ShurikenParticleData.startColor.w=ShurikenParticleData.startColor.w*t.MathUtil.lerp(h.w,_.w,c)}}var d=ShurikenParticleData.startSize;switch(e.startSizeType){case 0:if(e.threeDStartSize){var f=e.startSizeConstantSeparate;d[0]=f.x,d[1]=f.y,d[2]=f.z}else d[0]=d[1]=d[2]=e.startSizeConstant;break;case 2:if(e.threeDStartSize){var m=e.startSizeConstantMinSeparate,p=e.startSizeConstantMaxSeparate;i?(d[0]=t.MathUtil.lerp(m.x,p.x,Math.random()),d[1]=t.MathUtil.lerp(m.y,p.y,Math.random()),d[2]=t.MathUtil.lerp(m.z,p.z,Math.random())):(r.seed=o[4],d[0]=t.MathUtil.lerp(m.x,p.x,r.getFloat()),d[1]=t.MathUtil.lerp(m.y,p.y,r.getFloat()),d[2]=t.MathUtil.lerp(m.z,p.z,r.getFloat()),o[4]=r.seed)}else i?d[0]=d[1]=d[2]=t.MathUtil.lerp(e.startSizeConstantMin,e.startSizeConstantMax,Math.random()):(r.seed=o[4],d[0]=d[1]=d[2]=t.MathUtil.lerp(e.startSizeConstantMin,e.startSizeConstantMax,r.getFloat()),o[4]=r.seed)}var T=e.sizeOverLifetime;if(T&&T.enable&&1===T.size.type){var v,g=T.size;if(g.separateAxes)i?(d[0]=d[0]*t.MathUtil.lerp(g.constantMinSeparate.x,g.constantMaxSeparate.x,Math.random()),d[1]=d[1]*t.MathUtil.lerp(g.constantMinSeparate.y,g.constantMaxSeparate.y,Math.random()),d[2]=d[2]*t.MathUtil.lerp(g.constantMinSeparate.z,g.constantMaxSeparate.z,Math.random())):(r.seed=o[11],d[0]=d[0]*t.MathUtil.lerp(g.constantMinSeparate.x,g.constantMaxSeparate.x,r.getFloat()),d[1]=d[1]*t.MathUtil.lerp(g.constantMinSeparate.y,g.constantMaxSeparate.y,r.getFloat()),d[2]=d[2]*t.MathUtil.lerp(g.constantMinSeparate.z,g.constantMaxSeparate.z,r.getFloat()),o[11]=r.seed);else i?v=t.MathUtil.lerp(g.constantMin,g.constantMax,Math.random()):(r.seed=o[11],v=t.MathUtil.lerp(g.constantMin,g.constantMax,r.getFloat()),o[11]=r.seed),d[0]=d[0]*v,d[1]=d[1]*v,d[2]=d[2]*v}var E=n.renderMode;if(1!==E)switch(e.startRotationType){case 0:if(e.threeDStartRotation){var y=e.startRotationConstantSeparate,S=ShurikenParticleData._tempVector30;ShurikenParticleData._randomInvertRoationArray(y,S,e.randomizeRotationDirection,i?null:r,o),ShurikenParticleData.startRotation[0]=S.x,ShurikenParticleData.startRotation[1]=S.y,ShurikenParticleData.startRotation[2]=4!==E?-S.z:S.z}else ShurikenParticleData.startRotation[0]=ShurikenParticleData._randomInvertRoation(e.startRotationConstant,e.randomizeRotationDirection,i?null:r,o),ShurikenParticleData.startRotation[1]=0,ShurikenParticleData.startRotation[2]=0;break;case 2:if(e.threeDStartRotation){var R=e.startRotationConstantMinSeparate,C=e.startRotationConstantMaxSeparate,M=ShurikenParticleData._tempVector30;i?(M.x=t.MathUtil.lerp(R.x,C.x,Math.random()),M.y=t.MathUtil.lerp(R.y,C.y,Math.random()),M.z=t.MathUtil.lerp(R.z,C.z,Math.random())):(r.seed=o[5],M.x=t.MathUtil.lerp(R.x,C.x,r.getFloat()),M.y=t.MathUtil.lerp(R.y,C.y,r.getFloat()),M.z=t.MathUtil.lerp(R.z,C.z,r.getFloat()),o[5]=r.seed),ShurikenParticleData._randomInvertRoationArray(M,M,e.randomizeRotationDirection,i?null:r,o),ShurikenParticleData.startRotation[0]=M.x,ShurikenParticleData.startRotation[1]=M.y,ShurikenParticleData.startRotation[2]=4!==E?-M.z:M.z}else i?ShurikenParticleData.startRotation[0]=ShurikenParticleData._randomInvertRoation(t.MathUtil.lerp(e.startRotationConstantMin,e.startRotationConstantMax,Math.random()),e.randomizeRotationDirection,i?null:r,o):(r.seed=o[5],ShurikenParticleData.startRotation[0]=ShurikenParticleData._randomInvertRoation(t.MathUtil.lerp(e.startRotationConstantMin,e.startRotationConstantMax,r.getFloat()),e.randomizeRotationDirection,i?null:r,o),o[5]=r.seed)}switch(e.startLifetimeType){case 0:ShurikenParticleData.startLifeTime=e.startLifetimeConstant;break;case 1:ShurikenParticleData.startLifeTime=ShurikenParticleData._getStartLifetimeFromGradient(e.startLifeTimeGradient,e.emissionTime);break;case 2:i?ShurikenParticleData.startLifeTime=t.MathUtil.lerp(e.startLifetimeConstantMin,e.startLifetimeConstantMax,Math.random()):(r.seed=o[7],ShurikenParticleData.startLifeTime=t.MathUtil.lerp(e.startLifetimeConstantMin,e.startLifetimeConstantMax,r.getFloat()),o[7]=r.seed);break;case 3:var D=e.emissionTime;i?ShurikenParticleData.startLifeTime=t.MathUtil.lerp(ShurikenParticleData._getStartLifetimeFromGradient(e.startLifeTimeGradientMin,D),ShurikenParticleData._getStartLifetimeFromGradient(e.startLifeTimeGradientMax,D),Math.random()):(r.seed=o[7],ShurikenParticleData.startLifeTime=t.MathUtil.lerp(ShurikenParticleData._getStartLifetimeFromGradient(e.startLifeTimeGradientMin,D),ShurikenParticleData._getStartLifetimeFromGradient(e.startLifeTimeGradientMax,D),r.getFloat()),o[7]=r.seed)}var x=e.textureSheetAnimation;if(x&&x.enable){var A,I=x.tiles,L=I.x,P=I.y,O=1/L,N=1/P,b=x.startFrame;switch(b.type){case 0:A=b.constant;break;case 1:i?A=t.MathUtil.lerp(b.constantMin,b.constantMax,Math.random()):(r.seed=o[14],A=t.MathUtil.lerp(b.constantMin,b.constantMax,r.getFloat()),o[14]=r.seed)}var k=x.frame,w=x.cycles;switch(k.type){case 0:A+=k.constant*w;break;case 2:i?A+=t.MathUtil.lerp(k.constantMin,k.constantMax,Math.random())*w:(r.seed=o[15],A+=t.MathUtil.lerp(k.constantMin,k.constantMax,r.getFloat())*w,o[15]=r.seed)}var B=0;switch(x.type){case 0:B=Math.floor(A/L);break;case 1:x.randomRow?i?B=Math.floor(Math.random()*P):(r.seed=o[13],B=Math.floor(r.getFloat()*P),o[13]=r.seed):B=x.rowIndex}var V=Math.floor(A%L);ShurikenParticleData.startUVInfo=ShurikenParticleData.startUVInfo,ShurikenParticleData.startUVInfo[0]=O,ShurikenParticleData.startUVInfo[1]=N,ShurikenParticleData.startUVInfo[2]=V*O,ShurikenParticleData.startUVInfo[3]=B*N}else ShurikenParticleData.startUVInfo=ShurikenParticleData.startUVInfo,ShurikenParticleData.startUVInfo[0]=1,ShurikenParticleData.startUVInfo[1]=1,ShurikenParticleData.startUVInfo[2]=0,ShurikenParticleData.startUVInfo[3]=0}}]),ShurikenParticleData}();li._tempVector30=new o,li.startColor=new a,li.startSize=new Float32Array(3),li.startRotation=new Float32Array(3),li.startUVInfo=new Float32Array(4);var ui=function(n){function ShurikenParticleSystem(e){var t;return _classCallCheck(this,ShurikenParticleSystem),(t=_possibleConstructorReturn(this,_getPrototypeOf(ShurikenParticleSystem).call(this)))._boundingSphere=null,t._boundingBox=null,t._boundingBoxCorners=null,t._bounds=null,t._gravityOffset=new i,t._customBounds=null,t._useCustomBounds=!1,t._owner=null,t._ownerRender=null,t._vertices=null,t._floatCountPerVertex=0,t._startLifeTimeIndex=0,t._timeIndex=0,t._simulateUpdate=!1,t._firstActiveElement=0,t._firstNewElement=0,t._firstFreeElement=0,t._firstRetiredElement=0,t._drawCounter=0,t._bufferMaxParticles=0,t._emission=null,t._shape=null,t._isEmitting=!1,t._isPlaying=!1,t._isPaused=!1,t._playStartDelay=0,t._frameRateTime=0,t._emissionTime=0,t._totalDelayTime=0,t._burstsIndex=0,t._velocityOverLifetime=null,t._colorOverLifetime=null,t._sizeOverLifetime=null,t._rotationOverLifetime=null,t._textureSheetAnimation=null,t._startLifetimeType=0,t._startLifetimeConstant=0,t._startLifeTimeGradient=null,t._startLifetimeConstantMin=0,t._startLifetimeConstantMax=0,t._startLifeTimeGradientMin=null,t._startLifeTimeGradientMax=null,t._maxStartLifetime=0,t._uvLength=new i,t._vertexStride=0,t._indexStride=0,t._vertexBuffer=null,t._indexBuffer=null,t._bufferState=new oe,t._updateMask=0,t._currentTime=0,t._startUpdateLoopCount=0,t._rand=null,t._randomSeeds=null,t.duration=0,t.looping=!1,t.prewarm=!1,t.startDelayType=0,t.startDelay=0,t.startDelayMin=0,t.startDelayMax=0,t.startSpeedType=0,t.startSpeedConstant=0,t.startSpeedConstantMin=0,t.startSpeedConstantMax=0,t.threeDStartSize=!1,t.startSizeType=0,t.startSizeConstant=0,t.startSizeConstantSeparate=null,t.startSizeConstantMin=0,t.startSizeConstantMax=0,t.startSizeConstantMinSeparate=null,t.startSizeConstantMaxSeparate=null,t.threeDStartRotation=!1,t.startRotationType=0,t.startRotationConstant=0,t.startRotationConstantSeparate=null,t.startRotationConstantMin=0,t.startRotationConstantMax=0,t.startRotationConstantMinSeparate=null,t.startRotationConstantMaxSeparate=null,t.randomizeRotationDirection=0,t.startColorType=0,t.startColorConstant=new a(1,1,1,1),t.startColorConstantMin=new a(0,0,0,0),t.startColorConstantMax=new a(1,1,1,1),t.gravityModifier=0,t.simulationSpace=0,t.simulationSpeed=1,t.scaleMode=1,t.playOnAwake=!1,t.randomSeed=null,t.autoRandomSeed=!1,t.isPerformanceMode=!1,t._firstActiveElement=0,t._firstNewElement=0,t._firstFreeElement=0,t._firstRetiredElement=0,t._owner=e,t._ownerRender=e.particleRenderer,t._boundingBoxCorners=[],t._boundingSphere=new rn(new o,Number.MAX_VALUE),t._boundingBox=new wt(new o(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),new o(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)),t._bounds=new Bt(t._boundingBox.min,t._boundingBox.max),t._useCustomBounds=!1,t._currentTime=0,t._isEmitting=!1,t._isPlaying=!1,t._isPaused=!1,t._burstsIndex=0,t._frameRateTime=0,t._emissionTime=0,t._totalDelayTime=0,t._simulateUpdate=!1,t._bufferMaxParticles=1,t.duration=5,t.looping=!0,t.prewarm=!1,t.startDelayType=0,t.startDelay=0,t.startDelayMin=0,t.startDelayMax=0,t._startLifetimeType=0,t._startLifetimeConstant=5,t._startLifeTimeGradient=new Fn,t._startLifetimeConstantMin=0,t._startLifetimeConstantMax=5,t._startLifeTimeGradientMin=new Fn,t._startLifeTimeGradientMax=new Fn,t._maxStartLifetime=5,t.startSpeedType=0,t.startSpeedConstant=5,t.startSpeedConstantMin=0,t.startSpeedConstantMax=5,t.threeDStartSize=!1,t.startSizeType=0,t.startSizeConstant=1,t.startSizeConstantSeparate=new o(1,1,1),t.startSizeConstantMin=0,t.startSizeConstantMax=1,t.startSizeConstantMinSeparate=new o(0,0,0),t.startSizeConstantMaxSeparate=new o(1,1,1),t.threeDStartRotation=!1,t.startRotationType=0,t.startRotationConstant=0,t.startRotationConstantSeparate=new o(0,0,0),t.startRotationConstantMin=0,t.startRotationConstantMax=0,t.startRotationConstantMinSeparate=new o(0,0,0),t.startRotationConstantMaxSeparate=new o(0,0,0),t.gravityModifier=0,t.simulationSpace=1,t.scaleMode=1,t.playOnAwake=!0,t._rand=new oi(0),t.autoRandomSeed=!0,t.randomSeed=new Uint32Array(1),t._randomSeeds=new Uint32Array(ShurikenParticleSystem._RANDOMOFFSET.length),t.isPerformanceMode=!0,t._emission=new si,t._emission.enable=!0,t}return _inherits(ShurikenParticleSystem,Vt),_createClass(ShurikenParticleSystem,[{key:"_getVertexBuffer",value:function(){return 0===(arguments.length>0&&void 0!==arguments[0]?arguments[0]:0)?this._vertexBuffer:null}},{key:"_getIndexBuffer",value:function(){return this._indexBuffer}},{key:"_generateBoundingSphere",value:function(){var e=this._boundingSphere.center;e.x=0,e.y=0,e.z=0,this._boundingSphere.radius=Number.MAX_VALUE}},{key:"_generateBounds",value:function(){var t=this._owner.particleRenderer,n=this._bounds.getMin(),i=this._bounds.getMax(),a=0;switch(this.startLifetimeType){case 0:a=this._startLifetimeConstant;break;case 2:a=this._startLifetimeConstantMax}var r=0;switch(this.startSpeedType){case 0:r=this.startSpeedConstant;break;case 2:r=this.startSpeedConstantMax}var s=0;if(this.threeDStartSize)switch(this.startSizeType){case 0:s=Math.max(this.startSizeConstantSeparate.x,this.startSizeConstantSeparate.y,this.startSizeConstantSeparate.z);break;case 2:s=Math.max(this.startSizeConstantMaxSeparate.x,this.startSizeConstantMaxSeparate.y,this.startSizeConstantMaxSeparate.z)}else switch(this.startSizeType){case 0:s=this.startSizeConstant;break;case 2:s=this.startSizeConstantMax}var l=ShurikenParticleSystem._tempVector30,u=ShurikenParticleSystem._tempVector31,c=ShurikenParticleSystem._tempVector32,h=ShurikenParticleSystem._tempVector33;if(l.setValue(0,0,1),u.setValue(0,0,0),c.setValue(0,0,0),h.setValue(0,0,0),this.shape&&this.shape.enable)switch(this.shape.shapeType){case e.ParticleSystemShapeType.Sphere:var _=this.shape;l.setValue(1,1,1),u.setValue(1,1,1),c.setValue(_.radius,_.radius,_.radius),h.setValue(_.radius,_.radius,_.radius);break;case e.ParticleSystemShapeType.Hemisphere:var d=this.shape;l.setValue(1,1,1),u.setValue(1,1,1),c.setValue(d.radius,d.radius,d.radius),h.setValue(d.radius,d.radius,0);break;case e.ParticleSystemShapeType.Cone:var f=this.shape;if(0==f.emitType||1==f.emitType){var m=f.angle,p=Math.sin(m);l.setValue(p,p,1),u.setValue(p,p,0),c.setValue(f.radius,f.radius,0),h.setValue(f.radius,f.radius,0);break}if(2==f.emitType||3==f.emitType){m=f.angle,p=Math.sin(m);var T=f.length;l.setValue(p,p,1),u.setValue(p,p,0);var v=Math.tan(m),g=f.radius+T*v;c.setValue(g,g,T),h.setValue(g,g,0)}break;case e.ParticleSystemShapeType.Box:var E=this.shape;0!=this.shape.randomDirection&&(l.setValue(1,1,1),u.setValue(1,1,1)),c.setValue(E.x/2,E.y/2,E.z/2),h.setValue(E.x/2,E.y/2,E.z/2);break;case e.ParticleSystemShapeType.Circle:var y=this.shape;l.setValue(1,1,1),u.setValue(1,1,1),c.setValue(y.radius,y.radius,0),h.setValue(y.radius,y.radius,0)}var S=0,R=4==t.renderMode;switch(t.renderMode){case 0:case 1:case 2:case 3:S=ShurikenParticleSystem.halfKSqrtOf2;break;case 4:var C=t.mesh.bounds;S=Math.sqrt(Math.pow(C.getExtent().x,2)+Math.pow(C.getExtent().y,2)+Math.pow(C.getExtent().z,2))}var M=ShurikenParticleSystem._tempVector36;if(M.setValue(1,1,1),this.sizeOverLifetime&&this.sizeOverLifetime.enable){var D=this.sizeOverLifetime.size.getMaxSizeInGradient(R);M.setValue(D,D,D)}var x=S*s;o.scale(M,x,M);var A=ShurikenParticleSystem._tempVector34,I=ShurikenParticleSystem._tempVector35;if(r>0?(o.scale(l,r,A),o.scale(u,r,I)):(o.scale(l,-r,I),o.scale(u,-r,A)),this.velocityOverLifetime&&this.velocityOverLifetime.enable){var L=this.velocityOverLifetime.velocity,P=ShurikenParticleSystem._tempVector37;switch(P.setValue(0,0,0),L.type){case 0:L.constant.cloneTo(P);break;case 2:L.constantMax.cloneTo(P);break;case 1:var O=L.gradientX.getAverageValue(),N=L.gradientY.getAverageValue(),b=L.gradientZ.getAverageValue();P.setValue(O,N,b);break;case 3:var k=L.gradientXMax.getAverageValue(),w=L.gradientYMax.getAverageValue(),B=L.gradientZMax.getAverageValue();P.setValue(k,w,B)}1==this.velocityOverLifetime.space&&o.transformV3ToV3(P,this._owner.transform.worldMatrix,P),o.add(A,P,A),o.subtract(I,P,I),o.max(A,o._ZERO,A),o.max(I,o._ZERO,I)}o.scale(A,a,A),o.scale(I,a,I);var V=this.gravityModifier;if(0!=V){var F=.5*ShurikenParticleSystem.g*V*a*a,U=A.y-F,G=I.y+F;U=U>0?U:0,G=G>0?G:0,this._gravityOffset.setValue(A.y-U,G-I.y)}o.add(A,M,i),o.add(i,c,i),o.add(I,M,n),o.add(n,h,n),o.scale(n,-1,n),this._bounds.setMin(n),this._bounds.setMax(i)}},{key:"_simulationSupported",value:function(){return 0!=this.simulationSpace}},{key:"_updateEmission",value:function(){if(this.isAlive)if(this._simulateUpdate)this._simulateUpdate=!1;else{var e=this._startUpdateLoopCount===t.Stat.loopCount||this._isPaused?0:this._owner._scene.timer._delta/1e3;e=Math.min(ShurikenParticleSystem._maxElapsedTime,e*this.simulationSpeed),this._updateParticles(e)}}},{key:"_updateParticles",value:function(e){(4!==this._ownerRender.renderMode||this._ownerRender.mesh)&&(this._currentTime+=e,this._retireActiveParticles(),this._freeRetiredParticles(),this._totalDelayTime+=e,this._totalDelayTime<this._playStartDelay||this._emission.enable&&this._isEmitting&&!this._isPaused&&this._advanceTime(e,this._currentTime))}},{key:"_updateParticlesSimulationRestart",value:function(e){this._firstActiveElement=0,this._firstNewElement=0,this._firstFreeElement=0,this._firstRetiredElement=0,this._burstsIndex=0,this._frameRateTime=e,this._emissionTime=0,this._totalDelayTime=0,this._currentTime=e;var t=e;t<this._playStartDelay?this._totalDelayTime=t:this._emission.enable&&this._advanceTime(e,e)}},{key:"_retireActiveParticles",value:function(){for(;this._firstActiveElement!=this._firstNewElement;){var e=this._firstActiveElement*this._floatCountPerVertex*this._vertexStride,t=e+this._timeIndex;if(this._currentTime-this._vertices[t]+1e-4<this._vertices[e+this._startLifeTimeIndex])break;this._vertices[t]=this._drawCounter,this._firstActiveElement++,this._firstActiveElement>=this._bufferMaxParticles&&(this._firstActiveElement=0)}}},{key:"_freeRetiredParticles",value:function(){for(;this._firstRetiredElement!=this._firstActiveElement;){this._drawCounter,this._vertices[this._firstRetiredElement*this._floatCountPerVertex*this._vertexStride+this._timeIndex];this._firstRetiredElement++,this._firstRetiredElement>=this._bufferMaxParticles&&(this._firstRetiredElement=0)}}},{key:"_burst",value:function(e,n){for(var i=0,a=this._emission._bursts,r=a.length;this._burstsIndex<r;this._burstsIndex++){var o,s=a[this._burstsIndex],l=s.time;if(!(e<=l&&l<n))break;this.autoRandomSeed?o=t.MathUtil.lerp(s.minCount,s.maxCount,Math.random()):(this._rand.seed=this._randomSeeds[0],o=t.MathUtil.lerp(s.minCount,s.maxCount,this._rand.getFloat()),this._randomSeeds[0]=this._rand.seed),i+=o}return i}},{key:"_advanceTime",value:function(e,t){var n,i=this._emissionTime;this._emissionTime+=e;var a=0;if(this._emissionTime>this.duration){if(!this.looping){for(a=Math.min(this.maxParticles-this.aliveParticleCount,a),n=0;n<a;n++)this.emit(t);return this._isPlaying=!1,void this.stop()}a+=this._burst(i,this._emissionTime),this._emissionTime-=this.duration,this._burstsIndex=0,a+=this._burst(0,this._emissionTime)}else a+=this._burst(i,this._emissionTime);for(a=Math.min(this.maxParticles-this.aliveParticleCount,a),n=0;n<a;n++)this.emit(t);var r=this.emission.emissionRate;if(r>0){var o=1/r;for(this._frameRateTime+=o,this._frameRateTime=this._currentTime-(this._currentTime-this._frameRateTime)%this._maxStartLifetime;this._frameRateTime<=t&&this.emit(this._frameRateTime);)this._frameRateTime+=o;this._frameRateTime=Math.floor(t/o)*o}}},{key:"_initBufferDatas",value:function(){if(this._vertexBuffer){var n=this._vertexBuffer._byteLength+2*this._indexBuffer.indexCount;this._vertexBuffer.destroy(),this._indexBuffer.destroy(),t.Resource._addMemory(-n,-n)}var i=t.LayaGL.instance,a=this._ownerRender,r=a.renderMode;if(-1!==r&&this.maxParticles>0){var o,s,l,u,c,h,_,d=0,f=(n=0,a.mesh);if(4===r){if(f){_=ri.vertexDeclaration,this._floatCountPerVertex=_.vertexStride/4,this._startLifeTimeIndex=12,this._timeIndex=16,this._vertexStride=f._vertexCount;var m=this._bufferMaxParticles*this._vertexStride,p=m%65535;if(Math.floor(m/65535)+1>1)throw new Error("ShurikenParticleSystem:the maxParticleCount multiply mesh vertexCount is large than 65535.");d=_.vertexStride*p,this._vertexBuffer=new te(d,i.DYNAMIC_DRAW),this._vertexBuffer.vertexDeclaration=_,this._vertices=new Float32Array(this._floatCountPerVertex*p),this._indexStride=f._indexBuffer.indexCount;var T=f._indexBuffer.getData(),v=this._bufferMaxParticles*this._indexStride;for(this._indexBuffer=new Oe(e.IndexFormat.UInt16,v,i.STATIC_DRAW),o=new Uint16Array(v),n=d+2*v,c=0,s=0;s<this._bufferMaxParticles;s++){var g=s*this._vertexStride;for(l=0,u=T.length;l<u;l++)o[c++]=g+T[l]}this._indexBuffer.setData(o),this._bufferState.bind(),this._bufferState.applyVertexBuffer(this._vertexBuffer),this._bufferState.applyIndexBuffer(this._indexBuffer),this._bufferState.unBind()}}else{for(_=ai.vertexDeclaration,this._floatCountPerVertex=_.vertexStride/4,this._startLifeTimeIndex=7,this._timeIndex=11,this._vertexStride=4,d=_.vertexStride*this._bufferMaxParticles*this._vertexStride,this._vertexBuffer=new te(d,i.DYNAMIC_DRAW),this._vertexBuffer.vertexDeclaration=_,this._vertices=new Float32Array(this._floatCountPerVertex*this._bufferMaxParticles*this._vertexStride),s=0;s<this._bufferMaxParticles;s++)h=s*this._floatCountPerVertex*this._vertexStride,this._vertices[h]=-.5,this._vertices[h+1]=-.5,this._vertices[h+2]=0,this._vertices[h+3]=1,h+=this._floatCountPerVertex,this._vertices[h]=.5,this._vertices[h+1]=-.5,this._vertices[h+2]=1,this._vertices[h+3]=1,h+=this._floatCountPerVertex,this._vertices[h]=.5,this._vertices[h+1]=.5,this._vertices[h+2]=1,this._vertices[h+3]=0,h+=this._floatCountPerVertex,this._vertices[h]=-.5,this._vertices[h+1]=.5,this._vertices[h+2]=0,this._vertices[h+3]=0;for(this._indexStride=6,this._indexBuffer=new Oe(e.IndexFormat.UInt16,6*this._bufferMaxParticles,i.STATIC_DRAW),o=new Uint16Array(6*this._bufferMaxParticles),s=0;s<this._bufferMaxParticles;s++){c=6*s;var E=s*this._vertexStride,y=E+2;o[c++]=E,o[c++]=y,o[c++]=E+1,o[c++]=E,o[c++]=E+3,o[c++]=y}this._indexBuffer.setData(o),n=d+6*this._bufferMaxParticles*2,this._bufferState.bind(),this._bufferState.applyVertexBuffer(this._vertexBuffer),this._bufferState.applyIndexBuffer(this._indexBuffer),this._bufferState.unBind()}t.Resource._addMemory(n,n)}}},{key:"destroy",value:function(){_get(_getPrototypeOf(ShurikenParticleSystem.prototype),"destroy",this).call(this);var e=this._vertexBuffer._byteLength+2*this._indexBuffer.indexCount;t.Resource._addMemory(-e,-e),this._bufferState.destroy(),this._vertexBuffer.destroy(),this._indexBuffer.destroy(),this._emission.destroy(),this._boundingBox=null,this._boundingSphere=null,this._boundingBoxCorners=null,this._bounds=null,this._customBounds=null,this._bufferState=null,this._vertexBuffer=null,this._indexBuffer=null,this._owner=null,this._vertices=null,this._indexBuffer=null,this._emission=null,this._shape=null,this.startLifeTimeGradient=null,this.startLifeTimeGradientMin=null,this.startLifeTimeGradientMax=null,this.startSizeConstantSeparate=null,this.startSizeConstantMinSeparate=null,this.startSizeConstantMaxSeparate=null,this.startRotationConstantSeparate=null,this.startRotationConstantMinSeparate=null,this.startRotationConstantMaxSeparate=null,this.startColorConstant=null,this.startColorConstantMin=null,this.startColorConstantMax=null,this._velocityOverLifetime=null,this._colorOverLifetime=null,this._sizeOverLifetime=null,this._rotationOverLifetime=null,this._textureSheetAnimation=null}},{key:"emit",value:function(e){var t=ShurikenParticleSystem._tempPosition,n=ShurikenParticleSystem._tempDirection;return this._shape&&this._shape.enable?this.autoRandomSeed?this._shape.generatePositionAndDirection(t,n):this._shape.generatePositionAndDirection(t,n,this._rand,this._randomSeeds):(t.x=t.y=t.z=0,n.x=n.y=0,n.z=1),this.addParticle(t,n,e)}},{key:"addParticle",value:function(e,n,i){o.normalize(n,n);var a=this._firstFreeElement+1;if(a>=this._bufferMaxParticles&&(a=0),a===this._firstRetiredElement)return!1;var r,s,l,u,c,h,_,d,f,m,p=this._owner.transform;if(li.create(this,this._ownerRender),this._currentTime-i>=li.startLifeTime)return!0;switch(0==this.simulationSpace&&(r=p.position,s=p.rotation),this.startSpeedType){case 0:l=this.startSpeedConstant;break;case 2:this.autoRandomSeed?l=t.MathUtil.lerp(this.startSpeedConstantMin,this.startSpeedConstantMax,Math.random()):(this._rand.seed=this._randomSeeds[8],l=t.MathUtil.lerp(this.startSpeedConstantMin,this.startSpeedConstantMax,this._rand.getFloat()),this._randomSeeds[8]=this._rand.seed)}var T=this._velocityOverLifetime&&this._velocityOverLifetime.enable;if(T){var v=this._velocityOverLifetime.velocity.type;2===v||3===v?this.autoRandomSeed?(u=Math.random(),c=Math.random(),h=Math.random()):(this._rand.seed=this._randomSeeds[9],u=this._rand.getFloat(),c=this._rand.getFloat(),h=this._rand.getFloat(),this._randomSeeds[9]=this._rand.seed):T=!1}else T=!1;var g=this._colorOverLifetime&&this._colorOverLifetime.enable;g?3===this._colorOverLifetime.color.type?this.autoRandomSeed?_=Math.random():(this._rand.seed=this._randomSeeds[10],_=this._rand.getFloat(),this._randomSeeds[10]=this._rand.seed):g=!1:g=!1;var E=this._sizeOverLifetime&&this._sizeOverLifetime.enable;E?3===this._sizeOverLifetime.size.type?this.autoRandomSeed?d=Math.random():(this._rand.seed=this._randomSeeds[11],d=this._rand.getFloat(),this._randomSeeds[11]=this._rand.seed):E=!1:E=!1;var y=this._rotationOverLifetime&&this._rotationOverLifetime.enable;if(y){var S=this._rotationOverLifetime.angularVelocity.type;2===S||3===S?this.autoRandomSeed?f=Math.random():(this._rand.seed=this._randomSeeds[12],f=this._rand.getFloat(),this._randomSeeds[12]=this._rand.seed):y=!1}else y=!1;var R=this._textureSheetAnimation&&this._textureSheetAnimation.enable;R?3===this._textureSheetAnimation.frame.type?this.autoRandomSeed?m=Math.random():(this._rand.seed=this._randomSeeds[15],m=this._rand.getFloat(),this._randomSeeds[15]=this._rand.seed):R=!1:R=!1;var C,M,D,x,A,I,L=this._firstFreeElement*this._floatCountPerVertex*this._vertexStride,P=li.startUVInfo[0],O=li.startUVInfo[1],N=li.startUVInfo[2],b=li.startUVInfo[3],k=this._ownerRender;if(4===k.renderMode){var w=k.mesh._vertexBuffer;C=w.getFloat32Data();var B=w.vertexDeclaration;D=B.getVertexElementByUsage(Ne.MESH_POSITION0)._offset/4;var V=B.getVertexElementByUsage(Ne.MESH_COLOR0);x=V?V._offset/4:-1;var F=B.getVertexElementByUsage(Ne.MESH_TEXTURECOORDINATE0);A=F?F._offset/4:-1,M=B.vertexStride/4,I=0}else{this._vertices[L+2]=N,this._vertices[L+3]=b+O;var U=L+this._floatCountPerVertex;this._vertices[U+2]=N+P,this._vertices[U+3]=b+O;var G=U+this._floatCountPerVertex;this._vertices[G+2]=N+P,this._vertices[G+3]=b;var H=G+this._floatCountPerVertex;this._vertices[H+2]=N,this._vertices[H+3]=b}for(var z=L,W=L+this._floatCountPerVertex*this._vertexStride;z<W;z+=this._floatCountPerVertex){var X;if(4===k.renderMode){X=z;var Y=M*I++,j=Y+D;this._vertices[X++]=C[j++],this._vertices[X++]=C[j++],this._vertices[X++]=C[j],-1===x?(this._vertices[X++]=1,this._vertices[X++]=1,this._vertices[X++]=1,this._vertices[X++]=1):(j=Y+x,this._vertices[X++]=C[j++],this._vertices[X++]=C[j++],this._vertices[X++]=C[j++],this._vertices[X++]=C[j]),-1===A?(this._vertices[X++]=0,this._vertices[X++]=0):(j=Y+A,this._vertices[X++]=N+C[j++]*P,this._vertices[X++]=b+C[j]*O)}else X=z+4;switch(this._vertices[X++]=e.x,this._vertices[X++]=e.y,this._vertices[X++]=e.z,this._vertices[X++]=li.startLifeTime,this._vertices[X++]=n.x,this._vertices[X++]=n.y,this._vertices[X++]=n.z,this._vertices[X++]=i,this._vertices[X++]=li.startColor.x,this._vertices[X++]=li.startColor.y,this._vertices[X++]=li.startColor.z,this._vertices[X++]=li.startColor.w,this._vertices[X++]=li.startSize[0],this._vertices[X++]=li.startSize[1],this._vertices[X++]=li.startSize[2],this._vertices[X++]=li.startRotation[0],this._vertices[X++]=li.startRotation[1],this._vertices[X++]=li.startRotation[2],this._vertices[X++]=l,g&&(this._vertices[X+1]=_),E&&(this._vertices[X+2]=d),y&&(this._vertices[X+3]=f),R&&(this._vertices[X+4]=m),T&&(this._vertices[X+5]=u,this._vertices[X+6]=c,this._vertices[X+7]=h),this.simulationSpace){case 0:X+=8,this._vertices[X++]=r.x,this._vertices[X++]=r.y,this._vertices[X++]=r.z,this._vertices[X++]=s.x,this._vertices[X++]=s.y,this._vertices[X++]=s.z,this._vertices[X++]=s.w;break;case 1:break;default:throw new Error("ShurikenParticleMaterial: SimulationSpace value is invalid.")}}return this._firstFreeElement=a,!0}},{key:"addNewParticlesToVertexBuffer",value:function(){var e,t=this._vertexStride*this._floatCountPerVertex*4;this._firstNewElement<this._firstFreeElement?(e=this._firstNewElement*t,this._vertexBuffer.setData(this._vertices.buffer,e,e,(this._firstFreeElement-this._firstNewElement)*t)):(e=this._firstNewElement*t,this._vertexBuffer.setData(this._vertices.buffer,e,e,(this._bufferMaxParticles-this._firstNewElement)*t),this._firstFreeElement>0&&this._vertexBuffer.setData(this._vertices.buffer,0,0,this._firstFreeElement*t)),this._firstNewElement=this._firstFreeElement}},{key:"_getType",value:function(){return ShurikenParticleSystem._type}},{key:"_prepareRender",value:function(e){return this._updateMask!=t.Stat.loopCount&&(this._updateMask=t.Stat.loopCount,this._updateEmission(),this._firstNewElement!=this._firstFreeElement&&this.addNewParticlesToVertexBuffer(),this._drawCounter++),this._firstActiveElement!=this._firstFreeElement}},{key:"_render",value:function(e){var n;this._bufferState.bind();var i=t.LayaGL.instance;this._firstActiveElement<this._firstFreeElement?(n=(this._firstFreeElement-this._firstActiveElement)*this._indexStride,i.drawElements(i.TRIANGLES,n,i.UNSIGNED_SHORT,2*this._firstActiveElement*this._indexStride),t.Stat.trianglesFaces+=n/3,t.Stat.renderBatches++):(n=(this._bufferMaxParticles-this._firstActiveElement)*this._indexStride,i.drawElements(i.TRIANGLES,n,i.UNSIGNED_SHORT,2*this._firstActiveElement*this._indexStride),t.Stat.trianglesFaces+=n/3,t.Stat.renderBatches++,this._firstFreeElement>0&&(n=this._firstFreeElement*this._indexStride,i.drawElements(i.TRIANGLES,n,i.UNSIGNED_SHORT,0),t.Stat.trianglesFaces+=n/3,t.Stat.renderBatches++))}},{key:"play",value:function(){if(this._burstsIndex=0,this._isEmitting=!0,this._isPlaying=!0,this._isPaused=!1,this._emissionTime=0,this._totalDelayTime=0,!this.autoRandomSeed)for(var e=0,n=this._randomSeeds.length;e<n;e++)this._randomSeeds[e]=this.randomSeed[0]+ShurikenParticleSystem._RANDOMOFFSET[e];switch(this.startDelayType){case 0:this._playStartDelay=this.startDelay;break;case 1:this.autoRandomSeed?this._playStartDelay=t.MathUtil.lerp(this.startDelayMin,this.startDelayMax,Math.random()):(this._rand.seed=this._randomSeeds[2],this._playStartDelay=t.MathUtil.lerp(this.startDelayMin,this.startDelayMax,this._rand.getFloat()),this._randomSeeds[2]=this._rand.seed);break;default:throw new Error("Utils3D: startDelayType is invalid.")}this._frameRateTime=this._currentTime+this._playStartDelay,this._startUpdateLoopCount=t.Stat.loopCount}},{key:"pause",value:function(){this._isPaused=!0}},{key:"simulate",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];this._simulateUpdate=!0,t?this._updateParticlesSimulationRestart(e):(this._isPaused=!1,this._updateParticles(e)),this.pause()}},{key:"stop",value:function(){this._burstsIndex=0,this._isEmitting=!1,this._emissionTime=0}},{key:"cloneTo",value:function(e){var t=e;t._useCustomBounds=this._useCustomBounds,this._customBounds&&this._customBounds.cloneTo(t._customBounds),t.duration=this.duration,t.looping=this.looping,t.prewarm=this.prewarm,t.startDelayType=this.startDelayType,t.startDelay=this.startDelay,t.startDelayMin=this.startDelayMin,t.startDelayMax=this.startDelayMax,t._maxStartLifetime=this._maxStartLifetime,t.startLifetimeType=this.startLifetimeType,t.startLifetimeConstant=this.startLifetimeConstant,this.startLifeTimeGradient.cloneTo(t.startLifeTimeGradient),t.startLifetimeConstantMin=this.startLifetimeConstantMin,t.startLifetimeConstantMax=this.startLifetimeConstantMax,this.startLifeTimeGradientMin.cloneTo(t.startLifeTimeGradientMin),this.startLifeTimeGradientMax.cloneTo(t.startLifeTimeGradientMax),t.startSpeedType=this.startSpeedType,t.startSpeedConstant=this.startSpeedConstant,t.startSpeedConstantMin=this.startSpeedConstantMin,t.startSpeedConstantMax=this.startSpeedConstantMax,t.threeDStartSize=this.threeDStartSize,t.startSizeType=this.startSizeType,t.startSizeConstant=this.startSizeConstant,this.startSizeConstantSeparate.cloneTo(t.startSizeConstantSeparate),t.startSizeConstantMin=this.startSizeConstantMin,t.startSizeConstantMax=this.startSizeConstantMax,this.startSizeConstantMinSeparate.cloneTo(t.startSizeConstantMinSeparate),this.startSizeConstantMaxSeparate.cloneTo(t.startSizeConstantMaxSeparate),t.threeDStartRotation=this.threeDStartRotation,t.startRotationType=this.startRotationType,t.startRotationConstant=this.startRotationConstant,this.startRotationConstantSeparate.cloneTo(t.startRotationConstantSeparate),t.startRotationConstantMin=this.startRotationConstantMin,t.startRotationConstantMax=this.startRotationConstantMax,this.startRotationConstantMinSeparate.cloneTo(t.startRotationConstantMinSeparate),this.startRotationConstantMaxSeparate.cloneTo(t.startRotationConstantMaxSeparate),t.randomizeRotationDirection=this.randomizeRotationDirection,t.startColorType=this.startColorType,this.startColorConstant.cloneTo(t.startColorConstant),this.startColorConstantMin.cloneTo(t.startColorConstantMin),this.startColorConstantMax.cloneTo(t.startColorConstantMax),t.gravityModifier=this.gravityModifier,t.simulationSpace=this.simulationSpace,t.scaleMode=this.scaleMode,t.playOnAwake=this.playOnAwake,t.autoRandomSeed=this.autoRandomSeed,t.randomSeed[0]=this.randomSeed[0],t.maxParticles=this.maxParticles,this._emission&&(t._emission=this._emission.clone()),this.shape&&(t.shape=this.shape.clone()),this.velocityOverLifetime&&(t.velocityOverLifetime=this.velocityOverLifetime.clone()),this.colorOverLifetime&&(t.colorOverLifetime=this.colorOverLifetime.clone()),this.sizeOverLifetime&&(t.sizeOverLifetime=this.sizeOverLifetime.clone()),this.rotationOverLifetime&&(t.rotationOverLifetime=this.rotationOverLifetime.clone()),this.textureSheetAnimation&&(t.textureSheetAnimation=this.textureSheetAnimation.clone()),t.isPerformanceMode=this.isPerformanceMode,t._isEmitting=this._isEmitting,t._isPlaying=this._isPlaying,t._isPaused=this._isPaused,t._playStartDelay=this._playStartDelay,t._frameRateTime=this._frameRateTime,t._emissionTime=this._emissionTime,t._totalDelayTime=this._totalDelayTime,t._burstsIndex=this._burstsIndex}},{key:"clone",value:function(){var e=new ShurikenParticleSystem(null);return this.cloneTo(e),e}},{key:"maxParticles",get:function(){return this._bufferMaxParticles-1},set:function(e){var t=e+1;t!==this._bufferMaxParticles&&(this._bufferMaxParticles=t,this._initBufferDatas())}},{key:"emission",get:function(){return this._emission}},{key:"aliveParticleCount",get:function(){return this._firstNewElement>=this._firstRetiredElement?this._firstNewElement-this._firstRetiredElement:this._bufferMaxParticles-this._firstRetiredElement+this._firstNewElement}},{key:"emissionTime",get:function(){return this._emissionTime>this.duration?this.duration:this._emissionTime}},{key:"shape",get:function(){return this._shape},set:function(e){this._shape!==e&&(e&&e.enable?this._owner._render._shaderValues.addDefine(ei.SHADERDEFINE_SHAPE):this._owner._render._shaderValues.removeDefine(ei.SHADERDEFINE_SHAPE),this._shape=e)}},{key:"isAlive",get:function(){return!!(this._isPlaying||this.aliveParticleCount>0)}},{key:"isEmitting",get:function(){return this._isEmitting}},{key:"isPlaying",get:function(){return this._isPlaying}},{key:"isPaused",get:function(){return this._isPaused}},{key:"startLifetimeType",get:function(){return this._startLifetimeType},set:function(e){var t,n;switch(this.startLifetimeType){case 0:this._maxStartLifetime=this.startLifetimeConstant;break;case 1:this._maxStartLifetime=-Number.MAX_VALUE;var i=i;for(t=0,n=i.gradientCount;t<n;t++)this._maxStartLifetime=Math.max(this._maxStartLifetime,i.getValueByIndex(t));break;case 2:this._maxStartLifetime=Math.max(this.startLifetimeConstantMin,this.startLifetimeConstantMax);break;case 3:this._maxStartLifetime=-Number.MAX_VALUE;var a=a;for(t=0,n=a.gradientCount;t<n;t++)this._maxStartLifetime=Math.max(this._maxStartLifetime,a.getValueByIndex(t));var r=r;for(t=0,n=r.gradientCount;t<n;t++)this._maxStartLifetime=Math.max(this._maxStartLifetime,r.getValueByIndex(t))}this._startLifetimeType=e}},{key:"startLifetimeConstant",get:function(){return this._startLifetimeConstant},set:function(e){0===this._startLifetimeType&&(this._maxStartLifetime=e),this._startLifetimeConstant=e}},{key:"startLifeTimeGradient",get:function(){return this._startLifeTimeGradient},set:function(e){if(1===this._startLifetimeType){this._maxStartLifetime=-Number.MAX_VALUE;for(var t=0,n=e.gradientCount;t<n;t++)this._maxStartLifetime=Math.max(this._maxStartLifetime,e.getValueByIndex(t))}this._startLifeTimeGradient=e}},{key:"startLifetimeConstantMin",get:function(){return this._startLifetimeConstantMin},set:function(e){2===this._startLifetimeType&&(this._maxStartLifetime=Math.max(e,this._startLifetimeConstantMax)),this._startLifetimeConstantMin=e}},{key:"startLifetimeConstantMax",get:function(){return this._startLifetimeConstantMax},set:function(e){2===this._startLifetimeType&&(this._maxStartLifetime=Math.max(this._startLifetimeConstantMin,e)),this._startLifetimeConstantMax=e}},{key:"startLifeTimeGradientMin",get:function(){return this._startLifeTimeGradientMin},set:function(e){if(3===this._startLifetimeType){var t,n;for(this._maxStartLifetime=-Number.MAX_VALUE,t=0,n=e.gradientCount;t<n;t++)this._maxStartLifetime=Math.max(this._maxStartLifetime,e.getValueByIndex(t));for(t=0,n=this._startLifeTimeGradientMax.gradientCount;t<n;t++)this._maxStartLifetime=Math.max(this._maxStartLifetime,this._startLifeTimeGradientMax.getValueByIndex(t))}this._startLifeTimeGradientMin=e}},{key:"startLifeTimeGradientMax",get:function(){return this._startLifeTimeGradientMax},set:function(e){if(3===this._startLifetimeType){var t,n;for(this._maxStartLifetime=-Number.MAX_VALUE,t=0,n=this._startLifeTimeGradientMin.gradientCount;t<n;t++)this._maxStartLifetime=Math.max(this._maxStartLifetime,this._startLifeTimeGradientMin.getValueByIndex(t));for(t=0,n=e.gradientCount;t<n;t++)this._maxStartLifetime=Math.max(this._maxStartLifetime,e.getValueByIndex(t))}this._startLifeTimeGradientMax=e}},{key:"velocityOverLifetime",get:function(){return this._velocityOverLifetime},set:function(e){var t=this._owner._render._shaderValues;if(e){var n=e.velocity,i=n.type;if(e.enable)switch(i){case 0:t.addDefine(ei.SHADERDEFINE_VELOCITYOVERLIFETIMECONSTANT);break;case 1:t.addDefine(ei.SHADERDEFINE_VELOCITYOVERLIFETIMECURVE);break;case 2:t.addDefine(ei.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCONSTANT);break;case 3:t.addDefine(ei.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCURVE)}else t.removeDefine(ei.SHADERDEFINE_VELOCITYOVERLIFETIMECONSTANT),t.removeDefine(ei.SHADERDEFINE_VELOCITYOVERLIFETIMECURVE),t.removeDefine(ei.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCONSTANT),t.removeDefine(ei.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCURVE);switch(i){case 0:t.setVector3(ei.VOLVELOCITYCONST,n.constant);break;case 1:t.setBuffer(ei.VOLVELOCITYGRADIENTX,n.gradientX._elements),t.setBuffer(ei.VOLVELOCITYGRADIENTY,n.gradientY._elements),t.setBuffer(ei.VOLVELOCITYGRADIENTZ,n.gradientZ._elements);break;case 2:t.setVector3(ei.VOLVELOCITYCONST,n.constantMin),t.setVector3(ei.VOLVELOCITYCONSTMAX,n.constantMax);break;case 3:t.setBuffer(ei.VOLVELOCITYGRADIENTX,n.gradientXMin._elements),t.setBuffer(ei.VOLVELOCITYGRADIENTXMAX,n.gradientXMax._elements),t.setBuffer(ei.VOLVELOCITYGRADIENTY,n.gradientYMin._elements),t.setBuffer(ei.VOLVELOCITYGRADIENTYMAX,n.gradientYMax._elements),t.setBuffer(ei.VOLVELOCITYGRADIENTZ,n.gradientZMin._elements),t.setBuffer(ei.VOLVELOCITYGRADIENTZMAX,n.gradientZMax._elements)}t.setInt(ei.VOLSPACETYPE,e.space)}else t.removeDefine(ei.SHADERDEFINE_VELOCITYOVERLIFETIMECONSTANT),t.removeDefine(ei.SHADERDEFINE_VELOCITYOVERLIFETIMECURVE),t.removeDefine(ei.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCONSTANT),t.removeDefine(ei.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCURVE);this._velocityOverLifetime=e}},{key:"colorOverLifetime",get:function(){return this._colorOverLifetime},set:function(e){var t=this._owner._render._shaderValues;if(e){var n=e.color;if(e.enable)switch(n.type){case 1:t.addDefine(ei.SHADERDEFINE_COLOROVERLIFETIME);break;case 3:t.addDefine(ei.SHADERDEFINE_RANDOMCOLOROVERLIFETIME)}else t.removeDefine(ei.SHADERDEFINE_COLOROVERLIFETIME),t.removeDefine(ei.SHADERDEFINE_RANDOMCOLOROVERLIFETIME);switch(n.type){case 1:var i=n.gradient;t.setBuffer(ei.COLOROVERLIFEGRADIENTALPHAS,i._alphaElements),t.setBuffer(ei.COLOROVERLIFEGRADIENTCOLORS,i._rgbElements);break;case 3:var a=n.gradientMin,r=n.gradientMax;t.setBuffer(ei.COLOROVERLIFEGRADIENTALPHAS,a._alphaElements),t.setBuffer(ei.COLOROVERLIFEGRADIENTCOLORS,a._rgbElements),t.setBuffer(ei.MAXCOLOROVERLIFEGRADIENTALPHAS,r._alphaElements),t.setBuffer(ei.MAXCOLOROVERLIFEGRADIENTCOLORS,r._rgbElements)}}else t.removeDefine(ei.SHADERDEFINE_COLOROVERLIFETIME),t.removeDefine(ei.SHADERDEFINE_RANDOMCOLOROVERLIFETIME),t.setBuffer(ei.COLOROVERLIFEGRADIENTALPHAS,i._alphaElements),t.setBuffer(ei.COLOROVERLIFEGRADIENTCOLORS,i._rgbElements),t.setBuffer(ei.COLOROVERLIFEGRADIENTALPHAS,a._alphaElements),t.setBuffer(ei.COLOROVERLIFEGRADIENTCOLORS,a._rgbElements),t.setBuffer(ei.MAXCOLOROVERLIFEGRADIENTALPHAS,r._alphaElements),t.setBuffer(ei.MAXCOLOROVERLIFEGRADIENTCOLORS,r._rgbElements);this._colorOverLifetime=e}},{key:"sizeOverLifetime",get:function(){return this._sizeOverLifetime},set:function(e){var t=this._owner._render._shaderValues;if(e){var n=e.size,i=n.separateAxes,a=n.type;if(e.enable)switch(a){case 0:i?t.addDefine(ei.SHADERDEFINE_SIZEOVERLIFETIMECURVESEPERATE):t.addDefine(ei.SHADERDEFINE_SIZEOVERLIFETIMECURVE);break;case 2:i?t.addDefine(ei.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVESSEPERATE):t.addDefine(ei.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVES)}else t.removeDefine(ei.SHADERDEFINE_SIZEOVERLIFETIMECURVE),t.removeDefine(ei.SHADERDEFINE_SIZEOVERLIFETIMECURVESEPERATE),t.removeDefine(ei.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVES),t.removeDefine(ei.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVESSEPERATE);switch(a){case 0:i?(t.setBuffer(ei.SOLSIZEGRADIENTX,n.gradientX._elements),t.setBuffer(ei.SOLSIZEGRADIENTY,n.gradientY._elements),t.setBuffer(ei.SOLSizeGradientZ,n.gradientZ._elements)):t.setBuffer(ei.SOLSIZEGRADIENT,n.gradient._elements);break;case 2:i?(t.setBuffer(ei.SOLSIZEGRADIENTX,n.gradientXMin._elements),t.setBuffer(ei.SOLSIZEGRADIENTXMAX,n.gradientXMax._elements),t.setBuffer(ei.SOLSIZEGRADIENTY,n.gradientYMin._elements),t.setBuffer(ei.SOLSIZEGRADIENTYMAX,n.gradientYMax._elements),t.setBuffer(ei.SOLSizeGradientZ,n.gradientZMin._elements),t.setBuffer(ei.SOLSizeGradientZMAX,n.gradientZMax._elements)):(t.setBuffer(ei.SOLSIZEGRADIENT,n.gradientMin._elements),t.setBuffer(ei.SOLSizeGradientMax,n.gradientMax._elements))}}else t.removeDefine(ei.SHADERDEFINE_SIZEOVERLIFETIMECURVE),t.removeDefine(ei.SHADERDEFINE_SIZEOVERLIFETIMECURVESEPERATE),t.removeDefine(ei.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVES),t.removeDefine(ei.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVESSEPERATE);this._sizeOverLifetime=e}},{key:"rotationOverLifetime",get:function(){return this._rotationOverLifetime},set:function(e){var t=this._owner._render._shaderValues;if(e){var n=e.angularVelocity;if(!n)return;var i=n.separateAxes,a=n.type;if(e.enable)switch(i?t.addDefine(ei.SHADERDEFINE_ROTATIONOVERLIFETIMESEPERATE):t.addDefine(ei.SHADERDEFINE_ROTATIONOVERLIFETIME),a){case 0:t.addDefine(ei.SHADERDEFINE_ROTATIONOVERLIFETIMECONSTANT);break;case 1:t.addDefine(ei.SHADERDEFINE_ROTATIONOVERLIFETIMECURVE);break;case 2:t.addDefine(ei.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCONSTANTS);break;case 3:t.addDefine(ei.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCURVES)}else t.removeDefine(ei.SHADERDEFINE_ROTATIONOVERLIFETIME),t.removeDefine(ei.SHADERDEFINE_ROTATIONOVERLIFETIMESEPERATE),t.removeDefine(ei.SHADERDEFINE_ROTATIONOVERLIFETIMECONSTANT),t.removeDefine(ei.SHADERDEFINE_ROTATIONOVERLIFETIMECURVE),t.removeDefine(ei.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCONSTANTS),t.removeDefine(ei.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCURVES);switch(a){case 0:i?t.setVector3(ei.ROLANGULARVELOCITYCONSTSEPRARATE,n.constantSeparate):t.setNumber(ei.ROLANGULARVELOCITYCONST,n.constant);break;case 1:i?(t.setBuffer(ei.ROLANGULARVELOCITYGRADIENTX,n.gradientX._elements),t.setBuffer(ei.ROLANGULARVELOCITYGRADIENTY,n.gradientY._elements),t.setBuffer(ei.ROLANGULARVELOCITYGRADIENTZ,n.gradientZ._elements)):t.setBuffer(ei.ROLANGULARVELOCITYGRADIENT,n.gradient._elements);break;case 2:i?(t.setVector3(ei.ROLANGULARVELOCITYCONSTSEPRARATE,n.constantMinSeparate),t.setVector3(ei.ROLANGULARVELOCITYCONSTMAXSEPRARATE,n.constantMaxSeparate)):(t.setNumber(ei.ROLANGULARVELOCITYCONST,n.constantMin),t.setNumber(ei.ROLANGULARVELOCITYCONSTMAX,n.constantMax));break;case 3:i?(t.setBuffer(ei.ROLANGULARVELOCITYGRADIENTX,n.gradientXMin._elements),t.setBuffer(ei.ROLANGULARVELOCITYGRADIENTXMAX,n.gradientXMax._elements),t.setBuffer(ei.ROLANGULARVELOCITYGRADIENTY,n.gradientYMin._elements),t.setBuffer(ei.ROLANGULARVELOCITYGRADIENTYMAX,n.gradientYMax._elements),t.setBuffer(ei.ROLANGULARVELOCITYGRADIENTZ,n.gradientZMin._elements),t.setBuffer(ei.ROLANGULARVELOCITYGRADIENTZMAX,n.gradientZMax._elements)):(t.setBuffer(ei.ROLANGULARVELOCITYGRADIENT,n.gradientMin._elements),t.setBuffer(ei.ROLANGULARVELOCITYGRADIENTMAX,n.gradientMax._elements))}}else t.removeDefine(ei.SHADERDEFINE_ROTATIONOVERLIFETIME),t.removeDefine(ei.SHADERDEFINE_ROTATIONOVERLIFETIMESEPERATE),t.removeDefine(ei.SHADERDEFINE_ROTATIONOVERLIFETIMECONSTANT),t.removeDefine(ei.SHADERDEFINE_ROTATIONOVERLIFETIMECURVE),t.removeDefine(ei.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCONSTANTS),t.removeDefine(ei.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCURVES);this._rotationOverLifetime=e}},{key:"textureSheetAnimation",get:function(){return this._textureSheetAnimation},set:function(e){var t=this._owner._render._shaderValues;if(e){var n=e.frame,i=n.type;if(e.enable)switch(i){case 1:t.addDefine(ei.SHADERDEFINE_TEXTURESHEETANIMATIONCURVE);break;case 3:t.addDefine(ei.SHADERDEFINE_TEXTURESHEETANIMATIONRANDOMCURVE)}else t.removeDefine(ei.SHADERDEFINE_TEXTURESHEETANIMATIONCURVE),t.removeDefine(ei.SHADERDEFINE_TEXTURESHEETANIMATIONRANDOMCURVE);if(1===i||3===i){t.setNumber(ei.TEXTURESHEETANIMATIONCYCLES,e.cycles);var a=e.tiles,r=this._uvLength;r.x=1/a.x,r.y=1/a.y,t.setVector2(ei.TEXTURESHEETANIMATIONSUBUVLENGTH,this._uvLength)}switch(i){case 1:t.setBuffer(ei.TEXTURESHEETANIMATIONGRADIENTUVS,n.frameOverTimeData._elements);break;case 3:t.setBuffer(ei.TEXTURESHEETANIMATIONGRADIENTUVS,n.frameOverTimeDataMin._elements),t.setBuffer(ei.TEXTURESHEETANIMATIONGRADIENTMAXUVS,n.frameOverTimeDataMax._elements)}}else t.removeDefine(ei.SHADERDEFINE_TEXTURESHEETANIMATIONCURVE),t.removeDefine(ei.SHADERDEFINE_TEXTURESHEETANIMATIONRANDOMCURVE);this._textureSheetAnimation=e}},{key:"customBounds",get:function(){return this._customBounds},set:function(e){this._useCustomBounds=!!e,this._customBounds=e}}]),ShurikenParticleSystem}();ui._RANDOMOFFSET=new Uint32Array([592910910,3276756734,322376503,306581307,1793934638,3737431713,2527743459,2368504881,4085612399,3774601268,326370691,1494990940,1089181156,3159510623,2941263940,2786374529,271901988,4233252447]),ui.halfKSqrtOf2=.71,ui.g=9.8,ui._maxElapsedTime=1/3,ui._tempVector30=new o,ui._tempVector31=new o,ui._tempVector32=new o,ui._tempVector33=new o,ui._tempVector34=new o,ui._tempVector35=new o,ui._tempVector36=new o,ui._tempVector37=new o,ui._tempPosition=new o,ui._tempDirection=new o,ui._type=Vt._typeCounter++;var ci=function(e){function ShuriKenParticle3D(){var e;_classCallCheck(this,ShuriKenParticle3D),(e=_possibleConstructorReturn(this,_getPrototypeOf(ShuriKenParticle3D).call(this,null)))._render=new ni(_assertThisInitialized(e)),e._particleSystem=new ui(_assertThisInitialized(e));var t=e._render._renderElements[0]=new qe;return t.setTransform(e._transform),t.render=e._render,t.setGeometry(e._particleSystem),t.material=ti.defaultMaterial,e}return _inherits(ShuriKenParticle3D,Gt),_createClass(ShuriKenParticle3D,[{key:"_parseModule",value:function(e,n){for(var i in n)switch(i){case"bases":var a=n.bases;for(var r in a)e[r]=a[r];break;case"vector2s":var o=n.vector2s;for(var r in o){var s=e[r],l=o[r];s.setValue(l[0],l[1]),e[r]=s}break;case"vector3s":var u=n.vector3s;for(var r in u){var c=e[r],h=u[r];c.setValue(h[0],h[1],h[2]),e[r]=c}break;case"vector4s":var _=n.vector4s;for(var r in _){var d=e[r],f=_[r];d.setValue(f[0],f[1],f[2],f[3]),e[r]=d}break;case"gradientDataNumbers":var m=n.gradientDataNumbers;for(var r in m){for(var p=e[r],T=n[r],v=0,g=T.length;v<g;v++){var E=T[v];p.add(E.key,E.value)}e[r]=p}break;case"resources":var y=n.resources;for(var r in y)e[r]=t.Loader.getRes(y[r]);break;case"bursts":var S=n.bursts;for(v=0,g=S.length;v<g;v++){var R=S[v];e.addBurst(new Nn(R.time,R.min,R.max))}break;case"randomSeed":e.randomSeed[0]=n.randomSeed;break;case"shapeType":case"type":case"color":case"size":case"frame":case"startFrame":case"angularVelocity":case"velocity":break;default:throw"ShurikenParticle3D:unknown type."}}},{key:"_parse",value:function(e,t){if(_get(_getPrototypeOf(ShuriKenParticle3D.prototype),"_parse",this).call(this,e,t),e.main){var n=this.particleSystem,i=this.particleRenderer;this._parseModule(i,e.renderer),this._parseModule(n,e.main),this._parseModule(n.emission,e.emission);var r=e.shape;if(r){var s;switch(r.shapeType){case 0:s=new Qn;break;case 1:s=new Zn;break;case 2:s=new jn;break;case 3:s=new Xn;break;case 7:s=new Yn;break;default:throw"ShuriKenParticle3D:unknown shape type."}this._parseModule(s,r),n.shape=s}var l=e.velocityOverLifetime;if(l){var u,c=l.velocity;switch(c.type){case 0:var h=c.constant;u=Gn.createByConstant(h?new o(h[0],h[1],h[2]):new o(0,0,0));break;case 1:u=Gn.createByGradient(this._initParticleVelocity(c.gradientX),this._initParticleVelocity(c.gradientY),this._initParticleVelocity(c.gradientZ));break;case 2:var _=c.constantMin,d=c.constantMax;u=Gn.createByRandomTwoConstant(_?new o(_[0],_[1],_[2]):new o(0,0,0),d?new o(d[0],d[1],d[2]):new o(0,0,0));break;case 3:u=Gn.createByRandomTwoGradient(this._initParticleVelocity(c.gradientXMin),this._initParticleVelocity(c.gradientXMax),this._initParticleVelocity(c.gradientYMin),this._initParticleVelocity(c.gradientYMax),this._initParticleVelocity(c.gradientZMin),this._initParticleVelocity(c.gradientZMax))}var f=new $n(u);this._parseModule(f,l),n.velocityOverLifetime=f}var m=e.colorOverLifetime;if(m){var p,T=m.color;switch(T.type){case 0:var v=T.constant;p=bn.createByConstant(v?new a(v[0],v[1],v[2],v[3]):new a(0,0,0,0));break;case 1:p=bn.createByGradient(this._initParticleColor(T.gradient));break;case 2:var g=T.constantMin,E=T.constantMax;p=bn.createByRandomTwoConstant(g?new a(g[0],g[1],g[2],g[3]):new a(0,0,0,0),g?new a(E[0],E[1],E[2],E[3]):new a(0,0,0,0));break;case 3:p=bn.createByRandomTwoGradient(this._initParticleColor(T.gradientMin),this._initParticleColor(T.gradientMax))}var y=new kn(p);this._parseModule(y,m),n.colorOverLifetime=y}var S=e.sizeOverLifetime;if(S){var R,C=S.size;switch(C.type){case 0:R=C.separateAxes?Un.createByGradientSeparate(this._initParticleSize(C.gradientX),this._initParticleSize(C.gradientY),this._initParticleSize(C.gradientZ)):Un.createByGradient(this._initParticleSize(C.gradient));break;case 1:if(C.separateAxes){var M=C.constantMinSeparate,D=C.constantMaxSeparate;R=Un.createByRandomTwoConstantSeparate(M?new o(M[0],M[1],M[2]):new o(0,0,0),D?new o(D[0],D[1],D[2]):new o(0,0,0))}else R=Un.createByRandomTwoConstant(C.constantMin||0,C.constantMax||0);break;case 2:R=C.separateAxes?Un.createByRandomTwoGradientSeparate(this._initParticleSize(C.gradientXMin),this._initParticleSize(C.gradientYMin),this._initParticleSize(C.gradientZMin),this._initParticleSize(C.gradientXMax),this._initParticleSize(C.gradientYMax),this._initParticleSize(C.gradientZMax)):Un.createByRandomTwoGradient(this._initParticleSize(C.gradientMin),this._initParticleSize(C.gradientMax))}var x=new qn(R);this._parseModule(x,S),n.sizeOverLifetime=x}var A=e.rotationOverLifetime;if(A){var I,L=A.angularVelocity;switch(L.type){case 0:if(L.separateAxes){var P=L.constantSeparate;I=Bn.createByConstantSeparate(P?new o(P[0],P[1],P[2]):new o(0,0,Math.PI/4))}else I=Bn.createByConstant(L.constant||Math.PI/4);break;case 1:I=L.separateAxes?Bn.createByGradientSeparate(this._initParticleRotation(L.gradientX),this._initParticleRotation(L.gradientY),this._initParticleRotation(L.gradientZ)):Bn.createByGradient(this._initParticleRotation(L.gradient));break;case 2:if(L.separateAxes){var O=L.constantMinSeparate,N=L.constantMaxSeparate;I=Bn.createByRandomTwoConstantSeparate(O?new o(O[0],O[1],O[2]):new o(0,0,0),N?new o(N[0],N[1],N[2]):new o(0,0,Math.PI/4))}else I=Bn.createByRandomTwoConstant(L.constantMin||0,L.constantMax||Math.PI/4);break;case 3:L.separateAxes||(I=Bn.createByRandomTwoGradient(this._initParticleRotation(L.gradientMin),this._initParticleRotation(L.gradientMax)))}var b=new Hn(I);this._parseModule(b,A),n.rotationOverLifetime=b}var k=e.textureSheetAnimation;if(k){var w,B=k.frame;switch(B.type){case 0:w=wn.createByConstant(B.constant);break;case 1:w=wn.createByOverTime(this._initParticleFrame(B.overTime));break;case 2:w=wn.createByRandomTwoConstant(B.constantMin,B.constantMax);break;case 3:w=wn.createByRandomTwoOverTime(this._initParticleFrame(B.overTimeMin),this._initParticleFrame(B.overTimeMax))}var V,F=k.startFrame;switch(F.type){case 0:V=Kn.createByConstant(F.constant);break;case 1:V=Kn.createByRandomTwoConstant(F.constantMin,F.constantMax)}var U=new Jn(w,V);this._parseModule(U,k),n.textureSheetAnimation=U}}else this._parseOld(e)}},{key:"_activeHierarchy",value:function(e){_get(_getPrototypeOf(ShuriKenParticle3D.prototype),"_activeHierarchy",this).call(this,e),this.particleSystem.playOnAwake&&this.particleSystem.play()}},{key:"_inActiveHierarchy",value:function(e){_get(_getPrototypeOf(ShuriKenParticle3D.prototype),"_inActiveHierarchy",this).call(this,e),this.particleSystem.isAlive&&this.particleSystem.simulate(0,!0)}},{key:"_cloneTo",value:function(e,t,n){var i=e,a=i._particleSystem;this._particleSystem.cloneTo(a);var r=i._render,o=this._render;r.sharedMaterials=o.sharedMaterials,r.enable=o.enable,r.renderMode=o.renderMode,r.mesh=o.mesh,r.stretchedBillboardCameraSpeedScale=o.stretchedBillboardCameraSpeedScale,r.stretchedBillboardSpeedScale=o.stretchedBillboardSpeedScale,r.stretchedBillboardLengthScale=o.stretchedBillboardLengthScale,r.sortingFudge=o.sortingFudge,_get(_getPrototypeOf(ShuriKenParticle3D.prototype),"_cloneTo",this).call(this,e,t,n)}},{key:"destroy",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];this.destroyed||(_get(_getPrototypeOf(ShuriKenParticle3D.prototype),"destroy",this).call(this,e),this._particleSystem.destroy(),this._particleSystem=null)}},{key:"_create",value:function(){return new ShuriKenParticle3D}},{key:"_parseOld",value:function(e){var n,r,s,l=Math.PI/180,u=this.particleRenderer,c=e.material;c&&(s=t.Loader.getRes(c.path)),u.sharedMaterial=s;var h=e.meshPath;h&&(u.mesh=t.Loader.getRes(h)),u.renderMode=e.renderMode,u.stretchedBillboardCameraSpeedScale=e.stretchedBillboardCameraSpeedScale,u.stretchedBillboardSpeedScale=e.stretchedBillboardSpeedScale,u.stretchedBillboardLengthScale=e.stretchedBillboardLengthScale,u.sortingFudge=e.sortingFudge?e.sortingFudge:0;var _=this.particleSystem;_.isPerformanceMode=e.isPerformanceMode,_.duration=e.duration,_.looping=e.looping,_.prewarm=e.prewarm,_.startDelayType=e.startDelayType,_.startDelay=e.startDelay,_.startDelayMin=e.startDelayMin,_.startDelayMax=e.startDelayMax,_.startLifetimeType=e.startLifetimeType,_.startLifetimeConstant=e.startLifetimeConstant,_.startLifeTimeGradient=ShuriKenParticle3D._initStartLife(e.startLifetimeGradient),_.startLifetimeConstantMin=e.startLifetimeConstantMin,_.startLifetimeConstantMax=e.startLifetimeConstantMax,_.startLifeTimeGradientMin=ShuriKenParticle3D._initStartLife(e.startLifetimeGradientMin),_.startLifeTimeGradientMax=ShuriKenParticle3D._initStartLife(e.startLifetimeGradientMax),_.startSpeedType=e.startSpeedType,_.startSpeedConstant=e.startSpeedConstant,_.startSpeedConstantMin=e.startSpeedConstantMin,_.startSpeedConstantMax=e.startSpeedConstantMax,_.threeDStartSize=e.threeDStartSize,_.startSizeType=e.startSizeType,_.startSizeConstant=e.startSizeConstant;var d=e.startSizeConstantSeparate,f=_.startSizeConstantSeparate;f.x=d[0],f.y=d[1],f.z=d[2],_.startSizeConstantMin=e.startSizeConstantMin,_.startSizeConstantMax=e.startSizeConstantMax;var m=e.startSizeConstantMinSeparate,p=_.startSizeConstantMinSeparate;p.x=m[0],p.y=m[1],p.z=m[2];var T=e.startSizeConstantMaxSeparate,v=_.startSizeConstantMaxSeparate;v.x=T[0],v.y=T[1],v.z=T[2],_.threeDStartRotation=e.threeDStartRotation,_.startRotationType=e.startRotationType,_.startRotationConstant=e.startRotationConstant*l;var g=e.startRotationConstantSeparate,E=_.startRotationConstantSeparate;E.x=g[0]*l,E.y=g[1]*l,E.z=g[2]*l,_.startRotationConstantMin=e.startRotationConstantMin*l,_.startRotationConstantMax=e.startRotationConstantMax*l;var y=e.startRotationConstantMinSeparate,S=_.startRotationConstantMinSeparate;S.x=y[0]*l,S.y=y[1]*l,S.z=y[2]*l;var R=e.startRotationConstantMaxSeparate,C=_.startRotationConstantMaxSeparate;C.x=R[0]*l,C.y=R[1]*l,C.z=R[2]*l,_.randomizeRotationDirection=e.randomizeRotationDirection,_.startColorType=e.startColorType;var M=e.startColorConstant,D=_.startColorConstant;D.x=M[0],D.y=M[1],D.z=M[2],D.w=M[3];var x=e.startColorConstantMin,A=_.startColorConstantMin;A.x=x[0],A.y=x[1],A.z=x[2],A.w=x[3];var I=e.startColorConstantMax,L=_.startColorConstantMax;L.x=I[0],L.y=I[1],L.z=I[2],L.w=I[3],_.gravityModifier=e.gravityModifier,_.simulationSpace=e.simulationSpace,void 0!==e.simulationSpeed&&(_.simulationSpeed=e.simulationSpeed),_.scaleMode=e.scaleMode,_.playOnAwake=e.playOnAwake,_.maxParticles=e.maxParticles;var P=e.autoRandomSeed;null!=P&&(_.autoRandomSeed=P);var O=e.randomSeed;null!=O&&(_.randomSeed[0]=O);var N=e.emission,b=_.emission;if(N){b.emissionRate=N.emissionRate;var k=N.bursts;if(k)for(n=0,r=k.length;n<r;n++){var w=k[n];b.addBurst(new Nn(w.time,w.min,w.max))}b.enable=N.enable}else b.enable=!1;var B=e.shape;if(B){var V;switch(B.shapeType){case 0:var F;V=F=new Qn,F.radius=B.sphereRadius,F.emitFromShell=B.sphereEmitFromShell,F.randomDirection=B.sphereRandomDirection;break;case 1:var U;V=U=new Zn,U.radius=B.hemiSphereRadius,U.emitFromShell=B.hemiSphereEmitFromShell,U.randomDirection=B.hemiSphereRandomDirection;break;case 2:var G;V=G=new jn,G.angle=B.coneAngle*l,G.radius=B.coneRadius,G.length=B.coneLength,G.emitType=B.coneEmitType,G.randomDirection=B.coneRandomDirection;break;case 3:var H;V=H=new Xn,H.x=B.boxX,H.y=B.boxY,H.z=B.boxZ,H.randomDirection=B.boxRandomDirection;break;case 7:var z;V=z=new Yn,z.radius=B.circleRadius,z.arc=B.circleArc*l,z.emitFromEdge=B.circleEmitFromEdge,z.randomDirection=B.circleRandomDirection;break;default:var W;V=W=new Yn,W.radius=B.circleRadius,W.arc=B.circleArc*l,W.emitFromEdge=B.circleEmitFromEdge,W.randomDirection=B.circleRandomDirection}V.enable=B.enable,_.shape=V}var X=e.velocityOverLifetime;if(X){var Y,j=X.velocity;switch(j.type){case 0:var Z=j.constant;Y=Gn.createByConstant(new o(Z[0],Z[1],Z[2]));break;case 1:Y=Gn.createByGradient(this._initParticleVelocity(j.gradientX),this._initParticleVelocity(j.gradientY),this._initParticleVelocity(j.gradientZ));break;case 2:var Q=j.constantMin,q=j.constantMax;Y=Gn.createByRandomTwoConstant(new o(Q[0],Q[1],Q[2]),new o(q[0],q[1],q[2]));break;case 3:Y=Gn.createByRandomTwoGradient(this._initParticleVelocity(j.gradientXMin),this._initParticleVelocity(j.gradientXMax),this._initParticleVelocity(j.gradientYMin),this._initParticleVelocity(j.gradientYMax),this._initParticleVelocity(j.gradientZMin),this._initParticleVelocity(j.gradientZMax))}var K=new $n(Y);K.space=X.space,K.enable=X.enable,_.velocityOverLifetime=K}var J=e.colorOverLifetime;if(J){var $,ee=J.color;switch(ee.type){case 0:var te=ee.constant;$=bn.createByConstant(new a(te[0],te[1],te[2],te[3]));break;case 1:$=bn.createByGradient(this._initParticleColor(ee.gradient));break;case 2:var ne=ee.constantMin,ie=ee.constantMax;$=bn.createByRandomTwoConstant(new a(ne[0],ne[1],ne[2],ne[3]),new a(ie[0],ie[1],ie[2],ie[3]));break;case 3:$=bn.createByRandomTwoGradient(this._initParticleColor(ee.gradientMin),this._initParticleColor(ee.gradientMax))}var ae=new kn($);ae.enable=J.enable,_.colorOverLifetime=ae}var re=e.sizeOverLifetime;if(re){var oe,se=re.size;switch(se.type){case 0:oe=se.separateAxes?Un.createByGradientSeparate(this._initParticleSize(se.gradientX),this._initParticleSize(se.gradientY),this._initParticleSize(se.gradientZ)):Un.createByGradient(this._initParticleSize(se.gradient));break;case 1:if(se.separateAxes){var le=se.constantMinSeparate,ue=se.constantMaxSeparate;oe=Un.createByRandomTwoConstantSeparate(new o(le[0],le[1],le[2]),new o(ue[0],ue[1],ue[2]))}else oe=Un.createByRandomTwoConstant(se.constantMin,se.constantMax);break;case 2:oe=se.separateAxes?Un.createByRandomTwoGradientSeparate(this._initParticleSize(se.gradientXMin),this._initParticleSize(se.gradientYMin),this._initParticleSize(se.gradientZMin),this._initParticleSize(se.gradientXMax),this._initParticleSize(se.gradientYMax),this._initParticleSize(se.gradientZMax)):Un.createByRandomTwoGradient(this._initParticleSize(se.gradientMin),this._initParticleSize(se.gradientMax))}var ce=new qn(oe);ce.enable=re.enable,_.sizeOverLifetime=ce}var he=e.rotationOverLifetime;if(he){var _e,de=he.angularVelocity;switch(de.type){case 0:if(de.separateAxes){var fe=de.constantSeparate;_e=Bn.createByConstantSeparate(new o(fe[0]*l,fe[1]*l,fe[2]*l))}else _e=Bn.createByConstant(de.constant*l);break;case 1:_e=de.separateAxes?Bn.createByGradientSeparate(this._initParticleRotation(de.gradientX),this._initParticleRotation(de.gradientY),this._initParticleRotation(de.gradientZ)):Bn.createByGradient(this._initParticleRotation(de.gradient));break;case 2:if(de.separateAxes){var me=de.constantMinSeparate,pe=de.constantMaxSeparate;_e=Bn.createByRandomTwoConstantSeparate(new o(me[0]*l,me[1]*l,me[2]*l),new o(pe[0]*l,pe[1]*l,pe[2]*l))}else _e=Bn.createByRandomTwoConstant(de.constantMin*l,de.constantMax*l);break;case 3:de.separateAxes||(_e=Bn.createByRandomTwoGradient(this._initParticleRotation(de.gradientMin),this._initParticleRotation(de.gradientMax)))}var Te=new Hn(_e);Te.enable=he.enable,_.rotationOverLifetime=Te}var ve=e.textureSheetAnimation;if(ve){var ge,Ee=ve.frame;switch(Ee.type){case 0:ge=wn.createByConstant(Ee.constant);break;case 1:ge=wn.createByOverTime(this._initParticleFrame(Ee.overTime));break;case 2:ge=wn.createByRandomTwoConstant(Ee.constantMin,Ee.constantMax);break;case 3:ge=wn.createByRandomTwoOverTime(this._initParticleFrame(Ee.overTimeMin),this._initParticleFrame(Ee.overTimeMax))}var ye,Se=ve.startFrame;switch(Se.type){case 0:ye=Kn.createByConstant(Se.constant);break;case 1:ye=Kn.createByRandomTwoConstant(Se.constantMin,Se.constantMax)}var Re=new Jn(ge,ye);Re.enable=ve.enable;var Ce=ve.tiles;Re.tiles=new i(Ce[0],Ce[1]),Re.type=ve.type,Re.randomRow=ve.randomRow;var Me=ve.rowIndex;void 0!==Me&&(Re.rowIndex=Me),Re.cycles=ve.cycles,_.textureSheetAnimation=Re}}},{key:"_initParticleColor",value:function(e){var t=new On(4,4);if(e){var n,i,a=e.alphas;if(a)for(n=0,i=a.length;n<i;n++){3==n&&i>4&&(n=i-1,console.warn("GradientDataColor warning:alpha data length is large than 4, will ignore the middle data."));var r=a[n];t.addColorAlpha(r.key,r.value)}else t.addColorAlpha(0,1),t.addColorAlpha(1,1);var o=e.rgbs;if(o)for(n=0,i=o.length;n<i;n++){3==n&&i>4&&(n=i-1,console.warn("GradientDataColor warning:rgb data length is large than 4, will ignore the middle data."));var s=o[n],l=s.value;t.addColorRGB(s.key,new Et(l[0],l[1],l[2],1))}else t.addColorRGB(0,new Et(1,1,1,1)),t.addColorRGB(1,new Et(1,1,1,1))}else t.addColorAlpha(0,1),t.addColorAlpha(1,1),t.addColorRGB(0,new Et(1,1,1,1)),t.addColorRGB(1,new Et(1,1,1,1));return t}},{key:"_initParticleFrame",value:function(e){var t=new Vn;if(e)for(var n=e.frames,i=0,a=n.length;i<a;i++){var r=n[i];t.add(r.key,r.value)}else t.add(0,0),t.add(1,1);return t}},{key:"_initParticleVelocity",value:function(e){for(var t=new Fn,n=e.velocitys,i=0,a=n.length;i<a;i++){var r=n[i];t.add(r.key,r.value)}return t}},{key:"_initParticleSize",value:function(e){var t=new Fn;if(e)for(var n=e.sizes,i=0,a=n.length;i<a;i++){var r=n[i];t.add(r.key,r.value)}else t.add(0,0),t.add(1,1);return t}},{key:"_initParticleRotation",value:function(e){for(var t=new Fn,n=e.angularVelocitys,i=0,a=n.length;i<a;i++){var r=n[i];t.add(r.key,r.value/180*Math.PI)}return t}},{key:"particleSystem",get:function(){return this._particleSystem}},{key:"particleRenderer",get:function(){return this._render}}],[{key:"__init__",value:function(){ei.SHADERDEFINE_RENDERMODE_BILLBOARD=_e.getDefineByName("SPHERHBILLBOARD"),ei.SHADERDEFINE_RENDERMODE_STRETCHEDBILLBOARD=_e.getDefineByName("STRETCHEDBILLBOARD"),ei.SHADERDEFINE_RENDERMODE_HORIZONTALBILLBOARD=_e.getDefineByName("HORIZONTALBILLBOARD"),ei.SHADERDEFINE_RENDERMODE_VERTICALBILLBOARD=_e.getDefineByName("VERTICALBILLBOARD"),ei.SHADERDEFINE_COLOROVERLIFETIME=_e.getDefineByName("COLOROVERLIFETIME"),ei.SHADERDEFINE_RANDOMCOLOROVERLIFETIME=_e.getDefineByName("RANDOMCOLOROVERLIFETIME"),ei.SHADERDEFINE_VELOCITYOVERLIFETIMECONSTANT=_e.getDefineByName("VELOCITYOVERLIFETIMECONSTANT"),ei.SHADERDEFINE_VELOCITYOVERLIFETIMECURVE=_e.getDefineByName("VELOCITYOVERLIFETIMECURVE"),ei.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCONSTANT=_e.getDefineByName("VELOCITYOVERLIFETIMERANDOMCONSTANT"),ei.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCURVE=_e.getDefineByName("VELOCITYOVERLIFETIMERANDOMCURVE"),ei.SHADERDEFINE_TEXTURESHEETANIMATIONCURVE=_e.getDefineByName("TEXTURESHEETANIMATIONCURVE"),ei.SHADERDEFINE_TEXTURESHEETANIMATIONRANDOMCURVE=_e.getDefineByName("TEXTURESHEETANIMATIONRANDOMCURVE"),ei.SHADERDEFINE_ROTATIONOVERLIFETIME=_e.getDefineByName("ROTATIONOVERLIFETIME"),ei.SHADERDEFINE_ROTATIONOVERLIFETIMESEPERATE=_e.getDefineByName("ROTATIONOVERLIFETIMESEPERATE"),ei.SHADERDEFINE_ROTATIONOVERLIFETIMECONSTANT=_e.getDefineByName("ROTATIONOVERLIFETIMECONSTANT"),ei.SHADERDEFINE_ROTATIONOVERLIFETIMECURVE=_e.getDefineByName("ROTATIONOVERLIFETIMECURVE"),ei.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCONSTANTS=_e.getDefineByName("ROTATIONOVERLIFETIMERANDOMCONSTANTS"),ei.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCURVES=_e.getDefineByName("ROTATIONOVERLIFETIMERANDOMCURVES"),ei.SHADERDEFINE_SIZEOVERLIFETIMECURVE=_e.getDefineByName("SIZEOVERLIFETIMECURVE"),ei.SHADERDEFINE_SIZEOVERLIFETIMECURVESEPERATE=_e.getDefineByName("SIZEOVERLIFETIMECURVESEPERATE"),ei.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVES=_e.getDefineByName("SIZEOVERLIFETIMERANDOMCURVES"),ei.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVESSEPERATE=_e.getDefineByName("SIZEOVERLIFETIMERANDOMCURVESSEPERATE"),ei.SHADERDEFINE_RENDERMODE_MESH=_e.getDefineByName("RENDERMODE_MESH"),ei.SHADERDEFINE_SHAPE=_e.getDefineByName("SHAPE")}},{key:"_initStartLife",value:function(e){for(var t=new Fn,n=e.startLifetimes,i=0,a=n.length;i<a;i++){var r=n[i];t.add(r.key,r.value)}return t}}]),ShuriKenParticle3D}(),hi=function SkinnedMeshSprite3DShaderDeclaration(){_classCallCheck(this,SkinnedMeshSprite3DShaderDeclaration)},_i=function(n){function SkinnedMeshRenderer(e){var t;return _classCallCheck(this,SkinnedMeshRenderer),(t=_possibleConstructorReturn(this,_getPrototypeOf(SkinnedMeshRenderer).call(this,e)))._bones=[],t._skinnedDataLoopMarks=[],t._localBounds=new Bt(o._ZERO,o._ZERO),t._cacheAnimationNode=[],t}return _inherits(SkinnedMeshRenderer,Mn),_createClass(SkinnedMeshRenderer,[{key:"_computeSkinnedData",value:function(){if(this._cacheMesh&&this._cacheAvatar||this._cacheMesh&&!this._cacheAvatar)for(var e=this._cacheMesh._inverseBindPoses,t=this._cacheMesh._skinnedMatrixCaches,n=0,i=this._cacheMesh.subMeshCount;n<i;n++)for(var a=this._cacheMesh.getSubMesh(n)._boneIndicesList,r=this._skinnedData[n],o=0,s=a.length;o<s;o++){var l=a[o];this._computeSubSkinnedData(e,l,r[o],t)}}},{key:"_computeSubSkinnedData",value:function(e,n,i,a){for(var r=0,o=n.length;r<o;r++){var s=n[r];if(this._skinnedDataLoopMarks[s]===t.Stat.loopCount)for(var l=a[s],u=this._skinnedData[l.subMeshIndex][l.batchIndex],c=16*l.batchBoneIndex,h=16*r,_=0;_<16;_++)i[h+_]=u[c+_];else this._cacheAvatar?P._mulMatrixArray(this._cacheAnimationNode[s].transform.getWorldMatrix(),e[s].elements,0,i,16*r):P._mulMatrixArray(this._bones[s].transform.worldMatrix.elements,e[s].elements,0,i,16*r),this._skinnedDataLoopMarks[s]=t.Stat.loopCount}}},{key:"_onWorldMatNeedChange",value:function(e){this._boundsChange=!0,this._octreeNode&&(this._cacheAvatar?-1===this._indexInOctreeMotionList&&this._octreeNode._octree.addMotionObject(this):(e&=f.TRANSFORM_WORLDPOSITION|f.TRANSFORM_WORLDQUATERNION|f.TRANSFORM_WORLDSCALE)&&-1===this._indexInOctreeMotionList&&this._octreeNode._octree.addMotionObject(this))}},{key:"_createRenderElement",value:function(){return new qe}},{key:"_onMeshChange",value:function(e){_get(_getPrototypeOf(SkinnedMeshRenderer.prototype),"_onMeshChange",this).call(this,e),this._cacheMesh=e;var t=e.subMeshCount;this._skinnedData=[],this._skinnedDataLoopMarks.length=e._inverseBindPoses.length;for(var n=0;n<t;n++)for(var i=e.getSubMesh(n)._boneIndicesList,a=i.length,r=this._skinnedData[n]=[],o=0;o<a;o++)r[o]=new Float32Array(16*i[o].length);this._cacheAvatar&&e&&this._getCacheAnimationNodes()}},{key:"_setCacheAnimator",value:function(e){this._cacheAnimator=e,this._shaderValues.addDefine(hi.SHADERDEFINE_BONE),this._setRootNode()}},{key:"_calculateBoundingBox",value:function(){if(this._cacheAvatar)if(this._cacheAnimator&&this._rootBone){var e=SkinnedMeshRenderer._tempMatrix4x4;P.matrix4x4MultiplyMFM(this._cacheAnimator.owner.transform.worldMatrix,this._cacheRootAnimationNode.transform.getWorldMatrix(),e),this._localBounds._tranform(e,this._bounds)}else _get(_getPrototypeOf(SkinnedMeshRenderer.prototype),"_calculateBoundingBox",this).call(this);else this._cacheRootBone?this._localBounds._tranform(this._cacheRootBone.transform.worldMatrix,this._bounds):this._localBounds._tranform(this._owner.transform.worldMatrix,this._bounds)}},{key:"_renderUpdate",value:function(t,n){if(this._cacheAnimator)if(this._computeSkinnedData(),this._cacheAvatar){var i=this._cacheAnimator.owner._transform;this._shaderValues.setMatrix4x4(ve.WORLDMATRIX,i.worldMatrix)}else this._shaderValues.setMatrix4x4(ve.WORLDMATRIX,c.DEFAULT);else this._shaderValues.setMatrix4x4(ve.WORLDMATRIX,n.worldMatrix);this._probReflection&&(this._reflectionMode==e.ReflectionProbeMode.off?(this._shaderValues.removeDefine($e.SHADERDEFINE_SPECCUBE_BOX_PROJECTION),this._shaderValues.setVector(Gt.REFLECTIONCUBE_HDR_PARAMS,Qt.defaultTextureHDRDecodeValues),this._shaderValues.setTexture(Gt.REFLECTIONTEXTURE,Ot.blackTexture)):(this._probReflection.boxProjection?(this._shaderValues.addDefine($e.SHADERDEFINE_SPECCUBE_BOX_PROJECTION),this._shaderValues.setVector3(Gt.REFLECTIONCUBE_PROBEPOSITION,this._probReflection.probePosition),this._shaderValues.setVector3(Gt.REFLECTIONCUBE_PROBEBOXMAX,this._probReflection.boundsMax),this._shaderValues.setVector3(Gt.REFLECTIONCUBE_PROBEBOXMIN,this._probReflection.boundsMin)):this._shaderValues.removeDefine($e.SHADERDEFINE_SPECCUBE_BOX_PROJECTION),this._shaderValues.setTexture(Gt.REFLECTIONTEXTURE,this._probReflection.reflectionTexture),this._shaderValues.setVector(Gt.REFLECTIONCUBE_HDR_PARAMS,this._probReflection.reflectionHDRParams)))}},{key:"_renderUpdateWithCamera",value:function(e,t){var n=e.projectionViewMatrix;if(this._cacheAnimator)if(this._cacheAvatar){var i=this._cacheAnimator.owner._transform;c.multiply(n,i.worldMatrix,this._projectionViewWorldMatrix),this._shaderValues.setMatrix4x4(ve.MVPMATRIX,this._projectionViewWorldMatrix)}else this._shaderValues.setMatrix4x4(ve.MVPMATRIX,n);else c.multiply(n,t.worldMatrix,this._projectionViewWorldMatrix),this._shaderValues.setMatrix4x4(ve.MVPMATRIX,this._projectionViewWorldMatrix)}},{key:"_destroy",value:function(){_get(_getPrototypeOf(SkinnedMeshRenderer.prototype),"_destroy",this).call(this),this._cacheAvatar?this._cacheRootAnimationNode&&this._cacheRootAnimationNode.transform.off(t.Event.TRANSFORM_CHANGED,this,this._onWorldMatNeedChange):this._cacheRootBone?!this._cacheRootBone.destroyed&&this._cacheRootBone.transform.off(t.Event.TRANSFORM_CHANGED,this,this._onWorldMatNeedChange):this._owner&&!this._owner.destroyed&&this._owner.transform.off(t.Event.TRANSFORM_CHANGED,this,this._onWorldMatNeedChange)}},{key:"_setRootBone",value:function(e){this._rootBone=e,this._setRootNode()}},{key:"_setRootNode",value:function(){var e;e=this._cacheAnimator&&this._rootBone&&this._cacheAvatar?this._cacheAnimator._avatarNodeMap[this._rootBone]:null,this._cacheRootAnimationNode!=e&&(this._onWorldMatNeedChange(f.TRANSFORM_WORLDPOSITION|f.TRANSFORM_WORLDQUATERNION|f.TRANSFORM_WORLDSCALE),this._owner.transform.off(t.Event.TRANSFORM_CHANGED,this,this._onWorldMatNeedChange),this._cacheRootAnimationNode&&this._cacheRootAnimationNode.transform.off(t.Event.TRANSFORM_CHANGED,this,this._onWorldMatNeedChange),e&&e.transform.on(t.Event.TRANSFORM_CHANGED,this,this._onWorldMatNeedChange),this._cacheRootAnimationNode=e)}},{key:"_getCacheAnimationNodes",value:function(){var e=this._cacheMesh._boneNames,t=this._cacheMesh._inverseBindPoses.length;this._cacheAnimationNode.length=t;for(var n=this._cacheAnimator._avatarNodeMap,i=0;i<t;i++){var a=n[e[i]];this._cacheAnimationNode[i]=a}}},{key:"_setCacheAvatar",value:function(e){this._cacheAvatar!==e&&(this._cacheMesh?(this._cacheAvatar=e,e&&(this._shaderValues.addDefine(hi.SHADERDEFINE_BONE),this._getCacheAnimationNodes())):this._cacheAvatar=e,this._setRootNode())}},{key:"localBounds",get:function(){return this._localBounds},set:function(e){this._localBounds=e}},{key:"rootBone",get:function(){return this._cacheRootBone},set:function(e){this._cacheRootBone!=e&&(this._cacheRootBone?this._cacheRootBone.transform.off(t.Event.TRANSFORM_CHANGED,this,this._onWorldMatNeedChange):this._owner.transform.off(t.Event.TRANSFORM_CHANGED,this,this._onWorldMatNeedChange),e?e.transform.on(t.Event.TRANSFORM_CHANGED,this,this._onWorldMatNeedChange):this._owner.transform.on(t.Event.TRANSFORM_CHANGED,this,this._onWorldMatNeedChange),this._cacheRootBone=e,this._onWorldMatNeedChange(f.TRANSFORM_WORLDPOSITION|f.TRANSFORM_WORLDQUATERNION|f.TRANSFORM_WORLDSCALE))}},{key:"bones",get:function(){return this._bones}},{key:"bounds",get:function(){return(this._boundsChange||this._cacheAvatar)&&(this._calculateBoundingBox(),this._boundsChange=!1),this._bounds}}]),SkinnedMeshRenderer}();_i._tempMatrix4x4=new c;var di=function(e){function SkinnedMeshSprite3D(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return _classCallCheck(this,SkinnedMeshSprite3D),(e=_possibleConstructorReturn(this,_getPrototypeOf(SkinnedMeshSprite3D).call(this,n)))._meshFilter=new Dn(_assertThisInitialized(e)),e._render=new _i(_assertThisInitialized(e)),t&&(e._meshFilter.sharedMesh=t),e}return _inherits(SkinnedMeshSprite3D,Gt),_createClass(SkinnedMeshSprite3D,[{key:"_parse",value:function(e,n){_get(_getPrototypeOf(SkinnedMeshSprite3D.prototype),"_parse",this).call(this,e,n);var i=this.skinnedMeshRenderer,r=e.lightmapIndex;null!=r&&(i.lightmapIndex=r);var s,l=e.lightmapScaleOffset;if(l&&(i.lightmapScaleOffset=new a(l[0],l[1],l[2],l[3])),null!=e.enableRender&&(i.enable=e.enableRender),null!=e.receiveShadows&&(i.receiveShadow=e.receiveShadows),null!=e.castShadow&&(i.castShadow=e.castShadow),s=e.meshPath){var u=t.Loader.getRes(s);u&&(this.meshFilter.sharedMesh=u)}var c=e.materials;if(c){var h=i.sharedMaterials,_=c.length;h.length=_;for(var d=0;d<_;d++)h[d]=t.Loader.getRes(c[d].path);i.sharedMaterials=h}var f=e.boundBox,m=f.min,p=f.max;if(i.localBounds.setMin(new o(m[0],m[1],m[2])),i.localBounds.setMax(new o(p[0],p[1],p[2])),n){var T=e.rootBone;i.rootBone=n[T];var v,g=e.bones;for(d=0,v=g.length;d<v;d++)i.bones.push(n[g[d]])}else e.rootBone&&i._setRootBone(e.rootBone)}},{key:"_changeHierarchyAnimator",value:function(e){_get(_getPrototypeOf(SkinnedMeshSprite3D.prototype),"_changeHierarchyAnimator",this).call(this,e),this.skinnedMeshRenderer._setCacheAnimator(e)}},{key:"_changeAnimatorAvatar",value:function(e){this.skinnedMeshRenderer._setCacheAvatar(e)}},{key:"_cloneTo",value:function(e,t,n){var i=e;i.meshFilter.sharedMesh=this.meshFilter.sharedMesh;var a=this._render,r=i._render;r.enable=a.enable,r.sharedMaterials=a.sharedMaterials,r.castShadow=a.castShadow;var o=a.lightmapScaleOffset;o&&(r.lightmapScaleOffset=o.clone()),r.receiveShadow=a.receiveShadow,r.sortingFudge=a.sortingFudge,r._rootBone=a._rootBone;var s=a.bones,l=r.bones,u=s.length;l.length=u;var c=a.rootBone;if(c){var h=P._getHierarchyPath(t,c,SkinnedMeshSprite3D._tempArray0);r.rootBone=h?P._getNodeByHierarchyPath(n,h):c}for(var _=0;_<s.length;_++)h=P._getHierarchyPath(t,s[_],SkinnedMeshSprite3D._tempArray0),l[_]=h?P._getNodeByHierarchyPath(n,h):s[_];var d=a.localBounds;d&&d.cloneTo(r.localBounds),_get(_getPrototypeOf(SkinnedMeshSprite3D.prototype),"_cloneTo",this).call(this,e,t,n)}},{key:"destroy",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];this.destroyed||(_get(_getPrototypeOf(SkinnedMeshSprite3D.prototype),"destroy",this).call(this,e),this._meshFilter.destroy())}},{key:"_create",value:function(){return new SkinnedMeshSprite3D}},{key:"meshFilter",get:function(){return this._meshFilter}},{key:"skinnedMeshRenderer",get:function(){return this._render}}],[{key:"__init__",value:function(){hi.SHADERDEFINE_BONE=_e.getDefineByName("BONE"),hi.SHADERDEFINE_SIMPLEBONE=_e.getDefineByName("SIMPLEBONE")}}]),SkinnedMeshSprite3D}();di._tempArray0=[],di.BONES=_e.propertyNameToID("u_Bones"),di.SIMPLE_SIMPLEANIMATORTEXTURE=_e.propertyNameToID("u_SimpleAnimatorTexture"),di.SIMPLE_SIMPLEANIMATORPARAMS=_e.propertyNameToID("u_SimpleAnimatorParams"),di.SIMPLE_SIMPLEANIMATORTEXTURESIZE=_e.propertyNameToID("u_SimpleAnimatorTextureSize");var fi=function(e){function TrailMaterial(){var e;return _classCallCheck(this,TrailMaterial),(e=_possibleConstructorReturn(this,_getPrototypeOf(TrailMaterial).call(this))).setShaderName("Trail"),e._color=new a(1,1,1,1),e._shaderValues.setVector(TrailMaterial.TILINGOFFSET,new a(1,1,0,0)),e._shaderValues.setVector(TrailMaterial.TINTCOLOR,new a(1,1,1,1)),e.renderMode=TrailMaterial.RENDERMODE_ALPHABLENDED,e}return _inherits(TrailMaterial,st),_createClass(TrailMaterial,[{key:"clone",value:function(){var e=new TrailMaterial;return this.cloneTo(e),e}},{key:"_TintColorR",get:function(){return this._color.x},set:function(e){this._color.x=e,this.color=this._color}},{key:"_TintColorG",get:function(){return this._color.y},set:function(e){this._color.y=e,this.color=this._color}},{key:"_TintColorB",get:function(){return this._color.z},set:function(e){this._color.z=e,this.color=this._color}},{key:"_TintColorA",get:function(){return this._color.w},set:function(e){this._color.w=e,this.color=this._color}},{key:"_MainTex_STX",get:function(){return this._shaderValues.getVector(TrailMaterial.TILINGOFFSET).x},set:function(e){var t=this._shaderValues.getVector(TrailMaterial.TILINGOFFSET);t.x=e,this.tilingOffset=t}},{key:"_MainTex_STY",get:function(){return this._shaderValues.getVector(TrailMaterial.TILINGOFFSET).y},set:function(e){var t=this._shaderValues.getVector(TrailMaterial.TILINGOFFSET);t.y=e,this.tilingOffset=t}},{key:"_MainTex_STZ",get:function(){return this._shaderValues.getVector(TrailMaterial.TILINGOFFSET).z},set:function(e){var t=this._shaderValues.getVector(TrailMaterial.TILINGOFFSET);t.z=e,this.tilingOffset=t}},{key:"_MainTex_STW",get:function(){return this._shaderValues.getVector(TrailMaterial.TILINGOFFSET).w},set:function(e){var t=this._shaderValues.getVector(TrailMaterial.TILINGOFFSET);t.w=e,this.tilingOffset=t}},{key:"renderMode",set:function(e){switch(e){case TrailMaterial.RENDERMODE_ADDTIVE:this.renderQueue=st.RENDERQUEUE_TRANSPARENT,this.alphaTest=!1,this.depthWrite=!1,this.cull=ut.CULL_NONE,this.blend=ut.BLEND_ENABLE_ALL,this.blendSrc=ut.BLENDPARAM_SRC_ALPHA,this.blendDst=ut.BLENDPARAM_ONE,this.depthTest=ut.DEPTHTEST_LESS,this._shaderValues.addDefine(TrailMaterial.SHADERDEFINE_ADDTIVEFOG);break;case TrailMaterial.RENDERMODE_ALPHABLENDED:this.renderQueue=st.RENDERQUEUE_TRANSPARENT,this.alphaTest=!1,this.depthWrite=!1,this.cull=ut.CULL_NONE,this.blend=ut.BLEND_ENABLE_ALL,this.blendSrc=ut.BLENDPARAM_SRC_ALPHA,this.blendDst=ut.BLENDPARAM_ONE_MINUS_SRC_ALPHA,this.depthTest=ut.DEPTHTEST_LESS,this._shaderValues.removeDefine(TrailMaterial.SHADERDEFINE_ADDTIVEFOG);break;default:throw new Error("TrailMaterial : renderMode value error.")}}},{key:"colorR",get:function(){return this._TintColorR},set:function(e){this._TintColorR=e}},{key:"colorG",get:function(){return this._TintColorG},set:function(e){this._TintColorG=e}},{key:"colorB",get:function(){return this._TintColorB},set:function(e){this._TintColorB=e}},{key:"colorA",get:function(){return this._TintColorA},set:function(e){this._TintColorA=e}},{key:"color",get:function(){return this._shaderValues.getVector(TrailMaterial.TINTCOLOR)},set:function(e){this._shaderValues.setVector(TrailMaterial.TINTCOLOR,e)}},{key:"texture",get:function(){return this._shaderValues.getTexture(TrailMaterial.MAINTEXTURE)},set:function(e){e?this._shaderValues.addDefine(TrailMaterial.SHADERDEFINE_MAINTEXTURE):this._shaderValues.removeDefine(TrailMaterial.SHADERDEFINE_MAINTEXTURE),this._shaderValues.setTexture(TrailMaterial.MAINTEXTURE,e)}},{key:"tilingOffsetX",get:function(){return this._MainTex_STX},set:function(e){this._MainTex_STX=e}},{key:"tilingOffsetY",get:function(){return this._MainTex_STY},set:function(e){this._MainTex_STY=e}},{key:"tilingOffsetZ",get:function(){return this._MainTex_STZ},set:function(e){this._MainTex_STZ=e}},{key:"tilingOffsetW",get:function(){return this._MainTex_STW},set:function(e){this._MainTex_STW=e}},{key:"tilingOffset",get:function(){return this._shaderValues.getVector(TrailMaterial.TILINGOFFSET)},set:function(e){e?this._shaderValues.setVector(TrailMaterial.TILINGOFFSET,e):this._shaderValues.getVector(TrailMaterial.TILINGOFFSET).setValue(1,1,0,0)}}],[{key:"__initDefine__",value:function(){TrailMaterial.SHADERDEFINE_MAINTEXTURE=_e.getDefineByName("MAINTEXTURE"),TrailMaterial.SHADERDEFINE_ADDTIVEFOG=_e.getDefineByName("ADDTIVEFOG")}}]),TrailMaterial}();fi.RENDERMODE_ALPHABLENDED=0,fi.RENDERMODE_ADDTIVE=1,fi.MAINTEXTURE=_e.propertyNameToID("u_MainTexture"),fi.TINTCOLOR=_e.propertyNameToID("u_MainColor"),fi.TILINGOFFSET=_e.propertyNameToID("u_TilingOffset");var mi,pi=function TextureMode(){_classCallCheck(this,TextureMode)};pi.Stretch=0,pi.Tile=1,(mi=e.TrailAlignment||(e.TrailAlignment={}))[mi.View=0]="View",mi[mi.TransformZ=1]="TransformZ";var Ti=function(){function VertexTrail(){_classCallCheck(this,VertexTrail)}return _createClass(VertexTrail,[{key:"vertexDeclaration",get:function(){return VertexTrail._vertexDeclaration1}}],[{key:"__init__",value:function(){VertexTrail._vertexDeclaration1=new ae(32,[new re(0,ne.Vector3,VertexTrail.TRAIL_POSITION0),new re(12,ne.Vector3,VertexTrail.TRAIL_OFFSETVECTOR),new re(24,ne.Single,VertexTrail.TRAIL_TIME0),new re(28,ne.Single,VertexTrail.TRAIL_TEXTURECOORDINATE0Y)]),VertexTrail._vertexDeclaration2=new ae(20,[new re(0,ne.Single,VertexTrail.TRAIL_TEXTURECOORDINATE0X),new re(4,ne.Color,VertexTrail.TRAIL_COLOR)])}},{key:"vertexDeclaration1",get:function(){return VertexTrail._vertexDeclaration1}},{key:"vertexDeclaration2",get:function(){return VertexTrail._vertexDeclaration2}}]),VertexTrail}();Ti.TRAIL_POSITION0=0,Ti.TRAIL_OFFSETVECTOR=1,Ti.TRAIL_TIME0=2,Ti.TRAIL_TEXTURECOORDINATE0Y=3,Ti.TRAIL_TEXTURECOORDINATE0X=4,Ti.TRAIL_COLOR=5;var vi=function(i){function TrailGeometry(e){var t;_classCallCheck(this,TrailGeometry),(t=_possibleConstructorReturn(this,_getPrototypeOf(TrailGeometry).call(this)))._floatCountPerVertices1=8,t._floatCountPerVertices2=5,t._increaseSegementCount=16,t._activeIndex=0,t._endIndex=0,t._needAddFirstVertex=!1,t._isTempEndVertex=!1,t._vertices1=null,t._vertices2=null,t._lastFixedVertexPosition=new o,t._bufferState=new oe,t.tmpColor=new Et,t._disappearBoundsMode=!1,t._owner=e,t._segementCount=t._increaseSegementCount,t._resizeData(t._segementCount,t._bufferState);var n=t._owner._owner.trailRenderer.bounds,i=t._owner._owner.transform.position;return n.setMin(i),n.setMax(i),t}return _inherits(TrailGeometry,Vt),_createClass(TrailGeometry,[{key:"_resizeData",value:function(e,n){this._subBirthTime=new Float32Array(e),this._subDistance=new Float64Array(e);var i=t.LayaGL.instance,a=2*e,r=Ti.vertexDeclaration1,o=Ti.vertexDeclaration2,s=[],l=a*r.vertexStride,u=a*o.vertexStride,c=l+u;this._vertices1=new Float32Array(a*this._floatCountPerVertices1),this._vertices2=new Float32Array(a*this._floatCountPerVertices2),this._vertexBuffer1=new te(l,i.STATIC_DRAW,!1),this._vertexBuffer1.vertexDeclaration=r,this._vertexBuffer2=new te(u,i.DYNAMIC_DRAW,!1),this._vertexBuffer2.vertexDeclaration=o,s.push(this._vertexBuffer1),s.push(this._vertexBuffer2),n.bind(),n.applyVertexBuffers(s),n.unBind(),t.Resource._addMemory(c,c)}},{key:"_resetData",value:function(){var e=this._endIndex-this._activeIndex,n=new Float32Array(this._vertices1.buffer,2*this._floatCountPerVertices1*this._activeIndex*4,2*this._floatCountPerVertices1*e),i=new Float32Array(this._vertices2.buffer,2*this._floatCountPerVertices2*this._activeIndex*4,2*this._floatCountPerVertices2*e),a=new Float64Array(this._subDistance.buffer,8*this._activeIndex,e),r=new Float32Array(this._subBirthTime.buffer,4*this._activeIndex,e);if(e===this._segementCount){var o=this._vertexBuffer1._byteLength+this._vertexBuffer2._byteLength;t.Resource._addMemory(-o,-o),this._vertexBuffer1.destroy(),this._vertexBuffer2.destroy(),this._segementCount+=this._increaseSegementCount,this._resizeData(this._segementCount,this._bufferState)}this._vertices1.set(n,0),this._vertices2.set(i,0),this._subDistance.set(a,0),this._subBirthTime.set(r,0),this._endIndex=e,this._activeIndex=0,this._vertexBuffer1.setData(this._vertices1.buffer,0,2*this._floatCountPerVertices1*this._activeIndex*4,2*this._floatCountPerVertices1*e*4),this._vertexBuffer2.setData(this._vertices2.buffer,0,2*this._floatCountPerVertices2*this._activeIndex*4,2*this._floatCountPerVertices2*e*4)}},{key:"_updateTrail",value:function(e,t,n){o.equals(t,n)||(this._endIndex-this._activeIndex==0?this._addTrailByFirstPosition(e,n):this._addTrailByNextPosition(e,n))}},{key:"_addTrailByFirstPosition",value:function(e,t){this._endIndex===this._segementCount&&this._resetData(),this._subDistance[this._endIndex]=0,this._subBirthTime[this._endIndex]=this._owner._curtime,this._endIndex++,t.cloneTo(this._lastFixedVertexPosition),this._needAddFirstVertex=!0}},{key:"_addTrailByNextPosition",value:function(t,i){var a=TrailGeometry._tempVector30,r=TrailGeometry._tempVector31;switch(this._owner.alignment){case e.TrailAlignment.View:var s=t.viewMatrix;o.transformCoordinate(i,s,TrailGeometry._tempVector33),o.transformCoordinate(this._lastFixedVertexPosition,s,TrailGeometry._tempVector34),o.subtract(TrailGeometry._tempVector33,TrailGeometry._tempVector34,a),o.cross(TrailGeometry._tempVector33,a,r);break;case e.TrailAlignment.TransformZ:o.subtract(i,this._lastFixedVertexPosition,a);var l=TrailGeometry._tempVector32;this._owner._owner.transform.getForward(l),o.cross(a,l,r)}o.normalize(r,r),o.scale(r,this._owner.widthMultiplier/2,r);var u,c,h=o.scalarLength(a);this._needAddFirstVertex&&(this._updateVerticesByPositionData(i,r,this._endIndex-1),this._needAddFirstVertex=!1),h-this._owner.minVertexDistance>=n.zeroTolerance?(this._isTempEndVertex?(u=this._endIndex-1,c=h-this._subDistance[u],this._updateVerticesByPosition(i,r,h,u),this._owner._totalLength+=c):(this._endIndex===this._segementCount&&this._resetData(),this._updateVerticesByPosition(i,r,h,this._endIndex),this._owner._totalLength+=h,this._endIndex++),i.cloneTo(this._lastFixedVertexPosition),this._isTempEndVertex=!1):(this._isTempEndVertex?(u=this._endIndex-1,c=h-this._subDistance[u],this._updateVerticesByPosition(i,r,h,u),this._owner._totalLength+=c):(this._endIndex===this._segementCount&&this._resetData(),this._updateVerticesByPosition(i,r,h,this._endIndex),this._owner._totalLength+=h,this._endIndex++),this._isTempEndVertex=!0)}},{key:"_updateVerticesByPositionData",value:function(e,t,n){var i=2*this._floatCountPerVertices1*n,a=this._owner._curtime;this._vertices1[i]=e.x,this._vertices1[i+1]=e.y,this._vertices1[i+2]=e.z,this._vertices1[i+3]=-t.x,this._vertices1[i+4]=-t.y,this._vertices1[i+5]=-t.z,this._vertices1[i+6]=a,this._vertices1[i+7]=1,this._vertices1[i+8]=e.x,this._vertices1[i+9]=e.y,this._vertices1[i+10]=e.z,this._vertices1[i+11]=t.x,this._vertices1[i+12]=t.y,this._vertices1[i+13]=t.z,this._vertices1[i+14]=a,this._vertices1[i+15]=0;var r=this._owner._owner.trailRenderer.bounds,s=r.getMin(),l=r.getMax(),u=TrailGeometry._tempVector35,c=TrailGeometry._tempVector36,h=TrailGeometry._tempVector32;o.add(e,t,u),o.subtract(e,t,c),o.min(c,u,h),o.min(s,h,s),r.setMin(s),o.max(u,c,h),o.max(l,h,l),r.setMax(l);var _=2*this._floatCountPerVertices1;this._vertexBuffer1.setData(this._vertices1.buffer,4*i,4*i,4*_)}},{key:"_updateVerticesByPosition",value:function(e,t,n,i){this._updateVerticesByPositionData(e,t,i),this._subDistance[i]=n,this._subBirthTime[i]=this._owner._curtime}},{key:"_updateVertexBufferUV",value:function(){var e,t,n;if(this._disappearBoundsMode){e=this._owner._owner.trailRenderer.bounds;var i=this._owner._owner.transform.position;e.setMin(i),e.setMax(i),t=e.getMin(),n=e.getMax()}for(var a=this._endIndex,r=0,s=this._owner.colorGradient,l=s.colorAlphaKeysCount-1,u=s.colorRGBKeysCount-1,c=this._owner._totalLength,h=2*this._floatCountPerVertices2,_=this._activeIndex;_<a;_++){var d,f;_!==this._activeIndex&&(r+=this._subDistance[_]),this._owner.textureMode==pi.Stretch?f=d=1-r/c:(f=1-r/c,d=1-(c-r)),u=s.evaluateColorRGB(f,this.tmpColor,u,!0),l=s.evaluateColorAlpha(f,this.tmpColor,l,!0);var m=_*h;if(this._vertices2[m+0]=d,this._vertices2[m+1]=this.tmpColor.r,this._vertices2[m+2]=this.tmpColor.g,this._vertices2[m+3]=this.tmpColor.b,this._vertices2[m+4]=this.tmpColor.a,this._vertices2[m+5]=d,this._vertices2[m+6]=this.tmpColor.r,this._vertices2[m+7]=this.tmpColor.g,this._vertices2[m+8]=this.tmpColor.b,this._vertices2[m+9]=this.tmpColor.a,this._disappearBoundsMode){var p=2*this._floatCountPerVertices1*_,T=TrailGeometry._tempVector32,v=TrailGeometry._tempVector33,g=TrailGeometry._tempVector34;T.setValue(this._vertices1[p+0],this._vertices1[p+1],this._vertices1[p+2]),v.setValue(this._vertices1[p+3],this._vertices1[p+4],this._vertices1[p+5]),o.add(T,v,g),o.min(g,t,t),o.max(g,n,n),o.subtract(T,v,g),o.min(g,t,t),o.max(g,n,n)}}this._disappearBoundsMode&&(e.setMin(t),e.setMax(n),this._disappearBoundsMode=!1);var E=this._activeIndex*h;this._vertexBuffer2.setData(this._vertices2.buffer,4*E,4*E,4*(a*h-E))}},{key:"_updateDisappear",value:function(){for(var e=this._endIndex,t=this._activeIndex;t<e&&this._owner._curtime-this._subBirthTime[t]>=this._owner.time+n.zeroTolerance;t++){var i=t+1;if(i!==e&&(this._owner._totalLength-=this._subDistance[i]),this._isTempEndVertex&&i===e-1){var a=this._lastFixedVertexPosition;a.x=this._vertices1[0],a.y=this._vertices1[1],a.z=this._vertices1[2],this._isTempEndVertex=!1}this._activeIndex++,this._disappearBoundsMode=!0}}},{key:"_getType",value:function(){return TrailGeometry._type}},{key:"_prepareRender",value:function(e){return this._endIndex-this._activeIndex>1}},{key:"_render",value:function(e){this._bufferState.bind();var n=t.LayaGL.instance,i=2*this._activeIndex,a=2*this._endIndex-i;n.drawArrays(n.TRIANGLE_STRIP,i,a),t.Stat.renderBatches++,t.Stat.trianglesFaces+=a-2}},{key:"destroy",value:function(){_get(_getPrototypeOf(TrailGeometry.prototype),"destroy",this).call(this);var e=this._vertexBuffer1._byteLength+this._vertexBuffer2._byteLength;t.Resource._addMemory(-e,-e),this._bufferState.destroy(),this._vertexBuffer1.destroy(),this._vertexBuffer2.destroy(),this._bufferState=null,this._vertices1=null,this._vertexBuffer1=null,this._vertices2=null,this._vertexBuffer2=null,this._subBirthTime=null,this._subDistance=null,this._lastFixedVertexPosition=null,this._disappearBoundsMode=!1}},{key:"clear",value:function(){this._activeIndex=0,this._endIndex=0,this._disappearBoundsMode=!1,this._subBirthTime.fill(0),this._subDistance.fill(0),this._segementCount=0,this._isTempEndVertex=!1,this._needAddFirstVertex=!1,this._lastFixedVertexPosition.setValue(0,0,0)}}]),TrailGeometry}();vi.ALIGNMENT_VIEW=0,vi.ALIGNMENT_TRANSFORM_Z=1,vi._tempVector30=new o,vi._tempVector31=new o,vi._tempVector32=new o,vi._tempVector33=new o,vi._tempVector34=new o,vi._tempVector35=new o,vi._tempVector36=new o,vi._type=Vt._typeCounter++;var gi=function(){function TrailFilter(e){_classCallCheck(this,TrailFilter),this._totalLength=0,this._lastPosition=new o,this._curtime=0,this.alignment=TrailFilter.ALIGNMENT_VIEW,this._owner=e,this._initDefaultData(),this.addRenderElement()}return _createClass(TrailFilter,[{key:"addRenderElement",value:function(){var e=this._owner._render,t=e._renderElements,n=e.sharedMaterials[0];n||(n=fi.defaultMaterial);var i=new qe;i.setTransform(this._owner._transform),i.render=e,i.material=n,this._trialGeometry=new vi(this),i.setGeometry(this._trialGeometry),t.push(i)}},{key:"_update",value:function(e){var t=this._owner._render;this._curtime+=e.scene.timer._delta/1e3,t._shaderValues.setNumber(TrailFilter.CURTIME,this._curtime);var n=this._owner.transform.position,i=t._renderElements[0]._geometry;i._updateDisappear(),i._updateTrail(e.camera,this._lastPosition,n),i._updateVertexBufferUV(),n.cloneTo(this._lastPosition)}},{key:"_initDefaultData",value:function(){this.time=5,this.minVertexDistance=.1,this.widthMultiplier=1,this.textureMode=pi.Stretch;var e=[],t=new U;t.time=0,t.inTangent=0,t.outTangent=0,t.value=1,e.push(t);var n=new U;n.time=1,n.inTangent=0,n.outTangent=0,n.value=1,e.push(n),this.widthCurve=e;var i=new On(2,2);i.mode=Ln.Blend,i.addColorRGB(0,Et.WHITE),i.addColorRGB(1,Et.WHITE),i.addColorAlpha(0,1),i.addColorAlpha(1,1),this.colorGradient=i}},{key:"destroy",value:function(){this._trialGeometry.destroy(),this._trialGeometry=null,this._widthCurve=null,this._colorGradient=null}},{key:"clear",value:function(){this._trialGeometry.clear(),this._lastPosition.setValue(0,0,0),this._curtime=0,this._totalLength=0}},{key:"time",get:function(){return this._time},set:function(e){this._time=e,this._owner._render._shaderValues.setNumber(TrailFilter.LIFETIME,e)}},{key:"minVertexDistance",get:function(){return this._minVertexDistance},set:function(e){this._minVertexDistance=e}},{key:"widthMultiplier",get:function(){return this._widthMultiplier},set:function(e){this._widthMultiplier=e}},{key:"widthCurve",get:function(){return this._widthCurve},set:function(e){this._widthCurve=e;var t,n,i=new Float32Array(4*e.length),a=0;for(t=0,n=e.length;t<n;t++)i[a++]=e[t].time,i[a++]=e[t].inTangent,i[a++]=e[t].outTangent,i[a++]=e[t].value;this._owner._render._shaderValues.setBuffer(TrailFilter.WIDTHCURVE,i),this._owner._render._shaderValues.setInt(TrailFilter.WIDTHCURVEKEYLENGTH,e.length)}},{key:"colorGradient",get:function(){return this._colorGradient},set:function(e){this._colorGradient=e}},{key:"textureMode",get:function(){return this._textureMode},set:function(e){this._textureMode=e}}]),TrailFilter}();gi.CURTIME=_e.propertyNameToID("u_CurTime"),gi.LIFETIME=_e.propertyNameToID("u_LifeTime"),gi.WIDTHCURVE=_e.propertyNameToID("u_WidthCurve"),gi.WIDTHCURVEKEYLENGTH=_e.propertyNameToID("u_WidthCurveKeyLength"),gi.ALIGNMENT_VIEW=0,gi.ALIGNMENT_TRANSFORM_Z=1;var Ei=function(e){function TrailRenderer(e){var t;return _classCallCheck(this,TrailRenderer),(t=_possibleConstructorReturn(this,_getPrototypeOf(TrailRenderer).call(this,e)))._projectionViewWorldMatrix=new c,t}return _inherits(TrailRenderer,qt),_createClass(TrailRenderer,[{key:"_calculateBoundingBox",value:function(){}},{key:"_needRender",value:function(e,t){return this._owner.trailFilter._update(t),!e||e.intersects(this.bounds._getBoundBox())}},{key:"_updateForNative",value:function(e){this._owner.trailFilter._update(e)}},{key:"_renderUpdate",value:function(e,t){_get(_getPrototypeOf(TrailRenderer.prototype),"_renderUpdate",this).call(this,e,t)}},{key:"_renderUpdateWithCamera",value:function(e,t){var n=e.projectionViewMatrix;t?(c.multiply(n,t.worldMatrix,this._projectionViewWorldMatrix),this._shaderValues.setMatrix4x4(ve.MVPMATRIX,this._projectionViewWorldMatrix)):this._shaderValues.setMatrix4x4(ve.MVPMATRIX,n)}}]),TrailRenderer}(),yi=function(e){function TrailSprite3D(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;return _classCallCheck(this,TrailSprite3D),(e=_possibleConstructorReturn(this,_getPrototypeOf(TrailSprite3D).call(this,t)))._render=new Ei(_assertThisInitialized(e)),e._geometryFilter=new gi(_assertThisInitialized(e)),e}return _inherits(TrailSprite3D,Gt),_createClass(TrailSprite3D,[{key:"_parse",value:function(e,n){_get(_getPrototypeOf(TrailSprite3D.prototype),"_parse",this).call(this,e,n);var i,a,r=this._render,o=this._geometryFilter,s=e.materials;if(s){var l=r.sharedMaterials,u=s.length;for(l.length=u,i=0;i<u;i++)l[i]=t.Loader.getRes(s[i].path);r.sharedMaterials=l}o.time=e.time,o.minVertexDistance=e.minVertexDistance,o.widthMultiplier=e.widthMultiplier,o.textureMode=e.textureMode,null!=e.alignment&&(o.alignment=e.alignment);var c=[],h=e.widthCurve;for(i=0,a=h.length;i<a;i++){var _=new U;_.time=h[i].time,_.inTangent=h[i].inTangent,_.outTangent=h[i].outTangent,_.value=h[i].value,c.push(_)}o.widthCurve=c;var d=e.colorGradient,f=d.colorKeys,m=d.alphaKeys,p=new On(f.length,m.length);for(p.mode=d.mode,i=0,a=f.length;i<a;i++){var T=f[i];p.addColorRGB(T.time,new Et(T.value[0],T.value[1],T.value[2],1))}for(i=0,a=m.length;i<a;i++){var v=m[i];p.addColorAlpha(v.time,v.value)}o.colorGradient=p}},{key:"_onActive",value:function(){_get(_getPrototypeOf(TrailSprite3D.prototype),"_onActive",this).call(this),this._transform.position.cloneTo(this._geometryFilter._lastPosition)}},{key:"_cloneTo",value:function(e,t,n){var i,a;_get(_getPrototypeOf(TrailSprite3D.prototype),"_cloneTo",this).call(this,e,t,n);var r=e,o=r.trailFilter;o.time=this.trailFilter.time,o.minVertexDistance=this.trailFilter.minVertexDistance,o.widthMultiplier=this.trailFilter.widthMultiplier,o.textureMode=this.trailFilter.textureMode,o.alignment=this.trailFilter.alignment;var s=this.trailFilter.widthCurve,l=[];for(i=0,a=s.length;i<a;i++){var u=new U;s[i].cloneTo(u),l.push(u)}o.widthCurve=l;var c=new On(this.trailFilter.colorGradient.maxColorRGBKeysCount,this.trailFilter.colorGradient.maxColorAlphaKeysCount);this.trailFilter.colorGradient.cloneTo(c),o.colorGradient=c,r.trailRenderer.sharedMaterial=this.trailRenderer.sharedMaterial}},{key:"destroy",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];this.destroyed||(_get(_getPrototypeOf(TrailSprite3D.prototype),"destroy",this).call(this,e),this._geometryFilter.destroy(),this._geometryFilter=null)}},{key:"clear",value:function(){this._geometryFilter.clear()}},{key:"_create",value:function(){return new TrailSprite3D}},{key:"trailFilter",get:function(){return this._geometryFilter}},{key:"trailRenderer",get:function(){return this._render}}],[{key:"__init__",value:function(){}}]),TrailSprite3D}(),Si=function(){function VertexPositionTerrain(e,t,n,i){_classCallCheck(this,VertexPositionTerrain),this._position=e,this._normal=t,this._textureCoord0=n,this._textureCoord1=i}return _createClass(VertexPositionTerrain,[{key:"position",get:function(){return this._position}},{key:"normal",get:function(){return this._normal}},{key:"textureCoord0",get:function(){return this._textureCoord0}},{key:"textureCoord1",get:function(){return this._textureCoord1}},{key:"vertexDeclaration",get:function(){return VertexPositionTerrain._vertexDeclaration}}],[{key:"__init__",value:function(){VertexPositionTerrain._vertexDeclaration=new ae(40,[new re(0,ne.Vector3,VertexPositionTerrain.TERRAIN_POSITION0),new re(12,ne.Vector3,VertexPositionTerrain.TERRAIN_NORMAL0),new re(24,ne.Vector2,VertexPositionTerrain.TERRAIN_TEXTURECOORDINATE0),new re(32,ne.Vector2,VertexPositionTerrain.TERRAIN_TEXTURECOORDINATE1)])}},{key:"vertexDeclaration",get:function(){return VertexPositionTerrain._vertexDeclaration}}]),VertexPositionTerrain}();Si.TERRAIN_POSITION0=0,Si.TERRAIN_NORMAL0=1,Si.TERRAIN_TEXTURECOORDINATE0=2,Si.TERRAIN_TEXTURECOORDINATE1=3;var Ri=function BulletInteractive(){_classCallCheck(this,BulletInteractive)};Ri._interactive={getWorldTransform:function(e,t){},setWorldTransform:function(e,t){var n=S._physicObjectsMap[e];n._simulation._updatedRigidbodies++,n._updateTransformComponent(t)}};var Ci=function(e){function PhysicsCollider(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:m.COLLISIONFILTERGROUP_DEFAULTFILTER,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:m.COLLISIONFILTERGROUP_ALLFILTER;return _classCallCheck(this,PhysicsCollider),(e=_possibleConstructorReturn(this,_getPrototypeOf(PhysicsCollider).call(this,t,n)))._enableProcessCollisions=!1,e}return _inherits(PhysicsCollider,N),_createClass(PhysicsCollider,[{key:"_addToSimulation",value:function(){this._simulation._addPhysicsCollider(this,this._collisionGroup,this._canCollideWith)}},{key:"_removeFromSimulation",value:function(){this._simulation._removePhysicsCollider(this)}},{key:"_parse",value:function(e){null!=e.friction&&(this.friction=e.friction),null!=e.rollingFriction&&(this.rollingFriction=e.rollingFriction),null!=e.restitution&&(this.restitution=e.restitution),null!=e.isTrigger&&(this.isTrigger=e.isTrigger),_get(_getPrototypeOf(PhysicsCollider.prototype),"_parse",this).call(this,e),this._parseShape(e.shapes)}},{key:"_onAdded",value:function(){var e=k._bullet,t=e.btCollisionObject_create();e.btCollisionObject_setUserIndex(t,this.id),e.btCollisionObject_forceActivationState(t,S.ACTIVATIONSTATE_DISABLE_SIMULATION);var n=e.btCollisionObject_getCollisionFlags(t);this.owner.isStatic?((n&S.COLLISIONFLAGS_KINEMATIC_OBJECT)>0&&(n^=S.COLLISIONFLAGS_KINEMATIC_OBJECT),n|=S.COLLISIONFLAGS_STATIC_OBJECT):((n&S.COLLISIONFLAGS_STATIC_OBJECT)>0&&(n^=S.COLLISIONFLAGS_STATIC_OBJECT),n|=S.COLLISIONFLAGS_KINEMATIC_OBJECT),e.btCollisionObject_setCollisionFlags(t,n),this._btColliderObject=t,_get(_getPrototypeOf(PhysicsCollider.prototype),"_onAdded",this).call(this)}}]),PhysicsCollider}(),Mi=function(n){function SubMesh(e){var t;return _classCallCheck(this,SubMesh),(t=_possibleConstructorReturn(this,_getPrototypeOf(SubMesh).call(this)))._id=++SubMesh._uniqueIDCounter,t._mesh=e,t._boneIndicesList=[],t._subIndexBufferStart=[],t._subIndexBufferCount=[],t}return _inherits(SubMesh,Vt),_createClass(SubMesh,[{key:"_setIndexRange",value:function(t,n){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:e.IndexFormat.UInt16;this._indexStart=t,this._indexCount=n,i==e.IndexFormat.UInt16?this._indices=new Uint16Array(this._indexBuffer.getData().buffer,2*t,n):this._indices=new Uint32Array(this._indexBuffer.getData().buffer,4*t,n)}},{key:"_getType",value:function(){return SubMesh._type}},{key:"_prepareRender",value:function(e){return this._mesh._uploadVerticesData(),!0}},{key:"_render",value:function(n){var i=this._mesh;if(i.indexFormat!==e.IndexFormat.UInt32||t.LayaGL.layaGPUInstance.supportElementIndexUint32()){var a,r,o=t.LayaGL.instance,s=n.renderElement?n.renderElement.render._skinnedData:null;switch(i.indexFormat){case e.IndexFormat.UInt32:a=o.UNSIGNED_INT,r=4;break;case e.IndexFormat.UInt16:a=o.UNSIGNED_SHORT,r=2;break;case e.IndexFormat.UInt8:a=o.UNSIGNED_BYTE,r=1}if(i._bufferState.bind(),s)for(var l=s[this._indexInMesh],u=0,c=this._boneIndicesList.length;u<c;u++)n.shader.uploadCustomUniform(di.BONES,l[u]),o.drawElements(o.TRIANGLES,this._subIndexBufferCount[u],a,this._subIndexBufferStart[u]*r);else o.drawElements(o.TRIANGLES,this._indexCount,a,this._indexStart*r);t.Stat.trianglesFaces+=this._indexCount/3,t.Stat.renderBatches++}else console.warn("SubMesh:this device do not support IndexFormat.UInt32.")}},{key:"getIndices",value:function(){if(this._mesh._isReadable)return this._indices.slice();throw"SubMesh:can't get indices on subMesh,mesh's isReadable must be true."}},{key:"setIndices",value:function(e){this._indexBuffer.setData(e,this._indexStart,0,this._indexCount)}},{key:"destroy",value:function(){this._destroyed||(_get(_getPrototypeOf(SubMesh.prototype),"destroy",this).call(this),this._indexBuffer.destroy(),this._indexBuffer=null,this._mesh=null,this._boneIndicesList=null,this._subIndexBufferStart=null,this._subIndexBufferCount=null,this._skinAnimationDatas=null)}},{key:"indexCount",get:function(){return this._indexCount}}]),SubMesh}();Mi._uniqueIDCounter=0,Mi._type=Vt._typeCounter++;var Di=function skinnedMatrixCache(e,t,n){_classCallCheck(this,skinnedMatrixCache),this.subMeshIndex=e,this.batchIndex=t,this.batchBoneIndex=n},xi=function(n){function Mesh(){var t,n=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];return _classCallCheck(this,Mesh),(t=_possibleConstructorReturn(this,_getPrototypeOf(Mesh).call(this)))._tempVector30=new o,t._tempVector31=new o,t._tempVector32=new o,t._minVerticesUpdate=-1,t._maxVerticesUpdate=-1,t._needUpdateBounds=!0,t._bounds=new Bt(new o,new o),t._bufferState=new oe,t._instanceBufferState=new oe,t._instanceBufferStateType=0,t._vertexBuffer=null,t._indexBuffer=null,t._skinnedMatrixCaches=[],t._vertexCount=0,t._indexFormat=e.IndexFormat.UInt16,t._isReadable=n,t._subMeshes=[],t}return _inherits(Mesh,t.Resource),_createClass(Mesh,[{key:"_getPositionElement",value:function(e){for(var t=e.vertexDeclaration._vertexElements,n=0,i=t.length;n<i;n++){var a=t[n];if(a._elementFormat===ne.Vector3&&a._elementUsage===Ne.MESH_POSITION0)return a}return null}},{key:"_getVerticeElementData",value:function(e,t){e.length=this._vertexCount;var n=this._vertexBuffer.vertexDeclaration,r=n.getVertexElementByUsage(t);if(r){var s=this._vertexBuffer.getUint8Data(),l=this._vertexBuffer.getFloat32Data(),u=n.vertexStride,c=u/4,h=r._offset,_=h/4;switch(t){case Ne.MESH_TEXTURECOORDINATE0:case Ne.MESH_TEXTURECOORDINATE1:for(var d=0;d<this._vertexCount;d++){var f=c*d+_;e[d]=new i(l[f],l[f+1])}break;case Ne.MESH_POSITION0:case Ne.MESH_NORMAL0:for(d=0;d<this._vertexCount;d++){f=c*d+_;e[d]=new o(l[f],l[f+1],l[f+2])}break;case Ne.MESH_TANGENT0:case Ne.MESH_BLENDWEIGHT0:for(d=0;d<this._vertexCount;d++){f=c*d+_;e[d]=new a(l[f],l[f+1],l[f+2],l[f+3])}break;case Ne.MESH_COLOR0:for(d=0;d<this._vertexCount;d++){f=c*d+_;e[d]=new Et(l[f],l[f+1],l[f+2],l[f+3])}break;case Ne.MESH_BLENDINDICES0:for(d=0;d<this._vertexCount;d++){f=u*d+h;e[d]=new a(s[f],s[f+1],s[f+2],s[f+3])}break;default:throw"Mesh:Unknown elementUsage."}}}},{key:"_setVerticeElementData",value:function(e,t){var n=this._vertexBuffer.vertexDeclaration,i=n.getVertexElementByUsage(t);if(i){var a=this._vertexBuffer.getUint8Data(),r=this._vertexBuffer.getFloat32Data(),o=n.vertexStride,s=o/4,l=i._offset,u=l/4;switch(t){case Ne.MESH_TEXTURECOORDINATE0:case Ne.MESH_TEXTURECOORDINATE1:for(var c=0,h=e.length;c<h;c++){var _=s*c+u,d=e[c];r[_]=d.x,r[_+1]=d.y}break;case Ne.MESH_POSITION0:case Ne.MESH_NORMAL0:for(c=0,h=e.length;c<h;c++){_=s*c+u;var f=e[c];r[_]=f.x,r[_+1]=f.y,r[_+2]=f.z}break;case Ne.MESH_TANGENT0:case Ne.MESH_BLENDWEIGHT0:for(c=0,h=e.length;c<h;c++){_=s*c+u;var m=e[c];r[_]=m.x,r[_+1]=m.y,r[_+2]=m.z,r[_+3]=m.w}break;case Ne.MESH_COLOR0:for(c=0,h=e.length;c<h;c++){_=s*c+u;var p=e[c];r[_]=p.r,r[_+1]=p.g,r[_+2]=p.b,r[_+3]=p.a}break;case Ne.MESH_BLENDINDICES0:for(c=0,h=e.length;c<h;c++){_=o*c+l,m=e[c];a[_]=m.x,a[_+1]=m.y,a[_+2]=m.z,a[_+3]=m.w}break;default:throw"Mesh:Unknown elementUsage."}this._minVerticesUpdate=0,this._maxVerticesUpdate=Number.MAX_SAFE_INTEGER}else console.warn("Mesh: the mesh don't have  this VertexElement.")}},{key:"_disposeResource",value:function(){for(var e=0,t=this._subMeshes.length;e<t;e++)this._subMeshes[e].destroy();this._btTriangleMesh&&k._bullet.btStridingMeshInterface_destroy(this._btTriangleMesh),this._vertexBuffer.destroy(),this._indexBuffer.destroy(),this._bufferState.destroy(),this._instanceBufferState.destroy(),this._setCPUMemory(0),this._setGPUMemory(0),this._bufferState=null,this._instanceBufferState=null,this._vertexBuffer=null,this._indexBuffer=null,this._subMeshes=null,this._btTriangleMesh=null,this._indexBuffer=null,this._boneNames=null,this._inverseBindPoses=null}},{key:"_setSubMeshes",value:function(e){this._subMeshes=e;for(var t=0,n=e.length;t<n;t++)e[t]._indexInMesh=t}},{key:"_setBuffer",value:function(e,t){var n=this._bufferState;n.bind(),n.applyVertexBuffer(e),n.applyIndexBuffer(t),n.unBind()}},{key:"_setInstanceBuffer",value:function(e){var t=this._instanceBufferState;switch(t.bind(),t.applyVertexBuffer(this._vertexBuffer),t.applyInstanceVertexBuffer(zt.instance.instanceWorldMatrixBuffer),e){case Mesh.MESH_INSTANCEBUFFER_TYPE_SIMPLEANIMATOR:t.applyInstanceVertexBuffer(zt.instance.instanceSimpleAnimatorBuffer)}t.applyIndexBuffer(this._indexBuffer),t.unBind()}},{key:"_getPhysicMesh",value:function(){if(!this._btTriangleMesh){for(var e=k._bullet,t=e.btTriangleMesh_create(),n=Mesh._nativeTempVector30,i=Mesh._nativeTempVector31,a=Mesh._nativeTempVector32,r=this._tempVector30,o=this._tempVector31,s=this._tempVector32,l=this._vertexBuffer,u=this._getPositionElement(l),c=l.getFloat32Data(),h=l.vertexDeclaration.vertexStride/4,_=u._offset/4,d=this._indexBuffer.getData(),f=0,m=d.length;f<m;f+=3){var p=d[f]*h+_,T=d[f+1]*h+_,v=d[f+2]*h+_;r.setValue(c[p],c[p+1],c[p+2]),o.setValue(c[T],c[T+1],c[T+2]),s.setValue(c[v],c[v+1],c[v+2]),P._convertToBulletVec3(r,n,!0),P._convertToBulletVec3(o,i,!0),P._convertToBulletVec3(s,a,!0),e.btTriangleMesh_addTriangle(t,n,i,a,!0)}this._btTriangleMesh=t}return this._btTriangleMesh}},{key:"_uploadVerticesData",value:function(){var e=this._minVerticesUpdate,t=this._maxVerticesUpdate;if(-1!==e&&-1!==t){var n=e;this._vertexBuffer.setData(this._vertexBuffer.getUint8Data().buffer,n,n,t-e),this._minVerticesUpdate=-1,this._maxVerticesUpdate=-1}}},{key:"getSubMesh",value:function(e){return this._subMeshes[e]}},{key:"getPositions",value:function(e){if(!this._isReadable)throw"Mesh:can't get positions on mesh,isReadable must be true.";this._getVerticeElementData(e,Ne.MESH_POSITION0)}},{key:"setPositions",value:function(e){if(!this._isReadable)throw"Mesh:setPosition() need isReadable must be true or use setVertices().";this._setVerticeElementData(e,Ne.MESH_POSITION0),this._needUpdateBounds=!0}},{key:"getColors",value:function(e){if(!this._isReadable)throw"Mesh:can't get colors on mesh,isReadable must be true.";this._getVerticeElementData(e,Ne.MESH_COLOR0)}},{key:"setColors",value:function(e){if(!this._isReadable)throw"Mesh:setColors() need isReadable must be true or use setVertices().";this._setVerticeElementData(e,Ne.MESH_COLOR0)}},{key:"getUVs",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;if(!this._isReadable)throw"Mesh:can't get uvs on mesh,isReadable must be true.";switch(t){case 0:this._getVerticeElementData(e,Ne.MESH_TEXTURECOORDINATE0);break;case 1:this._getVerticeElementData(e,Ne.MESH_TEXTURECOORDINATE1);break;default:throw"Mesh:Invalid channel."}}},{key:"setUVs",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;if(!this._isReadable)throw"Mesh:setUVs() need isReadable must be true or use setVertices().";switch(t){case 0:this._setVerticeElementData(e,Ne.MESH_TEXTURECOORDINATE0);break;case 1:this._setVerticeElementData(e,Ne.MESH_TEXTURECOORDINATE1);break;default:throw"Mesh:Invalid channel."}}},{key:"getNormals",value:function(e){if(!this._isReadable)throw"Mesh:can't get colors on mesh,isReadable must be true.";this._getVerticeElementData(e,Ne.MESH_NORMAL0)}},{key:"setNormals",value:function(e){if(!this._isReadable)throw"Mesh:setNormals() need must be true or use setVertices().";this._setVerticeElementData(e,Ne.MESH_NORMAL0)}},{key:"getTangents",value:function(e){if(!this._isReadable)throw"Mesh:can't get colors on mesh,isReadable must be true.";this._getVerticeElementData(e,Ne.MESH_TANGENT0)}},{key:"setTangents",value:function(e){if(!this._isReadable)throw"Mesh:setTangents() need isReadable must be true or use setVertices().";this._setVerticeElementData(e,Ne.MESH_TANGENT0)}},{key:"getBoneWeights",value:function(e){if(!this._isReadable)throw"Mesh:can't get boneWeights on mesh,isReadable must be true.";this._getVerticeElementData(e,Ne.MESH_BLENDWEIGHT0)}},{key:"setBoneWeights",value:function(e){if(!this._isReadable)throw"Mesh:setBoneWeights() need isReadable must be true or use setVertices().";this._setVerticeElementData(e,Ne.MESH_BLENDWEIGHT0)}},{key:"getBoneIndices",value:function(e){if(!this._isReadable)throw"Mesh:can't get boneIndices on mesh,isReadable must be true.";this._getVerticeElementData(e,Ne.MESH_BLENDINDICES0)}},{key:"setBoneIndices",value:function(e){if(!this._isReadable)throw"Mesh:setBoneIndices() need isReadable must be true or use setVertices().";this._setVerticeElementData(e,Ne.MESH_BLENDINDICES0)}},{key:"markAsUnreadbale",value:function(){this._uploadVerticesData(),this._vertexBuffer.markAsUnreadbale(),this._isReadable=!1}},{key:"getVertexDeclaration",value:function(){return this._vertexBuffer._vertexDeclaration}},{key:"getVertices",value:function(){if(this._isReadable)return this._vertexBuffer.getUint8Data().buffer.slice(0);throw"Mesh:can't get vertices on mesh,isReadable must be true."}},{key:"setVertices",value:function(e){this._vertexBuffer.setData(e),this._needUpdateBounds=!0}},{key:"getIndices",value:function(){if(this._isReadable)return this._indexBuffer.getData().slice();throw"Mesh:can't get indices on subMesh,mesh's isReadable must be true."}},{key:"setIndices",value:function(n){var i;n instanceof Uint32Array?i=e.IndexFormat.UInt32:n instanceof Uint16Array?i=e.IndexFormat.UInt16:n instanceof Uint8Array&&(i=e.IndexFormat.UInt8);var a=this._indexBuffer;this._indexFormat===i&&a.indexCount===n.length||(a.destroy(),this._indexBuffer=a=new Oe(i,n.length,t.LayaGL.instance.STATIC_DRAW,this._isReadable)),a.setData(n),this._indexFormat=i}},{key:"calculateBounds",value:function(){if(!this._isReadable)throw"Mesh:can't calculate bounds on subMesh,mesh's isReadable must be true.";if(this._needUpdateBounds){var e=this._tempVector30,t=this._tempVector31;e.x=e.y=e.z=Number.MAX_VALUE,t.x=t.y=t.z=-Number.MAX_VALUE;for(var n=this._vertexBuffer,i=this._getPositionElement(n),a=n.getFloat32Data(),r=n.vertexDeclaration.vertexStride/4,o=i._offset/4,s=0,l=a.length;s<l;s+=r){var u=s+o,c=a[u],h=a[u+1],_=a[u+2];e.x=Math.min(e.x,c),e.y=Math.min(e.y,h),e.z=Math.min(e.z,_),t.x=Math.max(t.x,c),t.y=Math.max(t.y,h),t.z=Math.max(t.z,_)}this._bounds.setMin(e),this._bounds.setMax(t),this._needUpdateBounds=!1}}},{key:"cloneTo",value:function(t){var n=t,i=this._vertexBuffer,a=new te(i._byteLength,i.bufferUsage,i.canRead);a.vertexDeclaration=i.vertexDeclaration,a.setData(i.getUint8Data().slice().buffer),n._vertexBuffer=a,n._vertexCount=this._vertexCount;var r,o=this._indexBuffer,s=new Oe(e.IndexFormat.UInt16,o.indexCount,o.bufferUsage,o.canRead);s.setData(o.getData().slice()),n._indexBuffer=s,n._setBuffer(n._vertexBuffer,s),n._setInstanceBuffer(this._instanceBufferStateType),n._setCPUMemory(this.cpuMemory),n._setGPUMemory(this.gpuMemory);var l=this._boneNames;if(l){var u=n._boneNames=[];for(r=0;r<l.length;r++)u[r]=l[r]}var c=this._inverseBindPoses;if(c){var h=n._inverseBindPoses=[];for(r=0;r<c.length;r++)h[r]=c[r]}var _=this._skinnedMatrixCaches.length;for(n._skinnedMatrixCaches.length=_,r=0;r<_;r++){var d=this._skinnedMatrixCaches[r];n._skinnedMatrixCaches[r]=new Di(d.subMeshIndex,d.batchIndex,d.batchBoneIndex)}for(r=0;r<this.subMeshCount;r++){var f=this._subMeshes[r],m=f._subIndexBufferStart,p=f._subIndexBufferCount,T=f._boneIndicesList,v=new Mi(n);v._subIndexBufferStart.length=m.length,v._subIndexBufferCount.length=p.length,v._boneIndicesList.length=T.length;for(var g=0;g<m.length;g++)v._subIndexBufferStart[g]=m[g];for(g=0;g<p.length;g++)v._subIndexBufferCount[g]=p[g];for(g=0;g<T.length;g++)v._boneIndicesList[g]=new Uint16Array(T[g]);v._indexBuffer=s,v._indexStart=f._indexStart,v._indexCount=f._indexCount,v._indices=new Uint16Array(s.getData().buffer,2*f._indexStart,f._indexCount);var E=n._vertexBuffer;v._vertexBuffer=E,n._subMeshes.push(v)}n._setSubMeshes(n._subMeshes)}},{key:"clone",value:function(){var e=new Mesh;return this.cloneTo(e),e}},{key:"inverseAbsoluteBindPoses",get:function(){return this._inverseBindPoses}},{key:"vertexCount",get:function(){return this._vertexCount}},{key:"indexCount",get:function(){return this._indexBuffer.indexCount}},{key:"subMeshCount",get:function(){return this._subMeshes.length}},{key:"bounds",get:function(){return this._bounds},set:function(e){this._bounds!==e&&e.cloneTo(this._bounds)}},{key:"indexFormat",get:function(){return this._indexFormat}}],[{key:"__init__",value:function(){var e=k._bullet;e&&(Mesh._nativeTempVector30=e.btVector3_create(0,0,0),Mesh._nativeTempVector31=e.btVector3_create(0,0,0),Mesh._nativeTempVector32=e.btVector3_create(0,0,0))}},{key:"load",value:function(e,n){t.ILaya.loader.create(e,n,null,Mesh.MESH)}}]),Mesh}();xi.MESH="MESH",xi.MESH_INSTANCEBUFFER_TYPE_NORMAL=0,xi.MESH_INSTANCEBUFFER_TYPE_SIMPLEANIMATOR=1;var Ai=function(){function PrimitiveMesh(){_classCallCheck(this,PrimitiveMesh)}return _createClass(PrimitiveMesh,null,[{key:"__init__",value:function(){}},{key:"_createMesh",value:function(n,i,a){var r=t.LayaGL.instance,o=new xi,s=new Mi(o),l=new te(4*i.length,r.STATIC_DRAW,!0);l.vertexDeclaration=n,l.setData(i.buffer),o._vertexBuffer=l,o._vertexCount=l._byteLength/n.vertexStride;var u=new Oe(e.IndexFormat.UInt16,a.length,r.STATIC_DRAW,!0);u.setData(a),o._indexBuffer=u,o._setBuffer(l,u),o._setInstanceBuffer(o._instanceBufferStateType),s._vertexBuffer=l,s._indexBuffer=u,s._setIndexRange(0,u.indexCount);var c=s._subIndexBufferStart,h=s._subIndexBufferCount,_=s._boneIndicesList;c.length=1,h.length=1,_.length=1,c[0]=0,h[0]=u.indexCount;var d=[];d.push(s),o._setSubMeshes(d),o.calculateBounds();var f=l._byteLength+u._byteLength;return o._setCPUMemory(f),o._setGPUMemory(f),o}},{key:"createBox",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1,i=Ne.getVertexDeclaration("POSITION,NORMAL,UV"),a=e/2,r=t/2,o=n/2,s=new Float32Array([-a,r,-o,0,1,0,0,0,a,r,-o,0,1,0,1,0,a,r,o,0,1,0,1,1,-a,r,o,0,1,0,0,1,-a,-r,-o,0,-1,0,0,1,a,-r,-o,0,-1,0,1,1,a,-r,o,0,-1,0,1,0,-a,-r,o,0,-1,0,0,0,-a,r,-o,-1,0,0,0,0,-a,r,o,-1,0,0,1,0,-a,-r,o,-1,0,0,1,1,-a,-r,-o,-1,0,0,0,1,a,r,-o,1,0,0,1,0,a,r,o,1,0,0,0,0,a,-r,o,1,0,0,0,1,a,-r,-o,1,0,0,1,1,-a,r,o,0,0,1,0,0,a,r,o,0,0,1,1,0,a,-r,o,0,0,1,1,1,-a,-r,o,0,0,1,0,1,-a,r,-o,0,0,-1,1,0,a,r,-o,0,0,-1,0,0,a,-r,-o,0,0,-1,0,1,-a,-r,-o,0,0,-1,1,1]),l=new Uint16Array([0,1,2,2,3,0,4,7,6,6,5,4,8,9,10,10,11,8,12,15,14,14,13,12,16,17,18,18,19,16,20,23,22,22,21,20]);return PrimitiveMesh._createMesh(i,s,l)}},{key:"createCapsule",value:function(){var e,t,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:.5,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:2,a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:16,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:32,o=(a+1)*(r+1)*2+2*(r+1),s=3*a*(r+1)*2*2+2*r*3,l=Ne.getVertexDeclaration("POSITION,NORMAL,UV"),u=l.vertexStride/4,c=new Float32Array(o*u),h=new Uint16Array(s),_=Math.PI/2/a,d=2*Math.PI/r,f=i/2-n,m=0,p=0,T=0,v=0,g=0,E=0;for(e=0;e<=a;e++)for(t=0;t<=r;t++)m=n*Math.cos(e*_)*Math.cos(t*d+Math.PI),p=n*Math.sin(e*_),T=n*Math.cos(e*_)*Math.sin(t*d+Math.PI),c[v++]=m,c[v++]=p+f,c[v++]=T,c[v++]=m,c[v++]=p,c[v++]=T,c[v++]=1-t/r,c[v++]=(1-e/a)*(Math.PI*n/2/(i+Math.PI*n)),e<a&&(h[g++]=e*(r+1)+t+(r+1),h[g++]=e*(r+1)+t,h[g++]=e*(r+1)+t+1,h[g++]=e*(r+1)+t+r,h[g++]=e*(r+1)+t,h[g++]=e*(r+1)+t+(r+1));for(E+=(a+1)*(r+1),e=0;e<=a;e++)for(t=0;t<=r;t++)m=n*Math.cos(e*_)*Math.cos(t*d+Math.PI),p=n*Math.sin(-e*_),T=n*Math.cos(e*_)*Math.sin(t*d+Math.PI),c[v++]=m,c[v++]=p-f,c[v++]=T,c[v++]=m,c[v++]=p,c[v++]=T,c[v++]=1-t/r,c[v++]=(e/a*(Math.PI*n/2)+(i+Math.PI*n/2))/(i+Math.PI*n),e<a&&(h[g++]=E+e*(r+1)+t,h[g++]=E+e*(r+1)+t+(r+1),h[g++]=E+e*(r+1)+t+1,h[g++]=E+e*(r+1)+t,h[g++]=E+e*(r+1)+t+r,h[g++]=E+e*(r+1)+t+(r+1));for(E+=(a+1)*(r+1),t=0;t<=r;t++)m=n*Math.cos(t*d+Math.PI),p=f,T=n*Math.sin(t*d+Math.PI),c[v++]=m,c[v+8*(r+1)-1]=m,c[v++]=p,c[v+8*(r+1)-1]=-p,c[v++]=T,c[v+8*(r+1)-1]=T,c[v++]=m,c[v+8*(r+1)-1]=m,c[v++]=0,c[v+8*(r+1)-1]=0,c[v++]=T,c[v+8*(r+1)-1]=T,c[v++]=1-1*t/r,c[v+8*(r+1)-1]=1-1*t/r,c[v++]=Math.PI*n/2/(i+Math.PI*n),c[v+8*(r+1)-1]=(Math.PI*n/2+i)/(i+Math.PI*n);for(t=0;t<r;t++)h[g++]=t+E+(r+1),h[g++]=t+E+1,h[g++]=t+E,h[g++]=t+E+(r+1),h[g++]=t+E+(r+1)+1,h[g++]=t+E+1;return E+=2*(r+1),PrimitiveMesh._createMesh(l,c,h)}},{key:"createCone",value:function(){for(var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:.5,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:32,a=i+1+1+2*(i+1),r=6*i+3*i,s=Ne.getVertexDeclaration("POSITION,NORMAL,UV"),l=s.vertexStride/4,c=new Float32Array(a*l),h=new Uint16Array(r),_=2*Math.PI/i,d=n/2,f=0,m=0,p=0,T=0,v=0,g=new o,E=new o(0,-1,0),y=new o(0,d,0),S=new o,R=new o,C=new u,M=new o,D=0,x=0,A=0;A<=i;A++)f=A*_,p=Math.cos(f+Math.PI)*t,T=d,v=Math.sin(f+Math.PI)*t,c[D++]=0,c[D+8*(i+1)-1]=p,c[D++]=T,c[D+8*(i+1)-1]=-T,c[D++]=0,c[D+8*(i+1)-1]=v,g.x=p,g.y=0,g.z=v,S.x=p,S.y=-T,S.z=v,o.subtract(S,y,R),o.normalize(R,R),e=Math.acos(o.dot(E,R)),o.cross(E,R,M),o.normalize(M,M),u.createFromAxisAngle(M,e,C),o.normalize(g,g),o.transformQuat(g,C,g),o.normalize(g,g),c[D++]=g.x,c[D+8*(i+1)-1]=g.x,c[D++]=g.y,c[D+8*(i+1)-1]=g.y,c[D++]=g.z,c[D+8*(i+1)-1]=g.z,c[D++]=1-1*A/i,c[D+8*(i+1)-1]=1-1*A/i,c[D++]=0,c[D+8*(i+1)-1]=1;D+=8*(i+1);for(var I=0;I<i;I++)h[x++]=I+m+(i+1),h[x++]=I+m+1,h[x++]=I+m,h[x++]=I+m+(i+1),h[x++]=I+m+(i+1)+1,h[x++]=I+m+1;m+=2*(i+1);for(var L=0;L<=i;L++)0===L&&(c[D++]=0,c[D++]=-d,c[D++]=0,c[D++]=0,c[D++]=-1,c[D++]=0,c[D++]=.5,c[D++]=.5),f=L*_,p=Math.cos(f+Math.PI)*t,T=-d,v=Math.sin(f+Math.PI)*t,c[D++]=p,c[D++]=T,c[D++]=v,c[D++]=0,c[D++]=-1,c[D++]=0,c[D++]=.5+.5*Math.cos(f),c[D++]=.5+.5*Math.sin(f);for(var P=0;P<i;P++)h[x++]=0+m,h[x++]=P+2+m,h[x++]=P+1+m;return m+=i+1+1,PrimitiveMesh._createMesh(s,c,h)}},{key:"createCylinder",value:function(){for(var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:.5,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:2,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:32,i=n+1+1+2*(n+1)+(n+1+1),a=3*n+6*n+3*n,r=Ne.getVertexDeclaration("POSITION,NORMAL,UV"),o=r.vertexStride/4,s=new Float32Array(i*o),l=new Uint16Array(a),u=2*Math.PI/n,c=t/2,h=0,_=0,d=0,f=0,m=0,p=0,T=0,v=0;v<=n;v++)0===v&&(s[p++]=0,s[p++]=c,s[p++]=0,s[p++]=0,s[p++]=1,s[p++]=0,s[p++]=.5,s[p++]=.5),h=v*u,d=Math.cos(h)*e,f=c,m=Math.sin(h)*e,s[p++]=d,s[p++]=f,s[p++]=m,s[p++]=0,s[p++]=1,s[p++]=0,s[p++]=.5+.5*Math.cos(h),s[p++]=.5+.5*Math.sin(h);for(var g=0;g<n;g++)l[T++]=0,l[T++]=g+1,l[T++]=g+2;_+=n+1+1;for(var E=0;E<=n;E++)h=E*u,d=Math.cos(h+Math.PI)*e,f=c,m=Math.sin(h+Math.PI)*e,s[p++]=d,s[p+8*(n+1)-1]=d,s[p++]=f,s[p+8*(n+1)-1]=-f,s[p++]=m,s[p+8*(n+1)-1]=m,s[p++]=d,s[p+8*(n+1)-1]=d,s[p++]=0,s[p+8*(n+1)-1]=0,s[p++]=m,s[p+8*(n+1)-1]=m,s[p++]=1-1*E/n,s[p+8*(n+1)-1]=1-1*E/n,s[p++]=0,s[p+8*(n+1)-1]=1;p+=8*(n+1);for(var y=0;y<n;y++)l[T++]=y+_+(n+1),l[T++]=y+_+1,l[T++]=y+_,l[T++]=y+_+(n+1),l[T++]=y+_+(n+1)+1,l[T++]=y+_+1;_+=2*(n+1);for(var S=0;S<=n;S++)0===S&&(s[p++]=0,s[p++]=-c,s[p++]=0,s[p++]=0,s[p++]=-1,s[p++]=0,s[p++]=.5,s[p++]=.5),h=S*u,d=Math.cos(h+Math.PI)*e,f=-c,m=Math.sin(h+Math.PI)*e,s[p++]=d,s[p++]=f,s[p++]=m,s[p++]=0,s[p++]=-1,s[p++]=0,s[p++]=.5+.5*Math.cos(h),s[p++]=.5+.5*Math.sin(h);for(var R=0;R<n;R++)l[T++]=0+_,l[T++]=R+2+_,l[T++]=R+1+_;return _+=n+1+1,PrimitiveMesh._createMesh(r,s,l)}},{key:"createPlane",value:function(){for(var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:10,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:10,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:10,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:10,a=(n+1)*(i+1),r=new Uint16Array(n*i*2*3),o=Ne.getVertexDeclaration("POSITION,NORMAL,UV"),s=o.vertexStride/4,l=new Float32Array(a*s),u=e/2,c=t/2,h=e/n,_=t/i,d=0,f=0;f<=i;f++)for(var m=0;m<=n;m++)l[d++]=m*h-u,l[d++]=0,l[d++]=f*_-c,l[d++]=0,l[d++]=1,l[d++]=0,l[d++]=1*m/n,l[d++]=1*f/i;var p=0;for(f=0;f<i;f++)for(m=0;m<n;m++)r[p++]=(f+1)*(n+1)+m,r[p++]=f*(n+1)+m,r[p++]=(f+1)*(n+1)+m+1,r[p++]=f*(n+1)+m,r[p++]=f*(n+1)+m+1,r[p++]=(f+1)*(n+1)+m+1;return PrimitiveMesh._createMesh(o,l,r)}},{key:"createQuad",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,n=Ne.getVertexDeclaration("POSITION,NORMAL,UV"),i=e/2,a=t/2,r=new Float32Array([-i,a,0,0,0,1,0,0,i,a,0,0,0,1,1,0,-i,-a,0,0,0,1,0,1,i,-a,0,0,0,1,1,1]),o=new Uint16Array([0,1,2,3,2,1]);return PrimitiveMesh._createMesh(n,r,o)}},{key:"createSphere",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:.5,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:32,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:32,i=(t+1)*(n+1),a=3*t*(n+1)*2,r=new Uint16Array(a),o=Ne.getVertexDeclaration("POSITION,NORMAL,UV"),s=o.vertexStride/4,l=new Float32Array(i*s),u=Math.PI/t,c=2*Math.PI/n,h=0;i=0,a=0;for(var _=0;_<t+1;_++)for(var d=Math.sin(_*u),f=Math.cos(_*u),m=0;m<n+1;m++){var p=d*Math.sin(m*c+1*Math.PI/2),T=d*Math.cos(m*c+1*Math.PI/2);l[i+0]=p*e,l[i+1]=f*e,l[i+2]=T*e,l[i+3]=p,l[i+4]=f,l[i+5]=T,l[i+6]=m/n,l[i+7]=_/t,i+=s,_!=t-1&&(r[a++]=h+(n+1),r[a++]=h,r[a++]=h+1,r[a++]=h+n,r[a++]=h,r[a++]=h+(n+1),h++)}return PrimitiveMesh._createMesh(o,l,r)}}]),PrimitiveMesh}(),Ii='#include "Lighting.glsl";\n#if defined(GL_FRAGMENT_PRECISION_HIGH)// 原来的写法会被我们自己的解析流程处理，而我们的解析是不认内置宏的，导致被删掉，所以改成 if defined 了\n\tprecision highp float;\n#else\n\tprecision mediump float;\n#endif\nattribute vec4 a_PositionTexcoord;\nvarying vec2 v_Texcoord0;\n\nvoid main() {\n\tgl_Position = vec4(a_PositionTexcoord.xy, 0.0, 1.0);\n\tv_Texcoord0 = a_PositionTexcoord.zw;\n\tgl_Position = remapGLPositionZ(gl_Position);\n}',Li=function(){function ShaderInit3D(){_classCallCheck(this,ShaderInit3D)}return _createClass(ShaderInit3D,null,[{key:"__init__",value:function(){_e.SHADERDEFINE_LEGACYSINGALLIGHTING=_e.getDefineByName("LEGACYSINGLELIGHTING"),_e.SHADERDEFINE_GRAPHICS_API_GLES2=_e.getDefineByName("GRAPHICS_API_GLES2"),_e.SHADERDEFINE_GRAPHICS_API_GLES3=_e.getDefineByName("GRAPHICS_API_GLES3"),_e.addInclude("Lighting.glsl","#ifdef GRAPHICS_API_GLES3\n\t#define INVERSE_MAT(mat) inverse(mat)\n#else\n\t#define INVERSE_MAT(mat) inverseMat(mat)\n#endif\n\nstruct DirectionLight {\n\tvec3 color;\n\tvec3 direction;\n};\n\nstruct PointLight {\n\tvec3 color;\n\tvec3 position;\n\tfloat range;\n};\n\nstruct SpotLight {\n\tvec3 color;\n\tvec3 position;\n\tfloat range;\n\tvec3 direction;\n\tfloat spot;\n};\n\nstruct LayaGI{\n\tvec3 diffuse;\n\tvec3 specular;\n};\n\nstruct LayaLight{\n\tvec3 color;\n\tvec3 dir;\n};\n\nconst int c_ClusterBufferWidth = CLUSTER_X_COUNT*CLUSTER_Y_COUNT;\nconst int c_ClusterBufferHeight = CLUSTER_Z_COUNT*(1+int(ceil(float(MAX_LIGHT_COUNT_PER_CLUSTER)/4.0)));\nconst int c_ClusterBufferFloatWidth = c_ClusterBufferWidth*4;\n\n#ifndef GRAPHICS_API_GLES3\n\tmat3 inverseMat(mat3 m) {\n\t\tfloat a00 = m[0][0], a01 = m[0][1], a02 = m[0][2];\n\t\tfloat a10 = m[1][0], a11 = m[1][1], a12 = m[1][2];\n\t\tfloat a20 = m[2][0], a21 = m[2][1], a22 = m[2][2];\n\n\t\tfloat b01 = a22 * a11 - a12 * a21;\n\t\tfloat b11 = -a22 * a10 + a12 * a20;\n\t\tfloat b21 = a21 * a10 - a11 * a20;\n\n\t\tfloat det = a00 * b01 + a01 * b11 + a02 * b21;\n\n\t\treturn mat3(b01, (-a22 * a01 + a02 * a21), (a12 * a01 - a02 * a11),\n\t\t\t\t\tb11, (a22 * a00 - a02 * a20), (-a12 * a00 + a02 * a10),\n\t\t\t\t\tb21, (-a21 * a00 + a01 * a20), (a11 * a00 - a01 * a10)) / det;\n\t}\n#endif\n\n\t#ifdef THICKNESSMAP\n\t\tuniform sampler2D u_ThinknessTexture;\n\t#endif\n#ifdef ENABLETRANSMISSION\n\tuniform float u_TransmissionRate;\n\tuniform float u_BackDiffuse;\n\tuniform float u_BackScale;\n\tuniform vec4 u_TransmissionColor;\n\n\n\tvec3 SubSurfaceIBack(vec3 lightDir,vec3 viewDir,float thinknessFactor){\n\t\tvec3 H = normalize(lightDir);\n\t\tfloat VdotH = pow(clamp(dot(viewDir,H),0.0,1.0),u_BackDiffuse)*u_BackScale;\n\t\tvec3 I;\n\t\t#ifdef THICKNESSMAP\n\t\t\tI = u_TransmissionColor.rgb*VdotH*thinknessFactor;\n\t\t#else\n\t\t\tI = u_TransmissionColor.rgb*VdotH;\n\t\t#endif\n\t\treturn I;\n\t}\n#endif\n\nivec4 getClusterInfo(sampler2D clusterBuffer,mat4 viewMatrix,vec4 viewport,vec3 position,vec4 fragCoord,vec4 projectParams)\n{\n\tvec3 viewPos = vec3(viewMatrix*vec4(position, 1.0)); //position in viewspace\n\n\tint clusterXIndex = int(floor(fragCoord.x/ (float(viewport.z)/float(CLUSTER_X_COUNT))));\n    int clusterYIndex = int(floor((viewport.w * (projectParams.z <0.0? 0.0 : 1.0) - fragCoord.y * projectParams.z)/ (float(viewport.w)/float(CLUSTER_Y_COUNT))));//Maybe Flipped ProjectMatrix\n\tfloat zSliceParam =float(CLUSTER_Z_COUNT)/log2(projectParams.y / projectParams.x);\n \tint clusterZIndex = int(floor(log2(-viewPos.z) * zSliceParam- log2(projectParams.x) * zSliceParam));//projectParams x:cameraNear y:cameraFar\n\n\tvec2 uv= vec2((float(clusterXIndex + clusterYIndex * CLUSTER_X_COUNT)+0.5)/float(c_ClusterBufferWidth),\n\t\t\t\t(float(clusterZIndex)+0.5)/float(c_ClusterBufferHeight));\n\tvec4 clusterPixel=texture2D(clusterBuffer, uv);\n\treturn ivec4(clusterPixel);//X:Point Count Y:Spot Count Z、W:Light Offset\n}\n\n\nint getLightIndex(sampler2D clusterBuffer,int offset,int index) \n{\n\tint totalOffset=offset+index;\n\tint row=totalOffset/c_ClusterBufferFloatWidth;\n\tint lastRowFloat=totalOffset-row*c_ClusterBufferFloatWidth;\n\tint col=lastRowFloat/4;\n\tvec2 uv=vec2((float(col)+0.5)/float(c_ClusterBufferWidth),\n\t\t\t\t(float(row)+0.5)/float(c_ClusterBufferHeight));\n\tvec4 texel = texture2D(clusterBuffer, uv);\n    int pixelComponent = lastRowFloat-col*4;\n    if (pixelComponent == 0) \n      return int(texel.x);\n    else if (pixelComponent == 1) \n      return int(texel.y);\n    else if (pixelComponent == 2) \n      return int(texel.z);\n    else //pixelComponent==3\n      return int(texel.w);\n}\n\nDirectionLight getDirectionLight(sampler2D lightBuffer,int index) \n{\n    DirectionLight light;\n    float v = (float(index)+0.5)/ float(MAX_LIGHT_COUNT);\n    vec4 p1 = texture2D(lightBuffer, vec2(0.125,v));\n    vec4 p2 = texture2D(lightBuffer, vec2(0.375,v));\n\tlight.color=p1.rgb;\n    light.direction = p2.rgb;\n    return light;\n}\n\nPointLight getPointLight(sampler2D lightBuffer,sampler2D clusterBuffer,ivec4 clusterInfo,int index) \n{\n    PointLight light;\n\tint pointIndex=getLightIndex(clusterBuffer,clusterInfo.z*c_ClusterBufferFloatWidth+clusterInfo.w,index);\n    float v = (float(pointIndex)+0.5)/ float(MAX_LIGHT_COUNT);\n    vec4 p1 = texture2D(lightBuffer, vec2(0.125,v));\n    vec4 p2 = texture2D(lightBuffer, vec2(0.375,v));\n\tlight.color=p1.rgb;\n\tlight.range = p1.a;\n    light.position = p2.rgb;\n    return light;\n}\n\nSpotLight getSpotLight(sampler2D lightBuffer,sampler2D clusterBuffer,ivec4 clusterInfo,int index) \n{\n    SpotLight light;\n\tint spoIndex=getLightIndex(clusterBuffer,clusterInfo.z*c_ClusterBufferFloatWidth+clusterInfo.w,clusterInfo.x+index);\n    float v = (float(spoIndex)+0.5)/ float(MAX_LIGHT_COUNT);\n    vec4 p1 = texture2D(lightBuffer, vec2(0.125,v));\n    vec4 p2 = texture2D(lightBuffer, vec2(0.375,v));\n\tvec4 p3 = texture2D(lightBuffer, vec2(0.625,v));\n    light.color = p1.rgb;\n\tlight.range=p1.a;\n    light.position = p2.rgb;\n\tlight.spot = p2.a;\n\tlight.direction = p3.rgb;\n    return light;\n}\n\n// Laya中使用衰减纹理\nfloat LayaAttenuation(in vec3 L,in float invLightRadius) {\n\tfloat fRatio = clamp(length(L) * invLightRadius,0.0,1.0);\n\tfRatio *= fRatio;\n\treturn 1.0 / (1.0 + 25.0 * fRatio)* clamp(4.0*(1.0 - fRatio),0.0,1.0); //fade to black as if 4 pixel texture\n}\n\n// Same as Just Cause 2 and Crysis 2 (you can read GPU Pro 1 book for more information)\nfloat BasicAttenuation(in vec3 L,in float invLightRadius) {\n\tvec3 distance = L * invLightRadius;\n\tfloat attenuation = clamp(1.0 - dot(distance, distance),0.0,1.0); // Equals float attenuation = saturate(1.0f - dot(L, L) / (lightRadius *  lightRadius));\n\treturn attenuation * attenuation;\n}\n\n// Inspired on http://fools.slindev.com/viewtopic.php?f=11&t=21&view=unread#unread\nfloat NaturalAttenuation(in vec3 L,in float invLightRadius) {\n\tfloat attenuationFactor = 30.0;\n\tvec3 distance = L * invLightRadius;\n\tfloat attenuation = dot(distance, distance); // Equals float attenuation = dot(L, L) / (lightRadius *  lightRadius);\n\tattenuation = 1.0 / (attenuation * attenuationFactor + 1.0);\n\t// Second we move down the function therewith it reaches zero at abscissa 1:\n\tattenuationFactor = 1.0 / (attenuationFactor + 1.0); //attenuationFactor contains now the value we have to subtract\n\tattenuation = max(attenuation - attenuationFactor, 0.0); // The max fixes a bug.\n\t// Finally we expand the equation along the y-axis so that it starts with a function value of 1 again.\n\tattenuation /= 1.0 - attenuationFactor;\n\treturn attenuation;\n}\n\nvoid LayaAirBlinnPhongLight (in vec3 specColor,in float specColorIntensity,in vec3 normal,in vec3 gloss, in vec3 viewDir,in vec3 lightColor, in vec3 lightVec,out vec3 diffuseColor,out vec3 specularColor) {\n\tmediump vec3 h = normalize(viewDir-lightVec);\n\tlowp float ln = max (0.0, dot (-lightVec,normal));\n\tfloat nh = max (0.0, dot (h,normal));\n\tdiffuseColor=lightColor * ln;\n\tspecularColor=lightColor *specColor*pow (nh, specColorIntensity*128.0) * gloss;\n}\n\nvoid LayaAirBlinnPhongDiectionLight (in vec3 specColor,in float specColorIntensity,in vec3 normal,in vec3 gloss, in vec3 viewDir, in DirectionLight light,float thinknessFactor,out vec3 diffuseColor,out vec3 specularColor,out vec3 transmisColor) {\n\tvec3 lightVec=normalize(light.direction);\n\tLayaAirBlinnPhongLight(specColor,specColorIntensity,normal,gloss,viewDir,light.color,lightVec,diffuseColor,specularColor);\n\t#ifdef ENABLETRANSMISSION\n\t\tdiffuseColor *= u_TransmissionRate;\n\t\ttransmisColor = SubSurfaceIBack(lightVec, viewDir,thinknessFactor)*light.color.rgb*(1.0-u_TransmissionRate);\n\t#endif\n}\n\n\nvoid LayaAirBlinnPhongDiectionLight (in vec3 specColor,in float specColorIntensity,in vec3 normal,in vec3 gloss, in vec3 viewDir, in DirectionLight light,out vec3 diffuseColor,out vec3 specularColor) {\n\tvec3 lightVec=normalize(light.direction);\n\tLayaAirBlinnPhongLight(specColor,specColorIntensity,normal,gloss,viewDir,light.color,lightVec,diffuseColor,specularColor);\n}\n\n\nvoid LayaAirBlinnPhongPointLight (in vec3 pos,in vec3 specColor,in float specColorIntensity,in vec3 normal,in vec3 gloss, in vec3 viewDir, in PointLight light,float thinknessFactor,out vec3 diffuseColor,out vec3 specularColor,out vec3 transmisColor) {\n\tvec3 lightVec =  pos-light.position;\n\tLayaAirBlinnPhongLight(specColor,specColorIntensity,normal,gloss,viewDir,light.color,lightVec/length(lightVec),diffuseColor,specularColor);\n\tfloat attenuate = LayaAttenuation(lightVec, 1.0/light.range);\n\tdiffuseColor *= attenuate;\n\tspecularColor*= attenuate;\n\t#ifdef ENABLETRANSMISSION\n\t\tdiffuseColor *= u_TransmissionRate;\n\t\ttransmisColor = SubSurfaceIBack(lightVec, viewDir,thinknessFactor)*light.color.rgb*(1.0-u_TransmissionRate)*attenuate;\n\t#endif\n}\n\nvoid LayaAirBlinnPhongPointLight (in vec3 pos,in vec3 specColor,in float specColorIntensity,in vec3 normal,in vec3 gloss, in vec3 viewDir, in PointLight light,out vec3 diffuseColor,out vec3 specularColor) {\n\tvec3 lightVec =  pos-light.position;\n\tLayaAirBlinnPhongLight(specColor,specColorIntensity,normal,gloss,viewDir,light.color,lightVec/length(lightVec),diffuseColor,specularColor);\n\tfloat attenuate = LayaAttenuation(lightVec, 1.0/light.range);\n\tdiffuseColor *= attenuate;\n\tspecularColor*= attenuate;\n}\n\nvoid LayaAirBlinnPhongSpotLight (in vec3 pos,in vec3 specColor,in float specColorIntensity,in vec3 normal,in vec3 gloss, in vec3 viewDir, in SpotLight light,float thinknessFactor,out vec3 diffuseColor,out vec3 specularColor,out vec3 transmisColor) {\n\tvec3 lightVec =  pos-light.position;\n\tvec3 normalLightVec=lightVec/length(lightVec);\n\tLayaAirBlinnPhongLight(specColor,specColorIntensity,normal,gloss,viewDir,light.color,normalLightVec,diffuseColor,specularColor);\n\tvec2 cosAngles=cos(vec2(light.spot,light.spot*0.5)*0.5);//ConeAttenuation\n\tfloat dl=dot(normalize(light.direction),normalLightVec);\n\tdl*=smoothstep(cosAngles[0],cosAngles[1],dl);\n\tfloat attenuate = LayaAttenuation(lightVec, 1.0/light.range)*dl;\n\tdiffuseColor *=attenuate;\n\tspecularColor *=attenuate;\n\t#ifdef ENABLETRANSMISSION\n\t\tdiffuseColor *= u_TransmissionRate;\n\t\ttransmisColor = SubSurfaceIBack(lightVec, viewDir,thinknessFactor)*light.color.rgb*(1.0-u_TransmissionRate)*attenuate;\n\t#endif\n}\n\nvoid LayaAirBlinnPhongSpotLight (in vec3 pos,in vec3 specColor,in float specColorIntensity,in vec3 normal,in vec3 gloss, in vec3 viewDir, in SpotLight light,out vec3 diffuseColor,out vec3 specularColor) {\n\tvec3 lightVec =  pos-light.position;\n\tvec3 normalLightVec=lightVec/length(lightVec);\n\tLayaAirBlinnPhongLight(specColor,specColorIntensity,normal,gloss,viewDir,light.color,normalLightVec,diffuseColor,specularColor);\n\tvec2 cosAngles=cos(vec2(light.spot,light.spot*0.5)*0.5);//ConeAttenuation\n\tfloat dl=dot(normalize(light.direction),normalLightVec);\n\tdl*=smoothstep(cosAngles[0],cosAngles[1],dl);\n\tfloat attenuate = LayaAttenuation(lightVec, 1.0/light.range)*dl;\n\tdiffuseColor *=attenuate;\n\tspecularColor *=attenuate;\n}\n\n\n\n\nvec3 NormalSampleToWorldSpace(vec3 normalMapSample, vec3 unitNormal, vec3 tangent,vec3 binormal) {\n\tvec3 normalT =vec3(2.0*normalMapSample.x - 1.0,1.0-2.0*normalMapSample.y,2.0*normalMapSample.z - 1.0);\n\tmediump vec3 N = unitNormal;\n\tmediump vec3 T = tangent;\n\tmediump vec3 B = binormal;\n\tmat3 TBN = mat3(T, B, N);\n\n\t// Transform from tangent space to world space.\n\tvec3 bumpedNormal =normalize(TBN*normalT);\n\treturn bumpedNormal;\n}\n\nvec3 NormalSampleToWorldSpace1(vec4 normalMapSample, vec3 tangent, vec3 binormal, vec3 unitNormal) {\n\tvec3 normalT;\n\tnormalT.x = 2.0 * normalMapSample.x - 1.0;\n\tnormalT.y = 1.0 - 2.0 * normalMapSample.y;\n\tnormalT.z = sqrt(1.0 - clamp(dot(normalT.xy, normalT.xy), 0.0, 1.0));\n\n\tvec3 T = normalize(tangent);\n\tvec3 B = normalize(binormal);\n\tvec3 N = normalize(unitNormal);\n\tmat3 TBN = mat3(T, B, N);\n\n\t// Transform from tangent space to world space.\n\tvec3 bumpedNormal = TBN * normalize(normalT);\n\n\treturn bumpedNormal;\n}\n\nvec3 DecodeLightmap(vec4 color) {\n\treturn color.rgb*color.a*5.0;\n}\n\nvec3 decodeHDR(vec4 color,float range) {\n\treturn color.rgb*color.a*range;\n}\n\nvec2 TransformUV(vec2 texcoord,vec4 tilingOffset) {\n\tvec2 transTexcoord=vec2(texcoord.x,texcoord.y-1.0)*tilingOffset.xy+vec2(tilingOffset.z,-tilingOffset.w);\n\ttransTexcoord.y+=1.0;\n\treturn transTexcoord;\n}\n\nvec4 remapGLPositionZ(vec4 position) {\n\tposition.z=position.z * 2.0 - position.w;\n\treturn position;\n}\n\nmediump vec3 layaLinearToGammaSpace (mediump vec3 linRGB)\n{\n    linRGB = max(linRGB, vec3(0.0));\n    // An almost-perfect approximation from http://chilliant.blogspot.com.au/2012/08/srgb-approximations-for-hlsl.html?m=1\n    return max(1.055 * pow(linRGB,vec3(0.416666667)) - 0.055, 0.0);   \n}\n\nLayaLight layaDirectionLightToLight(in DirectionLight light,in float attenuate)\n{\n\tLayaLight relight;\n\trelight.color = light.color*attenuate;\n\trelight.dir = light.direction;\n\treturn relight;\n}\n\nLayaLight layaPointLightToLight(in vec3 pos,in vec3 normal, in PointLight light,in float attenuate)\n{\n\tLayaLight relight;\n\tvec3 lightVec =  pos-light.position;\n\tattenuate *= LayaAttenuation(lightVec, 1.0/light.range);\n\trelight.color = light.color*attenuate;\n\trelight.dir = normalize(lightVec);\n\treturn relight;\n}\n\nLayaLight layaSpotLightToLight(in vec3 pos,in vec3 normal, in SpotLight light,in float attenuate)\n{\n\tLayaLight relight;\n\tvec3 lightVec =  pos-light.position;\n\tvec3 normalLightVec=lightVec/length(lightVec);\n\tvec2 cosAngles=cos(vec2(light.spot,light.spot*0.5)*0.5);//ConeAttenuation\n\tfloat dl=dot(normalize(light.direction),normalLightVec);\n\tdl*=smoothstep(cosAngles[0],cosAngles[1],dl);\n\tattenuate *= LayaAttenuation(lightVec, 1.0/light.range)*dl;\n\trelight.dir = normalLightVec;\n\trelight.color = light.color*attenuate;\n\treturn relight;\n}\n\n\n\n\n"),_e.addInclude("ShadowSampleTent.glsl",'// ------------------------------------------------------------------\n//  PCF Filtering Tent Functions\n// ------------------------------------------------------------------\n\n// Assuming a isoceles right angled triangle of height "triangleHeight" (as drawn below).\n// This function return the area of the triangle above the first texel(in Y the first texel).\n//\n// |\\      <-- 45 degree slop isosceles right angled triangle\n// | \\\n// ----    <-- length of this side is "triangleHeight"\n// _ _ _ _ <-- texels\nfloat sampleShadowGetIRTriangleTexelArea(float triangleHeight)\n{\n    return triangleHeight - 0.5;\n}\n\n// Assuming a isoceles triangle of 1.5 texels height and 3 texels wide lying on 4 texels.\n// This function return the area of the triangle above each of those texels.\n//    |    <-- offset from -0.5 to 0.5, 0 meaning triangle is exactly in the center\n//   / \\   <-- 45 degree slop isosceles triangle (ie tent projected in 2D)\n//  /   \\\n// _ _ _ _ <-- texels\n// X Y Z W <-- result indices (in computedArea.xyzw and computedAreaUncut.xyzw)\n// Top point at (right,top) in a texel,left bottom point at (middle,middle) in a texel,right bottom point at (middle,middle) in a texel.\nvoid sampleShadowGetTexelAreasTent3x3(float offset, out vec4 computedArea, out vec4 computedAreaUncut)\n{\n    // Compute the exterior areas,a and h is same.\n    float a = offset + 0.5;\n    float offsetSquaredHalved = a * a * 0.5;\n    computedAreaUncut.x = computedArea.x = offsetSquaredHalved - offset;\n    computedAreaUncut.w = computedArea.w = offsetSquaredHalved;\n\n    // Compute the middle areas\n    // For Y : We find the area in Y of as if the left section of the isoceles triangle would\n    // intersect the axis between Y and Z (ie where offset = 0).\n    computedAreaUncut.y = sampleShadowGetIRTriangleTexelArea(1.5 - offset);\n    // This area is superior to the one we are looking for if (offset < 0) thus we need to\n    // subtract the area of the triangle defined by (0,1.5-offset), (0,1.5+offset), (-offset,1.5).\n    float clampedOffsetLeft = min(offset,0.0);\n    float areaOfSmallLeftTriangle = clampedOffsetLeft * clampedOffsetLeft;\n    computedArea.y = computedAreaUncut.y - areaOfSmallLeftTriangle;\n\n    // We do the same for the Z but with the right part of the isoceles triangle\n    computedAreaUncut.z = sampleShadowGetIRTriangleTexelArea(1.5 + offset);\n    float clampedOffsetRight = max(offset,0.0);\n    float areaOfSmallRightTriangle = clampedOffsetRight * clampedOffsetRight;\n    computedArea.z = computedAreaUncut.z - areaOfSmallRightTriangle;\n}\n\n// Assuming a isoceles triangle of 2.5 texel height and 5 texels wide lying on 6 texels.\n// This function return the weight of each texels area relative to the full triangle area.\n//  /       \\\n// _ _ _ _ _ _ <-- texels\n// 0 1 2 3 4 5 <-- computed area indices (in texelsWeights[])\n// Top point at (right,top) in a texel,left bottom point at (middle,middle) in a texel,right bottom point at (middle,middle) in a texel.\nvoid sampleShadowGetTexelWeightsTent5x5(float offset, out vec3 texelsWeightsA, out vec3 texelsWeightsB)\n{\n    vec4 areaFrom3texelTriangle;\n    vec4 areaUncutFrom3texelTriangle;\n    sampleShadowGetTexelAreasTent3x3(offset, areaFrom3texelTriangle, areaUncutFrom3texelTriangle);\n\n    // Triangle slope is 45 degree thus we can almost reuse the result of the 3 texel wide computation.\n    // the 5 texel wide triangle can be seen as the 3 texel wide one but shifted up by one unit/texel.\n    // 0.16 is 1/(the triangle area)\n    texelsWeightsA.x = 0.16 * (areaFrom3texelTriangle.x);\n    texelsWeightsA.y = 0.16 * (areaUncutFrom3texelTriangle.y);\n    texelsWeightsA.z = 0.16 * (areaFrom3texelTriangle.y + 1.0);\n    texelsWeightsB.x = 0.16 * (areaFrom3texelTriangle.z + 1.0);\n    texelsWeightsB.y = 0.16 * (areaUncutFrom3texelTriangle.z);\n    texelsWeightsB.z = 0.16 * (areaFrom3texelTriangle.w);\n}\n\n// 5x5 Tent filter (45 degree sloped triangles in U and V)\nvoid sampleShadowComputeSamplesTent5x5(vec4 shadowMapTextureTexelSize, vec2 coord, out float fetchesWeights[9], out vec2 fetchesUV[9])\n{\n    // tent base is 5x5 base thus covering from 25 to 36 texels, thus we need 9 bilinear PCF fetches\n    vec2 tentCenterInTexelSpace = coord.xy * shadowMapTextureTexelSize.zw;\n    vec2 centerOfFetchesInTexelSpace = floor(tentCenterInTexelSpace + 0.5);\n    vec2 offsetFromTentCenterToCenterOfFetches = tentCenterInTexelSpace - centerOfFetchesInTexelSpace;\n\n    // find the weight of each texel based on the area of a 45 degree slop tent above each of them.\n    vec3 texelsWeightsUA, texelsWeightsUB;\n    vec3 texelsWeightsVA, texelsWeightsVB;\n    sampleShadowGetTexelWeightsTent5x5(offsetFromTentCenterToCenterOfFetches.x, texelsWeightsUA, texelsWeightsUB);\n    sampleShadowGetTexelWeightsTent5x5(offsetFromTentCenterToCenterOfFetches.y, texelsWeightsVA, texelsWeightsVB);\n\n    // each fetch will cover a group of 2x2 texels, the weight of each group is the sum of the weights of the texels\n    vec3 fetchesWeightsU = vec3(texelsWeightsUA.xz, texelsWeightsUB.y) + vec3(texelsWeightsUA.y, texelsWeightsUB.xz);\n    vec3 fetchesWeightsV = vec3(texelsWeightsVA.xz, texelsWeightsVB.y) + vec3(texelsWeightsVA.y, texelsWeightsVB.xz);\n\n    // move the PCF bilinear fetches to respect texels weights\n    vec3 fetchesOffsetsU = vec3(texelsWeightsUA.y, texelsWeightsUB.xz) / fetchesWeightsU.xyz + vec3(-2.5,-0.5,1.5);\n    vec3 fetchesOffsetsV = vec3(texelsWeightsVA.y, texelsWeightsVB.xz) / fetchesWeightsV.xyz + vec3(-2.5,-0.5,1.5);\n    fetchesOffsetsU *= shadowMapTextureTexelSize.xxx;\n    fetchesOffsetsV *= shadowMapTextureTexelSize.yyy;\n\n    vec2 bilinearFetchOrigin = centerOfFetchesInTexelSpace * shadowMapTextureTexelSize.xy;\n    fetchesUV[0] = bilinearFetchOrigin + vec2(fetchesOffsetsU.x, fetchesOffsetsV.x);\n    fetchesUV[1] = bilinearFetchOrigin + vec2(fetchesOffsetsU.y, fetchesOffsetsV.x);\n    fetchesUV[2] = bilinearFetchOrigin + vec2(fetchesOffsetsU.z, fetchesOffsetsV.x);\n    fetchesUV[3] = bilinearFetchOrigin + vec2(fetchesOffsetsU.x, fetchesOffsetsV.y);\n    fetchesUV[4] = bilinearFetchOrigin + vec2(fetchesOffsetsU.y, fetchesOffsetsV.y);\n    fetchesUV[5] = bilinearFetchOrigin + vec2(fetchesOffsetsU.z, fetchesOffsetsV.y);\n    fetchesUV[6] = bilinearFetchOrigin + vec2(fetchesOffsetsU.x, fetchesOffsetsV.z);\n    fetchesUV[7] = bilinearFetchOrigin + vec2(fetchesOffsetsU.y, fetchesOffsetsV.z);\n    fetchesUV[8] = bilinearFetchOrigin + vec2(fetchesOffsetsU.z, fetchesOffsetsV.z);\n\n    fetchesWeights[0] = fetchesWeightsU.x * fetchesWeightsV.x;\n    fetchesWeights[1] = fetchesWeightsU.y * fetchesWeightsV.x;\n    fetchesWeights[2] = fetchesWeightsU.z * fetchesWeightsV.x;\n    fetchesWeights[3] = fetchesWeightsU.x * fetchesWeightsV.y;\n    fetchesWeights[4] = fetchesWeightsU.y * fetchesWeightsV.y;\n    fetchesWeights[5] = fetchesWeightsU.z * fetchesWeightsV.y;\n    fetchesWeights[6] = fetchesWeightsU.x * fetchesWeightsV.z;\n    fetchesWeights[7] = fetchesWeightsU.y * fetchesWeightsV.z;\n    fetchesWeights[8] = fetchesWeightsU.z * fetchesWeightsV.z;\n}'),_e.addInclude("GlobalIllumination.glsl",'struct LayaGIInput\n{\n\tvec2 lightmapUV;\n\tvec3 worldPos;\n};\n\n#define LAYA_SPECCUBE_LOD_STEPS 6.0\n\nuniform vec3 u_AmbientColor;\n\n#if defined(GI_AMBIENT_SH)\n\tuniform vec4 u_AmbientSHAr;\n\tuniform vec4 u_AmbientSHAg;\n\tuniform vec4 u_AmbientSHAb;\n\tuniform vec4 u_AmbientSHBr;\n\tuniform vec4 u_AmbientSHBg;\n\tuniform vec4 u_AmbientSHBb;\n\tuniform vec4 u_AmbientSHC;\n#endif\n\nuniform samplerCube u_ReflectTexture;\nuniform vec4 u_ReflectCubeHDRParams;\n\n#ifdef SPECCUBE_BOX_PROJECTION\n\tuniform vec3 u_SpecCubeProbePosition;\n\tuniform vec3 u_SpecCubeBoxMax;\n\tuniform vec3 u_SpecCubeBoxMin;\n#endif\n\n\n#ifdef GI_AMBIENT_SH\n\tmediump vec3 shEvalLinearL0L1(mediump vec4 normal)\n\t{\n\t\tmediump vec3 x;\n\t\t// Linear (L1) + constant (L0) polynomial terms\n\t\tx.r = dot(u_AmbientSHAr, normal);\n\t\tx.g = dot(u_AmbientSHAg, normal);\n\t\tx.b = dot(u_AmbientSHAb, normal);\n\t\treturn x;\n\t}\n\n\tmediump vec3 shEvalLinearL2(mediump vec4 normal)\n\t{\n\t\tmediump vec3 x1,x2;\n\t\t// 4 of the quadratic (L2) polynomials\n\t\tmediump vec4 vB = normal.xyzz * normal.yzzx;\n\t\tx1.r = dot(u_AmbientSHBr, vB);\n\t\tx1.g = dot(u_AmbientSHBg, vB);\n\t\tx1.b = dot(u_AmbientSHBb, vB);\n\n\t\t// Final (5th) quadratic (L2) polynomial\n\t\tmediump float vC = normal.x*normal.x - normal.y*normal.y;\n\t\tx2 = u_AmbientSHC.rgb * vC;\n\n\t\treturn x1 + x2;\n\t}\n\t\n\tmediump vec3 shadeSHPerPixel(mediump vec3 normal)\n\t{\n\t\tmediump vec3 ambientContrib;\n\t\tmediump vec4 normalV4=vec4(-normal.x,normal.yz, 1.0);//Note:SH Data is left-hand,so x need inverse\n\t\tambientContrib = shEvalLinearL0L1(normalV4);\n\t\tambientContrib += shEvalLinearL2(normalV4);\n\t\tmediump vec3 ambient = max(vec3(0.0), ambientContrib);\n\t\tambient = layaLinearToGammaSpace(ambient);\n\t\treturn ambient;\n\t}\n#endif\n\n\n\n mediump vec3 BoxProjectedCubemapDirection(mediump vec3 worldRefl,mediump vec3 worldPos,mediump vec3 cubemapCenter,mediump vec3 boxMin,mediump vec3 boxMax){\n\t mediump vec3 nrdir = normalize(worldRefl);\n\t mediump vec3 rbmax = (boxMax - worldPos);\n\t mediump vec3 rbmin = (boxMin - worldPos);\n\t mediump vec3 select = step(vec3(0.0), worldRefl);\n\t mediump vec3 rbminmax = mix(rbmin, rbmax, select);\n\trbminmax = rbminmax / nrdir;\n\tmediump float scalar = min(min(rbminmax.x, rbminmax.y), rbminmax.z);\n\t mediump vec3 worldChangeRefl = nrdir * scalar + (worldPos - cubemapCenter);\n\treturn worldChangeRefl;\n}\n\n\nmediump vec3 layaDecodeDirectionalLightmap (mediump vec3 color, lowp vec4 dirTex, mediump vec3 normalWorld)\n{\n    // In directional (non-specular) mode Enlighten bakes dominant light direction\n    // in a way, that using it for half Lambert and then dividing by a "rebalancing coefficient"\n    // gives a result close to plain diffuse response lightmaps, but normalmapped.\n\n    // Note that dir is not unit length on purpose. Its length is "directionality", like\n    // for the directional specular lightmaps.\n\tlowp vec3 directional=dirTex.xyz - 0.5;\n\tdirectional.x=-directional.x;//NOTE:because coord System\n    mediump float halfLambert = dot(normalWorld,directional) + 0.5;\n\n    return color * halfLambert / max(1e-4, dirTex.w);\n}\n\nvec3 layaGIBase(LayaGIInput giInput,mediump float occlusion, mediump vec3 normalWorld)\n{\n\tvec3 indirectDiffuse;\n\t#ifdef LIGHTMAP\t\n\t\tmediump vec3 bakedColor =decodeHDR(texture2D(u_LightMap, giInput.lightmapUV),5.0);\n\t\t#ifdef LIGHTMAP_DIRECTIONAL\n\t\t\tlowp vec4 bakedDirTex = texture2D (u_LightMapDirection, giInput.lightmapUV);\n            indirectDiffuse = layaDecodeDirectionalLightmap (bakedColor, bakedDirTex, normalWorld);\n\t\t#else //unDirectional lightmap\n\t\t\tindirectDiffuse = bakedColor;\n\t\t#endif\n\t#else\n\t\t#ifdef GI_AMBIENT_SH\n\t\t\tindirectDiffuse = shadeSHPerPixel(normalWorld);\n\t\t#else\n\t\t\tindirectDiffuse = u_AmbientColor; //already in gamma space\n\t\t#endif\n\t#endif\n\n\tindirectDiffuse*=occlusion;\n\treturn indirectDiffuse;\n}\n\nmediump vec3 layaGlossyEnvironment(mediump vec4 glossIn)\n{\n\tmediump float perceptualRoughness = glossIn.a;\n\n\t// use approximation to solve,below is more reasonable,but maybe slow. \n\t// float m = perceptualRoughnessToRoughness(perceptualRoughness); // m is the real roughness parameter\n    // const float fEps = 1.192092896e-07F;        // smallest such that 1.0+FLT_EPSILON != 1.0  (+1e-4h is NOT good here. is visibly very wrong)\n    // float n =  (2.0/max(fEps, m*m))-2.0;        // remap to spec power. See eq. 21 in --\x3e https://dl.dropboxusercontent.com/u/55891920/papers/mm_brdf.pdf\n    // n /= 4;                                     // remap from n_dot_h formulatino to n_dot_r. See section "Pre-convolved Cube Maps vs Path Tracers" --\x3e https://s3.amazonaws.com/docs.knaldtech.com/knald/1.0.0/lys_power_drops.html\n    // perceptualRoughness = pow( 2/(n+2), 0.25);  // remap back to square root of real roughness (0.25 include both the sqrt root of the conversion and sqrt for going from roughness to perceptualRoughness)\n\tperceptualRoughness = perceptualRoughness * (1.7 - 0.7*perceptualRoughness);//just a approximation,but fast.\n \n\tmediump float mip = perceptualRoughness * LAYA_SPECCUBE_LOD_STEPS;\n\tmediump vec3 uvw = glossIn.rgb;\n\tuvw.x=-uvw.x;//Note:reflectCube is left-hand,so x need inverse\n\tmediump vec4 rgbm=textureCubeLodEXT(u_ReflectTexture,uvw,mip);\n\treturn decodeHDR(rgbm,u_ReflectCubeHDRParams.x);\n}\n\nmediump vec3 layaGIIndirectSpecular(LayaGIInput giInput,mediump float occlusion, vec4 glossIn)\n{\n\t#ifdef SPECCUBE_BOX_PROJECTION\n\t\tvec3 originalReflUVW = glossIn.xyz;\n\t\tglossIn.xyz =BoxProjectedCubemapDirection(originalReflUVW,giInput.worldPos,u_SpecCubeProbePosition,u_SpecCubeBoxMin,u_SpecCubeBoxMax);\n\t#endif\n\tmediump vec3 specular = layaGlossyEnvironment(glossIn);\n\treturn specular * occlusion;\n}\n\n\nLayaGI layaGlobalIllumination(LayaGIInput giInput,mediump float occlusion, mediump vec3 normalWorld,mediump vec4 uvwRoughness)\n{\n\tLayaGI gi;\n\tgi.diffuse = layaGIBase(giInput,occlusion, normalWorld);\n\tgi.specular = layaGIIndirectSpecular(giInput,occlusion, uvwRoughness);\n\treturn gi;\n}\n\n\n'),_e.addInclude("Shadow.glsl",'#ifndef GRAPHICS_API_GLES3\n\t#define NO_NATIVE_SHADOWMAP\n#endif\n\n#if defined(NO_NATIVE_SHADOWMAP)\n\t#define TEXTURE2D_SHADOW(textureName) uniform mediump sampler2D textureName\n\t#define SAMPLE_TEXTURE2D_SHADOW(textureName, coord3) (texture2D(textureName,coord3.xy).r<coord3.z?0.0:1.0)\n\t#define TEXTURE2D_SHADOW_PARAM(shadowMap) mediump sampler2D shadowMap\n#else\n\t#define TEXTURE2D_SHADOW(textureName) uniform mediump sampler2DShadow textureName\n\t#define SAMPLE_TEXTURE2D_SHADOW(textureName, coord3) textureLod(textureName,coord3,0.0)\n\t#define TEXTURE2D_SHADOW_PARAM(shadowMap) mediump sampler2DShadow shadowMap\n#endif\n\n#if defined(RECEIVESHADOW)&&defined(SHADOW)\n    #define CALCULATE_SHADOWS\n#endif\n\n#if defined(RECEIVESHADOW)&&defined(SHADOW_SPOT)\n\t#define CALCULATE_SPOTSHADOWS\n#endif\n\nuniform vec4 u_ShadowBias; // x: depth bias, y: normal bias\n\n#if defined(CALCULATE_SHADOWS)||defined(CALCULATE_SPOTSHADOWS)\n\t#include "ShadowSampleTent.glsl"\n\tuniform vec4 u_ShadowMapSize;\n\tuniform vec4 u_SpotShadowMapSize;\n\tuniform vec4 u_ShadowParams; // x: shadowStrength y: ShadowSpotLightStrength\n\t\n\tfloat sampleShdowMapFiltered4(TEXTURE2D_SHADOW_PARAM(shadowMap),vec3 shadowCoord,vec4 shadowMapSize)\n\t{\n\t\tfloat attenuation;\n\t\tvec4 attenuation4;\n\t\tvec2 offset=shadowMapSize.xy/2.0;\n\t\tvec3 shadowCoord0=shadowCoord + vec3(-offset,0.0);\n\t\tvec3 shadowCoord1=shadowCoord + vec3(offset.x,-offset.y,0.0);\n\t\tvec3 shadowCoord2=shadowCoord + vec3(-offset.x,offset.y,0.0);\n\t\tvec3 shadowCoord3=shadowCoord + vec3(offset,0.0);\n\t\tattenuation4.x = SAMPLE_TEXTURE2D_SHADOW(shadowMap, shadowCoord0);\n\t\tattenuation4.y = SAMPLE_TEXTURE2D_SHADOW(shadowMap, shadowCoord1);\n\t\tattenuation4.z = SAMPLE_TEXTURE2D_SHADOW(shadowMap, shadowCoord2);\n\t\tattenuation4.w = SAMPLE_TEXTURE2D_SHADOW(shadowMap, shadowCoord3);\n\t\tattenuation = dot(attenuation4, vec4(0.25));\n\t\treturn attenuation;\n\t}\n\n\tfloat sampleShdowMapFiltered9(TEXTURE2D_SHADOW_PARAM(shadowMap),vec3 shadowCoord,vec4 shadowmapSize)\n\t{\n\t\tfloat attenuation;\n\t\tfloat fetchesWeights[9];\n\t\tvec2 fetchesUV[9];\n\t\tsampleShadowComputeSamplesTent5x5(shadowmapSize, shadowCoord.xy, fetchesWeights, fetchesUV);\n\t\tattenuation = fetchesWeights[0] * SAMPLE_TEXTURE2D_SHADOW(shadowMap, vec3(fetchesUV[0].xy, shadowCoord.z));\n\t\tattenuation += fetchesWeights[1] * SAMPLE_TEXTURE2D_SHADOW(shadowMap, vec3(fetchesUV[1].xy, shadowCoord.z));\n\t\tattenuation += fetchesWeights[2] * SAMPLE_TEXTURE2D_SHADOW(shadowMap, vec3(fetchesUV[2].xy, shadowCoord.z));\n\t\tattenuation += fetchesWeights[3] * SAMPLE_TEXTURE2D_SHADOW(shadowMap, vec3(fetchesUV[3].xy, shadowCoord.z));\n\t\tattenuation += fetchesWeights[4] * SAMPLE_TEXTURE2D_SHADOW(shadowMap, vec3(fetchesUV[4].xy, shadowCoord.z));\n\t\tattenuation += fetchesWeights[5] * SAMPLE_TEXTURE2D_SHADOW(shadowMap, vec3(fetchesUV[5].xy, shadowCoord.z));\n\t\tattenuation += fetchesWeights[6] * SAMPLE_TEXTURE2D_SHADOW(shadowMap, vec3(fetchesUV[6].xy, shadowCoord.z));\n\t\tattenuation += fetchesWeights[7] * SAMPLE_TEXTURE2D_SHADOW(shadowMap, vec3(fetchesUV[7].xy, shadowCoord.z));\n\t\tattenuation += fetchesWeights[8] * SAMPLE_TEXTURE2D_SHADOW(shadowMap, vec3(fetchesUV[8].xy, shadowCoord.z));\n\t\treturn attenuation;\n\t}\n\n#endif\n\n\n\n\n#if defined(CALCULATE_SHADOWS)\n\n\tTEXTURE2D_SHADOW(u_ShadowMap);\n\n\tuniform mat4 u_ShadowMatrices[4];\n\tuniform vec4 u_ShadowSplitSpheres[4];// max cascade is 4\n\n\tmediump int computeCascadeIndex(vec3 positionWS)\n\t{\n\t\tvec3 fromCenter0 = positionWS - u_ShadowSplitSpheres[0].xyz;\n\t\tvec3 fromCenter1 = positionWS - u_ShadowSplitSpheres[1].xyz;\n\t\tvec3 fromCenter2 = positionWS - u_ShadowSplitSpheres[2].xyz;\n\t\tvec3 fromCenter3 = positionWS - u_ShadowSplitSpheres[3].xyz;\n\n\t\tmediump vec4 comparison = vec4(\n\t\t\tdot(fromCenter0, fromCenter0)<u_ShadowSplitSpheres[0].w,\n\t\t\tdot(fromCenter1, fromCenter1)<u_ShadowSplitSpheres[1].w,\n\t\t\tdot(fromCenter2, fromCenter2)<u_ShadowSplitSpheres[2].w,\n\t\t\tdot(fromCenter3, fromCenter3)<u_ShadowSplitSpheres[3].w);\n\t\tcomparison.yzw = clamp(comparison.yzw - comparison.xyz,0.0,1.0);//keep the nearest\n\t\tmediump vec4 indexCoefficient = vec4(4.0,3.0,2.0,1.0);\n\t\tmediump int index = 4 - int(dot(comparison, indexCoefficient));\n\t\treturn index;\n\t}\n\n\tvec4 getShadowCoord(vec4 positionWS)\n\t{\n\t\t#ifdef SHADOW_CASCADE\n\t\t\tmediump int cascadeIndex = computeCascadeIndex(positionWS.xyz);\n\t\t\tif(cascadeIndex > 3)// out of shadow range cascadeIndex is 4.\n\t\t\t\treturn vec4(0.0);\n\t\t\t\n\t\t\t#ifdef GRAPHICS_API_GLES3\n\t\t\t\treturn u_ShadowMatrices[cascadeIndex] * positionWS;\n\t\t\t#else\n\t\t\t\tmat4 shadowMat;\n\t\t\t\tif(cascadeIndex == 0)\n\t\t\t\t\tshadowMat = u_ShadowMatrices[0];\n\t\t\t\telse if(cascadeIndex == 1)\n\t\t\t\t\tshadowMat = u_ShadowMatrices[1];\n\t\t\t\telse if(cascadeIndex == 2)\n\t\t\t\t\tshadowMat = u_ShadowMatrices[2];\n\t\t\t\telse\n\t\t\t\t\tshadowMat = u_ShadowMatrices[3];\n\t\t\t\treturn shadowMat * positionWS;\n\t\t\t#endif\n\t\t#else\n\t\t\treturn u_ShadowMatrices[0] * positionWS;\n\t\t#endif\n\t}\n\n\tfloat sampleShadowmap(vec4 shadowCoord)\n\t{\n\t\tshadowCoord.xyz /= shadowCoord.w;\n\t\tfloat attenuation = 1.0;\n\t\tif(shadowCoord.z > 0.0 && shadowCoord.z < 1.0)\n\t\t{\n\t\t\t#if defined(SHADOW_SOFT_SHADOW_HIGH)\n\t\t\t\tattenuation = sampleShdowMapFiltered9(u_ShadowMap,shadowCoord.xyz,u_ShadowMapSize);\n\t\t\t#elif defined(SHADOW_SOFT_SHADOW_LOW)\n\t\t\t\tattenuation = sampleShdowMapFiltered4(u_ShadowMap,shadowCoord.xyz,u_ShadowMapSize);\n\t\t\t#else\n\t\t\t\tattenuation = SAMPLE_TEXTURE2D_SHADOW(u_ShadowMap,shadowCoord.xyz);\n\t\t\t#endif\n\t\t\tattenuation = mix(1.0,attenuation,u_ShadowParams.x);//shadowParams.x:shadow strength\n\t\t}\n\t\treturn attenuation;\n\t}\n#endif\n\n#if defined(CALCULATE_SPOTSHADOWS)//shader���Զ���ĺ겻����ifdef ����ĳ�if defined\n\tTEXTURE2D_SHADOW(u_SpotShadowMap);\n\tuniform mat4 u_SpotViewProjectMatrix;\n\tfloat sampleSpotShadowmap(vec4 shadowCoord)\n\t{\n\t\tshadowCoord.xyz /= shadowCoord.w;\n\t\tfloat attenuation = 1.0;\n\t\tshadowCoord.xy +=1.0;\n\t\tshadowCoord.xy/=2.0; \n\t\tif(shadowCoord.z > 0.0 && shadowCoord.z < 1.0)\n\t\t{\n\t\t\t#if defined(SHADOW_SPOT_SOFT_SHADOW_HIGH)\n\t\t\t\tattenuation = sampleShdowMapFiltered9(u_SpotShadowMap,shadowCoord.xyz,u_SpotShadowMapSize);\n\t\t\t#elif defined(SHADOW_SPOT_SOFT_SHADOW_LOW)\n\t\t\t\tattenuation = sampleShdowMapFiltered4(u_SpotShadowMap,shadowCoord.xyz,u_SpotShadowMapSize);\n\t\t\t#else\n\t\t\t\tattenuation = SAMPLE_TEXTURE2D_SHADOW(u_SpotShadowMap,shadowCoord.xyz);\n\t\t\t#endif\n\t\t\tattenuation = mix(1.0,attenuation,u_ShadowParams.y);//shadowParams.y:shadow strength\n\t\t}\n\t\treturn attenuation;\n\t}\n#endif\n\nvec3 applyShadowBias(vec3 positionWS, vec3 normalWS, vec3 lightDirection)\n{\n    float invNdotL = 1.0 - clamp(dot(-lightDirection, normalWS),0.0,1.0);\n    float scale = invNdotL * u_ShadowBias.y;\n\n    // normal bias is negative since we want to apply an inset normal offset\n    positionWS += -lightDirection * u_ShadowBias.xxx;\n    positionWS += normalWS * vec3(scale);\n    return positionWS;\n}\n'),_e.addInclude("ShadowCasterVS.glsl",'#include "Lighting.glsl";\n#include "Shadow.glsl"\n\nattribute vec4 a_Position;\nattribute vec3 a_Normal;\n\n#ifdef BONE\n\tconst int c_MaxBoneCount = 24;\n\tattribute vec4 a_BoneIndices;\n\tattribute vec4 a_BoneWeights;\n\tuniform mat4 u_Bones[c_MaxBoneCount];\n#endif\n\n#ifdef GPU_INSTANCE\n\tattribute mat4 a_WorldMat;\n#else\n\tuniform mat4 u_WorldMat;\n#endif\n\nuniform mat4 u_ViewProjection;\n\n#ifdef SHADOW\n\tuniform vec3 u_ShadowLightDirection;\n#endif\n\n\nvec4 shadowCasterVertex()\n{\n\tmat4 worldMat;\n\t#ifdef GPU_INSTANCE\n\t\tworldMat = a_WorldMat;\n\t#else\n\t\tworldMat = u_WorldMat;\n\t#endif\n\t\n\t#ifdef BONE\n\t\tmat4 skinTransform;\n\t \t#ifdef SIMPLEBONE\n\t\t\tfloat currentPixelPos;\n\t\t\t#ifdef GPU_INSTANCE\n\t\t\t\tcurrentPixelPos = a_SimpleTextureParams.x+a_SimpleTextureParams.y;\n\t\t\t#else\n\t\t\t\tcurrentPixelPos = u_SimpleAnimatorParams.x+u_SimpleAnimatorParams.y;\n\t\t\t#endif\n\t\t\tfloat offset = 1.0/u_SimpleAnimatorTextureSize;\n\t\t\tskinTransform =  loadMatFromTexture(currentPixelPos,int(a_BoneIndices.x),offset) * a_BoneWeights.x;\n\t\t\tskinTransform += loadMatFromTexture(currentPixelPos,int(a_BoneIndices.y),offset) * a_BoneWeights.y;\n\t\t\tskinTransform += loadMatFromTexture(currentPixelPos,int(a_BoneIndices.z),offset) * a_BoneWeights.z;\n\t\t\tskinTransform += loadMatFromTexture(currentPixelPos,int(a_BoneIndices.w),offset) * a_BoneWeights.w;\n\t\t#else\n\t\t\tskinTransform =  u_Bones[int(a_BoneIndices.x)] * a_BoneWeights.x;\n\t\t\tskinTransform += u_Bones[int(a_BoneIndices.y)] * a_BoneWeights.y;\n\t\t\tskinTransform += u_Bones[int(a_BoneIndices.z)] * a_BoneWeights.z;\n\t\t\tskinTransform += u_Bones[int(a_BoneIndices.w)] * a_BoneWeights.w;\n\t\t#endif\n\t\tworldMat = worldMat * skinTransform;\n\t#endif\n\n\tvec4 positionWS = worldMat * a_Position;\n\tmat3 worldInvMat;\n\t#ifdef BONE\n\t\tworldInvMat=INVERSE_MAT(mat3(worldMat*skinTransform));\n\t#else\n\t\tworldInvMat=INVERSE_MAT(mat3(worldMat));\n\t#endif  \n\n\tvec3 normalWS = normalize(a_Normal*worldInvMat);//if no normalize will cause precision problem\n\t#ifdef SHADOW\n\t\tpositionWS.xyz = applyShadowBias(positionWS.xyz,normalWS,u_ShadowLightDirection);\n\t#endif\n\n\tvec4 positionCS = u_ViewProjection * positionWS;\n\t#ifdef SHADOW_SPOT\n\t\tpositionCS.z = positionCS.z-u_ShadowBias.x/positionCS.w;\n\t#endif\n\tpositionCS.z = max(positionCS.z, 0.0);//min ndc z is 0.0\n\t\n\t// //TODO没考虑UV动画呢\n\t// #if defined(DIFFUSEMAP)&&defined(ALPHATEST)\n\t// \tv_Texcoord0=a_Texcoord0;\n\t// #endif\n    return positionCS;\n}\n'),_e.addInclude("ShadowCasterFS.glsl","vec4 shadowCasterFragment()\n{\n    return vec4(0.0);\n}\n"),_e.addInclude("Colors.glsl",'#include "StdLib.glsl";\n\n#define EPSILON 1.0e-4\n\n// Quadratic color thresholding\n// curve = (threshold - knee, knee * 2, 0.25 / knee)\nmediump vec4 quadraticThreshold(mediump vec4 color, mediump float threshold, mediump vec3 curve) {\n\t// Pixel brightness\n\tmediump float br = max3(color.r, color.g, color.b);\n\n\t// Under-threshold part: quadratic curve\n\tmediump float rq = clamp(br - curve.x, 0.0, curve.y);\n\trq = curve.z * rq * rq;\n\n\t// Combine and apply the brightness response curve.\n\tcolor *= max(rq, br - threshold) / max(br, EPSILON);\n\n\treturn color;\n}\n\n\n\n//\n// sRGB transfer functions\n// Fast path ref: http://chilliant.blogspot.com.au/2012/08/srgb-approximations-for-hlsl.html?m=1\n//\nmediump vec3 sRGBToLinear(mediump vec3 c) {\n\t#ifdef USE_VERY_FAST_SRGB\n\t\treturn c * c;\n\t#elif defined(USE_FAST_SRGB)\n\t\treturn c * (c * (c * 0.305306011 + 0.682171111) + 0.012522878);\n\t#else\n\t\tmediump vec3 linearRGBLo = c / 12.92;\n\t\tmediump vec3 power=vec3(2.4, 2.4, 2.4);\n\t\tmediump vec3 linearRGBHi = positivePow((c + 0.055) / 1.055, power);\n\t\tmediump vec3 linearRGB =vec3((c.r<=0.04045) ? linearRGBLo.r : linearRGBHi.r,(c.g<=0.04045) ? linearRGBLo.g : linearRGBHi.g,(c.b<=0.04045) ? linearRGBLo.b : linearRGBHi.b);\n\t\treturn linearRGB;\n\t#endif\n}\n\nmediump vec4 sRGBToLinear(mediump vec4 c){\n    return vec4(sRGBToLinear(c.rgb), c.a);\n}\n\n\n\nmediump vec3 linearToSRGB(mediump vec3 c) {\n\t#ifdef USE_VERY_FAST_SRGB\n\t\treturn sqrt(c);\n\t#elif defined(USE_FAST_SRGB)\n\t\treturn max(1.055 * PositivePow(c, 0.416666667) - 0.055, 0.0);\n\t#else\n\t\tmediump vec3 sRGBLo = c * 12.92;\n\t\tmediump vec3 power=vec3(1.0 / 2.4, 1.0 / 2.4, 1.0 / 2.4);\n\t\tmediump vec3 sRGBHi = (positivePow(c, power) * 1.055) - 0.055;\n\t\tmediump vec3 sRGB =vec3((c.r<=0.0031308) ? sRGBLo.r : sRGBHi.r,(c.g<=0.0031308) ? sRGBLo.g : sRGBHi.g,(c.b<=0.0031308) ? sRGBLo.b : sRGBHi.b);\n\t\treturn sRGB;\n\t#endif\n}\n\nmediump vec4 linearToSRGB(mediump vec4 c){\n    return vec4(linearToSRGB(c.rgb), c.a);\n}'),_e.addInclude("Sampling.glsl","// Better, temporally stable box filtering\n// [Jimenez14] http://goo.gl/eomGso\n// . . . . . . .\n// . A . B . C .\n// . . D . E . .\n// . F . G . H .\n// . . I . J . .\n// . K . L . M .\n// . . . . . . .\nmediump vec4 downsampleBox13Tap(sampler2D tex, vec2 uv, vec2 texelSize)\n{\n    mediump vec4 A = texture2D(tex, uv + texelSize * vec2(-1.0, -1.0));\n    mediump vec4 B = texture2D(tex, uv + texelSize * vec2( 0.0, -1.0));\n    mediump vec4 C = texture2D(tex, uv + texelSize * vec2( 1.0, -1.0));\n    mediump vec4 D = texture2D(tex, uv + texelSize * vec2(-0.5, -0.5));\n    mediump vec4 E = texture2D(tex, uv + texelSize * vec2( 0.5, -0.5));\n    mediump vec4 F = texture2D(tex, uv + texelSize * vec2(-1.0,  0.0));\n    mediump vec4 G = texture2D(tex, uv);\n    mediump vec4 H = texture2D(tex, uv + texelSize * vec2( 1.0,  0.0));\n    mediump vec4 I = texture2D(tex, uv + texelSize * vec2(-0.5,  0.5));\n    mediump vec4 J = texture2D(tex, uv + texelSize * vec2( 0.5,  0.5));\n    mediump vec4 K = texture2D(tex, uv + texelSize * vec2(-1.0,  1.0));\n    mediump vec4 L = texture2D(tex, uv + texelSize * vec2( 0.0,  1.0));\n    mediump vec4 M = texture2D(tex, uv + texelSize * vec2( 1.0,  1.0));\n\n\tmediump vec2 scale= vec2(0.5, 0.125);\n    mediump vec2 div = (1.0 / 4.0) * scale;\n\n    mediump vec4 o = (D + E + I + J) * div.x;\n    o += (A + B + G + F) * div.y;\n    o += (B + C + H + G) * div.y;\n    o += (F + G + L + K) * div.y;\n    o += (G + H + M + L) * div.y;\n\n    return o;\n}\n\n// Standard box filtering\nmediump vec4 downsampleBox4Tap(sampler2D tex, vec2 uv, vec2 texelSize)\n{\n    vec4 d = texelSize.xyxy * vec4(-1.0, -1.0, 1.0, 1.0);\n\n    mediump vec4 s =  texture2D(tex, uv + d.xy);\n    s += texture2D(tex, uv + d.zy);\n    s += texture2D(tex, uv + d.xw);\n    s += texture2D(tex, uv + d.zw);\n\n    return s * (1.0 / 4.0);\n}\n\n// 9-tap bilinear upsampler (tent filter)\n// . . . . . . .\n// . 1 . 2 . 1 .\n// . . . . . . .\n// . 2 . 4 . 2 .\n// . . . . . . .\n// . 1 . 2 . 1 .\n// . . . . . . .\nmediump vec4 upsampleTent(sampler2D tex, vec2 uv, vec2 texelSize, vec4 sampleScale)\n{\n    vec4 d = texelSize.xyxy * vec4(1.0, 1.0, -1.0, 0.0) * sampleScale;\n\n    mediump vec4 s =  texture2D(tex, uv - d.xy);\n    s += texture2D(tex, uv - d.wy) * 2.0;\n    s += texture2D(tex, uv - d.zy);\n\n    s += texture2D(tex, uv + d.zw) * 2.0;\n    s += texture2D(tex, uv) * 4.0;\n    s += texture2D(tex,\tuv + d.xw) * 2.0;\n\n    s += texture2D(tex, uv + d.zy);\n    s += texture2D(tex, uv + d.wy) * 2.0;\n    s += texture2D(tex, uv + d.xy);\n\n    return s * (1.0 / 16.0);\n}\n\n// Standard box filtering\nmediump vec4 upsampleBox(sampler2D tex, vec2 uv, vec2 texelSize, vec4 sampleScale)\n{\n    vec4 d = texelSize.xyxy * vec4(-1.0, -1.0, 1.0, 1.0) * 0.5 * sampleScale;\n\n    mediump vec4 s =  texture2D(tex, uv + d.xy);\n    s += texture2D(tex, uv + d.zy);\n    s += texture2D(tex, uv + d.xw);\n    s += texture2D(tex, uv + d.zw);\n\n    return s * (1.0 / 4.0);\n}"),_e.addInclude("StdLib.glsl","#define HALF_MAX       65504.0 // (2 - 2^-10) * 2^15\n\n#define FLT_EPSILON    1.192092896e-07 // Smallest positive number, such that 1.0 + FLT_EPSILON != 1.0\n\nmediump vec4 safeHDR(mediump vec4 c)\n{\n    return min(c, HALF_MAX);\n}\n\nfloat max3(float a, float b, float c)\n{\n    return max(max(a, b), c);\n}\n\nvec3 positivePow(vec3 base, vec3 power)\n{\n    return pow(max(abs(base), vec3(FLT_EPSILON, FLT_EPSILON, FLT_EPSILON)), power);\n}"),_e.addInclude("PBRVSInput.glsl","attribute vec4 a_Position;\n\n#ifdef GPU_INSTANCE\n\tuniform mat4 u_ViewProjection;\n\tattribute mat4 a_WorldMat;\n#else\n\tuniform mat4 u_MvpMatrix;\n\tuniform mat4 u_WorldMat;\n#endif\n\n#ifdef BONE\n\tconst int c_MaxBoneCount = 24;\n\tattribute vec4 a_BoneIndices;\n\tattribute vec4 a_BoneWeights;\n\tuniform mat4 u_Bones[c_MaxBoneCount];\n#endif\n\nattribute vec3 a_Normal;\nvarying vec3 v_Normal; \n\n#if defined(NORMALTEXTURE)||defined(PARALLAXTEXTURE)\n\tattribute vec4 a_Tangent0;\n\tvarying vec3 v_Tangent;\n\tvarying vec3 v_Binormal;\n    #ifdef PARALLAXTEXTURE\n\t    varying vec3 v_ViewDirForParallax;\n    #endif\n#endif\n\n#if defined(ALBEDOTEXTURE)||defined(METALLICGLOSSTEXTURE)||defined(NORMALTEXTURE)||defined(EMISSIONTEXTURE)||defined(OCCLUSIONTEXTURE)||defined(PARALLAXTEXTURE)||(defined(LIGHTMAP)&&defined(UV))\n\tattribute vec2 a_Texcoord0;\n\tvarying vec2 v_Texcoord0;\n#endif\n\n#if defined(LIGHTMAP)&&defined(UV1)\n\tattribute vec2 a_Texcoord1;\n#endif\n\n#ifdef LIGHTMAP\n\tuniform vec4 u_LightmapScaleOffset;\n\tvarying vec2 v_LightMapUV;\n#endif\n\nuniform vec3 u_CameraPos;\nvarying vec3 v_EyeVec;\nvarying vec3 v_PositionWorld;\nvarying float v_posViewZ;\n\n#if defined(CALCULATE_SHADOWS)&&!defined(SHADOW_CASCADE)\n\tvarying vec4 v_ShadowCoord;\n#endif\n\n#if defined(CALCULATE_SPOTSHADOWS)//shader中自定义的宏不可用ifdef 必须改成if defined\n\tvarying vec4 v_SpotShadowCoord;\n#endif\n\nuniform vec4 u_TilingOffset;\n"),_e.addInclude("PBRFSInput.glsl","#ifdef ALPHATEST\n\tuniform float u_AlphaTestValue;\n#endif\n\nuniform vec4 u_AlbedoColor;\n\n#ifdef NORMALTEXTURE\n\tuniform sampler2D u_NormalTexture;\n\tuniform float u_NormalScale;\n#endif\n\n#ifdef ALBEDOTEXTURE\n\tuniform sampler2D u_AlbedoTexture;\n#endif\n\n#ifdef METALLICGLOSSTEXTURE\n\tuniform sampler2D u_MetallicGlossTexture;\n#endif\nuniform float u_Metallic;\n\n#ifdef SPECULARGLOSSTEXTURE\n\tuniform sampler2D u_SpecGlossTexture;\n#endif\nuniform vec3 u_SpecularColor;\n\nuniform float u_Smoothness;\nuniform float u_SmoothnessScale;\n\n#ifdef PARALLAXTEXTURE\n\tuniform sampler2D u_ParallaxTexture;\n\tuniform float u_ParallaxScale;\n\tvarying vec3 v_ViewDirForParallax;\n#endif\n\n#ifdef OCCLUSIONTEXTURE\n\tuniform sampler2D u_OcclusionTexture;\n\tuniform float u_occlusionStrength;\n#endif\n\n#ifdef EMISSION \n\t#ifdef EMISSIONTEXTURE\n\t\tuniform sampler2D u_EmissionTexture;\n\t#endif\n\tuniform vec4 u_EmissionColor;\n#endif\n\n#if defined(ALBEDOTEXTURE)||defined(METALLICGLOSSTEXTURE)||defined(NORMALTEXTURE)||defined(EMISSIONTEXTURE)||defined(OCCLUSIONTEXTURE)||defined(PARALLAXTEXTURE)\n\tvarying vec2 v_Texcoord0;\n#endif\n\n#ifdef LIGHTMAP\n\tvarying vec2 v_LightMapUV;\n\tuniform sampler2D u_LightMap;\n\t#ifdef LIGHTMAP_DIRECTIONAL\n\t\tuniform sampler2D u_LightMapDirection;\n\t#endif\n#endif\n\nvarying vec3 v_Normal; \n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n\t#ifdef LEGACYSINGLELIGHTING\n\t\t#ifdef DIRECTIONLIGHT\n\t\t\tuniform DirectionLight u_DirectionLight;\n\t\t#endif\n\t\t#ifdef POINTLIGHT\n\t\t\tuniform PointLight u_PointLight;\n\t\t#endif\n\t\t#ifdef SPOTLIGHT\n\t\t\tuniform SpotLight u_SpotLight;\n\t\t#endif\n\t#else\n\t\tuniform mat4 u_View;\n\t\tuniform vec4 u_ProjectionParams;\n\t\tuniform vec4 u_Viewport;\n\t\tuniform int u_DirationLightCount;\n\t\tuniform sampler2D u_LightBuffer;\n\t\tuniform sampler2D u_LightClusterBuffer;\n\t#endif\n#endif\n\nvarying vec3 v_EyeVec;\n\n#ifdef NORMALTEXTURE\n\tvarying vec3 v_Tangent;\n\tvarying vec3 v_Binormal;\n#endif\n\n#ifdef FOG\n\tuniform float u_FogStart;\n\tuniform float u_FogRange;\n\tuniform vec3 u_FogColor;\n#endif\n\n\n//后面考虑宏TODO\nvarying vec3 v_PositionWorld;\n\n#if defined(CALCULATE_SHADOWS)&&!defined(SHADOW_CASCADE)\n\tvarying vec4 v_ShadowCoord;\n#endif\n\n#if defined(CALCULATE_SPOTSHADOWS)//shader中自定义的宏不可用ifdef 必须改成if defined\n\tvarying vec4 v_SpotShadowCoord;\n#endif\n\nmediump float lerpOneTo(mediump float b, mediump float t)\n{\n    mediump float oneMinusT = 1.0 - t;\n    return oneMinusT + b * t;\n}\n\n#ifdef EMISSION \n\tvec3 emission(vec2 uv)\n\t{\n\t\t#ifdef EMISSIONTEXTURE\n\t\t\treturn texture2D(u_EmissionTexture, uv).rgb * u_EmissionColor.rgb;\n\t\t#else\n\t\t\treturn u_EmissionColor.rgb;\n\t\t#endif\n\t}\n#endif\n\nmediump float getAlpha(vec2 uv)\n{\n\t#ifdef SMOOTHNESSSOURCE_ALBEDOTEXTURE_ALPHA\n\t\treturn u_AlbedoColor.a;\n\t#else\n\t\t#ifdef ALBEDOTEXTURE\n\t\t\treturn texture2D(u_AlbedoTexture, uv).a * u_AlbedoColor.a;\n\t\t#else\n\t\t\treturn u_AlbedoColor.a;\n\t\t#endif\n\t#endif\n}\n\nmediump float getOcclusion(vec2 uv)\n{\n\t#ifdef OCCLUSIONTEXTURE\n\t\tmediump float occ = texture2D(u_OcclusionTexture, uv).g;\n\t\treturn lerpOneTo(occ, u_occlusionStrength);\n\t#else\n\t\treturn 1.0;\n\t#endif\n}\n\nmediump vec3 albedo(vec2 uv)\n{\n\t#ifdef ALBEDOTEXTURE\n\t\treturn u_AlbedoColor.rgb * texture2D(u_AlbedoTexture, uv).rgb;\n\t#else\n\t\treturn u_AlbedoColor.rgb;\n\t#endif\n\t//TODO:Detail Texture\n}\n\nmediump vec2 getMetallicGloss(vec2 uv)\n{\n\tmediump vec2 ms;//x is metallic,y is smoothness\n\t#ifdef METALLICGLOSSTEXTURE\n\t\t#ifdef SMOOTHNESSSOURCE_ALBEDOTEXTURE_ALPHA\n\t\t\tms.x = texture2D(u_MetallicGlossTexture, uv).r;\n\t\t\t#ifdef ALBEDOTEXTURE\n\t\t\t\tms.y = texture2D(u_AlbedoTexture, uv).a*u_SmoothnessScale;\n\t\t\t#else\n\t\t\t\tms.y = u_SmoothnessScale;\n\t\t\t#endif\n\t\t#else\n\t\t\tms = texture2D(u_MetallicGlossTexture, uv).ra;\n\t\t\tms.y *= u_SmoothnessScale;\n\t\t#endif\n\t#else\n\t\tms.x = u_Metallic;\n\t\t#ifdef SMOOTHNESSSOURCE_ALBEDOTEXTURE_ALPHA\n\t\t\t#ifdef ALBEDOTEXTURE\n\t\t\t\tms.y = texture2D(u_AlbedoTexture, uv).a * u_SmoothnessScale;\n\t\t\t#else\n\t\t\t\tms.y = u_SmoothnessScale;\n\t\t\t#endif\n\t\t#else\n\t\t\tms.y = u_Smoothness;\n\t\t#endif\n\t#endif\n\treturn ms;\n}\n\nmediump vec4 specularGloss(vec2 uv)\n{\n\tmediump vec4 sg;\n\t#ifdef SPECULARGLOSSTEXTURE\n\t\t#ifdef SMOOTHNESSSOURCE_ALBEDOTEXTURE_ALPHA\n\t\t\tsg.rgb = texture2D(u_SpecGlossTexture, uv).rgb;\n\t\t\t#ifdef ALBEDOTEXTURE\n\t\t\t\tsg.a = texture2D(u_AlbedoTexture, uv).a*u_SmoothnessScale;\n\t\t\t#else\n\t\t\t\tsg.a = u_SmoothnessScale;\n\t\t\t#endif\n\t\t#else\n\t\t\tsg = texture2D(u_SpecGlossTexture, uv);\n\t\t\tsg.a *= u_SmoothnessScale;\n\t\t#endif\n\t#else\n\t\tsg.rgb = u_SpecularColor.rgb;\n\t\t#ifdef SMOOTHNESSSOURCE_ALBEDOTEXTURE_ALPHA\n\t\t\t#ifdef ALBEDOTEXTURE\n\t\t\t\tsg.a = texture2D(u_AlbedoTexture, uv).a * u_SmoothnessScale;\n\t\t\t#else\n\t\t\t\tsg.a = u_SmoothnessScale;\n\t\t\t#endif\n\t\t#else\n\t\t\tsg.a = u_Smoothness;\n\t\t#endif\n\t#endif\n\t\treturn sg;\n}\n\n\n#ifdef NORMALTEXTURE\n\tmediump vec3 unpackScaleNormal(mediump vec3 packednormal, mediump float bumpScale)\n\t{\n\t\tmediump vec3 normal = packednormal.xyz * 2.0 - 1.0;\n\t\tnormal.y=-normal.y;//NOTE:because unity to LayaAir coordSystem.\n\t\tnormal.xy *= bumpScale;\n\t\treturn normal;\n\t}\n\t\n\tmediump vec3 normalInTangentSpace(vec2 texcoords)\n\t{\n\t\tmediump vec3 normalTangent = unpackScaleNormal(texture2D(u_NormalTexture, texcoords).rgb,u_NormalScale);\n\t\treturn normalTangent;\n\t}\n#endif\n\n#ifdef PARALLAXTEXTURE\n\tmediump vec2 parallaxOffset1Step(mediump float h, mediump float height, mediump vec3 viewDir)\n\t{\n\t\th = h * height - height / 2.0;\n\t\tviewDir.z += 0.42;\n\t\treturn h * (viewDir.xy / viewDir.z);\n\t}\n\n\tvec2 parallax(vec2 texcoords, mediump vec3 viewDir)\n\t{\n\t\tmediump float h = texture2D(u_ParallaxTexture, texcoords.xy).g;\n\t\tvec2 offset = parallaxOffset1Step(h, u_ParallaxScale, viewDir);\n\t\treturn texcoords+offset;\n\t}\n#endif\n\n\n\n\n\n\n\n\n"),_e.addInclude("LayaPBRBRDF.glsl",'// allow to explicitly override LAYA_BRDF_GI and LAYA_BRDF_LIGHT in custom shader,default is layaBRDFHighGI and layaBRDFHighLight\n#if !defined (LAYA_BRDF_GI) \n\t#if defined(LAYA_PBR_BRDF_LOW)\n\t\t#define LAYA_BRDF_GI layaBRDFLowGI\n\t#elif defined(LAYA_PBR_BRDF_HIGH)\n\t\t#define LAYA_BRDF_GI layaBRDFHighGI\n\t#endif\n#endif\n#if !defined (LAYA_BRDF_LIGHT)\n\t#if defined(LAYA_PBR_BRDF_LOW)\n\t\t#define LAYA_BRDF_LIGHT layaBRDFLowLight\n\t#elif defined(LAYA_PBR_BRDF_HIGH)\n\t\t#define LAYA_BRDF_LIGHT layaBRDFHighLight\n\t#endif\n#endif\n\n#define PI 3.14159265359\n#define INV_PI 0.31830988618\n\nmediump float pow4(mediump float x)\n{\n\treturn x * x * x * x;\n}\n\nmediump float pow5(mediump float x)\n{\n\treturn x * x * x * x * x;\n}\n\nmediump vec3 fresnelLerp(mediump vec3 F0,mediump vec3 F90,mediump float cosA)\n{\n\tfloat t = pow5(1.0 - cosA);   // ala Schlick interpoliation\n\treturn mix(F0, F90, t);\n}\n\nmediump vec3 fresnelTerm(mediump vec3 F0,mediump float cosA)\n{\n\tfloat t = pow5(1.0 - cosA);   // ala Schlick interpoliation\n\treturn F0 + (vec3(1.0) - F0) * t;\n}\n\n// approximage Schlick with ^4 instead of ^5\nmediump vec3 fresnelLerpFast (mediump vec3 F0, mediump vec3 F90,mediump float cosA)\n{\n    mediump float t = pow4 (1.0 - cosA);\n    return mix (F0, F90, t);\n}\n\nfloat smoothnessToPerceptualRoughness(float smoothness)\n{\n    return 1.0 - smoothness;\n}\n\nfloat perceptualRoughnessToRoughness(float perceptualRoughness)\n{\n    return perceptualRoughness * perceptualRoughness;\n}\n\nvec3 safeNormalize(vec3 inVec)\n{\n\tfloat dp3 = max(0.001,dot(inVec,inVec));\n\treturn inVec * inversesqrt(dp3);\n}\n\n// Note: Disney diffuse must be multiply by diffuseAlbedo / PI. This is done outside of this function.\nmediump float disneyDiffuse(mediump float NdotV,mediump float NdotL,mediump float LdotH,mediump float perceptualRoughness)\n{\n\t//https://www.cnblogs.com/herenzhiming/articles/5790389.html\n\tmediump float fd90 = 0.5 + 2.0 * LdotH * LdotH * perceptualRoughness;\n\t// Two schlick fresnel term\n\tmediump float lightScatter = (1.0 + (fd90 - 1.0) * pow5(1.0 - NdotL));\n\tmediump float viewScatter = (1.0 + (fd90 - 1.0) * pow5(1.0 - NdotV));\n\n\treturn lightScatter * viewScatter;\n}\n\n// Ref: http://jcgt.org/published/0003/02/03/paper.pdf\nfloat smithJointGGXVisibilityTerm(float NdotL, float NdotV, float roughness)\n{\n\t// Original formulation:\n    // lambda_v    = (-1 + sqrt(a2 * (1 - NdotL2) / NdotL2 + 1)) * 0.5f;\n    // lambda_l    = (-1 + sqrt(a2 * (1 - NdotV2) / NdotV2 + 1)) * 0.5f;\n    // G           = 1 / (1 + lambda_v + lambda_l);\n\n\t// scientific code implement:\n\t// Reorder code to be more optimal\n    // half a          = roughness;\n    // half a2         = a * a;\n\n    // half lambdaV    = NdotL * sqrt((-NdotV * a2 + NdotV) * NdotV + a2);\n    // half lambdaL    = NdotV * sqrt((-NdotL * a2 + NdotL) * NdotL + a2);\n\n    // Simplify visibility term: (2.0f * NdotL * NdotV) /  ((4.0f * NdotL * NdotV) * (lambda_v + lambda_l + 1e-5f));\n    // return 0.5f / (lambdaV + lambdaL + 1e-5f);  \n\t// This function is not intended to be running on Mobile,therefore epsilon is smaller than can be represented by half\n\n\t// Approximation of the above formulation (simplify the sqrt, not mathematically correct but close enough)\n\tfloat a = roughness;\n\tfloat lambdaV = NdotL * (NdotV * (1.0 - a) + a);\n\tfloat lambdaL = NdotV * (NdotL * (1.0 - a) + a);\n\treturn 0.5 / (lambdaV + lambdaL + 1e-5);\n}\n\nfloat ggxTerm(float NdotH, float roughness)\n{\n\tfloat a2 = roughness * roughness;\n\tfloat d = (NdotH * a2 - NdotH) * NdotH + 1.0; // 2 mad\n\treturn INV_PI * a2 / (d * d + 1e-7); // This function is not intended to be running on Mobile,therefore epsilon is smaller than what can be represented by half//返回值小用half来返回\n}\n\n// BRDF1-------------------------------------------------------------------------------------\n\n// Note: BRDF entry points use smoothness and oneMinusReflectivity for optimization purposes,\n// mostly for DX9 SM2.0 level. Most of the math is being done on these (1-x) values, and that saves a few precious ALU slots.\n\n// Main Physically Based BRDF\n// Derived from Disney work and based on Torrance-Sparrow micro-facet model\n//\n// BRDF = kD / pi + kS * (D * V * F) / 4\n// I = BRDF * NdotL\n//\n// *NDF GGX:\n// *Smith for Visiblity term\n// *Schlick approximation for Fresnel\nmediump vec4 layaBRDFHighLight(mediump vec3 diffColor, mediump vec3 specColor, mediump float oneMinusReflectivity, float perceptualRoughness,float roughness,mediump float nv,vec3 normal, vec3 viewDir,LayaLight light)\n{\n\tvec3 halfDir = safeNormalize(viewDir-light.dir);\n\n\tfloat nl = clamp(dot(normal, -light.dir),0.0,1.0);\n\tfloat nh = clamp(dot(normal, halfDir),0.0,1.0);\n\tmediump float lv = clamp(dot(light.dir, viewDir),0.0,1.0);\n\tmediump float lh = clamp(dot(light.dir, -halfDir),0.0,1.0);\n\n\t// Diffuse term\n\tmediump float diffuseTerm = disneyDiffuse(nv, nl, lh, perceptualRoughness) * nl;\n\n\t// Specular term\n    // HACK: theoretically we should divide diffuseTerm by Pi and not multiply specularTerm!\n    // BUT that will make shader look significantly darker than Legacy ones\n\n\t// GGX with roughtness to 0 would mean no specular at all, using max(roughness, 0.002) here to match HDrenderloop roughtness remapping.\n\troughness = max(roughness, 0.002);\n\tfloat V = smithJointGGXVisibilityTerm(nl, nv, roughness);\n\tfloat D = ggxTerm(nh, roughness);\n\n\tfloat specularTerm = V * D * PI; // Torrance-Sparrow model, Fresnel is applied later\n\n\t//#ifdef LAYA_COLORSPACE_GAMMA\n\tspecularTerm = sqrt(max(1e-4, specularTerm));\n\t//#endif\n\tspecularTerm = max(0.0, specularTerm * nl);\n\t\t\n\tmediump vec3 color = diffColor * light.color * diffuseTerm + specularTerm * light.color * fresnelTerm(specColor, lh);\n\treturn vec4(color, 1.0);\n}\n\nvec4 layaBRDFHighGI(mediump vec3 diffColor,mediump vec3 specColor,mediump float oneMinusReflectivity,float smoothness ,float perceptualRoughness,float roughness,mediump float nv,vec3 normal, vec3 viewDir,LayaGI gi)\n{\n\t// surfaceReduction = Int D(NdotH) * NdotH * Id(NdotL>0) dH = 1/(roughness^2+1)\n\tfloat surfaceReduction;\n\tsurfaceReduction = 1.0 - 0.28*roughness*perceptualRoughness;// 1-0.28*x^3 as approximation for (1/(x^4+1))^(1/2.2) on the domain [0;1]\n\tfloat grazingTerm = clamp(smoothness + (1.0 - oneMinusReflectivity),0.0,1.0);\n\tmediump vec3 color =diffColor * gi.diffuse + surfaceReduction * gi.specular * fresnelLerp(specColor,vec3(grazingTerm), nv);\n\treturn vec4(color,1.0);\n}\n// BRDF1-------------------------------------------------------------------------------------\n\n\n// BRDF2-------------------------------------------------------------------------------------\n// Based on Minimalist CookTorrance BRDF\n// Implementation is slightly different from original derivation: http://www.thetenthplanet.de/archives/255\n//\n// *NDF [Modified] GGX:\n// *Modified Kelemen and Szirmay-​Kalos for Visibility term\n// *Fresnel approximated with 1/LdotH\nmediump vec4 layaBRDFLowLight (mediump vec3 diffColor, mediump vec3 specColor,mediump float oneMinusReflectivity,float perceptualRoughness,float roughness,mediump float nv,vec3 normal,vec3 viewDir,LayaLight light)\n{\n    vec3 halfDir = safeNormalize (viewDir-light.dir);\n    mediump float nl = clamp(dot(normal, -light.dir),0.0,1.0);\n    float nh = clamp(dot(normal, halfDir),0.0,1.0);\n    float lh = clamp(dot(-light.dir, halfDir),0.0,1.0);\n\n    // GGX Distribution multiplied by combined approximation of Visibility and Fresnel\n    // See "Optimizing PBR for Mobile" from Siggraph 2015 moving mobile graphics course\n    // https://community.arm.com/events/1155\n    mediump float a = roughness;\n    float a2 = a*a;\n\n    float d = nh * nh * (a2 - 1.0) + 1.00001;\n\t// #ifdef LAYA_COLORSPACE_GAMMA\n\t\t// Tighter approximation for Gamma only rendering mode!\n\t\t// DVF = sqrt(DVF);\n\t\t// DVF = (a * sqrt(.25)) / (max(sqrt(0.1), lh)*sqrt(roughness + .5) * d);\n\t\tfloat specularTerm = a / (max(0.32, lh) * (1.5 + roughness) * d);\n\t// #else\n\t// \tfloat specularTerm = a2 / (max(0.1f, lh*lh) * (roughness + 0.5f) * (d * d) * 4);\n\t// #endif\n\n    // on mobiles (where half actually means something) denominator have risk of overflow\n    // clamp below was added specifically to "fix" that, but dx compiler (we convert bytecode to metal/gles)\n    // sees that specularTerm have only non-negative terms, so it skips max(0,..) in clamp (leaving only min(100,...))\n\n\t//#if defined (SHADER_API_MOBILE)\n    specularTerm = specularTerm - 1e-4;\n\t//#endif\n\n\t// #else\n\t\t// // Legacy\n\t\t// half specularPower = PerceptualRoughnessToSpecPower(perceptualRoughness);\n\t\t// // Modified with approximate Visibility function that takes roughness into account\n\t\t// // Original ((n+1)*N.H^n) / (8*Pi * L.H^3) didn\'t take into account roughness\n\t\t// // and produced extremely bright specular at grazing angles\n\n\t\t// half invV = lh * lh * smoothness + perceptualRoughness * perceptualRoughness; // approx ModifiedKelemenVisibilityTerm(lh, perceptualRoughness);\n\t\t// half invF = lh;\n\n\t\t// half specularTerm = ((specularPower + 1) * pow (nh, specularPower)) / (8 * invV * invF + 1e-4h);\n\n\t\t// #ifdef LAYA_COLORSPACE_GAMMA\n\t\t// \tspecularTerm = sqrt(max(1e-4f, specularTerm));\n\t\t// #endif\n\t// #endif\n\n\t// #if defined (SHADER_API_MOBILE)\n\t\tspecularTerm = clamp(specularTerm, 0.0, 100.0); // Prevent FP16 overflow on mobiles\n\t// #endif\n    \n    mediump vec3 color = (diffColor + specularTerm * specColor) * light.color * nl;\n\n    return vec4(color, 1.0);\n}\n\nmediump vec4 layaBRDFLowGI (mediump vec3 diffColor, mediump vec3 specColor,mediump float oneMinusReflectivity,mediump float smoothness,float perceptualRoughness,float roughness,mediump float nv,vec3 normal,vec3 viewDir,LayaGI gi)\n{\n\t// surfaceReduction = Int D(NdotH) * NdotH * Id(NdotL>0) dH = 1/(realRoughness^2+1)\n\n    // 1-0.28*x^3 as approximation for (1/(x^4+1))^(1/2.2) on the domain [0;1]\n    // 1-x^3*(0.6-0.08*x)   approximation for 1/(x^4+1)\n\t// #ifdef LAYA_COLORSPACE_GAMMA\n\t\tmediump float surfaceReduction = 0.28;\n\t// #else\n\t\t// mediump float surfaceReduction = (0.6-0.08*perceptualRoughness);\n\t// #endif\n\n    surfaceReduction = 1.0 - roughness*perceptualRoughness*surfaceReduction;\n\n\tmediump float grazingTerm = clamp(smoothness + (1.0-oneMinusReflectivity),0.0,1.0);\n\tmediump vec3 color =gi.diffuse * diffColor+ surfaceReduction * gi.specular * fresnelLerpFast (specColor, vec3(grazingTerm), nv);\n\n    return vec4(color, 1.0);\n}\n// BRDF2-------------------------------------------------------------------------------------'),_e.addInclude("PBRCore.glsl","struct FragmentCommonData{\n\tvec3 diffColor;\n\tvec3 specColor;\n\tfloat oneMinusReflectivity;\n\tfloat smoothness;\n\t//vec3 eyeVec;TODO:maybe can remove\n\t//float alpha;\n\t//vec3 reflUVW;\n};\n\n#if !defined(SETUP_BRDF_INPUT)//shader内部的宏需要将改成#ifdef改成#if类型 不然会被Laya的shader分析器优化掉\n    #define SETUP_BRDF_INPUT metallicSetup//default is metallicSetup,also can be other. \n#endif\n\nconst mediump vec4 dielectricSpecularColor = vec4(0.220916301, 0.220916301, 0.220916301, 1.0 - 0.220916301);\n\nmediump vec3 diffuseAndSpecularFromMetallic(mediump vec3 albedo,mediump float metallic, out mediump vec3 specColor, out mediump float oneMinusReflectivity)\n{\n\tspecColor = mix(dielectricSpecularColor.rgb, albedo, metallic);\n\toneMinusReflectivity= dielectricSpecularColor.a*(1.0-metallic);//diffuse proportion\n\treturn albedo * oneMinusReflectivity;\n}\n\nmediump float specularStrength(mediump vec3 specular)\n{\n    return max (max (specular.r, specular.g), specular.b);\n}\n\n// Diffuse/Spec Energy conservation\nmediump vec3 energyConservationBetweenDiffuseAndSpecular (mediump vec3 albedo, mediump vec3 specColor, out mediump float oneMinusReflectivity)\n{\n\toneMinusReflectivity = 1.0 - specularStrength(specColor);\n    return albedo * (vec3(1.0) - specColor);\n}\n\n#ifdef TRANSPARENTBLEND\n\tmediump vec3 preMultiplyAlpha (mediump vec3 diffColor, mediump float alpha, mediump float oneMinusReflectivity,out mediump float modifiedAlpha)\n\t{\n\t\t// Transparency 'removes' from Diffuse component\n\t\tdiffColor *= alpha;\n\t\t// Reflectivity 'removes' from the rest of components, including Transparency\n\t\t// modifiedAlpha = 1.0-(1.0-alpha)*(1.0-reflectivity) = 1.0-(oneMinusReflectivity - alpha*oneMinusReflectivity) = 1.0-oneMinusReflectivity + alpha*oneMinusReflectivity\n\t\tmodifiedAlpha = 1.0 - oneMinusReflectivity + alpha*oneMinusReflectivity;\n\t\treturn diffColor;\n\t}\n#endif\n\nFragmentCommonData metallicSetup(vec2 uv)\n{\n\tmediump vec2 metallicGloss = getMetallicGloss(uv);\n\tmediump float metallic = metallicGloss.x;\n\tmediump float smoothness = metallicGloss.y; // this is 1 minus the square root of real roughness m.\n\tmediump float oneMinusReflectivity;\n\tmediump vec3 specColor;\n\tmediump vec3 diffColor = diffuseAndSpecularFromMetallic(albedo(uv), metallic,/*out*/specColor,/*out*/oneMinusReflectivity);\n\n\tFragmentCommonData o;\n\to.diffColor = diffColor;\n\to.specColor = specColor;\n\to.oneMinusReflectivity = oneMinusReflectivity;\n\to.smoothness = smoothness;\n\treturn o;\n}\n\nFragmentCommonData specularSetup(vec2 uv)\n{\n    mediump vec4 specGloss = specularGloss(uv);\n    mediump vec3 specColor = specGloss.rgb;\n    mediump float smoothness = specGloss.a;\n\n    mediump float oneMinusReflectivity;\n    mediump vec3 diffColor = energyConservationBetweenDiffuseAndSpecular (albedo(uv), specColor, /*out*/ oneMinusReflectivity);\n\n    FragmentCommonData o;\n    o.diffColor = diffColor;\n    o.specColor = specColor;\n    o.oneMinusReflectivity = oneMinusReflectivity;\n    o.smoothness = smoothness;\n    return o;\n}\n\nLayaGI fragmentGI(float smoothness,vec3 eyeVec,mediump float occlusion,mediump vec2 lightmapUV,vec3 worldnormal,vec3 worldPos)\n{\n\tLayaGIInput giInput;\n\t#ifdef LIGHTMAP\n\t\tgiInput.lightmapUV=lightmapUV;\n\t#endif\n\tgiInput.worldPos = worldPos;\n\n\tvec3 worldViewDir = -eyeVec;\n\tmediump vec4 uvwRoughness;\n\tuvwRoughness.rgb = reflect(worldViewDir, worldnormal);//reflectUVW\n\tuvwRoughness.a= smoothnessToPerceptualRoughness(smoothness);//perceptualRoughness\n\n\treturn layaGlobalIllumination(giInput,occlusion, worldnormal, uvwRoughness);\n}\n\n\nvec3 perPixelWorldNormal(vec2 uv,vec3 normal,vec3 binormal,vec3 tangent)\n{\n\t#ifdef NORMALTEXTURE\n\t\tmediump vec3 normalTangent=normalInTangentSpace(uv);\n\t\tvec3 normalWorld = normalize(tangent * normalTangent.x + binormal * normalTangent.y + normal * normalTangent.z);\n\t#else\n\t\tvec3 normalWorld = normalize(normal);\n\t#endif\n\t\treturn normalWorld;\n}\n\nvoid fragmentForward()\n{\n\tvec2 uv;\n\t#if defined(ALBEDOTEXTURE)||defined(METALLICGLOSSTEXTURE)||defined(NORMALTEXTURE)||defined(EMISSIONTEXTURE)||defined(OCCLUSIONTEXTURE)||defined(PARALLAXTEXTURE)\n\t\t#ifdef PARALLAXTEXTURE\n\t\t\tuv = parallax(v_Texcoord0,normalize(v_ViewDirForParallax));\n\t\t#else\n\t\t\tuv = v_Texcoord0;\n\t\t#endif\n\t#endif\n\n\tmediump float alpha = getAlpha(uv);\n\t#ifdef ALPHATEST\n\t\tif(alpha<u_AlphaTestValue)\n\t\t\tdiscard;\n\t#endif\n\n\tFragmentCommonData o = SETUP_BRDF_INPUT(uv);\n\t\n\tvec3 binormal;\n\tvec3 tangent;\n\t#ifdef NORMALTEXTURE\n\t\ttangent = v_Tangent;\n\t\tbinormal = v_Binormal;\n\t#endif\n\n\tvec3 normal = v_Normal;\n\tvec3 normalWorld = perPixelWorldNormal(uv,normal,binormal,tangent);//In FS if the normal use mediump before normalize will cause precision prolem in mobile device.\n\tvec3 eyeVec = normalize(v_EyeVec);\n\tvec3 posworld = v_PositionWorld;\n\n\t#ifdef TRANSPARENTBLEND\n\t\to.diffColor=preMultiplyAlpha(o.diffColor,alpha,o.oneMinusReflectivity,/*out*/alpha);// shader relies on pre-multiply alpha-blend (srcBlend = One, dstBlend = OneMinusSrcAlpha)\n\t#endif\n\n\tmediump float occlusion = getOcclusion(uv);\n\tmediump vec2 lightMapUV;\n\t#ifdef LIGHTMAP\n\t\tlightMapUV=v_LightMapUV;\n\t#endif\n\tfloat perceptualRoughness = smoothnessToPerceptualRoughness(o.smoothness);\n\tfloat roughness = perceptualRoughnessToRoughness(perceptualRoughness);\n\tfloat nv = abs(dot(normalWorld, eyeVec));\n\tLayaGI gi =fragmentGI(o.smoothness,eyeVec,occlusion,lightMapUV,normalWorld,posworld);\n\tvec4 color = LAYA_BRDF_GI(o.diffColor,o.specColor,o.oneMinusReflectivity,o.smoothness,perceptualRoughness,roughness,nv,normalWorld,eyeVec,gi);\n\t\n\tfloat shadowAttenuation = 1.0;\n\t#ifdef LEGACYSINGLELIGHTING\n\t\t#ifdef DIRECTIONLIGHT\n\t\t\t#if defined(CALCULATE_SHADOWS)//shader中自定义的宏不可用ifdef 必须改成if defined\n\t\t\t\t#ifdef SHADOW_CASCADE\n\t\t\t\t\tvec4 shadowCoord = getShadowCoord(vec4(v_PositionWorld,1.0));\n\t\t\t\t#else\n\t\t\t\t\tvec4 shadowCoord = v_ShadowCoord;\n\t\t\t\t#endif\n\t\t\t\tshadowAttenuation=sampleShadowmap(shadowCoord);\n\t\t\t#endif\n\t\t\tLayaLight dirLight = layaDirectionLightToLight(u_DirectionLight,shadowAttenuation);\n\t\t\tcolor+= LAYA_BRDF_LIGHT(o.diffColor,o.specColor,o.oneMinusReflectivity,perceptualRoughness,roughness,nv,normalWorld,eyeVec,dirLight);\n\t\t#endif\n\t\n\t\t#ifdef POINTLIGHT\n\t\t\tshadowAttenuation = 1.0;\n\t\t\tLayaLight poiLight = layaPointLightToLight(posworld,normalWorld,u_PointLight,shadowAttenuation);\n\t\t\tcolor+= LAYA_BRDF_LIGHT(o.diffColor,o.specColor,o.oneMinusReflectivity,perceptualRoughness,roughness,nv,normalWorld,eyeVec,poiLight);\n\t\t#endif\n\t\t\n\t\t#ifdef SPOTLIGHT\n\t\t\tshadowAttenuation = 1.0;\n\t\t\t#if defined(CALCULATE_SPOTSHADOWS)//shader中自定义的宏不可用ifdef 必须改成if defined\n\t\t\t\tvec4 spotShadowcoord = v_SpotShadowCoord;\n\t\t\t\tshadowAttenuation = sampleSpotShadowmap(spotShadowcoord);\n\t\t\t#endif\n\t\t    LayaLight spoLight = layaSpotLightToLight(posworld,normalWorld,u_SpotLight,shadowAttenuation);\n\t\t\tcolor+= LAYA_BRDF_LIGHT(o.diffColor,o.specColor,o.oneMinusReflectivity,perceptualRoughness,roughness,nv,normalWorld,eyeVec,spoLight);\n\t\t#endif\n\t#else\n\t \t#ifdef DIRECTIONLIGHT\n\t\t\tfor (int i = 0; i < MAX_LIGHT_COUNT; i++) \n\t\t\t{\n\t\t\t\tshadowAttenuation = 1.0;\n\t\t\t\tif(i >= u_DirationLightCount)\n\t\t\t\t\tbreak;\n\t\t\t\t#if defined(CALCULATE_SHADOWS)//shader中自定义的宏不可用ifdef 必须改成if defined\n\t\t\t\t\tif(i == 0)\n\t\t\t\t\t{\n\t\t\t\t\t\t#ifdef SHADOW_CASCADE\n\t\t\t\t\t\t\tvec4 shadowCoord = getShadowCoord(vec4(v_PositionWorld,1.0));\n\t\t\t\t\t\t#else\n\t\t\t\t\t\t\tvec4 shadowCoord = v_ShadowCoord;\n\t\t\t\t\t\t#endif\n\t\t\t\t\t\tshadowAttenuation *= sampleShadowmap(shadowCoord);\n\t\t\t\t\t}\n\t\t\t\t#endif\n\t\t\t\tDirectionLight directionLight = getDirectionLight(u_LightBuffer,i);\n\t\t\t\tLayaLight dirLight = layaDirectionLightToLight(directionLight,shadowAttenuation);\n\t\t\t \tcolor+=LAYA_BRDF_LIGHT(o.diffColor,o.specColor,o.oneMinusReflectivity,perceptualRoughness,roughness,nv,normalWorld,eyeVec,dirLight);\n\t\t\t}\n\t \t#endif\n\t\t#if defined(POINTLIGHT)||defined(SPOTLIGHT)\n\t\t\tivec4 clusterInfo =getClusterInfo(u_LightClusterBuffer,u_View,u_Viewport, v_PositionWorld,gl_FragCoord,u_ProjectionParams);\n\t\t\t#ifdef POINTLIGHT\n\t\t\t\tfor (int i = 0; i < MAX_LIGHT_COUNT; i++) \n\t\t\t\t{\n\t\t\t\t\tshadowAttenuation = 1.0;\n\t\t\t\t\tif(i >= clusterInfo.x)//PointLightCount\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tPointLight pointLight = getPointLight(u_LightBuffer,u_LightClusterBuffer,clusterInfo,i);\n\t\t\t\t\tLayaLight poiLight = layaPointLightToLight(posworld,normalWorld,pointLight,shadowAttenuation);\n\t\t\t\t\tcolor+= LAYA_BRDF_LIGHT(o.diffColor,o.specColor,o.oneMinusReflectivity,perceptualRoughness,roughness,nv,normalWorld,eyeVec,poiLight);\n\t\t\t\t}\n\t\t\t#endif\n\t\t\t#ifdef SPOTLIGHT\n\t\t\t\tfor (int i = 0; i < MAX_LIGHT_COUNT; i++) \n\t\t\t\t{\n\t\t\t\t\tshadowAttenuation = 1.0;\n\t\t\t\t\tif(i >= clusterInfo.y)//SpotLightCount\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t#if defined(CALCULATE_SPOTSHADOWS)//shader中自定义的宏不可用ifdef 必须改成if defined\n\t\t\t\t\t\tif(i == 0)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tvec4 spotShadowcoord = v_SpotShadowCoord;\n\t\t\t\t\t\t\tshadowAttenuation= sampleSpotShadowmap(spotShadowcoord);\n\t\t\t\t\t\t}\n\t\t\t\t\t#endif\n\t\t\t\t\tSpotLight spotLight = getSpotLight(u_LightBuffer,u_LightClusterBuffer,clusterInfo,i);\n\t\t\t\t\tLayaLight spoLight = layaSpotLightToLight(posworld,normalWorld,spotLight,shadowAttenuation);\n\t\t\t\t\tcolor+= LAYA_BRDF_LIGHT(o.diffColor,o.specColor,o.oneMinusReflectivity,perceptualRoughness,roughness,nv,normalWorld,eyeVec,spoLight);\n\t\t\t\t}\n\t\t\t#endif\n\t\t#endif\n\t #endif\n\n\t#ifdef EMISSION\n\t\tcolor.rgb += emission(uv);\n\t#endif\n\n\t#ifdef FOG\n\t\tfloat lerpFact=clamp((1.0/gl_FragCoord.w-u_FogStart)/u_FogRange,0.0,1.0);\n\t\tcolor.rgb=mix(color.rgb,u_FogColor,lerpFact);\n\t#endif\n\t\n\tgl_FragColor=vec4(color.rgb,alpha);\n}\n\n\n\n"),_e.addInclude("PBRVertex.glsl","vec2 transformLightMapUV(in vec2 texcoord,in vec4 lightmapScaleOffset)\n{\n\tvec2 lightMapUV=vec2(texcoord.x,1.0-texcoord.y)*lightmapScaleOffset.xy+lightmapScaleOffset.zw;\n\tlightMapUV.y=1.0-lightMapUV.y;\n\treturn lightMapUV; \n}\n\nvoid vertexForward()\n{\n\tvec4 position;\n\t#ifdef BONE\n\t\tmat4 skinTransform;\n\t \t#ifdef SIMPLEBONE\n\t\t\tfloat currentPixelPos;\n\t\t\t#ifdef GPU_INSTANCE\n\t\t\t\tcurrentPixelPos = a_SimpleTextureParams.x+a_SimpleTextureParams.y;\n\t\t\t#else\n\t\t\t\tcurrentPixelPos = u_SimpleAnimatorParams.x+u_SimpleAnimatorParams.y;\n\t\t\t#endif\n\t\t\tfloat offset = 1.0/u_SimpleAnimatorTextureSize;\n\t\t\tskinTransform =  loadMatFromTexture(currentPixelPos,int(a_BoneIndices.x),offset) * a_BoneWeights.x;\n\t\t\tskinTransform += loadMatFromTexture(currentPixelPos,int(a_BoneIndices.y),offset) * a_BoneWeights.y;\n\t\t\tskinTransform += loadMatFromTexture(currentPixelPos,int(a_BoneIndices.z),offset) * a_BoneWeights.z;\n\t\t\tskinTransform += loadMatFromTexture(currentPixelPos,int(a_BoneIndices.w),offset) * a_BoneWeights.w;\n\t\t#else\n\t\t\tskinTransform =  u_Bones[int(a_BoneIndices.x)] * a_BoneWeights.x;\n\t\t\tskinTransform += u_Bones[int(a_BoneIndices.y)] * a_BoneWeights.y;\n\t\t\tskinTransform += u_Bones[int(a_BoneIndices.z)] * a_BoneWeights.z;\n\t\t\tskinTransform += u_Bones[int(a_BoneIndices.w)] * a_BoneWeights.w;\n\t\t#endif\n\t\tposition=skinTransform*a_Position;\n\t #else\n\t\tposition=a_Position;\n\t#endif\n\n\tmat4 worldMat;\n\t#ifdef GPU_INSTANCE\n\t\tworldMat = a_WorldMat;\n\t#else\n\t\tworldMat = u_WorldMat;\n\t#endif\n\n\t#ifdef GPU_INSTANCE\n\t\tgl_Position = u_ViewProjection * worldMat * position;\n\t#else\n\t\tgl_Position = u_MvpMatrix * position;\n\t#endif\n\n\t\n\n\tv_PositionWorld=(worldMat*position).xyz;\n\n\t#if defined(ALBEDOTEXTURE)||defined(METALLICGLOSSTEXTURE)||defined(NORMALTEXTURE)||defined(EMISSIONTEXTURE)||defined(OCCLUSIONTEXTURE)||defined(PARALLAXTEXTURE)\n\t\tv_Texcoord0=TransformUV(a_Texcoord0,u_TilingOffset);\n\t#endif\n\n\tv_EyeVec =u_CameraPos-v_PositionWorld;//will normalize per-pixel\n\n\t#ifdef LIGHTMAP\n\t\tvec2 texcoord;\n\t\t#ifdef UV1\n\t\t\ttexcoord=a_Texcoord1;\n\t\t#else\n\t\t\ttexcoord=a_Texcoord0;\n\t\t#endif\n\t\tv_LightMapUV=transformLightMapUV(texcoord,u_LightmapScaleOffset);\n\t#endif\n\n\tmat3 worldInvMat;\n\t#ifdef BONE\n\t\tworldInvMat=INVERSE_MAT(mat3(worldMat*skinTransform));\n\t#else\n\t\tworldInvMat=INVERSE_MAT(mat3(worldMat));\n\t#endif\n\n\tv_Normal=normalize(a_Normal*worldInvMat);//if no normalize will cause precision problem.\n\n\t#ifdef NORMALTEXTURE\n\t\tv_Tangent=normalize(a_Tangent0.xyz*worldInvMat);\n\t\tv_Binormal=cross(v_Normal,v_Tangent)*a_Tangent0.w;\n\t#endif\n\n\t#ifdef PARALLAXTEXTURE\n\t\tvec3 binormal = cross(a_Normal, a_Tangent0.xyz)*a_Tangent0.w;\n\t\tmat3 objectTBN = mat3(a_Tangent0.xyz, binormal, a_Normal);\n\t\tv_ViewDirForParallax =(u_CameraPos*worldInvMat-position.xyz)*objectTBN;\n\t#endif\n\n\t#if defined(CALCULATE_SHADOWS)&&!defined(SHADOW_CASCADE)\n\t\tv_ShadowCoord = getShadowCoord(vec4(v_PositionWorld,1.0));\n\t#endif\n\n\t#if defined(CALCULATE_SPOTSHADOWS)//shader中自定义的宏不可用ifdef 必须改成if defined\n\t\tv_SpotShadowCoord = u_SpotViewProjectMatrix*vec4(v_PositionWorld,1.0);\n\t#endif\n}"),_e.addInclude("LayaUtile.glsl","\n\n//SimpleSkinnedMesh\n#ifdef SIMPLEBONE\n\t#ifdef GPU_INSTANCE\n\t\tattribute vec4 a_SimpleTextureParams;\n\t#else\n\t\tuniform vec4 u_SimpleAnimatorParams;\n\t#endif\n\tuniform sampler2D u_SimpleAnimatorTexture;\n\n\tuniform float u_SimpleAnimatorTextureSize; \n#endif\n\n\n#ifdef SIMPLEBONE\n\tmat4 loadMatFromTexture(float FramePos,int boneIndices,float offset)\n\t{\n\t\tvec2 uv;\n\t\tfloat PixelPos = FramePos+float(boneIndices)*4.0;\n\t\tfloat halfOffset = offset * 0.5;\n\t\tfloat uvoffset = PixelPos/u_SimpleAnimatorTextureSize;\n\t\tuv.y = floor(uvoffset)*offset+halfOffset;\n\t\tuv.x = mod(float(PixelPos),u_SimpleAnimatorTextureSize)*offset+halfOffset;\n\t\tvec4 mat0row = texture2D(u_SimpleAnimatorTexture,uv);\n\t\tuv.x+=offset;\n\t\tvec4 mat1row = texture2D(u_SimpleAnimatorTexture,uv);\n\t\tuv.x+=offset;\n\t\tvec4 mat2row = texture2D(u_SimpleAnimatorTexture,uv);\n\t\tuv.x+=offset;\n\t\tvec4 mat3row = texture2D(u_SimpleAnimatorTexture,uv);\n\t\tmat4 m =mat4(mat0row.x,mat0row.y,mat0row.z,mat0row.w,\n\t\t\t\tmat1row.x,mat1row.y,mat1row.z,mat1row.w,\n\t\t\t\tmat2row.x,mat2row.y,mat2row.z,mat2row.w,\n\t\t\t\tmat3row.x,mat3row.y,mat3row.z,mat3row.w);\n\t\treturn m;\n\t}\n#endif\n\n"),_e.addInclude("DepthNormalUtil.glsl","#define SAMPLE_DEPTH_TEXTURE(textureName,coord2) (texture2D(textureName,coord2).r)\n//此方法库用来压缩解析深度贴图，法线深度贴图\n\n/*camera 传入的Texture以及*/\nuniform sampler2D u_CameraDepthTexture;\nuniform vec4 u_ZBufferParams;\nuniform sampler2D u_CameraDepthNormalsTexture;\n\n// Encoding/decoding view space normals into 2D 0..1 vector\nvec2 EncodeViewNormalStereo( vec3 n )\n{\n    n.z = abs(n.z);\n    float kScale = 1.7777;\n    vec2 enc;\n    enc = n.xy / (n.z+1.0);\n    enc /= kScale;\n    enc = enc*0.5+0.5;\n    return enc;\n}\n\nvec3 DecodeViewNormalStereo( vec4 enc4 )\n{\n    float kScale = 1.7777;\n    vec3 nn = enc4.xyz*vec3(2.0*kScale,2.0*kScale,0.0) + vec3(-kScale,-kScale,1.0);\n    float g = 2.0 / dot(nn.xyz,nn.xyz);\n    vec3 n;\n    n.xy = g*nn.xy;\n    n.z = g-1.0;\n    return n;\n}\n\n\n// Encoding/decoding [0..1) floats into 8 bit/channel RG. Note that 1.0 will not be encoded properly.\nvec2 EncodeFloatRG( float v )\n{\n    vec2 kEncodeMul = vec2(1.0, 255.0);\n    float kEncodeBit = 1.0/255.0;\n    vec2 enc = kEncodeMul * v;\n    enc = fract(enc);\n    enc.x -= enc.y * kEncodeBit;\n    return enc;\n}\n\n\n\nfloat DecodeFloatRG( vec2 enc )\n{\n    vec2 kDecodeDot = vec2(1.0, 1.0/255.0);\n    return dot( enc, kDecodeDot );\n}\n\nvec4 EncodeDepthNormal(float depth,vec3 normals){\n\tvec4 encode;\n\tencode.xy = EncodeViewNormalStereo(normals);\n\tencode.zw = EncodeFloatRG(depth);\n    return encode;\n}\n\nvoid DecodeDepthNormal( vec4 enc, out float depth, out vec3 normal )\n{\n    depth = DecodeFloatRG (enc.zw);\n    normal = DecodeViewNormalStereo (enc);\n}\n\n\n\nvec4 depthNormalsFragment(vec4 depthNormal)\n{\n    return EncodeDepthNormal(depthNormal.w,depthNormal.xyz);\n}\n\n\n// Z buffer to linear 0..1 depth\nfloat Linear01Depth(float z,vec4 zbufferParams)\n{\n    return 1.0 / (zbufferParams.x * z + zbufferParams.y);\n}\n// Z buffer to linear depth\nfloat LinearEyeDepth(float z,vec4 zbufferParams)\n{\n    return 1.0 / (zbufferParams.z * z + zbufferParams.w);\n}\n");var e={a_Position:Ne.MESH_POSITION0,a_Color:Ne.MESH_COLOR0,a_Normal:Ne.MESH_NORMAL0,a_Texcoord0:Ne.MESH_TEXTURECOORDINATE0,a_Texcoord1:Ne.MESH_TEXTURECOORDINATE1,a_BoneWeights:Ne.MESH_BLENDWEIGHT0,a_BoneIndices:Ne.MESH_BLENDINDICES0,a_Tangent0:Ne.MESH_TANGENT0,a_WorldMat:Ne.MESH_WORLDMATRIX_ROW0,a_SimpleTextureParams:Ne.MESH_SIMPLEANIMATOR},t={u_Bones:_e.PERIOD_CUSTOM,u_DiffuseTexture:_e.PERIOD_MATERIAL,u_SpecularTexture:_e.PERIOD_MATERIAL,u_NormalTexture:_e.PERIOD_MATERIAL,u_AlphaTestValue:_e.PERIOD_MATERIAL,u_DiffuseColor:_e.PERIOD_MATERIAL,u_MaterialSpecular:_e.PERIOD_MATERIAL,u_Shininess:_e.PERIOD_MATERIAL,u_TilingOffset:_e.PERIOD_MATERIAL,u_TransmissionRate:_e.PERIOD_MATERIAL,u_BackDiffuse:_e.PERIOD_MATERIAL,u_BackScale:_e.PERIOD_MATERIAL,u_ThinknessTexture:_e.PERIOD_MATERIAL,u_TransmissionColor:_e.PERIOD_MATERIAL,u_WorldMat:_e.PERIOD_SPRITE,u_MvpMatrix:_e.PERIOD_SPRITE,u_LightmapScaleOffset:_e.PERIOD_SPRITE,u_LightMap:_e.PERIOD_SPRITE,u_LightMapDirection:_e.PERIOD_SPRITE,u_SimpleAnimatorTexture:_e.PERIOD_SPRITE,u_SimpleAnimatorParams:_e.PERIOD_SPRITE,u_SimpleAnimatorTextureSize:_e.PERIOD_SPRITE,u_CameraPos:_e.PERIOD_CAMERA,u_Viewport:_e.PERIOD_CAMERA,u_ProjectionParams:_e.PERIOD_CAMERA,u_View:_e.PERIOD_CAMERA,u_ViewProjection:_e.PERIOD_CAMERA,u_ReflectTexture:_e.PERIOD_SCENE,u_FogStart:_e.PERIOD_SCENE,u_FogRange:_e.PERIOD_SCENE,u_FogColor:_e.PERIOD_SCENE,u_DirationLightCount:_e.PERIOD_SCENE,u_LightBuffer:_e.PERIOD_SCENE,u_LightClusterBuffer:_e.PERIOD_SCENE,u_AmbientColor:_e.PERIOD_SCENE,u_ShadowBias:_e.PERIOD_SCENE,u_ShadowLightDirection:_e.PERIOD_SCENE,u_ShadowMap:_e.PERIOD_SCENE,u_ShadowParams:_e.PERIOD_SCENE,u_ShadowSplitSpheres:_e.PERIOD_SCENE,u_ShadowMatrices:_e.PERIOD_SCENE,u_ShadowMapSize:_e.PERIOD_SCENE,u_SpotShadowMap:_e.PERIOD_SCENE,u_SpotViewProjectMatrix:_e.PERIOD_SCENE,u_ShadowLightPosition:_e.PERIOD_SCENE,u_AmbientSHAr:_e.PERIOD_SCENE,u_AmbientSHAg:_e.PERIOD_SCENE,u_AmbientSHAb:_e.PERIOD_SCENE,u_AmbientSHBr:_e.PERIOD_SCENE,u_AmbientSHBg:_e.PERIOD_SCENE,u_AmbientSHBb:_e.PERIOD_SCENE,u_AmbientSHC:_e.PERIOD_SCENE,"u_DirectionLight.color":_e.PERIOD_SCENE,"u_DirectionLight.direction":_e.PERIOD_SCENE,"u_PointLight.position":_e.PERIOD_SCENE,"u_PointLight.range":_e.PERIOD_SCENE,"u_PointLight.color":_e.PERIOD_SCENE,"u_SpotLight.position":_e.PERIOD_SCENE,"u_SpotLight.direction":_e.PERIOD_SCENE,"u_SpotLight.range":_e.PERIOD_SCENE,"u_SpotLight.spot":_e.PERIOD_SCENE,"u_SpotLight.color":_e.PERIOD_SCENE},n={s_Cull:_e.RENDER_STATE_CULL,s_Blend:_e.RENDER_STATE_BLEND,s_BlendSrc:_e.RENDER_STATE_BLEND_SRC,s_BlendDst:_e.RENDER_STATE_BLEND_DST,s_DepthTest:_e.RENDER_STATE_DEPTH_TEST,s_DepthWrite:_e.RENDER_STATE_DEPTH_WRITE},i=_e.add("BLINNPHONG",null,null,!0),a=new Tn(e,t);i.addSubShader(a),a.addShaderPass('#if defined(GL_FRAGMENT_PRECISION_HIGH)// 原来的写法会被我们自己的解析流程处理，而我们的解析是不认内置宏的，导致被删掉，所以改成 if defined 了\n\tprecision highp float;\n\tprecision highp int;\n#else\n\tprecision mediump float;\n\tprecision mediump int;\n#endif\n#include "Lighting.glsl";\n#include "LayaUtile.glsl"\n#include "Shadow.glsl";\n\n\nattribute vec4 a_Position;\n\n#ifdef GPU_INSTANCE\n\tuniform mat4 u_ViewProjection;\n#else\n\tuniform mat4 u_MvpMatrix;\n#endif\n\n#if defined(DIFFUSEMAP)||defined(THICKNESSMAP)||((defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT))&&(defined(SPECULARMAP)||defined(NORMALMAP)))||(defined(LIGHTMAP)&&defined(UV))\n\tattribute vec2 a_Texcoord0;\n\tvarying vec2 v_Texcoord0;\n#endif\n\n#if defined(LIGHTMAP)&&defined(UV1)\n\tattribute vec2 a_Texcoord1;\n#endif\n\n#ifdef LIGHTMAP\n\tuniform vec4 u_LightmapScaleOffset;\n\tvarying vec2 v_LightMapUV;\n#endif\n\n#ifdef COLOR\n\tattribute vec4 a_Color;\n\tvarying vec4 v_Color;\n#endif\n\n#ifdef BONE\n\tconst int c_MaxBoneCount = 24;\n\tattribute vec4 a_BoneIndices;\n\tattribute vec4 a_BoneWeights;\n\tuniform mat4 u_Bones[c_MaxBoneCount];\n#endif\n\nattribute vec3 a_Normal;\nvarying vec3 v_Normal; \n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n\tuniform vec3 u_CameraPos;\n\tvarying vec3 v_ViewDir; \n#endif\n\n#if defined(NORMALMAP)\n\tattribute vec4 a_Tangent0;\n\tvarying vec3 v_Tangent;\n\tvarying vec3 v_Binormal;\n#endif\n\n#ifdef GPU_INSTANCE\n\tattribute mat4 a_WorldMat;\n#else\n\tuniform mat4 u_WorldMat;\n#endif\n\n#if defined(POINTLIGHT)||defined(SPOTLIGHT)||(defined(CALCULATE_SHADOWS)&&defined(SHADOW_CASCADE))||defined(CALCULATE_SPOTSHADOWS)\n\tvarying vec3 v_PositionWorld;\n#endif\n\n#if defined(CALCULATE_SHADOWS)&&!defined(SHADOW_CASCADE)\n\tvarying vec4 v_ShadowCoord;\n#endif\n\n#if defined(CALCULATE_SPOTSHADOWS)//shader中自定义的宏不可用ifdef 必须改成if defined\n\tvarying vec4 v_SpotShadowCoord;\n#endif\n\nuniform vec4 u_TilingOffset;\n\nvoid main()\n{\n\tvec4 position;\n\t#ifdef BONE\n\t\tmat4 skinTransform;\n\t \t#ifdef SIMPLEBONE\n\t\t\tfloat currentPixelPos;\n\t\t\t#ifdef GPU_INSTANCE\n\t\t\t\tcurrentPixelPos = a_SimpleTextureParams.x+a_SimpleTextureParams.y;\n\t\t\t#else\n\t\t\t\tcurrentPixelPos = u_SimpleAnimatorParams.x+u_SimpleAnimatorParams.y;\n\t\t\t#endif\n\t\t\tfloat offset = 1.0/u_SimpleAnimatorTextureSize;\n\t\t\tskinTransform =  loadMatFromTexture(currentPixelPos,int(a_BoneIndices.x),offset) * a_BoneWeights.x;\n\t\t\tskinTransform += loadMatFromTexture(currentPixelPos,int(a_BoneIndices.y),offset) * a_BoneWeights.y;\n\t\t\tskinTransform += loadMatFromTexture(currentPixelPos,int(a_BoneIndices.z),offset) * a_BoneWeights.z;\n\t\t\tskinTransform += loadMatFromTexture(currentPixelPos,int(a_BoneIndices.w),offset) * a_BoneWeights.w;\n\t\t#else\n\t\t\tskinTransform =  u_Bones[int(a_BoneIndices.x)] * a_BoneWeights.x;\n\t\t\tskinTransform += u_Bones[int(a_BoneIndices.y)] * a_BoneWeights.y;\n\t\t\tskinTransform += u_Bones[int(a_BoneIndices.z)] * a_BoneWeights.z;\n\t\t\tskinTransform += u_Bones[int(a_BoneIndices.w)] * a_BoneWeights.w;\n\t\t#endif\n\t\tposition=skinTransform*a_Position;\n\t #else\n\t\tposition=a_Position;\n\t#endif\n\n\n\t\n\tmat4 worldMat;\n\t#ifdef GPU_INSTANCE\n\t\tworldMat = a_WorldMat;\n\t#else\n\t\tworldMat = u_WorldMat;\n\t#endif\n\n\t#ifdef GPU_INSTANCE\n\t\tgl_Position = u_ViewProjection * worldMat * position;\n\t#else\n\t\tgl_Position = u_MvpMatrix * position;\n\t#endif\n\n\tmat3 worldInvMat;\n\t#ifdef BONE\n\t\tworldInvMat=INVERSE_MAT(mat3(worldMat*skinTransform));\n\t#else\n\t\tworldInvMat=INVERSE_MAT(mat3(worldMat));\n\t#endif  \n\tv_Normal=normalize(a_Normal*worldInvMat);\n\t#if defined(NORMALMAP)\n\t\tv_Tangent=normalize(a_Tangent0.xyz*worldInvMat);\n\t\tv_Binormal=cross(v_Normal,v_Tangent)*a_Tangent0.w;\n\t#endif\n\n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||(defined(CALCULATE_SHADOWS)&&defined(SHADOW_CASCADE))||defined(CALCULATE_SPOTSHADOWS)\n\t\tvec3 positionWS=(worldMat*position).xyz;\n\t\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n\t\t\tv_ViewDir = u_CameraPos-positionWS;\n\t\t#endif\n\t\t#if defined(POINTLIGHT)||defined(SPOTLIGHT)||(defined(CALCULATE_SHADOWS)&&defined(SHADOW_CASCADE))||defined(CALCULATE_SPOTSHADOWS)\n\t\t\tv_PositionWorld = positionWS;\n\t\t#endif\n\t#endif\n\n\t#if defined(DIFFUSEMAP)||defined(THICKNESSMAP)||((defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT))&&(defined(SPECULARMAP)||defined(NORMALMAP)))\n\t\tv_Texcoord0=TransformUV(a_Texcoord0,u_TilingOffset);\n\t#endif\n\n\t#ifdef LIGHTMAP\n\t\t#ifdef UV1\n\t\t\tv_LightMapUV=vec2(a_Texcoord1.x,1.0-a_Texcoord1.y)*u_LightmapScaleOffset.xy+u_LightmapScaleOffset.zw;\n\t\t#else\n\t\t\tv_LightMapUV=vec2(a_Texcoord0.x,1.0-a_Texcoord0.y)*u_LightmapScaleOffset.xy+u_LightmapScaleOffset.zw;\n\t\t#endif \n\t\tv_LightMapUV.y=1.0-v_LightMapUV.y;\n\t#endif\n\n\t#if defined(COLOR)&&defined(ENABLEVERTEXCOLOR)\n\t\tv_Color=a_Color;\n\t#endif\n\n\t#if defined(CALCULATE_SHADOWS)&&!defined(SHADOW_CASCADE)\n\t\tv_ShadowCoord =getShadowCoord(vec4(positionWS,1.0));\n\t#endif\n\n\t#if defined(CALCULATE_SPOTSHADOWS)//shader中自定义的宏不可用ifdef 必须改成if defined\n\t\tv_SpotShadowCoord = u_SpotViewProjectMatrix*vec4(positionWS,1.0);\n\t#endif\n\n\tgl_Position=remapGLPositionZ(gl_Position);\n}','#if defined(GL_FRAGMENT_PRECISION_HIGH)// 原来的写法会被我们自己的解析流程处理，而我们的解析是不认内置宏的，导致被删掉，所以改成 if defined 了\n\tprecision highp float;\n\tprecision highp int;\n#else\n\tprecision mediump float;\n\tprecision mediump int;\n#endif\n\n\n#include "Lighting.glsl";\n#include "Shadow.glsl"\n\nuniform vec4 u_DiffuseColor;\n\n#if defined(COLOR)&&defined(ENABLEVERTEXCOLOR)\n\tvarying vec4 v_Color;\n#endif\n\n#ifdef ALPHATEST\n\tuniform float u_AlphaTestValue;\n#endif\n\n#ifdef DIFFUSEMAP\n\tuniform sampler2D u_DiffuseTexture;\n#endif\n\n\n#if defined(DIFFUSEMAP)||defined(THICKNESSMAP)||((defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT))&&(defined(SPECULARMAP)||defined(NORMALMAP)))\n\tvarying vec2 v_Texcoord0;\n#endif\n\n#ifdef LIGHTMAP\n\tvarying vec2 v_LightMapUV;\n\tuniform sampler2D u_LightMap;\n\t#ifdef LIGHTMAP_DIRECTIONAL\n\t\tuniform sampler2D u_LightMapDirection;\n\t#endif\n#endif\n\nvarying vec3 v_Normal;\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n\tvarying vec3 v_ViewDir; \n\n\tuniform vec3 u_MaterialSpecular;\n\tuniform float u_Shininess;\n\n\t#ifdef LEGACYSINGLELIGHTING\n\t\t#ifdef DIRECTIONLIGHT\n\t\t\tuniform DirectionLight u_DirectionLight;\n\t\t#endif\n\t\t#ifdef POINTLIGHT\n\t\t\tuniform PointLight u_PointLight;\n\t\t#endif\n\t\t#ifdef SPOTLIGHT\n\t\t\tuniform SpotLight u_SpotLight;\n\t\t#endif\n\t#else\n\t\tuniform mat4 u_View;\n\t\tuniform vec4 u_ProjectionParams;\n\t\tuniform vec4 u_Viewport;\n\t\tuniform int u_DirationLightCount;\n\t\tuniform sampler2D u_LightBuffer;\n\t\tuniform sampler2D u_LightClusterBuffer;\n\t#endif\n\n\t#ifdef SPECULARMAP \n\t\tuniform sampler2D u_SpecularTexture;\n\t#endif\n#endif\n\n#ifdef NORMALMAP \n\tuniform sampler2D u_NormalTexture;\n\tvarying vec3 v_Tangent;\n\tvarying vec3 v_Binormal;\n#endif\n\n#ifdef FOG\n\tuniform float u_FogStart;\n\tuniform float u_FogRange;\n\tuniform vec3 u_FogColor;\n#endif\n\n#if defined(POINTLIGHT)||defined(SPOTLIGHT)||(defined(CALCULATE_SHADOWS)&&defined(SHADOW_CASCADE))||defined(CALCULATE_SPOTSHADOWS)\n\tvarying vec3 v_PositionWorld;\n#endif\n\n\n#include "GlobalIllumination.glsl";//"GlobalIllumination.glsl use uniform should at front of this\n\n#if defined(CALCULATE_SHADOWS)&&!defined(SHADOW_CASCADE)\n\tvarying vec4 v_ShadowCoord;\n#endif\n\n#if defined(CALCULATE_SPOTSHADOWS)//shader中自定义的宏不可用ifdef 必须改成if defined\n\tvarying vec4 v_SpotShadowCoord;\n#endif\n\n\nvoid main()\n{\n\tvec3 normal;//light and SH maybe use normal\n\t#if defined(NORMALMAP)\n\t\tvec3 normalMapSample = texture2D(u_NormalTexture, v_Texcoord0).rgb;\n\t\tnormal = normalize(NormalSampleToWorldSpace(normalMapSample, v_Normal, v_Tangent,v_Binormal));\n\t#else\n\t\tnormal = normalize(v_Normal);\n\t#endif\n\n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n\t\tvec3 viewDir= normalize(v_ViewDir);\n\t#endif\n\n\tLayaGIInput giInput;\n\t#ifdef LIGHTMAP\t\n\t\tgiInput.lightmapUV=v_LightMapUV;\n\t#endif\n\tvec3 globalDiffuse=layaGIBase(giInput,1.0,normal);\n\t\n\tvec4 mainColor=u_DiffuseColor;\n\t#ifdef DIFFUSEMAP\n\t\tvec4 difTexColor=texture2D(u_DiffuseTexture, v_Texcoord0);\n\t\tmainColor=mainColor*difTexColor;\n\t#endif \n\t#if defined(COLOR)&&defined(ENABLEVERTEXCOLOR)\n\t\tmainColor=mainColor*v_Color;\n\t#endif \n    \n\t#ifdef ALPHATEST\n\t\tif(mainColor.a<u_AlphaTestValue)\n\t\t\tdiscard;\n\t#endif\n  \n\t\n\tvec3 diffuse = vec3(0.0);\n\tvec3 specular= vec3(0.0);\n\tvec3 transmissionDiffuse = vec3(0.0);\n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n\t\tvec3 dif,spe,transmis;\n\t\tfloat transmissionFactor;\n\t\t#ifdef SPECULARMAP\n\t\t\tvec3 gloss=texture2D(u_SpecularTexture, v_Texcoord0).rgb;\n\t\t#else\n\t\t\t#ifdef DIFFUSEMAP\n\t\t\t\tvec3 gloss=vec3(difTexColor.a);\n\t\t\t#else\n\t\t\t\tvec3 gloss=vec3(1.0);\n\t\t\t#endif\n\t\t#endif\n\t\t#ifdef THICKNESSMAP\n\t\t\ttransmissionFactor = texture2D(u_ThinknessTexture, v_Texcoord0).r;\n\t\t#endif\n\t#endif\n\n\t\n\t\n\t#ifdef LEGACYSINGLELIGHTING\n\t\t#ifdef DIRECTIONLIGHT\n\t\t\tLayaAirBlinnPhongDiectionLight(u_MaterialSpecular,u_Shininess,normal,gloss,viewDir,u_DirectionLight,transmissionFactor,dif,spe,transmis);\n\t\t\t#if defined(CALCULATE_SHADOWS)//shader中自定义的宏不可用ifdef 必须改成if defined\n\t\t\t\t#ifdef SHADOW_CASCADE\n\t\t\t\t\tvec4 shadowCoord = getShadowCoord(vec4(v_PositionWorld,1.0));\n\t\t\t\t#else\n\t\t\t\t\tvec4 shadowCoord = v_ShadowCoord;\n\t\t\t\t#endif\n\t\t\t\tfloat shadowAttenuation=sampleShadowmap(shadowCoord);\n\t\t\t\tdif *= shadowAttenuation;\n\t\t\t\tspe *= shadowAttenuation;\n\t\t\t\ttransmis *=shadowAttenuation;\n\t\t\t#endif\n\t\t\tdiffuse+=dif;\n\t\t\tspecular+=spe;\n\t\t\ttransmissionDiffuse+=transmis;\n\t\t#endif\n\t\n\t\t#ifdef POINTLIGHT\n\t\t\tLayaAirBlinnPhongPointLight(v_PositionWorld,u_MaterialSpecular,u_Shininess,normal,gloss,viewDir,u_PointLight,transmissionFactor,dif,spe,transmis);\n\t\t\tdiffuse+=dif;\n\t\t\tspecular+=spe;\n\t\t\ttransmissionDiffuse+=transmis;\n\t\t#endif\n\n\t\t#ifdef SPOTLIGHT\n\t\t\tLayaAirBlinnPhongSpotLight(v_PositionWorld,u_MaterialSpecular,u_Shininess,normal,gloss,viewDir,u_SpotLight,transmissionFactor,dif,spe,transmis);\n\t\t\t#if defined(CALCULATE_SPOTSHADOWS)//shader中自定义的宏不可用ifdef 必须改成if defined\n\t\t\t\tvec4 spotShadowcoord = v_SpotShadowCoord;\n\t\t\t\tfloat spotShadowAttenuation = sampleSpotShadowmap(spotShadowcoord);\n\t\t\t\tdif *= spotShadowAttenuation;\n\t\t\t\tspe *= spotShadowAttenuation;\n\t\t\t\ttransmis *=spotShadowAttenuation;\n\t\t\t#endif\n\t\t\tdiffuse+=dif;\n\t\t\tspecular+=spe;\n\t\t\ttransmissionDiffuse+=transmis;\n\t\t#endif\n\t#else\n\t\t#ifdef DIRECTIONLIGHT\n\t\t\tfor (int i = 0; i < MAX_LIGHT_COUNT; i++) \n\t\t\t{\n\t\t\t\tif(i >= u_DirationLightCount)\n\t\t\t\t\tbreak;\n\t\t\t\tDirectionLight directionLight = getDirectionLight(u_LightBuffer,i);\n\t\t\t\t#if defined(CALCULATE_SHADOWS)//shader中自定义的宏不可用ifdef 必须改成if defined\n\t\t\t\t\tif(i == 0)\n\t\t\t\t\t{\n\t\t\t\t\t\t#ifdef SHADOW_CASCADE\n\t\t\t\t\t\t\tvec4 shadowCoord = getShadowCoord(vec4(v_PositionWorld,1.0));\n\t\t\t\t\t\t#else\n\t\t\t\t\t\t\tvec4 shadowCoord = v_ShadowCoord;\n\t\t\t\t\t\t#endif\n\t\t\t\t\t\tdirectionLight.color *= sampleShadowmap(shadowCoord);\n\t\t\t\t\t}\n\t\t\t\t#endif\n\t\t\t\tLayaAirBlinnPhongDiectionLight(u_MaterialSpecular,u_Shininess,normal,gloss,viewDir,directionLight,transmissionFactor,dif,spe,transmis);\n\t\t\t\tdiffuse+=dif;\n\t\t\t\tspecular+=spe;\n\t\t\t\ttransmissionDiffuse+=transmis;\n\t\t\t}\n\t\t#endif\n\t\t#if defined(POINTLIGHT)||defined(SPOTLIGHT)\n\t\t\tivec4 clusterInfo =getClusterInfo(u_LightClusterBuffer,u_View,u_Viewport, v_PositionWorld,gl_FragCoord,u_ProjectionParams);\n\t\t\t#ifdef POINTLIGHT\n\t\t\t\tfor (int i = 0; i < MAX_LIGHT_COUNT; i++) \n\t\t\t\t{\n\t\t\t\t\tif(i >= clusterInfo.x)//PointLightCount\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tPointLight pointLight = getPointLight(u_LightBuffer,u_LightClusterBuffer,clusterInfo,i);\n\t\t\t\t\tLayaAirBlinnPhongPointLight(v_PositionWorld,u_MaterialSpecular,u_Shininess,normal,gloss,viewDir,pointLight,transmissionFactor,dif,spe,transmis);\n\t\t\t\t\tdiffuse+=dif;\n\t\t\t\t\tspecular+=spe;\n\t\t\t\t\ttransmissionDiffuse+=transmis;\n\t\t\t\t}\n\t\t\t#endif\n\t\t\t#ifdef SPOTLIGHT\n\t\t\t\tfor (int i = 0; i < MAX_LIGHT_COUNT; i++) \n\t\t\t\t{\n\t\t\t\t\tif(i >= clusterInfo.y)//SpotLightCount\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tSpotLight spotLight = getSpotLight(u_LightBuffer,u_LightClusterBuffer,clusterInfo,i);\n\t\t\t\t\t#if defined(CALCULATE_SPOTSHADOWS)//shader中自定义的宏不可用ifdef 必须改成if defined\n\t\t\t\t\t\tif(i == 0)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tvec4 spotShadowcoord = v_SpotShadowCoord;\n\t\t\t\t\t\t\tspotLight.color *= sampleSpotShadowmap(spotShadowcoord);\n\t\t\t\t\t\t}\n\t\t\t\t\t#endif\n\t\t\t\t\tLayaAirBlinnPhongSpotLight(v_PositionWorld,u_MaterialSpecular,u_Shininess,normal,gloss,viewDir,spotLight,transmissionFactor,dif,spe,transmis);\n\t\t\t\t\tdiffuse+=dif;\n\t\t\t\t\tspecular+=spe;\n\t\t\t\t\ttransmissionDiffuse+=transmis;\n\t\t\t\t}\n\t\t\t#endif\n\t\t#endif\n\t#endif\n\n\tgl_FragColor =vec4(mainColor.rgb*(globalDiffuse + diffuse),mainColor.a);\n\n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n\t\tgl_FragColor.rgb+=specular;\n\t#endif\n\n\t#ifdef ENABLETRANSMISSION\n\t\tgl_FragColor.rgb+= transmissionDiffuse;\n\t#endif\n\n\t  \n\t#ifdef FOG\n\t\tfloat lerpFact=clamp((1.0/gl_FragCoord.w-u_FogStart)/u_FogRange,0.0,1.0);\n\t\tgl_FragColor.rgb=mix(gl_FragColor.rgb,u_FogColor,lerpFact);\n\t#endif\n\n\t//gl_FragColor.rgb =transmissionDiffuse;\n}\n\n',n,"Forward");a.addShaderPass('#include "ShadowCasterVS.glsl"\n\nvoid main()\n{\n\tvec4 positionCS =  shadowCasterVertex();\n\tgl_Position=remapGLPositionZ(positionCS);\n}','#if defined(GL_FRAGMENT_PRECISION_HIGH)// 原来的写法会被我们自己的解析流程处理，而我们的解析是不认内置宏的，导致被删掉，所以改成 if defined 了\n\tprecision highp float;\n\tprecision highp int;\n#else\n\tprecision mediump float;\n\tprecision mediump int;\n#endif\n\n#include "ShadowCasterFS.glsl"\n\nvoid main()\n{\n\tgl_FragColor=shadowCasterFragment();\n}',n,"ShadowCaster");a.addShaderPass(mt,pt,n,"DepthNormal"),e={a_Position:Ne.MESH_POSITION0,a_Color:Ne.MESH_COLOR0},t={u_MvpMatrix:_e.PERIOD_SPRITE,u_Color:_e.PERIOD_MATERIAL},n={s_Cull:_e.RENDER_STATE_CULL,s_Blend:_e.RENDER_STATE_BLEND,s_BlendSrc:_e.RENDER_STATE_BLEND_SRC,s_BlendDst:_e.RENDER_STATE_BLEND_DST,s_DepthTest:_e.RENDER_STATE_DEPTH_TEST,s_DepthWrite:_e.RENDER_STATE_DEPTH_WRITE},i=_e.add("LineShader"),a=new Tn(e,t),i.addSubShader(a),a.addShaderPass('#if defined(GL_FRAGMENT_PRECISION_HIGH)// 原来的写法会被我们自己的解析流程处理，而我们的解析是不认内置宏的，导致被删掉，所以改成 if defined 了\nprecision highp float;\n#else\nprecision mediump float;\n#endif\n\n#include "Lighting.glsl";\n\nattribute vec4 a_Position;\nuniform mat4 u_MvpMatrix;\nuniform vec4 u_Color;\nattribute vec4 a_Color;\nvarying vec4 v_Color;\n\n\nvoid main()\n{\n\tgl_Position = u_MvpMatrix * a_Position;\n\tv_Color=a_Color*u_Color;\n\tgl_Position=remapGLPositionZ(gl_Position);\n}',"#if defined(GL_FRAGMENT_PRECISION_HIGH)// 原来的写法会被我们自己的解析流程处理，而我们的解析是不认内置宏的，导致被删掉，所以改成 if defined 了\nprecision highp float;\n#else\nprecision mediump float;\n#endif\n\nvarying vec4 v_Color;\nuniform vec4 u_Color;\n\nvoid main()\n{\n  gl_FragColor = v_Color * u_Color; \n}\n\n",n),e={a_Position:Ne.MESH_POSITION0,a_Color:Ne.MESH_COLOR0,a_Texcoord0:Ne.MESH_TEXTURECOORDINATE0,a_BoneWeights:Ne.MESH_BLENDWEIGHT0,a_BoneIndices:Ne.MESH_BLENDINDICES0,a_WorldMat:Ne.MESH_WORLDMATRIX_ROW0},t={u_Bones:_e.PERIOD_CUSTOM,u_AlbedoTexture:_e.PERIOD_MATERIAL,u_AlbedoColor:_e.PERIOD_MATERIAL,u_TilingOffset:_e.PERIOD_MATERIAL,u_AlphaTestValue:_e.PERIOD_MATERIAL,u_MvpMatrix:_e.PERIOD_SPRITE,u_ViewProjection:_e.PERIOD_CAMERA,u_SimpleAnimatorTexture:_e.PERIOD_SPRITE,u_SimpleAnimatorParams:_e.PERIOD_SPRITE,u_SimpleAnimatorTextureSize:_e.PERIOD_SPRITE,u_FogStart:_e.PERIOD_SCENE,u_FogRange:_e.PERIOD_SCENE,u_FogColor:_e.PERIOD_SCENE},n={s_Cull:_e.RENDER_STATE_CULL,s_Blend:_e.RENDER_STATE_BLEND,s_BlendSrc:_e.RENDER_STATE_BLEND_SRC,s_BlendDst:_e.RENDER_STATE_BLEND_DST,s_DepthTest:_e.RENDER_STATE_DEPTH_TEST,s_DepthWrite:_e.RENDER_STATE_DEPTH_WRITE},i=_e.add("Unlit",null,null,!0),a=new Tn(e,t),i.addSubShader(a),a.addShaderPass('#if defined(GL_FRAGMENT_PRECISION_HIGH)// 原来的写法会被我们自己的解析流程处理，而我们的解析是不认内置宏的，导致被删掉，所以改成 if defined 了\n\tprecision highp float;\n#else\n\tprecision mediump float;\n#endif\n#include "Lighting.glsl";\n#include "LayaUtile.glsl";\n\nattribute vec4 a_Position;\n\nattribute vec2 a_Texcoord0;\n\n#ifdef GPU_INSTANCE\n\tuniform mat4 u_ViewProjection;\n\tattribute mat4 a_WorldMat;\n#else\n\tuniform mat4 u_MvpMatrix;\n#endif\n\nattribute vec4 a_Color;\nvarying vec4 v_Color;\nvarying vec2 v_Texcoord0;\n\nuniform vec4 u_TilingOffset;\n\n#ifdef BONE\n\tconst int c_MaxBoneCount = 24;\n\tattribute vec4 a_BoneIndices;\n\tattribute vec4 a_BoneWeights;\n\tuniform mat4 u_Bones[c_MaxBoneCount];\n#endif\n\nvoid main() {\n\tvec4 position;\n\t#ifdef BONE\n\t\tmat4 skinTransform;\n\t \t#ifdef SIMPLEBONE\n\t\t\tfloat currentPixelPos;\n\t\t\t#ifdef GPU_INSTANCE\n\t\t\t\tcurrentPixelPos = a_SimpleTextureParams.x+a_SimpleTextureParams.y;\n\t\t\t#else\n\t\t\t\tcurrentPixelPos = u_SimpleAnimatorParams.x+u_SimpleAnimatorParams.y;\n\t\t\t#endif\n\t\t\tfloat offset = 1.0/u_SimpleAnimatorTextureSize;\n\t\t\tskinTransform =  loadMatFromTexture(currentPixelPos,int(a_BoneIndices.x),offset) * a_BoneWeights.x;\n\t\t\tskinTransform += loadMatFromTexture(currentPixelPos,int(a_BoneIndices.y),offset) * a_BoneWeights.y;\n\t\t\tskinTransform += loadMatFromTexture(currentPixelPos,int(a_BoneIndices.z),offset) * a_BoneWeights.z;\n\t\t\tskinTransform += loadMatFromTexture(currentPixelPos,int(a_BoneIndices.w),offset) * a_BoneWeights.w;\n\t\t#else\n\t\t\tskinTransform =  u_Bones[int(a_BoneIndices.x)] * a_BoneWeights.x;\n\t\t\tskinTransform += u_Bones[int(a_BoneIndices.y)] * a_BoneWeights.y;\n\t\t\tskinTransform += u_Bones[int(a_BoneIndices.z)] * a_BoneWeights.z;\n\t\t\tskinTransform += u_Bones[int(a_BoneIndices.w)] * a_BoneWeights.w;\n\t\t#endif\n\t\tposition=skinTransform*a_Position;\n\t #else\n\t\tposition=a_Position;\n\t#endif\n\t#ifdef GPU_INSTANCE\n\t\tgl_Position =u_ViewProjection * a_WorldMat * position;\n\t#else\n\t\tgl_Position = u_MvpMatrix * position;\n\t#endif\n\n\tv_Texcoord0=TransformUV(a_Texcoord0,u_TilingOffset);\n\n\t#if defined(COLOR)&&defined(ENABLEVERTEXCOLOR)\n\t\tv_Color = a_Color;\n\t#endif\n\tgl_Position=remapGLPositionZ(gl_Position);\n}',"#if defined(GL_FRAGMENT_PRECISION_HIGH)// 原来的写法会被我们自己的解析流程处理，而我们的解析是不认内置宏的，导致被删掉，所以改成 if defined 了\n\tprecision highp float;\n#else\n\tprecision mediump float;\n#endif\n\n#if defined(COLOR)&&defined(ENABLEVERTEXCOLOR)\n\tvarying vec4 v_Color;\n#endif\n\n#ifdef ALBEDOTEXTURE\n\tuniform sampler2D u_AlbedoTexture;\n\tvarying vec2 v_Texcoord0;\n#endif\n\nuniform vec4 u_AlbedoColor;\n\n#ifdef ALPHATEST\n\tuniform float u_AlphaTestValue;\n#endif\n\n#ifdef FOG\n\tuniform float u_FogStart;\n\tuniform float u_FogRange;\n\t#ifdef ADDTIVEFOG\n\t#else\n\t\tuniform vec3 u_FogColor;\n\t#endif\n#endif\n\nvoid main()\n{\n\tvec4 color =  u_AlbedoColor;\n\t#ifdef ALBEDOTEXTURE\n\t\tcolor *= texture2D(u_AlbedoTexture, v_Texcoord0);\n\t#endif\n\t#if defined(COLOR)&&defined(ENABLEVERTEXCOLOR)\n\t\tcolor *= v_Color;\n\t#endif\n\t\n\t#ifdef ALPHATEST\n\t\tif(color.a < u_AlphaTestValue)\n\t\t\tdiscard;\n\t#endif\n\t\n\tgl_FragColor = color;\n\t\n\t#ifdef FOG\n\t\tfloat lerpFact = clamp((1.0 / gl_FragCoord.w - u_FogStart) / u_FogRange, 0.0, 1.0);\n\t\t#ifdef ADDTIVEFOG\n\t\t\tgl_FragColor.rgb = mix(gl_FragColor.rgb, vec3(0.0), lerpFact);\n\t\t#else\n\t\t\tgl_FragColor.rgb = mix(gl_FragColor.rgb, u_FogColor, lerpFact);\n\t\t#endif\n\t#endif\n\t\n}\n\n",n),e={a_Position:Ne.MESH_POSITION0,a_Texcoord0:Ne.MESH_TEXTURECOORDINATE0,a_BoneWeights:Ne.MESH_BLENDWEIGHT0,a_BoneIndices:Ne.MESH_BLENDINDICES0,a_WorldMat:Ne.MESH_WORLDMATRIX_ROW0},t={u_Bones:_e.PERIOD_CUSTOM,u_AlbedoTexture:_e.PERIOD_MATERIAL,u_AlbedoColor:_e.PERIOD_MATERIAL,u_TilingOffset:_e.PERIOD_MATERIAL,u_AlphaTestValue:_e.PERIOD_MATERIAL,u_ViewProjection:_e.PERIOD_CAMERA,u_MvpMatrix:_e.PERIOD_SPRITE,u_SimpleAnimatorTexture:_e.PERIOD_SPRITE,u_SimpleAnimatorParams:_e.PERIOD_SPRITE,u_SimpleAnimatorTextureSize:_e.PERIOD_SPRITE,u_FogStart:_e.PERIOD_SCENE,u_FogRange:_e.PERIOD_SCENE,u_FogColor:_e.PERIOD_SCENE},n={s_Cull:_e.RENDER_STATE_CULL,s_Blend:_e.RENDER_STATE_BLEND,s_BlendSrc:_e.RENDER_STATE_BLEND_SRC,s_BlendDst:_e.RENDER_STATE_BLEND_DST,s_DepthTest:_e.RENDER_STATE_DEPTH_TEST,s_DepthWrite:_e.RENDER_STATE_DEPTH_WRITE},i=_e.add("Effect",null,null,!0),a=new Tn(e,t),i.addSubShader(a),a.addShaderPass('#if defined(GL_FRAGMENT_PRECISION_HIGH)// 原来的写法会被我们自己的解析流程处理，而我们的解析是不认内置宏的，导致被删掉，所以改成 if defined 了\n\tprecision highp float;\n#else\n\tprecision mediump float;\n#endif\n#include "Lighting.glsl";\n#include "LayaUtile.glsl";\n\nattribute vec4 a_Position;\nattribute vec4 a_Color;\nattribute vec2 a_Texcoord0;\n\n#ifdef GPU_INSTANCE\n\tuniform mat4 u_ViewProjection;\n\tattribute mat4 a_WorldMat;\n#else\n\tuniform mat4 u_MvpMatrix;\n#endif\n\n#ifdef COLOR\n\tvarying vec4 v_Color;\n#endif\nvarying vec2 v_Texcoord0;\n\nuniform vec4 u_TilingOffset;\n\n#ifdef BONE\n\tconst int c_MaxBoneCount = 24;\n\tattribute vec4 a_BoneIndices;\n\tattribute vec4 a_BoneWeights;\n\tuniform mat4 u_Bones[c_MaxBoneCount];\n#endif\n\n\nvoid main()\n{\n\tvec4 position;\n\t#ifdef BONE\n\t\tmat4 skinTransform;\n\t \t#ifdef SIMPLEBONE\n\t\t\tfloat currentPixelPos;\n\t\t\t#ifdef GPU_INSTANCE\n\t\t\t\tcurrentPixelPos = a_SimpleTextureParams.x+a_SimpleTextureParams.y;\n\t\t\t#else\n\t\t\t\tcurrentPixelPos = u_SimpleAnimatorParams.x+u_SimpleAnimatorParams.y;\n\t\t\t#endif\n\t\t\tfloat offset = 1.0/u_SimpleAnimatorTextureSize;\n\t\t\tskinTransform =  loadMatFromTexture(currentPixelPos,int(a_BoneIndices.x),offset) * a_BoneWeights.x;\n\t\t\tskinTransform += loadMatFromTexture(currentPixelPos,int(a_BoneIndices.y),offset) * a_BoneWeights.y;\n\t\t\tskinTransform += loadMatFromTexture(currentPixelPos,int(a_BoneIndices.z),offset) * a_BoneWeights.z;\n\t\t\tskinTransform += loadMatFromTexture(currentPixelPos,int(a_BoneIndices.w),offset) * a_BoneWeights.w;\n\t\t#else\n\t\t\tskinTransform =  u_Bones[int(a_BoneIndices.x)] * a_BoneWeights.x;\n\t\t\tskinTransform += u_Bones[int(a_BoneIndices.y)] * a_BoneWeights.y;\n\t\t\tskinTransform += u_Bones[int(a_BoneIndices.z)] * a_BoneWeights.z;\n\t\t\tskinTransform += u_Bones[int(a_BoneIndices.w)] * a_BoneWeights.w;\n\t\t#endif\n\t\tposition=skinTransform*a_Position;\n\t #else\n\t\tposition=a_Position;\n\t#endif\n\t#ifdef GPU_INSTANCE\n\t\tgl_Position = u_ViewProjection * a_WorldMat * position;\n\t#else\n\t\tgl_Position = u_MvpMatrix * position;\n\t#endif\n\t\n\tv_Texcoord0=TransformUV(a_Texcoord0,u_TilingOffset);\n\t\t\n\t#ifdef COLOR\n\t\tv_Color = a_Color;\n\t#endif\n\tgl_Position=remapGLPositionZ(gl_Position);\n}',"#if defined(GL_FRAGMENT_PRECISION_HIGH)// 原来的写法会被我们自己的解析流程处理，而我们的解析是不认内置宏的，导致被删掉，所以改成 if defined 了\n\tprecision highp float;\n#else\n\tprecision mediump float;\n#endif\n\n#ifdef COLOR\n\tvarying vec4 v_Color;\n#endif\nvarying vec2 v_Texcoord0;\n\n#ifdef MAINTEXTURE\n\tuniform sampler2D u_AlbedoTexture;\n#endif\n\nuniform vec4 u_AlbedoColor;\n\n#ifdef FOG\n\tuniform float u_FogStart;\n\tuniform float u_FogRange;\n\t#ifdef ADDTIVEFOG\n\t#else\n\t\tuniform vec3 u_FogColor;\n\t#endif\n#endif\n\nvoid main()\n{\n\tvec4 color =  2.0 * u_AlbedoColor;\n\t#ifdef COLOR\n\t\tcolor *= v_Color;\n\t#endif\n\t#ifdef MAINTEXTURE\n\t\tcolor *= texture2D(u_AlbedoTexture, v_Texcoord0);\n\t#endif\n\t\n\tgl_FragColor = color;\n\t\n\t#ifdef FOG\n\t\tfloat lerpFact = clamp((1.0 / gl_FragCoord.w - u_FogStart) / u_FogRange, 0.0, 1.0);\n\t\t#ifdef ADDTIVEFOG\n\t\t\tgl_FragColor.rgb = mix(gl_FragColor.rgb, vec3(0.0), lerpFact);\n\t\t#else\n\t\t\tgl_FragColor.rgb = mix(gl_FragColor.rgb, u_FogColor, lerpFact);\n\t\t#endif\n\t#endif\n}\n\n",n),e={a_CornerTextureCoordinate:ii.PARTICLE_CORNERTEXTURECOORDINATE0,a_MeshPosition:ii.PARTICLE_POSITION0,a_MeshColor:ii.PARTICLE_COLOR0,a_MeshTextureCoordinate:ii.PARTICLE_TEXTURECOORDINATE0,a_ShapePositionStartLifeTime:ii.PARTICLE_SHAPEPOSITIONSTARTLIFETIME,a_DirectionTime:ii.PARTICLE_DIRECTIONTIME,a_StartColor:ii.PARTICLE_STARTCOLOR0,a_EndColor:ii.PARTICLE_ENDCOLOR0,a_StartSize:ii.PARTICLE_STARTSIZE,a_StartRotation0:ii.PARTICLE_STARTROTATION,a_StartSpeed:ii.PARTICLE_STARTSPEED,a_Random0:ii.PARTICLE_RANDOM0,a_Random1:ii.PARTICLE_RANDOM1,a_SimulationWorldPostion:ii.PARTICLE_SIMULATIONWORLDPOSTION,a_SimulationWorldRotation:ii.PARTICLE_SIMULATIONWORLDROTATION},t={u_Tintcolor:_e.PERIOD_MATERIAL,u_TilingOffset:_e.PERIOD_MATERIAL,u_texture:_e.PERIOD_MATERIAL,u_WorldPosition:_e.PERIOD_SPRITE,u_WorldRotation:_e.PERIOD_SPRITE,u_PositionScale:_e.PERIOD_SPRITE,u_SizeScale:_e.PERIOD_SPRITE,u_ScalingMode:_e.PERIOD_SPRITE,u_Gravity:_e.PERIOD_SPRITE,u_ThreeDStartRotation:_e.PERIOD_SPRITE,u_StretchedBillboardLengthScale:_e.PERIOD_SPRITE,u_StretchedBillboardSpeedScale:_e.PERIOD_SPRITE,u_SimulationSpace:_e.PERIOD_SPRITE,u_CurrentTime:_e.PERIOD_SPRITE,u_ColorOverLifeGradientAlphas:_e.PERIOD_SPRITE,u_ColorOverLifeGradientColors:_e.PERIOD_SPRITE,u_MaxColorOverLifeGradientAlphas:_e.PERIOD_SPRITE,u_MaxColorOverLifeGradientColors:_e.PERIOD_SPRITE,u_VOLVelocityConst:_e.PERIOD_SPRITE,u_VOLVelocityGradientX:_e.PERIOD_SPRITE,u_VOLVelocityGradientY:_e.PERIOD_SPRITE,u_VOLVelocityGradientZ:_e.PERIOD_SPRITE,u_VOLVelocityConstMax:_e.PERIOD_SPRITE,u_VOLVelocityGradientMaxX:_e.PERIOD_SPRITE,u_VOLVelocityGradientMaxY:_e.PERIOD_SPRITE,u_VOLVelocityGradientMaxZ:_e.PERIOD_SPRITE,u_VOLSpaceType:_e.PERIOD_SPRITE,u_SOLSizeGradient:_e.PERIOD_SPRITE,u_SOLSizeGradientX:_e.PERIOD_SPRITE,u_SOLSizeGradientY:_e.PERIOD_SPRITE,u_SOLSizeGradientZ:_e.PERIOD_SPRITE,u_SOLSizeGradientMax:_e.PERIOD_SPRITE,u_SOLSizeGradientMaxX:_e.PERIOD_SPRITE,u_SOLSizeGradientMaxY:_e.PERIOD_SPRITE,u_SOLSizeGradientMaxZ:_e.PERIOD_SPRITE,u_ROLAngularVelocityConst:_e.PERIOD_SPRITE,u_ROLAngularVelocityConstSeprarate:_e.PERIOD_SPRITE,u_ROLAngularVelocityGradient:_e.PERIOD_SPRITE,u_ROLAngularVelocityGradientX:_e.PERIOD_SPRITE,u_ROLAngularVelocityGradientY:_e.PERIOD_SPRITE,u_ROLAngularVelocityGradientZ:_e.PERIOD_SPRITE,u_ROLAngularVelocityConstMax:_e.PERIOD_SPRITE,u_ROLAngularVelocityConstMaxSeprarate:_e.PERIOD_SPRITE,u_ROLAngularVelocityGradientMax:_e.PERIOD_SPRITE,u_ROLAngularVelocityGradientMaxX:_e.PERIOD_SPRITE,u_ROLAngularVelocityGradientMaxY:_e.PERIOD_SPRITE,u_ROLAngularVelocityGradientMaxZ:_e.PERIOD_SPRITE,u_ROLAngularVelocityGradientMaxW:_e.PERIOD_SPRITE,u_TSACycles:_e.PERIOD_SPRITE,u_TSASubUVLength:_e.PERIOD_SPRITE,u_TSAGradientUVs:_e.PERIOD_SPRITE,u_TSAMaxGradientUVs:_e.PERIOD_SPRITE,u_CameraPos:_e.PERIOD_CAMERA,u_CameraDirection:_e.PERIOD_CAMERA,u_CameraUp:_e.PERIOD_CAMERA,u_View:_e.PERIOD_CAMERA,u_Projection:_e.PERIOD_CAMERA,u_FogStart:_e.PERIOD_SCENE,u_FogRange:_e.PERIOD_SCENE,u_FogColor:_e.PERIOD_SCENE},n={s_Cull:_e.RENDER_STATE_CULL,s_Blend:_e.RENDER_STATE_BLEND,s_BlendSrc:_e.RENDER_STATE_BLEND_SRC,s_BlendDst:_e.RENDER_STATE_BLEND_DST,s_DepthTest:_e.RENDER_STATE_DEPTH_TEST,s_DepthWrite:_e.RENDER_STATE_DEPTH_WRITE},i=_e.add("PARTICLESHURIKEN"),a=new Tn(e,t),i.addSubShader(a),a.addShaderPass('// #include "Lighting.glsl";\n\n//修改这里剔除没有用到的光照函数，增加粒子的编译速度\nvec2 TransformUV(vec2 texcoord,vec4 tilingOffset) {\n\tvec2 transTexcoord=vec2(texcoord.x,texcoord.y-1.0)*tilingOffset.xy+vec2(tilingOffset.z,-tilingOffset.w);\n\ttransTexcoord.y+=1.0;\n\treturn transTexcoord;\n}\n\nvec4 remapGLPositionZ(vec4 position) {\n\tposition.z=position.z * 2.0 - position.w;\n\treturn position;\n}\n\n#if defined(GL_FRAGMENT_PRECISION_HIGH)\n  precision highp float;\n#else\n  precision mediump float;\n#endif\n\n#if defined(SPHERHBILLBOARD)||defined(STRETCHEDBILLBOARD)||defined(HORIZONTALBILLBOARD)||defined(VERTICALBILLBOARD)\n\tattribute vec4 a_CornerTextureCoordinate;\n#endif\n#ifdef RENDERMODE_MESH\n\tattribute vec3 a_MeshPosition;\n\tattribute vec4 a_MeshColor;\n\tattribute vec2 a_MeshTextureCoordinate;\n\tvarying vec4 v_MeshColor;\n#endif\n\nattribute vec4 a_ShapePositionStartLifeTime;\nattribute vec4 a_DirectionTime;\nattribute vec4 a_StartColor;\nattribute vec3 a_StartSize;\nattribute vec3 a_StartRotation0;\nattribute float a_StartSpeed;\n#if defined(COLOROVERLIFETIME)||defined(RANDOMCOLOROVERLIFETIME)||defined(SIZEOVERLIFETIMERANDOMCURVES)||defined(SIZEOVERLIFETIMERANDOMCURVESSEPERATE)||defined(ROTATIONOVERLIFETIMERANDOMCONSTANTS)||defined(ROTATIONOVERLIFETIMERANDOMCURVES)\n  attribute vec4 a_Random0;\n#endif\n#if defined(TEXTURESHEETANIMATIONRANDOMCURVE)||defined(VELOCITYOVERLIFETIMERANDOMCONSTANT)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)\n  attribute vec4 a_Random1;\n#endif\nattribute vec3 a_SimulationWorldPostion;\nattribute vec4 a_SimulationWorldRotation;\n\nvarying vec4 v_Color;\n#ifdef DIFFUSEMAP\n\tvarying vec2 v_TextureCoordinate;\n#endif\n\nuniform float u_CurrentTime;\nuniform vec3 u_Gravity;\n\nuniform vec3 u_WorldPosition;\nuniform vec4 u_WorldRotation;\nuniform bool u_ThreeDStartRotation;\nuniform int u_ScalingMode;\nuniform vec3 u_PositionScale;\nuniform vec3 u_SizeScale;\nuniform mat4 u_View;\nuniform mat4 u_Projection;\n\n#ifdef STRETCHEDBILLBOARD\n\tuniform vec3 u_CameraPos;\n#endif\nuniform vec3 u_CameraDirection;//TODO:只有几种广告牌模式需要用\nuniform vec3 u_CameraUp;\n\nuniform  float u_StretchedBillboardLengthScale;\nuniform  float u_StretchedBillboardSpeedScale;\nuniform int u_SimulationSpace;\n\n#if defined(VELOCITYOVERLIFETIMECONSTANT)||defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCONSTANT)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)\n  uniform  int  u_VOLSpaceType;\n#endif\n#if defined(VELOCITYOVERLIFETIMECONSTANT)||defined(VELOCITYOVERLIFETIMERANDOMCONSTANT)\n  uniform  vec3 u_VOLVelocityConst;\n#endif\n#if defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)\n  uniform  vec2 u_VOLVelocityGradientX[4];//x为key,y为速度\n  uniform  vec2 u_VOLVelocityGradientY[4];//x为key,y为速度\n  uniform  vec2 u_VOLVelocityGradientZ[4];//x为key,y为速度\n#endif\n#ifdef VELOCITYOVERLIFETIMERANDOMCONSTANT\n  uniform  vec3 u_VOLVelocityConstMax;\n#endif\n#ifdef VELOCITYOVERLIFETIMERANDOMCURVE\n  uniform  vec2 u_VOLVelocityGradientMaxX[4];//x为key,y为速度\n  uniform  vec2 u_VOLVelocityGradientMaxY[4];//x为key,y为速度\n  uniform  vec2 u_VOLVelocityGradientMaxZ[4];//x为key,y为速度\n#endif\n\n#ifdef COLOROVERLIFETIME\n  uniform  vec4 u_ColorOverLifeGradientColors[4];//x为key,yzw为Color\n  uniform  vec2 u_ColorOverLifeGradientAlphas[4];//x为key,y为Alpha\n#endif\n#ifdef RANDOMCOLOROVERLIFETIME\n  uniform  vec4 u_ColorOverLifeGradientColors[4];//x为key,yzw为Color\n  uniform  vec2 u_ColorOverLifeGradientAlphas[4];//x为key,y为Alpha\n  uniform  vec4 u_MaxColorOverLifeGradientColors[4];//x为key,yzw为Color\n  uniform  vec2 u_MaxColorOverLifeGradientAlphas[4];//x为key,y为Alpha\n#endif\n\n\n#if defined(SIZEOVERLIFETIMECURVE)||defined(SIZEOVERLIFETIMERANDOMCURVES)\n  uniform  vec2 u_SOLSizeGradient[4];//x为key,y为尺寸\n#endif\n#ifdef SIZEOVERLIFETIMERANDOMCURVES\n  uniform  vec2 u_SOLSizeGradientMax[4];//x为key,y为尺寸\n#endif\n#if defined(SIZEOVERLIFETIMECURVESEPERATE)||defined(SIZEOVERLIFETIMERANDOMCURVESSEPERATE)\n  uniform  vec2 u_SOLSizeGradientX[4];//x为key,y为尺寸\n  uniform  vec2 u_SOLSizeGradientY[4];//x为key,y为尺寸\n  uniform  vec2 u_SOLSizeGradientZ[4];//x为key,y为尺寸\n#endif\n#ifdef SIZEOVERLIFETIMERANDOMCURVESSEPERATE\n  uniform  vec2 u_SOLSizeGradientMaxX[4];//x为key,y为尺寸\n  uniform  vec2 u_SOLSizeGradientMaxY[4];//x为key,y为尺寸\n  uniform  vec2 u_SOLSizeGradientMaxZ[4];//x为key,y为尺寸\n#endif\n\n\n#ifdef ROTATIONOVERLIFETIME\n  #if defined(ROTATIONOVERLIFETIMECONSTANT)||defined(ROTATIONOVERLIFETIMERANDOMCONSTANTS)\n    uniform  float u_ROLAngularVelocityConst;\n  #endif\n  #ifdef ROTATIONOVERLIFETIMERANDOMCONSTANTS\n    uniform  float u_ROLAngularVelocityConstMax;\n  #endif\n  #if defined(ROTATIONOVERLIFETIMECURVE)||defined(ROTATIONOVERLIFETIMERANDOMCURVES)\n    uniform  vec2 u_ROLAngularVelocityGradient[4];//x为key,y为旋转\n  #endif\n  #ifdef ROTATIONOVERLIFETIMERANDOMCURVES\n    uniform  vec2 u_ROLAngularVelocityGradientMax[4];//x为key,y为旋转\n  #endif\n#endif\n#ifdef ROTATIONOVERLIFETIMESEPERATE\n  #if defined(ROTATIONOVERLIFETIMECONSTANT)||defined(ROTATIONOVERLIFETIMERANDOMCONSTANTS)\n    uniform  vec3 u_ROLAngularVelocityConstSeprarate;\n  #endif\n  #ifdef ROTATIONOVERLIFETIMERANDOMCONSTANTS\n    uniform  vec3 u_ROLAngularVelocityConstMaxSeprarate;\n  #endif\n  #if defined(ROTATIONOVERLIFETIMECURVE)||defined(ROTATIONOVERLIFETIMERANDOMCURVES)\n    uniform  vec2 u_ROLAngularVelocityGradientX[4];\n    uniform  vec2 u_ROLAngularVelocityGradientY[4];\n    uniform  vec2 u_ROLAngularVelocityGradientZ[4];\n  #endif\n  #ifdef ROTATIONOVERLIFETIMERANDOMCURVES\n    uniform  vec2 u_ROLAngularVelocityGradientMaxX[4];\n    uniform  vec2 u_ROLAngularVelocityGradientMaxY[4];\n    uniform  vec2 u_ROLAngularVelocityGradientMaxZ[4];\n\tuniform  vec2 u_ROLAngularVelocityGradientMaxW[4];\n  #endif\n#endif\n\n#if defined(TEXTURESHEETANIMATIONCURVE)||defined(TEXTURESHEETANIMATIONRANDOMCURVE)\n  uniform  float u_TSACycles;\n  uniform  vec2 u_TSASubUVLength;\n  uniform  vec2 u_TSAGradientUVs[4];//x为key,y为frame\n#endif\n#ifdef TEXTURESHEETANIMATIONRANDOMCURVE\n  uniform  vec2 u_TSAMaxGradientUVs[4];//x为key,y为frame\n#endif\n\nuniform vec4 u_TilingOffset;\n\nvec3 rotationByEuler(in vec3 vector,in vec3 rot)\n{\n\tfloat halfRoll = rot.z * 0.5;\n    float halfPitch = rot.x * 0.5;\n\tfloat halfYaw = rot.y * 0.5;\n\n\tfloat sinRoll = sin(halfRoll);\n\tfloat cosRoll = cos(halfRoll);\n\tfloat sinPitch = sin(halfPitch);\n\tfloat cosPitch = cos(halfPitch);\n\tfloat sinYaw = sin(halfYaw);\n\tfloat cosYaw = cos(halfYaw);\n\n\tfloat quaX = (cosYaw * sinPitch * cosRoll) + (sinYaw * cosPitch * sinRoll);\n\tfloat quaY = (sinYaw * cosPitch * cosRoll) - (cosYaw * sinPitch * sinRoll);\n\tfloat quaZ = (cosYaw * cosPitch * sinRoll) - (sinYaw * sinPitch * cosRoll);\n\tfloat quaW = (cosYaw * cosPitch * cosRoll) + (sinYaw * sinPitch * sinRoll);\n\t\n\t//vec4 q=vec4(quaX,quaY,quaZ,quaW);\n\t//vec3 temp = cross(q.xyz, vector) + q.w * vector;\n\t//return (cross(temp, -q.xyz) + dot(q.xyz,vector) * q.xyz + q.w * temp);\n\t\n\tfloat x = quaX + quaX;\n    float y = quaY + quaY;\n    float z = quaZ + quaZ;\n    float wx = quaW * x;\n    float wy = quaW * y;\n    float wz = quaW * z;\n\tfloat xx = quaX * x;\n    float xy = quaX * y;\n\tfloat xz = quaX * z;\n    float yy = quaY * y;\n    float yz = quaY * z;\n    float zz = quaZ * z;\n\n    return vec3(((vector.x * ((1.0 - yy) - zz)) + (vector.y * (xy - wz))) + (vector.z * (xz + wy)),\n                ((vector.x * (xy + wz)) + (vector.y * ((1.0 - xx) - zz))) + (vector.z * (yz - wx)),\n                ((vector.x * (xz - wy)) + (vector.y * (yz + wx))) + (vector.z * ((1.0 - xx) - yy)));\n\t\n}\n\n//假定axis已经归一化\nvec3 rotationByAxis(in vec3 vector,in vec3 axis, in float angle)\n{\n\tfloat halfAngle = angle * 0.5;\n\tfloat sin = sin(halfAngle);\n\t\n\tfloat quaX = axis.x * sin;\n\tfloat quaY = axis.y * sin;\n\tfloat quaZ = axis.z * sin;\n\tfloat quaW = cos(halfAngle);\n\t\n\t//vec4 q=vec4(quaX,quaY,quaZ,quaW);\n\t//vec3 temp = cross(q.xyz, vector) + q.w * vector;\n\t//return (cross(temp, -q.xyz) + dot(q.xyz,vector) * q.xyz + q.w * temp);\n\t\n\tfloat x = quaX + quaX;\n    float y = quaY + quaY;\n    float z = quaZ + quaZ;\n    float wx = quaW * x;\n    float wy = quaW * y;\n    float wz = quaW * z;\n\tfloat xx = quaX * x;\n    float xy = quaX * y;\n\tfloat xz = quaX * z;\n    float yy = quaY * y;\n    float yz = quaY * z;\n    float zz = quaZ * z;\n\n    return vec3(((vector.x * ((1.0 - yy) - zz)) + (vector.y * (xy - wz))) + (vector.z * (xz + wy)),\n                ((vector.x * (xy + wz)) + (vector.y * ((1.0 - xx) - zz))) + (vector.z * (yz - wx)),\n                ((vector.x * (xz - wy)) + (vector.y * (yz + wx))) + (vector.z * ((1.0 - xx) - yy)));\n\t\n}\n\nvec3 rotationByQuaternions(in vec3 v,in vec4 q) \n{\n\treturn v + 2.0 * cross(q.xyz, cross(q.xyz, v) + q.w * v);\n}\n\n \n#if defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)||defined(SIZEOVERLIFETIMECURVE)||defined(SIZEOVERLIFETIMECURVESEPERATE)||defined(SIZEOVERLIFETIMERANDOMCURVES)||defined(SIZEOVERLIFETIMERANDOMCURVESSEPERATE)\nfloat getCurValueFromGradientFloat(in vec2 gradientNumbers[4],in float normalizedAge)\n{\n\tfloat curValue;\n\tfor(int i=1;i<4;i++)\n\t{\n\t\tvec2 gradientNumber=gradientNumbers[i];\n\t\tfloat key=gradientNumber.x;\n\t\tif(key>=normalizedAge)\n\t\t{\n\t\t\tvec2 lastGradientNumber=gradientNumbers[i-1];\n\t\t\tfloat lastKey=lastGradientNumber.x;\n\t\t\tfloat age=(normalizedAge-lastKey)/(key-lastKey);\n\t\t\tcurValue=mix(lastGradientNumber.y,gradientNumber.y,age);\n\t\t\tbreak;\n\t\t}\n\t}\n\treturn curValue;\n}\n#endif\n\n#if defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)||defined(ROTATIONOVERLIFETIMECURVE)||defined(ROTATIONOVERLIFETIMERANDOMCURVES)\nfloat getTotalValueFromGradientFloat(in vec2 gradientNumbers[4],in float normalizedAge)\n{\n\tfloat totalValue=0.0;\n\tfor(int i=1;i<4;i++)\n\t{\n\t\tvec2 gradientNumber=gradientNumbers[i];\n\t\tfloat key=gradientNumber.x;\n\t\tvec2 lastGradientNumber=gradientNumbers[i-1];\n\t\tfloat lastValue=lastGradientNumber.y;\n\t\t\n\t\tif(key>=normalizedAge){\n\t\t\tfloat lastKey=lastGradientNumber.x;\n\t\t\tfloat age=(normalizedAge-lastKey)/(key-lastKey);\n\t\t\ttotalValue+=(lastValue+mix(lastValue,gradientNumber.y,age))/2.0*a_ShapePositionStartLifeTime.w*(normalizedAge-lastKey);\n\t\t\tbreak;\n\t\t}\n\t\telse{\n\t\t\ttotalValue+=(lastValue+gradientNumber.y)/2.0*a_ShapePositionStartLifeTime.w*(key-lastGradientNumber.x);\n\t\t}\n\t}\n\treturn totalValue;\n}\n#endif\n\n#if defined(COLOROVERLIFETIME)||defined(RANDOMCOLOROVERLIFETIME)\nvec4 getColorFromGradient(in vec2 gradientAlphas[4],in vec4 gradientColors[4],in float normalizedAge)\n{\n\tvec4 overTimeColor;\n\tfor(int i=1;i<4;i++)\n\t{\n\t\tvec2 gradientAlpha=gradientAlphas[i];\n\t\tfloat alphaKey=gradientAlpha.x;\n\t\tif(alphaKey>=normalizedAge)\n\t\t{\n\t\t\tvec2 lastGradientAlpha=gradientAlphas[i-1];\n\t\t\tfloat lastAlphaKey=lastGradientAlpha.x;\n\t\t\tfloat age=(normalizedAge-lastAlphaKey)/(alphaKey-lastAlphaKey);\n\t\t\toverTimeColor.a=mix(lastGradientAlpha.y,gradientAlpha.y,age);\n\t\t\tbreak;\n\t\t}\n\t}\n\t\n\tfor(int i=1;i<4;i++)\n\t{\n\t\tvec4 gradientColor=gradientColors[i];\n\t\tfloat colorKey=gradientColor.x;\n\t\tif(colorKey>=normalizedAge)\n\t\t{\n\t\t\tvec4 lastGradientColor=gradientColors[i-1];\n\t\t\tfloat lastColorKey=lastGradientColor.x;\n\t\t\tfloat age=(normalizedAge-lastColorKey)/(colorKey-lastColorKey);\n\t\t\toverTimeColor.rgb=mix(gradientColors[i-1].yzw,gradientColor.yzw,age);\n\t\t\tbreak;\n\t\t}\n\t}\n\treturn overTimeColor;\n}\n#endif\n\n\n#if defined(TEXTURESHEETANIMATIONCURVE)||defined(TEXTURESHEETANIMATIONRANDOMCURVE)\nfloat getFrameFromGradient(in vec2 gradientFrames[4],in float normalizedAge)\n{\n\tfloat overTimeFrame;\n\tfor(int i=1;i<4;i++)\n\t{\n\t\tvec2 gradientFrame=gradientFrames[i];\n\t\tfloat key=gradientFrame.x;\n\t\tif(key>=normalizedAge)\n\t\t{\n\t\t\tvec2 lastGradientFrame=gradientFrames[i-1];\n\t\t\tfloat lastKey=lastGradientFrame.x;\n\t\t\tfloat age=(normalizedAge-lastKey)/(key-lastKey);\n\t\t\toverTimeFrame=mix(lastGradientFrame.y,gradientFrame.y,age);\n\t\t\tbreak;\n\t\t}\n\t}\n\treturn floor(overTimeFrame);\n}\n#endif\n\n#if defined(VELOCITYOVERLIFETIMECONSTANT)||defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCONSTANT)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)\nvec3 computeParticleLifeVelocity(in float normalizedAge)\n{\n  vec3 outLifeVelocity;\n  #ifdef VELOCITYOVERLIFETIMECONSTANT\n\t outLifeVelocity=u_VOLVelocityConst; \n  #endif\n  #ifdef VELOCITYOVERLIFETIMECURVE\n     outLifeVelocity= vec3(getCurValueFromGradientFloat(u_VOLVelocityGradientX,normalizedAge),getCurValueFromGradientFloat(u_VOLVelocityGradientY,normalizedAge),getCurValueFromGradientFloat(u_VOLVelocityGradientZ,normalizedAge));\n  #endif\n  #ifdef VELOCITYOVERLIFETIMERANDOMCONSTANT\n\t outLifeVelocity=mix(u_VOLVelocityConst,u_VOLVelocityConstMax,vec3(a_Random1.y,a_Random1.z,a_Random1.w)); \n  #endif\n  #ifdef VELOCITYOVERLIFETIMERANDOMCURVE\n     outLifeVelocity=vec3(mix(getCurValueFromGradientFloat(u_VOLVelocityGradientX,normalizedAge),getCurValueFromGradientFloat(u_VOLVelocityGradientMaxX,normalizedAge),a_Random1.y),\n\t                 mix(getCurValueFromGradientFloat(u_VOLVelocityGradientY,normalizedAge),getCurValueFromGradientFloat(u_VOLVelocityGradientMaxY,normalizedAge),a_Random1.z),\n\t\t\t\t\t mix(getCurValueFromGradientFloat(u_VOLVelocityGradientZ,normalizedAge),getCurValueFromGradientFloat(u_VOLVelocityGradientMaxZ,normalizedAge),a_Random1.w));\n  #endif\n\t\t\t\t\t\n  return outLifeVelocity;\n} \n#endif\n\nvec3 computeParticlePosition(in vec3 startVelocity, in vec3 lifeVelocity,in float age,in float normalizedAge,vec3 gravityVelocity,vec4 worldRotation)\n{\n   vec3 startPosition;\n   vec3 lifePosition;\n   #if defined(VELOCITYOVERLIFETIMECONSTANT)||defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCONSTANT)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)\n\t#ifdef VELOCITYOVERLIFETIMECONSTANT\n\t\t  startPosition=startVelocity*age;\n\t\t  lifePosition=lifeVelocity*age;\n\t#endif\n\t#ifdef VELOCITYOVERLIFETIMECURVE\n\t\t  startPosition=startVelocity*age;\n\t\t  lifePosition=vec3(getTotalValueFromGradientFloat(u_VOLVelocityGradientX,normalizedAge),getTotalValueFromGradientFloat(u_VOLVelocityGradientY,normalizedAge),getTotalValueFromGradientFloat(u_VOLVelocityGradientZ,normalizedAge));\n\t#endif\n\t#ifdef VELOCITYOVERLIFETIMERANDOMCONSTANT\n\t\t  startPosition=startVelocity*age;\n\t\t  lifePosition=lifeVelocity*age;\n\t#endif\n\t#ifdef VELOCITYOVERLIFETIMERANDOMCURVE\n\t\t  startPosition=startVelocity*age;\n\t\t  lifePosition=vec3(mix(getTotalValueFromGradientFloat(u_VOLVelocityGradientX,normalizedAge),getTotalValueFromGradientFloat(u_VOLVelocityGradientMaxX,normalizedAge),a_Random1.y)\n\t      ,mix(getTotalValueFromGradientFloat(u_VOLVelocityGradientY,normalizedAge),getTotalValueFromGradientFloat(u_VOLVelocityGradientMaxY,normalizedAge),a_Random1.z)\n\t      ,mix(getTotalValueFromGradientFloat(u_VOLVelocityGradientZ,normalizedAge),getTotalValueFromGradientFloat(u_VOLVelocityGradientMaxZ,normalizedAge),a_Random1.w));\n\t#endif\n\t\n\tvec3 finalPosition;\n\tif(u_VOLSpaceType==0){\n\t  if(u_ScalingMode!=2)\n\t   finalPosition =rotationByQuaternions(u_PositionScale*(a_ShapePositionStartLifeTime.xyz+startPosition+lifePosition),worldRotation);\n\t  else\n\t   finalPosition =rotationByQuaternions(u_PositionScale*a_ShapePositionStartLifeTime.xyz+startPosition+lifePosition,worldRotation);\n\t}\n\telse{\n\t  if(u_ScalingMode!=2)\n\t    finalPosition = rotationByQuaternions(u_PositionScale*(a_ShapePositionStartLifeTime.xyz+startPosition),worldRotation)+lifePosition;\n\t  else\n\t    finalPosition = rotationByQuaternions(u_PositionScale*a_ShapePositionStartLifeTime.xyz+startPosition,worldRotation)+lifePosition;\n\t}\n  #else\n\t startPosition=startVelocity*age;\n\t vec3 finalPosition;\n\t if(u_ScalingMode!=2)\n\t\t\tfinalPosition = rotationByQuaternions(u_PositionScale*(a_ShapePositionStartLifeTime.xyz+startPosition),worldRotation);\n\t else\n\t   \tfinalPosition = rotationByQuaternions(u_PositionScale*a_ShapePositionStartLifeTime.xyz+startPosition,worldRotation);\n  #endif\n  \n  if(u_SimulationSpace==0)\n    finalPosition=finalPosition+a_SimulationWorldPostion;\n  else if(u_SimulationSpace==1) \n    finalPosition=finalPosition+u_WorldPosition;\n  \n  finalPosition+=0.5*gravityVelocity*age;\n \n  return  finalPosition;\n}\n\n\nvec4 computeParticleColor(in vec4 color,in float normalizedAge)\n{\n\t#ifdef COLOROVERLIFETIME\n\t  color*=getColorFromGradient(u_ColorOverLifeGradientAlphas,u_ColorOverLifeGradientColors,normalizedAge);\n\t#endif\n\t\n\t#ifdef RANDOMCOLOROVERLIFETIME\n\t  color*=mix(getColorFromGradient(u_ColorOverLifeGradientAlphas,u_ColorOverLifeGradientColors,normalizedAge),getColorFromGradient(u_MaxColorOverLifeGradientAlphas,u_MaxColorOverLifeGradientColors,normalizedAge),a_Random0.y);\n\t#endif\n\n    return color;\n}\n\nvec2 computeParticleSizeBillbard(in vec2 size,in float normalizedAge)\n{\n\t#ifdef SIZEOVERLIFETIMECURVE\n\t\tsize*=getCurValueFromGradientFloat(u_SOLSizeGradient,normalizedAge);\n\t#endif\n\t#ifdef SIZEOVERLIFETIMERANDOMCURVES\n\t    size*=mix(getCurValueFromGradientFloat(u_SOLSizeGradient,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientMax,normalizedAge),a_Random0.z); \n\t#endif\n\t#ifdef SIZEOVERLIFETIMECURVESEPERATE\n\t\tsize*=vec2(getCurValueFromGradientFloat(u_SOLSizeGradientX,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientY,normalizedAge));\n\t#endif\n\t#ifdef SIZEOVERLIFETIMERANDOMCURVESSEPERATE\n\t    size*=vec2(mix(getCurValueFromGradientFloat(u_SOLSizeGradientX,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientMaxX,normalizedAge),a_Random0.z)\n\t    ,mix(getCurValueFromGradientFloat(u_SOLSizeGradientY,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientMaxY,normalizedAge),a_Random0.z));\n\t#endif\n\treturn size;\n}\n\n#ifdef RENDERMODE_MESH\nvec3 computeParticleSizeMesh(in vec3 size,in float normalizedAge)\n{\n\t#ifdef SIZEOVERLIFETIMECURVE\n\t\tsize*=getCurValueFromGradientFloat(u_SOLSizeGradient,normalizedAge);\n\t#endif\n\t#ifdef SIZEOVERLIFETIMERANDOMCURVES\n\t    size*=mix(getCurValueFromGradientFloat(u_SOLSizeGradient,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientMax,normalizedAge),a_Random0.z); \n\t#endif\n\t#ifdef SIZEOVERLIFETIMECURVESEPERATE\n\t\tsize*=vec3(getCurValueFromGradientFloat(u_SOLSizeGradientX,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientY,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientZ,normalizedAge));\n\t#endif\n\t#ifdef SIZEOVERLIFETIMERANDOMCURVESSEPERATE\n\t    size*=vec3(mix(getCurValueFromGradientFloat(u_SOLSizeGradientX,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientMaxX,normalizedAge),a_Random0.z)\n\t    ,mix(getCurValueFromGradientFloat(u_SOLSizeGradientY,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientMaxY,normalizedAge),a_Random0.z)\n\t\t,mix(getCurValueFromGradientFloat(u_SOLSizeGradientZ,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientMaxZ,normalizedAge),a_Random0.z));\n\t#endif\n\treturn size;\n}\n#endif\n\nfloat computeParticleRotationFloat(in float rotation,in float age,in float normalizedAge)\n{ \n\t#ifdef ROTATIONOVERLIFETIME\n\t\t#ifdef ROTATIONOVERLIFETIMECONSTANT\n\t\t\tfloat ageRot=u_ROLAngularVelocityConst*age;\n\t        rotation+=ageRot;\n\t\t#endif\n\t\t#ifdef ROTATIONOVERLIFETIMECURVE\n\t\t\trotation+=getTotalValueFromGradientFloat(u_ROLAngularVelocityGradient,normalizedAge);\n\t\t#endif\n\t\t#ifdef ROTATIONOVERLIFETIMERANDOMCONSTANTS\n\t\t\tfloat ageRot=mix(u_ROLAngularVelocityConst,u_ROLAngularVelocityConstMax,a_Random0.w)*age;\n\t        rotation+=ageRot;\n\t    #endif\n\t\t#ifdef ROTATIONOVERLIFETIMERANDOMCURVES\n\t\t\trotation+=mix(getTotalValueFromGradientFloat(u_ROLAngularVelocityGradient,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientMax,normalizedAge),a_Random0.w);\n\t\t#endif\n\t#endif\n\t#ifdef ROTATIONOVERLIFETIMESEPERATE\n\t\t#ifdef ROTATIONOVERLIFETIMECONSTANT\n\t\t\tfloat ageRot=u_ROLAngularVelocityConstSeprarate.z*age;\n\t        rotation+=ageRot;\n\t\t#endif\n\t\t#ifdef ROTATIONOVERLIFETIMECURVE\n\t\t\trotation+=getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientZ,normalizedAge);\n\t\t#endif\n\t\t#ifdef ROTATIONOVERLIFETIMERANDOMCONSTANTS\n\t\t\tfloat ageRot=mix(u_ROLAngularVelocityConstSeprarate.z,u_ROLAngularVelocityConstMaxSeprarate.z,a_Random0.w)*age;\n\t        rotation+=ageRot;\n\t    #endif\n\t\t#ifdef ROTATIONOVERLIFETIMERANDOMCURVES\n\t\t\trotation+=mix(getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientZ,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientMaxZ,normalizedAge),a_Random0.w));\n\t\t#endif\n\t#endif\n\treturn rotation;\n}\n\n#if defined(RENDERMODE_MESH)&&(defined(ROTATIONOVERLIFETIME)||defined(ROTATIONOVERLIFETIMESEPERATE))\nvec3 computeParticleRotationVec3(in vec3 rotation,in float age,in float normalizedAge)\n{ \n\t#ifdef ROTATIONOVERLIFETIME\n\t#ifdef ROTATIONOVERLIFETIMECONSTANT\n\t\t\tfloat ageRot=u_ROLAngularVelocityConst*age;\n\t        rotation+=ageRot;\n\t\t#endif\n\t\t#ifdef ROTATIONOVERLIFETIMECURVE\n\t\t\trotation+=getTotalValueFromGradientFloat(u_ROLAngularVelocityGradient,normalizedAge);\n\t\t#endif\n\t\t#ifdef ROTATIONOVERLIFETIMERANDOMCONSTANTS\n\t\t\tfloat ageRot=mix(u_ROLAngularVelocityConst,u_ROLAngularVelocityConstMax,a_Random0.w)*age;\n\t        rotation+=ageRot;\n\t    #endif\n\t\t#ifdef ROTATIONOVERLIFETIMERANDOMCURVES\n\t\t\trotation+=mix(getTotalValueFromGradientFloat(u_ROLAngularVelocityGradient,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientMax,normalizedAge),a_Random0.w);\n\t\t#endif\n\t#endif\n\t#ifdef ROTATIONOVERLIFETIMESEPERATE\n\t\t#ifdef ROTATIONOVERLIFETIMECONSTANT\n\t\t\tvec3 ageRot=u_ROLAngularVelocityConstSeprarate*age;\n\t        rotation+=ageRot;\n\t\t#endif\n\t\t#ifdef ROTATIONOVERLIFETIMECURVE\n\t\t\trotation+=vec3(getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientX,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientY,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientZ,normalizedAge));\n\t\t#endif\n\t\t#ifdef ROTATIONOVERLIFETIMERANDOMCONSTANTS\n\t\t\tvec3 ageRot=mix(u_ROLAngularVelocityConstSeprarate,u_ROLAngularVelocityConstMaxSeprarate,a_Random0.w)*age;\n\t        rotation+=ageRot;\n\t    #endif\n\t\t#ifdef ROTATIONOVERLIFETIMERANDOMCURVES\n\t\t\trotation+=vec3(mix(getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientX,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientMaxX,normalizedAge),a_Random0.w)\n\t        ,mix(getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientY,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientMaxY,normalizedAge),a_Random0.w)\n\t        ,mix(getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientZ,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientMaxZ,normalizedAge),a_Random0.w));\n\t\t#endif\n\t#endif\n\treturn rotation;\n}\n#endif\n\nvec2 computeParticleUV(in vec2 uv,in float normalizedAge)\n{ \n\t#ifdef TEXTURESHEETANIMATIONCURVE\n\t\tfloat cycleNormalizedAge=normalizedAge*u_TSACycles;\n\t\tfloat frame=getFrameFromGradient(u_TSAGradientUVs,cycleNormalizedAge-floor(cycleNormalizedAge));\n\t\tfloat totalULength=frame*u_TSASubUVLength.x;\n\t\tfloat floorTotalULength=floor(totalULength);\n\t    uv.x+=totalULength-floorTotalULength;\n\t\tuv.y+=floorTotalULength*u_TSASubUVLength.y;\n    #endif\n\t#ifdef TEXTURESHEETANIMATIONRANDOMCURVE\n\t\tfloat cycleNormalizedAge=normalizedAge*u_TSACycles;\n\t\tfloat uvNormalizedAge=cycleNormalizedAge-floor(cycleNormalizedAge);\n\t    float frame=floor(mix(getFrameFromGradient(u_TSAGradientUVs,uvNormalizedAge),getFrameFromGradient(u_TSAMaxGradientUVs,uvNormalizedAge),a_Random1.x));\n\t\tfloat totalULength=frame*u_TSASubUVLength.x;\n\t\tfloat floorTotalULength=floor(totalULength);\n\t    uv.x+=totalULength-floorTotalULength;\n\t\tuv.y+=floorTotalULength*u_TSASubUVLength.y;\n    #endif\n\treturn uv;\n}\n\nvoid main()\n{\n\tfloat age = u_CurrentTime - a_DirectionTime.w;\n\tfloat normalizedAge = age/a_ShapePositionStartLifeTime.w;\n\tvec3 lifeVelocity;\n\tif(normalizedAge<1.0)\n\t{ \n\t\tvec3 startVelocity=a_DirectionTime.xyz*a_StartSpeed;\n\t\t#if defined(VELOCITYOVERLIFETIMECONSTANT)||defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCONSTANT)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)\n\t\t\tlifeVelocity= computeParticleLifeVelocity(normalizedAge);//计算粒子生命周期速度\n\t\t#endif \n\t\tvec3 gravityVelocity=u_Gravity*age;\n\t\t\n\t\tvec4 worldRotation;\n\t\tif(u_SimulationSpace==0)\n\t\t\tworldRotation=a_SimulationWorldRotation;\n\t\telse\n\t\t\tworldRotation=u_WorldRotation;\n\t\t\n\t\tvec3 center=computeParticlePosition(startVelocity, lifeVelocity, age, normalizedAge,gravityVelocity,worldRotation);//计算粒子位置\n\t\n\t\n\t\t#ifdef SPHERHBILLBOARD\n\t\t\tvec2 corner=a_CornerTextureCoordinate.xy;//Billboard模式z轴无效\n\t\t\tvec3 cameraUpVector =normalize(u_CameraUp);//TODO:是否外面归一化\n\t\t\tvec3 sideVector = normalize(cross(u_CameraDirection,cameraUpVector));\n\t\t\tvec3 upVector = normalize(cross(sideVector,u_CameraDirection));\n\t\t\tcorner*=computeParticleSizeBillbard(a_StartSize.xy,normalizedAge);\n\t\t\t#if defined(ROTATIONOVERLIFETIME)||defined(ROTATIONOVERLIFETIMESEPERATE)\n\t\t\t\tif(u_ThreeDStartRotation){\n\t\t\t\t\tvec3 rotation=vec3(a_StartRotation0.xy,computeParticleRotationFloat(a_StartRotation0.z,age,normalizedAge));\n\t\t\t\t\tcenter += u_SizeScale.xzy*rotationByEuler(corner.x*sideVector+corner.y*upVector,rotation);\n\t\t\t\t}\n\t\t\t\telse{\n\t\t\t\t\tfloat rot = computeParticleRotationFloat(a_StartRotation0.x, age,normalizedAge);\n\t\t\t\t\tfloat c = cos(rot);\n\t\t\t\t\tfloat s = sin(rot);\n\t\t\t\t\tmat2 rotation= mat2(c, -s, s, c);\n\t\t\t\t\tcorner=rotation*corner;\n\t\t\t\t\tcenter += u_SizeScale.xzy*(corner.x*sideVector+corner.y*upVector);\n\t\t\t\t}\n\t\t\t#else\n\t\t\t\tif(u_ThreeDStartRotation){\n\t\t\t\t\tcenter += u_SizeScale.xzy*rotationByEuler(corner.x*sideVector+corner.y*upVector,a_StartRotation0);\n\t\t\t\t}\n\t\t\t\telse{\n\t\t\t\t\tfloat c = cos(a_StartRotation0.x);\n\t\t\t\t\tfloat s = sin(a_StartRotation0.x);\n\t\t\t\t\tmat2 rotation= mat2(c, -s, s, c);\n\t\t\t\t\tcorner=rotation*corner;\n\t\t\t\t\tcenter += u_SizeScale.xzy*(corner.x*sideVector+corner.y*upVector);\n\t\t\t\t}\n\t\t\t#endif\n\t\t#endif\n\t\n\t\t#ifdef STRETCHEDBILLBOARD\n\t\t\tvec2 corner=a_CornerTextureCoordinate.xy;//Billboard模式z轴无效\n\t\t\tvec3 velocity;\n\t\t\t#if defined(VELOCITYOVERLIFETIMECONSTANT)||defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCONSTANT)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)\n\t\t\t\tif(u_VOLSpaceType==0)\n\t\t\t\tvelocity=rotationByQuaternions(u_SizeScale*(startVelocity+lifeVelocity),worldRotation)+gravityVelocity;\n\t\t\t\telse\n\t\t\t\tvelocity=rotationByQuaternions(u_SizeScale*startVelocity,worldRotation)+lifeVelocity+gravityVelocity;\n\t\t\t#else\n\t\t\t\tvelocity= rotationByQuaternions(u_SizeScale*startVelocity,worldRotation)+gravityVelocity;\n\t\t\t#endif\t\n\t\t\tvec3 cameraUpVector = normalize(velocity);\n\t\t\tvec3 direction = normalize(center-u_CameraPos);\n\t\t\tvec3 sideVector = normalize(cross(direction,normalize(velocity)));\n\t\t\t\n\t\t\tsideVector=u_SizeScale.xzy*sideVector;\n\t\t\tcameraUpVector=length(vec3(u_SizeScale.x,0.0,0.0))*cameraUpVector;\n\t\t\t\n\t\t\tvec2 size=computeParticleSizeBillbard(a_StartSize.xy,normalizedAge);\n\t\t\t\n\t\t\tconst mat2 rotaionZHalfPI=mat2(0.0, -1.0, 1.0, 0.0);\n\t\t\tcorner=rotaionZHalfPI*corner;\n\t\t\tcorner.y=corner.y-abs(corner.y);\n\t\t\t\n\t\t\tfloat speed=length(velocity);//TODO:\n\t\t\tcenter +=sign(u_SizeScale.x)*(sign(u_StretchedBillboardLengthScale)*size.x*corner.x*sideVector+(speed*u_StretchedBillboardSpeedScale+size.y*u_StretchedBillboardLengthScale)*corner.y*cameraUpVector);\n\t\t#endif\n\t\n\t\t#ifdef HORIZONTALBILLBOARD\n\t\t\tvec2 corner=a_CornerTextureCoordinate.xy;//Billboard模式z轴无效\n\t\t\tconst vec3 cameraUpVector=vec3(0.0,0.0,1.0);\n\t\t\tconst vec3 sideVector = vec3(-1.0,0.0,0.0);\n\t\t\t\n\t\t\tfloat rot = computeParticleRotationFloat(a_StartRotation0.x, age,normalizedAge);\n\t\t\tfloat c = cos(rot);\n\t\t\tfloat s = sin(rot);\n\t\t\tmat2 rotation= mat2(c, -s, s, c);\n\t\t\tcorner=rotation*corner*cos(0.78539816339744830961566084581988);//TODO:临时缩小cos45,不确定U3D原因\n\t\t\tcorner*=computeParticleSizeBillbard(a_StartSize.xy,normalizedAge);\n\t\t\tcenter +=u_SizeScale.xzy*(corner.x*sideVector+ corner.y*cameraUpVector);\n\t\t#endif\n\t\n\t\t#ifdef VERTICALBILLBOARD\n\t\t\tvec2 corner=a_CornerTextureCoordinate.xy;//Billboard模式z轴无效\n\t\t\tconst vec3 cameraUpVector =vec3(0.0,1.0,0.0);\n\t\t\tvec3 sideVector = normalize(cross(u_CameraDirection,cameraUpVector));\n\t\t\t\n\t\t\tfloat rot = computeParticleRotationFloat(a_StartRotation0.x, age,normalizedAge);\n\t\t\tfloat c = cos(rot);\n\t\t\tfloat s = sin(rot);\n\t\t\tmat2 rotation= mat2(c, -s, s, c);\n\t\t\tcorner=rotation*corner*cos(0.78539816339744830961566084581988);//TODO:临时缩小cos45,不确定U3D原因\n\t\t\tcorner*=computeParticleSizeBillbard(a_StartSize.xy,normalizedAge);\n\t\t\tcenter +=u_SizeScale.xzy*(corner.x*sideVector+ corner.y*cameraUpVector);\n\t\t#endif\n\t\n\t\t#ifdef RENDERMODE_MESH\n\t\t\tvec3 size=computeParticleSizeMesh(a_StartSize,normalizedAge);\n\t\t\t#if defined(ROTATIONOVERLIFETIME)||defined(ROTATIONOVERLIFETIMESEPERATE)\n\t\t\t\tif(u_ThreeDStartRotation){\n\t\t\t\t\tvec3 rotation=vec3(a_StartRotation0.xy,computeParticleRotationFloat(a_StartRotation0.z, age,normalizedAge));\n\t\t\t\t\tcenter+= rotationByQuaternions(u_SizeScale*rotationByEuler(a_MeshPosition*size,rotation),worldRotation);\n\t\t\t\t}\n\t\t\t\telse{\n\t\t\t\t\t#ifdef ROTATIONOVERLIFETIME\n\t\t\t\t\t\tfloat angle=computeParticleRotationFloat(a_StartRotation0.x, age,normalizedAge);\n\t\t\t\t\t\tif(a_ShapePositionStartLifeTime.x!=0.0||a_ShapePositionStartLifeTime.y!=0.0){\n\t\t\t\t\t\t\tcenter+= (rotationByQuaternions(rotationByAxis(u_SizeScale*a_MeshPosition*size,normalize(cross(vec3(0.0,0.0,1.0),vec3(a_ShapePositionStartLifeTime.xy,0.0))),angle),worldRotation));//已验证\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse{\n\t\t\t\t\t\t\t#ifdef SHAPE\n\t\t\t\t\t\t\t\tcenter+= u_SizeScale.xzy*(rotationByQuaternions(rotationByAxis(a_MeshPosition*size,vec3(0.0,-1.0,0.0),angle),worldRotation));\n\t\t\t\t\t\t\t#else\n\t\t\t\t\t\t\t\tif(u_SimulationSpace==0)\n\t\t\t\t\t\t\t\t\tcenter+=rotationByAxis(u_SizeScale*a_MeshPosition*size,vec3(0.0,0.0,-1.0),angle);//已验证\n\t\t\t\t\t\t\t\telse if(u_SimulationSpace==1)\n\t\t\t\t\t\t\t\t\tcenter+=rotationByQuaternions(u_SizeScale*rotationByAxis(a_MeshPosition*size,vec3(0.0,0.0,-1.0),angle),worldRotation);//已验证\n\t\t\t\t\t\t\t#endif\n\t\t\t\t\t\t}\n\t\t\t\t\t#endif\n\t\t\t\t\t#ifdef ROTATIONOVERLIFETIMESEPERATE\n\t\t\t\t\t\t//TODO:是否应合并if(u_ThreeDStartRotation)分支代码,待测试\n\t\t\t\t\t\tvec3 angle=computeParticleRotationVec3(vec3(0.0,0.0,-a_StartRotation0.x), age,normalizedAge);\n\t\t\t\t\t\tcenter+= (rotationByQuaternions(rotationByEuler(u_SizeScale*a_MeshPosition*size,vec3(angle.x,angle.y,angle.z)),worldRotation));//已验证\n\t\t\t\t\t#endif\t\t\n\t\t\t\t}\n\t\t\t#else\n\t\t\t\tif(u_ThreeDStartRotation){\n\t\t\t\t\tcenter+= rotationByQuaternions(u_SizeScale*rotationByEuler(a_MeshPosition*size,a_StartRotation0),worldRotation);//已验证\n\t\t\t\t}\n\t\t\t\telse{\n\t\t\t\t\tif(a_ShapePositionStartLifeTime.x!=0.0||a_ShapePositionStartLifeTime.y!=0.0){\n\t\t\t\t\t\tif(u_SimulationSpace==0)\n\t\t\t\t\t\t\tcenter+= rotationByAxis(u_SizeScale*a_MeshPosition*size,normalize(cross(vec3(0.0,0.0,1.0),vec3(a_ShapePositionStartLifeTime.xy,0.0))),a_StartRotation0.x);\n\t\t\t\t\t\telse if(u_SimulationSpace==1)\n\t\t\t\t\t\t\tcenter+= (rotationByQuaternions(u_SizeScale*rotationByAxis(a_MeshPosition*size,normalize(cross(vec3(0.0,0.0,1.0),vec3(a_ShapePositionStartLifeTime.xy,0.0))),a_StartRotation0.x),worldRotation));//已验证\n\t\t\t\t\t}\n\t\t\t\t\telse{\n\t\t\t\t\t\t#ifdef SHAPE\n\t\t\t\t\t\t\tif(u_SimulationSpace==0)\n\t\t\t\t\t\t\t\tcenter+= u_SizeScale*rotationByAxis(a_MeshPosition*size,vec3(0.0,-1.0,0.0),a_StartRotation0.x);\n\t\t\t\t\t\t\telse if(u_SimulationSpace==1)\n\t\t\t\t\t\t\t\tcenter+= rotationByQuaternions(u_SizeScale*rotationByAxis(a_MeshPosition*size,vec3(0.0,-1.0,0.0),a_StartRotation0.x),worldRotation);\t\n\t\t\t\t\t\t#else\n\t\t\t\t\t\t\tif(u_SimulationSpace==0)\n\t\t\t\t\t\t\t\tcenter+= rotationByAxis(u_SizeScale*a_MeshPosition*size,vec3(0.0,0.0,-1.0),a_StartRotation0.x);\n\t\t\t\t\t\t\telse if(u_SimulationSpace==1)\n\t\t\t\t\t\t\t\tcenter+= rotationByQuaternions(u_SizeScale*rotationByAxis(a_MeshPosition*size,vec3(0.0,0.0,-1.0),a_StartRotation0.x),worldRotation);//已验证\n\t\t\t\t\t\t#endif\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t#endif\n\t\t\tv_MeshColor=a_MeshColor;\n\t\t#endif\n\t\n\t\tgl_Position=u_Projection*u_View*vec4(center,1.0);\n\t\tv_Color = computeParticleColor(a_StartColor, normalizedAge);\n\t\t#ifdef DIFFUSEMAP\n\t\t\t#if defined(SPHERHBILLBOARD)||defined(STRETCHEDBILLBOARD)||defined(HORIZONTALBILLBOARD)||defined(VERTICALBILLBOARD)\n\t\t\t\tv_TextureCoordinate =computeParticleUV(a_CornerTextureCoordinate.zw, normalizedAge);\n\t\t\t#endif\n\t\t\t#ifdef RENDERMODE_MESH\n\t\t\t\tv_TextureCoordinate =computeParticleUV(a_MeshTextureCoordinate, normalizedAge);\n\t\t\t#endif\n\t\t\t\n\t\t\tv_TextureCoordinate=TransformUV(v_TextureCoordinate,u_TilingOffset);\n\t\t#endif\n   \t}\n   \telse\n\t{\n\t\tgl_Position=vec4(2.0,2.0,2.0,1.0);//Discard use out of X(-1,1),Y(-1,1),Z(0,1)\n\t}\n\tgl_Position=remapGLPositionZ(gl_Position);\n}\n\n',"#if defined(GL_FRAGMENT_PRECISION_HIGH)// 原来的写法会被我们自己的解析流程处理，而我们的解析是不认内置宏的，导致被删掉，所以改成 if defined 了\n  precision highp float;\n#else\n  precision mediump float;\n#endif\n\nvarying vec4 v_Color;\nvarying vec2 v_TextureCoordinate;\nuniform sampler2D u_texture;\nuniform vec4 u_Tintcolor;\n\n#ifdef RENDERMODE_MESH\n\tvarying vec4 v_MeshColor;\n#endif\n\n#ifdef FOG\n\tuniform float u_FogStart;\n\tuniform float u_FogRange;\n\t#ifdef ADDTIVEFOG\n\t#else\n\t\tuniform vec3 u_FogColor;\n\t#endif\n#endif\n\n\nvoid main()\n{\t\n\t#ifdef RENDERMODE_MESH\n\t\tgl_FragColor=v_MeshColor;\n\t#else\n\t\tgl_FragColor=vec4(1.0);\t\n\t#endif\n\t\t\n\t#ifdef DIFFUSEMAP\n\t\t#ifdef TINTCOLOR\n\t\t\tgl_FragColor*=texture2D(u_texture,v_TextureCoordinate)*u_Tintcolor*2.0*v_Color;\n\t\t#else\n\t\t\tgl_FragColor*=texture2D(u_texture,v_TextureCoordinate)*v_Color;\n\t\t#endif\n\t#else\n\t\t#ifdef TINTCOLOR\n\t\t\tgl_FragColor*=u_Tintcolor*2.0*v_Color;\n\t\t#else\n\t\t\tgl_FragColor*=v_Color;\n\t\t#endif\n\t#endif\n\t\n\t#ifdef FOG\n\t\tfloat lerpFact=clamp((1.0/gl_FragCoord.w-u_FogStart)/u_FogRange,0.0,1.0);\n\t\t#ifdef ADDTIVEFOG\n\t\t\tgl_FragColor.rgb=mix(gl_FragColor.rgb,vec3(0.0,0.0,0.0),lerpFact);\n\t\t#else\n\t\t\tgl_FragColor.rgb=mix(gl_FragColor.rgb,u_FogColor,lerpFact);\n\t\t#endif\n\t#endif\n}",n),e={a_Position:Ne.MESH_POSITION0},t={u_TintColor:_e.PERIOD_MATERIAL,u_Exposure:_e.PERIOD_MATERIAL,u_Rotation:_e.PERIOD_MATERIAL,u_CubeTexture:_e.PERIOD_MATERIAL,u_ViewProjection:_e.PERIOD_CAMERA},i=_e.add("SkyBox"),a=new Tn(e,t),i.addSubShader(a),a.addShaderPass('#if defined(GL_FRAGMENT_PRECISION_HIGH)// 原来的写法会被我们自己的解析流程处理，而我们的解析是不认内置宏的，导致被删掉，所以改成 if defined 了\nprecision highp float;\n#else\nprecision mediump float;\n#endif\n#include "Lighting.glsl";\n\nattribute vec4 a_Position;\nuniform mat4 u_ViewProjection;\nuniform float u_Rotation;\nvarying vec3 v_Texcoord;\n\n\nvec4 rotateAroundYInDegrees (vec4 vertex, float degrees)\n{\n\tfloat angle = degrees * 3.141593 / 180.0;\n\tfloat sina=sin(angle);\n\tfloat cosa=cos(angle);\n\tmat2 m = mat2(cosa, -sina, sina, cosa);\n\treturn vec4(m*vertex.xz, vertex.yw).xzyw;\n}\n\t\t\nvoid main()\n{\n\tvec4 position=rotateAroundYInDegrees(a_Position,u_Rotation);\n\tgl_Position = u_ViewProjection*position;\n\tv_Texcoord=vec3(-a_Position.x,a_Position.yz);//转换坐标系\n\tgl_Position=remapGLPositionZ(gl_Position);\n}\n',"#if defined(GL_FRAGMENT_PRECISION_HIGH)// 原来的写法会被我们自己的解析流程处理，而我们的解析是不认内置宏的，导致被删掉，所以改成 if defined 了\nprecision highp float;\n#else\nprecision mediump float;\n#endif\n\nvarying vec3 v_Texcoord;\n\nuniform samplerCube u_CubeTexture;\nuniform float u_Exposure;\nuniform vec4 u_TintColor;\n\n\nvoid main()\n{\t\n\tvec3 color=textureCube(u_CubeTexture, v_Texcoord).rgb*u_TintColor.rgb*u_Exposure*2.0;\n\tgl_FragColor=vec4(color,1.0);\n}\n\n"),e={a_Position:Ne.MESH_POSITION0},t={u_SunSize:_e.PERIOD_MATERIAL,u_SunSizeConvergence:_e.PERIOD_MATERIAL,u_AtmosphereThickness:_e.PERIOD_MATERIAL,u_SkyTint:_e.PERIOD_MATERIAL,u_GroundTint:_e.PERIOD_MATERIAL,u_Exposure:_e.PERIOD_MATERIAL,u_ViewProjection:_e.PERIOD_CAMERA,"u_SunLight.direction":_e.PERIOD_SCENE,"u_SunLight.color":_e.PERIOD_SCENE},i=_e.add("SkyBoxProcedural"),a=new Tn(e,t),i.addSubShader(a),a.addShaderPass("#if defined(GL_FRAGMENT_PRECISION_HIGH)// 原来的写法会被我们自己的解析流程处理，而我们的解析是不认内置宏的，导致被删掉，所以改成 if defined 了\n\tprecision highp float;\n#else\n\tprecision mediump float;\n#endif\n\n#include \"Lighting.glsl\";\n\n#define OUTER_RADIUS 1.025\n#define RAYLEIGH (mix(0.0, 0.0025, pow(u_AtmosphereThickness,2.5)))// Rayleigh constant Rayleigh为夜空光和极光亮度单位\n#define MIE 0.0010             // Mie constant 米氏散射\n#define SUN_BRIGHTNESS 20.0    // Sun brightness\n#define MAX_SCATTER 50.0 // Maximum scattering value, to prevent math overflows on Adrenos\n\nconst float SKY_GROUND_THRESHOLD = 0.02;\nconst float outerRadius = OUTER_RADIUS;\nconst float outerRadius2 = OUTER_RADIUS*OUTER_RADIUS;\nconst float innerRadius = 1.0;\nconst float innerRadius2 = 1.0;\nconst float cameraHeight = 0.0001;\n\nconst float HDSundiskIntensityFactor = 15.0;\nconst float simpleSundiskIntensityFactor = 27.0;\n\nconst float sunScale = 400.0 * SUN_BRIGHTNESS;\nconst float kmESun = MIE * SUN_BRIGHTNESS;\nconst float km4PI = MIE * 4.0 * 3.14159265;\nconst float scale = 1.0 / (OUTER_RADIUS - 1.0);\nconst float scaleDepth = 0.25;\nconst float scaleOverScaleDepth = (1.0 / (OUTER_RADIUS - 1.0)) / 0.25;\nconst float samples = 2.0; // THIS IS UNROLLED MANUALLY, DON'T TOUCH\n\n// RGB wavelengths        .35 (.62=158), .43 (.68=174), .525 (.75=190)\nconst vec3 c_DefaultScatteringWavelength = vec3(0.65, 0.57, 0.475);//默认散射波长\nconst vec3 c_VariableRangeForScatteringWavelength = vec3(0.15, 0.15, 0.15);//散射播放的可变范围\n\nattribute vec4 a_Position;\n\nuniform mat4 u_ViewProjection;\nuniform vec3 u_SkyTint;\nuniform vec3 u_GroundTint;\nuniform float u_Exposure;\nuniform float u_AtmosphereThickness;\nuniform DirectionLight u_SunLight;\n\nvarying vec3 v_GroundColor;\nvarying vec3 v_SkyColor;\n\n#ifdef SUN_HIGH_QUALITY\n\tvarying vec3 v_Vertex;\n#elif defined(SUN_SIMPLE)\n\tvarying vec3 v_RayDir;\n#else\n\tvarying float v_SkyGroundFactor;\n#endif\n\n#if defined(SUN_HIGH_QUALITY)||defined(SUN_SIMPLE)\n\tvarying vec3 v_SunColor;\n#endif\n\n// Calculates the Rayleigh phase function\nfloat getRayleighPhase(vec3 light, vec3 ray) \n{\n\tfloat eyeCos = dot(light, ray);\n\treturn 0.75 + 0.75*eyeCos*eyeCos;\n}\n\nfloat scaleAngle(float inCos)\n{\n\tfloat x = 1.0 - inCos;\n\treturn 0.25 * exp(-0.00287 + x*(0.459 + x*(3.83 + x*(-6.80 + x*5.25))));\n}\n\n\nvoid main () {\n\tgl_Position = u_ViewProjection*a_Position;\n\n\tvec3 skyTintInGammaSpace = u_SkyTint;//支持非GAMMA空间后要调整\n\tvec3 scatteringWavelength = mix(c_DefaultScatteringWavelength-c_VariableRangeForScatteringWavelength,c_DefaultScatteringWavelength+c_VariableRangeForScatteringWavelength,vec3(1.0) - skyTintInGammaSpace); // using Tint in sRGB+ gamma allows for more visually linear interpolation and to keep (0.5) at (128, gray in sRGB) point\n\tvec3 invWavelength = 1.0 / pow(scatteringWavelength, vec3(4.0));\n\n\tfloat krESun = RAYLEIGH * SUN_BRIGHTNESS;\n\tfloat kr4PI = RAYLEIGH * 4.0 * 3.14159265;\n\n\tvec3 cameraPos = vec3(0.0,innerRadius + cameraHeight,0.0); // The camera's current position\n\n\t// Get the ray from the camera to the vertex and its length (which is the far point of the ray passing through the atmosphere)\n\tvec3 eyeRay = normalize(a_Position.xyz);\n\n\tfloat far = 0.0;\n\tvec3 cIn, cOut;\n\tif (eyeRay.y >= 0.0) {// Sky\n\t\t// Calculate the length of the \"atmosphere\"\n\t\tfar = sqrt(outerRadius2 + innerRadius2 * eyeRay.y * eyeRay.y - innerRadius2) - innerRadius * eyeRay.y;\n\n\t\t// Calculate the ray's starting position, then calculate its scattering offset\n\t\tfloat height = innerRadius + cameraHeight;\n\t\tfloat depth = exp(scaleOverScaleDepth * -cameraHeight);\n\t\tfloat startAngle = dot(eyeRay, cameraPos) / height;\n\t\tfloat startOffset = depth*scaleAngle(startAngle);\n\n\t\t// Initialize the scattering loop variables\n\t\tfloat sampleLength = far / samples;\n\t\tfloat scaledLength = sampleLength * scale;\n\t\tvec3 sampleRay = eyeRay * sampleLength;\n\t\tvec3 samplePoint = cameraPos + sampleRay * 0.5;\n\n\t\tvec3 frontColor = vec3(0.0);\n\t\t//unrolling this manually to avoid some platform for loop slow\n\t\t{\n\t\t\tfloat height = length(samplePoint);\n\t\t\tfloat depth = exp(scaleOverScaleDepth * (innerRadius - height));\n\t\t\tfloat lightAngle = dot(-u_SunLight.direction, samplePoint) / height;\n\t\t\tfloat cameraAngle = dot(eyeRay, samplePoint) / height;\n\t\t\tfloat scatter = (startOffset + depth*(scaleAngle(lightAngle) - scaleAngle(cameraAngle)));\n\t\t\tvec3 attenuate = exp(-clamp(scatter, 0.0, MAX_SCATTER) * (invWavelength * kr4PI + km4PI));\n\n\t\t\tfrontColor += attenuate * (depth * scaledLength);\n\t\t\tsamplePoint += sampleRay;\n\t\t}\n\t\t{\n\t\t\tfloat height = length(samplePoint);\n\t\t\tfloat depth = exp(scaleOverScaleDepth * (innerRadius - height));\n\t\t\tfloat lightAngle = dot(-u_SunLight.direction, samplePoint) / height;\n\t\t\tfloat cameraAngle = dot(eyeRay, samplePoint) / height;\n\t\t\tfloat scatter = (startOffset + depth*(scaleAngle(lightAngle) - scaleAngle(cameraAngle)));\n\t\t\tvec3 attenuate = exp(-clamp(scatter, 0.0, MAX_SCATTER) * (invWavelength * kr4PI + km4PI));\n\n\t\t\tfrontColor += attenuate * (depth * scaledLength);\n\t\t\tsamplePoint += sampleRay;\n\t\t}\n\n\t\t// Finally, scale the Mie and Rayleigh colors and set up the varying variables for the pixel shader\n\t\tcIn = frontColor * (invWavelength * krESun);\n\t\tcOut = frontColor * kmESun;\n\t} else {// Ground\n\t\tfar = (-cameraHeight) / (min(-0.001, eyeRay.y));\n\t\tvec3 pos = cameraPos + far * eyeRay;\n\n\t\t// Calculate the ray's starting position, then calculate its scattering offset\n\t\tfloat depth = exp((-cameraHeight) * (1.0/scaleDepth));\n\t\tfloat cameraAngle = dot(-eyeRay, pos);\n\t\tfloat lightAngle = dot(-u_SunLight.direction, pos);\n\t\tfloat cameraScale = scaleAngle(cameraAngle);\n\t\tfloat lightScale = scaleAngle(lightAngle);\n\t\tfloat cameraOffset = depth*cameraScale;\n\t\tfloat temp = lightScale + cameraScale;\n\n\t\t// Initialize the scattering loop variables\n\t\tfloat sampleLength = far / samples;\n\t\tfloat scaledLength = sampleLength * scale;\n\t\tvec3 sampleRay = eyeRay * sampleLength;\n\t\tvec3 samplePoint = cameraPos + sampleRay * 0.5;\n\n\t\t// Now loop through the sample rays\n\t\tvec3 frontColor = vec3(0.0, 0.0, 0.0);\n\t\tvec3 attenuate;\n\n\t\t// Loop removed because we kept hitting SM2.0 temp variable limits. Doesn't affect the image too much.\n\t\t{\n\t\t\tfloat height = length(samplePoint);\n\t\t\tfloat depth = exp(scaleOverScaleDepth * (innerRadius - height));\n\t\t\tfloat scatter = depth*temp - cameraOffset;\n\t\t\tattenuate = exp(-clamp(scatter, 0.0, MAX_SCATTER) * (invWavelength * kr4PI + km4PI));\n\t\t\tfrontColor += attenuate * (depth * scaledLength);\n\t\t\tsamplePoint += sampleRay;\n\t\t}\n\n\t\tcIn = frontColor * (invWavelength * krESun + kmESun);\n\t\tcOut = clamp(attenuate, 0.0, 1.0);\n\t}\n\n\t#ifdef SUN_HIGH_QUALITY\n\t\tv_Vertex = -a_Position.xyz;\n\t#elif defined(SUN_SIMPLE) \n\t\tv_RayDir = -eyeRay;\n\t#else\n\t\tv_SkyGroundFactor = -eyeRay.y / SKY_GROUND_THRESHOLD;\n\t#endif\n\n\t// if we want to calculate color in vprog:\n\t// in case of linear: multiply by _Exposure in here (even in case of lerp it will be common multiplier, so we can skip mul in fshader)\n\tv_GroundColor = u_Exposure * (cIn + u_GroundTint*u_GroundTint * cOut);//u_GroundColor*u_GroundColor is gamma space convert to linear space\n\tv_SkyColor    = u_Exposure * (cIn * getRayleighPhase(-u_SunLight.direction, -eyeRay));\n\n\t\n\t// The sun should have a stable intensity in its course in the sky. Moreover it should match the highlight of a purely specular material.\n\t// This matching was done using the Unity3D standard shader BRDF1 on the 5/31/2017\n\t// Finally we want the sun to be always bright even in LDR thus the normalization of the lightColor for low intensity.\n\tfloat lightColorIntensity = clamp(length(u_SunLight.color), 0.25, 1.0);\n\n\t#ifdef SUN_HIGH_QUALITY \n\t\tv_SunColor = HDSundiskIntensityFactor * clamp(cOut,0.0,1.0) * u_SunLight.color / lightColorIntensity;\n\t#elif defined(SUN_SIMPLE) \n\t\tv_SunColor = simpleSundiskIntensityFactor * clamp(cOut * sunScale,0.0,1.0) * u_SunLight.color / lightColorIntensity;\n\t#endif\n\tgl_Position=remapGLPositionZ(gl_Position);\n}\n",'#if defined(GL_FRAGMENT_PRECISION_HIGH)// 原来的写法会被我们自己的解析流程处理，而我们的解析是不认内置宏的，导致被删掉，所以改成 if defined 了\n\tprecision highp float;\n#else\n\tprecision mediump float;\n#endif\n\n#include "Lighting.glsl";\n\nconst float MIE_G = -0.990;\nconst float MIE_G2 = 0.9801;\nconst float SKY_GROUND_THRESHOLD = 0.02;\n\nuniform float u_SunSize;\nuniform float u_SunSizeConvergence;\nuniform DirectionLight u_SunLight;\n\n\nvarying vec3 v_GroundColor;\nvarying vec3 v_SkyColor;\n\n\n#ifdef SUN_HIGH_QUALITY\n\tvarying vec3 v_Vertex;\n#elif defined(SUN_SIMPLE)\n\tvarying vec3 v_RayDir;\n#else\n\tvarying float v_SkyGroundFactor;\n#endif\n\n#if defined(SUN_HIGH_QUALITY)||defined(SUN_SIMPLE)\n\tvarying vec3 v_SunColor;\n#endif\n\n// Calculates the Mie phase function\nfloat getMiePhase(float eyeCos, float eyeCos2) {\n\tfloat temp = 1.0 + MIE_G2 - 2.0 * MIE_G * eyeCos;\n\ttemp = pow(temp, pow(u_SunSize,0.65) * 10.0);\n\ttemp = max(temp,1.0e-4); // prevent division by zero, esp. in half precision\n\ttemp = 1.5 * ((1.0 - MIE_G2) / (2.0 + MIE_G2)) * (1.0 + eyeCos2) / temp;\n\treturn temp;\n}\n\n// Calculates the sun shape\nfloat calcSunAttenuation(vec3 lightPos, vec3 ray) {\n\t#ifdef SUN_HIGH_QUALITY\n\t\tfloat focusedEyeCos = pow(clamp(dot(lightPos, ray),0.0,1.0), u_SunSizeConvergence);\n\t\treturn getMiePhase(-focusedEyeCos, focusedEyeCos * focusedEyeCos);\n\t#else //SUN_SIMPLE\n\t\tvec3 delta = lightPos - ray;\n\t\tfloat dist = length(delta);\n\t\tfloat spot = 1.0 - smoothstep(0.0, u_SunSize, dist);\n\t\treturn spot * spot;\n\t#endif\n}\n\nvoid main() {\n\t// if y > 1 [eyeRay.y < -SKY_GROUND_THRESHOLD] - ground\n\t// if y >= 0 and < 1 [eyeRay.y <= 0 and > -SKY_GROUND_THRESHOLD] - horizon\n\t// if y < 0 [eyeRay.y > 0] - sky\n\tvec3 col = vec3(0.0, 0.0, 0.0);\n\n\t#ifdef SUN_HIGH_QUALITY\n\t\tvec3 ray = normalize(v_Vertex);\n\t\tfloat y = ray.y / SKY_GROUND_THRESHOLD;\n\t#elif defined(SUN_SIMPLE) \n\t\tvec3 ray = v_RayDir;\n\t\tfloat y = ray.y / SKY_GROUND_THRESHOLD;\t\n\t#else\n\t\tfloat y = v_SkyGroundFactor;\n\t#endif\n\n\t// if we did precalculate color in vprog: just do lerp between them\n\tcol = mix(v_SkyColor, v_GroundColor, clamp(y,0.0,1.0));\n\n\t#if defined(SUN_HIGH_QUALITY)||defined(SUN_SIMPLE)\n\t\tif (y < 0.0)\n\t\t\tcol += v_SunColor * calcSunAttenuation(-u_SunLight.direction, -ray);\n\t#endif\n\n\tcol = sqrt(col);//linear space convert to gamma space\n\tgl_FragColor=vec4(col,1.0);\n}\n\n'),e={a_Position:Ne.MESH_POSITION0,a_Normal:Ne.MESH_NORMAL0,a_Texcoord0:Ne.MESH_TEXTURECOORDINATE0},t={u_MvpMatrix:_e.PERIOD_SPRITE,u_WorldMat:_e.PERIOD_SPRITE,u_CameraPos:_e.PERIOD_CAMERA,u_Viewport:_e.PERIOD_CAMERA,u_ProjectionParams:_e.PERIOD_CAMERA,u_View:_e.PERIOD_CAMERA,u_LightmapScaleOffset:_e.PERIOD_SPRITE,u_LightMap:_e.PERIOD_SPRITE,u_SplatAlphaTexture:_e.PERIOD_MATERIAL,u_DiffuseTexture1:_e.PERIOD_MATERIAL,u_DiffuseTexture2:_e.PERIOD_MATERIAL,u_DiffuseTexture3:_e.PERIOD_MATERIAL,u_DiffuseTexture4:_e.PERIOD_MATERIAL,u_DiffuseTexture5:_e.PERIOD_MATERIAL,u_DiffuseScaleOffset1:_e.PERIOD_MATERIAL,u_DiffuseScaleOffset2:_e.PERIOD_MATERIAL,u_DiffuseScaleOffset3:_e.PERIOD_MATERIAL,u_DiffuseScaleOffset4:_e.PERIOD_MATERIAL,u_DiffuseScaleOffset5:_e.PERIOD_MATERIAL,u_FogStart:_e.PERIOD_SCENE,u_FogRange:_e.PERIOD_SCENE,u_FogColor:_e.PERIOD_SCENE,u_DirationLightCount:_e.PERIOD_SCENE,u_LightBuffer:_e.PERIOD_SCENE,u_LightClusterBuffer:_e.PERIOD_SCENE,u_AmbientColor:_e.PERIOD_SCENE,u_ShadowMap:_e.PERIOD_SCENE,u_shadowMap2:_e.PERIOD_SCENE,u_shadowMap3:_e.PERIOD_SCENE,u_ShadowSplitSpheres:_e.PERIOD_SCENE,u_ShadowMatrices:_e.PERIOD_SCENE,u_ShadowMapSize:_e.PERIOD_SCENE,"u_DirectionLight.color":_e.PERIOD_SCENE,"u_DirectionLight.direction":_e.PERIOD_SCENE,"u_PointLight.position":_e.PERIOD_SCENE,"u_PointLight.range":_e.PERIOD_SCENE,"u_PointLight.color":_e.PERIOD_SCENE,"u_SpotLight.position":_e.PERIOD_SCENE,"u_SpotLight.direction":_e.PERIOD_SCENE,"u_SpotLight.range":_e.PERIOD_SCENE,"u_SpotLight.spot":_e.PERIOD_SCENE,"u_SpotLight.color":_e.PERIOD_SCENE},n={s_Cull:_e.RENDER_STATE_CULL,s_Blend:_e.RENDER_STATE_BLEND,s_BlendSrc:_e.RENDER_STATE_BLEND_SRC,s_BlendDst:_e.RENDER_STATE_BLEND_DST,s_DepthTest:_e.RENDER_STATE_DEPTH_TEST,s_DepthWrite:_e.RENDER_STATE_DEPTH_WRITE},i=_e.add("ExtendTerrain"),a=new Tn(e,t),i.addSubShader(a),a.addShaderPass('#include "Lighting.glsl";\n\nattribute vec4 a_Position;\nattribute vec2 a_Texcoord0;\n\nuniform mat4 u_MvpMatrix;\n\nvarying vec2 v_Texcoord0;\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(LIGHTMAP)\n\tattribute vec3 a_Normal;\n\tvarying vec3 v_Normal;\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(FOG)||(defined(CALCULATE_SHADOWS)&&defined(SHADOWMAP_PSSM1))\n\tuniform mat4 u_WorldMat;\n\tvarying vec3 v_PositionWorld;\n#endif\n\n#ifdef LIGHTMAP\n\tvarying vec2 v_LightMapUV;\n\tuniform vec4 u_LightmapScaleOffset;\n#endif\n\n#if defined(CALCULATE_SHADOWS)//shader���Զ���ĺ겻����ifdef ����ĳ�if defined\n\tvarying vec4 v_ShadowCoord;\n#endif\n\nvoid main()\n{\n\tgl_Position = u_MvpMatrix * a_Position;\n  \n\tv_Texcoord0 = a_Texcoord0;\n  \n\t#ifdef LIGHTMAP\n\t\tv_LightMapUV = vec2(a_Texcoord0.x, 1.0 - a_Texcoord0.y) * u_LightmapScaleOffset.xy + u_LightmapScaleOffset.zw;\n\t\tv_LightMapUV.y = 1.0 - v_LightMapUV.y;\n\t#endif\n  \n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n\t\tv_Normal = a_Normal;\n\t#endif\n\n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(FOG)||(defined(CALCULATE_SHADOWS)&&defined(SHADOWMAP_PSSM1))\n\t\tv_PositionWorld=(u_WorldMat*a_Position).xyz;\n\t#endif\n\n\t#if defined(CALCULATE_SHADOWS)//shader���Զ���ĺ겻����ifdef ����ĳ�if defined\n\t\tv_ShadowCoord = getShadowCoord(vec4(v_PositionWorld));\n\t#endif\n\tgl_Position=remapGLPositionZ(gl_Position);\n}','#if defined(GL_FRAGMENT_PRECISION_HIGH)// 原来的写法会被我们自己的解析流程处理，而我们的解析是不认内置宏的，导致被删掉，所以改成 if defined 了\n\tprecision highp float;\n#else\n\tprecision mediump float;\n#endif\n\n#include "Lighting.glsl";\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(FOG)\n\tuniform vec3 u_CameraPos;\n\tvarying vec3 v_Normal;\n\tvarying vec3 v_PositionWorld;\n#endif\n\n#ifdef FOG\n\tuniform float u_FogStart;\n\tuniform float u_FogRange;\n\tuniform vec3 u_FogColor;\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n\t#ifdef LEGACYSINGLELIGHTING\n\t\t#ifdef DIRECTIONLIGHT\n\t\t\tuniform DirectionLight u_DirectionLight;\n\t\t#endif\n\t\t#ifdef POINTLIGHT\n\t\t\tuniform PointLight u_PointLight;\n\t\t#endif\n\t\t#ifdef SPOTLIGHT\n\t\t\tuniform SpotLight u_SpotLight;\n\t\t#endif\n\t#else\n\t\tuniform mat4 u_View;\n\t\tuniform vec4 u_ProjectionParams;\n\t\tuniform vec4 u_Viewport;\n\t\tuniform int u_DirationLightCount;\n\t\tuniform sampler2D u_LightBuffer;\n\t\tuniform sampler2D u_LightClusterBuffer;\n\t#endif\n#endif\n\n#include "Shadow.glsl"\n#if defined(CALCULATE_SHADOWS)//shader中自定义的宏不可用ifdef 必须改成if defined\n\tvarying vec4 v_ShadowCoord;\n#endif\nvarying float v_posViewZ;\n\nuniform vec3 u_AmbientColor;\n\nuniform sampler2D u_SplatAlphaTexture;\n\nuniform sampler2D u_DiffuseTexture1;\nuniform sampler2D u_DiffuseTexture2;\nuniform sampler2D u_DiffuseTexture3;\nuniform sampler2D u_DiffuseTexture4;\nuniform sampler2D u_DiffuseTexture5;\n\nuniform vec4 u_DiffuseScaleOffset1;\nuniform vec4 u_DiffuseScaleOffset2;\nuniform vec4 u_DiffuseScaleOffset3;\nuniform vec4 u_DiffuseScaleOffset4;\nuniform vec4 u_DiffuseScaleOffset5;\n\nvarying vec2 v_Texcoord0;\n\n#ifdef LIGHTMAP\n\tuniform sampler2D u_LightMap;\n\tvarying vec2 v_LightMapUV;\n#endif\n\nvoid main()\n{\n\tvec4 splatAlpha = vec4(1.0);\n\t#ifdef ExtendTerrain_DETAIL_NUM1\n\t\tsplatAlpha = texture2D(u_SplatAlphaTexture, v_Texcoord0);\n\t\tvec4 color1 = texture2D(u_DiffuseTexture1, v_Texcoord0 * u_DiffuseScaleOffset1.xy);\n\t\tgl_FragColor.xyz = color1.xyz * splatAlpha.r;\n\t#endif\n\t#ifdef ExtendTerrain_DETAIL_NUM2\n\t\tsplatAlpha = texture2D(u_SplatAlphaTexture, v_Texcoord0);\n\t\tvec4 color1 = texture2D(u_DiffuseTexture1, v_Texcoord0 * u_DiffuseScaleOffset1.xy);\n\t\tvec4 color2 = texture2D(u_DiffuseTexture2, v_Texcoord0 * u_DiffuseScaleOffset2.xy);\n\t\tgl_FragColor.xyz = color1.xyz * splatAlpha.r + color2.xyz * (1.0 - splatAlpha.r);\n\t#endif\n\t#ifdef ExtendTerrain_DETAIL_NUM3\n\t\tsplatAlpha = texture2D(u_SplatAlphaTexture, v_Texcoord0);\n\t\tvec4 color1 = texture2D(u_DiffuseTexture1, v_Texcoord0 * u_DiffuseScaleOffset1.xy);\n\t\tvec4 color2 = texture2D(u_DiffuseTexture2, v_Texcoord0 * u_DiffuseScaleOffset2.xy);\n\t\tvec4 color3 = texture2D(u_DiffuseTexture3, v_Texcoord0 * u_DiffuseScaleOffset3.xy);\n\t\tgl_FragColor.xyz = color1.xyz * splatAlpha.r  + color2.xyz * splatAlpha.g + color3.xyz * (1.0 - splatAlpha.r - splatAlpha.g);\n\t#endif\n\t#ifdef ExtendTerrain_DETAIL_NUM4\n\t\tsplatAlpha = texture2D(u_SplatAlphaTexture, v_Texcoord0);\n\t\tvec4 color1 = texture2D(u_DiffuseTexture1, v_Texcoord0 * u_DiffuseScaleOffset1.xy);\n\t\tvec4 color2 = texture2D(u_DiffuseTexture2, v_Texcoord0 * u_DiffuseScaleOffset2.xy);\n\t\tvec4 color3 = texture2D(u_DiffuseTexture3, v_Texcoord0 * u_DiffuseScaleOffset3.xy);\n\t\tvec4 color4 = texture2D(u_DiffuseTexture4, v_Texcoord0 * u_DiffuseScaleOffset4.xy);\n\t\tgl_FragColor.xyz = color1.xyz * splatAlpha.r  + color2.xyz * splatAlpha.g + color3.xyz * splatAlpha.b + color4.xyz * (1.0 - splatAlpha.r - splatAlpha.g - splatAlpha.b);\n\t#endif\n\t#ifdef ExtendTerrain_DETAIL_NUM5\n\t\tsplatAlpha = texture2D(u_SplatAlphaTexture, v_Texcoord0);\n\t\tvec4 color1 = texture2D(u_DiffuseTexture1, v_Texcoord0 * u_DiffuseScaleOffset1.xy);\n\t\tvec4 color2 = texture2D(u_DiffuseTexture2, v_Texcoord0 * u_DiffuseScaleOffset2.xy);\n\t\tvec4 color3 = texture2D(u_DiffuseTexture3, v_Texcoord0 * u_DiffuseScaleOffset3.xy);\n\t\tvec4 color4 = texture2D(u_DiffuseTexture4, v_Texcoord0 * u_DiffuseScaleOffset4.xy);\n\t\tvec4 color5 = texture2D(u_DiffuseTexture5, v_Texcoord0 * u_DiffuseScaleOffset5.xy);\n\t\tgl_FragColor.xyz = color1.xyz * splatAlpha.r  + color2.xyz * splatAlpha.g + color3.xyz * splatAlpha.b + color4.xyz * splatAlpha.a + color5.xyz * (1.0 - splatAlpha.r - splatAlpha.g - splatAlpha.b - splatAlpha.a);\n\t#endif\n\t\tgl_FragColor.w = splatAlpha.a;\n\t\t\n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n\t\tvec3 normal = v_Normal;\n\t\tvec3 dif, spe;\n\t#endif\n\n\tvec3 diffuse = vec3(0.0);\n\tvec3 specular= vec3(0.0);\n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(FOG)\n\t\tvec3 toEye;\n\t\t#ifdef FOG\n\t\t\ttoEye=u_CameraPos-v_PositionWorld;\n\t\t\tfloat toEyeLength=length(toEye);\n\t\t\ttoEye/=toEyeLength;\n\t\t#else\n\t\t\ttoEye=normalize(u_CameraPos-v_PositionWorld);\n\t\t#endif\n\t#endif\n\n\t#ifdef LEGACYSINGLELIGHTING\n\t\t#ifdef DIRECTIONLIGHT\n\t\t\tLayaAirBlinnPhongDiectionLight(vec3(0.0),1.0,normal,vec3(1.0),toEye,u_DirectionLight,dif,spe);\n\t\t\tdiffuse+=dif;\n\t\t\tspecular+=spe;\n\t\t#endif\n\t\n\t\t#ifdef POINTLIGHT\n\t\t\tLayaAirBlinnPhongPointLight(v_PositionWorld,vec3(0.0),1.0,normal,vec3(1.0),toEye,u_PointLight,dif,spe);\n\t\t\tdiffuse+=dif;\n\t\t\tspecular+=spe;\n\t\t#endif\n\n\t\t#ifdef SPOTLIGHT\n\t\t\tLayaAirBlinnPhongSpotLight(v_PositionWorld,vec3(0.0),1.0,normal,vec3(1.0),toEye,u_SpotLight,dif,spe);\n\t\t\tdiffuse+=dif;\n\t\t\tspecular+=spe;\n\t\t#endif\n\t#else\n\t\t#ifdef DIRECTIONLIGHT\n\t\t\tfor (int i = 0; i < MAX_LIGHT_COUNT; i++) \n\t\t\t{\n\t\t\t\tif(i >= u_DirationLightCount)\n\t\t\t\t\tbreak;\n\t\t\t\tDirectionLight directionLight = getDirectionLight(u_LightBuffer,i);\n\t\t\t\tLayaAirBlinnPhongDiectionLight(vec3(0.0),1.0,normal,vec3(1.0),toEye,directionLight,dif,spe);\n\t\t\t\tdiffuse+=dif;\n\t\t\t\tspecular+=spe;\n\t\t\t}\n\t\t#endif\n\t\t#if defined(POINTLIGHT)||defined(SPOTLIGHT)\n\t\t\tivec4 clusterInfo =getClusterInfo(u_LightClusterBuffer,u_View,u_Viewport, v_PositionWorld,gl_FragCoord,u_ProjectionParams);\n\t\t\t#ifdef POINTLIGHT\n\t\t\t\tfor (int i = 0; i < MAX_LIGHT_COUNT; i++) \n\t\t\t\t{\n\t\t\t\t\tif(i >= clusterInfo.x)//PointLightCount\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tPointLight pointLight = getPointLight(u_LightBuffer,u_LightClusterBuffer,clusterInfo,i);\n\t\t\t\t\tLayaAirBlinnPhongPointLight(v_PositionWorld,vec3(0.0),1.0,normal,vec3(1.0),toEye,pointLight,dif,spe);\n\t\t\t\t\tdiffuse+=dif;\n\t\t\t\t\tspecular+=spe;\n\t\t\t\t}\n\t\t\t#endif\n\t\t\t#ifdef SPOTLIGHT\n\t\t\t\tfor (int i = 0; i < MAX_LIGHT_COUNT; i++) \n\t\t\t\t{\n\t\t\t\t\tif(i >= clusterInfo.y)//SpotLightCount\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tSpotLight spotLight = getSpotLight(u_LightBuffer,u_LightClusterBuffer,clusterInfo,i);\n\t\t\t\t\tLayaAirBlinnPhongSpotLight(v_PositionWorld,vec3(0.0),1.0,normal,vec3(1.0),toEye\t,spotLight,dif,spe);\n\t\t\t\t\tdiffuse+=dif;\n\t\t\t\t\tspecular+=spe;\n\t\t\t\t}\n\t\t\t#endif\n\t\t#endif\n\t#endif\n\nvec3 globalDiffuse = u_AmbientColor;\n#ifdef LIGHTMAP\n\tglobalDiffuse += decodeHDR(texture2D(u_LightMap, v_LightMapUV),5.0);\n#endif\n\n#if defined(CALCULATE_SHADOWS)//shader中自定义的宏不可用ifdef 必须改成if defined\n\tfloat shadowValue = shadowValue = sampleShadowmap(v_ShadowCoord);\n\tgl_FragColor = vec4(gl_FragColor.rgb * (globalDiffuse + diffuse) * shadowValue, gl_FragColor.a);\n#else\n\tgl_FragColor = vec4(gl_FragColor.rgb * (globalDiffuse + diffuse), gl_FragColor.a);\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n\t#if defined(CALCULATE_SHADOWS)//shader中自定义的宏不可用ifdef 必须改成if defined\n\t\tgl_FragColor.rgb += specular * shadowValue;\n\t#else\n\t\tgl_FragColor.rgb += specular;\n\t#endif\n#endif\n\n#ifdef FOG\n\tfloat lerpFact=clamp((toEyeLength-u_FogStart)/u_FogRange,0.0,1.0);\n\tgl_FragColor.rgb=mix(gl_FragColor.rgb,u_FogColor,lerpFact);\n#endif\n}\n\n\n\n\n\n',n),e={a_Position:Ti.TRAIL_POSITION0,a_OffsetVector:Ti.TRAIL_OFFSETVECTOR,a_Texcoord0X:Ti.TRAIL_TEXTURECOORDINATE0X,a_Texcoord0Y:Ti.TRAIL_TEXTURECOORDINATE0Y,a_BirthTime:Ti.TRAIL_TIME0,a_Color:Ti.TRAIL_COLOR},t={u_MvpMatrix:_e.PERIOD_SPRITE,u_View:_e.PERIOD_CAMERA,u_Projection:_e.PERIOD_CAMERA,u_TilingOffset:_e.PERIOD_MATERIAL,u_MainTexture:_e.PERIOD_MATERIAL,u_MainColor:_e.PERIOD_MATERIAL,u_CurTime:_e.PERIOD_SPRITE,u_LifeTime:_e.PERIOD_SPRITE,u_WidthCurve:_e.PERIOD_SPRITE,u_WidthCurveKeyLength:_e.PERIOD_SPRITE,u_GradientColorkey:_e.PERIOD_SPRITE,u_GradientAlphakey:_e.PERIOD_SPRITE},n={s_Cull:_e.RENDER_STATE_CULL,s_Blend:_e.RENDER_STATE_BLEND,s_BlendSrc:_e.RENDER_STATE_BLEND_SRC,s_BlendDst:_e.RENDER_STATE_BLEND_DST,s_DepthTest:_e.RENDER_STATE_DEPTH_TEST,s_DepthWrite:_e.RENDER_STATE_DEPTH_WRITE},i=_e.add("Trail"),a=new Tn(e,t),i.addSubShader(a),a.addShaderPass('#if defined(GL_FRAGMENT_PRECISION_HIGH)// 原来的写法会被我们自己的解析流程处理，而我们的解析是不认内置宏的，导致被删掉，所以改成 if defined 了\n\tprecision highp float;\n#else\n\tprecision mediump float;\n#endif\n#include "Lighting.glsl";\n\nattribute vec3 a_Position;\nattribute vec3 a_OffsetVector;\nattribute vec4 a_Color;\nattribute float a_Texcoord0X;\nattribute float a_Texcoord0Y;\nattribute float a_BirthTime;\n\nuniform mat4 u_View;\nuniform mat4 u_Projection;\n\nuniform vec4 u_TilingOffset;\n\nuniform float u_CurTime;\nuniform float u_LifeTime;\nuniform vec4 u_WidthCurve[10];\nuniform int u_WidthCurveKeyLength;\n\nvarying vec2 v_Texcoord0;\nvarying vec4 v_Color;\n\nfloat hermiteInterpolate(float t, float outTangent, float inTangent, float duration, float value1, float value2)\n{\n\tfloat t2 = t * t;\n\tfloat t3 = t2 * t;\n\tfloat a = 2.0 * t3 - 3.0 * t2 + 1.0;\n\tfloat b = t3 - 2.0 * t2 + t;\n\tfloat c = t3 - t2;\n\tfloat d = -2.0 * t3 + 3.0 * t2;\n\treturn a * value1 + b * outTangent * duration + c * inTangent * duration + d * value2;\n}\n\nfloat getCurWidth(in float normalizeTime)\n{\n\tfloat width;\n\tif(normalizeTime == 0.0){\n\t\twidth=u_WidthCurve[0].w;\n\t}\n\telse if(normalizeTime >= 1.0){\n\t\twidth=u_WidthCurve[u_WidthCurveKeyLength - 1].w;\n\t}\n\telse{\n\t\tfor(int i = 0; i < 10; i ++ )\n\t\t{\n\t\t\tif(normalizeTime == u_WidthCurve[i].x){\n\t\t\t\twidth=u_WidthCurve[i].w;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\t\n\t\t\tvec4 lastFrame = u_WidthCurve[i];\n\t\t\tvec4 nextFrame = u_WidthCurve[i + 1];\n\t\t\tif(normalizeTime > lastFrame.x && normalizeTime < nextFrame.x)\n\t\t\t{\n\t\t\t\tfloat duration = nextFrame.x - lastFrame.x;\n\t\t\t\tfloat t = (normalizeTime - lastFrame.x) / duration;\n\t\t\t\tfloat outTangent = lastFrame.z;\n\t\t\t\tfloat inTangent = nextFrame.y;\n\t\t\t\tfloat value1 = lastFrame.w;\n\t\t\t\tfloat value2 = nextFrame.w;\n\t\t\t\twidth=hermiteInterpolate(t, outTangent, inTangent, duration, value1, value2);\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t}\n\treturn width;\n}\t\n\nvoid main()\n{\n\tfloat normalizeTime = (u_CurTime - a_BirthTime) / u_LifeTime;\n\t\n\tv_Texcoord0 = vec2(a_Texcoord0X, 1.0 - a_Texcoord0Y) * u_TilingOffset.xy + u_TilingOffset.zw;\n\t\n\tv_Color = a_Color;\n\t\n\tvec3 cameraPos = (u_View*vec4(a_Position,1.0)).rgb;\n\tgl_Position = u_Projection * vec4(cameraPos+a_OffsetVector * getCurWidth(normalizeTime),1.0);\n\n\tgl_Position=remapGLPositionZ(gl_Position);\n}\n',"#if defined(GL_FRAGMENT_PRECISION_HIGH)// 原来的写法会被我们自己的解析流程处理，而我们的解析是不认内置宏的，导致被删掉，所以改成 if defined 了\n\tprecision highp float;\n#else\n\tprecision mediump float;\n#endif\n\nuniform sampler2D u_MainTexture;\nuniform vec4 u_MainColor;\n\nvarying vec2 v_Texcoord0;\nvarying vec4 v_Color;\n\nvoid main()\n{\n\tvec4 color = 2.0 * u_MainColor * v_Color;\n\t#ifdef MAINTEXTURE\n\t\tvec4 mainTextureColor = texture2D(u_MainTexture, v_Texcoord0);\n\t\tcolor *= mainTextureColor;\n\t#endif\n\tgl_FragColor = color;\n}\n\n     ",n),e={a_Position:Ne.MESH_POSITION0,a_Normal:Ne.MESH_NORMAL0,a_Tangent0:Ne.MESH_TANGENT0},t={u_MvpMatrix:_e.PERIOD_SPRITE,u_WorldMat:_e.PERIOD_SPRITE,u_CameraPos:_e.PERIOD_CAMERA,u_Time:_e.PERIOD_SCENE,u_MainTexture:_e.PERIOD_MATERIAL,u_NormalTexture:_e.PERIOD_MATERIAL,u_HorizonColor:_e.PERIOD_MATERIAL,u_WaveScale:_e.PERIOD_MATERIAL,u_WaveSpeed:_e.PERIOD_MATERIAL},i=_e.add("WaterPrimary"),a=new Tn(e,t),i.addSubShader(a),a.addShaderPass('#include "Lighting.glsl";\n\nattribute vec4 a_Position;\nattribute vec3 a_Normal;\nattribute vec4 a_Tangent0;\n\nuniform mat4 u_MvpMatrix;\nuniform mat4 u_WorldMat;\nuniform vec3 u_CameraPos;\nuniform float u_WaveScale;\nuniform vec4 u_WaveSpeed;\nuniform float u_Time;\n\nvarying vec3 v_Normal;\nvarying vec3 v_Tangent;\nvarying vec3 v_Binormal;\nvarying vec3 v_ViewDir;\nvarying vec2 v_Texcoord0;\nvarying vec2 v_Texcoord1;\n\nvoid main()\n{\n\tvec4 positionWorld = u_WorldMat * a_Position;\n\tvec4 position = u_MvpMatrix * a_Position;\n\t\n\tvec4 temp = vec4(positionWorld.x, positionWorld.z, positionWorld.x, positionWorld.z) * u_WaveScale + u_WaveSpeed * u_WaveScale * u_Time;\n\t\n\tv_Texcoord0 = temp.xy * vec2(0.4, 0.45);\n\tv_Texcoord1 = temp.wz;\n\t\n\tmat3 worldMat = mat3(u_WorldMat);\n\tv_Normal = worldMat * a_Normal;\n\tv_Tangent = worldMat * a_Tangent0.xyz;\n\tv_Binormal = cross(v_Normal, v_Tangent) * a_Tangent0.w;\n\t\n\tv_ViewDir = u_CameraPos - positionWorld.xyz;\n\tgl_Position = position;\n\tgl_Position=remapGLPositionZ(gl_Position);\n}','#if defined(GL_FRAGMENT_PRECISION_HIGH)// 原来的写法会被我们自己的解析流程处理，而我们的解析是不认内置宏的，导致被删掉，所以改成 if defined 了\n\tprecision highp float;\n#else\n\tprecision mediump float;\n#endif\n\n#ifdef MAINTEXTURE\n\tuniform sampler2D u_MainTexture;\n#endif\n\n#ifdef NORMALTEXTURE\n\tuniform sampler2D u_NormalTexture;\n#endif\n\nuniform vec4 u_HorizonColor;\n\nvarying vec3 v_Normal;\nvarying vec3 v_Tangent;\nvarying vec3 v_Binormal;\nvarying vec3 v_ViewDir;\nvarying vec2 v_Texcoord0;\nvarying vec2 v_Texcoord1;\n\n\n#include "Lighting.glsl"\n\n\n\nvec3 NormalSampleToWorldSpace(vec4 normalMapSample) {\n\tvec3 normalT;\n\tnormalT.x = 2.0 * normalMapSample.x - 1.0;\n\tnormalT.y = 1.0 - 2.0 * normalMapSample.y;\n\tnormalT.z = sqrt(1.0 - clamp(dot(normalT.xy, normalT.xy), 0.0, 1.0));\n\n\tvec3 bumpedNormal = normalize(normalT);\n\n\treturn bumpedNormal;\n}\n\n\nvoid main()\n{\n\tvec4 bumpColor1 = texture2D(u_NormalTexture, v_Texcoord0);\n\tvec4 bumpColor2 = texture2D(u_NormalTexture, v_Texcoord1);\n\n\tvec3 normal1 = NormalSampleToWorldSpace(bumpColor1);\n\tvec3 normal2 = NormalSampleToWorldSpace(bumpColor2);\n\t\n\tvec3 normal = normalize((normal1 + normal2) * 0.5);\n\tvec3 viewDir = normalize(v_ViewDir);\n\tfloat fresnel = dot(viewDir, normal);\n\t\n\tvec4 waterColor = texture2D(u_MainTexture, vec2(fresnel, fresnel));\n\t\n\tvec4 color;\n\tcolor.rgb = mix(waterColor.rgb, u_HorizonColor.rgb, vec3(waterColor.a));\n\tcolor.a = u_HorizonColor.a;\n\t\n\tgl_FragColor = color;\n}\n\n\n'),e={a_PositionTexcoord:Ne.MESH_POSITION0},t={u_MainTex:_e.PERIOD_MATERIAL,u_OffsetScale:_e.PERIOD_MATERIAL},i=_e.add("BlitScreen"),a=new Tn(e,t),i.addSubShader(a);var r=a.addShaderPass('#include "Lighting.glsl";\n#if defined(GL_FRAGMENT_PRECISION_HIGH)// 原来的写法会被我们自己的解析流程处理，而我们的解析是不认内置宏的，导致被删掉，所以改成 if defined 了\n\tprecision highp float;\n#else\n\tprecision mediump float;\n#endif\nattribute vec4 a_PositionTexcoord;\nuniform vec4 u_OffsetScale;\nvarying vec2 v_Texcoord0;\n\nvoid main() {\t\n\tgl_Position = vec4(u_OffsetScale.x*2.0-1.0+(a_PositionTexcoord.x+1.0)*u_OffsetScale.z,(1.0-((u_OffsetScale.y*2.0-1.0+(-a_PositionTexcoord.y+1.0)*u_OffsetScale.w)+1.0)/2.0)*2.0-1.0, 0.0, 1.0);\t\n\tv_Texcoord0 = a_PositionTexcoord.zw;\n\tgl_Position = remapGLPositionZ(gl_Position);\n}',"#if defined(GL_FRAGMENT_PRECISION_HIGH)// 原来的写法会被我们自己的解析流程处理，而我们的解析是不认内置宏的，导致被删掉，所以改成 if defined 了\n\tprecision highp float;\n#else\n\tprecision mediump float;\n#endif\n\nuniform sampler2D u_MainTex;\nvarying vec2 v_Texcoord0;\n\nvoid main() {\n\tgl_FragColor = texture2D(u_MainTex, v_Texcoord0);\n}\n\n").renderState;r.depthTest=ut.DEPTHTEST_ALWAYS,r.depthWrite=!1,r.cull=ut.CULL_NONE,r.blend=ut.BLEND_DISABLE,e={a_PositionTexcoord:Ne.MESH_POSITION0},t={u_MainTex:_e.PERIOD_MATERIAL,u_BloomTex:_e.PERIOD_MATERIAL,u_AutoExposureTex:_e.PERIOD_MATERIAL,u_MainTex_TexelSize:_e.PERIOD_MATERIAL,u_SampleScale:_e.PERIOD_MATERIAL,u_Threshold:_e.PERIOD_MATERIAL,u_Params:_e.PERIOD_MATERIAL},i=_e.add("PostProcessBloom"),a=new Tn(e,t),i.addSubShader(a),(r=a.addShaderPass(Ii,'#if defined(GL_FRAGMENT_PRECISION_HIGH)// 原来的写法会被我们自己的解析流程处理，而我们的解析是不认内置宏的，导致被删掉，所以改成 if defined 了\n\tprecision highp float;\n#else\n\tprecision mediump float;\n#endif\n\n#include "Colors.glsl";\n#include "Sampling.glsl";\n\nvarying vec2 v_Texcoord0;\n\nuniform sampler2D u_MainTex;\nuniform sampler2D u_AutoExposureTex;\nuniform vec4 u_MainTex_TexelSize;\nuniform vec4 u_Threshold; // x: threshold value (linear), y: threshold - knee, z: knee * 2, w: 0.25 / knee\nuniform vec4 u_Params; // x: clamp, yzw: unused\n\nmediump vec4 prefilter(mediump vec4 color, vec2 uv) {\n\tmediump float autoExposure = texture2D(u_AutoExposureTex, uv).r;\n\tcolor *= autoExposure;\n\tcolor = min(vec4(u_Params.x), color); // clamp to max\n\tcolor = quadraticThreshold(color, u_Threshold.x, u_Threshold.yzw);\n\treturn color;\n}\n\nvoid fragPrefilter13() {\n\tmediump vec4 color = downsampleBox13Tap(u_MainTex, v_Texcoord0, u_MainTex_TexelSize.xy);\n\tgl_FragColor = prefilter(safeHDR(color), v_Texcoord0);\n}\n\nvoid main() {\n\tfragPrefilter13();\n}').renderState).depthTest=ut.DEPTHTEST_ALWAYS,r.depthWrite=!1,r.cull=ut.CULL_NONE,r.blend=ut.BLEND_DISABLE,a=new Tn(e,t),i.addSubShader(a),(r=a.addShaderPass(Ii,'#if defined(GL_FRAGMENT_PRECISION_HIGH)// 原来的写法会被我们自己的解析流程处理，而我们的解析是不认内置宏的，导致被删掉，所以改成 if defined 了\n\tprecision highp float;\n#else\n\tprecision mediump float;\n#endif\n\n#include "Colors.glsl";\n#include "Sampling.glsl";\n\nvarying vec2 v_Texcoord0;\n\nuniform sampler2D u_MainTex;\nuniform sampler2D u_AutoExposureTex;\nuniform vec4 u_MainTex_TexelSize;\nuniform vec4 u_Threshold; // x: threshold value (linear), y: threshold - knee, z: knee * 2, w: 0.25 / knee\nuniform vec4 u_Params; // x: clamp, yzw: unused\n\nmediump vec4 prefilter(mediump vec4 color, vec2 uv) {\n\tmediump float autoExposure = texture2D(u_AutoExposureTex, uv).r;\n\tcolor *= autoExposure;\n\tcolor = min(vec4(u_Params.x), color); // clamp to max\n\tcolor = quadraticThreshold(color, u_Threshold.x, u_Threshold.yzw);\n\treturn color;\n}\n\nvoid fragPrefilter4() {\n\tmediump vec4 color = downsampleBox4Tap(u_MainTex, v_Texcoord0, u_MainTex_TexelSize.xy);\n\tgl_FragColor = prefilter(safeHDR(color), v_Texcoord0);\n}\n\nvoid main() {\n\tfragPrefilter4();\n}').renderState).depthTest=ut.DEPTHTEST_ALWAYS,r.depthWrite=!1,r.cull=ut.CULL_NONE,r.blend=ut.BLEND_DISABLE,a=new Tn(e,t),i.addSubShader(a),(r=a.addShaderPass(Ii,'#if defined(GL_FRAGMENT_PRECISION_HIGH)// 原来的写法会被我们自己的解析流程处理，而我们的解析是不认内置宏的，导致被删掉，所以改成 if defined 了\n\tprecision highp float;\n#else\n\tprecision mediump float;\n#endif\n\n#include "Colors.glsl";\n#include "Sampling.glsl";\n\nvarying vec2 v_Texcoord0;\n\nuniform sampler2D u_MainTex;\nuniform vec4 u_MainTex_TexelSize;\n\nvoid fragDownsample13() {\n\tmediump vec4 color = downsampleBox13Tap(u_MainTex, v_Texcoord0, u_MainTex_TexelSize.xy);\n\tgl_FragColor = color;\n}\n\nvoid main() {\n\tfragDownsample13();\n}').renderState).depthTest=ut.DEPTHTEST_ALWAYS,r.depthWrite=!1,r.cull=ut.CULL_NONE,r.blend=ut.BLEND_DISABLE,a=new Tn(e,t),i.addSubShader(a),(r=a.addShaderPass(Ii,'#if defined(GL_FRAGMENT_PRECISION_HIGH)// 原来的写法会被我们自己的解析流程处理，而我们的解析是不认内置宏的，导致被删掉，所以改成 if defined 了\n\tprecision highp float;\n#else\n\tprecision mediump float;\n#endif\n\n#include "Colors.glsl";\n#include "Sampling.glsl";\n\nvarying vec2 v_Texcoord0;\n\nuniform sampler2D u_MainTex;\nuniform vec4 u_MainTex_TexelSize;\n\nvoid fragDownsample4() {\n\tmediump vec4 color = downsampleBox4Tap(u_MainTex, v_Texcoord0, u_MainTex_TexelSize.xy);\n\tgl_FragColor = color;\n}\n\nvoid main() {\n\tfragDownsample4();\n}').renderState).depthTest=ut.DEPTHTEST_ALWAYS,r.depthWrite=!1,r.cull=ut.CULL_NONE,r.blend=ut.BLEND_DISABLE,a=new Tn(e,t),i.addSubShader(a),(r=a.addShaderPass(Ii,'#if defined(GL_FRAGMENT_PRECISION_HIGH)// 原来的写法会被我们自己的解析流程处理，而我们的解析是不认内置宏的，导致被删掉，所以改成 if defined 了\n\tprecision highp float;\n#else\n\tprecision mediump float;\n#endif\n\n#include "Colors.glsl";\n#include "Sampling.glsl";\n\nvarying vec2 v_Texcoord0;\n\nuniform sampler2D u_MainTex;\nuniform sampler2D u_BloomTex;\n\nuniform vec4 u_MainTex_TexelSize;\nuniform float u_SampleScale;\n\nmediump vec4 combine(mediump vec4 bloom, vec2 uv) {\n\tmediump vec4 color = texture2D(u_BloomTex, uv);\n\treturn bloom + color;\n}\n\nvoid fragUpsampleTent() {\n\tmediump vec4 bloom = upsampleTent(u_MainTex, v_Texcoord0, u_MainTex_TexelSize.xy, vec4(u_SampleScale));\n\tgl_FragColor = combine(bloom, v_Texcoord0);\n}\n\nvoid main() {\n\tfragUpsampleTent();\n}').renderState).depthTest=ut.DEPTHTEST_ALWAYS,r.depthWrite=!1,r.cull=ut.CULL_NONE,r.blend=ut.BLEND_DISABLE,a=new Tn(e,t),i.addSubShader(a),(r=a.addShaderPass(Ii,'#if defined(GL_FRAGMENT_PRECISION_HIGH)// 原来的写法会被我们自己的解析流程处理，而我们的解析是不认内置宏的，导致被删掉，所以改成 if defined 了\n\tprecision highp float;\n#else\n\tprecision mediump float;\n#endif\n\n#include "Colors.glsl";\n#include "Sampling.glsl";\n\nvarying vec2 v_Texcoord0;\n\nuniform sampler2D u_MainTex;\nuniform sampler2D u_BloomTex;\n\nuniform vec4 u_MainTex_TexelSize;\nuniform float u_SampleScale;\n\nmediump vec4 combine(mediump vec4 bloom, vec2 uv) {\n\tmediump vec4 color = texture2D(u_BloomTex, uv);\n\treturn bloom + color;\n}\n\nvoid fragUpsampleBox() {\n\tmediump vec4 bloom = upsampleBox(u_MainTex, v_Texcoord0, u_MainTex_TexelSize.xy, vec4(u_SampleScale));\n\tgl_FragColor = combine(bloom, v_Texcoord0);\n}\n\nvoid main() {\n\tfragUpsampleBox();\n}').renderState).depthTest=ut.DEPTHTEST_ALWAYS,r.depthWrite=!1,r.cull=ut.CULL_NONE,r.blend=ut.BLEND_DISABLE,e={a_PositionTexcoord:Ne.MESH_POSITION0},t={u_MainTex:_e.PERIOD_MATERIAL,u_BloomTex:_e.PERIOD_MATERIAL,u_AutoExposureTex:_e.PERIOD_MATERIAL,u_Bloom_DirtTileOffset:_e.PERIOD_MATERIAL,u_Bloom_DirtTex:_e.PERIOD_MATERIAL,u_BloomTex_TexelSize:_e.PERIOD_MATERIAL,u_Bloom_Settings:_e.PERIOD_MATERIAL,u_Bloom_Color:_e.PERIOD_MATERIAL},i=_e.add("PostProcessComposite"),a=new Tn(e,t),i.addSubShader(a),(r=a.addShaderPass('#include "Lighting.glsl";\n\nattribute vec4 a_PositionTexcoord;\nvarying vec2 v_Texcoord0;\n\nvoid main() {\n\tgl_Position = vec4(a_PositionTexcoord.xy, 0.0, 1.0);\n\tv_Texcoord0 = a_PositionTexcoord.zw;\n\tgl_Position = remapGLPositionZ(gl_Position);\n}','#if defined(GL_FRAGMENT_PRECISION_HIGH)// 原来的写法会被我们自己的解析流程处理，而我们的解析是不认内置宏的，导致被删掉，所以改成 if defined 了\n\tprecision highp float;\n#else\n\tprecision mediump float;\n#endif\n\n#include "Colors.glsl";\n#include "Sampling.glsl";\n\nvarying vec2 v_Texcoord0;\n\nuniform sampler2D u_MainTex;\nuniform sampler2D u_BloomTex;\n\nuniform sampler2D u_AutoExposureTex;\nuniform sampler2D u_Bloom_DirtTex;\nuniform vec4 u_BloomTex_TexelSize;\nuniform vec4 u_Bloom_DirtTileOffset; // xy: tiling, zw: offset\nuniform mediump vec3 u_Bloom_Settings;// x: sampleScale, y: intensity, z: dirt intensity\nuniform mediump vec3 u_Bloom_Color;\n\nvoid main() {\n\tmediump float autoExposure = texture2D(u_AutoExposureTex, v_Texcoord0).r;\n\tmediump vec4 color=vec4(0.0);\n\tcolor = texture2D(u_MainTex, v_Texcoord0);\n\t\n\tcolor = sRGBToLinear(color);\n\tcolor.rgb *= autoExposure;\n\t\n\t#if defined(BLOOM)||defined(BLOOM_LOW)\n\t\t#ifdef BLOOM\n\t\t\tmediump vec4 bloom = upsampleTent(u_BloomTex, v_Texcoord0, u_BloomTex_TexelSize.xy, vec4(u_Bloom_Settings.x));\n\t\t#else\n\t\t\tmediump vec4 bloom = upsampleBox(u_BloomTex, v_Texcoord0, u_BloomTex_TexelSize.xy, vec4(u_Bloom_Settings.x));\n\t\t#endif\n\n\t\t// UVs should be Distort(uv * u_Bloom_DirtTileOffset.xy + u_Bloom_DirtTileOffset.zw)\n\t\t// but considering we use a cover-style scale on the dirt texture the difference\n\t\t// isn\'t massive so we chose to save a few ALUs here instead in case lens distortion\n\t\t// is active\n\t\tmediump vec4 dirt =vec4(texture2D(u_Bloom_DirtTex, v_Texcoord0 * u_Bloom_DirtTileOffset.xy + u_Bloom_DirtTileOffset.zw).rgb, 0.0);\n\n\t\t// Additive bloom (artist friendly)\n\t\tbloom *= u_Bloom_Settings.y;\n\t\tdirt *= u_Bloom_Settings.z;\n\t\tmediump vec4 bloomColor=vec4(u_Bloom_Color, 1.0);\n\t\tcolor += bloom * bloomColor;\n\t\tcolor += dirt * bloom;\n\t#endif\n\t\n\tmediump vec4 finalColor = color;\n\tfinalColor = linearToSRGB(finalColor);\n\t//finalColor.rgb = Dither(finalColor.rgb, v_Texcoord0);//TODO:抖动\n\tgl_FragColor = finalColor;\n}').renderState).depthTest=ut.DEPTHTEST_ALWAYS,r.depthWrite=!1,r.cull=ut.CULL_NONE,r.blend=ut.BLEND_DISABLE}}]),ShaderInit3D}(),Pi=function(t){function DirectionLight(){var t;return _classCallCheck(this,DirectionLight),(t=_possibleConstructorReturn(this,_getPrototypeOf(DirectionLight).call(this)))._direction=new o,t._shadowCascadesMode=e.ShadowCascadesMode.NoCascades,t._shadowTwoCascadeSplits=1/3,t._shadowFourCascadeSplits=new o(1/15,.2,7/15),t._lightType=e.LightType.Directional,t}return _inherits(DirectionLight,ze),_createClass(DirectionLight,[{key:"_addToLightQueue",value:function(){this._scene._directionLights.add(this)}},{key:"_removeFromLightQueue",value:function(){this._scene._directionLights.remove(this)}},{key:"_create",value:function(){return new DirectionLight}},{key:"shadowCascadesMode",get:function(){return this._shadowCascadesMode},set:function(e){this._shadowCascadesMode=e}},{key:"shadowTwoCascadeSplits",get:function(){return this._shadowTwoCascadeSplits},set:function(e){this._shadowTwoCascadeSplits=e}},{key:"shadowFourCascadeSplits",get:function(){return this._shadowFourCascadeSplits},set:function(e){if(e.x>e.y||e.y>e.z||e.z>1)throw"DiretionLight:Invalid value.";e.cloneTo(this._shadowFourCascadeSplits)}}]),DirectionLight}(),Oi=function(t){function PointLight(){var t;return _classCallCheck(this,PointLight),(t=_possibleConstructorReturn(this,_getPrototypeOf(PointLight).call(this)))._range=6,t._lightType=e.LightType.Point,t}return _inherits(PointLight,ze),_createClass(PointLight,[{key:"_addToLightQueue",value:function(){this._scene._pointLights.add(this)}},{key:"_removeFromLightQueue",value:function(){this._scene._pointLights.remove(this)}},{key:"_parse",value:function(e,t){_get(_getPrototypeOf(PointLight.prototype),"_parse",this).call(this,e,t),this.range=e.range}},{key:"_cloneTo",value:function(t,n,i){_get(_getPrototypeOf(PointLight.prototype),"_cloneTo",this).call(this,t,n,i);var a=t;a.range=this.range,a._lightType=e.LightType.Point}},{key:"_create",value:function(){return new PointLight}},{key:"range",get:function(){return this._range},set:function(e){this._range=e}}]),PointLight}(),Ni=function(t){function SpotLight(){var t;return _classCallCheck(this,SpotLight),(t=_possibleConstructorReturn(this,_getPrototypeOf(SpotLight).call(this)))._spotAngle=30,t._range=10,t._direction=new o,t._lightType=e.LightType.Spot,t}return _inherits(SpotLight,ze),_createClass(SpotLight,[{key:"_addToLightQueue",value:function(){this._scene._spotLights.add(this)}},{key:"_removeFromLightQueue",value:function(){this._scene._spotLights.remove(this)}},{key:"_parse",value:function(e,t){_get(_getPrototypeOf(SpotLight.prototype),"_parse",this).call(this,e,t),this.range=e.range,this.spotAngle=e.spotAngle}},{key:"_cloneTo",value:function(e,t,n){_get(_getPrototypeOf(SpotLight.prototype),"_cloneTo",this).call(this,e,t,n);var i=e;i.range=this.range,i.spotAngle=this.spotAngle}},{key:"_create",value:function(){return new SpotLight}},{key:"spotAngle",get:function(){return this._spotAngle},set:function(e){this._spotAngle=Math.max(Math.min(e,179),0)}},{key:"range",get:function(){return this._range},set:function(e){this._range=e}}]),SpotLight}(),bi=function(e){function SimpleSkinnedMeshRenderer(e){var t;return _classCallCheck(this,SimpleSkinnedMeshRenderer),(t=_possibleConstructorReturn(this,_getPrototypeOf(SimpleSkinnedMeshRenderer).call(this,e)))._simpleAnimatorParams=new a,t._simpleAnimatorOffset=new i,t._shaderValues.addDefine(hi.SHADERDEFINE_SIMPLEBONE),t._shaderValues.addDefine(hi.SHADERDEFINE_BONE),t}return _inherits(SimpleSkinnedMeshRenderer,_i),_createClass(SimpleSkinnedMeshRenderer,[{key:"_computeAnimatorParamsData",value:function(){this._cacheMesh&&(this._simpleAnimatorParams.x=this._simpleAnimatorOffset.x,this._simpleAnimatorParams.y=Math.round(this._simpleAnimatorOffset.y)*this._bonesNums*4)}},{key:"_createRenderElement",value:function(){return new Wt}},{key:"_setCacheAnimator",value:function(e){this._cacheAnimator=e,this._shaderValues.addDefine(hi.SHADERDEFINE_SIMPLEBONE)}},{key:"_onMeshChange",value:function(e){_get(_getPrototypeOf(SimpleSkinnedMeshRenderer.prototype),"_onMeshChange",this).call(this,e),this._cacheMesh=e}},{key:"_renderUpdate",value:function(e,t){var n=e.renderElement;switch(n.renderType){case qe.RENDERTYPE_NORMAL:if(this._cacheAnimator){var i=this._cacheAnimator.owner.transform.worldMatrix;this._shaderValues.setMatrix4x4(ve.WORLDMATRIX,i)}else this._shaderValues.setMatrix4x4(ve.WORLDMATRIX,t.worldMatrix);this._computeAnimatorParamsData(),this._shaderValues.setVector(SimpleSkinnedMeshRenderer.SIMPLE_SIMPLEANIMATORPARAMS,this._simpleAnimatorParams);break;case qe.RENDERTYPE_INSTANCEBATCH:var a=zt.instance.instanceWorldMatrixData,r=n.instanceBatchElementList,o=r.elements,s=r.length;if(this._cacheAnimator)for(var l=0;l<s;l++){var u=o[l].render._cacheAnimator.owner._transform.worldMatrix;a.set(u.elements,16*l)}else for(l=0;l<s;l++)a.set(o[l]._transform.worldMatrix.elements,16*l);var c=zt.instance.instanceWorldMatrixBuffer;c.orphanStorage(),c.setData(a.buffer,0,0,16*s*4),this._shaderValues.addDefine($e.SHADERDEFINE_GPU_INSTANCE);var h=zt.instance.instanceSimpleAnimatorData;if(this._cacheAnimator)for(l=0;l<s;l++){var _=o[l].render;_._computeAnimatorParamsData();var d=_._simpleAnimatorParams,f=4*l;h[f]=d.x,h[f+1]=d.y}else for(l=0;l<s;l++)h[f]=0,h[f+1]=0;var m=zt.instance.instanceSimpleAnimatorBuffer;m.orphanStorage(),m.setData(h.buffer,0,0,4*s*4)}}},{key:"_renderUpdateWithCamera",value:function(e,t){var n=e.projectionViewMatrix;if(n)switch(e.renderElement.renderType){case qe.RENDERTYPE_NORMAL:if(this._cacheAnimator){var i=this._cacheAnimator.owner._transform.worldMatrix;c.multiply(n,i,this._projectionViewWorldMatrix),this._shaderValues.setMatrix4x4(ve.MVPMATRIX,this._projectionViewWorldMatrix)}else c.multiply(n,t.worldMatrix,this._projectionViewWorldMatrix),this._shaderValues.setMatrix4x4(ve.MVPMATRIX,this._projectionViewWorldMatrix)}}},{key:"_destroy",value:function(){this._cacheRootBone&&!this._cacheRootBone.destroyed&&this._cacheRootBone.transform.off(t.Event.TRANSFORM_CHANGED,this,this._onWorldMatNeedChange),this._simpleAnimatorTexture&&this._simpleAnimatorTexture._removeReference(),this._simpleAnimatorTexture=null}},{key:"simpleAnimatorTexture",get:function(){return this._simpleAnimatorTexture},set:function(e){this._simpleAnimatorTexture=e,this._simpleAnimatorTextureSize=e.width,this._shaderValues.setTexture(SimpleSkinnedMeshRenderer.SIMPLE_SIMPLEANIMATORTEXTURE,e),e._addReference(),this._shaderValues.setNumber(SimpleSkinnedMeshRenderer.SIMPLE_SIMPLEANIMATORTEXTURESIZE,this._simpleAnimatorTextureSize)}},{key:"simpleAnimatorOffset",get:function(){return this._simpleAnimatorOffset},set:function(e){e.cloneTo(this._simpleAnimatorOffset)}}]),SimpleSkinnedMeshRenderer}(),ki=function(e){function SimpleSkinnedMeshSprite3D(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return _classCallCheck(this,SimpleSkinnedMeshSprite3D),(e=_possibleConstructorReturn(this,_getPrototypeOf(SimpleSkinnedMeshSprite3D).call(this,n)))._meshFilter=new Dn(_assertThisInitialized(e)),e._render=new bi(_assertThisInitialized(e)),t&&(e._meshFilter.sharedMesh=t),e}return _inherits(SimpleSkinnedMeshSprite3D,Gt),_createClass(SimpleSkinnedMeshSprite3D,[{key:"_parse",value:function(e,n){_get(_getPrototypeOf(SimpleSkinnedMeshSprite3D.prototype),"_parse",this).call(this,e,n);var i=this.simpleSkinnedMeshRenderer,r=e.lightmapIndex;null!=r&&(i.lightmapIndex=r);var s,l=e.lightmapScaleOffset;if(l&&(i.lightmapScaleOffset=new a(l[0],l[1],l[2],l[3])),null!=e.enableRender&&(i.enable=e.enableRender),null!=e.receiveShadows&&(i.receiveShadow=e.receiveShadows),null!=e.castShadow&&(i.castShadow=e.castShadow),s=e.meshPath){var u=t.Loader.getRes(s);u&&(this.meshFilter.sharedMesh=u)}var c=e.materials;if(c){var h=i.sharedMaterials,_=c.length;h.length=_;for(var d=0;d<_;d++)h[d]=t.Loader.getRes(c[d].path);i.sharedMaterials=h}var f=e.boundBox,m=f.min,p=f.max;if(i.localBounds.setMin(new o(m[0],m[1],m[2])),i.localBounds.setMax(new o(p[0],p[1],p[2])),n){var T=e.rootBone;i.rootBone=n[T];var v,g=e.bones;for(d=0,v=g.length;d<v;d++)i.bones.push(n[g[d]]);i._bonesNums=e.bonesNums?e.bonesNums:i.bones.length}else e.rootBone&&i._setRootBone(e.rootBone);var E=e.animatorTexture;if(E){var y=t.Loader.getRes(E);i.simpleAnimatorTexture=y}}},{key:"_changeHierarchyAnimator",value:function(e){_get(_getPrototypeOf(SimpleSkinnedMeshSprite3D.prototype),"_changeHierarchyAnimator",this).call(this,e),this.simpleSkinnedMeshRenderer._setCacheAnimator(e)}},{key:"_cloneTo",value:function(e,t,n){var i=e;i.meshFilter.sharedMesh=this.meshFilter.sharedMesh;var a=this._render,r=i._render;r.enable=a.enable,r.sharedMaterials=a.sharedMaterials,r.castShadow=a.castShadow;var o=a.lightmapScaleOffset;o&&(r.lightmapScaleOffset=o.clone()),r.receiveShadow=a.receiveShadow,r.sortingFudge=a.sortingFudge,r._rootBone=a._rootBone;var s=a.bones,l=r.bones,u=s.length;l.length=u;var c=a.rootBone;if(c){var h=P._getHierarchyPath(t,c,SimpleSkinnedMeshSprite3D._tempArray0);r.rootBone=h?P._getNodeByHierarchyPath(n,h):c}for(var _=0;_<s.length;_++)h=P._getHierarchyPath(t,s[_],SimpleSkinnedMeshSprite3D._tempArray0),l[_]=h?P._getNodeByHierarchyPath(n,h):s[_];var d=a.localBounds;d&&d.cloneTo(r.localBounds),r.simpleAnimatorOffset=a.simpleAnimatorOffset,r.simpleAnimatorTexture=a.simpleAnimatorTexture,r._bonesNums=a._bonesNums,_get(_getPrototypeOf(SimpleSkinnedMeshSprite3D.prototype),"_cloneTo",this).call(this,e,t,n)}},{key:"destroy",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];this.destroyed||(_get(_getPrototypeOf(SimpleSkinnedMeshSprite3D.prototype),"destroy",this).call(this,e),this._meshFilter.destroy())}},{key:"_create",value:function(){return new SimpleSkinnedMeshSprite3D}},{key:"meshFilter",get:function(){return this._meshFilter}},{key:"simpleSkinnedMeshRenderer",get:function(){return this._render}}],[{key:"__init__",value:function(){bi.SIMPLE_SIMPLEANIMATORPARAMS=SimpleSkinnedMeshSprite3D.SIMPLE_SIMPLEANIMATORPARAMS,bi.SIMPLE_SIMPLEANIMATORTEXTURE=SimpleSkinnedMeshSprite3D.SIMPLE_SIMPLEANIMATORTEXTURE,bi.SIMPLE_SIMPLEANIMATORTEXTURESIZE=SimpleSkinnedMeshSprite3D.SIMPLE_SIMPLEANIMATORTEXTURESIZE}}]),SimpleSkinnedMeshSprite3D}();ki._tempArray0=[],ki.SIMPLE_SIMPLEANIMATORTEXTURE=_e.propertyNameToID("u_SimpleAnimatorTexture"),ki.SIMPLE_SIMPLEANIMATORPARAMS=_e.propertyNameToID("u_SimpleAnimatorParams"),ki.SIMPLE_SIMPLEANIMATORTEXTURESIZE=_e.propertyNameToID("u_SimpleAnimatorTextureSize");var wi=function(){function Scene3DUtils(){_classCallCheck(this,Scene3DUtils)}return _createClass(Scene3DUtils,null,[{key:"_createSprite3DInstance",value:function(e,t,n){var i;switch(e.type){case"Scene3D":i=new fn;break;case"Sprite3D":i=new ve;break;case"MeshSprite3D":i=new In,n&&e.props.isStatic&&n.push(i);break;case"SkinnedMeshSprite3D":i=new di;break;case"SimpleSkinnedMeshSprite3D":i=new ki;break;case"ShuriKenParticle3D":i=new ci;break;case"Camera":i=new Qe;break;case"DirectionLight":i=new Pi;break;case"PointLight":i=new Oi;break;case"SpotLight":i=new Ni;break;case"TrailSprite3D":i=new yi;break;case"ReflectionProbe":i=new Qt;break;default:throw new Error("Utils3D:unidentified class type in (.lh) file.")}var a=e.child;if(a)for(var r=0,o=a.length;r<o;r++){var s=Scene3DUtils._createSprite3DInstance(a[r],t,n);i.addChild(s)}return t[e.instanceID]=i,i}},{key:"_createComponentInstance",value:function(e,n,i){var a=n[e.instanceID];a._parse(e.props,n);var r=e.child;if(r)for(var o=0,s=r.length;o<s;o++)Scene3DUtils._createComponentInstance(r[o],n,i);var l=e.components;if(l)for(var u=0,c=l.length;u<c;u++){var h=l[u],_=t.ClassUtils.getRegClass(h.type);if(_)a.addComponent(_)._parse(h,i);else console.warn("Unkown component type.")}}},{key:"_createNodeByJson02",value:function(e,t){var n={},i={component:[],data:[]},a=Scene3DUtils._createSprite3DInstance(e,n,t);return Scene3DUtils._createComponentInstance(e,n,i),Scene3DUtils._createInteractInstance(i,n),a}},{key:"_createInteractInstance",value:function(e,t){for(var n=e.component,i=e.data,a=0,r=n.length;a<r;a++)n[a]._parseInteractive(i[a],t)}},{key:"_parse",value:function(e){arguments.length>1&&void 0!==arguments[1]&&arguments[1],arguments.length>2&&void 0!==arguments[2]&&arguments[2];var t,n=e.data,i=[];switch(e.version){case"LAYAHIERARCHY:02":t=Scene3DUtils._createNodeByJson02(n,i);break;default:t=Scene3DUtils._createNodeByJson(n,i)}return Xt.combine(t,i),t}},{key:"_parseScene",value:function(e){arguments.length>1&&void 0!==arguments[1]&&arguments[1],arguments.length>2&&void 0!==arguments[2]&&arguments[2];var t,n=e.data,i=[];switch(e.version){case"LAYASCENE3D:02":t=Scene3DUtils._createNodeByJson02(n,i);break;default:t=Scene3DUtils._createNodeByJson(n,i)}return Xt.combine(null,i),t}},{key:"_createNodeByJson",value:function(e,n){var i;switch(e.type){case"Scene3D":i=new fn;break;case"Sprite3D":i=new ve;break;case"MeshSprite3D":i=new In,n&&e.props.isStatic&&n.push(i);break;case"SkinnedMeshSprite3D":i=new di;break;case"ShuriKenParticle3D":i=new ci;break;case"Camera":i=new Qe;break;case"DirectionLight":i=new Pi;break;case"PointLight":i=new Oi;break;case"SpotLight":i=new Ni;break;case"TrailSprite3D":i=new yi;break;default:throw new Error("Utils3D:unidentified class type in (.lh) file.")}var a=e.child;if(a)for(var r=0,o=a.length;r<o;r++){var s=Scene3DUtils._createNodeByJson(a[r],n);i.addChild(s)}var l=e.components;if(l)for(var u=0,c=l.length;u<c;u++){var h=l[u],_=t.ClassUtils.getRegClass(h.type);if(_)i.addComponent(_)._parse(h);else console.warn("Unkown component type.")}return i._parse(e.props,null),i}}]),Scene3DUtils}(),Bi=function(){function LoadModelV04(){_classCallCheck(this,LoadModelV04)}return _createClass(LoadModelV04,null,[{key:"parse",value:function(e,t,n,i){LoadModelV04._mesh=n,LoadModelV04._subMeshes=i,LoadModelV04._version=t,LoadModelV04._readData=e,LoadModelV04.READ_DATA(),LoadModelV04.READ_BLOCK(),LoadModelV04.READ_STRINGS();for(var a=0,r=LoadModelV04._BLOCK.count;a<r;a++){LoadModelV04._readData.pos=LoadModelV04._BLOCK.blockStarts[a];var o=LoadModelV04._readData.getUint16(),s=LoadModelV04._strings[o],l=LoadModelV04["READ_"+s];if(null==l)throw new Error("model file err,no this function:"+o+" "+s);l.call(null)}LoadModelV04._strings.length=0,LoadModelV04._readData=null,LoadModelV04._version=null,LoadModelV04._mesh=null,LoadModelV04._subMeshes=null}},{key:"_readString",value:function(){return LoadModelV04._strings[LoadModelV04._readData.getUint16()]}},{key:"READ_DATA",value:function(){LoadModelV04._DATA.offset=LoadModelV04._readData.getUint32(),LoadModelV04._DATA.size=LoadModelV04._readData.getUint32()}},{key:"READ_BLOCK",value:function(){for(var e=LoadModelV04._BLOCK.count=LoadModelV04._readData.getUint16(),t=LoadModelV04._BLOCK.blockStarts=[],n=LoadModelV04._BLOCK.blockLengths=[],i=0;i<e;i++)t.push(LoadModelV04._readData.getUint32()),n.push(LoadModelV04._readData.getUint32())}},{key:"READ_STRINGS",value:function(){var e=LoadModelV04._readData.getUint32(),t=LoadModelV04._readData.getUint16(),n=LoadModelV04._readData.pos;LoadModelV04._readData.pos=e+LoadModelV04._DATA.offset;for(var i=0;i<t;i++)LoadModelV04._strings[i]=LoadModelV04._readData.readUTFString();LoadModelV04._readData.pos=n}},{key:"READ_MESH",value:function(){var n,i=t.LayaGL.instance,a=(LoadModelV04._readString(),LoadModelV04._readData.__getBuffer()),r=0,o=LoadModelV04._readData.getInt16(),s=LoadModelV04._DATA.offset;for(n=0;n<o;n++){var l,u=s+LoadModelV04._readData.getUint32(),h=LoadModelV04._readData.getUint32(),_=a.slice(u,u+h),d=new Float32Array(_),f=LoadModelV04._readString();switch(LoadModelV04._version){case"LAYAMODEL:0301":case"LAYAMODEL:0400":l=Ne.getVertexDeclaration(f);break;case"LAYAMODEL:0401":l=Ne.getVertexDeclaration(f,!1);break;default:throw new Error("LoadModelV03: unknown version.")}if(!l)throw new Error("LoadModelV03: unknown vertexDeclaration.");var m=new te(4*d.length,i.STATIC_DRAW,!0);m.vertexDeclaration=l,m.setData(d.buffer),LoadModelV04._mesh._vertexBuffer=m,LoadModelV04._mesh._vertexCount+=m._byteLength/l.vertexStride,r+=4*d.length}var p=s+LoadModelV04._readData.getUint32(),T=LoadModelV04._readData.getUint32(),v=new Uint16Array(a.slice(p,p+T)),g=new Oe(e.IndexFormat.UInt16,T/2,i.STATIC_DRAW,!0);g.setData(v),LoadModelV04._mesh._indexBuffer=g,r+=2*g.indexCount,LoadModelV04._mesh._setBuffer(LoadModelV04._mesh._vertexBuffer,g),LoadModelV04._mesh._setCPUMemory(r),LoadModelV04._mesh._setGPUMemory(r);var E=LoadModelV04._mesh._boneNames=[],y=LoadModelV04._readData.getUint16();for(E.length=y,n=0;n<y;n++)E[n]=LoadModelV04._strings[LoadModelV04._readData.getUint16()];LoadModelV04._readData.pos+=8;var S=LoadModelV04._readData.getUint32(),R=LoadModelV04._readData.getUint32(),C=new Float32Array(a.slice(s+S,s+S+R)),M=C.length,D=LoadModelV04._mesh._inverseBindPosesBuffer=new ArrayBuffer(4*M);for(LoadModelV04._mesh._inverseBindPoses=[],LoadModelV04._mesh._instanceBufferStateType=0!=M?xi.MESH_INSTANCEBUFFER_TYPE_SIMPLEANIMATOR:xi.MESH_INSTANCEBUFFER_TYPE_NORMAL,LoadModelV04._mesh._setInstanceBuffer(LoadModelV04._mesh._instanceBufferStateType),n=0;n<M;n+=16){var x=new c(C[n+0],C[n+1],C[n+2],C[n+3],C[n+4],C[n+5],C[n+6],C[n+7],C[n+8],C[n+9],C[n+10],C[n+11],C[n+12],C[n+13],C[n+14],C[n+15],new Float32Array(D,4*n,16));LoadModelV04._mesh._inverseBindPoses[n/16]=x}return!0}},{key:"READ_SUBMESH",value:function(){var e=LoadModelV04._readData.__getBuffer(),t=new Mi(LoadModelV04._mesh);LoadModelV04._readData.getInt16(),LoadModelV04._readData.getUint32(),LoadModelV04._readData.getUint32();var n=LoadModelV04._readData.getUint32(),i=LoadModelV04._readData.getUint32(),a=LoadModelV04._mesh._indexBuffer;t._indexBuffer=a,t._setIndexRange(n,i);var r=LoadModelV04._mesh._vertexBuffer;t._vertexBuffer=r;var o=LoadModelV04._DATA.offset,s=t._subIndexBufferStart,l=t._subIndexBufferCount,u=t._boneIndicesList,c=LoadModelV04._readData.getUint16();s.length=c,l.length=c,u.length=c;var h=LoadModelV04._mesh._skinnedMatrixCaches,_=LoadModelV04._subMeshes.length;h.length=LoadModelV04._mesh._inverseBindPoses.length;for(var d=0;d<c;d++){s[d]=LoadModelV04._readData.getUint32(),l[d]=LoadModelV04._readData.getUint32();for(var f=LoadModelV04._readData.getUint32(),m=LoadModelV04._readData.getUint32(),p=u[d]=new Uint16Array(e.slice(o+f,o+f+m)),T=p.length,v=0;v<T;v++){var g=p[v];h[g]||(h[g]=new Di(_,d,v))}}return LoadModelV04._subMeshes.push(t),!0}}]),LoadModelV04}();Bi._BLOCK={count:0},Bi._DATA={offset:0,size:0},Bi._strings=[];var Vi=function(){function LoadModelV05(){_classCallCheck(this,LoadModelV05)}return _createClass(LoadModelV05,null,[{key:"parse",value:function(e,t,n,i){LoadModelV05._mesh=n,LoadModelV05._subMeshes=i,LoadModelV05._version=t,LoadModelV05._readData=e,LoadModelV05.READ_DATA(),LoadModelV05.READ_BLOCK(),LoadModelV05.READ_STRINGS();for(var a=0,r=LoadModelV05._BLOCK.count;a<r;a++){LoadModelV05._readData.pos=LoadModelV05._BLOCK.blockStarts[a];var o=LoadModelV05._readData.getUint16(),s=LoadModelV05._strings[o],l=LoadModelV05["READ_"+s];if(null==l)throw new Error("model file err,no this function:"+o+" "+s);l.call(null)}LoadModelV05._strings.length=0,LoadModelV05._readData=null,LoadModelV05._version=null,LoadModelV05._mesh=null,LoadModelV05._subMeshes=null}},{key:"_readString",value:function(){return LoadModelV05._strings[LoadModelV05._readData.getUint16()]}},{key:"READ_DATA",value:function(){LoadModelV05._DATA.offset=LoadModelV05._readData.getUint32(),LoadModelV05._DATA.size=LoadModelV05._readData.getUint32()}},{key:"READ_BLOCK",value:function(){for(var e=LoadModelV05._BLOCK.count=LoadModelV05._readData.getUint16(),t=LoadModelV05._BLOCK.blockStarts=[],n=LoadModelV05._BLOCK.blockLengths=[],i=0;i<e;i++)t.push(LoadModelV05._readData.getUint32()),n.push(LoadModelV05._readData.getUint32())}},{key:"READ_STRINGS",value:function(){var e=LoadModelV05._readData.getUint32(),t=LoadModelV05._readData.getUint16(),n=LoadModelV05._readData.pos;LoadModelV05._readData.pos=e+LoadModelV05._DATA.offset;for(var i=0;i<t;i++)LoadModelV05._strings[i]=LoadModelV05._readData.readUTFString();LoadModelV05._readData.pos=n}},{key:"READ_MESH",value:function(){var n,i=t.LayaGL.instance,a=0,r=(LoadModelV05._readString(),LoadModelV05._readData),o=r.__getBuffer(),s=r.getInt16(),l=LoadModelV05._DATA.offset;for(n=0;n<s;n++){var u,h,_,d=l+r.getUint32(),f=r.getUint32(),m=LoadModelV05._readString(),p=Ne.getVertexDeclaration(m,!1),T=p.vertexStride,v=m.split(","),g=v.length,E=LoadModelV05._mesh;switch(LoadModelV05._version){case"LAYAMODEL:05":case"LAYAMODEL:0501":u=o.slice(d,d+f*T),h=new Float32Array(u),_=new Uint8Array(u);break;case"LAYAMODEL:COMPRESSION_05":case"LAYAMODEL:COMPRESSION_0501":u=new ArrayBuffer(T*f),h=new Float32Array(u),_=new Uint8Array(u);var y=r.pos;r.pos=d;for(var S=0;S<f;S++)for(var R,C=S*T,M=0;M<g;M++)switch(v[M]){case"POSITION":h[R=C/4]=t.HalfFloatUtils.convertToNumber(r.getUint16()),h[R+1]=t.HalfFloatUtils.convertToNumber(r.getUint16()),h[R+2]=t.HalfFloatUtils.convertToNumber(r.getUint16()),C+=12;break;case"NORMAL":h[R=C/4]=r.getUint8()/127.5-1,h[R+1]=r.getUint8()/127.5-1,h[R+2]=r.getUint8()/127.5-1,C+=12;break;case"COLOR":h[R=C/4]=r.getUint8()/255,h[R+1]=r.getUint8()/255,h[R+2]=r.getUint8()/255,h[R+3]=r.getUint8()/255,C+=16;break;case"UV":case"UV1":h[R=C/4]=t.HalfFloatUtils.convertToNumber(r.getUint16()),h[R+1]=t.HalfFloatUtils.convertToNumber(r.getUint16()),C+=8;break;case"BLENDWEIGHT":h[R=C/4]=r.getUint8()/255,h[R+1]=r.getUint8()/255,h[R+2]=r.getUint8()/255,h[R+3]=r.getUint8()/255,C+=16;break;case"BLENDINDICES":_[C]=r.getUint8(),_[C+1]=r.getUint8(),_[C+2]=r.getUint8(),_[C+3]=r.getUint8(),C+=4;break;case"TANGENT":h[R=C/4]=r.getUint8()/127.5-1,h[R+1]=r.getUint8()/127.5-1,h[R+2]=r.getUint8()/127.5-1,h[R+3]=r.getUint8()/127.5-1,C+=16}r.pos=y}var D=new te(u.byteLength,i.STATIC_DRAW,!0);D.vertexDeclaration=p,D.setData(u);f=D._byteLength/p.vertexStride;E._indexFormat=f>65535?e.IndexFormat.UInt32:e.IndexFormat.UInt16,E._vertexBuffer=D,E._vertexCount+=f,a+=4*h.length}var x,A=l+r.getUint32(),I=r.getUint32();x=E.indexFormat==e.IndexFormat.UInt32?new Uint32Array(o.slice(A,A+I)):new Uint16Array(o.slice(A,A+I));var L=new Oe(E.indexFormat,x.length,i.STATIC_DRAW,!0);if(L.setData(x),E._indexBuffer=L,E._setBuffer(E._vertexBuffer,L),a+=2*L.indexCount,E._setCPUMemory(a),E._setGPUMemory(a),"LAYAMODEL:0501"==LoadModelV05._version||"LAYAMODEL:COMPRESSION_0501"==LoadModelV05._version){var P=E.bounds,O=P.getMin(),N=P.getMax();O.setValue(r.getFloat32(),r.getFloat32(),r.getFloat32()),N.setValue(r.getFloat32(),r.getFloat32(),r.getFloat32()),P.setMin(O),P.setMax(N),E.bounds=P}var b=E._boneNames=[],k=r.getUint16();for(b.length=k,n=0;n<k;n++)b[n]=LoadModelV05._strings[r.getUint16()];var w=r.getUint32(),B=r.getUint32(),V=new Float32Array(o.slice(l+w,l+w+B)),F=V.length,U=E._inverseBindPosesBuffer=new ArrayBuffer(4*F);for(E._inverseBindPoses=[],E._instanceBufferStateType=0!=F?xi.MESH_INSTANCEBUFFER_TYPE_SIMPLEANIMATOR:xi.MESH_INSTANCEBUFFER_TYPE_NORMAL,E._setInstanceBuffer(E._instanceBufferStateType),n=0;n<F;n+=16){var G=new c(V[n+0],V[n+1],V[n+2],V[n+3],V[n+4],V[n+5],V[n+6],V[n+7],V[n+8],V[n+9],V[n+10],V[n+11],V[n+12],V[n+13],V[n+14],V[n+15],new Float32Array(U,4*n,16));E._inverseBindPoses[n/16]=G}return!0}},{key:"READ_SUBMESH",value:function(){var e=LoadModelV05._readData,t=e.__getBuffer(),n=new Mi(LoadModelV05._mesh);e.getInt16();var i=e.getUint32(),a=e.getUint32(),r=LoadModelV05._mesh._indexBuffer;n._indexBuffer=r,n._setIndexRange(i,a);var o=LoadModelV05._mesh._vertexBuffer;n._vertexBuffer=o;var s=LoadModelV05._DATA.offset,l=n._subIndexBufferStart,u=n._subIndexBufferCount,c=n._boneIndicesList,h=e.getUint16();l.length=h,u.length=h,c.length=h;var _=LoadModelV05._mesh._skinnedMatrixCaches,d=LoadModelV05._subMeshes.length;_.length=LoadModelV05._mesh._inverseBindPoses.length;for(var f=0;f<h;f++){l[f]=e.getUint32(),u[f]=e.getUint32();for(var m=e.getUint32(),p=e.getUint32(),T=c[f]=new Uint16Array(t.slice(s+m,s+m+p)),v=0,g=T.length;v<g;v++){var E=T[v];_[E]||(_[E]=new Di(d,f,v))}}return LoadModelV05._subMeshes.push(n),!0}}]),LoadModelV05}();Vi._BLOCK={count:0},Vi._DATA={offset:0,size:0},Vi._strings=[];var Fi=function(){function MeshReader(){_classCallCheck(this,MeshReader)}return _createClass(MeshReader,null,[{key:"_parse",value:function(e){arguments.length>1&&void 0!==arguments[1]&&arguments[1],arguments.length>2&&void 0!==arguments[2]&&arguments[2];var t=new xi;return MeshReader.read(e,t,t._subMeshes),t}},{key:"read",value:function(e,n,i){var a=new t.Byte(e);a.pos=0;var r=a.readUTFString();switch(r){case"LAYAMODEL:0301":case"LAYAMODEL:0400":case"LAYAMODEL:0401":Bi.parse(a,r,n,i);break;case"LAYAMODEL:05":case"LAYAMODEL:COMPRESSION_05":case"LAYAMODEL:0501":case"LAYAMODEL:COMPRESSION_0501":Vi.parse(a,r,n,i);break;default:throw new Error("MeshReader: unknown mesh version.")}n._setSubMeshes(i),"LAYAMODEL:0501"!=r&&"LAYAMODEL:COMPRESSION_0501"!=r&&n.calculateBounds()}}]),MeshReader}(),Ui=function(e){function SkyPanoramicMaterial(){var e;_classCallCheck(this,SkyPanoramicMaterial),(e=_possibleConstructorReturn(this,_getPrototypeOf(SkyPanoramicMaterial).call(this)))._exposure=1,e._textureDecodeFormat=t.TextureDecodeFormat.Normal,e._textureHDRParams=new a(1,0,0,1),e.setShaderName("SkyPanoramic");var n=e._shaderValues;return n.setVector(SkyPanoramicMaterial.TINTCOLOR,new a(.5,.5,.5,.5)),n.setNumber(SkyPanoramicMaterial.ROTATION,0),n.setVector(SkyPanoramicMaterial.TEXTURE_HDR_PARAMS,e._textureHDRParams),e}return _inherits(SkyPanoramicMaterial,st),_createClass(SkyPanoramicMaterial,[{key:"tintColor",get:function(){return this._shaderValues.getVector(SkyPanoramicMaterial.TINTCOLOR)},set:function(e){this._shaderValues.setVector(SkyPanoramicMaterial.TINTCOLOR,e)}},{key:"exposure",get:function(){return this._exposure},set:function(e){this._exposure!==e&&(this._exposure=e,this._textureDecodeFormat==t.TextureDecodeFormat.RGBM?this._textureHDRParams.x=e*t.BaseTexture._rgbmRange:this._textureHDRParams.x=e)}},{key:"rotation",get:function(){return this._shaderValues.getNumber(SkyPanoramicMaterial.ROTATION)},set:function(e){this._shaderValues.setNumber(SkyPanoramicMaterial.ROTATION,e)}},{key:"panoramicTexture",get:function(){return this._shaderValues.getTexture(SkyPanoramicMaterial.TEXTURE)},set:function(e){this._shaderValues.setTexture(SkyPanoramicMaterial.TEXTURE,e)}},{key:"panoramicTextureDecodeFormat",get:function(){return this._textureDecodeFormat},set:function(e){this._textureDecodeFormat!==e&&(this._textureDecodeFormat=e,e==t.TextureDecodeFormat.RGBM?this._textureHDRParams.x=this._exposure*t.BaseTexture._rgbmRange:this._textureHDRParams.x=this._exposure)}}],[{key:"__init__",value:function(){var e={a_Position:Ne.MESH_POSITION0},t={u_TintColor:_e.PERIOD_MATERIAL,u_TextureHDRParams:_e.PERIOD_MATERIAL,u_Rotation:_e.PERIOD_MATERIAL,u_Texture:_e.PERIOD_MATERIAL,u_ViewProjection:_e.PERIOD_CAMERA},n=_e.add("SkyPanoramic"),i=new Tn(e,t);n.addSubShader(i),i.addShaderPass('#include "Lighting.glsl";\n\n#define PI 3.14159265359\n\nattribute vec4 a_Position;\n\nuniform mat4 u_ViewProjection;\nuniform float u_Rotation;\n\nvarying vec3 v_Texcoord;\nvarying vec2 v_Image180ScaleAndCutoff;\nvarying vec4 v_Layout3DScaleAndOffset;\n\nvec4 rotateAroundYInDegrees (vec4 vertex, float degrees)\n{\n\tfloat angle = degrees * PI / 180.0;\n\tfloat sina=sin(angle);\n\tfloat cosa=cos(angle);\n\tmat2 m = mat2(cosa, -sina, sina, cosa);\n\treturn vec4(m*vertex.xz, vertex.yw).xzyw;\n}\n\n\t\t\nvoid main()\n{\n\tvec4 position = rotateAroundYInDegrees(a_Position, u_Rotation);\n\tgl_Position = u_ViewProjection*position;\n\n\tv_Texcoord=vec3(-a_Position.x,-a_Position.y,a_Position.z);// NOTE: -a_Position.x convert coords system\n\n\t// Calculate constant horizontal scale and cutoff for 180 (vs 360) image type\n\tv_Image180ScaleAndCutoff = vec2(1.0, 1.0);// 360 degree mode\n\n\t// Calculate constant scale and offset for 3D layouts\n\tv_Layout3DScaleAndOffset = vec4(0,0,1,1);\n}\n','#if defined(GL_FRAGMENT_PRECISION_HIGH)// 原来的写法会被我们自己的解析流程处理，而我们的解析是不认内置宏的，导致被删掉，所以改成 if defined 了\n\tprecision highp float;\n#else\n\tprecision mediump float;\n#endif\n\n#define PI 3.14159265359\n#include "Lighting.glsl";\n\nuniform sampler2D u_Texture;\nuniform vec4 u_TextureHDRParams;\nuniform vec4 u_TintColor;\n\nvarying vec3 v_Texcoord;\nvarying vec2 v_Image180ScaleAndCutoff;\nvarying vec4 v_Layout3DScaleAndOffset;\n\nvec2 ToRadialCoords(vec3 coords)\n{\n\tvec3 normalizedCoords = normalize(coords);\n\tfloat latitude = acos(normalizedCoords.y);\n\tfloat longitude = atan(normalizedCoords.z,normalizedCoords.x);\n\tvec2 sphereCoords = vec2(longitude, latitude) * vec2(0.5/PI, 1.0/PI);\n\treturn vec2(0.5,1.0) - sphereCoords;\n}\n\n\nvoid main()\n{\t\n\tvec2 tc = ToRadialCoords(v_Texcoord);\n\tif (tc.x > v_Image180ScaleAndCutoff.y)\n\t\tgl_FragColor=vec4(0,0,0,1);\n\ttc.x = mod(tc.x*v_Image180ScaleAndCutoff.x, 1.0);\n\ttc = (tc + v_Layout3DScaleAndOffset.xy) * v_Layout3DScaleAndOffset.zw;\n\n\tmediump vec4 tex = texture2D (u_Texture, tc);\n\tmediump vec3 c = decodeHDR (tex, u_TextureHDRParams.x);\n\tc = c * u_TintColor.rgb * 2.0;//Gamma Space is 2.0,linear space is 4.59479380\n\tgl_FragColor=vec4(c, 1.0);\n}\n\n')}}]),SkyPanoramicMaterial}();Ui.TINTCOLOR=_e.propertyNameToID("u_TintColor"),Ui.EXPOSURE=_e.propertyNameToID("u_Exposure"),Ui.ROTATION=_e.propertyNameToID("u_Rotation"),Ui.TEXTURE=_e.propertyNameToID("u_Texture"),Ui.TEXTURE_HDR_PARAMS=_e.propertyNameToID("u_TextureHDRParams");var Gi=function(e){function ConstraintComponent(e){var t;_classCallCheck(this,ConstraintComponent),(t=_possibleConstructorReturn(this,_getPrototypeOf(ConstraintComponent).call(this)))._anchor=new o,t._connectAnchor=new o,t._feedbackEnabled=!1,t._getJointFeedBack=!1,t._currentForce=new o,t._currentTorque=new o,t._constraintType=e;var n=k._bullet;return t._btframATrans=n.btTransform_create(),t._btframBTrans=n.btTransform_create(),n.btTransform_setIdentity(t._btframATrans),n.btTransform_setIdentity(t._btframBTrans),t._btframAPos=n.btVector3_create(0,0,0),t._btframBPos=n.btVector3_create(0,0,0),n.btTransform_setOrigin(t._btframATrans,t._btframAPos),n.btTransform_setOrigin(t._btframBTrans,t._btframBPos),t._breakForce=-1,t._breakTorque=-1,t}return _inherits(ConstraintComponent,t.Component),_createClass(ConstraintComponent,[{key:"setOverrideNumSolverIterations",value:function(e){k._bullet.btTypedConstraint_setOverrideNumSolverIterations(this._btConstraint,e)}},{key:"setConstraintEnabled",value:function(e){k._bullet.btTypedConstraint_setEnabled(this._btConstraint,e)}},{key:"_onEnable",value:function(){_get(_getPrototypeOf(ConstraintComponent.prototype),"_onEnable",this).call(this),this.enabled=!0}},{key:"_onDisable",value:function(){_get(_getPrototypeOf(ConstraintComponent.prototype),"_onDisable",this).call(this),this.enabled=!1}},{key:"setFrames",value:function(){var e=k._bullet;e.btVector3_setValue(this._btframAPos,-this._anchor.x,this.anchor.y,this.anchor.z),e.btVector3_setValue(this._btframBPos,-this._connectAnchor.x,this._connectAnchor.y,this._connectAnchor.z),e.btTransform_setOrigin(this._btframATrans,this._btframAPos),e.btTransform_setOrigin(this._btframBTrans,this._btframBPos)}},{key:"_addToSimulation",value:function(){}},{key:"_removeFromSimulation",value:function(){}},{key:"_createConstraint",value:function(){}},{key:"setConnectRigidBody",value:function(e,t){var n=e&&!!(e._simulation&&e._enabled&&e.colliderShape),i=t&&!!(t._simulation&&t._enabled&&t.colliderShape);if(!n||!i)throw"ownerRigid or connectRigidBody is not in Simulation";e==this._ownBody&&t==this._connectedBody||(!(!this.enabled||!this._simulation)&&this._removeFromSimulation(),this._ownBody=e,this._connectedBody=t,this._ownBody.constaintRigidbodyA=this,this._connectedBody.constaintRigidbodyB=this,this._createConstraint())}},{key:"getcurrentForce",value:function(e){if(!this._btJointFeedBackObj)throw"this Constraint is not simulation";var t=k._bullet,n=t.btJointFeedback_getAppliedForceBodyA(this._btJointFeedBackObj);e.setValue(t.btVector3_x(n),t.btVector3_y(n),t.btVector3_z(n))}},{key:"getcurrentTorque",value:function(e){if(!this._btJointFeedBackObj)throw"this Constraint is not simulation";var t=k._bullet,n=t.btJointFeedback_getAppliedTorqueBodyA(this._btJointFeedBackObj);e.setValue(t.btVector3_x(n),t.btVector3_y(n),t.btVector3_z(n))}},{key:"_onDestroy",value:function(){var e=k._bullet;this._simulation&&this._removeFromSimulation(),this._btConstraint&&this._btJointFeedBackObj&&this._simulation&&(e.btTypedConstraint_destroy(this._btConstraint),e.btJointFeedback_destroy(this._btJointFeedBackObj),this._btJointFeedBackObj=null,this._btConstraint=null),_get(_getPrototypeOf(ConstraintComponent.prototype),"_onDisable",this).call(this)}},{key:"_isBreakConstrained",value:function(){if(this._getJointFeedBack=!1,-1==this.breakForce&&-1==this.breakTorque)return!1;this._getFeedBackInfo();var e=-1!=this._breakForce&&o.scalarLength(this._currentForce)>this._breakForce,t=-1!=this._breakTorque&&o.scalarLength(this._currentTorque)>this._breakTorque;return!(!e&&!t)&&(this._breakConstrained(),!0)}},{key:"_parse",value:function(e){this._anchor.fromArray(e.anchor),this._connectAnchor.fromArray(e.connectAnchor),this.setFrames()}},{key:"_getFeedBackInfo",value:function(){var e=k._bullet,t=e.btJointFeedback_getAppliedForceBodyA(this._btJointFeedBackObj),n=e.btJointFeedback_getAppliedTorqueBodyA(this._btJointFeedBackObj);this._currentTorque.setValue(e.btVector3_x(n),e.btVector3_y(n),e.btVector3_z(n)),this._currentForce.setValue(e.btVector3_x(t),e.btVector3_y(t),e.btVector3_z(t)),this._getJointFeedBack=!0}},{key:"_breakConstrained",value:function(){this.ownBody.constaintRigidbodyA=null,this.connectedBody&&(this.connectedBody.constaintRigidbodyB=null),this.destroy()}},{key:"enabled",get:function(){return _get(_getPrototypeOf(ConstraintComponent.prototype),"enabled",this)},set:function(e){_set(_getPrototypeOf(ConstraintComponent.prototype),"enabled",e,this,!0)}},{key:"appliedImpulse",get:function(){return this._feedbackEnabled||(this._btConstraint.EnableFeedback(!0),this._feedbackEnabled=!0),this._btConstraint.AppliedImpulse}},{key:"connectedBody",set:function(e){this._connectedBody=e,e&&(e.constaintRigidbodyB=this)},get:function(){return this._connectedBody}},{key:"ownBody",get:function(){return this._ownBody},set:function(e){this._ownBody=e,e.constaintRigidbodyA=this}},{key:"currentForce",get:function(){return this._getJointFeedBack||this._getFeedBackInfo(),this._currentForce}},{key:"currentTorque",get:function(){return this._getJointFeedBack||this._getFeedBackInfo(),this._currentTorque}},{key:"breakForce",get:function(){return this._breakForce},set:function(e){this._breakForce=e}},{key:"breakTorque",get:function(){return this._breakTorque},set:function(e){this._breakTorque=e}},{key:"anchor",set:function(e){e.cloneTo(this._anchor),this.setFrames()},get:function(){return this._anchor}},{key:"connectAnchor",set:function(e){e.cloneTo(this._connectAnchor),this.setFrames()},get:function(){return this._connectAnchor}}]),ConstraintComponent}();Gi.CONSTRAINT_POINT2POINT_CONSTRAINT_TYPE=3,Gi.CONSTRAINT_HINGE_CONSTRAINT_TYPE=4,Gi.CONSTRAINT_CONETWIST_CONSTRAINT_TYPE=5,Gi.CONSTRAINT_D6_CONSTRAINT_TYPE=6,Gi.CONSTRAINT_SLIDER_CONSTRAINT_TYPE=7,Gi.CONSTRAINT_CONTACT_CONSTRAINT_TYPE=8,Gi.CONSTRAINT_D6_SPRING_CONSTRAINT_TYPE=9,Gi.CONSTRAINT_GEAR_CONSTRAINT_TYPE=10,Gi.CONSTRAINT_FIXED_CONSTRAINT_TYPE=11,Gi.CONSTRAINT_MAX_CONSTRAINT_TYPE=12,Gi.CONSTRAINT_CONSTRAINT_ERP=1,Gi.CONSTRAINT_CONSTRAINT_STOP_ERP=2,Gi.CONSTRAINT_CONSTRAINT_CFM=3,Gi.CONSTRAINT_CONSTRAINT_STOP_CFM=4,Gi.tempForceV3=new o;var Hi=function(e){function FixedConstraint(){var e;return _classCallCheck(this,FixedConstraint),(e=_possibleConstructorReturn(this,_getPrototypeOf(FixedConstraint).call(this,Gi.CONSTRAINT_FIXED_CONSTRAINT_TYPE))).breakForce=-1,e.breakTorque=-1,e}return _inherits(FixedConstraint,Gi),_createClass(FixedConstraint,[{key:"_addToSimulation",value:function(){this._simulation&&this._simulation.addConstraint(this,this.enabled)}},{key:"_removeFromSimulation",value:function(){this._simulation.removeConstraint(this),this._simulation=null}},{key:"_createConstraint",value:function(){if(this.ownBody&&this.ownBody._simulation&&this.connectedBody&&this.connectedBody._simulation){var e=k._bullet;this._btConstraint=e.btFixedConstraint_create(this.ownBody.btColliderObject,this._btframATrans,this.connectedBody.btColliderObject,this._btframBTrans),this._btJointFeedBackObj=e.btJointFeedback_create(this._btConstraint),e.btTypedConstraint_setJointFeedback(this._btConstraint,this._btJointFeedBackObj),this._simulation=this.owner._scene.physicsSimulation,this._addToSimulation(),k._bullet.btTypedConstraint_setEnabled(this._btConstraint,!0)}}},{key:"_onAdded",value:function(){_get(_getPrototypeOf(FixedConstraint.prototype),"_onAdded",this).call(this)}},{key:"_onEnable",value:function(){this._btConstraint&&(_get(_getPrototypeOf(FixedConstraint.prototype),"_onEnable",this).call(this),this._btConstraint&&k._bullet.btTypedConstraint_setEnabled(this._btConstraint,!0))}},{key:"_onDisable",value:function(){_get(_getPrototypeOf(FixedConstraint.prototype),"_onDisable",this).call(this),this.connectedBody||this._removeFromSimulation(),this._btConstraint&&k._bullet.btTypedConstraint_setEnabled(this._btConstraint,!1)}},{key:"_onDestroy",value:function(){_get(_getPrototypeOf(FixedConstraint.prototype),"_onDestroy",this).call(this)}},{key:"_parse",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;_get(_getPrototypeOf(FixedConstraint.prototype),"_parse",this).call(this,e),-1!=e.rigidbodyID&&-1!=e.connectRigidbodyID&&(t.component.push(this),t.data.push(e)),null!=e.breakForce&&(this.breakForce=e.breakForce),null!=e.breakTorque&&(this.breakTorque=e.breakTorque)}},{key:"_parseInteractive",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=t[e.rigidbodyID].getComponent(b),i=t[e.connectRigidbodyID].getComponent(b);this.ownBody=n,this.connectedBody=i}}]),FixedConstraint}(),zi=function(e){function ConfigurableConstraint(){var e;_classCallCheck(this,ConfigurableConstraint),(e=_possibleConstructorReturn(this,_getPrototypeOf(ConfigurableConstraint).call(this,Gi.CONSTRAINT_D6_SPRING_CONSTRAINT_TYPE)))._axis=new o,e._secondaryAxis=new o,e._minLinearLimit=new o,e._maxLinearLimit=new o,e._minAngularLimit=new o,e._maxAngularLimit=new o,e._linearLimitSpring=new o,e._angularLimitSpring=new o,e._linearBounce=new o,e._angularBounce=new o,e._linearDamp=new o,e._angularDamp=new o,e._xMotion=0,e._yMotion=0,e._zMotion=0,e._angularXMotion=0,e._angularYMotion=0,e._angularZMotion=0;var t=k._bullet;return e._btAxis=t.btVector3_create(-1,0,0),e._btSecondaryAxis=t.btVector3_create(0,1,0),e}return _inherits(ConfigurableConstraint,Gi),_createClass(ConfigurableConstraint,[{key:"setAxis",value:function(e,t){if(this._btConstraint){var n=k._bullet;this._axis.setValue(e.x,e.y,e.y),this._secondaryAxis.setValue(t.x,t.y,t.z),this._btAxis=n.btVector3_setValue(-e.x,e.y,e.z),this._btSecondaryAxis=n.btVector3_setValue(-t.x,t.y,t.z),n.btGeneric6DofSpring2Constraint_setAxis(this._btConstraint,this._btAxis,this._btSecondaryAxis)}}},{key:"setLimit",value:function(e,t,n,i){if(this._btConstraint){var a=k._bullet;switch(t){case ConfigurableConstraint.CONFIG_MOTION_TYPE_LOCKED:a.btGeneric6DofSpring2Constraint_setLimit(this._btConstraint,e,0,0);break;case ConfigurableConstraint.CONFIG_MOTION_TYPE_LIMITED:n<i&&a.btGeneric6DofSpring2Constraint_setLimit(this._btConstraint,e,n,i);break;case ConfigurableConstraint.CONFIG_MOTION_TYPE_FREE:a.btGeneric6DofSpring2Constraint_setLimit(this._btConstraint,e,1,0);break;default:throw"No Type of Axis Motion"}}}},{key:"setSpring",value:function(e,t){var n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];if(this._btConstraint){var i=k._bullet,a=t>0;i.btGeneric6DofSpring2Constraint_enableSpring(this._btConstraint,e,a),a&&i.btGeneric6DofSpring2Constraint_setStiffness(this._btConstraint,e,t,n)}}},{key:"setBounce",value:function(e,t){this._btConstraint&&(t=t<=0?0:t,k._bullet.btGeneric6DofSpring2Constraint_setBounce(this._btConstraint,e,t))}},{key:"setDamping",value:function(e,t){var n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];this._btConstraint&&(t=t<=0?0:t,k._bullet.btGeneric6DofSpring2Constraint_setDamping(this._btConstraint,e,t,n))}},{key:"setEquilibriumPoint",value:function(e,t){k._bullet.btGeneric6DofSpring2Constraint_setEquilibriumPoint(this._btConstraint,e,t)}},{key:"enableMotor",value:function(e,t){k._bullet.btGeneric6DofSpring2Constraint_enableMotor(this._btConstraint,e,t)}},{key:"setServo",value:function(e,t){k._bullet.btGeneric6DofSpring2Constraint_setServo(this._btConstraint,e,t)}},{key:"setTargetVelocity",value:function(e,t){k._bullet.btGeneric6DofSpring2Constraint_setTargetVelocity(this._btConstraint,e,t)}},{key:"setTargetPosition",value:function(e,t){k._bullet.btGeneric6DofSpring2Constraint_setServoTarget(this._btConstraint,e,t)}},{key:"setMaxMotorForce",value:function(e,t){k._bullet.btGeneric6DofSpring2Constraint_setMaxMotorForce(this._btConstraint,e,t)}},{key:"setParam",value:function(e,t,n){k._bullet.btTypedConstraint_setParam(this._btConstraint,e,t,n)}},{key:"setFrames",value:function(){_get(_getPrototypeOf(ConfigurableConstraint.prototype),"setFrames",this).call(this);var e=k._bullet;this._btConstraint&&e.btGeneric6DofSpring2Constraint_setFrames(this._btConstraint,this._btframATrans,this._btframBTrans)}},{key:"_addToSimulation",value:function(){this._simulation&&this._simulation.addConstraint(this,this.enabled)}},{key:"_removeFromSimulation",value:function(){this._simulation.removeConstraint(this),this._simulation=null}},{key:"_createConstraint",value:function(){var e=k._bullet;this._btConstraint=e.btGeneric6DofSpring2Constraint_create(this.ownBody.btColliderObject,this._btframAPos,this.connectedBody.btColliderObject,this._btframBPos,ConfigurableConstraint.RO_XYZ),this._btJointFeedBackObj=e.btJointFeedback_create(this._btConstraint),e.btTypedConstraint_setJointFeedback(this._btConstraint,this._btJointFeedBackObj),this._simulation=this.owner._scene.physicsSimulation,this._initAllConstraintInfo(),this._addToSimulation(),k._bullet.btTypedConstraint_setEnabled(this._btConstraint,!0)}},{key:"_initAllConstraintInfo",value:function(){this.setLimit(ConfigurableConstraint.MOTION_LINEAR_INDEX_X,this._xMotion,-this._maxLinearLimit.x,-this._minLinearLimit.x),this.setLimit(ConfigurableConstraint.MOTION_LINEAR_INDEX_Y,this._yMotion,this._minLinearLimit.y,this._maxLinearLimit.y),this.setLimit(ConfigurableConstraint.MOTION_LINEAR_INDEX_Z,this._zMotion,this._minLinearLimit.z,this._maxLinearLimit.z),this.setLimit(ConfigurableConstraint.MOTION_ANGULAR_INDEX_X,this._angularXMotion,-this._maxAngularLimit.x,-this._minAngularLimit.x),this.setLimit(ConfigurableConstraint.MOTION_ANGULAR_INDEX_Y,this._angularYMotion,this._minAngularLimit.y,this._maxAngularLimit.y),this.setLimit(ConfigurableConstraint.MOTION_ANGULAR_INDEX_Z,this._angularZMotion,this._minAngularLimit.z,this._maxAngularLimit.z),this.setSpring(ConfigurableConstraint.MOTION_LINEAR_INDEX_X,this._linearLimitSpring.x),this.setSpring(ConfigurableConstraint.MOTION_LINEAR_INDEX_Y,this._linearLimitSpring.y),this.setSpring(ConfigurableConstraint.MOTION_LINEAR_INDEX_Z,this._linearLimitSpring.z),this.setSpring(ConfigurableConstraint.MOTION_ANGULAR_INDEX_X,this._angularLimitSpring.x),this.setSpring(ConfigurableConstraint.MOTION_ANGULAR_INDEX_Y,this._angularLimitSpring.y),this.setSpring(ConfigurableConstraint.MOTION_ANGULAR_INDEX_Z,this._angularLimitSpring.z),this.setBounce(ConfigurableConstraint.MOTION_LINEAR_INDEX_X,this._linearBounce.x),this.setBounce(ConfigurableConstraint.MOTION_LINEAR_INDEX_Y,this._linearBounce.y),this.setBounce(ConfigurableConstraint.MOTION_LINEAR_INDEX_Z,this._linearBounce.z),this.setBounce(ConfigurableConstraint.MOTION_ANGULAR_INDEX_X,this._angularBounce.x),this.setBounce(ConfigurableConstraint.MOTION_ANGULAR_INDEX_Y,this._angularBounce.y),this.setBounce(ConfigurableConstraint.MOTION_ANGULAR_INDEX_Z,this._angularBounce.z),this.setDamping(ConfigurableConstraint.MOTION_LINEAR_INDEX_X,this._linearDamp.x),this.setDamping(ConfigurableConstraint.MOTION_LINEAR_INDEX_Y,this._linearDamp.y),this.setDamping(ConfigurableConstraint.MOTION_LINEAR_INDEX_Z,this._linearDamp.z),this.setDamping(ConfigurableConstraint.MOTION_ANGULAR_INDEX_X,this._angularDamp.x),this.setDamping(ConfigurableConstraint.MOTION_ANGULAR_INDEX_Y,this._angularDamp.y),this.setDamping(ConfigurableConstraint.MOTION_ANGULAR_INDEX_Z,this._angularDamp.z),this.setFrames(),this.setEquilibriumPoint(0,0)}},{key:"_onAdded",value:function(){_get(_getPrototypeOf(ConfigurableConstraint.prototype),"_onAdded",this).call(this)}},{key:"_onEnable",value:function(){this._btConstraint&&(_get(_getPrototypeOf(ConfigurableConstraint.prototype),"_onEnable",this).call(this),this._btConstraint&&k._bullet.btTypedConstraint_setEnabled(this._btConstraint,!0))}},{key:"_onDisable",value:function(){_get(_getPrototypeOf(ConfigurableConstraint.prototype),"_onDisable",this).call(this),!this.connectedBody&&this._simulation&&this._removeFromSimulation(),this._btConstraint&&k._bullet.btTypedConstraint_setEnabled(this._btConstraint,!1)}},{key:"_parse",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;_get(_getPrototypeOf(ConfigurableConstraint.prototype),"_parse",this).call(this,e),this._axis.fromArray(e.axis),this._secondaryAxis.fromArray(e.secondaryAxis);var n=e.linearLimit;this._minLinearLimit.setValue(-n,-n,-n),this._maxLinearLimit.setValue(n,n,n);var i=e.linearLimitSpring;this._linearLimitSpring.setValue(i,i,i);var a=e.linearLimitDamper;this._linearDamp.setValue(a,a,a);var r=e.linearLimitBounciness;this._linearBounce.setValue(r,r,r);var o=e.lowAngularXLimit,s=e.highAngularXLimit,l=e.angularYLimit,u=e.angularZLimit;this._minAngularLimit.setValue(o,-l,-u),this._maxAngularLimit.setValue(s,l,u);var c=e.highAngularXLimitBounciness,h=e.angularYLimitBounciness,_=e.angularZLimitBounciness;this._angularBounce.setValue(c,h,_);var d=e.angularXLimitSpring,f=e.angularYZLimitSpring;this._angularLimitSpring.setValue(d,f,f);var m=e.angularXLimitDamper,p=e.angularYZLimitDamper;this._angularDamp.setValue(m,p,p),this.XMotion=e.xMotion,this.YMotion=e.yMotion,this.ZMotion=e.zMotion,this.angularXMotion=e.angularXMotion,this.angularYMotion=e.angularYMotion,this.angularZMotion=e.angularZMotion,-1!=e.rigidbodyID&&-1!=e.connectRigidbodyID&&(t.component.push(this),t.data.push(e)),null!=e.breakForce&&(this.breakForce=e.breakForce),null!=e.breakTorque&&(this.breakTorque=e.breakTorque)}},{key:"_parseInteractive",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=t[e.rigidbodyID].getComponent(b),i=t[e.connectRigidbodyID].getComponent(b);this.ownBody=n,this.connectedBody=i}},{key:"_onDestroy",value:function(){_get(_getPrototypeOf(ConfigurableConstraint.prototype),"_onDestroy",this).call(this)}},{key:"axis",get:function(){return this._axis}},{key:"secondaryAxis",get:function(){return this._secondaryAxis}},{key:"maxAngularLimit",set:function(e){e.cloneTo(this._maxAngularLimit)},get:function(){return this._maxAngularLimit}},{key:"minAngularLimit",set:function(e){e.cloneTo(this._minAngularLimit)},get:function(){return this._minAngularLimit}},{key:"maxLinearLimit",set:function(e){e.cloneTo(this._maxLinearLimit)},get:function(){return this._maxLinearLimit}},{key:"minLinearLimit",set:function(e){e.cloneTo(this._minLinearLimit)},get:function(){return this._minLinearLimit}},{key:"XMotion",set:function(e){this._xMotion!=e&&(this._xMotion=e,this.setLimit(ConfigurableConstraint.MOTION_LINEAR_INDEX_X,e,-this._maxLinearLimit.x,-this._minLinearLimit.x))},get:function(){return this._xMotion}},{key:"YMotion",set:function(e){this._yMotion!=e&&(this._yMotion=e,this.setLimit(ConfigurableConstraint.MOTION_LINEAR_INDEX_Y,e,this._minLinearLimit.y,this._maxLinearLimit.y))},get:function(){return this._yMotion}},{key:"ZMotion",set:function(e){this._zMotion!=e&&(this._zMotion=e,this.setLimit(ConfigurableConstraint.MOTION_LINEAR_INDEX_Z,e,this._minLinearLimit.z,this._maxLinearLimit.z))},get:function(){return this._zMotion}},{key:"angularXMotion",set:function(e){this._angularXMotion!=e&&(this._angularXMotion=e,this.setLimit(ConfigurableConstraint.MOTION_ANGULAR_INDEX_X,e,-this._maxAngularLimit.x,-this._minAngularLimit.x))},get:function(){return this._angularXMotion}},{key:"angularYMotion",set:function(e){this._angularYMotion!=e&&(this._angularYMotion=e,this.setLimit(ConfigurableConstraint.MOTION_ANGULAR_INDEX_Y,e,this._minAngularLimit.y,this._maxAngularLimit.y))},get:function(){return this._angularYMotion}},{key:"angularZMotion",set:function(e){this._angularZMotion!=e&&(this._angularZMotion=e,this.setLimit(ConfigurableConstraint.MOTION_ANGULAR_INDEX_Z,e,this._minAngularLimit.z,this._maxAngularLimit.z))},get:function(){return this._angularZMotion}},{key:"linearLimitSpring",set:function(e){o.equals(this._linearLimitSpring,e)||(e.cloneTo(this._linearLimitSpring),this.setSpring(ConfigurableConstraint.MOTION_LINEAR_INDEX_X,e.x),this.setSpring(ConfigurableConstraint.MOTION_LINEAR_INDEX_Y,e.y),this.setSpring(ConfigurableConstraint.MOTION_LINEAR_INDEX_Z,e.z))},get:function(){return this._linearLimitSpring}},{key:"angularLimitSpring",set:function(e){o.equals(this._angularLimitSpring,e)||(e.cloneTo(this._angularLimitSpring),this.setSpring(ConfigurableConstraint.MOTION_ANGULAR_INDEX_X,e.x),this.setSpring(ConfigurableConstraint.MOTION_ANGULAR_INDEX_Y,e.y),this.setSpring(ConfigurableConstraint.MOTION_ANGULAR_INDEX_Z,e.z))},get:function(){return this._angularLimitSpring}},{key:"linearBounce",set:function(e){o.equals(this._linearBounce,e)||(e.cloneTo(this._linearBounce),this.setBounce(ConfigurableConstraint.MOTION_LINEAR_INDEX_X,e.x),this.setBounce(ConfigurableConstraint.MOTION_LINEAR_INDEX_Y,e.y),this.setBounce(ConfigurableConstraint.MOTION_LINEAR_INDEX_Z,e.z))},get:function(){return this._linearBounce}},{key:"angularBounce",set:function(e){o.equals(this._angularBounce,e)||(e.cloneTo(this._angularBounce),this.setBounce(ConfigurableConstraint.MOTION_ANGULAR_INDEX_X,e.x),this.setBounce(ConfigurableConstraint.MOTION_ANGULAR_INDEX_Y,e.y),this.setBounce(ConfigurableConstraint.MOTION_ANGULAR_INDEX_Z,e.z))},get:function(){return this._angularBounce}},{key:"linearDamp",set:function(e){o.equals(this._linearDamp,e)||(e.cloneTo(this._linearDamp),this.setDamping(ConfigurableConstraint.MOTION_LINEAR_INDEX_X,e.x),this.setDamping(ConfigurableConstraint.MOTION_LINEAR_INDEX_Y,e.y),this.setDamping(ConfigurableConstraint.MOTION_LINEAR_INDEX_Z,e.z))},get:function(){return this._linearDamp}},{key:"angularDamp",set:function(e){o.equals(this._angularDamp,e)||(e.cloneTo(this._angularDamp),this.setDamping(ConfigurableConstraint.MOTION_ANGULAR_INDEX_X,e.x),this.setDamping(ConfigurableConstraint.MOTION_ANGULAR_INDEX_Y,e.y),this.setDamping(ConfigurableConstraint.MOTION_ANGULAR_INDEX_Z,e.z))},get:function(){return this._angularDamp}},{key:"anchor",set:function(e){e.cloneTo(this._anchor),this.setFrames()},get:function(){return this._anchor}},{key:"connectAnchor",set:function(e){e.cloneTo(this._connectAnchor),this.setFrames()},get:function(){return this._connectAnchor}}]),ConfigurableConstraint}();zi.CONFIG_MOTION_TYPE_LOCKED=0,zi.CONFIG_MOTION_TYPE_LIMITED=1,zi.CONFIG_MOTION_TYPE_FREE=2,zi.MOTION_LINEAR_INDEX_X=0,zi.MOTION_LINEAR_INDEX_Y=1,zi.MOTION_LINEAR_INDEX_Z=2,zi.MOTION_ANGULAR_INDEX_X=3,zi.MOTION_ANGULAR_INDEX_Y=4,zi.MOTION_ANGULAR_INDEX_Z=5,zi.RO_XYZ=0,zi.RO_XZY=1,zi.RO_YXZ=2,zi.RO_YZX=3,zi.RO_ZXY=4,zi.RO_ZYX=5;var Wi=function(){function Laya3D(){_classCallCheck(this,Laya3D)}return _createClass(Laya3D,null,[{key:"_cancelLoadByUrl",value:function(e){t.Laya.loader.cancelLoadByUrl(e),Laya3D._innerFirstLevelLoaderManager.cancelLoadByUrl(e),Laya3D._innerSecondLevelLoaderManager.cancelLoadByUrl(e),Laya3D._innerThirdLevelLoaderManager.cancelLoadByUrl(e),Laya3D._innerFourthLevelLoaderManager.cancelLoadByUrl(e)}},{key:"_changeWebGLSize",value:function(e,n){t.WebGL.onStageResize(e,n),J.clientWidth=e,J.clientHeight=n}},{key:"__init__",value:function(n,i,a){if(t.Config.isAntialias=a.isAntialias,t.Config.isAlpha=a.isAlpha,t.Config.premultipliedAlpha=a.premultipliedAlpha,t.Config.isStencil=a.isStencil,t.WebGL.enable()){t.RunDriver.changeWebGLSize=Laya3D._changeWebGLSize,t.Render.is3DMode=!0,t.Laya.init(n,i),t.Render.supportWebGLPlusRendering||(t.LayaGL.instance=t.WebGLContext.mainContext,t.LayaGL.instance.createCommandEncoder=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:128,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:64,i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return new t.CommandEncoder(this,e,n,i)}),a._multiLighting=a.enableMultiLight&&t.SystemUtils.supportTextureFormat(t.TextureFormat.R32G32B32A32),l.Shader3D=_e,l.Scene3D=fn,l.MeshRenderStaticBatchManager=Zt,l.MeshRenderDynamicBatchManager=An,l.SubMeshDynamicBatch=xn,l.Laya3D=Laya3D,l.Matrix4x4=c,l.Physics3D=k,l.ShadowLightType=e.ShadowLightType,Laya3D.enableNative3D(),a.isUseCannonPhysicsEngine&&k.__cannoninit__(),k.__bulletinit__(),ne.__init__(),Ne.__init__(),ai.__init__(),ri.__init__(),Lt.__init__(),Ti.__init__(),Si.__init__(),Ft.__init__(),zt.__init__(),xn.__init__(),Li.__init__(),Xe.init(),ft.__init__(),En.__init__(),vn.__init__(),Ui.__init__(),xi.__init__(),Ai.__init__(),ve.__init__(),Gt.__init__(),In.__init__(),di.__init__(),ki.__init__(),ci.__init__(),yi.__init__(),it.__init__(),fn.__init__(),Zt.__init__(),st.__initDefine__(),lt.__initDefine__(),ct.__initDefine__(),Sn.__initDefine__(),Rn.__initDefine__(),fi.__initDefine__(),ht.__initDefine__(),Cn.__initDefine__(),ti.__initDefine__(),dt.__initDefine__(),kt.__initDefine__(),yn.__initDefine__(),de.__init__(),t.ClassUtils.regClass("Laya.SkyPanoramicMaterial",Ui),t.ClassUtils.regClass("Laya.EffectMaterial",ht),t.ClassUtils.regClass("Laya.UnlitMaterial",Rn),t.ClassUtils.regClass("Laya.BlinnPhongMaterial",ct),t.ClassUtils.regClass("Laya.SkyProceduralMaterial",Sn),t.ClassUtils.regClass("Laya.PBRStandardMaterial",En),t.ClassUtils.regClass("Laya.PBRSpecularMaterial",vn),t.ClassUtils.regClass("Laya.SkyBoxMaterial",yn),t.ClassUtils.regClass("Laya.WaterPrimaryMaterial",Cn),t.ClassUtils.regClass("Laya.ExtendTerrainMaterial",dt),t.ClassUtils.regClass("Laya.ShurikenParticleMaterial",ti),t.ClassUtils.regClass("Laya.TrailMaterial",fi),t.ClassUtils.regClass("Laya.PhysicsCollider",Ci),t.ClassUtils.regClass("Laya.Rigidbody3D",b),t.ClassUtils.regClass("Laya.CharacterController",O),t.ClassUtils.regClass("Laya.Animator",K),t.ClassUtils.regClass("PhysicsCollider",Ci),t.ClassUtils.regClass("CharacterController",O),t.ClassUtils.regClass("Animator",K),t.ClassUtils.regClass("Rigidbody3D",b),t.ClassUtils.regClass("FixedConstraint",Hi),t.ClassUtils.regClass("ConfigurableConstraint",zi),kt.defaultMaterial=new kt,ct.defaultMaterial=new ct,ht.defaultMaterial=new ht,Rn.defaultMaterial=new Rn,ti.defaultMaterial=new ti,fi.defaultMaterial=new fi,Sn.defaultMaterial=new Sn,yn.defaultMaterial=new yn,Cn.defaultMaterial=new Cn,kt.defaultMaterial.lock=!0,ct.defaultMaterial.lock=!0,ht.defaultMaterial.lock=!0,Rn.defaultMaterial.lock=!0,ti.defaultMaterial.lock=!0,fi.defaultMaterial.lock=!0,Sn.defaultMaterial.lock=!0,yn.defaultMaterial.lock=!0,Cn.defaultMaterial.lock=!0,t.Texture2D.__init__(),Ot.__init__(),ke.__init__(),Pt.__init__(),se.__init__(),le.__init__(),Rt.__init__(),t.HalfFloatUtils.__init__();var r=t.LoaderManager.createMap;r.lh=[Laya3D.HIERARCHY,wi._parse],r.ls=[Laya3D.HIERARCHY,wi._parseScene],r.lm=[Laya3D.MESH,Fi._parse],r.lmat=[Laya3D.MATERIAL,st._parse],r.jpg=[Laya3D.TEXTURE2D,t.Texture2D._parse],r.jpeg=[Laya3D.TEXTURE2D,t.Texture2D._parse],r.bmp=[Laya3D.TEXTURE2D,t.Texture2D._parse],r.gif=[Laya3D.TEXTURE2D,t.Texture2D._parse],r.png=[Laya3D.TEXTURE2D,t.Texture2D._parse],r.dds=[Laya3D.TEXTURE2D,t.Texture2D._parse],r.ktx=[Laya3D.TEXTURE2D,t.Texture2D._parse],r.pvr=[Laya3D.TEXTURE2D,t.Texture2D._parse],r.lani=[Laya3D.ANIMATIONCLIP,Y._parse],r.lav=[Laya3D.AVATAR,ot._parse],r.ltc=[Laya3D.TEXTURECUBE,Ot._parse],r.ltcb=[Laya3D.TEXTURECUBEBIN,Ot._parseBin],r["ltcb.ls"]=[Laya3D.TEXTURECUBEBIN,Ot._parseBin],r["lanit.ls"]=[Laya3D.TEXTURE2D,t.Texture2D._SimpleAnimatorTextureParse];var o=t.Loader.parserMap;o[Laya3D.HIERARCHY]=Laya3D._loadHierarchy,o[Laya3D.MESH]=Laya3D._loadMesh,o[Laya3D.MATERIAL]=Laya3D._loadMaterial,o[Laya3D.TEXTURECUBE]=Laya3D._loadTextureCube,o[Laya3D.TEXTURECUBEBIN]=Laya3D._loadTextureCubeBin,o[Laya3D.TEXTURE2D]=Laya3D._loadTexture2D,o[Laya3D.ANIMATIONCLIP]=Laya3D._loadAnimationClip,o[Laya3D.AVATAR]=Laya3D._loadAvatar,o[Laya3D.SIMPLEANIMATORBIN]=Laya3D._loadSimpleAnimator,Laya3D._innerFirstLevelLoaderManager.on(t.Event.ERROR,null,Laya3D._eventLoadManagerError),Laya3D._innerSecondLevelLoaderManager.on(t.Event.ERROR,null,Laya3D._eventLoadManagerError),Laya3D._innerThirdLevelLoaderManager.on(t.Event.ERROR,null,Laya3D._eventLoadManagerError),Laya3D._innerFourthLevelLoaderManager.on(t.Event.ERROR,null,Laya3D._eventLoadManagerError)}else alert("Laya3D init error,must support webGL!")}},{key:"enableNative3D",value:function(){var e=ie,n=vt;t.Render.supportWebGLPlusRendering&&(e.prototype._initData=e.prototype._initDataForNative,e.prototype.setBool=e.prototype.setBoolForNative,e.prototype.getBool=e.prototype.getBoolForNative,e.prototype.setInt=e.prototype.setIntForNative,e.prototype.getInt=e.prototype.getIntForNative,e.prototype.setNumber=e.prototype.setNumberForNative,e.prototype.getNumber=e.prototype.getNumberForNative,e.prototype.setVector=e.prototype.setVectorForNative,e.prototype.getVector=e.prototype.getVectorForNative,e.prototype.setVector2=e.prototype.setVector2ForNative,e.prototype.getVector2=e.prototype.getVector2ForNative,e.prototype.setVector3=e.prototype.setVector3ForNative,e.prototype.getVector3=e.prototype.getVector3ForNative,e.prototype.setQuaternion=e.prototype.setQuaternionForNative,e.prototype.getQuaternion=e.prototype.getQuaternionForNative,e.prototype.setMatrix4x4=e.prototype.setMatrix4x4ForNative,e.prototype.getMatrix4x4=e.prototype.getMatrix4x4ForNative,e.prototype.setBuffer=e.prototype.setBufferForNative,e.prototype.getBuffer=e.prototype.getBufferForNative,e.prototype.setTexture=e.prototype.setTextureForNative,e.prototype.getTexture=e.prototype.getTextureForNative,e.prototype.setAttribute=e.prototype.setAttributeForNative,e.prototype.getAttribute=e.prototype.getAttributeForNative,e.prototype.cloneTo=e.prototype.cloneToForNative,e.prototype.getData=e.prototype.getDataForNative,n.prototype._uniformMatrix2fv=n.prototype._uniformMatrix2fvForNative,n.prototype._uniformMatrix3fv=n.prototype._uniformMatrix3fvForNative,n.prototype._uniformMatrix4fv=n.prototype._uniformMatrix4fvForNative,t.LayaGLRunner.uploadShaderUniforms=t.LayaGLRunner.uploadShaderUniformsForNative)}},{key:"formatRelativePath",value:function(e,t){var n;if(n=e+t,"."===t.charAt(0)){for(var i=n.split("/"),a=0,r=i.length;a<r;a++)if(".."==i[a]){var o=a-1;o>0&&".."!==i[o]&&(i.splice(o,2),a-=2)}n=i.join("/")}return n}},{key:"_endLoad",value:function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;if(i)for(var a=0,r=i.length;a<r;a++){var o=t.Loader.getRes(i[a]);o&&o._removeReference()}e.endLoad(n)}},{key:"_eventLoadManagerError",value:function(e){t.Laya.loader.event(t.Event.ERROR,e)}},{key:"_addHierarchyInnerUrls",value:function(e,t,n,i,a,r){var o=arguments.length>6&&void 0!==arguments[6]?arguments[6]:null,s=arguments.length>7&&void 0!==arguments[7]?arguments[7]:null,l=Laya3D.formatRelativePath(i,a);return n&&(l+=n),e.push({url:l,type:r,constructParams:o,propertyParams:s}),t.push(l),l}},{key:"_getSprite3DHierarchyInnerUrls",value:function(e,t,n,i,a,r,o,s){var l,u,c=e.props;switch(e.type){case"Scene3D":var h=c.lightmaps;for(l=0,u=h.length;l<u;l++){var _=h[l];if(_.path)_.path=Laya3D._addHierarchyInnerUrls(a,r,o,s,_.path,Laya3D.TEXTURE2D,_.constructParams,_.propertyParams);else{var d=_.color;d.path=Laya3D._addHierarchyInnerUrls(a,r,o,s,d.path,Laya3D.TEXTURE2D,d.constructParams,d.propertyParams);var f=_.direction;f&&(f.path=Laya3D._addHierarchyInnerUrls(a,r,o,s,f.path,Laya3D.TEXTURE2D,f.constructParams,f.propertyParams))}}var m=c.reflectionTexture;m&&(c.reflection=Laya3D._addHierarchyInnerUrls(i,r,o,s,m,Laya3D.TEXTURECUBE));var p=c.reflection;if(p&&(c.reflection=Laya3D._addHierarchyInnerUrls(a,r,o,s,p,Laya3D.TEXTURECUBEBIN)),c.sky){var T=c.sky.material;T&&(T.path=Laya3D._addHierarchyInnerUrls(n,r,o,s,T.path,Laya3D.MATERIAL))}break;case"Camera":var v=c.skyboxMaterial;v&&(v.path=Laya3D._addHierarchyInnerUrls(n,r,o,s,v.path,Laya3D.MATERIAL));break;case"TrailSprite3D":case"MeshSprite3D":case"SkinnedMeshSprite3D":case"SimpleSkinnedMeshSprite3D":var g=c.meshPath;g&&(c.meshPath=Laya3D._addHierarchyInnerUrls(t,r,o,s,g,Laya3D.MESH));var E=c.materials;if(E)for(l=0,u=E.length;l<u;l++)E[l].path=Laya3D._addHierarchyInnerUrls(n,r,o,s,E[l].path,Laya3D.MATERIAL);"SimpleSkinnedMeshSprite3D"==e.type&&c.animatorTexture&&(c.animatorTexture=Laya3D._addHierarchyInnerUrls(a,r,o,s,c.animatorTexture,Laya3D.SIMPLEANIMATORBIN));break;case"ShuriKenParticle3D":if(c.main){var y=c.renderer.resources,S=y.mesh,R=y.material;S&&(y.mesh=Laya3D._addHierarchyInnerUrls(t,r,o,s,S,Laya3D.MESH)),R&&(y.material=Laya3D._addHierarchyInnerUrls(n,r,o,s,R,Laya3D.MATERIAL))}else{var C=c.meshPath;C&&(c.meshPath=Laya3D._addHierarchyInnerUrls(t,r,o,s,C,Laya3D.MESH)),c.material.path=Laya3D._addHierarchyInnerUrls(n,r,o,s,c.material.path,Laya3D.MATERIAL)}break;case"Terrain":Laya3D._addHierarchyInnerUrls(a,r,o,s,c.dataPath,Laya3D.TERRAINRES);break;case"ReflectionProbe":var M=c.reflection;M&&(c.reflection=Laya3D._addHierarchyInnerUrls(t,r,o,s,M,Laya3D.TEXTURECUBEBIN))}var D=e.components;if(D)for(var x=0,A=D.length;x<A;x++){var I=D[x];switch(I.type){case"Animator":I.avatarPath;var L=I.avatar;L&&(L.path=Laya3D._addHierarchyInnerUrls(a,r,o,s,L.path,Laya3D.AVATAR));var P=I.clipPaths;if(P)for(l=0,u=P.length;l<u;l++)P[l]=Laya3D._addHierarchyInnerUrls(a,r,o,s,P[l],Laya3D.ANIMATIONCLIP);else{var O=I.layers;for(l=0;l<O.length;l++)for(var N=O[l].states,b=0,k=N.length;b<k;b++){var w=N[b].clipPath;w&&(N[b].clipPath=Laya3D._addHierarchyInnerUrls(a,r,o,s,w,Laya3D.ANIMATIONCLIP))}}break;case"PhysicsCollider":case"Rigidbody3D":case"CharacterController":var B=I.shapes;for(l=0;l<B.length;l++){var V=B[l];if("MeshColliderShape"===V.type)(S=V.mesh)&&(V.mesh=Laya3D._addHierarchyInnerUrls(t,r,o,s,S,Laya3D.MESH))}}}var F=e.child;for(l=0,u=F.length;l<u;l++)Laya3D._getSprite3DHierarchyInnerUrls(F[l],t,n,i,a,r,o,s)}},{key:"_loadHierarchy",value:function(e){e._originType=e.type,e.on(t.Event.LOADED,null,Laya3D._onHierarchylhLoaded,[e]),e.load(e.url,t.Loader.JSON,!1,null,!0)}},{key:"_onHierarchylhLoaded",value:function(e,n){var i=e.url,a=P.getURLVerion(i),r=t.URL.getPath(i),o=[],s=[],l=[],u=[],c=[];Laya3D._getSprite3DHierarchyInnerUrls(n.data,o,s,l,u,c,a,r);var h=o.length+s.length+u.length,_=h+1,d=1/_;if(Laya3D._onProcessChange(e,0,d,1),u.length>0){var f=h/_,m=t.Handler.create(null,Laya3D._onProcessChange,[e,d,f],!1);Laya3D._innerFourthLevelLoaderManager._create(u,!1,t.Handler.create(null,Laya3D._onHierarchyInnerForthLevResouLoaded,[e,m,n,c,o,s,l,d+f*u.length,f]),m,null,null,null,1,!0)}else Laya3D._onHierarchyInnerForthLevResouLoaded(e,null,n,c,o,s,l,d,f)}},{key:"_onHierarchyInnerForthLevResouLoaded",value:function(e,n,i,a,r,o,s,l,u){if(n&&n.recover(),s.length>0){var c=t.Handler.create(null,Laya3D._onProcessChange,[e,l,u],!1);Laya3D._innerThirdLevelLoaderManager._create(s,!1,t.Handler.create(null,Laya3D._onHierarchyInnerThirdLevResouLoaded,[e,c,i,a,r,o,l+u*o.length,u]),n,null,null,null,1,!0)}else Laya3D._onHierarchyInnerThirdLevResouLoaded(e,null,i,a,r,o,l,u)}},{key:"_onHierarchyInnerThirdLevResouLoaded",value:function(e,n,i,a,r,o,s,l){if(n&&n.recover(),o.length>0){var u=t.Handler.create(null,Laya3D._onProcessChange,[e,s,l],!1);Laya3D._innerSecondLevelLoaderManager._create(o,!1,t.Handler.create(null,Laya3D._onHierarchyInnerSecondLevResouLoaded,[e,u,i,a,r,s+l*o.length,l]),n,null,null,null,1,!0)}else Laya3D._onHierarchyInnerSecondLevResouLoaded(e,null,i,a,r,s,l)}},{key:"_onHierarchyInnerSecondLevResouLoaded",value:function(e,n,i,a,r,o,s){if(n&&n.recover(),r.length>0){var l=t.Handler.create(null,Laya3D._onProcessChange,[e,o,s],!1);Laya3D._innerFirstLevelLoaderManager._create(r,!1,t.Handler.create(null,Laya3D._onHierarchyInnerFirstLevResouLoaded,[e,l,i,a]),n,null,null,null,1,!0)}else Laya3D._onHierarchyInnerFirstLevResouLoaded(e,null,i,a)}},{key:"_onHierarchyInnerFirstLevResouLoaded",value:function(e,t,n,i){t&&t.recover(),e._cache=e._createCache;var a="Scene3D"===n.data.type?wi._parseScene(n,e._propertyParams,e._constructParams):wi._parse(n,e._propertyParams,e._constructParams);Laya3D._endLoad(e,a,i)}},{key:"_loadMesh",value:function(e){e.on(t.Event.LOADED,null,Laya3D._onMeshLmLoaded,[e]),e.load(e.url,t.Loader.BUFFER,!1,null,!0)}},{key:"_onMeshLmLoaded",value:function(e,t){e._cache=e._createCache;var n=Fi._parse(t,e._propertyParams,e._constructParams);Laya3D._endLoad(e,n)}},{key:"_loadMaterial",value:function(e){e.on(t.Event.LOADED,null,Laya3D._onMaterilLmatLoaded,[e]),e.load(e.url,t.Loader.JSON,!1,null,!0)}},{key:"_onMaterilLmatLoaded",value:function(e,n){var i,a=e.url,r=P.getURLVerion(a),o=t.URL.getPath(a),s=[],l=[];n.customProps;switch(n.version){case"LAYAMATERIAL:01":case"LAYAMATERIAL:02":var u,c,h=n.props.textures;if(h)for(u=0,c=h.length;u<c;u++){var _=h[u],d=_.path;d&&(i=Laya3D.formatRelativePath(o,d),r&&(i+=r),s.push({url:i,constructParams:_.constructParams,propertyParams:_.propertyParams}),l.push(i),_.path=i)}break;default:throw new Error("Laya3D:unkonwn version.")}var f=s.length,m=f+1,p=1/m;if(Laya3D._onProcessChange(e,0,p,1),f>0){var T=t.Handler.create(null,Laya3D._onProcessChange,[e,p,f/m],!1);Laya3D._innerFourthLevelLoaderManager._create(s,!1,t.Handler.create(null,Laya3D._onMateialTexturesLoaded,[e,T,n,l]),T,null,null,null,1,!0)}else Laya3D._onMateialTexturesLoaded(e,null,n,null)}},{key:"_onMateialTexturesLoaded",value:function(e,t,n,i){e._cache=e._createCache;var a=st._parse(n,e._propertyParams,e._constructParams);Laya3D._endLoad(e,a,i),t&&t.recover()}},{key:"_loadAvatar",value:function(e){e.on(t.Event.LOADED,null,function(t){e._cache=e._createCache;var n=ot._parse(t,e._propertyParams,e._constructParams);Laya3D._endLoad(e,n)}),e.load(e.url,t.Loader.JSON,!1,null,!0)}},{key:"_loadSimpleAnimator",value:function(e){e.on(t.Event.LOADED,null,function(n){e._cache=e._createCache;var i=t.Texture2D._SimpleAnimatorTextureParse(n,e._propertyParams,e._constructParams);Laya3D._endLoad(e,i)}),e.load(e.url,t.Loader.BUFFER,!1,null,!0)}},{key:"_loadAnimationClip",value:function(e){e.on(t.Event.LOADED,null,function(t){e._cache=e._createCache;var n=Y._parse(t);Laya3D._endLoad(e,n)}),e.load(e.url,t.Loader.BUFFER,!1,null,!0)}},{key:"_loadTexture2D",value:function(e){var n,i=e.url,a=i.lastIndexOf(".")+1,r=i.indexOf("?"),o=-1==r?i.length:r;switch(i.substr(a,o-a)){case"jpg":case"jpeg":case"bmp":case"gif":case"png":n="nativeimage";break;case"dds":case"ktx":case"pvr":n=t.Loader.BUFFER}e.on(t.Event.LOADED,null,function(n){e._cache=e._createCache;var i=t.Texture2D._parse(n,e._propertyParams,e._constructParams);Laya3D._endLoad(e,i)}),e.load(e.url,n,!1,null,!0)}},{key:"_loadTextureCube",value:function(e){e.on(t.Event.LOADED,null,Laya3D._onTextureCubeLtcLoaded,[e]),e.load(e.url,t.Loader.JSON,!1,null,!0)}},{key:"_loadTextureCubeBin",value:function(e){e.on(t.Event.LOADED,null,function(n){e._cache=e._createCache;var i=new t.Byte(n);if("LAYATEXTURECUBE:0000"!==i.readUTFString())throw"Laya3D:unknow version.";var a=i.readUint8(),r=i.getUint8(),o=i.readUint16(),s=i.getUint8(),l=i.getUint8(),u=i.getUint8(),c=i.getUint8(),h=new Ot(o,a,r>1);h.filterMode=s,h.wrapModeU=l,h.wrapModeV=u,h.anisoLevel=c;for(var _=i.pos,d=o,f=0;f<r;f++){for(var m=new Array(6),p=d*d*h._getFormatByteCount(),T=0;T<6;T++)m[T]=new Uint8Array(n,_,p),_+=p;h.setSixSidePixels(m,f),d/=2}Laya3D._endLoad(e,h)}),e.load(e.url,t.Loader.BUFFER,!1,null,!0)}},{key:"_onTextureCubeLtcLoaded",value:function(e,n){var i=t.URL.getPath(e.url),a=[Laya3D.formatRelativePath(i,n.front),Laya3D.formatRelativePath(i,n.back),Laya3D.formatRelativePath(i,n.left),Laya3D.formatRelativePath(i,n.right),Laya3D.formatRelativePath(i,n.up),Laya3D.formatRelativePath(i,n.down)];Laya3D._onProcessChange(e,0,1/7,1);var r=t.Handler.create(null,Laya3D._onProcessChange,[e,1/7,6/7],!1);Laya3D._innerFourthLevelLoaderManager.load(a,t.Handler.create(null,Laya3D._onTextureCubeImagesLoaded,[e,a,r]),r,"nativeimage")}},{key:"_onTextureCubeImagesLoaded",value:function(e,n,i){for(var a=new Array(6),r=0;r<6;r++)a[r]=t.Loader.getRes(n[r]);e._cache=e._createCache;var o=Ot._parse(a,e._propertyParams,e._constructParams);for(i.recover(),r=0;r<6;r++)t.Loader.clearRes(n[r]);Laya3D._endLoad(e,o)}},{key:"_onProcessChange",value:function(e,n,i,a){(a=n+a*i)<1&&e.event(t.Event.PROGRESS,2*a/3+1/3)}},{key:"init",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;if(Laya3D._isInit)i&&i.run();else{Laya3D._isInit=!0,n&&n.cloneTo(w._config),n=w._config,Rt.debugFrustumCulling=n.debugFrustumCulling,Laya3D._editerEnvironment=n._editerEnvironment,fn.octreeCulling=n.octreeCulling,fn.octreeInitialSize=n.octreeInitialSize,fn.octreeInitialCenter=n.octreeInitialCenter,fn.octreeMinNodeSize=n.octreeMinNodeSize,fn.octreeLooseness=n.octreeLooseness;var a=window.Physics3D;null==a||n.isUseCannonPhysicsEngine?(k._enablePhysics=!1,Laya3D.__init__(e,t,n),i&&i.run()):(k._enablePhysics=!0,a(16*n.defaultPhysicsMemory,Ri._interactive).then(function(){Laya3D.__init__(e,t,n),i&&i.run()}))}}},{key:"enablePhysics",get:function(){return k._enablePhysics}}]),Laya3D}();Wi.HIERARCHY="HIERARCHY",Wi.MESH="MESH",Wi.MATERIAL="MATERIAL",Wi.TEXTURE2D="TEXTURE2D",Wi.TEXTURECUBE="TEXTURECUBE",Wi.TEXTURECUBEBIN="TEXTURECUBEBIN",Wi.ANIMATIONCLIP="ANIMATIONCLIP",Wi.AVATAR="AVATAR",Wi.TERRAINHEIGHTDATA="TERRAINHEIGHTDATA",Wi.TERRAINRES="TERRAIN",Wi.SIMPLEANIMATORBIN="SIMPLEANIMATOR",Wi._innerFirstLevelLoaderManager=new t.LoaderManager,Wi._innerSecondLevelLoaderManager=new t.LoaderManager,Wi._innerThirdLevelLoaderManager=new t.LoaderManager,Wi._innerFourthLevelLoaderManager=new t.LoaderManager,Wi._isInit=!1,Wi._editerEnvironment=!1,Wi.physicsSettings=new It,window.Laya3D=Wi;var Xi=function(e){function CastShadowList(){return _classCallCheck(this,CastShadowList),_possibleConstructorReturn(this,_getPrototypeOf(CastShadowList).call(this))}return _inherits(CastShadowList,R),_createClass(CastShadowList,[{key:"add",value:function(e){if(-1!==e._indexInCastShadowList)throw"CastShadowList:element has  in  CastShadowList.";this._add(e),e._indexInCastShadowList=this.length++}},{key:"remove",value:function(e){var t=e._indexInCastShadowList;if(this.length--,t!==this.length){var n=this.elements[this.length];this.elements[t]=n,n._indexInCastShadowList=t}e._indexInCastShadowList=-1}}]),CastShadowList}(),Yi=function(){function AnimatorStateScript(){_classCallCheck(this,AnimatorStateScript)}return _createClass(AnimatorStateScript,[{key:"onStateEnter",value:function(){}},{key:"onStateUpdate",value:function(){}},{key:"onStateExit",value:function(){}}]),AnimatorStateScript}(),ji=function(e){function Script3D(){var e;return _classCallCheck(this,Script3D),(e=_possibleConstructorReturn(this,_getPrototypeOf(Script3D).apply(this,arguments)))._indexInPool=-1,e}return _inherits(Script3D,t.Component),_createClass(Script3D,[{key:"_checkProcessTriggers",value:function(){var e=Script3D.prototype;return this.onTriggerEnter!==e.onTriggerEnter||(this.onTriggerStay!==e.onTriggerStay||this.onTriggerExit!==e.onTriggerExit)}},{key:"_checkProcessCollisions",value:function(){var e=Script3D.prototype;return this.onCollisionEnter!==e.onCollisionEnter||(this.onCollisionStay!==e.onCollisionStay||this.onCollisionExit!==e.onCollisionExit)}},{key:"_onAwake",value:function(){this.onAwake(),this.onStart!==Script3D.prototype.onStart&&t.Laya.startTimer.callLater(this,this.onStart)}},{key:"_onEnable",value:function(){this.owner._scene._addScript(this),this.onEnable()}},{key:"_onDisable",value:function(){this.owner._scene._removeScript(this),this.owner.offAllCaller(this),this.onDisable()}},{key:"_onDestroy",value:function(){var e=this.owner._scripts;e.splice(e.indexOf(this),1);var t=this.owner;t._needProcessTriggers=!1;for(var n=0,i=e.length;n<i;n++)if(e[n]._checkProcessTriggers()){t._needProcessTriggers=!0;break}for(t._needProcessCollisions=!1,n=0,i=e.length;n<i;n++)if(e[n]._checkProcessCollisions()){t._needProcessCollisions=!0;break}this.onDestroy()}},{key:"_isScript",value:function(){return!0}},{key:"_onAdded",value:function(){var e=this.owner,t=e._scripts;t||(e._scripts=t=[]),t.push(this),e._needProcessCollisions||(e._needProcessCollisions=this._checkProcessCollisions()),e._needProcessTriggers||(e._needProcessTriggers=this._checkProcessTriggers())}},{key:"onAwake",value:function(){}},{key:"onEnable",value:function(){}},{key:"onStart",value:function(){}},{key:"onTriggerEnter",value:function(e){}},{key:"onTriggerStay",value:function(e){}},{key:"onTriggerExit",value:function(e){}},{key:"onCollisionEnter",value:function(e){}},{key:"onCollisionStay",value:function(e){}},{key:"onCollisionExit",value:function(e){}},{key:"onJointBreak",value:function(){}},{key:"onMouseDown",value:function(){}},{key:"onMouseDrag",value:function(){}},{key:"onMouseClick",value:function(){}},{key:"onMouseUp",value:function(){}},{key:"onMouseEnter",value:function(){}},{key:"onMouseOver",value:function(){}},{key:"onMouseOut",value:function(){}},{key:"onUpdate",value:function(){}},{key:"onLateUpdate",value:function(){}},{key:"onPreRender",value:function(){}},{key:"onPostRender",value:function(){}},{key:"onDisable",value:function(){}},{key:"onDestroy",value:function(){}},{key:"isSingleton",get:function(){return!1}}]),Script3D}(),Zi=function(){function HeightMap(e,t,n,i){_classCallCheck(this,HeightMap),this._datas=[],this._w=e,this._h=t,this._minHeight=n,this._maxHeight=i}return _createClass(HeightMap,[{key:"_inBounds",value:function(e,t){return e>=0&&e<this._h&&t>=0&&t<this._w}},{key:"getHeight",value:function(e,t){return this._inBounds(e,t)?this._datas[e][t]:NaN}},{key:"width",get:function(){return this._w}},{key:"height",get:function(){return this._h}},{key:"maxHeight",get:function(){return this._maxHeight}},{key:"minHeight",get:function(){return this._minHeight}}],[{key:"creatFromMesh",value:function(e,t,n,i){for(var a=[],r=[],s=e.subMeshCount,l=0;l<s;l++){for(var u=e.getSubMesh(l),c=u._vertexBuffer,h=c.getFloat32Data(),_=[],d=0;d<h.length;d+=c.vertexDeclaration.vertexStride/4){var f=new o(h[d+0],h[d+1],h[d+2]);_.push(f)}a.push(_);var m=u._indexBuffer;r.push(m.getData())}var p=e.bounds,T=p.getMin().x,v=p.getMin().z,g=p.getMax().x,E=p.getMax().z,y=p.getMin().y,S=p.getMax().y,R=g-T,C=E-v,M=i.x=R/(t-1),D=i.y=C/(n-1),x=new HeightMap(t,n,y,S),A=HeightMap._tempRay,I=A.direction;I.x=0,I.y=-1,I.z=0;var L=S+.1;A.origin.y=L;for(var P=0;P<n;P++){var O=v+P*D;x._datas[P]=[];for(var N=0;N<t;N++){var b=T+N*M,k=A.origin;k.x=b,k.z=O;var w=HeightMap._getPosition(A,a,r);x._datas[P][N]=w===Number.MAX_VALUE?NaN:L-w}}return x}},{key:"createFromImage",value:function(e,t,n){for(var i=e.width,a=e.height,r=new HeightMap(i,a,t,n),o=(n-t)/254,s=e.getPixels(),l=0,u=0;u<a;u++)for(var c=r._datas[u]=[],h=0;h<i;h++){var _=s[l++],d=s[l++],f=s[l++],m=s[l++];c[h]=255==_&&255==d&&255==f&&255==m?NaN:(_+d+f)/3*o+t}return r}},{key:"_getPosition",value:function(e,t,n){for(var i=Number.MAX_VALUE,a=0;a<t.length;a++)for(var r=t[a],o=n[a],s=0;s<o.length;s+=3){var l=r[o[s+0]],u=r[o[s+1]],c=r[o[s+2]],h=Pe.rayIntersectsTriangle(e,l,u,c);!isNaN(h)&&h<i&&(i=h)}return i}}]),HeightMap}();Zi._tempRay=new Ce(new o,new o);var Qi=function(e){function MeshTerrainSprite3D(e,t){var n,a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;return _classCallCheck(this,MeshTerrainSprite3D),(n=_possibleConstructorReturn(this,_getPrototypeOf(MeshTerrainSprite3D).call(this,e,a)))._heightMap=t,n._cellSize=new i,n}return _inherits(MeshTerrainSprite3D,In),_createClass(MeshTerrainSprite3D,[{key:"_disableRotation",value:function(){var e=this.transform.rotation;e.x=0,e.y=0,e.z=0,e.w=1,this.transform.rotation=e}},{key:"_getScaleX",value:function(){var e=this.transform.worldMatrix.elements,t=e[0],n=e[1],i=e[2];return Math.sqrt(t*t+n*n+i*i)}},{key:"_getScaleZ",value:function(){var e=this.transform.worldMatrix.elements,t=e[8],n=e[9],i=e[10];return Math.sqrt(t*t+n*n+i*i)}},{key:"_initCreateFromMesh",value:function(e,t){this._heightMap=Zi.creatFromMesh(this.meshFilter.sharedMesh,e,t,this._cellSize);var n=this.meshFilter.sharedMesh.bounds.getMin();this._minX=n.x,this._minZ=n.z}},{key:"_initCreateFromMeshHeightMap",value:function(e,t,n){var i=this.meshFilter.sharedMesh.bounds;this._heightMap=Zi.createFromImage(e,t,n),this._computeCellSize(i);var a=i.getMin();this._minX=a.x,this._minZ=a.z}},{key:"_computeCellSize",value:function(e){var t=e.getMin(),n=e.getMax(),i=t.x,a=t.z,r=n.x-i,o=n.z-a;this._cellSize.x=r/(this._heightMap.width-1),this._cellSize.y=o/(this._heightMap.height-1)}},{key:"_update",value:function(e){this._disableRotation()}},{key:"getHeight",value:function(e,t){MeshTerrainSprite3D._tempVector3.x=e,MeshTerrainSprite3D._tempVector3.y=0,MeshTerrainSprite3D._tempVector3.z=t,this._disableRotation();var n=this.transform.worldMatrix;n.invert(MeshTerrainSprite3D._tempMatrix4x4),o.transformCoordinate(MeshTerrainSprite3D._tempVector3,MeshTerrainSprite3D._tempMatrix4x4,MeshTerrainSprite3D._tempVector3),e=MeshTerrainSprite3D._tempVector3.x,t=MeshTerrainSprite3D._tempVector3.z;var i=(e-this._minX)/this._cellSize.x,a=(t-this._minZ)/this._cellSize.y,r=Math.floor(a),s=Math.floor(i),l=i-s,u=a-r,c=n.elements,h=c[4],_=c[5],d=c[6],f=Math.sqrt(h*h+_*_+d*d),m=c[13],p=this._heightMap.getHeight(r,s+1),T=this._heightMap.getHeight(r+1,s);if(isNaN(p)||isNaN(T))return NaN;if(l+u<=1){var v=this._heightMap.getHeight(r,s);return isNaN(v)?NaN:(v+l*(p-v)+u*(T-v))*f+m}var g=this._heightMap.getHeight(r+1,s+1);return isNaN(g)?NaN:(g+(1-l)*(T-g)+(1-u)*(p-g))*f+m}},{key:"minX",get:function(){var e=this.transform.worldMatrix.elements;return this._minX*this._getScaleX()+e[12]}},{key:"minZ",get:function(){var e=this.transform.worldMatrix.elements;return this._minZ*this._getScaleZ()+e[14]}},{key:"width",get:function(){return(this._heightMap.width-1)*this._cellSize.x*this._getScaleX()}},{key:"depth",get:function(){return(this._heightMap.height-1)*this._cellSize.y*this._getScaleZ()}}],[{key:"createFromMesh",value:function(e,t,n){var i=new MeshTerrainSprite3D(e,null,arguments.length>3&&void 0!==arguments[3]?arguments[3]:null);return i._initCreateFromMesh(t,n),i}},{key:"createFromMeshAndHeightMap",value:function(e,t,n,i){var a=new MeshTerrainSprite3D(e,null,arguments.length>4&&void 0!==arguments[4]?arguments[4]:null);return a._initCreateFromMeshHeightMap(t,n,i),a}}]),MeshTerrainSprite3D}();Qi._tempVector3=new o,Qi._tempMatrix4x4=new c;var qi=function(){function GradientDataVector2(){_classCallCheck(this,GradientDataVector2),this._currentLength=0,this._elements=new Float32Array(12)}return _createClass(GradientDataVector2,[{key:"add",value:function(e,t){this._currentLength<8?(6===this._currentLength&&1!==e&&(e=1,console.log("GradientDataVector2 warning:the forth key is  be force set to 1.")),this._elements[this._currentLength++]=e,this._elements[this._currentLength++]=t.x,this._elements[this._currentLength++]=t.y):console.log("GradientDataVector2 warning:data count must lessEqual than 4")}},{key:"cloneTo",value:function(e){var t=e;t._currentLength=this._currentLength;for(var n=t._elements,i=0,a=this._elements.length;i<a;i++)n[i]=this._elements[i]}},{key:"clone",value:function(){var e=new GradientDataVector2;return this.cloneTo(e),e}},{key:"gradientCount",get:function(){return this._currentLength/3}}]),GradientDataVector2}(),Ki=function(){function PixelLineData(){_classCallCheck(this,PixelLineData),this.startPosition=new o,this.endPosition=new o,this.startColor=new Et,this.endColor=new Et}return _createClass(PixelLineData,[{key:"cloneTo",value:function(e){this.startPosition.cloneTo(e.startPosition),this.endPosition.cloneTo(e.endPosition),this.startColor.cloneTo(e.startColor),this.endColor.cloneTo(e.endColor)}}]),PixelLineData}(),Ji=function(){function PostProcessEffect(){_classCallCheck(this,PostProcessEffect)}return _createClass(PostProcessEffect,[{key:"render",value:function(e){}}]),PostProcessEffect}(),$i=function(e){function BloomEffect(){var e;return _classCallCheck(this,BloomEffect),(e=_possibleConstructorReturn(this,_getPrototypeOf(BloomEffect).call(this)))._shader=null,e._shaderData=new ie,e._linearColor=new Et,e._bloomTextureTexelSize=new a,e._shaderThreshold=new a,e._shaderParams=new a,e._pyramid=null,e._intensity=0,e._threshold=1,e._softKnee=.5,e._diffusion=7,e._anamorphicRatio=0,e._dirtIntensity=0,e._shaderSetting=new a,e._dirtTileOffset=new a,e.clamp=65472,e.color=new Et(1,1,1,1),e.fastMode=!1,e.dirtTexture=null,e._shader=_e.find("PostProcessBloom"),e._pyramid=new Array(2*BloomEffect.MAXPYRAMIDSIZE),e}return _inherits(BloomEffect,Ji),_createClass(BloomEffect,[{key:"render",value:function(e){var n=e.command,i=e.camera.viewport;this._shaderData.setTexture(BloomEffect.SHADERVALUE_AUTOEXPOSURETEX,t.Texture2D.whiteTexture);var r,o=this._anamorphicRatio,s=o<0?-o:0,l=o>0?o:0,u=Math.floor(i.width/(2-s)),c=Math.floor(i.height/(2-l)),h=Math.max(u,c);r=Math.log2(h)+this._diffusion-10;var _=Math.floor(r),d=Math.min(Math.max(_,1),BloomEffect.MAXPYRAMIDSIZE),f=.5+r-_;this._shaderData.setNumber(BloomEffect.SHADERVALUE_SAMPLESCALE,f);var m=Et.gammaToLinearSpace(this.threshold),p=m*this._softKnee+1e-5;this._shaderThreshold.setValue(m,m-p,2*p,.25/p),this._shaderData.setVector(BloomEffect.SHADERVALUE_THRESHOLD,this._shaderThreshold);var T=Et.gammaToLinearSpace(this.clamp);this._shaderParams.setValue(T,0,0,0),this._shaderData.setVector(BloomEffect.SHADERVALUE_PARAMS,this._shaderParams);for(var v=this.fastMode?1:0,g=e.source,E=0;E<d;E++){var y=2*E,S=y+1,R=0==E?BloomEffect.SUBSHADER_PREFILTER13+v:BloomEffect.SUBSHADER_DOWNSAMPLE13+v,C=$.createFromPool(u,c,t.RenderTextureFormat.R8G8B8,t.RenderTextureDepthFormat.DEPTHSTENCIL_NONE);if(C.filterMode=t.FilterMode.Bilinear,this._pyramid[y]=C,E!==d-1){var M=$.createFromPool(u,c,t.RenderTextureFormat.R8G8B8,t.RenderTextureDepthFormat.DEPTHSTENCIL_NONE);M.filterMode=t.FilterMode.Bilinear,this._pyramid[S]=M}n.blitScreenTriangle(g,C,null,this._shader,this._shaderData,R),g=C,u=Math.max(Math.floor(u/2),1),c=Math.max(Math.floor(c/2),1)}var D=this._pyramid[2*(d-1)];for(E=d-2;E>=0;E--)S=(y=2*E)+1,C=this._pyramid[y],M=this._pyramid[S],n.setShaderDataTexture(this._shaderData,BloomEffect.SHADERVALUE_BLOOMTEX,C),n.blitScreenTriangle(D,M,null,this._shader,this._shaderData,BloomEffect.SUBSHADER_UPSAMPLETENT+v),D=M;var x=this._linearColor;this.color.toLinear(x);var A=Math.pow(2,this._intensity/10)-1,I=this._shaderSetting;this._shaderSetting.setValue(f,A,this._dirtIntensity,d);var L=this.dirtTexture?this.dirtTexture:t.Texture2D.blackTexture,P=L.width/L.height,O=i.width/i.height,N=this._dirtTileOffset;P>O?N.setValue(O/P,1,.5*(1-N.x),0):P<O&&N.setValue(1,P/O,0,.5*(1-N.y));var b=e.compositeShaderData;for(this.fastMode?b.addDefine(it.SHADERDEFINE_BLOOM_LOW):b.addDefine(it.SHADERDEFINE_BLOOM),this._bloomTextureTexelSize.setValue(1/D.width,1/D.height,D.width,D.height),b.setVector(it.SHADERVALUE_BLOOM_DIRTTILEOFFSET,N),b.setVector(it.SHADERVALUE_BLOOM_SETTINGS,I),b.setVector(it.SHADERVALUE_BLOOM_COLOR,new a(x.r,x.g,x.b,x.a)),b.setTexture(it.SHADERVALUE_BLOOM_DIRTTEX,L),b.setTexture(it.SHADERVALUE_BLOOMTEX,D),b.setVector(it.SHADERVALUE_BLOOMTEX_TEXELSIZE,this._bloomTextureTexelSize),E=0;E<d;E++)S=(y=2*E)+1,$.recoverToPool(this._pyramid[y]),0!==E&&E!==d-1&&$.recoverToPool(this._pyramid[S]);e.deferredReleaseTextures.push(D)}},{key:"intensity",get:function(){return this._intensity},set:function(e){this._intensity=Math.max(e,0)}},{key:"threshold",get:function(){return this._threshold},set:function(e){this._threshold=Math.max(e,0)}},{key:"softKnee",get:function(){return this._softKnee},set:function(e){this._softKnee=Math.min(Math.max(e,0),1)}},{key:"diffusion",get:function(){return this._diffusion},set:function(e){this._diffusion=Math.min(Math.max(e,1),10)}},{key:"anamorphicRatio",get:function(){return this._anamorphicRatio},set:function(e){this._anamorphicRatio=Math.min(Math.max(e,-1),1)}},{key:"dirtIntensity",get:function(){return this._dirtIntensity},set:function(e){this._dirtIntensity=Math.max(e,0)}}]),BloomEffect}();$i.SHADERVALUE_MAINTEX=_e.propertyNameToID("u_MainTex"),$i.SHADERVALUE_AUTOEXPOSURETEX=_e.propertyNameToID("u_AutoExposureTex"),$i.SHADERVALUE_SAMPLESCALE=_e.propertyNameToID("u_SampleScale"),$i.SHADERVALUE_THRESHOLD=_e.propertyNameToID("u_Threshold"),$i.SHADERVALUE_PARAMS=_e.propertyNameToID("u_Params"),$i.SHADERVALUE_BLOOMTEX=_e.propertyNameToID("u_BloomTex"),$i.SUBSHADER_PREFILTER13=0,$i.SUBSHADER_PREFILTER4=1,$i.SUBSHADER_DOWNSAMPLE13=2,$i.SUBSHADER_DOWNSAMPLE4=3,$i.SUBSHADER_UPSAMPLETENT=4,$i.SUBSHADER_UPSAMPLEBOX=5,$i.MAXPYRAMIDSIZE=16;var ea,ta=function(){function MaterialInstanceProperty(){_classCallCheck(this,MaterialInstanceProperty),this._isNeedUpdate=!1}return _createClass(MaterialInstanceProperty,[{key:"createInstanceVertexBuffer3D",value:function(){var e=t.LayaGL.instance;this._instanceData=new Float32Array(et.maxInstanceCount*this._vertexStride),this._vertexBuffer=new te(4*this._instanceData.length,e.DYNAMIC_DRAW),this._vertexBuffer.vertexDeclaration=this._vertexDeclaration}},{key:"updateVertexBufferData",value:function(e){if(this._isNeedUpdate){var t=this._instanceData,n=this._value,i=this._value.length,a=this._vertexStride,r=0;switch(this._value instanceof Float32Array||(r=1),r){case 0:t.set(n,0);break;case 1:for(var o=0;o<i;o++)n[o].toArray(t,o*a)}this._vertexBuffer.orphanStorage(),this._vertexBuffer.setData(t.buffer,0,0,4*e*(r?a:1))}}}]),MaterialInstanceProperty}();(ea=e.InstanceLocation||(e.InstanceLocation={}))[ea.CUSTOME0=12]="CUSTOME0",ea[ea.CUSTOME1=13]="CUSTOME1",ea[ea.CUSTOME2=14]="CUSTOME2",ea[ea.CUSTOME3=15]="CUSTOME3";var na=function(){function MaterialInstancePropertyBlock(){_classCallCheck(this,MaterialInstancePropertyBlock),this._type=0,this._propertyMap={}}return _createClass(MaterialInstancePropertyBlock,[{key:"_checkPropertyLegal",value:function(e,t,n,i){if(i._vertexDeclaration._vertexElements[0]._elementFormat!==e)throw"Data exists and format does not match";if(i._name!==t)throw"You cannot add a new property to an existing attributeLocation,Please use another attributeLocation"}},{key:"_creatProperty",value:function(e,t,n,i,a){var r=this._propertyMap[a]=new ta;r._name=e,r._value=t,r._vertexDeclaration=new ae(n,[new re(0,i,a)]),r._isNeedUpdate=!0,r._vertexStride=n/4,r.createInstanceVertexBuffer3D()}},{key:"setVectorArray",value:function(e,t,n){var i=this._propertyMap[n];i?(this._checkPropertyLegal(ne.Vector4,e,n,i),i._value=t,i._isNeedUpdate=!0):this._creatProperty(e,t,16,ne.Vector4,n)}},{key:"setVector3Array",value:function(e,t,n){var i=this._propertyMap[n];i?(this._checkPropertyLegal(ne.Vector3,e,n,i),i._value=t,i._isNeedUpdate=!0):this._creatProperty(e,t,12,ne.Vector3,n)}},{key:"setVector2Array",value:function(e,t,n){var i=this._propertyMap[n];i?(this._checkPropertyLegal(ne.Vector2,e,n,i),i._value=t,i._isNeedUpdate=!0):this._creatProperty(e,t,8,ne.Vector2,n)}},{key:"setNumberArray",value:function(e,t,n){var i=this._propertyMap[n];i?(this._checkPropertyLegal(ne.Single,e,n,i),i._value=t,i._isNeedUpdate=!0):this._creatProperty(e,t,4,ne.Single,n)}},{key:"getPropertyArray",value:function(e){var t=this._propertyMap[e];return t?t._value:null}},{key:"clear",value:function(){this._propertyMap={}}}]),MaterialInstancePropertyBlock}();na.INSTANCETYPE_ATTRIBUTE=0,na.INSTANCETYPE_UNIFORMBUFFER=1;var ia=function(){function ConchVector4(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;_classCallCheck(this,ConchVector4);var a=this.elements=new Float32Array(4);a[0]=e,a[1]=t,a[2]=n,a[3]=i}return _createClass(ConchVector4,[{key:"fromArray",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;this.elements[0]=e[t+0],this.elements[1]=e[t+1],this.elements[2]=e[t+2],this.elements[3]=e[t+3]}},{key:"cloneTo",value:function(e){var t=e.elements,n=this.elements;t[0]=n[0],t[1]=n[1],t[2]=n[2],t[3]=n[3]}},{key:"clone",value:function(){var e=new ConchVector4;return this.cloneTo(e),e}},{key:"length",value:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}},{key:"lengthSquared",value:function(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}},{key:"x",get:function(){return this.elements[0]},set:function(e){this.elements[0]=e}},{key:"y",get:function(){return this.elements[1]},set:function(e){this.elements[1]=e}},{key:"z",get:function(){return this.elements[2]},set:function(e){this.elements[2]=e}},{key:"w",get:function(){return this.elements[3]},set:function(e){this.elements[3]=e}}],[{key:"lerp",value:function(e,t,n,i){var a=i.elements,r=e.elements,o=t.elements,s=r[0],l=r[1],u=r[2],c=r[3];a[0]=s+n*(o[0]-s),a[1]=l+n*(o[1]-l),a[2]=u+n*(o[2]-u),a[3]=c+n*(o[3]-c)}},{key:"transformByM4x4",value:function(e,t,n){var i=e.elements,a=i[0],r=i[1],o=i[2],s=i[3],l=t.elements,u=n.elements;u[0]=a*l[0]+r*l[4]+o*l[8]+s*l[12],u[1]=a*l[1]+r*l[5]+o*l[9]+s*l[13],u[2]=a*l[2]+r*l[6]+o*l[10]+s*l[14],u[3]=a*l[3]+r*l[7]+o*l[11]+s*l[15]}},{key:"equals",value:function(e,t){var i=e.elements,a=t.elements;return n.nearEqual(Math.abs(i[0]),Math.abs(a[0]))&&n.nearEqual(Math.abs(i[1]),Math.abs(a[1]))&&n.nearEqual(Math.abs(i[2]),Math.abs(a[2]))&&n.nearEqual(Math.abs(i[3]),Math.abs(a[3]))}},{key:"normalize",value:function(e,t){var n=e.elements,i=t.elements,a=e.length();a>0&&(i[0]=n[0]*a,i[1]=n[1]*a,i[2]=n[2]*a,i[3]=n[3]*a)}},{key:"add",value:function(e,t,n){var i=n.elements,a=e.elements,r=t.elements;i[0]=a[0]+r[0],i[1]=a[1]+r[1],i[2]=a[2]+r[2],i[3]=a[3]+r[3]}},{key:"subtract",value:function(e,t,n){var i=n.elements,a=e.elements,r=t.elements;i[0]=a[0]-r[0],i[1]=a[1]-r[1],i[2]=a[2]-r[2],i[3]=a[3]-r[3]}},{key:"multiply",value:function(e,t,n){var i=n.elements,a=e.elements,r=t.elements;i[0]=a[0]*r[0],i[1]=a[1]*r[1],i[2]=a[2]*r[2],i[3]=a[3]*r[3]}},{key:"scale",value:function(e,t,n){var i=n.elements,a=e.elements;i[0]=a[0]*t,i[1]=a[1]*t,i[2]=a[2]*t,i[3]=a[3]*t}},{key:"Clamp",value:function(e,t,n,i){var a=e.elements,r=a[0],o=a[1],s=a[2],l=a[3],u=t.elements,c=u[0],h=u[1],_=u[2],d=u[3],f=n.elements,m=f[0],p=f[1],T=f[2],v=f[3],g=i.elements;r=(r=r>m?m:r)<c?c:r,o=(o=o>p?p:o)<h?h:o,s=(s=s>T?T:s)<_?_:s,l=(l=l>v?v:l)<d?d:l,g[0]=r,g[1]=o,g[2]=s,g[3]=l}},{key:"distanceSquared",value:function(e,t){var n=e.elements,i=t.elements,a=n[0]-i[0],r=n[1]-i[1],o=n[2]-i[2],s=n[3]-i[3];return a*a+r*r+o*o+s*s}},{key:"distance",value:function(e,t){var n=e.elements,i=t.elements,a=n[0]-i[0],r=n[1]-i[1],o=n[2]-i[2],s=n[3]-i[3];return Math.sqrt(a*a+r*r+o*o+s*s)}},{key:"dot",value:function(e,t){var n=e.elements,i=t.elements;return n[0]*i[0]+n[1]*i[1]+n[2]*i[2]+n[3]*i[3]}},{key:"min",value:function(e,t,n){var i=n.elements,a=e.elements,r=t.elements;i[0]=Math.min(a[0],r[0]),i[1]=Math.min(a[1],r[1]),i[2]=Math.min(a[2],r[2]),i[3]=Math.min(a[3],r[3])}},{key:"max",value:function(e,t,n){var i=n.elements,a=e.elements,r=t.elements;i[0]=Math.max(a[0],r[0]),i[1]=Math.max(a[1],r[1]),i[2]=Math.max(a[2],r[2]),i[3]=Math.max(a[3],r[3])}}]),ConchVector4}();ia.ZERO=new ia,ia.ONE=new ia(1,1,1,1),ia.UnitX=new ia(1,0,0,0),ia.UnitY=new ia(0,1,0,0),ia.UnitZ=new ia(0,0,1,0),ia.UnitW=new ia(0,0,0,1);var aa=function(){function ConchVector3(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;_classCallCheck(this,ConchVector3),e=a||new Float32Array(3),this.elements=e,e[0]=t,e[1]=n,e[2]=i}return _createClass(ConchVector3,[{key:"setValue",value:function(e,t,n){this.elements[0]=e,this.elements[1]=t,this.elements[2]=n}},{key:"fromArray",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;this.elements[0]=e[t+0],this.elements[1]=e[t+1],this.elements[2]=e[t+2]}},{key:"cloneTo",value:function(e){var t=e.elements,n=this.elements;t[0]=n[0],t[1]=n[1],t[2]=n[2]}},{key:"clone",value:function(){var e=new ConchVector3;return this.cloneTo(e),e}},{key:"toDefault",value:function(){this.elements[0]=0,this.elements[1]=0,this.elements[2]=0}},{key:"x",get:function(){return this.elements[0]},set:function(e){this.elements[0]=e}},{key:"y",get:function(){return this.elements[1]},set:function(e){this.elements[1]=e}},{key:"z",get:function(){return this.elements[2]},set:function(e){this.elements[2]=e}}],[{key:"distanceSquared",value:function(e,t){var n=e.elements,i=t.elements,a=n[0]-i[0],r=n[1]-i[1],o=n[2]-i[2];return a*a+r*r+o*o}},{key:"distance",value:function(e,t){var n=e.elements,i=t.elements,a=n[0]-i[0],r=n[1]-i[1],o=n[2]-i[2];return Math.sqrt(a*a+r*r+o*o)}},{key:"min",value:function(e,t,n){var i=n.elements,a=e.elements,r=t.elements;i[0]=Math.min(a[0],r[0]),i[1]=Math.min(a[1],r[1]),i[2]=Math.min(a[2],r[2])}},{key:"max",value:function(e,t,n){var i=n.elements,a=e.elements,r=t.elements;i[0]=Math.max(a[0],r[0]),i[1]=Math.max(a[1],r[1]),i[2]=Math.max(a[2],r[2])}},{key:"transformQuat",value:function(e,t,n){var i=n.elements,a=e.elements,r=t.elements,o=a[0],s=a[1],l=a[2],u=r[0],c=r[1],h=r[2],_=r[3],d=_*o+c*l-h*s,f=_*s+h*o-u*l,m=_*l+u*s-c*o,p=-u*o-c*s-h*l;i[0]=d*_+p*-u+f*-h-m*-c,i[1]=f*_+p*-c+m*-u-d*-h,i[2]=m*_+p*-h+d*-c-f*-u}},{key:"scalarLength",value:function(e){var t=e.elements,n=t[0],i=t[1],a=t[2];return Math.sqrt(n*n+i*i+a*a)}},{key:"scalarLengthSquared",value:function(e){var t=e.elements,n=t[0],i=t[1],a=t[2];return n*n+i*i+a*a}},{key:"normalize",value:function(e,t){var n=e.elements,i=t.elements,a=n[0],r=n[1],o=n[2],s=a*a+r*r+o*o;s>0&&(s=1/Math.sqrt(s),i[0]=n[0]*s,i[1]=n[1]*s,i[2]=n[2]*s)}},{key:"multiply",value:function(e,t,n){var i=n.elements,a=e.elements,r=t.elements;i[0]=a[0]*r[0],i[1]=a[1]*r[1],i[2]=a[2]*r[2]}},{key:"scale",value:function(e,t,n){var i=n.elements,a=e.elements;i[0]=a[0]*t,i[1]=a[1]*t,i[2]=a[2]*t}},{key:"lerp",value:function(e,t,n,i){var a=i.elements,r=e.elements,o=t.elements,s=r[0],l=r[1],u=r[2];a[0]=s+n*(o[0]-s),a[1]=l+n*(o[1]-l),a[2]=u+n*(o[2]-u)}},{key:"transformV3ToV3",value:function(e,t,n){var i=ConchVector3._tempVector4;ConchVector3.transformV3ToV4(e,t,i);var a=i.elements,r=n.elements;r[0]=a[0],r[1]=a[1],r[2]=a[2]}},{key:"transformV3ToV4",value:function(e,t,n){var i=e.elements,a=i[0],r=i[1],o=i[2],s=t.elements,l=n.elements;l[0]=a*s[0]+r*s[4]+o*s[8]+s[12],l[1]=a*s[1]+r*s[5]+o*s[9]+s[13],l[2]=a*s[2]+r*s[6]+o*s[10]+s[14],l[3]=a*s[3]+r*s[7]+o*s[11]+s[15]}},{key:"TransformNormal",value:function(e,t,n){var i=e.elements,a=i[0],r=i[1],o=i[2],s=t.elements,l=n.elements;l[0]=a*s[0]+r*s[4]+o*s[8],l[1]=a*s[1]+r*s[5]+o*s[9],l[2]=a*s[2]+r*s[6]+o*s[10]}},{key:"transformCoordinate",value:function(e,t,n){var i=e.elements,a=i[0],r=i[1],o=i[2],s=t.elements,l=a*s[3]+r*s[7]+o*s[11]+s[15],u=n.elements;u[0]=a*s[0]+r*s[4]+o*s[8]+s[12]/l,u[1]=a*s[1]+r*s[5]+o*s[9]+s[13]/l,u[2]=a*s[2]+r*s[6]+o*s[10]+s[14]/l}},{key:"Clamp",value:function(e,t,n,i){var a=e.elements,r=a[0],o=a[1],s=a[2],l=t.elements,u=l[0],c=l[1],h=l[2],_=n.elements,d=_[0],f=_[1],m=_[2],p=i.elements;r=(r=r>d?d:r)<u?u:r,o=(o=o>f?f:o)<c?c:o,s=(s=s>m?m:s)<h?h:s,p[0]=r,p[1]=o,p[2]=s}},{key:"add",value:function(e,t,n){var i=n.elements,a=e.elements,r=t.elements;i[0]=a[0]+r[0],i[1]=a[1]+r[1],i[2]=a[2]+r[2]}},{key:"subtract",value:function(e,t,n){var i=n.elements,a=e.elements,r=t.elements;i[0]=a[0]-r[0],i[1]=a[1]-r[1],i[2]=a[2]-r[2]}},{key:"cross",value:function(e,t,n){var i=e.elements,a=t.elements,r=n.elements,o=i[0],s=i[1],l=i[2],u=a[0],c=a[1],h=a[2];r[0]=s*h-l*c,r[1]=l*u-o*h,r[2]=o*c-s*u}},{key:"dot",value:function(e,t){var n=e.elements,i=t.elements;return n[0]*i[0]+n[1]*i[1]+n[2]*i[2]}},{key:"equals",value:function(e,t){var i=e.elements,a=t.elements;return n.nearEqual(i[0],a[0])&&n.nearEqual(i[1],a[1])&&n.nearEqual(i[2],a[2])}}]),ConchVector3}();aa._tempVector4=new ia,aa.ZERO=new aa(0,0,0),aa.ONE=new aa(1,1,1),aa.NegativeUnitX=new aa(-1,0,0),aa.UnitX=new aa(1,0,0),aa.UnitY=new aa(0,1,0),aa.UnitZ=new aa(0,0,1),aa.ForwardRH=new aa(0,0,-1),aa.ForwardLH=new aa(0,0,1),aa.Up=new aa(0,1,0),aa.NAN=new aa(NaN,NaN,NaN);var ra=function(){function ConchQuaternion(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;_classCallCheck(this,ConchQuaternion),(e=r||new Float32Array(4))[0]=t,e[1]=n,e[2]=i,e[3]=a,this.elements=e}return _createClass(ConchQuaternion,[{key:"scaling",value:function(e,t){var n=t.elements,i=this.elements;n[0]=i[0]*e,n[1]=i[1]*e,n[2]=i[2]*e,n[3]=i[3]*e}},{key:"normalize",value:function(e){ConchQuaternion._normalizeArray(this.elements,e.elements)}},{key:"length",value:function(){var e=this.elements,t=e[0],n=e[1],i=e[2],a=e[3];return Math.sqrt(t*t+n*n+i*i+a*a)}},{key:"rotateX",value:function(e,t){var n=t.elements,i=this.elements;e*=.5;var a=i[0],r=i[1],o=i[2],s=i[3],l=Math.sin(e),u=Math.cos(e);n[0]=a*u+s*l,n[1]=r*u+o*l,n[2]=o*u-r*l,n[3]=s*u-a*l}},{key:"rotateY",value:function(e,t){var n=t.elements,i=this.elements;e*=.5;var a=i[0],r=i[1],o=i[2],s=i[3],l=Math.sin(e),u=Math.cos(e);n[0]=a*u-o*l,n[1]=r*u+s*l,n[2]=o*u+a*l,n[3]=s*u-r*l}},{key:"rotateZ",value:function(e,t){var n=t.elements,i=this.elements;e*=.5;var a=i[0],r=i[1],o=i[2],s=i[3],l=Math.sin(e),u=Math.cos(e);n[0]=a*u+r*l,n[1]=r*u-a*l,n[2]=o*u+s*l,n[3]=s*u-o*l}},{key:"getYawPitchRoll",value:function(e){aa.transformQuat(aa.ForwardRH,this,ConchQuaternion.TEMPVector31),aa.transformQuat(aa.Up,this,ConchQuaternion.TEMPVector32);var t=ConchQuaternion.TEMPVector32.elements;ConchQuaternion.angleTo(aa.ZERO,ConchQuaternion.TEMPVector31,ConchQuaternion.TEMPVector33);var n=ConchQuaternion.TEMPVector33.elements;n[0]==Math.PI/2?(n[1]=ConchQuaternion.arcTanAngle(t[2],t[0]),n[2]=0):n[0]==-Math.PI/2?(n[1]=ConchQuaternion.arcTanAngle(-t[2],-t[0]),n[2]=0):(c.createRotationY(-n[1],ConchQuaternion.TEMPMatrix0),c.createRotationX(-n[0],ConchQuaternion.TEMPMatrix1),aa.transformCoordinate(ConchQuaternion.TEMPVector32,ConchQuaternion.TEMPMatrix0,ConchQuaternion.TEMPVector32),aa.transformCoordinate(ConchQuaternion.TEMPVector32,ConchQuaternion.TEMPMatrix1,ConchQuaternion.TEMPVector32),n[2]=ConchQuaternion.arcTanAngle(t[1],-t[0])),n[1]<=-Math.PI&&(n[1]=Math.PI),n[2]<=-Math.PI&&(n[2]=Math.PI),n[1]>=Math.PI&&n[2]>=Math.PI&&(n[1]=0,n[2]=0,n[0]=Math.PI-n[0]);var i=e.elements;i[0]=n[1],i[1]=n[0],i[2]=n[2]}},{key:"invert",value:function(e){var t=e.elements,n=this.elements,i=n[0],a=n[1],r=n[2],o=n[3],s=i*i+a*a+r*r+o*o,l=s?1/s:0;t[0]=-i*l,t[1]=-a*l,t[2]=-r*l,t[3]=o*l}},{key:"identity",value:function(){var e=this.elements;e[0]=0,e[1]=0,e[2]=0,e[3]=1}},{key:"fromArray",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;this.elements[0]=e[t+0],this.elements[1]=e[t+1],this.elements[2]=e[t+2],this.elements[3]=e[t+3]}},{key:"cloneTo",value:function(e){var t,n,i;if((n=this.elements)!==(i=e.elements))for(t=0;t<4;++t)i[t]=n[t]}},{key:"clone",value:function(){var e=new ConchQuaternion;return this.cloneTo(e),e}},{key:"equals",value:function(e){var t=this.elements,i=e.elements;return n.nearEqual(t[0],i[0])&&n.nearEqual(t[1],i[1])&&n.nearEqual(t[2],i[2])&&n.nearEqual(t[3],i[3])}},{key:"lengthSquared",value:function(){var e=this.elements[0],t=this.elements[1],n=this.elements[2],i=this.elements[3];return e*e+t*t+n*n+i*i}},{key:"x",get:function(){return this.elements[0]},set:function(e){this.elements[0]=e}},{key:"y",get:function(){return this.elements[1]},set:function(e){this.elements[1]=e}},{key:"z",get:function(){return this.elements[2]},set:function(e){this.elements[2]=e}},{key:"w",get:function(){return this.elements[3]},set:function(e){this.elements[3]=e}}],[{key:"_dotArray",value:function(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]+e[3]*t[3]}},{key:"_normalizeArray",value:function(e,t){var n=e[0],i=e[1],a=e[2],r=e[3],o=n*n+i*i+a*a+r*r;o>0&&(o=1/Math.sqrt(o),t[0]=n*o,t[1]=i*o,t[2]=a*o,t[3]=r*o)}},{key:"_lerpArray",value:function(e,t,n,i){var a=1-n;ConchQuaternion._dotArray(e,t)>=0?(i[0]=a*e[0]+n*t[0],i[1]=a*e[1]+n*t[1],i[2]=a*e[2]+n*t[2],i[3]=a*e[3]+n*t[3]):(i[0]=a*e[0]-n*t[0],i[1]=a*e[1]-n*t[1],i[2]=a*e[2]-n*t[2],i[3]=a*e[3]-n*t[3]),ConchQuaternion._normalizeArray(i,i)}},{key:"createFromYawPitchRoll",value:function(e,t,n,i){var a=.5*n,r=.5*t,o=.5*e,s=Math.sin(a),l=Math.cos(a),u=Math.sin(r),c=Math.cos(r),h=Math.sin(o),_=Math.cos(o),d=i.elements;d[0]=_*u*l+h*c*s,d[1]=h*c*l-_*u*s,d[2]=_*c*s-h*u*l,d[3]=_*c*l+h*u*s}},{key:"multiply",value:function(e,t,n){var i=e.elements,a=t.elements,r=n.elements,o=i[0],s=i[1],l=i[2],u=i[3],c=a[0],h=a[1],_=a[2],d=a[3],f=s*_-l*h,m=l*c-o*_,p=o*h-s*c,T=o*c+s*h+l*_;r[0]=o*d+c*u+f,r[1]=s*d+h*u+m,r[2]=l*d+_*u+p,r[3]=u*d-T}},{key:"arcTanAngle",value:function(e,t){return 0==e?1==t?Math.PI/2:-Math.PI/2:e>0?Math.atan(t/e):e<0?t>0?Math.atan(t/e)+Math.PI:Math.atan(t/e)-Math.PI:0}},{key:"angleTo",value:function(e,t,n){aa.subtract(t,e,ConchQuaternion.TEMPVector30),aa.normalize(ConchQuaternion.TEMPVector30,ConchQuaternion.TEMPVector30),n.elements[0]=Math.asin(ConchQuaternion.TEMPVector30.y),n.elements[1]=ConchQuaternion.arcTanAngle(-ConchQuaternion.TEMPVector30.z,-ConchQuaternion.TEMPVector30.x)}},{key:"createFromAxisAngle",value:function(e,t,n){var i=n.elements,a=e.elements;t*=.5;var r=Math.sin(t);i[0]=r*a[0],i[1]=r*a[1],i[2]=r*a[2],i[3]=Math.cos(t)}},{key:"createFromMatrix3x3",value:function(e,t){var n,i=t.elements,a=e.elements,r=a[0]+a[4]+a[8];if(r>0)n=Math.sqrt(r+1),i[3]=.5*n,n=.5/n,i[0]=(a[5]-a[7])*n,i[1]=(a[6]-a[2])*n,i[2]=(a[1]-a[3])*n;else{var o=0;a[4]>a[0]&&(o=1),a[8]>a[3*o+o]&&(o=2);var s=(o+1)%3,l=(o+2)%3;n=Math.sqrt(a[3*o+o]-a[3*s+s]-a[3*l+l]+1),i[o]=.5*n,n=.5/n,i[3]=(a[3*s+l]-a[3*l+s])*n,i[s]=(a[3*s+o]+a[3*o+s])*n,i[l]=(a[3*l+o]+a[3*o+l])*n}}},{key:"createFromMatrix4x4",value:function(e,t){var n,i,a=e.elements,r=t.elements,o=a[0]+a[5]+a[10];o>0?(n=Math.sqrt(o+1),r[3]=.5*n,n=.5/n,r[0]=(a[6]-a[9])*n,r[1]=(a[8]-a[2])*n,r[2]=(a[1]-a[4])*n):a[0]>=a[5]&&a[0]>=a[10]?(i=.5/(n=Math.sqrt(1+a[0]-a[5]-a[10])),r[0]=.5*n,r[1]=(a[1]+a[4])*i,r[2]=(a[2]+a[8])*i,r[3]=(a[6]-a[9])*i):a[5]>a[10]?(i=.5/(n=Math.sqrt(1+a[5]-a[0]-a[10])),r[0]=(a[4]+a[1])*i,r[1]=.5*n,r[2]=(a[9]+a[6])*i,r[3]=(a[8]-a[2])*i):(i=.5/(n=Math.sqrt(1+a[10]-a[0]-a[5])),r[0]=(a[8]+a[2])*i,r[1]=(a[9]+a[6])*i,r[2]=.5*n,r[3]=(a[1]-a[4])*i)}},{key:"slerp",value:function(e,t,n,i){var a,r,o,s,l,u=e.elements,c=t.elements,h=i.elements,_=u[0],d=u[1],f=u[2],m=u[3],p=c[0],T=c[1],v=c[2],g=c[3];return(r=_*p+d*T+f*v+m*g)<0&&(r=-r,p=-p,T=-T,v=-v,g=-g),1-r>1e-6?(a=Math.acos(r),o=Math.sin(a),s=Math.sin((1-n)*a)/o,l=Math.sin(n*a)/o):(s=1-n,l=n),h[0]=s*_+l*p,h[1]=s*d+l*T,h[2]=s*f+l*v,h[3]=s*m+l*g,h}},{key:"lerp",value:function(e,t,n,i){ConchQuaternion._lerpArray(e.elements,t.elements,n,i.elements)}},{key:"add",value:function(e,t,n){var i=n.elements,a=e.elements,r=t.elements;i[0]=a[0]+r[0],i[1]=a[1]+r[1],i[2]=a[2]+r[2],i[3]=a[3]+r[3]}},{key:"dot",value:function(e,t){return ConchQuaternion._dotArray(e.elements,t.elements)}},{key:"rotationLookAt",value:function(e,t,n){ConchQuaternion.lookAt(aa.ZERO,e,t,n)}},{key:"lookAt",value:function(e,t,n,i){s.lookAt(e,t,n,ConchQuaternion._tempMatrix3x3),ConchQuaternion.rotationMatrix(ConchQuaternion._tempMatrix3x3,i)}},{key:"invert",value:function(e,t){var i=e.elements,a=t.elements,r=e.lengthSquared();n.isZero(r)||(r=1/r,a[0]=-i[0]*r,a[1]=-i[1]*r,a[2]=-i[2]*r,a[3]=i[3]*r)}},{key:"rotationMatrix",value:function(e,t){var n,i,a=e.elements,r=a[0],o=a[1],s=a[2],l=a[3],u=a[4],c=a[5],h=a[6],_=a[7],d=a[8],f=t.elements,m=r+u+d;m>0?(n=Math.sqrt(m+1),f[3]=.5*n,n=.5/n,f[0]=(c-_)*n,f[1]=(h-s)*n,f[2]=(o-l)*n):r>=u&&r>=d?(i=.5/(n=Math.sqrt(1+r-u-d)),f[0]=.5*n,f[1]=(o+l)*i,f[2]=(s+h)*i,f[3]=(c-_)*i):u>d?(i=.5/(n=Math.sqrt(1+u-r-d)),f[0]=(l+o)*i,f[1]=.5*n,f[2]=(_+c)*i,f[3]=(h-s)*i):(i=.5/(n=Math.sqrt(1+d-r-u)),f[0]=(h+s)*i,f[1]=(_+c)*i,f[2]=.5*n,f[3]=(o-l)*i)}}]),ConchQuaternion}();ra.TEMPVector30=new aa,ra.TEMPVector31=new aa,ra.TEMPVector32=new aa,ra.TEMPVector33=new aa,ra.TEMPMatrix0=new c,ra.TEMPMatrix1=new c,ra._tempMatrix3x3=new s,ra.DEFAULT=new ra,ra.NAN=new ra(NaN,NaN,NaN,NaN);var oa=function(){function RandX(e){if(_classCallCheck(this,RandX),!(e instanceof Array)||4!==e.length)throw new Error("Rand:Seed must be an array with 4 numbers");this._state0U=0|e[0],this._state0L=0|e[1],this._state1U=0|e[2],this._state1L=0|e[3]}return _createClass(RandX,[{key:"randomint",value:function(){var e=this._state0U,t=this._state0L,n=this._state1U,i=this._state1L,a=(i>>>0)+(t>>>0),r=n+e+(a/2>>>31)>>>0,o=a>>>0;this._state0U=n,this._state0L=i;var s=0,l=0;s=(e^=s=e<<23|(-512&t)>>>9)^n,l=(t^=l=t<<23)^i;s^=e>>>18,l^=t>>>18|(262143&e)<<14;return s^=n>>>5,l^=i>>>5|(31&n)<<27,this._state1U=s,this._state1L=l,[r,o]}},{key:"random",value:function(){var e=this.randomint(),t=e[0],n=1023<<20|t>>>12,i=0|(e[1]>>>12|(4095&t)<<20);return RandX._CONVERTION_BUFFER.setUint32(0,n,!1),RandX._CONVERTION_BUFFER.setUint32(4,i,!1),RandX._CONVERTION_BUFFER.getFloat64(0,!1)-1}}]),RandX}();oa._CONVERTION_BUFFER=new DataView(new ArrayBuffer(8)),oa.defaultRand=new oa([0,Date.now()/65536,0,Date.now()%65536]);var sa=function(){function TextMesh(){_classCallCheck(this,TextMesh)}return _createClass(TextMesh,[{key:"text",get:function(){return this._text},set:function(e){this._text=e}},{key:"fontSize",get:function(){return this._fontSize},set:function(e){this._fontSize=e}},{key:"color",get:function(){return this._color},set:function(e){this._color=e}}]),TextMesh}(),la=function(){function Size(e,t){_classCallCheck(this,Size),this._width=0,this._height=0,this._width=e,this._height=t}return _createClass(Size,[{key:"width",get:function(){return-1===this._width?J.clientWidth:this._width}},{key:"height",get:function(){return-1===this._height?J.clientHeight:this._height}}],[{key:"fullScreen",get:function(){return new Size(-1,-1)}}]),Size}();e.AlternateLightQueue=bt,e.AnimationClip=Y,e.AnimationClipParser03=z,e.AnimationClipParser04=W,e.AnimationEvent=V,e.AnimationNode=rt,e.AnimationTransform3D=at,e.Animator=K,e.AnimatorControllerLayer=Z,e.AnimatorPlayState=j,e.AnimatorState=Q,e.AnimatorStateScript=Yi,e.Avatar=ot,e.BaseCamera=Ve,e.BaseMaterial=lt,e.BaseRender=qt,e.BaseShape=zn,e.BatchMark=Ht,e.BlinnPhongMaterial=ct,e.BlitScreenQuadCMD=fe,e.BloomEffect=$i,e.BoundBox=wt,e.BoundFrustum=Ae,e.BoundSphere=rn,e.Bounds=Bt,e.BoundsOctree=nn,e.BoundsOctreeNode=en,e.BoxColliderShape=p,e.BoxShape=Xn,e.BufferState=oe,e.BulletInteractive=Ri,e.Burst=Nn,e.Camera=Qe,e.CameraCullInfo=yt,e.CapsuleColliderShape=T,e.CastShadowList=Xi,e.CharacterController=O,e.CircleShape=Yn,e.ClearRenderTextureCMD=Ee,e.Cluster=Se,e.ColliderShape=h,e.Collision=x,e.CollisionTool=A,e.CollisionUtils=xe,e.Color=Et,e.ColorOverLifetime=kn,e.Command=de,e.CommandBuffer=tt,e.CompoundColliderShape=d,e.ConchQuaternion=ra,e.ConchVector3=aa,e.ConchVector4=ia,e.ConeColliderShape=v,e.ConeShape=jn,e.Config3D=w,e.ConfigurableConstraint=zi,e.Constraint3D=function Constraint3D(){_classCallCheck(this,Constraint3D)},e.ConstraintComponent=Gi,e.ContactPoint=M,e.ContainmentType=Me,e.CylinderColliderShape=g,e.DefineDatas=ee,e.DepthPass=Ze,e.DirectionLight=Pi,e.DrawMeshCMD=ge,e.DrawMeshInstancedCMD=et,e.DrawRenderCMD=Ke,e.DynamicBatchManager=cn,e.EffectMaterial=ht,e.Emission=si,e.ExtendTerrainMaterial=dt,e.FixedConstraint=Hi,e.FloatKeyframe=U,e.FrameOverTime=wn,e.FrustumCulling=Rt,e.GeometryElement=Vt,e.Gradient=On,e.GradientAngularVelocity=Bn,e.GradientColor=bn,e.GradientDataInt=Vn,e.GradientDataNumber=Fn,e.GradientDataVector2=qi,e.GradientMode=Ln,e.GradientSize=Un,e.GradientVelocity=Gn,e.HeightMap=Zi,e.HemisphereShape=Zn,e.HitResult=D,e.ILaya3D=l,e.IndexBuffer3D=Oe,e.Input3D=xt,e.Keyframe=F,e.KeyframeNode=B,e.KeyframeNodeList=X,e.KeyframeNodeOwner=q,e.Laya3D=Wi,e.LightQueue=Nt,e.LightSprite=ze,e.Lightmap=an,e.LoadModelV04=Bi,e.LoadModelV05=Vi,e.Material=st,e.MaterialInstanceProperty=ta,e.MaterialInstancePropertyBlock=na,e.MathUtils3D=n,e.Matrix3x3=s,e.Matrix4x4=c,e.Mesh=xi,e.MeshColliderShape=E,e.MeshFilter=Dn,e.MeshReader=Fi,e.MeshRenderDynamicBatchManager=An,e.MeshRenderStaticBatchManager=Zt,e.MeshRenderer=Mn,e.MeshSprite3D=In,e.MeshSprite3DShaderDeclaration=$e,e.MeshTerrainSprite3D=Qi,e.MouseTouch=Mt,e.OctreeMotionList=tn,e.PBRMaterial=ft,e.PBRSpecularMaterial=vn,e.PBRStandardMaterial=En,e.Physics3D=k,e.Physics3DUtils=m,e.PhysicsCollider=Ci,e.PhysicsComponent=S,e.PhysicsSettings=It,e.PhysicsSimulation=I,e.PhysicsTriggerComponent=N,e.PhysicsUpdateList=C,e.Picker=Pe,e.PixelLineData=Ki,e.PixelLineFilter=Ut,e.PixelLineMaterial=kt,e.PixelLineRenderer=Kt,e.PixelLineSprite3D=Jt,e.PixelLineVertex=Ft,e.Plane=Re,e.PointLight=Oi,e.PostProcess=it,e.PostProcessEffect=Ji,e.PostProcessRenderContext=nt,e.PrimitiveMesh=Ai,e.Quaternion=u,e.QuaternionKeyframe=G,e.Rand=oi,e.RandX=oa,e.Ray=Ce,e.ReflectionProbe=Qt,e.ReflectionProbeList=_n,e.ReflectionProbeManager=dn,e.RenderContext3D=J,e.RenderElement=qe,e.RenderQueue=$t,e.RenderState=ut,e.RenderTexture=$,e.RenderableSprite3D=Gt,e.Rigidbody3D=b,e.RotationOverLifetime=Hn,e.Scene3D=fn,e.Scene3DShaderDeclaration=Ue,e.Scene3DUtils=wi,e.ScreenQuad=se,e.ScreenTriangle=le,e.Script3D=ji,e.SetGlobalShaderDataCMD=Je,e.SetRenderTargetCMD=pe,e.SetShaderDataCMD=Te,e.Shader3D=_e,e.ShaderData=ie,e.ShaderDefine=ue,e.ShaderInit3D=Li,e.ShaderInstance=vt,e.ShaderPass=mn,e.ShaderVariable=Tt,e.ShaderVariant=ce,e.ShaderVariantCollection=he,e.ShadowCasterPass=un,e.ShadowCullInfo=St,e.ShadowSliceData=sn,e.ShadowSpotData=ln,e.ShadowUtils=Xe,e.ShapeUtils=Wn,e.ShuriKenParticle3D=ci,e.ShuriKenParticle3DShaderDeclaration=ei,e.ShurikenParticleData=li,e.ShurikenParticleMaterial=ti,e.ShurikenParticleRenderer=ni,e.ShurikenParticleSystem=ui,e.SimpleSingletonList=gt,e.SimpleSkinnedMeshRenderer=bi,e.SimpleSkinnedMeshSprite3D=ki,e.SingletonList=R,e.Size=la,e.SizeOverLifetime=qn,e.SkinnedMeshRenderer=_i,e.SkinnedMeshSprite3D=di,e.SkinnedMeshSprite3DShaderDeclaration=hi,e.SkyBox=ke,e.SkyBoxMaterial=yn,e.SkyDome=Pt,e.SkyMesh=be,e.SkyPanoramicMaterial=Ui,e.SkyProceduralMaterial=Sn,e.SkyRenderer=we,e.SphereColliderShape=y,e.SphereShape=Qn,e.SphericalHarmonicsL2=Ct,e.SpotLight=Ni,e.Sprite3D=ve,e.StartFrame=Kn,e.StaticBatchManager=Xt,e.StaticPlaneColliderShape=_,e.SubMesh=Mi,e.SubMeshDynamicBatch=xn,e.SubMeshInstanceBatch=zt,e.SubMeshRenderElement=Wt,e.SubMeshStaticBatch=Yt,e.SubShader=Tn,e.TextMesh=sa,e.TextureCube=Ot,e.TextureGenerator=L,e.TextureMode=pi,e.TextureSheetAnimation=Jn,e.Touch=Dt,e.TrailFilter=gi,e.TrailGeometry=vi,e.TrailMaterial=fi,e.TrailRenderer=Ei,e.TrailSprite3D=yi,e.Transform3D=f,e.UnlitMaterial=Rn,e.Utils3D=P,e.Vector2=i,e.Vector3=o,e.Vector3Keyframe=H,e.Vector4=a,e.VelocityOverLifetime=$n,e.VertexBuffer3D=te,e.VertexDeclaration=ae,e.VertexElement=re,e.VertexElementFormat=ne,e.VertexMesh=Ne,e.VertexPositionTerrain=Si,e.VertexPositionTexture0=Lt,e.VertexShuriKenParticle=ii,e.VertexShurikenParticleBillboard=ai,e.VertexShurikenParticleMesh=ri,e.VertexTrail=Ti,e.Viewport=Ie,e.WaterPrimaryMaterial=Cn,e.skinnedMatrixCache=Di}(window.Laya=window.Laya||{},Laya);