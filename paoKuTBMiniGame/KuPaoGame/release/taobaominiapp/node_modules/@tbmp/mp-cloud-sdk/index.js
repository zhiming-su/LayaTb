!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t(e.cloud={})}(this,function(e){"use strict";var n=function(e,t){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)};function t(e,t){function r(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}var h=function(){return(h=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var o in t=arguments[r])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)};function r(e,t,r,n){var o,i=arguments.length,a=i<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,n);else for(var s=e.length-1;0<=s;s--)(o=e[s])&&(a=(i<3?o(a):3<i?o(t,r,a):o(t,r))||a);return 3<i&&a&&Object.defineProperty(t,r,a),a}function d(e,a,s,c){return new(s=s||Promise)(function(r,t){function n(e){try{i(c.next(e))}catch(e){t(e)}}function o(e){try{i(c.throw(e))}catch(e){t(e)}}function i(e){var t;e.done?r(e.value):((t=e.value)instanceof s?t:new s(function(e){e(t)})).then(n,o)}i((c=c.apply(e,a||[])).next())})}function S(r,n){var o,i,a,e,s={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return e={next:t(0),throw:t(1),return:t(2)},"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function(t){if(o)throw new TypeError("Generator is already executing.");for(;s;)try{if(o=1,i&&(a=2&t[0]?i.return:t[0]?i.throw||((a=i.return)&&a.call(i),0):i.next)&&!(a=a.call(i,t[1])).done)return a;switch(i=0,a&&(t=[2&t[0],a.value]),t[0]){case 0:case 1:a=t;break;case 4:return s.label++,{value:t[1],done:!1};case 5:s.label++,i=t[1],t=[0];continue;case 7:t=s.ops.pop(),s.trys.pop();continue;default:if(!(a=0<(a=s.trys).length&&a[a.length-1])&&(6===t[0]||2===t[0])){s=0;continue}if(3===t[0]&&(!a||t[1]>a[0]&&t[1]<a[3])){s.label=t[1];break}if(6===t[0]&&s.label<a[1]){s.label=a[1],a=t;break}if(a&&s.label<a[2]){s.label=a[2],s.ops.push(t);break}a[2]&&s.ops.pop(),s.trys.pop();continue}t=n.call(r,s)}catch(e){t=[6,e],i=0}finally{o=a=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([t,e])}}}function o(){return function(e,t,r){var l=r.value;r.value=function(e){var t,r=e||{},n=r.success,o=void 0===n?null:n,i=r.fail,a=void 0===i?null:i,s=r.complete,c=void 0===s?null:s,u=!c&&!a&&!o;try{t=l.apply(this,arguments)}catch(e){return u?Promise.reject(e):(a&&a(e),void(c&&c(e)))}if(t=t.then?t:Promise.resolve(t),u)return t;t.then(function(e){try{o&&o(e),c&&c(e)}catch(e){throw e}}).catch(function(e){a&&a(e),c&&c(e)})}}}function T(e,t,r){Array.isArray(t)||(t=t.split("."));var n=t.reduce(function(e,t){return e?e[t]:null},e);return r?n||r:n}function i(e,t){return e(t={exports:{}},t.exports),t.exports}var p,a,s=i(function(e,t){var r;e.exports=(r=r||function(l){var r=Object.create||function(e){var t;return n.prototype=e,t=new n,n.prototype=null,t};function n(){}var e={},t=e.lib={},o=t.Base={extend:function(e){var t=r(this);return e&&t.mixIn(e),t.hasOwnProperty("init")&&this.init!==t.init||(t.init=function(){t.$super.init.apply(this,arguments)}),(t.init.prototype=t).$super=this,t},create:function(){var e=this.extend();return e.init.apply(e,arguments),e},init:function(){},mixIn:function(e){for(var t in e)e.hasOwnProperty(t)&&(this[t]=e[t]);e.hasOwnProperty("toString")&&(this.toString=e.toString)},clone:function(){return this.init.prototype.extend(this)}},d=t.WordArray=o.extend({init:function(e,t){e=this.words=e||[],this.sigBytes=null!=t?t:4*e.length},toString:function(e){return(e||a).stringify(this)},concat:function(e){var t=this.words,r=e.words,n=this.sigBytes,o=e.sigBytes;if(this.clamp(),n%4)for(var i=0;i<o;i++){var a=r[i>>>2]>>>24-i%4*8&255;t[n+i>>>2]|=a<<24-(n+i)%4*8}else for(i=0;i<o;i+=4)t[n+i>>>2]=r[i>>>2];return this.sigBytes+=o,this},clamp:function(){var e=this.words,t=this.sigBytes;e[t>>>2]&=4294967295<<32-t%4*8,e.length=l.ceil(t/4)},clone:function(){var e=o.clone.call(this);return e.words=this.words.slice(0),e},random:function(e){for(var t,r=[],n=function(t){t=t;var r=987654321,n=4294967295;return function(){var e=((r=36969*(65535&r)+(r>>16)&n)<<16)+(t=18e3*(65535&t)+(t>>16)&n)&n;return e/=4294967296,(e+=.5)*(.5<l.random()?1:-1)}},o=0;o<e;o+=4){var i=n(4294967296*(t||l.random()));t=987654071*i(),r.push(4294967296*i()|0)}return new d.init(r,e)}}),i=e.enc={},a=i.Hex={stringify:function(e){for(var t=e.words,r=e.sigBytes,n=[],o=0;o<r;o++){var i=t[o>>>2]>>>24-o%4*8&255;n.push((i>>>4).toString(16)),n.push((15&i).toString(16))}return n.join("")},parse:function(e){for(var t=e.length,r=[],n=0;n<t;n+=2)r[n>>>3]|=parseInt(e.substr(n,2),16)<<24-n%8*4;return new d.init(r,t/2)}},s=i.Latin1={stringify:function(e){for(var t=e.words,r=e.sigBytes,n=[],o=0;o<r;o++){var i=t[o>>>2]>>>24-o%4*8&255;n.push(String.fromCharCode(i))}return n.join("")},parse:function(e){for(var t=e.length,r=[],n=0;n<t;n++)r[n>>>2]|=(255&e.charCodeAt(n))<<24-n%4*8;return new d.init(r,t)}},c=i.Utf8={stringify:function(e){try{return decodeURIComponent(escape(s.stringify(e)))}catch(e){throw new Error("Malformed UTF-8 data")}},parse:function(e){return s.parse(unescape(encodeURIComponent(e)))}},u=t.BufferedBlockAlgorithm=o.extend({reset:function(){this._data=new d.init,this._nDataBytes=0},_append:function(e){"string"==typeof e&&(e=c.parse(e)),this._data.concat(e),this._nDataBytes+=e.sigBytes},_process:function(e){var t=this._data,r=t.words,n=t.sigBytes,o=this.blockSize,i=n/(4*o),a=(i=e?l.ceil(i):l.max((0|i)-this._minBufferSize,0))*o,s=l.min(4*a,n);if(a){for(var c=0;c<a;c+=o)this._doProcessBlock(r,c);var u=r.splice(0,a);t.sigBytes-=s}return new d.init(u,s)},clone:function(){var e=o.clone.call(this);return e._data=this._data.clone(),e},_minBufferSize:0}),p=(t.Hasher=u.extend({cfg:o.extend(),init:function(e){this.cfg=this.cfg.extend(e),this.reset()},reset:function(){u.reset.call(this),this._doReset()},update:function(e){return this._append(e),this._process(),this},finalize:function(e){return e&&this._append(e),this._doFinalize()},blockSize:16,_createHelper:function(r){return function(e,t){return new r.init(t).finalize(e)}},_createHmacHelper:function(r){return function(e,t){return new p.HMAC.init(r,t).finalize(e)}}}),e.algo={});return e}(Math),r)}),c=(i(function(e,t){var c;e.exports=(c=s,function(o){var e=c,t=e.lib,r=t.WordArray,n=t.Hasher,i=e.algo,a=[],w=[];!function(){function e(e){for(var t=o.sqrt(e),r=2;r<=t;r++)if(!(e%r))return;return 1}function t(e){return 4294967296*(e-(0|e))|0}for(var r=2,n=0;n<64;)e(r)&&(n<8&&(a[n]=t(o.pow(r,.5))),w[n]=t(o.pow(r,1/3)),n++),r++}();var b=[],s=i.SHA256=n.extend({_doReset:function(){this._hash=new r.init(a.slice(0))},_doProcessBlock:function(e,t){for(var r=this._hash.words,n=r[0],o=r[1],i=r[2],a=r[3],s=r[4],c=r[5],u=r[6],l=r[7],d=0;d<64;d++){if(d<16)b[d]=0|e[t+d];else{var p=b[d-15],h=(p<<25|p>>>7)^(p<<14|p>>>18)^p>>>3,f=b[d-2],v=(f<<15|f>>>17)^(f<<13|f>>>19)^f>>>10;b[d]=h+b[d-7]+v+b[d-16]}var y=n&o^n&i^o&i,m=(n<<30|n>>>2)^(n<<19|n>>>13)^(n<<10|n>>>22),g=l+((s<<26|s>>>6)^(s<<21|s>>>11)^(s<<7|s>>>25))+(s&c^~s&u)+w[d]+b[d];l=u,u=c,c=s,s=a+g|0,a=i,i=o,o=n,n=g+(m+y)|0}r[0]=r[0]+n|0,r[1]=r[1]+o|0,r[2]=r[2]+i|0,r[3]=r[3]+a|0,r[4]=r[4]+s|0,r[5]=r[5]+c|0,r[6]=r[6]+u|0,r[7]=r[7]+l|0},_doFinalize:function(){var e=this._data,t=e.words,r=8*this._nDataBytes,n=8*e.sigBytes;return t[n>>>5]|=128<<24-n%32,t[14+(64+n>>>9<<4)]=o.floor(r/4294967296),t[15+(64+n>>>9<<4)]=r,e.sigBytes=4*t.length,this._process(),this._hash},clone:function(){var e=n.clone.call(this);return e._hash=this._hash.clone(),e}});e.SHA256=n._createHelper(s),e.HmacSHA256=n._createHmacHelper(s)}(Math),c.SHA256)}),i(function(e,t){var r;e.exports=(r=s,void function(){var e=r.lib.Base,u=r.enc.Utf8;r.algo.HMAC=e.extend({init:function(e,t){e=this._hasher=new e.init,"string"==typeof t&&(t=u.parse(t));var r=e.blockSize,n=4*r;t.sigBytes>n&&(t=e.finalize(t)),t.clamp();for(var o=this._oKey=t.clone(),i=this._iKey=t.clone(),a=o.words,s=i.words,c=0;c<r;c++)a[c]^=1549556828,s[c]^=909522486;o.sigBytes=i.sigBytes=n,this.reset()},reset:function(){var e=this._hasher;e.reset(),e.update(this._iKey)},update:function(e){return this._hasher.update(e),this},finalize:function(e){var t=this._hasher,r=t.finalize(e);return t.reset(),t.finalize(this._oKey.clone().concat(r))}})}())}),i(function(e,t){e.exports=s.HmacSHA256})),u=i(function(e,t){var r;e.exports=(r=s,function(){var c=r.lib.WordArray;r.enc.Base64={stringify:function(e){var t=e.words,r=e.sigBytes,n=this._map;e.clamp();for(var o=[],i=0;i<r;i+=3)for(var a=(t[i>>>2]>>>24-i%4*8&255)<<16|(t[i+1>>>2]>>>24-(i+1)%4*8&255)<<8|t[i+2>>>2]>>>24-(i+2)%4*8&255,s=0;s<4&&i+.75*s<r;s++)o.push(n.charAt(a>>>6*(3-s)&63));var c=n.charAt(64);if(c)for(;o.length%4;)o.push(c);return o.join("")},parse:function(e){var t=e.length,r=this._map,n=this._reverseMap;if(!n){n=this._reverseMap=[];for(var o=0;o<r.length;o++)n[r.charCodeAt(o)]=o}var i=r.charAt(64);if(i){var a=e.indexOf(i);-1!==a&&(t=a)}return function(e,t,r){for(var n=[],o=0,i=0;i<t;i++)if(i%4){var a=r[e.charCodeAt(i-1)]<<i%4*2,s=r[e.charCodeAt(i)]>>>6-i%4*2;n[o>>>2]|=(a|s)<<24-o%4*8,o++}return c.create(n,o)}(e,t,n)},_map:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/="}}(),r.enc.Base64)}),l=i(function(e,t){var a;e.exports=(a=s,function(l){var e=a,t=e.lib,r=t.WordArray,n=t.Hasher,o=e.algo,R=[];!function(){for(var e=0;e<64;e++)R[e]=4294967296*l.abs(l.sin(e+1))|0}();var i=o.MD5=n.extend({_doReset:function(){this._hash=new r.init([1732584193,4023233417,2562383102,271733878])},_doProcessBlock:function(e,t){for(var r=0;r<16;r++){var n=t+r,o=e[n];e[n]=16711935&(o<<8|o>>>24)|4278255360&(o<<24|o>>>8)}var i=this._hash.words,a=e[t+0],s=e[t+1],c=e[t+2],u=e[t+3],l=e[t+4],d=e[t+5],p=e[t+6],h=e[t+7],f=e[t+8],v=e[t+9],y=e[t+10],m=e[t+11],g=e[t+12],w=e[t+13],b=e[t+14],_=e[t+15],A=i[0],x=i[1],q=i[2],k=i[3];A=S(A,x,q,k,a,7,R[0]),k=S(k,A,x,q,s,12,R[1]),q=S(q,k,A,x,c,17,R[2]),x=S(x,q,k,A,u,22,R[3]),A=S(A,x,q,k,l,7,R[4]),k=S(k,A,x,q,d,12,R[5]),q=S(q,k,A,x,p,17,R[6]),x=S(x,q,k,A,h,22,R[7]),A=S(A,x,q,k,f,7,R[8]),k=S(k,A,x,q,v,12,R[9]),q=S(q,k,A,x,y,17,R[10]),x=S(x,q,k,A,m,22,R[11]),A=S(A,x,q,k,g,7,R[12]),k=S(k,A,x,q,w,12,R[13]),q=S(q,k,A,x,b,17,R[14]),A=T(A,x=S(x,q,k,A,_,22,R[15]),q,k,s,5,R[16]),k=T(k,A,x,q,p,9,R[17]),q=T(q,k,A,x,m,14,R[18]),x=T(x,q,k,A,a,20,R[19]),A=T(A,x,q,k,d,5,R[20]),k=T(k,A,x,q,y,9,R[21]),q=T(q,k,A,x,_,14,R[22]),x=T(x,q,k,A,l,20,R[23]),A=T(A,x,q,k,v,5,R[24]),k=T(k,A,x,q,b,9,R[25]),q=T(q,k,A,x,u,14,R[26]),x=T(x,q,k,A,f,20,R[27]),A=T(A,x,q,k,w,5,R[28]),k=T(k,A,x,q,c,9,R[29]),q=T(q,k,A,x,h,14,R[30]),A=M(A,x=T(x,q,k,A,g,20,R[31]),q,k,d,4,R[32]),k=M(k,A,x,q,f,11,R[33]),q=M(q,k,A,x,m,16,R[34]),x=M(x,q,k,A,b,23,R[35]),A=M(A,x,q,k,s,4,R[36]),k=M(k,A,x,q,l,11,R[37]),q=M(q,k,A,x,h,16,R[38]),x=M(x,q,k,A,y,23,R[39]),A=M(A,x,q,k,w,4,R[40]),k=M(k,A,x,q,a,11,R[41]),q=M(q,k,A,x,u,16,R[42]),x=M(x,q,k,A,p,23,R[43]),A=M(A,x,q,k,v,4,R[44]),k=M(k,A,x,q,g,11,R[45]),q=M(q,k,A,x,_,16,R[46]),A=E(A,x=M(x,q,k,A,c,23,R[47]),q,k,a,6,R[48]),k=E(k,A,x,q,h,10,R[49]),q=E(q,k,A,x,b,15,R[50]),x=E(x,q,k,A,d,21,R[51]),A=E(A,x,q,k,g,6,R[52]),k=E(k,A,x,q,u,10,R[53]),q=E(q,k,A,x,y,15,R[54]),x=E(x,q,k,A,s,21,R[55]),A=E(A,x,q,k,f,6,R[56]),k=E(k,A,x,q,_,10,R[57]),q=E(q,k,A,x,p,15,R[58]),x=E(x,q,k,A,w,21,R[59]),A=E(A,x,q,k,l,6,R[60]),k=E(k,A,x,q,m,10,R[61]),q=E(q,k,A,x,c,15,R[62]),x=E(x,q,k,A,v,21,R[63]),i[0]=i[0]+A|0,i[1]=i[1]+x|0,i[2]=i[2]+q|0,i[3]=i[3]+k|0},_doFinalize:function(){var e=this._data,t=e.words,r=8*this._nDataBytes,n=8*e.sigBytes;t[n>>>5]|=128<<24-n%32;var o=l.floor(r/4294967296),i=r;t[15+(64+n>>>9<<4)]=16711935&(o<<8|o>>>24)|4278255360&(o<<24|o>>>8),t[14+(64+n>>>9<<4)]=16711935&(i<<8|i>>>24)|4278255360&(i<<24|i>>>8),e.sigBytes=4*(t.length+1),this._process();for(var a=this._hash,s=a.words,c=0;c<4;c++){var u=s[c];s[c]=16711935&(u<<8|u>>>24)|4278255360&(u<<24|u>>>8)}return a},clone:function(){var e=n.clone.call(this);return e._hash=this._hash.clone(),e}});function S(e,t,r,n,o,i,a){var s=e+(t&r|~t&n)+o+a;return(s<<i|s>>>32-i)+t}function T(e,t,r,n,o,i,a){var s=e+(t&n|r&~n)+o+a;return(s<<i|s>>>32-i)+t}function M(e,t,r,n,o,i,a){var s=e+(t^r^n)+o+a;return(s<<i|s>>>32-i)+t}function E(e,t,r,n,o,i,a){var s=e+(r^(t|~n))+o+a;return(s<<i|s>>>32-i)+t}e.MD5=n._createHelper(i),e.HmacMD5=n._createHmacHelper(i)}(Math),a.MD5)});(a=p=p||{})[a.MTOP=1]="MTOP",a[a.MY=2]="MY",a[a.GATEWAY=3]="GATEWAY";var f,v=(t(y,f=Error),y);function y(){return null!==f&&f.apply(this,arguments)||this}function m(e){this.options=e||{},this.options.dataProxyGatewayUrl=this.options.dataProxyGatewayUrl||this.options.gatewayUrl}var g=(w.prototype.init=function(t,r){return d(this,void 0,void 0,function(){return S(this,function(e){switch(e.label){case 0:return this.options=h({},t),this.proxy=r,this.tasks=[],this.inited=!0,[4,this.listenNetworkChange()];case 1:return e.sent(),this.flushGatewayRequestQueue(),this.pauseExecTask=!1,[2]}})})},w.prototype.listenNetworkChange=function(){return d(this,void 0,void 0,function(){var t,r=this;return S(this,function(e){switch(e.label){case 0:return e.trys.push([0,2,,3]),[4,this.exec({url:"my.getNetworkType"})];case 1:return t=e.sent(),this.networkType=t.networkType,window.my&&window.my.onNetworkStatusChange&&window.my.onNetworkStatusChange(function(e){e&&e.networkType&&(r.networkType=e.networkType)}),[3,3];case 2:return e.sent(),[3,3];case 3:return[2]}})})},w.getRequestType=function(e){return 0===e.indexOf("mtop.")?p.MTOP:0===e.indexOf("my.")?p.MY:p.GATEWAY},w.prototype.verifyResponse=function(t,r,n){return d(this,void 0,void 0,function(){return S(this,function(e){switch(e.label){case 0:if(T(n,"mc-code")||T(t,"errCode")||T(t,"error_response.code"),r.__is_retry_task__)return this.tryThrowError(t,n),[2,t];e.label=1;case 1:return e.trys.push([1,3,,4]),this.tryThrowError(t,n),[2,t];case 2:return[2,e.sent()];case 3:throw e.sent();case 4:return[2]}})})},w.prototype.tryThrowError=function(e,t){var r=T(t,"mc-msg")||T(e,"errMsg")||T(e,"error_response.msg"),n=T(t,"mc-code")||T(e,"errCode")||T(e,"error_response.code");if(n&&"200"!=n){var o=new v(n+":::"+r);throw o.code=n,o.msg=r,o}},w.prototype.sendGatewayRequest=function(n){return d(this,void 0,void 0,function(){var t,r=this;return S(this,function(e){switch(e.label){case 0:return this.pauseExecTask?[2,new Promise(function(e,t){r.tasks.push({detail:n,success:e,fail:t})})]:[3,1];case 1:return n=this.createGatewayRequest(n),[4,this.proxy.apply(h({},n),p.GATEWAY)];case 2:return t=e.sent(),[4,this.verifyResponse(T(t,"data"),n,T(t,"headers"))];case 3:return[2,e.sent()]}})})},w.prototype.flushGatewayRequestQueue=function(o){var i=this;void 0===o&&(o=!1),this.tasks.forEach(function(e){var t=e.detail,r=e.success,n=e.fail;if(o)return n("初始化失败");i.exec(t,p.GATEWAY).then(r).catch(n)}),this.tasks=[]},w.prototype.exec=function(t,r){return d(this,void 0,void 0,function(){return S(this,function(e){switch(e.label){case 0:if(r=r||w.getRequestType(t.url),!this.inited)throw new Error("请先调用cloud.init()");return t.data=t.data||{},r!==p.GATEWAY?[3,2]:[4,this.sendGatewayRequest(t)];case 1:return[2,e.sent()];case 2:return[4,this.proxy.apply(t,r)];case 3:return[2,e.sent()]}})})},w.prototype.getHttpRequestSign=function(e,t,r,n,o){if(this.options.signSecret){var i=o;delete n["mc-sign"];var a=t+"\n"+u.stringify(l(i))+"\napplication/json\n"+Object.keys(n).filter(function(e){return/^mc-/.test(e)}).sort().map(function(e){return e.toLowerCase()+":"+n[e]}).join("\n")+"\n"+e+(r?"?"+r:"");return u.stringify(c(a,this.options.signSecret))}},w.prototype.createGatewayRequest=function(e){var t=this.options,r=t.sessionKey,n=t.appKey,o=t.requestId,i=t.miniappId,a=t.openId,s=t.unionId,c=t.cloudId,u=t.sdkVersion;e.method="POST";var l=h(h({},e.headers),{"Content-Type":"application/json","mc-timestamp":""+Date.now(),"mc-session":r});a&&(l["mc-open-id"]=a),c&&(l["mc-cloud-id"]=c),s&&(l["mc-union-id"]=s),n&&(l["mc-appKey"]=n),i&&(l["mc-miniapp-id"]=i),o&&(l["mc-request-id"]=o),u&&(l["mc-sdk-version"]=u),e.env&&(l["mc-env"]=e.env),this.networkType&&(l["mc-network"]=this.networkType),l["mc-session"]||delete l["mc-session"],e.rawData=e.rawData||e.data,"object"==typeof e.data&&(e.data=JSON.stringify(e.data));var d=this.getHttpRequestSign(e.url,e.method,"",l,e.data);return h(h({},e),{url:""+e.url,headers:h(h({},l),{sign:d,"eagleeye-traceid":o})})},w);function w(){this.inited=!1,this.pauseExecTask=!1}function b(e,t){this.request=t,this.options=e}new g;var _,A=(t(x,_=b),x.prototype.invoke=function(t,r,n,o){return void 0===n&&(n="main"),d(this,void 0,void 0,function(){return S(this,function(e){switch(e.label){case 0:return[4,this.fcRequest({fcName:t,handler:n,data:r,options:o})];case 1:return[2,e.sent()]}})})},x.prototype.fcRequest=function(t){return d(this,void 0,void 0,function(){return S(this,function(e){switch(e.label){case 0:return[4,this.request.exec({env:this.options.env||"online",url:"fc",data:t},p.GATEWAY)];case 1:return[2,e.sent()]}})})},r([o()],x.prototype,"invoke",null),x);function x(){return null!==_&&_.apply(this,arguments)||this}var q,k=require("./package.json"),M="mtop.taobao.miniapp.cloud.store.config.get",E="mtop.taobao.miniapp.cloud.store.config.v2.seller.get",I="mtop.taobao.miniapp.cloud.store.file.save",O="mtop.taobao.miniapp.cloud.store.file.v2.seller.save",R="mtop.taobao.miniapp.cloud.store.file.delete",P="mtop.taobao.miniapp.cloud.store.file.v2.seller.delete",B="mtop.taobao.miniapp.cloud.store.file.list",H="mtop.taobao.miniapp.cloud.store.file.v2.seller.list",C="other",D=(t(j,q=b),j.prototype.parseUploadResult=function(e,t,r){return this.parsePostUploadResult(e,t,r)},j.prototype.parsePostUploadResult=function(e,t,r){var n,o,i,a;if(t.data)if(r)try{o=(s=JSON.parse(t.data)).fileId,n=s.url,i=s.message}catch(e){console.log(e)}else try{var s=JSON.parse(t.data);switch(e){case"image":o=s.jsonData.fileId,n=s.jsonData.url;break;case"video":o=s.fileId,a=s.videoId,n=s.url;break;case"audio":o=s.fileId,a=s.videoId,n=s.url}}catch(e){}return{imageUrl:n,specialId:o,message:i,videoId:a}},j.prototype.uploadFile=function(R){return d(this,void 0,void 0,function(){var t,r,n,o,i,a,s,c,u,l,d,p,h,f,v,y,m,g,w,b,_,A,x,q,k;return S(this,function(e){switch(e.label){case 0:t=R.filePath,r=R.fileType,n=void 0===r?C:r,o=R.fileName,i=void 0===o?"miniappfile":o,a=R.seller,s=void 0!==a&&a,c=R.dirId,e.label=1;case 1:return e.trys.push([1,3,,4]),l=s?E:M,[4,this.storageRequest(l,{newContainer:!0,cloudPath:i,fileType:n,sellerSpace:s,dirId:c})];case 2:return u=e.sent(),[3,4];case 3:throw d=e.sent(),new Error("获取配置错误"+(d.message||d.toString()));case 4:return p=T(u,["data","model",n],{}),h=p.url,f=void 0===h?"":h,v=p.formData,y=void 0===v?null:v,m=p.headers,(g={url:f,fileType:n,header:void 0===m?null:m,formData:y,filePath:t,fileName:"file"}).formData=g.formData||{},g.header&&g.header.Authorization&&(g.formData.Authorization=g.header.Authorization),i&&(g.formData.localFileName=Date.now()+"-"+function(e){if(!e)return"file";var t=e.lastIndexOf("/");return 0<=t?e.substr(t+1):e}(i)),g.header?"image"!==n&&(g.header.origin=g.header.origin||"https://miniapp-cloud.taobao.com",g.header.referer=g.header.referer||"https://miniapp-cloud.taobao.com"):delete g.header,[4,this.storageRequest("my.uploadFile",g)];case 5:return w=e.sent(),console.log(w),b=this.parseUploadResult(n,w,s),_=b.imageUrl,A=b.specialId,b.message,x=b.videoId,q={fileType:n,specialId:"other"===n?T(u,["data","model",n,"formData","key"],""):A,videoId:x,url:_,cloudPath:i,sellerSpace:s},[4,this.storageRequest(s?O:I,q)];case 6:if(!T(k=e.sent(),"data.model.fileId"))throw new Error(T(k,["result","msgInfo"],"上传文件失败"));return[2,T(k,"data.model")]}})})},j.prototype.deleteFile=function(c){return d(this,void 0,void 0,function(){var t,r,n,o,i,a,s;return S(this,function(e){switch(e.label){case 0:if(t=c.fileId,r=c.fileType,n=void 0===r?C:r,o=c.seller,i=void 0!==o&&o,a=Array.isArray(t)?t:[t],i)throw new Error("商家空间资源不允许使用接口删除");return a=JSON.stringify(a),[4,this.storageRequest(i?P:R,{fileType:n,fileIds:a,sellerSpace:i})];case 1:if(T(s=e.sent(),["data","model"]))return[2,!0];throw new Error(T(s,["data","msgInfo"]))}})})},j.prototype.getTempFileURL=function(s){return d(this,void 0,void 0,function(){var t,r,n,o,i,a;return S(this,function(e){switch(e.label){case 0:if(t=s.fileId,r=s.seller,n=void 0!==r&&r,!t)throw new Error("缺少fileId,请检查参数");return o=Array.isArray(t)?t:[t],o=JSON.stringify(o),[4,this.storageRequest(n?H:B,{fileIds:o,sellerSpace:n})];case 1:if(i=e.sent(),a=T(i,["data","model"]))return[2,a];throw new Error(T(i,["data","msgInfo"]))}})})},j.prototype.downloadByFileId=function(l){return d(this,void 0,void 0,function(){var t,r,n,o,i,a,s,c,u;return S(this,function(e){switch(e.label){case 0:if(t=l.fileId,r=l.cache,!t)throw new Error("缺少fileId,请检查参数");return n=Array.isArray(t)?t:[t],[4,this.storageRequest(B,{fileIds:JSON.stringify(n)})];case 1:o=e.sent(),i=T(o,["data","model"])||[],a=[],s=0,e.label=2;case 2:return s<i.length?(c=(i[s]||{}).url,[4,this._downloadByUrl(c,r)]):[3,5];case 3:(u=e.sent())&&a.push(u),e.label=4;case 4:return s++,[3,2];case 5:return[2,a]}})})},j.prototype.storageRequest=function(r,n,o){return d(this,void 0,void 0,function(){var t;return S(this,function(e){switch(e.label){case 0:return t="test"===this.options.env?"test":"online",(n=n||{}).env=t,n.sdkVersion=k.version,[4,this.request.exec({url:r,data:n},o)];case 1:return[2,e.sent()]}})})},j.prototype._downloadByUrl=function(n,o){return d(this,void 0,void 0,function(){var t,r;return S(this,function(e){switch(e.label){case 0:return n?o?[4,this.request.proxy.apply({url:"my.getStorage",data:{key:n}})]:[3,2]:[2,null];case 1:if(t=e.sent().data)return[2,t];e.label=2;case 2:return[4,this.request.exec({url:"my.downloadFile",data:{url:n}})];case 3:return r=e.sent().apFilePath,o?[4,this.request.exec({url:"my.setStorage",data:{key:n,data:r}})]:[3,5];case 4:e.sent(),e.label=5;case 5:return[2,r]}})})},r([o()],j.prototype,"uploadFile",null),r([o()],j.prototype,"deleteFile",null),r([o()],j.prototype,"getTempFileURL",null),r([o()],j.prototype,"downloadByFileId",null),j);function j(){return null!==q&&q.apply(this,arguments)||this}var G=(Object.defineProperty(N.prototype,"name",{get:function(){return this._coll},enumerable:!0,configurable:!0}),N.prototype.aggregate=function(r){return d(this,void 0,void 0,function(){var t;return S(this,function(e){switch(e.label){case 0:return Array.isArray(r)||(r=[r]),t={aggregate_pipelines:r,collection_name:this._coll},[4,this._db.dbRequest("miniapp.cloud.db.collection.aggregate",t)];case 1:return[2,e.sent()]}})})},N.prototype.count=function(r){return d(this,void 0,void 0,function(){var t;return S(this,function(e){switch(e.label){case 0:return t={filter:r,collection_name:this._coll},[4,this._db.dbRequest("miniapp.cloud.db.collection.count",t)];case 1:return[2,e.sent()]}})})},N.prototype.deleteMany=function(r){return d(this,void 0,void 0,function(){var t;return S(this,function(e){switch(e.label){case 0:return t={filter:r,collection_name:this._coll},[4,this._db.dbRequest("miniapp.cloud.db.collection.remove",t)];case 1:return[2,e.sent()]}})})},N.prototype.find=function(r,n){return void 0===n&&(n={}),d(this,void 0,void 0,function(){var t;return S(this,function(e){switch(e.label){case 0:return t={displayed_fields:n.projection,order_by:n.sort,skip:n.skip,limit:n.limit,filter:r,collection_name:this._coll},[4,this._db.dbRequest("miniapp.cloud.db.collection.get",t)];case 1:return[2,e.sent()]}})})},N.prototype.replaceOne=function(r,n){return d(this,void 0,void 0,function(){var t;return S(this,function(e){switch(e.label){case 0:return t={filter:r,new_record:n,collection_name:this._coll},[4,this._db.dbRequest("miniapp.cloud.db.collection.replace",t)];case 1:return[2,e.sent()]}})})},N.prototype.insertOne=function(r){return d(this,void 0,void 0,function(){var t;return S(this,function(e){switch(e.label){case 0:return t={record:r,collection_name:this._coll},[4,this._db.dbRequest("miniapp.cloud.db.collection.add",t)];case 1:return[2,e.sent()]}})})},N.prototype.insertMany=function(r){return d(this,void 0,void 0,function(){var t;return S(this,function(e){switch(e.label){case 0:if(t={records:r,collection_name:this._coll},!Array.isArray(r))throw new Error("带插入的数据只能为数组");return[4,this._db.dbRequest("miniapp.cloud.db.collection.addMany",t)];case 1:return[2,e.sent()]}})})},N.prototype.updateMany=function(r,n,o){return d(this,void 0,void 0,function(){var t;return S(this,function(e){switch(e.label){case 0:return t={filter:r,action:n,arrayFilters:o,collection_name:this._coll},[4,this._db.dbRequest("miniapp.cloud.db.collection.update",t)];case 1:return[2,e.sent()]}})})},N.prototype.createIndex=function(r,n,o){return d(this,void 0,void 0,function(){var t;return S(this,function(e){switch(e.label){case 0:return t={index_name:r,unique:n,fields:o,collection_name:this._coll},[4,this._db.dbRequest("miniapp.cloud.db.index.create",t)];case 1:return[2,e.sent()]}})})},r([o()],N.prototype,"aggregate",null),r([o()],N.prototype,"count",null),r([o()],N.prototype,"deleteMany",null),r([o()],N.prototype,"find",null),r([o()],N.prototype,"replaceOne",null),r([o()],N.prototype,"insertOne",null),r([o()],N.prototype,"insertMany",null),r([o()],N.prototype,"updateMany",null),r([o()],N.prototype,"createIndex",null),N);function N(e,t){this._db=e,this._coll=t}var U,z=(t(W,U=b),W.prototype.collection=function(e){if(!e)throw new Error("集合名称不能为空");return new G(this,e)},W.prototype.createCollection=function(r,e){return d(this,void 0,void 0,function(){var t;return S(this,function(e){switch(e.label){case 0:return t={collection_name:r},[4,this.dbRequest("miniapp.cloud.db.collection.create",t)];case 1:return[2,e.sent()]}})})},W.prototype.dbRequest=function(r,n){return d(this,void 0,void 0,function(){var t;return S(this,function(e){switch(e.label){case 0:return"test"!==(t=this.options.env)&&(t="online"),n=h(h({},n),{env:t}),[4,this.request.exec({env:t,url:"db/"+r,data:n},p.GATEWAY)];case 1:return[2,e.sent()]}})})},r([o()],W.prototype,"createCollection",null),W);function W(){return null!==U&&U.apply(this,arguments)||this}var Y,F=(t(J,Y=b),J.prototype.invoke=function(p){return d(this,void 0,void 0,function(){var t,i,a,s,c,u,l,d;return S(this,function(e){switch(e.label){case 0:return t=p.data,i=p.headers,a=p.authScope,s=p.api,t=t||{},Object.keys(t).forEach(function(e){t[e]="string"==typeof t[e]?t[e]:JSON.stringify(t[e])}),c={apiName:s,httpHeaders:i,data:t},[4,this.topRequest(c)];case 1:if(!T(u=e.sent(),"error_response"))return[2,u];if(l=T(u,"error_response.code"),(d=my&&my.canIUse("qn.cleanToken"))&&!a&&(a="*"),26!=l&&27!=l&&53!=l||!a)return[3,9];e.label=2;case 2:return e.trys.push([2,8,,9]),d?(console.log("call my.qn.cleanToken"),[4,my.qn.cleanToken()]):[3,4];case 3:e.sent(),e.label=4;case 4:return[4,(r=my.authorize,n={scopes:a},r?(n=n||{},new Promise(function(e,t){r.call(o||my,h(h({},n),{success:e,fail:t}))})):Promise.reject("未实现my.api"))];case 5:return[4,e.sent()];case 6:return e.sent(),[4,this.topRequest(c)];case 7:return T(u=e.sent(),"error_response")?[3,9]:[2,u];case 8:return e.sent(),[3,9];case 9:throw new Error(""+JSON.stringify(T(u,"error_response")))}var r,n,o})})},J.prototype.topRequest=function(t){return d(this,void 0,void 0,function(){return S(this,function(e){switch(e.label){case 0:return[4,this.request.exec({env:this.options.env||"online",url:"top",data:t},p.GATEWAY)];case 1:return[2,e.sent()]}})})},r([o()],J.prototype,"invoke",null),J);function J(){return null!==Y&&Y.apply(this,arguments)||this}var K,L=(t(V,K=b),V.prototype.invoke=function(o){return d(this,void 0,void 0,function(){var t,r,n;return S(this,function(e){switch(e.label){case 0:return t=o.data,r=o.headers,n=o.api,[4,this.topRequest({apiName:n,httpHeaders:r,data:t})];case 1:return[2,e.sent()]}})})},V.prototype.topRequest=function(t){return d(this,void 0,void 0,function(){return S(this,function(e){switch(e.label){case 0:return[4,this.request.exec({url:"process",data:t},p.GATEWAY)];case 1:return[2,e.sent()]}})})},r([o()],V.prototype,"invoke",null),V);function V(){return null!==K&&K.apply(this,arguments)||this}var Q,X=(t($,Q=b),$.prototype.invoke=function(i){return d(this,void 0,void 0,function(){var t,r,n,o;return S(this,function(e){switch(e.label){case 0:return t=i.data,r=i.headers,n=i.api,o=i.targetAppKey,[4,this.qimenRequest({apiName:n,httpHeaders:r,targetAppKey:o,data:t})];case 1:return[2,e.sent()]}})})},$.prototype.qimenRequest=function(t){return d(this,void 0,void 0,function(){return S(this,function(e){switch(e.label){case 0:return[4,this.request.exec({env:this.options.env||"online",url:"qimen",data:t},p.GATEWAY)];case 1:return[2,e.sent()]}})})},r([o()],$.prototype,"invoke",null),$);function $(){return null!==Q&&Q.apply(this,arguments)||this}var Z,ee=(t(te,Z=b),te.prototype.httpRequest=function(s){return d(this,void 0,void 0,function(){var t,r,n,o,i,a;return S(this,function(e){switch(e.label){case 0:return t=s.body,r=s.params,n=s.headers,o=s.path,i=s.method,a=s.exts,[4,this.innerRequest({path:o,headers:n,body:t,queryString:r,method:i,options:a})];case 1:return[2,e.sent()]}})})},te.prototype.innerRequest=function(t){return d(this,void 0,void 0,function(){return S(this,function(e){switch(e.label){case 0:return[4,this.request.exec({env:this.options.env||"online",url:"cloudHttp",data:t},p.GATEWAY)];case 1:return[2,e.sent()]}})})},r([o()],te.prototype,"httpRequest",null),te);function te(){return null!==Z&&Z.apply(this,arguments)||this}var re,ne=require("./package.json"),oe=(t(ie,re=Error),ie.prototype.toString=function(){return(this.code||"")+" "+(this.message||"")},ie);function ie(){return null!==re&&re.apply(this,arguments)||this}var ae,se=(t(ce,ae=m),ce.getMtopErrorMsg=function(e){var t=new oe;if(!e)return t.code="500",t.message="客户端网络错误,请稍后重试",t;var r,n,o=e.ret&&e.ret[0]&&e.ret[0].split("::");if(e.data=e.data||T(e,["err","data"]),e.data&&e.data.errCode&&(r=e.data.errCode,n=e.data.errMessage||e.data.errMsg),e.data&&e.data.errorCode&&(r=e.data.errorCode),e.data&&e.data.errorMessage&&(n=e.data.errorMessage),e.data&&e.data.errorPage)try{if(my&&my.tb&&my.tb.showErrorView)return my.tb.showErrorView({reason:e.data.errorPage.reason,message:e.data.errorPage.message,action:e.data.errorPage.action,icon:e.data.errorPage.icon}),t;delete e.data.errorPage}catch(e){}return e.data&&e.data.success||o&&"SUCCESS"===o[0]&&!r?void 0:(r=r||(o&&"FAIL_SYS_SESSION_EXPIRED"===o[0]?"904":"500"),n=n||o&&o[1]||"客户端网络错误,请稍后重试",t.code=r,t.message=n,t)},ce.GATEWAY_APIS={"db/miniapp.cloud.db.collection.create":"mtop.taobao.dataproxy.collection.create","db/miniapp.cloud.db.index.create":"mtop.taobao.dataproxy.index.create","db/miniapp.cloud.db.collection.aggregate":"mtop.taobao.dataproxy.record.aggregate","db/miniapp.cloud.db.collection.count":"mtop.taobao.dataproxy.record.count","db/miniapp.cloud.db.collection.remove":"mtop.taobao.dataproxy.record.delete","db/miniapp.cloud.db.collection.get":"mtop.taobao.dataproxy.record.select","db/miniapp.cloud.db.collection.replace":"mtop.taobao.dataproxy.record.replace","db/miniapp.cloud.db.collection.add":"mtop.taobao.dataproxy.record.insert","db/miniapp.cloud.db.collection.addMany":"mtop.taobao.dataproxy.record.batch.insert","db/miniapp.cloud.db.collection.update":"mtop.taobao.dataproxy.record.update",fc:"mtop.miniapp.cloud.invoke.fc",top:"mtop.miniapp.cloud.invoke.top",qimen:"mtop.miniapp.cloud.invoke.qimen.cloud",process:"mtop.miniapp.cloud.invoke.process",cloudHttp:"mtop.miniapp.cloud.application.request"},ce);function ce(){var e=null!==ae&&ae.apply(this,arguments)||this;return e.sendMtop=function(t,o,i){return d(e,void 0,void 0,function(){return S(this,function(e){return[2,new Promise(function(r,n){if(1024e3<=o.length){var e=new oe;e.code="500",e.message="本次请求内容过长，请控制在1M以内",n(e)}else my.sendMtop(h(h({api:t,v:"1.0",data:o,method:"POST",needLogin:!0,sessionOption:"AutoLoginAndManualLogin"},i),{success:function(e){var t=ce.getMtopErrorMsg(e);t?n(t):r(e)},fail:function(e){console.log("sendMtop error",e),n(ce.getMtopErrorMsg(e))}}))})]})})},e.invokeMyApi=function(r,n){return d(e,void 0,void 0,function(){return S(this,function(e){return[2,new Promise(function(e,t){return r=r.replace(/^my\./,""),my[r](h(h({},n),{success:e,fail:t}))})]})})},e.sendHttpRequest=function(n,o,i,a){return d(e,void 0,void 0,function(){var t=this;return S(this,function(e){return[2,new Promise(function(r,e){my.httpRequest({url:t.options.gatewayUrl+"/"+n,data:o,dataType:"text",method:a,headers:i,success:function(t){try{r(h(h({},t),{data:JSON.parse(t.data)}))}catch(e){r(h(h({},t),{data:t.data}))}},fail:e})})]})})},e.apply=function(u,l){return d(e,void 0,void 0,function(){var t,r,n,o,i,a,s,c;return S(this,function(e){switch(e.label){case 0:return t=u.url,r=u.data,n=u.headers,o=u.mtopOptions,i=u.method,l!==p.MTOP?[3,2]:[4,this.sendMtop(t,r,o)];case 1:return[2,e.sent()];case 2:return l!==p.GATEWAY?[3,8]:this.options.gatewayUrl?[4,this.sendHttpRequest(t,r,n,i)]:[3,4];case 3:return[2,e.sent()];case 4:return e.trys.push([4,6,,7]),u.rawData&&Object.keys(u.rawData).forEach(function(e){"object"==typeof u.rawData[e]&&(u.rawData[e]=JSON.stringify(u.rawData[e]))}),[4,this.sendMtop(ce.GATEWAY_APIS[t],h(h({},u.rawData),{sdkVersion:ne.version,protocols:JSON.stringify(n)}),o)];case 5:return a=e.sent(),(s=a&&a.data||{}).errCode?[2,{headers:{"mc-code":s.errCode,"mc-msg":s.errMessage},data:{}}]:[2,{headers:{"mc-code":200,"mc-msg":"请求成功"},data:T(s,["data"])||{}}];case 6:return(c=e.sent())&&c.code?[2,{headers:{"mc-code":c.code,"mc-msg":c.message}}]:[2,{headers:{"mc-code":500,"mc-msg":c.message||c}}];case 7:return[3,10];case 8:return[4,this.invokeMyApi(t,r)];case 9:return[2,e.sent()];case 10:return[2]}})})},e}var ue=(le.prototype.init=function(i,a){return d(this,void 0,void 0,function(){var r,n,o;return S(this,function(e){switch(e.label){case 0:return e.trys.push([0,2,,3]),t=i.env,r="string"==typeof(t=t||"online")?{database:t,file:t,function:t,message:t}:(t.database=t.database||"online",t.file=t.file||"online",t.function=t.function||"online",t.message=t.message||"online",t),n=new g,this.db=new z({env:r.database},n),this.function=new A({env:r.function},n),this.file=new D({env:r.file},n),this.qimenApi=new X({env:r.database},n),this.topApi=new F({env:r.database},n),this.processApi=new L({env:r.database},n),this.application=new ee({env:r.database},n),[4,n.init(h({},i),a||new se({gatewayUrl:i.__gatewayUrl}))];case 1:return e.sent(),[2,!0];case 2:return o=e.sent(),console.error("SDK初始化失败 ",o),[3,3];case 3:return[2,!1]}var t})})},le);function le(){}var de=new ue;e.Cloud=ue,e.default=de,Object.defineProperty(e,"__esModule",{value:!0})});
