var window = $global.window;
var document = window.document;
var XMLHttpRequest = window.XMLHttpRequest;
var Laya = window.Laya;
var Laya3D = window.Laya3D;
var performance = window.performance;
var CANNON = window.CANNON;
"use strict";function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function set(e,t,n,i){return(set="undefined"!=typeof Reflect&&Reflect.set?Reflect.set:function(e,t,n,i){var r,a=_superPropBase(e,t);if(a){if((r=Object.getOwnPropertyDescriptor(a,t)).set)return r.set.call(i,n),!0;if(!r.writable)return!1}if(r=Object.getOwnPropertyDescriptor(i,t)){if(!r.writable)return!1;r.value=n,Object.defineProperty(i,t,r)}else _defineProperty(i,t,n);return!0})(e,t,n,i)}function _set(e,t,n,i,r){if(!set(e,t,n,i||e)&&r)throw new Error("failed to set property");return n}function _defineProperty(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function _get(e,t,n){return(_get="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var i=_superPropBase(e,t);if(i){var r=Object.getOwnPropertyDescriptor(i,t);return r.get?r.get.call(n):r.value}})(e,t,n||e)}function _superPropBase(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=_getPrototypeOf(e)););return e}function _possibleConstructorReturn(e,t){return!t||"object"!==_typeof(t)&&"function"!=typeof t?_assertThisInitialized(e):t}function _assertThisInitialized(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function _getPrototypeOf(e){return(_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&_setPrototypeOf(e,t)}function _setPrototypeOf(e,t){return(_setPrototypeOf=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function _createClass(e,t,n){return t&&_defineProperties(e.prototype,t),n&&_defineProperties(e,n),e}!function(e,t){var i=function(){function i(){_classCallCheck(this,i)}return _createClass(i,null,[{key:"isZero",value:function(e){return Math.abs(e)<i.zeroTolerance}},{key:"nearEqual",value:function(e,t){return!!i.isZero(e-t)}},{key:"fastInvSqrt",value:function(e){return i.isZero(e)?e:1/Math.sqrt(e)}}]),i}();i.zeroTolerance=1e-6,i.MaxValue=3.40282347e38,i.MinValue=-3.40282347e38,i.Deg2Rad=Math.PI/180;var r=function(){function r(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;_classCallCheck(this,r),this.x=e,this.y=t}return _createClass(r,[{key:"setValue",value:function(e,t){this.x=e,this.y=t}},{key:"fromArray",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;this.x=e[t+0],this.y=e[t+1]}},{key:"toArray",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;e[t+0]=this.x,e[t+1]=this.y}},{key:"cloneTo",value:function(e){var t=e;t.x=this.x,t.y=this.y}},{key:"clone",value:function(){var e=new r;return this.cloneTo(e),e}},{key:"forNativeElement",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;e?(this.elements=e,this.elements[0]=this.x,this.elements[1]=this.y):this.elements=new Float32Array([this.x,this.y]),r.rewriteNumProperty(this,"x",0),r.rewriteNumProperty(this,"y",1)}}],[{key:"scale",value:function(e,t,n){n.x=e.x*t,n.y=e.y*t}},{key:"dot",value:function(e,t){return e.x*t.x+e.y*t.y}},{key:"normalize",value:function(e,t){var n=e.x,i=e.y,r=n*n+i*i;r>0&&(r=1/Math.sqrt(r),t.x=n*r,t.y=i*r)}},{key:"scalarLength",value:function(e){var t=e.x,n=e.y;return Math.sqrt(t*t+n*n)}},{key:"rewriteNumProperty",value:function(e,t,n){Object.defineProperty(e,t,{get:function(){return this.elements[n]},set:function(e){this.elements[n]=e}})}}]),r}();r.ZERO=new r(0,0),r.ONE=new r(1,1);var o=function(){function n(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;_classCallCheck(this,n),this.x=e,this.y=t,this.z=i,this.w=r}return _createClass(n,[{key:"setValue",value:function(e,t,n,i){this.x=e,this.y=t,this.z=n,this.w=i}},{key:"fromArray",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;this.x=e[t+0],this.y=e[t+1],this.z=e[t+2],this.w=e[t+3]}},{key:"toArray",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;e[t+0]=this.x,e[t+1]=this.y,e[t+2]=this.z,e[t+3]=this.w}},{key:"cloneTo",value:function(e){var t=e;t.x=this.x,t.y=this.y,t.z=this.z,t.w=this.w}},{key:"clone",value:function(){var e=new n;return this.cloneTo(e),e}},{key:"length",value:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}},{key:"lengthSquared",value:function(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}},{key:"forNativeElement",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;e?(this.elements=e,this.elements[0]=this.x,this.elements[1]=this.y,this.elements[2]=this.z,this.elements[3]=this.w):this.elements=new Float32Array([this.x,this.y,this.z,this.w]),r.rewriteNumProperty(this,"x",0),r.rewriteNumProperty(this,"y",1),r.rewriteNumProperty(this,"z",2),r.rewriteNumProperty(this,"w",3)}}],[{key:"lerp",value:function(e,t,n,i){var r=e.x,a=e.y,o=e.z,s=e.w;i.x=r+n*(t.x-r),i.y=a+n*(t.y-a),i.z=o+n*(t.z-o),i.w=s+n*(t.w-s)}},{key:"transformByM4x4",value:function(e,t,n){var i=e.x,r=e.y,a=e.z,o=e.w,s=t.elements;n.x=i*s[0]+r*s[4]+a*s[8]+o*s[12],n.y=i*s[1]+r*s[5]+a*s[9]+o*s[13],n.z=i*s[2]+r*s[6]+a*s[10]+o*s[14],n.w=i*s[3]+r*s[7]+a*s[11]+o*s[15]}},{key:"equals",value:function(e,t){return i.nearEqual(Math.abs(e.x),Math.abs(t.x))&&i.nearEqual(Math.abs(e.y),Math.abs(t.y))&&i.nearEqual(Math.abs(e.z),Math.abs(t.z))&&i.nearEqual(Math.abs(e.w),Math.abs(t.w))}},{key:"normalize",value:function(e,t){var n=e.length();if(n>0){var i=1/n;t.x=e.x*i,t.y=e.y*i,t.z=e.z*i,t.w=e.w*i}}},{key:"add",value:function(e,t,n){n.x=e.x+t.x,n.y=e.y+t.y,n.z=e.z+t.z,n.w=e.w+t.w}},{key:"subtract",value:function(e,t,n){n.x=e.x-t.x,n.y=e.y-t.y,n.z=e.z-t.z,n.w=e.w-t.w}},{key:"multiply",value:function(e,t,n){n.x=e.x*t.x,n.y=e.y*t.y,n.z=e.z*t.z,n.w=e.w*t.w}},{key:"scale",value:function(e,t,n){n.x=e.x*t,n.y=e.y*t,n.z=e.z*t,n.w=e.w*t}},{key:"Clamp",value:function(e,t,n,i){var r=e.x,a=e.y,o=e.z,s=e.w,l=t.x,u=t.y,_=t.z,c=t.w,h=n.x,d=n.y,f=n.z,m=n.w;r=(r=r>h?h:r)<l?l:r,a=(a=a>d?d:a)<u?u:a,o=(o=o>f?f:o)<_?_:o,s=(s=s>m?m:s)<c?c:s,i.x=r,i.y=a,i.z=o,i.w=s}},{key:"distanceSquared",value:function(e,t){var n=e.x-t.x,i=e.y-t.y,r=e.z-t.z,a=e.w-t.w;return n*n+i*i+r*r+a*a}},{key:"distance",value:function(e,t){var n=e.x-t.x,i=e.y-t.y,r=e.z-t.z,a=e.w-t.w;return Math.sqrt(n*n+i*i+r*r+a*a)}},{key:"dot",value:function(e,t){return e.x*t.x+e.y*t.y+e.z*t.z+e.w*t.w}},{key:"min",value:function(e,t,n){n.x=Math.min(e.x,t.x),n.y=Math.min(e.y,t.y),n.z=Math.min(e.z,t.z),n.w=Math.min(e.w,t.w)}},{key:"max",value:function(e,t,n){n.x=Math.max(e.x,t.x),n.y=Math.max(e.y,t.y),n.z=Math.max(e.z,t.z),n.w=Math.max(e.w,t.w)}}]),n}();o.ZERO=new o,o.ONE=new o(1,1,1,1),o.UnitX=new o(1,0,0,0),o.UnitY=new o(0,1,0,0),o.UnitZ=new o(0,0,1,0),o.UnitW=new o(0,0,0,1);var s,l,u,_,c,h,d,f,m,E,T,g,D=function(){function a(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;_classCallCheck(this,a),this.x=e,this.y=t,this.z=n}return _createClass(a,[{key:"setValue",value:function(e,t,n){this.x=e,this.y=t,this.z=n}},{key:"fromArray",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;this.x=e[t+0],this.y=e[t+1],this.z=e[t+2]}},{key:"toArray",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;e[t+0]=this.x,e[t+1]=this.y,e[t+2]=this.z}},{key:"cloneTo",value:function(e){var t=e;t.x=this.x,t.y=this.y,t.z=this.z}},{key:"clone",value:function(){var e=new a;return this.cloneTo(e),e}},{key:"toDefault",value:function(){this.x=0,this.y=0,this.z=0}},{key:"forNativeElement",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;e?(this.elements=e,this.elements[0]=this.x,this.elements[1]=this.y,this.elements[2]=this.z):this.elements=new Float32Array([this.x,this.y,this.z]),r.rewriteNumProperty(this,"x",0),r.rewriteNumProperty(this,"y",1),r.rewriteNumProperty(this,"z",2)}}],[{key:"distanceSquared",value:function(e,t){var n=e.x-t.x,i=e.y-t.y,r=e.z-t.z;return n*n+i*i+r*r}},{key:"distance",value:function(e,t){var n=e.x-t.x,i=e.y-t.y,r=e.z-t.z;return Math.sqrt(n*n+i*i+r*r)}},{key:"min",value:function(e,t,n){n.x=Math.min(e.x,t.x),n.y=Math.min(e.y,t.y),n.z=Math.min(e.z,t.z)}},{key:"max",value:function(e,t,n){n.x=Math.max(e.x,t.x),n.y=Math.max(e.y,t.y),n.z=Math.max(e.z,t.z)}},{key:"transformQuat",value:function(e,t,n){var i=e.x,r=e.y,a=e.z,o=t.x,s=t.y,l=t.z,u=t.w,_=u*i+s*a-l*r,c=u*r+l*i-o*a,h=u*a+o*r-s*i,d=-o*i-s*r-l*a;n.x=_*u+d*-o+c*-l-h*-s,n.y=c*u+d*-s+h*-o-_*-l,n.z=h*u+d*-l+_*-s-c*-o}},{key:"scalarLength",value:function(e){var t=e.x,n=e.y,i=e.z;return Math.sqrt(t*t+n*n+i*i)}},{key:"scalarLengthSquared",value:function(e){var t=e.x,n=e.y,i=e.z;return t*t+n*n+i*i}},{key:"normalize",value:function(e,t){var n=e.x,i=e.y,r=e.z,a=n*n+i*i+r*r;a>0&&(a=1/Math.sqrt(a),t.x=n*a,t.y=i*a,t.z=r*a)}},{key:"multiply",value:function(e,t,n){n.x=e.x*t.x,n.y=e.y*t.y,n.z=e.z*t.z}},{key:"scale",value:function(e,t,n){n.x=e.x*t,n.y=e.y*t,n.z=e.z*t}},{key:"lerp",value:function(e,t,n,i){var r=e.x,a=e.y,o=e.z;i.x=r+n*(t.x-r),i.y=a+n*(t.y-a),i.z=o+n*(t.z-o)}},{key:"transformV3ToV3",value:function(e,t,n){var i=a._tempVector4;a.transformV3ToV4(e,t,i),n.x=i.x,n.y=i.y,n.z=i.z}},{key:"transformV3ToV4",value:function(e,t,n){var i=e.x,r=e.y,a=e.z,o=t.elements;n.x=i*o[0]+r*o[4]+a*o[8]+o[12],n.y=i*o[1]+r*o[5]+a*o[9]+o[13],n.z=i*o[2]+r*o[6]+a*o[10]+o[14],n.w=i*o[3]+r*o[7]+a*o[11]+o[15]}},{key:"TransformNormal",value:function(e,t,n){var i=e.x,r=e.y,a=e.z,o=t.elements;n.x=i*o[0]+r*o[4]+a*o[8],n.y=i*o[1]+r*o[5]+a*o[9],n.z=i*o[2]+r*o[6]+a*o[10]}},{key:"transformCoordinate",value:function(e,t,n){var i=e.x,r=e.y,a=e.z,o=t.elements,s=i*o[3]+r*o[7]+a*o[11]+o[15];n.x=(i*o[0]+r*o[4]+a*o[8]+o[12])/s,n.y=(i*o[1]+r*o[5]+a*o[9]+o[13])/s,n.z=(i*o[2]+r*o[6]+a*o[10]+o[14])/s}},{key:"Clamp",value:function(e,t,n,i){var r=e.x,a=e.y,o=e.z,s=t.x,l=t.y,u=t.z,_=n.x,c=n.y,h=n.z;r=(r=r>_?_:r)<s?s:r,a=(a=a>c?c:a)<l?l:a,o=(o=o>h?h:o)<u?u:o,i.x=r,i.y=a,i.z=o}},{key:"add",value:function(e,t,n){n.x=e.x+t.x,n.y=e.y+t.y,n.z=e.z+t.z}},{key:"subtract",value:function(e,t,n){n.x=e.x-t.x,n.y=e.y-t.y,n.z=e.z-t.z}},{key:"cross",value:function(e,t,n){var i=e.x,r=e.y,a=e.z,o=t.x,s=t.y,l=t.z;n.x=r*l-a*s,n.y=a*o-i*l,n.z=i*s-r*o}},{key:"dot",value:function(e,t){return e.x*t.x+e.y*t.y+e.z*t.z}},{key:"equals",value:function(e,t){return i.nearEqual(e.x,t.x)&&i.nearEqual(e.y,t.y)&&i.nearEqual(e.z,t.z)}}]),a}();D._tempVector4=new o,D._ZERO=new D(0,0,0),D._ONE=new D(1,1,1),D._NegativeUnitX=new D(-1,0,0),D._UnitX=new D(1,0,0),D._UnitY=new D(0,1,0),D._UnitZ=new D(0,0,1),D._ForwardRH=new D(0,0,-1),D._ForwardLH=new D(0,0,1),D._Up=new D(0,1,0),(s=e.PBRRenderQuality||(e.PBRRenderQuality={}))[s.High=0]="High",s[s.Low=1]="Low";var b=function(){function p(){_classCallCheck(this,p);var e=this.elements=new Float32Array(9);e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1}return _createClass(p,[{key:"determinant",value:function(){var e=this.elements,t=e[0],n=e[1],i=e[2],r=e[3],a=e[4],o=e[5],s=e[6],l=e[7],u=e[8];return t*(u*a-o*l)+n*(-u*r+o*s)+i*(l*r-a*s)}},{key:"translate",value:function(e,t){var n=t.elements,i=this.elements,r=i[0],a=i[1],o=i[2],s=i[3],l=i[4],u=i[5],_=i[6],c=i[7],h=i[8],d=e.x,f=e.y;n[0]=r,n[1]=a,n[2]=o,n[3]=s,n[4]=l,n[5]=u,n[6]=d*r+f*s+_,n[7]=d*a+f*l+c,n[8]=d*o+f*u+h}},{key:"rotate",value:function(e,t){var n=t.elements,i=this.elements,r=i[0],a=i[1],o=i[2],s=i[3],l=i[4],u=i[5],_=i[6],c=i[7],h=i[8],d=Math.sin(e),f=Math.cos(e);n[0]=f*r+d*s,n[1]=f*a+d*l,n[2]=f*o+d*u,n[3]=f*s-d*r,n[4]=f*l-d*a,n[5]=f*u-d*o,n[6]=_,n[7]=c,n[8]=h}},{key:"scale",value:function(e,t){var n=t.elements,i=this.elements,r=e.x,a=e.y;n[0]=r*i[0],n[1]=r*i[1],n[2]=r*i[2],n[3]=a*i[3],n[4]=a*i[4],n[5]=a*i[5],n[6]=i[6],n[7]=i[7],n[8]=i[8]}},{key:"invert",value:function(e){var t=e.elements,n=this.elements,i=n[0],r=n[1],a=n[2],o=n[3],s=n[4],l=n[5],u=n[6],_=n[7],c=n[8],h=c*s-l*_,d=-c*o+l*u,f=_*o-s*u,m=i*h+r*d+a*f;m&&(m=1/m,t[0]=h*m,t[1]=(-c*r+a*_)*m,t[2]=(l*r-a*s)*m,t[3]=d*m,t[4]=(c*i-a*u)*m,t[5]=(-l*i+a*o)*m,t[6]=f*m,t[7]=(-_*i+r*u)*m,t[8]=(s*i-r*o)*m)}},{key:"transpose",value:function(e){var t=e.elements,n=this.elements;if(e===this){var i=n[1],r=n[2],a=n[5];t[1]=n[3],t[2]=n[6],t[3]=i,t[5]=n[7],t[6]=r,t[7]=a}else t[0]=n[0],t[1]=n[3],t[2]=n[6],t[3]=n[1],t[4]=n[4],t[5]=n[7],t[6]=n[2],t[7]=n[5],t[8]=n[8]}},{key:"identity",value:function(){var e=this.elements;e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1}},{key:"cloneTo",value:function(e){var t,n,i;if((n=this.elements)!==(i=e.elements))for(t=0;t<9;++t)i[t]=n[t]}},{key:"clone",value:function(){var e=new p;return this.cloneTo(e),e}}],[{key:"createRotationQuaternion",value:function(e,t){var n=e.x,i=e.y,r=e.z,a=e.w,o=n*n,s=i*i,l=r*r,u=n*i,_=r*a,c=r*n,h=i*a,d=i*r,f=n*a,m=t.elements;m[0]=1-2*(s+l),m[1]=2*(u+_),m[2]=2*(c-h),m[3]=2*(u-_),m[4]=1-2*(l+o),m[5]=2*(d+f),m[6]=2*(c+h),m[7]=2*(d-f),m[8]=1-2*(s+o)}},{key:"createFromTranslation",value:function(e,t){var n=t.elements;n[0]=1,n[1]=0,n[2]=0,n[3]=0,n[4]=1,n[5]=0,n[6]=e.x,n[7]=e.y,n[8]=1}},{key:"createFromRotation",value:function(e,t){var n=t.elements,i=Math.sin(e),r=Math.cos(e);n[0]=r,n[1]=i,n[2]=0,n[3]=-i,n[4]=r,n[5]=0,n[6]=0,n[7]=0,n[8]=1}},{key:"createFromScaling",value:function(e,t){var n=t.elements;n[0]=e.x,n[1]=0,n[2]=0,n[3]=0,n[4]=e.y,n[5]=0,n[6]=0,n[7]=0,n[8]=e.z}},{key:"createFromMatrix4x4",value:function(e,t){var n=e.elements,i=t.elements;i[0]=n[0],i[1]=n[1],i[2]=n[2],i[3]=n[4],i[4]=n[5],i[5]=n[6],i[6]=n[8],i[7]=n[9],i[8]=n[10]}},{key:"multiply",value:function(e,t,n){var i=e.elements,r=t.elements,a=n.elements,o=i[0],s=i[1],l=i[2],u=i[3],_=i[4],c=i[5],h=i[6],d=i[7],f=i[8],m=r[0],p=r[1],v=r[2],E=r[3],T=r[4],g=r[5],y=r[6],S=r[7],R=r[8];a[0]=m*o+p*u+v*h,a[1]=m*s+p*_+v*S,a[2]=m*l+p*c+v*f,a[3]=E*o+T*u+g*h,a[4]=E*s+T*_+g*d,a[5]=E*l+T*c+g*f,a[6]=y*o+S*u+R*h,a[7]=y*s+S*_+R*d,a[8]=y*l+S*c+R*f}},{key:"lookAt",value:function(e,t,n,i){D.subtract(e,t,p._tempV30),D.normalize(p._tempV30,p._tempV30),D.cross(n,p._tempV30,p._tempV31),D.normalize(p._tempV31,p._tempV31),D.cross(p._tempV30,p._tempV31,p._tempV32);var r=p._tempV30,a=p._tempV31,o=p._tempV32,s=i.elements;s[0]=a.x,s[3]=a.y,s[6]=a.z,s[1]=o.x,s[4]=o.y,s[7]=o.z,s[2]=r.x,s[5]=r.y,s[8]=r.z}}]),p}();b.DEFAULT=new b,b._tempV30=new D,b._tempV31=new D,b._tempV32=new D;var F=function g(){_classCallCheck(this,g)};F.Shader3D=null,F.Scene3D=null,F.MeshRenderStaticBatchManager=null,F.MeshRenderDynamicBatchManager=null,F.SubMeshDynamicBatch=null,F.Laya3D=null,F.Matrix4x4=null,F.Physics3D=null,F.ShadowLightType=null;var Z=function(){function S(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1;_classCallCheck(this,S),this.x=e,this.y=t,this.z=n,this.w=i}return _createClass(S,[{key:"scaling",value:function(e,t){t.x=this.x*e,t.y=this.y*e,t.z=this.z*e,t.w=this.w*e}},{key:"normalize",value:function(e){var t=this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w;t>0&&(t=1/Math.sqrt(t),e.x=this.x*t,e.y=this.y*t,e.z=this.z*t,e.w=this.w*t)}},{key:"length",value:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}},{key:"rotateX",value:function(e,t){e*=.5;var n=Math.sin(e),i=Math.cos(e);t.x=this.x*i+this.w*n,t.y=this.y*i+this.z*n,t.z=this.z*i-this.y*n,t.w=this.w*i-this.x*n}},{key:"rotateY",value:function(e,t){e*=.5;var n=Math.sin(e),i=Math.cos(e);t.x=this.x*i-this.z*n,t.y=this.y*i+this.w*n,t.z=this.z*i+this.x*n,t.w=this.w*i-this.y*n}},{key:"rotateZ",value:function(e,t){e*=.5;var n=Math.sin(e),i=Math.cos(e);t.x=this.x*i+this.y*n,t.y=this.y*i-this.x*n,t.z=this.z*i+this.w*n,t.w=this.w*i-this.z*n}},{key:"getYawPitchRoll",value:function(e){D.transformQuat(D._ForwardRH,this,S.TEMPVector31),D.transformQuat(D._Up,this,S.TEMPVector32);var t=S.TEMPVector32;S.angleTo(D._ZERO,S.TEMPVector31,S.TEMPVector33);var n=S.TEMPVector33;n.x==Math.PI/2?(n.y=S.arcTanAngle(t.z,t.x),n.z=0):n.x==-Math.PI/2?(n.y=S.arcTanAngle(-t.z,-t.x),n.z=0):(F.Matrix4x4.createRotationY(-n.y,F.Matrix4x4.TEMPMatrix0),F.Matrix4x4.createRotationX(-n.x,F.Matrix4x4.TEMPMatrix1),D.transformCoordinate(S.TEMPVector32,F.Matrix4x4.TEMPMatrix0,S.TEMPVector32),D.transformCoordinate(S.TEMPVector32,F.Matrix4x4.TEMPMatrix1,S.TEMPVector32),n.z=S.arcTanAngle(t.y,-t.x)),n.y<=-Math.PI&&(n.y=Math.PI),n.z<=-Math.PI&&(n.z=Math.PI),n.y>=Math.PI&&n.z>=Math.PI&&(n.y=0,n.z=0,n.x=Math.PI-n.x);var i=e;i.x=n.y,i.y=n.x,i.z=n.z}},{key:"invert",value:function(e){var t=this.x,n=this.y,i=this.z,r=this.w,a=t*t+n*n+i*i+r*r,o=a?1/a:0;e.x=-t*o,e.y=-n*o,e.z=-i*o,e.w=r*o}},{key:"identity",value:function(){this.x=0,this.y=0,this.z=0,this.w=1}},{key:"fromArray",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;this.x=e[t+0],this.y=e[t+1],this.z=e[t+2],this.w=e[t+3]}},{key:"cloneTo",value:function(e){this!==e&&(e.x=this.x,e.y=this.y,e.z=this.z,e.w=this.w)}},{key:"clone",value:function(){var e=new S;return this.cloneTo(e),e}},{key:"equals",value:function(e){return i.nearEqual(this.x,e.x)&&i.nearEqual(this.y,e.y)&&i.nearEqual(this.z,e.z)&&i.nearEqual(this.w,e.w)}},{key:"lengthSquared",value:function(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}},{key:"forNativeElement",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;e?(this.elements=e,this.elements[0]=this.x,this.elements[1]=this.y,this.elements[2]=this.z,this.elements[3]=this.w):this.elements=new Float32Array([this.x,this.y,this.z,this.w]),r.rewriteNumProperty(this,"x",0),r.rewriteNumProperty(this,"y",1),r.rewriteNumProperty(this,"z",2),r.rewriteNumProperty(this,"w",3)}}],[{key:"createFromYawPitchRoll",value:function(e,t,n,i){var r=.5*n,a=.5*t,o=.5*e,s=Math.sin(r),l=Math.cos(r),u=Math.sin(a),_=Math.cos(a),c=Math.sin(o),h=Math.cos(o);i.x=h*u*l+c*_*s,i.y=c*_*l-h*u*s,i.z=h*_*s-c*u*l,i.w=h*_*l+c*u*s}},{key:"multiply",value:function(e,t,n){var i=e.x,r=e.y,a=e.z,o=e.w,s=t.x,l=t.y,u=t.z,_=t.w,c=r*u-a*l,h=a*s-i*u,d=i*l-r*s,f=i*s+r*l+a*u;n.x=i*_+s*o+c,n.y=r*_+l*o+h,n.z=a*_+u*o+d,n.w=o*_-f}},{key:"arcTanAngle",value:function(e,t){return 0==e?1==t?Math.PI/2:-Math.PI/2:e>0?Math.atan(t/e):e<0?t>0?Math.atan(t/e)+Math.PI:Math.atan(t/e)-Math.PI:0}},{key:"angleTo",value:function(e,t,n){D.subtract(t,e,S.TEMPVector30),D.normalize(S.TEMPVector30,S.TEMPVector30),n.x=Math.asin(S.TEMPVector30.y),n.y=S.arcTanAngle(-S.TEMPVector30.z,-S.TEMPVector30.x)}},{key:"createFromAxisAngle",value:function(e,t,n){t*=.5;var i=Math.sin(t);n.x=i*e.x,n.y=i*e.y,n.z=i*e.z,n.w=Math.cos(t)}},{key:"createFromMatrix4x4",value:function(e,t){var n,i,r=e.elements,a=r[0]+r[5]+r[10];a>0?(n=Math.sqrt(a+1),t.w=.5*n,n=.5/n,t.x=(r[6]-r[9])*n,t.y=(r[8]-r[2])*n,t.z=(r[1]-r[4])*n):r[0]>=r[5]&&r[0]>=r[10]?(i=.5/(n=Math.sqrt(1+r[0]-r[5]-r[10])),t.x=.5*n,t.y=(r[1]+r[4])*i,t.z=(r[2]+r[8])*i,t.w=(r[6]-r[9])*i):r[5]>r[10]?(i=.5/(n=Math.sqrt(1+r[5]-r[0]-r[10])),t.x=(r[4]+r[1])*i,t.y=.5*n,t.z=(r[9]+r[6])*i,t.w=(r[8]-r[2])*i):(i=.5/(n=Math.sqrt(1+r[10]-r[0]-r[5])),t.x=(r[8]+r[2])*i,t.y=(r[9]+r[6])*i,t.z=.5*n,t.w=(r[1]-r[4])*i)}},{key:"slerp",value:function(e,t,n,i){var r,a,o,s,l,u=e.x,_=e.y,c=e.z,h=e.w,d=t.x,f=t.y,m=t.z,p=t.w;return(a=u*d+_*f+c*m+h*p)<0&&(a=-a,d=-d,f=-f,m=-m,p=-p),1-a>1e-6?(r=Math.acos(a),o=Math.sin(r),s=Math.sin((1-n)*r)/o,l=Math.sin(n*r)/o):(s=1-n,l=n),i.x=s*u+l*d,i.y=s*_+l*f,i.z=s*c+l*m,i.w=s*h+l*p,i}},{key:"lerp",value:function(e,t,n,i){var r=1-n;S.dot(e,t)>=0?(i.x=r*e.x+n*t.x,i.y=r*e.y+n*t.y,i.z=r*e.z+n*t.z,i.w=r*e.w+n*t.w):(i.x=r*e.x-n*t.x,i.y=r*e.y-n*t.y,i.z=r*e.z-n*t.z,i.w=r*e.w-n*t.w),i.normalize(i)}},{key:"add",value:function(e,t,n){n.x=e.x+t.x,n.y=e.y+t.y,n.z=e.z+t.z,n.w=e.w+t.w}},{key:"dot",value:function(e,t){return e.x*t.x+e.y*t.y+e.z*t.z+e.w*t.w}},{key:"rotationLookAt",value:function(e,t,n){S.lookAt(D._ZERO,e,t,n)}},{key:"lookAt",value:function(e,t,n,i){b.lookAt(e,t,n,S._tempMatrix3x3),S.rotationMatrix(S._tempMatrix3x3,i)}},{key:"invert",value:function(e,t){var n=e.lengthSquared();i.isZero(n)||(n=1/n,t.x=-e.x*n,t.y=-e.y*n,t.z=-e.z*n,t.w=e.w*n)}},{key:"rotationMatrix",value:function(e,t){var n,i,r=e.elements,a=r[0],o=r[1],s=r[2],l=r[3],u=r[4],_=r[5],c=r[6],h=r[7],d=r[8],f=a+u+d;f>0?(n=Math.sqrt(f+1),t.w=.5*n,n=.5/n,t.x=(_-h)*n,t.y=(c-s)*n,t.z=(o-l)*n):a>=u&&a>=d?(i=.5/(n=Math.sqrt(1+a-u-d)),t.x=.5*n,t.y=(o+l)*i,t.z=(s+c)*i,t.w=(_-h)*i):u>d?(i=.5/(n=Math.sqrt(1+u-a-d)),t.x=(l+o)*i,t.y=.5*n,t.z=(h+_)*i,t.w=(c-s)*i):(i=.5/(n=Math.sqrt(1+d-a-u)),t.x=(c+s)*i,t.y=(h+_)*i,t.z=.5*n,t.w=(o-l)*i)}}]),S}();Z.TEMPVector30=new D,Z.TEMPVector31=new D,Z.TEMPVector32=new D,Z.TEMPVector33=new D,Z._tempMatrix3x3=new b,Z.DEFAULT=new Z,Z.NAN=new Z(NaN,NaN,NaN,NaN);var q=function(){function R(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:1,o=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0,s=arguments.length>7&&void 0!==arguments[7]?arguments[7]:0,l=arguments.length>8&&void 0!==arguments[8]?arguments[8]:0,u=arguments.length>9&&void 0!==arguments[9]?arguments[9]:0,_=arguments.length>10&&void 0!==arguments[10]?arguments[10]:1,c=arguments.length>11&&void 0!==arguments[11]?arguments[11]:0,h=arguments.length>12&&void 0!==arguments[12]?arguments[12]:0,d=arguments.length>13&&void 0!==arguments[13]?arguments[13]:0,f=arguments.length>14&&void 0!==arguments[14]?arguments[14]:0,m=arguments.length>15&&void 0!==arguments[15]?arguments[15]:1,p=arguments.length>16&&void 0!==arguments[16]?arguments[16]:null;_classCallCheck(this,R);var v=this.elements=p||new Float32Array(16);v[0]=e,v[1]=t,v[2]=n,v[3]=i,v[4]=r,v[5]=a,v[6]=o,v[7]=s,v[8]=l,v[9]=u,v[10]=_,v[11]=c,v[12]=h,v[13]=d,v[14]=f,v[15]=m}return _createClass(R,[{key:"setRotation",value:function(e){var t=e.x,n=e.y,i=e.z,r=e.w,a=t*t,o=n*n,s=i*i,l=t*n,u=i*r,_=i*t,c=n*r,h=n*i,d=t*r,f=this.elements;f[0]=1-2*(o+s),f[1]=2*(l+u),f[2]=2*(_-c),f[4]=2*(l-u),f[5]=1-2*(s+a),f[6]=2*(h+d),f[8]=2*(_+c),f[9]=2*(h-d),f[10]=1-2*(o+a)}},{key:"setPosition",value:function(e){var t=this.elements;t[12]=e.x,t[13]=e.y,t[14]=e.z}},{key:"getElementByRowColumn",value:function(e,t){if(e<0||e>3)throw new Error("row Rows and columns for matrices run from 0 to 3, inclusive.");if(t<0||t>3)throw new Error("column Rows and columns for matrices run from 0 to 3, inclusive.");return this.elements[4*e+t]}},{key:"setElementByRowColumn",value:function(e,t,n){if(e<0||e>3)throw new Error("row Rows and columns for matrices run from 0 to 3, inclusive.");if(t<0||t>3)throw new Error("column Rows and columns for matrices run from 0 to 3, inclusive.");this.elements[4*e+t]=n}},{key:"equalsOtherMatrix",value:function(e){var t=this.elements,n=e.elements;return i.nearEqual(t[0],n[0])&&i.nearEqual(t[1],n[1])&&i.nearEqual(t[2],n[2])&&i.nearEqual(t[3],n[3])&&i.nearEqual(t[4],n[4])&&i.nearEqual(t[5],n[5])&&i.nearEqual(t[6],n[6])&&i.nearEqual(t[7],n[7])&&i.nearEqual(t[8],n[8])&&i.nearEqual(t[9],n[9])&&i.nearEqual(t[10],n[10])&&i.nearEqual(t[11],n[11])&&i.nearEqual(t[12],n[12])&&i.nearEqual(t[13],n[13])&&i.nearEqual(t[14],n[14])&&i.nearEqual(t[15],n[15])}},{key:"decomposeTransRotScale",value:function(e,t,n){var i=R._tempMatrix4x4;return this.decomposeTransRotMatScale(e,i,n)?(Z.createFromMatrix4x4(i,t),!0):(t.identity(),!1)}},{key:"decomposeTransRotMatScale",value:function(e,t,n){var r=this.elements,a=e,o=t.elements,s=n;a.x=r[12],a.y=r[13],a.z=r[14];var l=r[0],u=r[1],_=r[2],c=r[4],h=r[5],d=r[6],f=r[8],m=r[9],p=r[10],v=s.x=Math.sqrt(l*l+u*u+_*_),E=s.y=Math.sqrt(c*c+h*h+d*d),T=s.z=Math.sqrt(f*f+m*m+p*p);if(i.isZero(v)||i.isZero(E)||i.isZero(T))return o[1]=o[2]=o[3]=o[4]=o[6]=o[7]=o[8]=o[9]=o[11]=o[12]=o[13]=o[14]=0,o[0]=o[5]=o[10]=o[15]=1,!1;var g=R._tempVector0;g.x=f/T,g.y=m/T,g.z=p/T;var y=R._tempVector1;y.x=l/v,y.y=u/v,y.z=_/v;var S=R._tempVector2;D.cross(g,y,S);var C=R._tempVector1;return D.cross(S,g,C),o[3]=o[7]=o[11]=o[12]=o[13]=o[14]=0,o[15]=1,o[0]=C.x,o[1]=C.y,o[2]=C.z,o[4]=S.x,o[5]=S.y,o[6]=S.z,o[8]=g.x,o[9]=g.y,o[10]=g.z,o[0]*l+o[1]*u+o[2]*_<0&&(s.x=-v),o[4]*c+o[5]*h+o[6]*d<0&&(s.y=-E),o[8]*f+o[9]*m+o[10]*p<0&&(s.z=-T),!0}},{key:"decomposeYawPitchRoll",value:function(e){var t=Math.asin(-this.elements[9]);e.y=t,Math.cos(t)>i.zeroTolerance?(e.z=Math.atan2(this.elements[1],this.elements[5]),e.x=Math.atan2(this.elements[8],this.elements[10])):(e.z=Math.atan2(-this.elements[4],this.elements[0]),e.x=0)}},{key:"normalize",value:function(){var e=this.elements,t=e[0],n=e[1],i=e[2],r=Math.sqrt(t*t+n*n+i*i);if(!r)return e[0]=0,e[1]=0,void(e[2]=0);1!=r&&(r=1/r,e[0]=t*r,e[1]=n*r,e[2]=i*r)}},{key:"transpose",value:function(){var e,t;return t=(e=this.elements)[1],e[1]=e[4],e[4]=t,t=e[2],e[2]=e[8],e[8]=t,t=e[3],e[3]=e[12],e[12]=t,t=e[6],e[6]=e[9],e[9]=t,t=e[7],e[7]=e[13],e[13]=t,t=e[11],e[11]=e[14],e[14]=t,this}},{key:"invert",value:function(e){var t=this.elements,n=e.elements,i=t[0],r=t[1],a=t[2],o=t[3],s=t[4],l=t[5],u=t[6],_=t[7],c=t[8],h=t[9],d=t[10],f=t[11],m=t[12],p=t[13],v=t[14],E=t[15],T=i*l-r*s,g=i*u-a*s,y=i*_-o*s,S=r*u-a*l,R=r*_-o*l,C=a*_-o*u,A=c*p-h*m,I=c*v-d*m,x=c*E-f*m,D=h*v-d*p,M=h*E-f*p,L=d*E-f*v,O=T*L-g*M+y*D+S*x-R*I+C*A;0!==Math.abs(O)&&(O=1/O,n[0]=(l*L-u*M+_*D)*O,n[1]=(a*M-r*L-o*D)*O,n[2]=(p*C-v*R+E*S)*O,n[3]=(d*R-h*C-f*S)*O,n[4]=(u*x-s*L-_*I)*O,n[5]=(i*L-a*x+o*I)*O,n[6]=(v*y-m*C-E*g)*O,n[7]=(c*C-d*y+f*g)*O,n[8]=(s*M-l*x+_*A)*O,n[9]=(r*x-i*M-o*A)*O,n[10]=(m*R-p*y+E*T)*O,n[11]=(h*y-c*R-f*T)*O,n[12]=(l*I-s*D-u*A)*O,n[13]=(i*D-r*I+a*A)*O,n[14]=(p*g-m*S-v*T)*O,n[15]=(c*S-h*g+d*T)*O)}},{key:"identity",value:function(){var e=this.elements;e[1]=e[2]=e[3]=e[4]=e[6]=e[7]=e[8]=e[9]=e[11]=e[12]=e[13]=e[14]=0,e[0]=e[5]=e[10]=e[15]=1}},{key:"cloneTo",value:function(e){var t,n,i;if((n=this.elements)!==(i=e.elements))for(t=0;t<16;++t)i[t]=n[t]}},{key:"clone",value:function(){var e=new R;return this.cloneTo(e),e}},{key:"getTranslationVector",value:function(e){var t=this.elements;e.x=t[12],e.y=t[13],e.z=t[14]}},{key:"setTranslationVector",value:function(e){var t=this.elements,n=e;t[12]=n.x,t[13]=n.y,t[14]=n.z}},{key:"getForward",value:function(e){var t=this.elements;e.x=-t[8],e.y=-t[9],e.z=-t[10]}},{key:"setForward",value:function(e){var t=this.elements;t[8]=-e.x,t[9]=-e.y,t[10]=-e.z}},{key:"getInvertFront",value:function(){this.decomposeTransRotScale(R._tempVector0,R._tempQuaternion,R._tempVector1);var e=R._tempVector1,t=e.x<0;return e.y<0&&(t=!t),e.z<0&&(t=!t),t}}],[{key:"createRotationX",value:function(e,t){var n=t.elements,i=Math.sin(e),r=Math.cos(e);n[1]=n[2]=n[3]=n[4]=n[7]=n[8]=n[11]=n[12]=n[13]=n[14]=0,n[0]=n[15]=1,n[5]=n[10]=r,n[6]=i,n[9]=-i}},{key:"createRotationY",value:function(e,t){var n=t.elements,i=Math.sin(e),r=Math.cos(e);n[1]=n[3]=n[4]=n[6]=n[7]=n[9]=n[11]=n[12]=n[13]=n[14]=0,n[5]=n[15]=1,n[0]=n[10]=r,n[2]=-i,n[8]=i}},{key:"createRotationZ",value:function(e,t){var n=t.elements,i=Math.sin(e),r=Math.cos(e);n[2]=n[3]=n[6]=n[7]=n[8]=n[9]=n[11]=n[12]=n[13]=n[14]=0,n[10]=n[15]=1,n[0]=n[5]=r,n[1]=i,n[4]=-i}},{key:"createRotationYawPitchRoll",value:function(e,t,n,i){Z.createFromYawPitchRoll(e,t,n,R._tempQuaternion),R.createRotationQuaternion(R._tempQuaternion,i)}},{key:"createRotationAxis",value:function(e,t,n){var i=e.x,r=e.y,a=e.z,o=Math.cos(t),s=Math.sin(t),l=i*i,u=r*r,_=a*a,c=i*r,h=i*a,d=r*a,f=n.elements;f[3]=f[7]=f[11]=f[12]=f[13]=f[14]=0,f[15]=1,f[0]=l+o*(1-l),f[1]=c-o*c+s*a,f[2]=h-o*h-s*r,f[4]=c-o*c-s*a,f[5]=u+o*(1-u),f[6]=d-o*d+s*i,f[8]=h-o*h+s*r,f[9]=d-o*d-s*i,f[10]=_+o*(1-_)}},{key:"createRotationQuaternion",value:function(e,t){var n=t.elements,i=e.x,r=e.y,a=e.z,o=e.w,s=i*i,l=r*r,u=a*a,_=i*r,c=a*o,h=a*i,d=r*o,f=r*a,m=i*o;n[3]=n[7]=n[11]=n[12]=n[13]=n[14]=0,n[15]=1,n[0]=1-2*(l+u),n[1]=2*(_+c),n[2]=2*(h-d),n[4]=2*(_-c),n[5]=1-2*(u+s),n[6]=2*(f+m),n[8]=2*(h+d),n[9]=2*(f-m),n[10]=1-2*(l+s)}},{key:"createTranslate",value:function(e,t){var n=t.elements;n[4]=n[8]=n[1]=n[9]=n[2]=n[6]=n[3]=n[7]=n[11]=0,n[0]=n[5]=n[10]=n[15]=1,n[12]=e.x,n[13]=e.y,n[14]=e.z}},{key:"createScaling",value:function(e,t){var n=t.elements;n[0]=e.x,n[5]=e.y,n[10]=e.z,n[1]=n[4]=n[8]=n[12]=n[9]=n[13]=n[2]=n[6]=n[14]=n[3]=n[7]=n[11]=0,n[15]=1}},{key:"multiply",value:function(e,t,n){var i=t.elements,r=e.elements,a=n.elements,o=i[0],s=i[1],l=i[2],u=i[3],_=i[4],c=i[5],h=i[6],d=i[7],f=i[8],m=i[9],p=i[10],v=i[11],E=i[12],T=i[13],g=i[14],y=i[15],S=r[0],R=r[1],C=r[2],A=r[3],I=r[4],x=r[5],D=r[6],M=r[7],L=r[8],O=r[9],N=r[10],P=r[11],b=r[12],w=r[13],k=r[14],V=r[15];a[0]=o*S+s*I+l*L+u*b,a[1]=o*R+s*x+l*O+u*w,a[2]=o*C+s*D+l*N+u*k,a[3]=o*A+s*M+l*P+u*V,a[4]=_*S+c*I+h*L+d*b,a[5]=_*R+c*x+h*O+d*w,a[6]=_*C+c*D+h*N+d*k,a[7]=_*A+c*M+h*P+d*V,a[8]=f*S+m*I+p*L+v*b,a[9]=f*R+m*x+p*O+v*w,a[10]=f*C+m*D+p*N+v*k,a[11]=f*A+m*M+p*P+v*V,a[12]=E*S+T*I+g*L+y*b,a[13]=E*R+T*x+g*O+y*w,a[14]=E*C+T*D+g*N+y*k,a[15]=E*A+T*M+g*P+y*V}},{key:"multiplyForNative",value:function(e,n,i){t.LayaGL.instance.matrix4x4Multiply(e.elements,n.elements,i.elements)}},{key:"createFromQuaternion",value:function(e,t){var n=t.elements,i=e.x,r=e.y,a=e.z,o=e.w,s=i+i,l=r+r,u=a+a,_=i*s,c=r*s,h=r*l,d=a*s,f=a*l,m=a*u,p=o*s,v=o*l,E=o*u;n[0]=1-h-m,n[1]=c+E,n[2]=d-v,n[3]=0,n[4]=c-E,n[5]=1-_-m,n[6]=f+p,n[7]=0,n[8]=d+v,n[9]=f-p,n[10]=1-_-h,n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1}},{key:"createAffineTransformation",value:function(e,t,n,i){var r=i.elements,a=t.x,o=t.y,s=t.z,l=t.w,u=a+a,_=o+o,c=s+s,h=a*u,d=a*_,f=a*c,m=o*_,p=o*c,v=s*c,E=l*u,T=l*_,g=l*c,y=n.x,S=n.y,R=n.z;r[0]=(1-(m+v))*y,r[1]=(d+g)*y,r[2]=(f-T)*y,r[3]=0,r[4]=(d-g)*S,r[5]=(1-(h+v))*S,r[6]=(p+E)*S,r[7]=0,r[8]=(f+T)*R,r[9]=(p-E)*R,r[10]=(1-(h+m))*R,r[11]=0,r[12]=e.x,r[13]=e.y,r[14]=e.z,r[15]=1}},{key:"createLookAt",value:function(e,t,n,i){var r=i.elements,a=R._tempVector0,o=R._tempVector1,s=R._tempVector2;D.subtract(e,t,s),D.normalize(s,s),D.cross(n,s,a),D.normalize(a,a),D.cross(s,a,o),r[3]=r[7]=r[11]=0,r[15]=1,r[0]=a.x,r[4]=a.y,r[8]=a.z,r[1]=o.x,r[5]=o.y,r[9]=o.z,r[2]=s.x,r[6]=s.y,r[10]=s.z,r[12]=-D.dot(a,e),r[13]=-D.dot(o,e),r[14]=-D.dot(s,e)}},{key:"createPerspective",value:function(e,t,n,i,r){var a=1/Math.tan(.5*e),o=n/(a/t),s=n/a;R.createPerspectiveOffCenter(-o,o,-s,s,n,i,r)}},{key:"createPerspectiveOffCenter",value:function(e,t,n,i,r,a,o){var s=o.elements,l=a/(a-r);s[1]=s[2]=s[3]=s[4]=s[6]=s[7]=s[12]=s[13]=s[15]=0,s[0]=2*r/(t-e),s[5]=2*r/(i-n),s[8]=(e+t)/(t-e),s[9]=(i+n)/(i-n),s[10]=-l,s[11]=-1,s[14]=-r*l}},{key:"createOrthoOffCenter",value:function(e,t,n,i,r,a,o){var s=o.elements,l=1/(a-r);s[1]=s[2]=s[3]=s[4]=s[6]=s[8]=s[7]=s[9]=s[11]=0,s[15]=1,s[0]=2/(t-e),s[5]=2/(i-n),s[10]=-l,s[12]=(e+t)/(e-t),s[13]=(i+n)/(n-i),s[14]=-r*l}},{key:"billboard",value:function(e,t,n,r,a){D.subtract(e,t,R._tempVector0);var o=D.scalarLengthSquared(R._tempVector0);i.isZero(o)?(D.scale(r,-1,R._tempVector1),R._tempVector1.cloneTo(R._tempVector0)):D.scale(R._tempVector0,1/Math.sqrt(o),R._tempVector0),D.cross(n,R._tempVector0,R._tempVector2),D.normalize(R._tempVector2,R._tempVector2),D.cross(R._tempVector0,R._tempVector2,R._tempVector3);var s=R._tempVector2,l=R._tempVector3,u=R._tempVector0,_=e,c=a.elements;c[0]=s.x,c[1]=s.y,c[2]=s.z,c[3]=0,c[4]=l.x,c[5]=l.y,c[6]=l.z,c[7]=0,c[8]=u.x,c[9]=u.y,c[10]=u.z,c[11]=0,c[12]=_.x,c[13]=_.y,c[14]=_.z,c[15]=1}},{key:"translation",value:function(e,t){var n=t.elements;n[0]=n[5]=n[10]=n[15]=1,n[12]=e.x,n[13]=e.y,n[14]=e.z}}]),R}();q._tempMatrix4x4=new q,q.TEMPMatrix0=new q,q.TEMPMatrix1=new q,q._tempVector0=new D,q._tempVector1=new D,q._tempVector2=new D,q._tempVector3=new D,q._tempQuaternion=new Z,q.DEFAULT=new q,q.ZERO=new q(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);var Q=function(){function v(){_classCallCheck(this,v),this._scale=new D(1,1,1),this._centerMatrix=new q,this._attatched=!1,this._indexInCompound=-1,this._compoundParent=null,this._attatchedCollisionObject=null,this._referenceCount=0,this._localOffset=new D(0,0,0),this._localRotation=new Z(0,0,0,1),this.needsCustomCollisionCallback=!1}return _createClass(v,[{key:"_setScale",value:function(e){if(this._compoundParent)this.updateLocalTransformations();else{var t=F.Physics3D._bullet;t.btVector3_setValue(v._btScale,e.x,e.y,e.z),t.btCollisionShape_setLocalScaling(this._btShape,v._btScale)}}},{key:"_addReference",value:function(){this._referenceCount++}},{key:"_removeReference",value:function(){this._referenceCount--}},{key:"updateLocalTransformations",value:function(){if(this._compoundParent){var e=v._tempVector30;D.multiply(this.localOffset,this._scale,e),v._createAffineTransformation(e,this.localRotation,this._centerMatrix.elements)}else v._createAffineTransformation(this.localOffset,this.localRotation,this._centerMatrix.elements)}},{key:"cloneTo",value:function(e){var t=e;this._localOffset.cloneTo(t.localOffset),this._localRotation.cloneTo(t.localRotation),t.localOffset=t.localOffset,t.localRotation=t.localRotation}},{key:"clone",value:function(){return null}},{key:"destroy",value:function(){this._btShape&&(F.Physics3D._bullet.btCollisionShape_destroy(this._btShape),this._btShape=null)}},{key:"type",get:function(){return this._type}},{key:"localOffset",get:function(){return this._localOffset},set:function(e){this._localOffset=e,this._compoundParent&&this._compoundParent._updateChildTransform(this)}},{key:"localRotation",get:function(){return this._localRotation},set:function(e){this._localRotation=e,this._compoundParent&&this._compoundParent._updateChildTransform(this)}}],[{key:"__init__",value:function(){var e=F.Physics3D._bullet;v._btScale=e.btVector3_create(1,1,1),v._btVector30=e.btVector3_create(0,0,0),v._btQuaternion0=e.btQuaternion_create(0,0,0,1),v._btTransform0=e.btTransform_create()}},{key:"_createAffineTransformation",value:function(e,t,n){var i=t.x,r=t.y,a=t.z,o=t.w,s=i+i,l=r+r,u=a+a,_=i*s,c=i*l,h=i*u,d=r*l,f=r*u,m=a*u,p=o*s,v=o*l,E=o*u;n[0]=1-(d+m),n[1]=c+E,n[2]=h-v,n[3]=0,n[4]=c-E,n[5]=1-(_+m),n[6]=f+p,n[7]=0,n[8]=h+v,n[9]=f-p,n[10]=1-(_+d),n[11]=0,n[12]=e.x,n[13]=e.y,n[14]=e.z,n[15]=1}}]),v}();Q.SHAPEORIENTATION_UPX=0,Q.SHAPEORIENTATION_UPY=1,Q.SHAPEORIENTATION_UPZ=2,Q.SHAPETYPES_BOX=0,Q.SHAPETYPES_SPHERE=1,Q.SHAPETYPES_CYLINDER=2,Q.SHAPETYPES_CAPSULE=3,Q.SHAPETYPES_CONVEXHULL=4,Q.SHAPETYPES_COMPOUND=5,Q.SHAPETYPES_STATICPLANE=6,Q.SHAPETYPES_CONE=7,Q._tempVector30=new D;var ne=function(e){function A(e,t){var n;_classCallCheck(this,A),(n=_possibleConstructorReturn(this,_getPrototypeOf(A).call(this)))._normal=e,n._offset=t,n._type=Q.SHAPETYPES_STATICPLANE;var i=F.Physics3D._bullet;return i.btVector3_setValue(A._btNormal,-e.x,e.y,e.z),n._btShape=i.btStaticPlaneShape_create(A._btNormal,t),n}return _inherits(A,Q),_createClass(A,[{key:"clone",value:function(){var e=new A(this._normal,this._offset);return this.cloneTo(e),e}}],[{key:"__init__",value:function(){A._btNormal=F.Physics3D._bullet.btVector3_create(0,0,0)}}]),A}(),ie=function(e){function x(){var e;return _classCallCheck(this,x),(e=_possibleConstructorReturn(this,_getPrototypeOf(x).call(this)))._childColliderShapes=[],e._type=Q.SHAPETYPES_COMPOUND,e._btShape=F.Physics3D._bullet.btCompoundShape_create(),e}return _inherits(x,Q),_createClass(x,[{key:"_clearChildShape",value:function(e){e._attatched=!1,e._compoundParent=null,e._indexInCompound=-1}},{key:"_addReference",value:function(){}},{key:"_removeReference",value:function(){}},{key:"_updateChildTransform",value:function(e){var t=F.Physics3D._bullet,n=e.localOffset,i=e.localRotation,r=Q._btVector30,a=Q._btQuaternion0,o=Q._btTransform0;t.btVector3_setValue(r,-n.x,n.y,n.z),t.btQuaternion_setValue(a,-i.x,i.y,i.z,-i.w),t.btTransform_setOrigin(o,r),t.btTransform_setRotation(o,a),t.btCompoundShape_updateChildTransform(this._btShape,e._indexInCompound,o,!0)}},{key:"addChildShape",value:function(e){if(e._attatched)throw"CompoundColliderShape: this shape has attatched to other entity.";e._attatched=!0,e._compoundParent=this,e._indexInCompound=this._childColliderShapes.length,this._childColliderShapes.push(e);var t=e.localOffset,n=e.localRotation,i=F.Physics3D._bullet;i.btVector3_setValue(x._btOffset,-t.x,t.y,t.z),i.btQuaternion_setValue(x._btRotation,-n.x,n.y,n.z,-n.w),i.btTransform_setOrigin(x._btTransform,x._btOffset),i.btTransform_setRotation(x._btTransform,x._btRotation);var r=i.btCollisionShape_getLocalScaling(this._btShape);i.btCollisionShape_setLocalScaling(this._btShape,x._btVector3One),i.btCompoundShape_addChildShape(this._btShape,x._btTransform,e._btShape),i.btCollisionShape_setLocalScaling(this._btShape,r),this._attatchedCollisionObject&&(this._attatchedCollisionObject.colliderShape=this)}},{key:"removeChildShape",value:function(e){if(e._compoundParent===this){var t=e._indexInCompound;this._clearChildShape(e);var n=this._childColliderShapes[this._childColliderShapes.length-1];n._indexInCompound=t,this._childColliderShapes[t]=n,this._childColliderShapes.pop(),F.Physics3D._bullet.btCompoundShape_removeChildShapeByIndex(this._btShape,t)}}},{key:"clearChildShape",value:function(){for(var e=0,t=this._childColliderShapes.length;e<t;e++)this._clearChildShape(this._childColliderShapes[e]),F.Physics3D._bullet.btCompoundShape_removeChildShapeByIndex(this._btShape,0);this._childColliderShapes.length=0}},{key:"getChildShapeCount",value:function(){return this._childColliderShapes.length}},{key:"cloneTo",value:function(e){var t=e;t.clearChildShape();for(var n=0,i=this._childColliderShapes.length;n<i;n++)t.addChildShape(this._childColliderShapes[n].clone())}},{key:"clone",value:function(){var e=new x;return this.cloneTo(e),e}},{key:"destroy",value:function(){_get(_getPrototypeOf(x.prototype),"destroy",this).call(this);for(var e=0,t=this._childColliderShapes.length;e<t;e++){var n=this._childColliderShapes[e];0===n._referenceCount&&n.destroy()}}}],[{key:"__init__",value:function(){var e=F.Physics3D._bullet;x._btVector3One=e.btVector3_create(1,1,1),x._btTransform=e.btTransform_create(),x._btOffset=e.btVector3_create(0,0,0),x._btRotation=e.btQuaternion_create(0,0,0,1)}}]),x}(),oe=function(e){function I(e){var t;return _classCallCheck(this,I),(t=_possibleConstructorReturn(this,_getPrototypeOf(I).call(this)))._localPosition=new D(0,0,0),t._localRotation=new Z(0,0,0,1),t._localScale=new D(1,1,1),t._localRotationEuler=new D(0,0,0),t._localMatrix=new q,t._position=new D(0,0,0),t._rotation=new Z(0,0,0,1),t._scale=new D(1,1,1),t._rotationEuler=new D(0,0,0),t._worldMatrix=new q,t._children=null,t._parent=null,t._dummy=null,t._transformFlag=0,t._owner=e,t._children=[],t._setTransformFlag(I.TRANSFORM_LOCALQUATERNION|I.TRANSFORM_LOCALEULER|I.TRANSFORM_LOCALMATRIX,!1),t._setTransformFlag(I.TRANSFORM_WORLDPOSITION|I.TRANSFORM_WORLDQUATERNION|I.TRANSFORM_WORLDEULER|I.TRANSFORM_WORLDSCALE|I.TRANSFORM_WORLDMATRIX,!0),t}return _inherits(I,t.EventDispatcher),_createClass(I,[{key:"_getScaleMatrix",value:function(){var e=I._tempQuaternion0,t=I._tempMatrix3x30,n=I._tempMatrix3x31,i=I._tempMatrix3x32;return b.createFromMatrix4x4(this.worldMatrix,n),this.rotation.invert(e),b.createRotationQuaternion(e,t),b.multiply(t,n,i),i}},{key:"_setTransformFlag",value:function(e,t){t?this._transformFlag|=e:this._transformFlag&=~e}},{key:"_getTransformFlag",value:function(e){return 0!=(this._transformFlag&e)}},{key:"_setParent",value:function(e){if(this._parent!==e){if(this._parent){var t=this._parent._children,n=t.indexOf(this);t.splice(n,1)}e&&(e._children.push(this),e&&this._onWorldTransform()),this._parent=e}}},{key:"_onWorldPositionRotationTransform",value:function(){if(!(this._getTransformFlag(I.TRANSFORM_WORLDMATRIX)&&this._getTransformFlag(I.TRANSFORM_WORLDPOSITION)&&this._getTransformFlag(I.TRANSFORM_WORLDQUATERNION)&&this._getTransformFlag(I.TRANSFORM_WORLDEULER))){this._setTransformFlag(I.TRANSFORM_WORLDMATRIX|I.TRANSFORM_WORLDPOSITION|I.TRANSFORM_WORLDQUATERNION|I.TRANSFORM_WORLDEULER,!0),this.event(t.Event.TRANSFORM_CHANGED,this._transformFlag);for(var e=0,n=this._children.length;e<n;e++)this._children[e]._onWorldPositionRotationTransform()}}},{key:"_onWorldPositionScaleTransform",value:function(){if(!this._getTransformFlag(I.TRANSFORM_WORLDMATRIX)||!this._getTransformFlag(I.TRANSFORM_WORLDPOSITION)||!this._getTransformFlag(I.TRANSFORM_WORLDSCALE)){this._setTransformFlag(I.TRANSFORM_WORLDMATRIX|I.TRANSFORM_WORLDPOSITION|I.TRANSFORM_WORLDSCALE,!0),this.event(t.Event.TRANSFORM_CHANGED,this._transformFlag);for(var e=0,n=this._children.length;e<n;e++)this._children[e]._onWorldPositionScaleTransform()}}},{key:"_onWorldPositionTransform",value:function(){if(!this._getTransformFlag(I.TRANSFORM_WORLDMATRIX)||!this._getTransformFlag(I.TRANSFORM_WORLDPOSITION)){this._setTransformFlag(I.TRANSFORM_WORLDMATRIX|I.TRANSFORM_WORLDPOSITION,!0),this.event(t.Event.TRANSFORM_CHANGED,this._transformFlag);for(var e=0,n=this._children.length;e<n;e++)this._children[e]._onWorldPositionTransform()}}},{key:"_onWorldRotationTransform",value:function(){if(!this._getTransformFlag(I.TRANSFORM_WORLDMATRIX)||!this._getTransformFlag(I.TRANSFORM_WORLDQUATERNION)||!this._getTransformFlag(I.TRANSFORM_WORLDEULER)){this._setTransformFlag(I.TRANSFORM_WORLDMATRIX|I.TRANSFORM_WORLDQUATERNION|I.TRANSFORM_WORLDEULER,!0),this.event(t.Event.TRANSFORM_CHANGED,this._transformFlag);for(var e=0,n=this._children.length;e<n;e++)this._children[e]._onWorldPositionRotationTransform()}}},{key:"_onWorldScaleTransform",value:function(){if(!this._getTransformFlag(I.TRANSFORM_WORLDMATRIX)||!this._getTransformFlag(I.TRANSFORM_WORLDSCALE)){this._setTransformFlag(I.TRANSFORM_WORLDMATRIX|I.TRANSFORM_WORLDSCALE,!0),this.event(t.Event.TRANSFORM_CHANGED,this._transformFlag);for(var e=0,n=this._children.length;e<n;e++)this._children[e]._onWorldPositionScaleTransform()}}},{key:"_onWorldTransform",value:function(){if(!(this._getTransformFlag(I.TRANSFORM_WORLDMATRIX)&&this._getTransformFlag(I.TRANSFORM_WORLDPOSITION)&&this._getTransformFlag(I.TRANSFORM_WORLDQUATERNION)&&this._getTransformFlag(I.TRANSFORM_WORLDEULER)&&this._getTransformFlag(I.TRANSFORM_WORLDSCALE))){this._setTransformFlag(I.TRANSFORM_WORLDMATRIX|I.TRANSFORM_WORLDPOSITION|I.TRANSFORM_WORLDQUATERNION|I.TRANSFORM_WORLDEULER|I.TRANSFORM_WORLDSCALE,!0),this.event(t.Event.TRANSFORM_CHANGED,this._transformFlag);for(var e=0,n=this._children.length;e<n;e++)this._children[e]._onWorldTransform()}}},{key:"translate",value:function(e){!(arguments.length>1&&void 0!==arguments[1])||arguments[1]?(q.createFromQuaternion(this.localRotation,I._tempMatrix0),D.transformCoordinate(e,I._tempMatrix0,I._tempVector30),D.add(this.localPosition,I._tempVector30,this._localPosition),this.localPosition=this._localPosition):(D.add(this.position,e,this._position),this.position=this._position)}},{key:"rotate",value:function(e){var t,n=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];!(arguments.length>2&&void 0!==arguments[2])||arguments[2]?t=e:(D.scale(e,Math.PI/180,I._tempVector30),t=I._tempVector30),Z.createFromYawPitchRoll(t.y,t.x,t.z,I._tempQuaternion0),n?(Z.multiply(this._localRotation,I._tempQuaternion0,this._localRotation),this.localRotation=this._localRotation):(Z.multiply(I._tempQuaternion0,this.rotation,this._rotation),this.rotation=this._rotation)}},{key:"getForward",value:function(e){var t=this.worldMatrix.elements;e.x=-t[8],e.y=-t[9],e.z=-t[10]}},{key:"getUp",value:function(e){var t=this.worldMatrix.elements;e.x=t[4],e.y=t[5],e.z=t[6]}},{key:"getRight",value:function(e){var t=this.worldMatrix.elements;e.x=t[0],e.y=t[1],e.z=t[2]}},{key:"lookAt",value:function(e,t){var n;if(arguments.length>2&&void 0!==arguments[2]&&arguments[2]){if(n=this._localPosition,Math.abs(n.x-e.x)<i.zeroTolerance&&Math.abs(n.y-e.y)<i.zeroTolerance&&Math.abs(n.z-e.z)<i.zeroTolerance)return;Z.lookAt(this._localPosition,e,t,this._localRotation),this._localRotation.invert(this._localRotation),this.localRotation=this._localRotation}else{var r=this.position;if(n=r,Math.abs(n.x-e.x)<i.zeroTolerance&&Math.abs(n.y-e.y)<i.zeroTolerance&&Math.abs(n.z-e.z)<i.zeroTolerance)return;Z.lookAt(r,e,t,this._rotation),this._rotation.invert(this._rotation),this.rotation=this._rotation}}},{key:"getWorldLossyScale",value:function(){if(this._getTransformFlag(I.TRANSFORM_WORLDSCALE)){if(null!==this._parent){var e=this._getScaleMatrix().elements;this._scale.x=e[0],this._scale.y=e[4],this._scale.z=e[8]}else this._localScale.cloneTo(this._scale);this._setTransformFlag(I.TRANSFORM_WORLDSCALE,!1)}return this._scale}},{key:"setWorldLossyScale",value:function(e){if(null!==this._parent){var t=I._tempMatrix3x33,n=I._tempMatrix3x33,i=n.elements,r=this._parent._getScaleMatrix();r.invert(r),b.createFromScaling(e,t),b.multiply(r,t,n),this._localScale.x=i[0],this._localScale.y=i[4],this._localScale.z=i[8]}else e.cloneTo(this._localScale);this.localScale=this._localScale,this._scale!==e&&e.cloneTo(this._scale),this._setTransformFlag(I.TRANSFORM_WORLDSCALE,!1)}},{key:"_isFrontFaceInvert",get:function(){var e=this.getWorldLossyScale(),t=e.x<0;return e.y<0&&(t=!t),e.z<0&&(t=!t),t}},{key:"owner",get:function(){return this._owner}},{key:"worldNeedUpdate",get:function(){return this._getTransformFlag(I.TRANSFORM_WORLDMATRIX)}},{key:"localPositionX",get:function(){return this._localPosition.x},set:function(e){this._localPosition.x=e,this.localPosition=this._localPosition}},{key:"localPositionY",get:function(){return this._localPosition.y},set:function(e){this._localPosition.y=e,this.localPosition=this._localPosition}},{key:"localPositionZ",get:function(){return this._localPosition.z},set:function(e){this._localPosition.z=e,this.localPosition=this._localPosition}},{key:"localPosition",get:function(){return this._localPosition},set:function(e){this._localPosition!==e&&e.cloneTo(this._localPosition),this._setTransformFlag(I.TRANSFORM_LOCALMATRIX,!0),this._onWorldPositionTransform()}},{key:"localRotationX",get:function(){return this.localRotation.x},set:function(e){this._localRotation.x=e,this.localRotation=this._localRotation}},{key:"localRotationY",get:function(){return this.localRotation.y},set:function(e){this._localRotation.y=e,this.localRotation=this._localRotation}},{key:"localRotationZ",get:function(){return this.localRotation.z},set:function(e){this._localRotation.z=e,this.localRotation=this._localRotation}},{key:"localRotationW",get:function(){return this.localRotation.w},set:function(e){this._localRotation.w=e,this.localRotation=this._localRotation}},{key:"localRotation",get:function(){if(this._getTransformFlag(I.TRANSFORM_LOCALQUATERNION)){var e=this._localRotationEuler;Z.createFromYawPitchRoll(e.y/I._angleToRandin,e.x/I._angleToRandin,e.z/I._angleToRandin,this._localRotation),this._setTransformFlag(I.TRANSFORM_LOCALQUATERNION,!1)}return this._localRotation},set:function(e){this._localRotation!==e&&e.cloneTo(this._localRotation),this._localRotation.normalize(this._localRotation),this._setTransformFlag(I.TRANSFORM_LOCALEULER|I.TRANSFORM_LOCALMATRIX,!0),this._setTransformFlag(I.TRANSFORM_LOCALQUATERNION,!1),this._onWorldRotationTransform()}},{key:"localScaleX",get:function(){return this._localScale.x},set:function(e){this._localScale.x=e,this.localScale=this._localScale}},{key:"localScaleY",get:function(){return this._localScale.y},set:function(e){this._localScale.y=e,this.localScale=this._localScale}},{key:"localScaleZ",get:function(){return this._localScale.z},set:function(e){this._localScale.z=e,this.localScale=this._localScale}},{key:"localScale",get:function(){return this._localScale},set:function(e){this._localScale!==e&&e.cloneTo(this._localScale),this._setTransformFlag(I.TRANSFORM_LOCALMATRIX,!0),this._onWorldScaleTransform()}},{key:"localRotationEulerX",get:function(){return this.localRotationEuler.x},set:function(e){this._localRotationEuler.x=e,this.localRotationEuler=this._localRotationEuler}},{key:"localRotationEulerY",get:function(){return this.localRotationEuler.y},set:function(e){this._localRotationEuler.y=e,this.localRotationEuler=this._localRotationEuler}},{key:"localRotationEulerZ",get:function(){return this.localRotationEuler.z},set:function(e){this._localRotationEuler.z=e,this.localRotationEuler=this._localRotationEuler}},{key:"localRotationEuler",get:function(){if(this._getTransformFlag(I.TRANSFORM_LOCALEULER)){this._localRotation.getYawPitchRoll(I._tempVector30);var e=I._tempVector30,t=this._localRotationEuler;t.x=e.y*I._angleToRandin,t.y=e.x*I._angleToRandin,t.z=e.z*I._angleToRandin,this._setTransformFlag(I.TRANSFORM_LOCALEULER,!1)}return this._localRotationEuler},set:function(e){this._localRotationEuler!==e&&e.cloneTo(this._localRotationEuler),this._setTransformFlag(I.TRANSFORM_LOCALEULER,!1),this._setTransformFlag(I.TRANSFORM_LOCALQUATERNION|I.TRANSFORM_LOCALMATRIX,!0),this._onWorldRotationTransform()}},{key:"localMatrix",get:function(){return this._getTransformFlag(I.TRANSFORM_LOCALMATRIX)&&(q.createAffineTransformation(this._localPosition,this.localRotation,this._localScale,this._localMatrix),this._setTransformFlag(I.TRANSFORM_LOCALMATRIX,!1)),this._localMatrix},set:function(e){this._localMatrix!==e&&e.cloneTo(this._localMatrix),this._localMatrix.decomposeTransRotScale(this._localPosition,this._localRotation,this._localScale),this._setTransformFlag(I.TRANSFORM_LOCALEULER,!0),this._setTransformFlag(I.TRANSFORM_LOCALMATRIX,!1),this._onWorldTransform()}},{key:"position",get:function(){if(this._getTransformFlag(I.TRANSFORM_WORLDPOSITION)){if(null!=this._parent){var e=this.worldMatrix.elements;this._position.x=e[12],this._position.y=e[13],this._position.z=e[14]}else this._localPosition.cloneTo(this._position);this._setTransformFlag(I.TRANSFORM_WORLDPOSITION,!1)}return this._position},set:function(e){if(null!=this._parent){var t=I._tempMatrix0;this._parent.worldMatrix.invert(t),D.transformCoordinate(e,t,this._localPosition)}else e.cloneTo(this._localPosition);this.localPosition=this._localPosition,this._position!==e&&e.cloneTo(this._position),this._setTransformFlag(I.TRANSFORM_WORLDPOSITION,!1)}},{key:"rotation",get:function(){return this._getTransformFlag(I.TRANSFORM_WORLDQUATERNION)&&(null!=this._parent?Z.multiply(this._parent.rotation,this.localRotation,this._rotation):this.localRotation.cloneTo(this._rotation),this._setTransformFlag(I.TRANSFORM_WORLDQUATERNION,!1)),this._rotation},set:function(e){null!=this._parent?(this._parent.rotation.invert(I._tempQuaternion0),Z.multiply(I._tempQuaternion0,e,this._localRotation)):e.cloneTo(this._localRotation),this.localRotation=this._localRotation,e!==this._rotation&&e.cloneTo(this._rotation),this._setTransformFlag(I.TRANSFORM_WORLDQUATERNION,!1)}},{key:"rotationEuler",get:function(){if(this._getTransformFlag(I.TRANSFORM_WORLDEULER)){this.rotation.getYawPitchRoll(I._tempVector30);var e=I._tempVector30,t=this._rotationEuler;t.x=e.y*I._angleToRandin,t.y=e.x*I._angleToRandin,t.z=e.z*I._angleToRandin,this._setTransformFlag(I.TRANSFORM_WORLDEULER,!1)}return this._rotationEuler},set:function(e){Z.createFromYawPitchRoll(e.y/I._angleToRandin,e.x/I._angleToRandin,e.z/I._angleToRandin,this._rotation),this.rotation=this._rotation,this._rotationEuler!==e&&e.cloneTo(this._rotationEuler),this._setTransformFlag(I.TRANSFORM_WORLDEULER,!1)}},{key:"worldMatrix",get:function(){return this._getTransformFlag(I.TRANSFORM_WORLDMATRIX)&&(null!=this._parent?q.multiply(this._parent.worldMatrix,this.localMatrix,this._worldMatrix):this.localMatrix.cloneTo(this._worldMatrix),this._setTransformFlag(I.TRANSFORM_WORLDMATRIX,!1)),this._worldMatrix},set:function(e){null===this._parent?e.cloneTo(this._localMatrix):(this._parent.worldMatrix.invert(this._localMatrix),q.multiply(this._localMatrix,e,this._localMatrix)),this.localMatrix=this._localMatrix,this._worldMatrix!==e&&e.cloneTo(this._worldMatrix),this._setTransformFlag(I.TRANSFORM_WORLDMATRIX,!1)}},{key:"scale",get:function(){return console.warn("Transfrm3D: discard function,please use getWorldLossyScale instead."),this.getWorldLossyScale()},set:function(e){console.warn("Transfrm3D: discard function,please use setWorldLossyScale instead."),this.setWorldLossyScale(e)}}]),I}();oe._tempVector30=new D,oe._tempQuaternion0=new Z,oe._tempMatrix0=new q,oe._tempMatrix3x30=new b,oe._tempMatrix3x31=new b,oe._tempMatrix3x32=new b,oe._tempMatrix3x33=new b,oe.TRANSFORM_LOCALQUATERNION=1,oe.TRANSFORM_LOCALEULER=2,oe.TRANSFORM_LOCALMATRIX=4,oe.TRANSFORM_WORLDPOSITION=8,oe.TRANSFORM_WORLDQUATERNION=16,oe.TRANSFORM_WORLDSCALE=32,oe.TRANSFORM_WORLDMATRIX=64,oe.TRANSFORM_WORLDEULER=128,oe._angleToRandin=180/Math.PI;var ce=function(){function D(){_classCallCheck(this,D)}return _createClass(D,null,[{key:"setColliderCollision",value:function(e,t,n){}},{key:"getIColliderCollision",value:function(e,t){return!1}}]),D}();ce.COLLISIONFILTERGROUP_DEFAULTFILTER=1,ce.COLLISIONFILTERGROUP_STATICFILTER=2,ce.COLLISIONFILTERGROUP_KINEMATICFILTER=4,ce.COLLISIONFILTERGROUP_DEBRISFILTER=8,ce.COLLISIONFILTERGROUP_SENSORTRIGGER=16,ce.COLLISIONFILTERGROUP_CHARACTERFILTER=32,ce.COLLISIONFILTERGROUP_CUSTOMFILTER1=64,ce.COLLISIONFILTERGROUP_CUSTOMFILTER2=128,ce.COLLISIONFILTERGROUP_CUSTOMFILTER3=256,ce.COLLISIONFILTERGROUP_CUSTOMFILTER4=512,ce.COLLISIONFILTERGROUP_CUSTOMFILTER5=1024,ce.COLLISIONFILTERGROUP_CUSTOMFILTER6=2048,ce.COLLISIONFILTERGROUP_CUSTOMFILTER7=4096,ce.COLLISIONFILTERGROUP_CUSTOMFILTER8=8192,ce.COLLISIONFILTERGROUP_CUSTOMFILTER9=16384,ce.COLLISIONFILTERGROUP_CUSTOMFILTER10=32768,ce.COLLISIONFILTERGROUP_ALLFILTER=-1,ce.gravity=new D(0,-9.81,0);var he=function(e){function C(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1;_classCallCheck(this,C),(e=_possibleConstructorReturn(this,_getPrototypeOf(C).call(this)))._sizeX=t,e._sizeY=n,e._sizeZ=i,e._type=Q.SHAPETYPES_BOX;var r=F.Physics3D._bullet;return r.btVector3_setValue(C._btSize,t/2,n/2,i/2),e._btShape=r.btBoxShape_create(C._btSize),e}return _inherits(C,Q),_createClass(C,[{key:"clone",value:function(){var e=new C(this._sizeX,this._sizeY,this._sizeZ);return this.cloneTo(e),e}},{key:"sizeX",get:function(){return this._sizeX}},{key:"sizeY",get:function(){return this._sizeY}},{key:"sizeZ",get:function(){return this._sizeZ}}],[{key:"__init__",value:function(){C._btSize=F.Physics3D._bullet.btVector3_create(0,0,0)}}]),C}(),Te=function(e){function M(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:.5,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1.25,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Q.SHAPEORIENTATION_UPY;_classCallCheck(this,M),(e=_possibleConstructorReturn(this,_getPrototypeOf(M).call(this)))._radius=t,e._length=n,e._orientation=i,e._type=Q.SHAPETYPES_CAPSULE;var r=F.Physics3D._bullet;switch(i){case Q.SHAPEORIENTATION_UPX:e._btShape=r.btCapsuleShapeX_create(t,n-2*t);break;case Q.SHAPEORIENTATION_UPY:e._btShape=r.btCapsuleShape_create(t,n-2*t);break;case Q.SHAPEORIENTATION_UPZ:e._btShape=r.btCapsuleShapeZ_create(t,n-2*t);break;default:throw"CapsuleColliderShape:unknown orientation."}return e}return _inherits(M,Q),_createClass(M,[{key:"_setScale",value:function(e){var t=M._tempVector30;switch(this.orientation){case Q.SHAPEORIENTATION_UPX:t.x=e.x,t.y=t.z=Math.max(e.y,e.z);break;case Q.SHAPEORIENTATION_UPY:t.y=e.y,t.x=t.z=Math.max(e.x,e.z);break;case Q.SHAPEORIENTATION_UPZ:t.z=e.z,t.x=t.y=Math.max(e.x,e.y);break;default:throw"CapsuleColliderShape:unknown orientation."}_get(_getPrototypeOf(M.prototype),"_setScale",this).call(this,t)}},{key:"clone",value:function(){var e=new M(this._radius,this._length,this._orientation);return this.cloneTo(e),e}},{key:"radius",get:function(){return this._radius}},{key:"length",get:function(){return this._length}},{key:"orientation",get:function(){return this._orientation}}]),M}();Te._tempVector30=new D;var Se=function(e){function y(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:.5,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Q.SHAPEORIENTATION_UPY;_classCallCheck(this,y),(e=_possibleConstructorReturn(this,_getPrototypeOf(y).call(this)))._radius=1,e._height=.5,e._radius=t,e._height=n,e._orientation=i,e._type=Q.SHAPETYPES_CYLINDER;var r=F.Physics3D._bullet;switch(i){case Q.SHAPEORIENTATION_UPX:e._btShape=r.btConeShapeX_create(t,n);break;case Q.SHAPEORIENTATION_UPY:e._btShape=r.btConeShape_create(t,n);break;case Q.SHAPEORIENTATION_UPZ:e._btShape=r.btConeShapeZ_create(t,n);break;default:throw"ConeColliderShape:unknown orientation."}return e}return _inherits(y,Q),_createClass(y,[{key:"clone",value:function(){var e=new y(this._radius,this._height,this._orientation);return this.cloneTo(e),e}},{key:"radius",get:function(){return this._radius}},{key:"height",get:function(){return this._height}},{key:"orientation",get:function(){return this._orientation}}]),y}(),Oe=function(e){function L(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:.5,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Q.SHAPEORIENTATION_UPY;_classCallCheck(this,L),(e=_possibleConstructorReturn(this,_getPrototypeOf(L).call(this)))._radius=1,e._height=.5,e._radius=t,e._height=n,e._orientation=i,e._type=Q.SHAPETYPES_CYLINDER;var r=F.Physics3D._bullet;switch(i){case Q.SHAPEORIENTATION_UPX:r.btVector3_setValue(L._btSize,n/2,t,t),e._btShape=r.btCylinderShapeX_create(L._btSize);break;case Q.SHAPEORIENTATION_UPY:r.btVector3_setValue(L._btSize,t,n/2,t),e._btShape=r.btCylinderShape_create(L._btSize);break;case Q.SHAPEORIENTATION_UPZ:r.btVector3_setValue(L._btSize,t,t,n/2),e._btShape=r.btCylinderShapeZ_create(L._btSize);break;default:throw"CapsuleColliderShape:unknown orientation."}return e}return _inherits(L,Q),_createClass(L,[{key:"clone",value:function(){var e=new L(this._radius,this._height,this._orientation);return this.cloneTo(e),e}},{key:"radius",get:function(){return this._radius}},{key:"height",get:function(){return this._height}},{key:"orientation",get:function(){return this._orientation}}],[{key:"__init__",value:function(){L._btSize=F.Physics3D._bullet.btVector3_create(0,0,0)}}]),L}(),be=function(e){function O(){var e;return _classCallCheck(this,O),(e=_possibleConstructorReturn(this,_getPrototypeOf(O).call(this)))._mesh=null,e._convex=!1,e}return _inherits(O,Q),_createClass(O,[{key:"_setScale",value:function(e){if(this._compoundParent)this.updateLocalTransformations();else{var t=F.Physics3D._bullet;t.btVector3_setValue(Q._btScale,e.x,e.y,e.z),t.btCollisionShape_setLocalScaling(this._btShape,Q._btScale),t.btGImpactShapeInterface_updateBound(this._btShape)}}},{key:"cloneTo",value:function(e){var t=e;t.convex=this._convex,t.mesh=this._mesh,_get(_getPrototypeOf(O.prototype),"cloneTo",this).call(this,e)}},{key:"clone",value:function(){var e=new O;return this.cloneTo(e),e}},{key:"destroy",value:function(){this._btShape&&(F.Physics3D._bullet.btCollisionShape_destroy(this._btShape),this._btShape=null)}},{key:"mesh",get:function(){return this._mesh},set:function(e){if(this._mesh!==e){var t=F.Physics3D._bullet;this._mesh&&t.btCollisionShape_destroy(this._btShape),e&&(this._btShape=t.btGImpactMeshShape_create(e._getPhysicMesh()),t.btGImpactShapeInterface_updateBound(this._btShape)),this._mesh=e}}},{key:"convex",get:function(){return this._convex},set:function(e){this._convex=e}}]),O}(),we=function(e){function N(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:.5;return _classCallCheck(this,N),(e=_possibleConstructorReturn(this,_getPrototypeOf(N).call(this)))._radius=t,e._type=Q.SHAPETYPES_SPHERE,e._btShape=F.Physics3D._bullet.btSphereShape_create(t),e}return _inherits(N,Q),_createClass(N,[{key:"clone",value:function(){var e=new N(this._radius);return this.cloneTo(e),e}},{key:"radius",get:function(){return this._radius}}]),N}(),ze=function(e){function P(e,t){var n;return _classCallCheck(this,P),(n=_possibleConstructorReturn(this,_getPrototypeOf(P).call(this)))._restitution=0,n._friction=.5,n._rollingFriction=0,n._ccdMotionThreshold=0,n._ccdSweptSphereRadius=0,n._collisionGroup=ce.COLLISIONFILTERGROUP_DEFAULTFILTER,n._canCollideWith=ce.COLLISIONFILTERGROUP_ALLFILTER,n._colliderShape=null,n._transformFlag=2147483647,n._controlBySimulation=!1,n._enableProcessCollisions=!0,n._inPhysicUpdateListIndex=-1,n.canScaleShape=!0,n._collisionGroup=e,n._canCollideWith=t,P._physicObjectsMap[n.id]=_assertThisInitialized(n),n}return _inherits(P,t.Component),_createClass(P,[{key:"_parseShape",value:function(e){var t=e.length;if(1===t){var n=P._creatShape(e[0]);this.colliderShape=n}else{for(var i=new ie,r=0;r<t;r++)n=P._creatShape(e[r]),i.addChildShape(n);this.colliderShape=i}}},{key:"_onScaleChange",value:function(e){this._colliderShape._setScale(e)}},{key:"_onEnable",value:function(){this._simulation=this.owner._scene.physicsSimulation,F.Physics3D._bullet.btCollisionObject_setContactProcessingThreshold(this._btColliderObject,0),this._colliderShape&&(this._derivePhysicsTransformation(!0),this._addToSimulation())}},{key:"_onDisable",value:function(){this._colliderShape&&(this._removeFromSimulation(),-1!==this._inPhysicUpdateListIndex&&this._simulation._physicsUpdateList.remove(this)),this._simulation=null}},{key:"_onDestroy",value:function(){delete P._physicObjectsMap[this.id],F.Physics3D._bullet.btCollisionObject_destroy(this._btColliderObject),this._colliderShape.destroy(),_get(_getPrototypeOf(P.prototype),"_onDestroy",this).call(this),this._btColliderObject=null,this._colliderShape=null,this._simulation=null,this.owner.transform.off(t.Event.TRANSFORM_CHANGED,this,this._onTransformChanged)}},{key:"_isValid",value:function(){return this._simulation&&this._colliderShape&&this._enabled}},{key:"_parse",value:function(e){null!=e.collisionGroup&&(this.collisionGroup=e.collisionGroup),null!=e.canCollideWith&&(this.canCollideWith=e.canCollideWith),null!=e.ccdMotionThreshold&&(this.ccdMotionThreshold=e.ccdMotionThreshold),null!=e.ccdSweptSphereRadius&&(this.ccdSweptSphereRadius=e.ccdSweptSphereRadius)}},{key:"_setTransformFlag",value:function(e,t){t?this._transformFlag|=e:this._transformFlag&=~e}},{key:"_getTransformFlag",value:function(e){return 0!=(this._transformFlag&e)}},{key:"_addToSimulation",value:function(){}},{key:"_removeFromSimulation",value:function(){}},{key:"_derivePhysicsTransformation",value:function(e){var t=F.Physics3D._bullet,n=this._btColliderObject,i=t.btCollisionObject_getWorldTransform(n);this._innerDerivePhysicsTransformation(i,e),t.btCollisionObject_setWorldTransform(n,i)}},{key:"_innerDerivePhysicsTransformation",value:function(e,t){var n=F.Physics3D._bullet,i=this.owner._transform;if(t||this._getTransformFlag(oe.TRANSFORM_WORLDPOSITION)){var r=this._colliderShape.localOffset,a=i.position,o=P._btVector30;if(0!==r.x||0!==r.y||0!==r.z){var s=P._tempVector30,l=i.worldMatrix;D.transformCoordinate(r,l,s),n.btVector3_setValue(o,-s.x,s.y,s.z)}else n.btVector3_setValue(o,-a.x,a.y,a.z);n.btTransform_setOrigin(e,o),this._setTransformFlag(oe.TRANSFORM_WORLDPOSITION,!1)}if(t||this._getTransformFlag(oe.TRANSFORM_WORLDQUATERNION)){var u=this._colliderShape.localRotation,_=P._btQuaternion0,c=i.rotation;if(0!==u.x||0!==u.y||0!==u.z||1!==u.w){var h=P._tempQuaternion0;P.physicQuaternionMultiply(c.x,c.y,c.z,c.w,u,h),n.btQuaternion_setValue(_,-h.x,h.y,h.z,-h.w)}else n.btQuaternion_setValue(_,-c.x,c.y,c.z,-c.w);n.btTransform_setRotation(e,_),this._setTransformFlag(oe.TRANSFORM_WORLDQUATERNION,!1)}(t||this._getTransformFlag(oe.TRANSFORM_WORLDSCALE))&&(this._onScaleChange(i.getWorldLossyScale()),this._setTransformFlag(oe.TRANSFORM_WORLDSCALE,!1))}},{key:"_updateTransformComponent",value:function(e){var t=F.Physics3D._bullet,n=this._colliderShape,i=n.localOffset,r=n.localRotation,a=this.owner._transform,o=a.position,s=a.rotation,l=t.btTransform_getOrigin(e),u=t.btTransform_getRotation(e),_=-t.btQuaternion_x(u),c=t.btQuaternion_y(u),h=t.btQuaternion_z(u),d=-t.btQuaternion_w(u);if(0!==r.x||0!==r.y||0!==r.z||1!==r.w){var f=P._tempQuaternion0;r.invert(f),P.physicQuaternionMultiply(_,c,h,d,f,s)}else s.x=_,s.y=c,s.z=h,s.w=d;if(a.rotation=s,0!==i.x||0!==i.y||0!==i.z){var m=t.btCollisionShape_getLocalScaling(n._btShape),p=P._tempVector30;p.x=i.x*t.btVector3_x(m),p.y=i.y*t.btVector3_y(m),p.z=i.z*t.btVector3_z(m),D.transformQuat(p,s,p),o.x=-t.btVector3_x(l)-p.x,o.y=t.btVector3_y(l)-p.y,o.z=t.btVector3_z(l)-p.z}else o.x=-t.btVector3_x(l),o.y=t.btVector3_y(l),o.z=t.btVector3_z(l);a.position=o}},{key:"_onShapeChange",value:function(e){var t=this._btColliderObject,n=F.Physics3D._bullet,i=n.btCollisionObject_getCollisionFlags(t);e.needsCustomCollisionCallback?0==(i&P.COLLISIONFLAGS_CUSTOM_MATERIAL_CALLBACK)&&n.btCollisionObject_setCollisionFlags(t,i|P.COLLISIONFLAGS_CUSTOM_MATERIAL_CALLBACK):(i&P.COLLISIONFLAGS_CUSTOM_MATERIAL_CALLBACK)>0&&n.btCollisionObject_setCollisionFlags(t,i^P.COLLISIONFLAGS_CUSTOM_MATERIAL_CALLBACK)}},{key:"_onAdded",value:function(){this.enabled=this._enabled,this.restitution=this._restitution,this.friction=this._friction,this.rollingFriction=this._rollingFriction,this.ccdMotionThreshold=this._ccdMotionThreshold,this.ccdSweptSphereRadius=this._ccdSweptSphereRadius,this.owner.transform.on(t.Event.TRANSFORM_CHANGED,this,this._onTransformChanged)}},{key:"_onTransformChanged",value:function(e){!P._addUpdateList&&this._controlBySimulation||(e&=oe.TRANSFORM_WORLDPOSITION|oe.TRANSFORM_WORLDQUATERNION|oe.TRANSFORM_WORLDSCALE)&&(this._transformFlag|=e,this._isValid()&&-1===this._inPhysicUpdateListIndex&&this._simulation._physicsUpdateList.add(this))}},{key:"_cloneTo",value:function(e){var t=e;t.restitution=this._restitution,t.friction=this._friction,t.rollingFriction=this._rollingFriction,t.ccdMotionThreshold=this._ccdMotionThreshold,t.ccdSweptSphereRadius=this._ccdSweptSphereRadius,t.collisionGroup=this._collisionGroup,t.canCollideWith=this._canCollideWith,t.canScaleShape=this.canScaleShape,this._colliderShape&&(t.colliderShape=this._colliderShape.clone())}},{key:"restitution",get:function(){return this._restitution},set:function(e){this._restitution=e,this._btColliderObject&&F.Physics3D._bullet.btCollisionObject_setRestitution(this._btColliderObject,e)}},{key:"friction",get:function(){return this._friction},set:function(e){this._friction=e,this._btColliderObject&&F.Physics3D._bullet.btCollisionObject_setFriction(this._btColliderObject,e)}},{key:"rollingFriction",get:function(){return this._rollingFriction},set:function(e){this._rollingFriction=e,this._btColliderObject&&F.Physics3D._bullet.btCollisionObject_setRollingFriction(this._btColliderObject,e)}},{key:"ccdMotionThreshold",get:function(){return this._ccdMotionThreshold},set:function(e){this._ccdMotionThreshold=e,this._btColliderObject&&F.Physics3D._bullet.btCollisionObject_setCcdMotionThreshold(this._btColliderObject,e)}},{key:"ccdSweptSphereRadius",get:function(){return this._ccdSweptSphereRadius},set:function(e){this._ccdSweptSphereRadius=e,this._btColliderObject&&F.Physics3D._bullet.btCollisionObject_setCcdSweptSphereRadius(this._btColliderObject,e)}},{key:"isActive",get:function(){return!!this._btColliderObject&&F.Physics3D._bullet.btCollisionObject_isActive(this._btColliderObject)}},{key:"colliderShape",get:function(){return this._colliderShape},set:function(e){var t=this._colliderShape;if(t&&(t._attatched=!1,t._attatchedCollisionObject=null),this._colliderShape=e,e){if(e._attatched)throw"PhysicsComponent: this shape has attatched to other entity.";if(e._attatched=!0,e._attatchedCollisionObject=this,this._btColliderObject){F.Physics3D._bullet.btCollisionObject_setCollisionShape(this._btColliderObject,e._btShape);var n=this._simulation&&this._enabled;n&&t&&this._removeFromSimulation(),this._onShapeChange(e),n&&(this._derivePhysicsTransformation(!0),this._addToSimulation())}}else this._simulation&&this._enabled&&t&&this._removeFromSimulation()}},{key:"simulation",get:function(){return this._simulation}},{key:"collisionGroup",get:function(){return this._collisionGroup},set:function(e){this._collisionGroup!==e&&(this._collisionGroup=e,this._simulation&&this._colliderShape&&this._enabled&&(this._removeFromSimulation(),this._addToSimulation()))}},{key:"canCollideWith",get:function(){return this._canCollideWith},set:function(e){this._canCollideWith!==e&&(this._canCollideWith=e,this._simulation&&this._colliderShape&&this._enabled&&(this._removeFromSimulation(),this._addToSimulation()))}}],[{key:"__init__",value:function(){var e=F.Physics3D._bullet;P._btVector30=e.btVector3_create(0,0,0),P._btQuaternion0=e.btQuaternion_create(0,0,0,1)}},{key:"_createAffineTransformationArray",value:function(e,t,n,i,r,a,o,s,l){var u=i+i,_=r+r,c=a+a,h=i*u,d=i*_,f=i*c,m=r*_,p=r*c,v=a*c,E=o*u,T=o*_,g=o*c,y=s[0],S=s[1],R=s[2];l[0]=(1-(m+v))*y,l[1]=(d+g)*y,l[2]=(f-T)*y,l[3]=0,l[4]=(d-g)*S,l[5]=(1-(h+v))*S,l[6]=(p+E)*S,l[7]=0,l[8]=(f+T)*R,l[9]=(p-E)*R,l[10]=(1-(h+m))*R,l[11]=0,l[12]=e,l[13]=t,l[14]=n,l[15]=1}},{key:"_creatShape",value:function(e){var n;switch(e.type){case"BoxColliderShape":var i=e.size;n=i?new he(i[0],i[1],i[2]):new he;break;case"SphereColliderShape":n=new we(e.radius);break;case"CapsuleColliderShape":n=new Te(e.radius,e.height,e.orientation);break;case"MeshColliderShape":var r=new be;e.mesh&&(r.mesh=t.Loader.getRes(e.mesh)),n=r;break;case"ConeColliderShape":n=new Se(e.radius,e.height,e.orientation);break;case"CylinderColliderShape":n=new Oe(e.radius,e.height,e.orientation);break;default:throw"unknown shape type."}if(e.center){var a=n.localOffset;a.fromArray(e.center),n.localOffset=a}return n}},{key:"physicVector3TransformQuat",value:function(e,t,n,i,r,a){var o=e.x,s=e.y,l=e.z,u=r*o+n*l-i*s,_=r*s+i*o-t*l,c=r*l+t*s-n*o,h=-t*o-n*s-i*l;a.x=u*r+h*-t+_*-i-c*-n,a.y=_*r+h*-n+c*-t-u*-i,a.z=c*r+h*-i+u*-n-_*-t}},{key:"physicQuaternionMultiply",value:function(e,t,n,i,r,a){var o=r.x,s=r.y,l=r.z,u=r.w,_=t*l-n*s,c=n*o-e*l,h=e*s-t*o,d=e*o+t*s+n*l;a.x=e*u+o*i+_,a.y=t*u+s*i+c,a.z=n*u+l*i+h,a.w=i*u-d}}]),P}();ze.ACTIVATIONSTATE_ACTIVE_TAG=1,ze.ACTIVATIONSTATE_ISLAND_SLEEPING=2,ze.ACTIVATIONSTATE_WANTS_DEACTIVATION=3,ze.ACTIVATIONSTATE_DISABLE_DEACTIVATION=4,ze.ACTIVATIONSTATE_DISABLE_SIMULATION=5,ze.COLLISIONFLAGS_STATIC_OBJECT=1,ze.COLLISIONFLAGS_KINEMATIC_OBJECT=2,ze.COLLISIONFLAGS_NO_CONTACT_RESPONSE=4,ze.COLLISIONFLAGS_CUSTOM_MATERIAL_CALLBACK=8,ze.COLLISIONFLAGS_CHARACTER_OBJECT=16,ze.COLLISIONFLAGS_DISABLE_VISUALIZE_OBJECT=32,ze.COLLISIONFLAGS_DISABLE_SPU_COLLISION_PROCESSING=64,ze._tempVector30=new D,ze._tempQuaternion0=new Z,ze._tempQuaternion1=new Z,ze._tempMatrix4x40=new q,ze._physicObjectsMap={},ze._addUpdateList=!0;var Ye=function(){function b(){_classCallCheck(this,b),this.elements=[],this.length=0}return _createClass(b,[{key:"_add",value:function(e){this.length===this.elements.length?this.elements.push(e):this.elements[this.length]=e}},{key:"add",value:function(e){this.length===this.elements.length?this.elements.push(e):this.elements[this.length]=e,this.length++}}]),b}(),et=function(e){function w(){return _classCallCheck(this,w),_possibleConstructorReturn(this,_getPrototypeOf(w).call(this))}return _inherits(w,Ye),_createClass(w,[{key:"add",value:function(e){if(-1!==e._inPhysicUpdateListIndex)throw"PhysicsUpdateList:element has  in  PhysicsUpdateList.";this._add(e),e._inPhysicUpdateListIndex=this.length++}},{key:"remove",value:function(e){var t=e._inPhysicUpdateListIndex;if(this.length--,t!==this.length){var n=this.elements[this.length];this.elements[t]=n,n._inPhysicUpdateListIndex=t}e._inPhysicUpdateListIndex=-1}}]),w}(),rt=function V(){_classCallCheck(this,V),this._idCounter=0,this.colliderA=null,this.colliderB=null,this.distance=0,this.normal=new D,this.positionOnA=new D,this.positionOnB=new D,this._id=++this._idCounter},ft=function B(){_classCallCheck(this,B),this.succeeded=!1,this.collider=null,this.point=new D,this.normal=new D,this.hitFraction=0},pt=function(){function F(){_classCallCheck(this,F),this._lastUpdateFrame=-2147483648,this._updateFrame=-2147483648,this._isTrigger=!1,this.contacts=[]}return _createClass(F,[{key:"_setUpdateFrame",value:function(e){this._lastUpdateFrame=this._updateFrame,this._updateFrame=e}}]),F}(),vt=function(){function U(){_classCallCheck(this,U),this._hitResultsPoolIndex=0,this._hitResultsPool=[],this._contactPonintsPoolIndex=0,this._contactPointsPool=[],this._collisionsPool=[],this._collisions={}}return _createClass(U,[{key:"getHitResult",value:function(){var e=this._hitResultsPool[this._hitResultsPoolIndex++];return e||(e=new ft,this._hitResultsPool.push(e)),e}},{key:"recoverAllHitResultsPool",value:function(){this._hitResultsPoolIndex=0}},{key:"getContactPoints",value:function(){var e=this._contactPointsPool[this._contactPonintsPoolIndex++];return e||(e=new rt,this._contactPointsPool.push(e)),e}},{key:"recoverAllContactPointsPool",value:function(){this._contactPonintsPoolIndex=0}},{key:"getCollision",value:function(e,t){var n,i=e.id,r=t.id,a=this._collisions[i];return a&&(n=a[r]),n||(a||(a={},this._collisions[i]=a),(n=0===this._collisionsPool.length?new pt:this._collisionsPool.pop())._colliderA=e,n._colliderB=t,a[r]=n),n}},{key:"recoverCollision",value:function(e){var t=e._colliderA.id,n=e._colliderB.id;this._collisions[t][n]=null,this._collisionsPool.push(e)}},{key:"garbageCollection",value:function(){for(var e in this._hitResultsPoolIndex=0,this._hitResultsPool.length=0,this._contactPonintsPoolIndex=0,this._contactPointsPool.length=0,this._collisionsPool.length=0,this._collisionsPool){var t=this._collisionsPool[e],n=!0;for(var i in t)t[i]?n=!1:delete t[i];n&&delete this._collisionsPool[e]}}}]),U}(),Et=function(){function G(e){_classCallCheck(this,G),this._gravity=new D(0,-10,0),this._btVector3Zero=F.Physics3D._bullet.btVector3_create(0,0,0),this._btDefaultQuaternion=F.Physics3D._bullet.btQuaternion_create(0,0,0,-1),this._collisionsUtils=new vt,this._previousFrameCollisions=[],this._currentFrameCollisions=[],this._currentConstraint={},this._physicsUpdateList=new et,this._characters=[],this._updatedRigidbodies=0,this.maxSubSteps=1,this.fixedTimeStep=1/60,this.maxSubSteps=e.maxSubSteps,this.fixedTimeStep=e.fixedTimeStep;var t=F.Physics3D._bullet;this._btCollisionConfiguration=t.btDefaultCollisionConfiguration_create(),this._btDispatcher=t.btCollisionDispatcher_create(this._btCollisionConfiguration),this._btBroadphase=t.btDbvtBroadphase_create(),t.btOverlappingPairCache_setInternalGhostPairCallback(t.btDbvtBroadphase_getOverlappingPairCache(this._btBroadphase),t.btGhostPairCallback_create());var n=e.flags;if(n&G.PHYSICSENGINEFLAGS_COLLISIONSONLY)this._btCollisionWorld=new t.btCollisionWorld(this._btDispatcher,this._btBroadphase,this._btCollisionConfiguration);else{if(n&G.PHYSICSENGINEFLAGS_SOFTBODYSUPPORT)throw"PhysicsSimulation:SoftBody processing is not yet available";var i=t.btSequentialImpulseConstraintSolver_create();this._btDiscreteDynamicsWorld=t.btDiscreteDynamicsWorld_create(this._btDispatcher,this._btBroadphase,i,this._btCollisionConfiguration),this._btCollisionWorld=this._btDiscreteDynamicsWorld}this._btDiscreteDynamicsWorld&&(this._btSolverInfo=t.btDynamicsWorld_getSolverInfo(this._btDiscreteDynamicsWorld),this._btDispatchInfo=t.btCollisionWorld_getDispatchInfo(this._btDiscreteDynamicsWorld)),this._btClosestRayResultCallback=t.ClosestRayResultCallback_create(this._btVector3Zero,this._btVector3Zero),this._btAllHitsRayResultCallback=t.AllHitsRayResultCallback_create(this._btVector3Zero,this._btVector3Zero),this._btClosestConvexResultCallback=t.ClosestConvexResultCallback_create(this._btVector3Zero,this._btVector3Zero),this._btAllConvexResultCallback=t.AllConvexResultCallback_create(this._btVector3Zero,this._btVector3Zero),this.setHitsRayResultCallbackFlag(),t.btGImpactCollisionAlgorithm_RegisterAlgorithm(this._btDispatcher)}return _createClass(G,[{key:"_simulate",value:function(e){this._updatedRigidbodies=0;var t=F.Physics3D._bullet;this._btDiscreteDynamicsWorld?t.btDiscreteDynamicsWorld_stepSimulation(this._btDiscreteDynamicsWorld,e,this.maxSubSteps,this.fixedTimeStep):t.PerformDiscreteCollisionDetection(this._btCollisionWorld)}},{key:"_destroy",value:function(){var e=F.Physics3D._bullet;this._btDiscreteDynamicsWorld?(e.btCollisionWorld_destroy(this._btDiscreteDynamicsWorld),this._btDiscreteDynamicsWorld=null):(e.btCollisionWorld_destroy(this._btCollisionWorld),this._btCollisionWorld=null),e.btDbvtBroadphase_destroy(this._btBroadphase),this._btBroadphase=null,e.btCollisionDispatcher_destroy(this._btDispatcher),this._btDispatcher=null,e.btDefaultCollisionConfiguration_destroy(this._btCollisionConfiguration),this._btCollisionConfiguration=null}},{key:"_addPhysicsCollider",value:function(e,t,n){F.Physics3D._bullet.btCollisionWorld_addCollisionObject(this._btCollisionWorld,e._btColliderObject,t,n)}},{key:"_removePhysicsCollider",value:function(e){F.Physics3D._bullet.btCollisionWorld_removeCollisionObject(this._btCollisionWorld,e._btColliderObject)}},{key:"_addRigidBody",value:function(e,t,n){if(!this._btDiscreteDynamicsWorld)throw"Simulation:Cannot perform this action when the physics engine is set to CollisionsOnly";F.Physics3D._bullet.btDiscreteDynamicsWorld_addRigidBody(this._btCollisionWorld,e._btColliderObject,t,n)}},{key:"_removeRigidBody",value:function(e){if(!this._btDiscreteDynamicsWorld)throw"Simulation:Cannot perform this action when the physics engine is set to CollisionsOnly";F.Physics3D._bullet.btDiscreteDynamicsWorld_removeRigidBody(this._btCollisionWorld,e._btColliderObject)}},{key:"_addCharacter",value:function(e,t,n){if(!this._btDiscreteDynamicsWorld)throw"Simulation:Cannot perform this action when the physics engine is set to CollisionsOnly";var i=F.Physics3D._bullet;i.btCollisionWorld_addCollisionObject(this._btCollisionWorld,e._btColliderObject,t,n),i.btDynamicsWorld_addAction(this._btCollisionWorld,e._btKinematicCharacter)}},{key:"_removeCharacter",value:function(e){if(!this._btDiscreteDynamicsWorld)throw"Simulation:Cannot perform this action when the physics engine is set to CollisionsOnly";var t=F.Physics3D._bullet;t.btCollisionWorld_removeCollisionObject(this._btCollisionWorld,e._btColliderObject),t.btDynamicsWorld_removeAction(this._btCollisionWorld,e._btKinematicCharacter)}},{key:"raycastFromTo",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:ce.COLLISIONFILTERGROUP_ALLFILTER,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:ce.COLLISIONFILTERGROUP_ALLFILTER,a=F.Physics3D._bullet,o=this._btClosestRayResultCallback,s=G._btTempVector30,l=G._btTempVector31;if(a.btVector3_setValue(s,-e.x,e.y,e.z),a.btVector3_setValue(l,-t.x,t.y,t.z),a.ClosestRayResultCallback_set_m_rayFromWorld(o,s),a.ClosestRayResultCallback_set_m_rayToWorld(o,l),a.RayResultCallback_set_m_collisionFilterGroup(o,i),a.RayResultCallback_set_m_collisionFilterMask(o,r),a.RayResultCallback_set_m_collisionObject(o,null),a.RayResultCallback_set_m_closestHitFraction(o,1),a.btCollisionWorld_rayTest(this._btCollisionWorld,s,l,o),a.RayResultCallback_hasHit(o)){if(n){n.succeeded=!0,n.collider=ze._physicObjectsMap[a.btCollisionObject_getUserIndex(a.RayResultCallback_get_m_collisionObject(o))],n.hitFraction=a.RayResultCallback_get_m_closestHitFraction(o);var u=a.ClosestRayResultCallback_get_m_hitPointWorld(o),_=n.point;_.x=-a.btVector3_x(u),_.y=a.btVector3_y(u),_.z=a.btVector3_z(u);var c=a.ClosestRayResultCallback_get_m_hitNormalWorld(o),h=n.normal;h.x=-a.btVector3_x(c),h.y=a.btVector3_y(c),h.z=a.btVector3_z(c)}return!0}return n&&(n.succeeded=!1),!1}},{key:"raycastAllFromTo",value:function(e,t,n){var i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:ce.COLLISIONFILTERGROUP_ALLFILTER,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:ce.COLLISIONFILTERGROUP_ALLFILTER,a=F.Physics3D._bullet,o=this._btAllHitsRayResultCallback,s=G._btTempVector30,l=G._btTempVector31;n.length=0,a.btVector3_setValue(s,-e.x,e.y,e.z),a.btVector3_setValue(l,-t.x,t.y,t.z),a.AllHitsRayResultCallback_set_m_rayFromWorld(o,s),a.AllHitsRayResultCallback_set_m_rayToWorld(o,l),a.RayResultCallback_set_m_collisionFilterGroup(o,i),a.RayResultCallback_set_m_collisionFilterMask(o,r);var u=a.AllHitsRayResultCallback_get_m_collisionObjects(o),_=a.AllHitsRayResultCallback_get_m_hitPointWorld(o),c=a.AllHitsRayResultCallback_get_m_hitNormalWorld(o),h=a.AllHitsRayResultCallback_get_m_hitFractions(o);a.tBtCollisionObjectArray_clear(u),a.tVector3Array_clear(_),a.tVector3Array_clear(c),a.tScalarArray_clear(h),a.btCollisionWorld_rayTest(this._btCollisionWorld,s,l,o);var d=a.tBtCollisionObjectArray_size(u);if(d>0){this._collisionsUtils.recoverAllHitResultsPool();for(var f=0;f<d;f++){var m=this._collisionsUtils.getHitResult();n.push(m),m.succeeded=!0,m.collider=ze._physicObjectsMap[a.btCollisionObject_getUserIndex(a.tBtCollisionObjectArray_at(u,f))],m.hitFraction=a.tScalarArray_at(h,f);var p=a.tVector3Array_at(_,f),v=m.point;v.x=-a.btVector3_x(p),v.y=a.btVector3_y(p),v.z=a.btVector3_z(p);var E=a.tVector3Array_at(c,f),T=m.normal;T.x=-a.btVector3_x(E),T.y=a.btVector3_y(E),T.z=a.btVector3_z(E)}return!0}return!1}},{key:"rayCast",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:2147483647,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:ce.COLLISIONFILTERGROUP_ALLFILTER,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:ce.COLLISIONFILTERGROUP_ALLFILTER,a=e.origin,o=G._tempVector30;return D.normalize(e.direction,o),D.scale(o,n,o),D.add(a,o,o),this.raycastFromTo(a,o,t,i,r)}},{key:"rayCastAll",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:2147483647,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:ce.COLLISIONFILTERGROUP_ALLFILTER,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:ce.COLLISIONFILTERGROUP_ALLFILTER,a=e.origin,o=G._tempVector30;return D.normalize(e.direction,o),D.scale(o,n,o),D.add(a,o,o),this.raycastAllFromTo(a,o,t,i,r)}},{key:"shapeCast",value:function(e,t,n){var i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null,o=arguments.length>6&&void 0!==arguments[6]?arguments[6]:ce.COLLISIONFILTERGROUP_ALLFILTER,s=arguments.length>7&&void 0!==arguments[7]?arguments[7]:ce.COLLISIONFILTERGROUP_ALLFILTER,l=arguments.length>8&&void 0!==arguments[8]?arguments[8]:0,u=F.Physics3D._bullet,_=this._btClosestConvexResultCallback,c=G._btTempVector30,h=G._btTempVector31,d=G._btTempQuaternion0,f=G._btTempQuaternion1,m=G._btTempTransform0,p=G._btTempTransform1,v=e._btShape;if(u.btVector3_setValue(c,-t.x,t.y,t.z),u.btVector3_setValue(h,-n.x,n.y,n.z),u.ConvexResultCallback_set_m_collisionFilterGroup(_,o),u.ConvexResultCallback_set_m_collisionFilterMask(_,s),u.btTransform_setOrigin(m,c),u.btTransform_setOrigin(p,h),r?(u.btQuaternion_setValue(d,-r.x,r.y,r.z,-r.w),u.btTransform_setRotation(m,d)):u.btTransform_setRotation(m,this._btDefaultQuaternion),a?(u.btQuaternion_setValue(f,-a.x,a.y,a.z,-a.w),u.btTransform_setRotation(p,f)):u.btTransform_setRotation(p,this._btDefaultQuaternion),u.ClosestConvexResultCallback_set_m_hitCollisionObject(_,null),u.ConvexResultCallback_set_m_closestHitFraction(_,1),u.btCollisionWorld_convexSweepTest(this._btCollisionWorld,v,m,p,_,l),u.ConvexResultCallback_hasHit(_)){if(i){i.succeeded=!0,i.collider=ze._physicObjectsMap[u.btCollisionObject_getUserIndex(u.ClosestConvexResultCallback_get_m_hitCollisionObject(_))],i.hitFraction=u.ConvexResultCallback_get_m_closestHitFraction(_);var E=u.ClosestConvexResultCallback_get_m_hitPointWorld(_),T=u.ClosestConvexResultCallback_get_m_hitNormalWorld(_),g=i.point,y=i.normal;g.x=-u.btVector3_x(E),g.y=u.btVector3_y(E),g.z=u.btVector3_z(E),y.x=-u.btVector3_x(T),y.y=u.btVector3_y(T),y.z=u.btVector3_z(T)}return!0}return i&&(i.succeeded=!1),!1}},{key:"shapeCastAll",value:function(e,t,n,i){var r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null,o=arguments.length>6&&void 0!==arguments[6]?arguments[6]:ce.COLLISIONFILTERGROUP_ALLFILTER,s=arguments.length>7&&void 0!==arguments[7]?arguments[7]:ce.COLLISIONFILTERGROUP_ALLFILTER,l=arguments.length>8&&void 0!==arguments[8]?arguments[8]:0,u=F.Physics3D._bullet,_=this._btAllConvexResultCallback,c=G._btTempVector30,h=G._btTempVector31,d=G._btTempQuaternion0,f=G._btTempQuaternion1,m=G._btTempTransform0,p=G._btTempTransform1,v=e._btShape;i.length=0,u.btVector3_setValue(c,-t.x,t.y,t.z),u.btVector3_setValue(h,-n.x,n.y,n.z),u.ConvexResultCallback_set_m_collisionFilterGroup(_,o),u.ConvexResultCallback_set_m_collisionFilterMask(_,s),u.btTransform_setOrigin(m,c),u.btTransform_setOrigin(p,h),r?(u.btQuaternion_setValue(d,-r.x,r.y,r.z,-r.w),u.btTransform_setRotation(m,d)):u.btTransform_setRotation(m,this._btDefaultQuaternion),a?(u.btQuaternion_setValue(f,-a.x,a.y,a.z,-a.w),u.btTransform_setRotation(p,f)):u.btTransform_setRotation(p,this._btDefaultQuaternion);var E=u.AllConvexResultCallback_get_m_collisionObjects(_),T=u.AllConvexResultCallback_get_m_hitPointWorld(_),g=u.AllConvexResultCallback_get_m_hitNormalWorld(_),y=u.AllConvexResultCallback_get_m_hitFractions(_);u.tVector3Array_clear(T),u.tVector3Array_clear(g),u.tScalarArray_clear(y),u.tBtCollisionObjectArray_clear(E),u.btCollisionWorld_convexSweepTest(this._btCollisionWorld,v,m,p,_,l);var S=u.tBtCollisionObjectArray_size(E);if(S>0){this._collisionsUtils.recoverAllHitResultsPool();for(var R=0;R<S;R++){var C=this._collisionsUtils.getHitResult();i.push(C),C.succeeded=!0,C.collider=ze._physicObjectsMap[u.btCollisionObject_getUserIndex(u.tBtCollisionObjectArray_at(E,R))],C.hitFraction=u.tScalarArray_at(y,R);var A=u.tVector3Array_at(T,R),I=C.point;I.x=-u.btVector3_x(A),I.y=u.btVector3_y(A),I.z=u.btVector3_z(A);var x=u.tVector3Array_at(g,R),D=C.normal;D.x=-u.btVector3_x(x),D.y=u.btVector3_y(x),D.z=u.btVector3_z(x)}return!0}return!1}},{key:"addConstraint",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(!this._btDiscreteDynamicsWorld)throw"Cannot perform this action when the physics engine is set to CollisionsOnly";F.Physics3D._bullet.btCollisionWorld_addConstraint(this._btDiscreteDynamicsWorld,e._btConstraint,t),this._currentConstraint[e.id]=e}},{key:"removeConstraint",value:function(e){if(!this._btDiscreteDynamicsWorld)throw"Cannot perform this action when the physics engine is set to CollisionsOnly";F.Physics3D._bullet.btCollisionWorld_removeConstraint(this._btDiscreteDynamicsWorld,e._btConstraint),delete this._currentConstraint[e.id]}},{key:"setHitsRayResultCallbackFlag",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,t=F.Physics3D._bullet;t.RayResultCallback_set_m_flags(this._btAllHitsRayResultCallback,e),t.RayResultCallback_set_m_flags(this._btClosestRayResultCallback,e)}},{key:"_updatePhysicsTransformFromRender",value:function(){for(var e=this._physicsUpdateList.elements,t=0,n=this._physicsUpdateList.length;t<n;t++){var i=e[t];i._derivePhysicsTransformation(!1),i._inPhysicUpdateListIndex=-1}this._physicsUpdateList.length=0}},{key:"_updateCharacters",value:function(){for(var e=0,t=this._characters.length;e<t;e++){var n=this._characters[e];n._updateTransformComponent(F.Physics3D._bullet.btCollisionObject_getWorldTransform(n._btColliderObject))}}},{key:"_updateCollisions",value:function(){this._collisionsUtils.recoverAllContactPointsPool();var e=this._currentFrameCollisions;this._currentFrameCollisions=this._previousFrameCollisions,this._currentFrameCollisions.length=0,this._previousFrameCollisions=e;for(var n=t.Stat.loopCount,i=F.Physics3D._bullet,r=i.btDispatcher_getNumManifolds(this._btDispatcher),a=0;a<r;a++){var o,s=i.btDispatcher_getManifoldByIndexInternal(this._btDispatcher,a),l=ze._physicObjectsMap[i.btCollisionObject_getUserIndex(i.btPersistentManifold_getBody0(s))],u=ze._physicObjectsMap[i.btCollisionObject_getUserIndex(i.btPersistentManifold_getBody1(s))],_=null,c=null;if((l.isTrigger||u.isTrigger)&&(l.owner._needProcessTriggers||u.owner._needProcessTriggers))for(var h=i.btPersistentManifold_getNumContacts(s),d=0;d<h;d++){var f=i.btPersistentManifold_getContactPoint(s,d),m=i.btManifoldPoint_getDistance(f);if(m<=0){c=(_=this._collisionsUtils.getCollision(l,u)).contacts,(o=_._updateFrame!==n)&&(_._isTrigger=!0,c.length=0);break}}else if((l.owner._needProcessCollisions||u.owner._needProcessCollisions)&&(l._enableProcessCollisions||u._enableProcessCollisions))for(h=i.btPersistentManifold_getNumContacts(s),d=0;d<h;d++)if(f=i.btPersistentManifold_getContactPoint(s,d),(m=i.btManifoldPoint_getDistance(f))<=0){var p=this._collisionsUtils.getContactPoints();p.colliderA=l,p.colliderB=u,p.distance=m;var v=i.btManifoldPoint_get_m_normalWorldOnB(f),E=p.normal;E.x=-i.btVector3_x(v),E.y=i.btVector3_y(v),E.z=i.btVector3_z(v);var T=i.btManifoldPoint_get_m_positionWorldOnA(f),g=p.positionOnA;g.x=-i.btVector3_x(T),g.y=i.btVector3_y(T),g.z=i.btVector3_z(T);var y=i.btManifoldPoint_get_m_positionWorldOnB(f),S=p.positionOnB;S.x=-i.btVector3_x(y),S.y=i.btVector3_y(y),S.z=i.btVector3_z(y),_||(c=(_=this._collisionsUtils.getCollision(l,u)).contacts,(o=_._updateFrame!==n)&&(_._isTrigger=!1,c.length=0)),c.push(p)}_&&o&&(this._currentFrameCollisions.push(_),_._setUpdateFrame(n))}}},{key:"_eventScripts",value:function(){for(var e=t.Stat.loopCount,n=0,i=this._currentFrameCollisions.length;n<i;n++){var r=this._currentFrameCollisions[n],a=r._colliderA,o=r._colliderB;if(!a.destroyed&&!o.destroyed)if(e-r._lastUpdateFrame==1){var s=a.owner,l=s._scripts;if(l)if(r._isTrigger){if(s._needProcessTriggers)for(var u=0,_=l.length;u<_;u++)l[u].onTriggerStay(o)}else if(s._needProcessCollisions)for(u=0,_=l.length;u<_;u++)r.other=o,l[u].onCollisionStay(r);var c=o.owner,h=c._scripts;if(h)if(r._isTrigger){if(c._needProcessTriggers)for(u=0,_=h.length;u<_;u++)h[u].onTriggerStay(a)}else if(c._needProcessCollisions)for(u=0,_=h.length;u<_;u++)r.other=a,h[u].onCollisionStay(r)}else{if(l=(s=a.owner)._scripts)if(r._isTrigger){if(s._needProcessTriggers)for(u=0,_=l.length;u<_;u++)l[u].onTriggerEnter(o)}else if(s._needProcessCollisions)for(u=0,_=l.length;u<_;u++)r.other=o,l[u].onCollisionEnter(r);if(h=(c=o.owner)._scripts)if(r._isTrigger){if(c._needProcessTriggers)for(u=0,_=h.length;u<_;u++)h[u].onTriggerEnter(a)}else if(c._needProcessCollisions)for(u=0,_=h.length;u<_;u++)r.other=a,h[u].onCollisionEnter(r)}}for(n=0,i=this._previousFrameCollisions.length;n<i;n++){var d=this._previousFrameCollisions[n],f=d._colliderA,m=d._colliderB;if(!f.destroyed&&!m.destroyed&&e-d._updateFrame==1){if(this._collisionsUtils.recoverCollision(d),l=(s=f.owner)._scripts)if(d._isTrigger){if(s._needProcessTriggers)for(u=0,_=l.length;u<_;u++)l[u].onTriggerExit(m)}else if(s._needProcessCollisions)for(u=0,_=l.length;u<_;u++)d.other=m,l[u].onCollisionExit(d);if(h=(c=m.owner)._scripts)if(d._isTrigger){if(c._needProcessTriggers)for(u=0,_=h.length;u<_;u++)h[u].onTriggerExit(f)}else if(c._needProcessCollisions)for(u=0,_=h.length;u<_;u++)d.other=f,h[u].onCollisionExit(d)}}for(var p in this._currentConstraint){var v=this._currentConstraint[p],E=v.owner._scripts;if(v.enabled&&v._isBreakConstrained()&&E&&0!=E.length)for(n=0,i=E.length;n<i;n++)E[n].onJointBreak()}}},{key:"clearForces",value:function(){if(!this._btDiscreteDynamicsWorld)throw"Cannot perform this action when the physics engine is set to CollisionsOnly";F.Physics3D._bullet.btDiscreteDynamicsWorld_clearForces(this._btDiscreteDynamicsWorld)}},{key:"continuousCollisionDetection",get:function(){return F.Physics3D._bullet.btCollisionWorld_get_m_useContinuous(this._btDispatchInfo)},set:function(e){F.Physics3D._bullet.btCollisionWorld_set_m_useContinuous(this._btDispatchInfo,e)}},{key:"gravity",get:function(){if(!this._btDiscreteDynamicsWorld)throw"Simulation:Cannot perform this action when the physics engine is set to CollisionsOnly";return this._gravity},set:function(e){if(!this._btDiscreteDynamicsWorld)throw"Simulation:Cannot perform this action when the physics engine is set to CollisionsOnly";this._gravity=e;var t=F.Physics3D._bullet,n=G._btTempVector30;t.btVector3_setValue(n,-e.x,e.y,e.z),t.btDiscreteDynamicsWorld_setGravity(this._btDiscreteDynamicsWorld,n)}},{key:"speculativeContactRestitution",get:function(){if(!this._btDiscreteDynamicsWorld)throw"Simulation:Cannot Cannot perform this action when the physics engine is set to CollisionsOnly";return F.Physics3D._bullet.btDiscreteDynamicsWorld_getApplySpeculativeContactRestitution(this._btDiscreteDynamicsWorld)},set:function(e){if(!this._btDiscreteDynamicsWorld)throw"Simulation:Cannot Cannot perform this action when the physics engine is set to CollisionsOnly";F.Physics3D._bullet.btDiscreteDynamicsWorld_setApplySpeculativeContactRestitution(this._btDiscreteDynamicsWorld,e)}}],[{key:"__init__",value:function(){var e=F.Physics3D._bullet;G._btTempVector30=e.btVector3_create(0,0,0),G._btTempVector31=e.btVector3_create(0,0,0),G._btTempQuaternion0=e.btQuaternion_create(0,0,0,1),G._btTempQuaternion1=e.btQuaternion_create(0,0,0,1),G._btTempTransform0=e.btTransform_create(),G._btTempTransform1=e.btTransform_create()}},{key:"createConstraint",value:function(){}}]),G}();Et.PHYSICSENGINEFLAGS_NONE=0,Et.PHYSICSENGINEFLAGS_COLLISIONSONLY=1,Et.PHYSICSENGINEFLAGS_SOFTBODYSUPPORT=2,Et.PHYSICSENGINEFLAGS_MULTITHREADED=4,Et.PHYSICSENGINEFLAGS_USEHARDWAREWHENPOSSIBLE=8,Et.SOLVERMODE_RANDMIZE_ORDER=1,Et.SOLVERMODE_FRICTION_SEPARATE=2,Et.SOLVERMODE_USE_WARMSTARTING=4,Et.SOLVERMODE_USE_2_FRICTION_DIRECTIONS=16,Et.SOLVERMODE_ENABLE_FRICTION_DIRECTION_CACHING=32,Et.SOLVERMODE_DISABLE_VELOCITY_DEPENDENT_FRICTION_DIRECTION=64,Et.SOLVERMODE_CACHE_FRIENDLY=128,Et.SOLVERMODE_SIMD=256,Et.SOLVERMODE_INTERLEAVE_CONTACT_AND_FRICTION_CONSTRAINTS=512,Et.SOLVERMODE_ALLOW_ZERO_LENGTH_FRICTION_DIRECTIONS=1024,Et.HITSRAYRESULTCALLBACK_FLAG_NONE=0,Et.HITSRAYRESULTCALLBACK_FLAG_FILTERBACKFACESS=1,Et.HITSRAYRESULTCALLBACK_FLAG_KEEPUNFILIPPEDNORMAL=2,Et.HITSRAYRESULTCALLBACK_FLAG_USESUBSIMPLEXCONVEXCASTRAYTEST=4,Et.HITSRAYRESULTCALLBACK_FLAG_USEGJKCONVEXCASTRAYTEST=8,Et.HITSRAYRESULTCALLBACK_FLAG_TERMINATOR=4294967295,Et._tempVector30=new D,Et.disableSimulation=!1;var Tt=function(){function H(){_classCallCheck(this,H)}return _createClass(H,null,[{key:"lightAttenTexture",value:function(e,t,n,i,r,a){var o=e/n,s=1/(1+25*o);o>=.64&&(o>1?s=0:s*=1-(o-.64)/.36),a[r]=Math.floor(255*s+.5)}},{key:"haloTexture",value:function(e,t,n,i,r,a){var o=(e-(n>>=1))/n,s=(t-(i>>=1))/i,l=o*o+s*s;l>1&&(l=1),a[r]=Math.floor(255*(1-l)+.5)}},{key:"_generateTexture2D",value:function(e,n,i,r){var a=0,o=0;switch(e.format){case t.TextureFormat.R8G8B8:o=3;break;case t.TextureFormat.R8G8B8A8:o=4;break;case t.TextureFormat.Alpha8:o=1;break;default:throw"GeneratedTexture._generateTexture: unkonw texture format."}for(var s=new Uint8Array(n*i*o),l=0;l<i;l++)for(var u=0;u<n;u++)r(u,l,n,i,a,s),a+=o;e.setPixels(s)}}]),H}(),gt=function(){function z(){_classCallCheck(this,z)}return _createClass(z,null,[{key:"_createFloatTextureBuffer",value:function(e,n){var i=new t.Texture2D(e,n,t.TextureFormat.R32G32B32A32,!1,!1);return i.filterMode=t.FilterMode.Point,i.wrapModeU=t.WarpMode.Clamp,i.wrapModeV=t.WarpMode.Clamp,i.anisoLevel=0,i}},{key:"_convertToLayaVec3",value:function(e,t,n){var i=F.Physics3D._bullet;t.x=n?-i.btVector3_x(e):i.btVector3_x(e),t.y=i.btVector3_y(e),t.z=i.btVector3_z(e)}},{key:"_convertToBulletVec3",value:function(e,t,n){F.Physics3D._bullet.btVector3_setValue(t,n?-e.x:e.x,e.y,e.z)}},{key:"_rotationTransformScaleSkinAnimation",value:function(e,t,n,i,r,a,o,s,l,u,_,c){var h,d,f,m,p,v=z._tempArray16_0,E=z._tempArray16_1,T=z._tempArray16_2,g=i+i,y=r+r,S=a+a,R=i*g,C=r*g,A=r*y,I=a*g,x=a*y,D=a*S,M=o*g,L=o*y,O=o*S;for(v[15]=1,v[0]=1-A-D,v[1]=C+O,v[2]=I-L,v[4]=C-O,v[5]=1-R-D,v[6]=x+M,v[8]=I+L,v[9]=x-M,v[10]=1-R-A,E[15]=1,E[0]=s,E[5]=l,E[10]=u,h=0;h<4;h++)d=v[h],f=v[h+4],m=v[h+8],p=v[h+12],T[h]=d,T[h+4]=f,T[h+8]=m,T[h+12]=d*e+f*t+m*n+p;for(h=0;h<4;h++)d=T[h],f=T[h+4],m=T[h+8],p=T[h+12],_[h+c]=d*E[0]+f*E[1]+m*E[2]+p*E[3],_[h+c+4]=d*E[4]+f*E[5]+m*E[6]+p*E[7],_[h+c+8]=d*E[8]+f*E[9]+m*E[10]+p*E[11],_[h+c+12]=d*E[12]+f*E[13]+m*E[14]+p*E[15]}},{key:"_computeBoneAndAnimationDatasByBindPoseMatrxix",value:function(e,t,n,i,r,a){var o,s,l=0,u=0,_=e.length;for(o=0;o<_;l+=e[o].keyframeWidth,u+=16,o++)z._rotationTransformScaleSkinAnimation(t[l+0],t[l+1],t[l+2],t[l+3],t[l+4],t[l+5],t[l+6],t[l+7],t[l+8],t[l+9],i,u),0!=o&&(s=16*e[o].parentIndex,z.mulMatrixByArray(i,s,i,u,i,u));var c=n.length;for(o=0;o<c;o++)z.mulMatrixByArrayAndMatrixFast(i,16*a[o],n[o],r,16*o)}},{key:"_computeAnimationDatasByArrayAndMatrixFast",value:function(e,t,n,i){for(var r=0,a=e.length;r<a;r++)z.mulMatrixByArrayAndMatrixFast(t,16*i[r],e[r],n,16*r)}},{key:"_computeBoneAndAnimationDatasByBindPoseMatrxixOld",value:function(e,t,n,i,r){var a,o,s=0,l=0,u=e.length;for(a=0;a<u;s+=e[a].keyframeWidth,l+=16,a++)z._rotationTransformScaleSkinAnimation(t[s+7],t[s+8],t[s+9],t[s+3],t[s+4],t[s+5],t[s+6],t[s+0],t[s+1],t[s+2],i,l),0!=a&&(o=16*e[a].parentIndex,z.mulMatrixByArray(i,o,i,l,i,l));var _=n.length;for(a=0;a<_;a++){var c=16*a;z.mulMatrixByArrayAndMatrixFast(i,c,n[a],r,c)}}},{key:"_computeAnimationDatasByArrayAndMatrixFastOld",value:function(e,t,n){for(var i=e.length,r=0;r<i;r++){var a=16*r;z.mulMatrixByArrayAndMatrixFast(t,a,e[r],n,a)}}},{key:"_computeRootAnimationData",value:function(e,t,n){for(var i=0,r=0,a=0,o=e.length;i<o;r+=e[i].keyframeWidth,a+=16,i++)z.createAffineTransformationArray(t[r+0],t[r+1],t[r+2],t[r+3],t[r+4],t[r+5],t[r+6],t[r+7],t[r+8],t[r+9],n,a)}},{key:"transformVector3ArrayByQuat",value:function(e,t,n,i,r){var a=e[t],o=e[t+1],s=e[t+2],l=n.x,u=n.y,_=n.z,c=n.w,h=c*a+u*s-_*o,d=c*o+_*a-l*s,f=c*s+l*o-u*a,m=-l*a-u*o-_*s;i[r]=h*c+m*-l+d*-_-f*-u,i[r+1]=d*c+m*-u+f*-l-h*-_,i[r+2]=f*c+m*-_+h*-u-d*-l}},{key:"mulMatrixByArray",value:function(e,t,n,i,r,a){var o,s,l,u,_;if(r===n){for(n=z._tempArray16_3,o=0;o<16;++o)n[o]=r[a+o];i=0}for(o=0;o<4;o++)s=e[t+o],l=e[t+o+4],u=e[t+o+8],_=e[t+o+12],r[a+o]=s*n[i+0]+l*n[i+1]+u*n[i+2]+_*n[i+3],r[a+o+4]=s*n[i+4]+l*n[i+5]+u*n[i+6]+_*n[i+7],r[a+o+8]=s*n[i+8]+l*n[i+9]+u*n[i+10]+_*n[i+11],r[a+o+12]=s*n[i+12]+l*n[i+13]+u*n[i+14]+_*n[i+15]}},{key:"mulMatrixByArrayFast",value:function(e,t,n,i,r,a){var o,s,l,u,_;for(o=0;o<4;o++)s=e[t+o],l=e[t+o+4],u=e[t+o+8],_=e[t+o+12],r[a+o]=s*n[i+0]+l*n[i+1]+u*n[i+2]+_*n[i+3],r[a+o+4]=s*n[i+4]+l*n[i+5]+u*n[i+6]+_*n[i+7],r[a+o+8]=s*n[i+8]+l*n[i+9]+u*n[i+10]+_*n[i+11],r[a+o+12]=s*n[i+12]+l*n[i+13]+u*n[i+14]+_*n[i+15]}},{key:"mulMatrixByArrayAndMatrixFast",value:function(e,t,n,i,r){var a,o,s,l,u,_=n.elements,c=_[0],h=_[1],d=_[2],f=_[3],m=_[4],p=_[5],v=_[6],E=_[7],T=_[8],g=_[9],y=_[10],S=_[11],R=_[12],C=_[13],A=_[14],I=_[15],x=t,D=t+4,M=t+8,L=t+12,O=r,N=r+4,P=r+8,b=r+12;for(a=0;a<4;a++)o=e[x+a],s=e[D+a],l=e[M+a],u=e[L+a],i[O+a]=o*c+s*h+l*d+u*f,i[N+a]=o*m+s*p+l*v+u*E,i[P+a]=o*T+s*g+l*y+u*S,i[b+a]=o*R+s*C+l*A+u*I}},{key:"createAffineTransformationArray",value:function(e,t,n,i,r,a,o,s,l,u,_,c){var h=i+i,d=r+r,f=a+a,m=i*h,p=i*d,v=i*f,E=r*d,T=r*f,g=a*f,y=o*h,S=o*d,R=o*f;_[c+0]=(1-(E+g))*s,_[c+1]=(p+R)*s,_[c+2]=(v-S)*s,_[c+3]=0,_[c+4]=(p-R)*l,_[c+5]=(1-(m+g))*l,_[c+6]=(T+y)*l,_[c+7]=0,_[c+8]=(v+S)*u,_[c+9]=(T-y)*u,_[c+10]=(1-(m+E))*u,_[c+11]=0,_[c+12]=e,_[c+13]=t,_[c+14]=n,_[c+15]=1}},{key:"transformVector3ArrayToVector3ArrayCoordinate",value:function(e,t,n,i,r){var a=e[t+0],o=e[t+1],s=e[t+2],l=n.elements,u=a*l[3]+o*l[7]+s*l[11]+l[15];i[r]=a*l[0]+o*l[4]+s*l[8]+l[12]/u,i[r+1]=a*l[1]+o*l[5]+s*l[9]+l[13]/u,i[r+2]=a*l[2]+o*l[6]+s*l[10]+l[14]/u}},{key:"transformVector3ArrayToVector3ArrayNormal",value:function(e,t,n,i,r){var a=e[t+0],o=e[t+1],s=e[t+2],l=n.elements;i[r]=a*l[0]+o*l[4]+s*l[8],i[r+1]=a*l[1]+o*l[5]+s*l[9],i[r+2]=a*l[2]+o*l[6]+s*l[10]}},{key:"transformLightingMapTexcoordArray",value:function(e,t,n,i,r){i[r+0]=e[t+0]*n.x+n.z,i[r+1]=1-((1-e[t+1])*n.y+n.w)}},{key:"getURLVerion",value:function(e){var t=e.indexOf("?");return t>=0?e.substr(t):null}},{key:"_createAffineTransformationArray",value:function(e,t,n,i){var r=t.x,a=t.y,o=t.z,s=t.w,l=r+r,u=a+a,_=o+o,c=r*l,h=r*u,d=r*_,f=a*u,m=a*_,p=o*_,v=s*l,E=s*u,T=s*_,g=n.x,y=n.y,S=n.z;i[0]=(1-(f+p))*g,i[1]=(h+T)*g,i[2]=(d-E)*g,i[3]=0,i[4]=(h-T)*y,i[5]=(1-(c+p))*y,i[6]=(m+v)*y,i[7]=0,i[8]=(d+E)*S,i[9]=(m-v)*S,i[10]=(1-(c+f))*S,i[11]=0,i[12]=e.x,i[13]=e.y,i[14]=e.z,i[15]=1}},{key:"_mulMatrixArray",value:function(e,t,n,i,r){var a=t,o=e,s=i,l=a[n],u=a[n+1],_=a[n+2],c=a[n+3],h=a[n+4],d=a[n+5],f=a[n+6],m=a[n+7],p=a[n+8],v=a[n+9],E=a[n+10],T=a[n+11],g=a[n+12],y=a[n+13],S=a[n+14],R=a[n+15],C=o[0],A=o[1],I=o[2],x=o[3],D=o[4],M=o[5],L=o[6],O=o[7],N=o[8],P=o[9],b=o[10],w=o[11],k=o[12],V=o[13],B=o[14],F=o[15];s[r]=l*C+u*D+_*N+c*k,s[r+1]=l*A+u*M+_*P+c*V,s[r+2]=l*I+u*L+_*b+c*B,s[r+3]=l*x+u*O+_*w+c*F,s[r+4]=h*C+d*D+f*N+m*k,s[r+5]=h*A+d*M+f*P+m*V,s[r+6]=h*I+d*L+f*b+m*B,s[r+7]=h*x+d*O+f*w+m*F,s[r+8]=p*C+v*D+E*N+T*k,s[r+9]=p*A+v*M+E*P+T*V,s[r+10]=p*I+v*L+E*b+T*B,s[r+11]=p*x+v*O+E*w+T*F,s[r+12]=g*C+y*D+S*N+R*k,s[r+13]=g*A+y*M+S*P+R*V,s[r+14]=g*I+y*L+S*b+R*B,s[r+15]=g*x+y*O+S*w+R*F}},{key:"arcTanAngle",value:function(e,t){return 0==e?1==t?Math.PI/2:-Math.PI/2:e>0?Math.atan(t/e):e<0?t>0?Math.atan(t/e)+Math.PI:Math.atan(t/e)-Math.PI:0}},{key:"angleTo",value:function(e,t,n){D.subtract(t,e,Z.TEMPVector30),D.normalize(Z.TEMPVector30,Z.TEMPVector30),n.x=Math.asin(Z.TEMPVector30.y),n.y=z.arcTanAngle(-Z.TEMPVector30.z,-Z.TEMPVector30.x)}},{key:"transformQuat",value:function(e,t,n){var i=t,r=e.x,a=e.y,o=e.z,s=i[0],l=i[1],u=i[2],_=i[3],c=_*r+l*o-u*a,h=_*a+u*r-s*o,d=_*o+s*a-l*r,f=-s*r-l*a-u*o;n.x=c*_+f*-s+h*-u-d*-l,n.y=h*_+f*-l+d*-s-c*-u,n.z=d*_+f*-u+c*-l-h*-s}},{key:"quaternionWeight",value:function(e,t,n){n.x=e.x*t,n.y=e.y*t,n.z=e.z*t,n.w=e.w}},{key:"quaternionConjugate",value:function(e,t){t.x=-e.x,t.y=-e.y,t.z=-e.z,t.w=e.w}},{key:"scaleWeight",value:function(e,t,n){var i=e.x,r=e.y,a=e.z;n.x=i>0?Math.pow(Math.abs(i),t):-Math.pow(Math.abs(i),t),n.y=r>0?Math.pow(Math.abs(r),t):-Math.pow(Math.abs(r),t),n.z=a>0?Math.pow(Math.abs(a),t):-Math.pow(Math.abs(a),t)}},{key:"scaleBlend",value:function(e,t,n,i){var r=z._tempVector3_0,a=z._tempVector3_1;z.scaleWeight(e,1-n,r),z.scaleWeight(t,n,a);var o=n>.5?t:e;i.x=o.x>0?Math.abs(r.x*a.x):-Math.abs(r.x*a.x),i.y=o.y>0?Math.abs(r.y*a.y):-Math.abs(r.y*a.y),i.z=o.z>0?Math.abs(r.z*a.z):-Math.abs(r.z*a.z)}},{key:"matrix4x4MultiplyFFF",value:function(e,t,n){var i,r,a,o,s;if(n===t)for(t=new Float32Array(16),i=0;i<16;++i)t[i]=n[i];var l=t[0],u=t[1],_=t[2],c=t[3],h=t[4],d=t[5],f=t[6],m=t[7],p=t[8],v=t[9],E=t[10],T=t[11],g=t[12],y=t[13],S=t[14],R=t[15];for(i=0;i<4;i++)r=e[i],a=e[i+4],o=e[i+8],s=e[i+12],n[i]=r*l+a*u+o*_+s*c,n[i+4]=r*h+a*d+o*f+s*m,n[i+8]=r*p+a*v+o*E+s*T,n[i+12]=r*g+a*y+o*S+s*R}},{key:"matrix4x4MultiplyFFFForNative",value:function(e,n,i){t.LayaGL.instance.matrix4x4Multiply(e,n,i)}},{key:"matrix4x4MultiplyMFM",value:function(e,t,n){z.matrix4x4MultiplyFFF(e.elements,t,n.elements)}},{key:"_buildTexture2D",value:function(e,n,i,r){var a=arguments.length>4&&void 0!==arguments[4]&&arguments[4],o=new t.Texture2D(e,n,i,a,!0);return o.anisoLevel=1,o.filterMode=t.FilterMode.Point,Tt._generateTexture2D(o,e,n,r),o}},{key:"_drawBound",value:function(e,t,n){e.lineCount+12>e.maxLineCount&&(e.maxLineCount+=12);var i=z._tempVector3_0,r=z._tempVector3_1,a=t.min,o=t.max;i.setValue(a.x,a.y,a.z),r.setValue(o.x,a.y,a.z),e.addLine(i,r,n,n),i.setValue(a.x,a.y,a.z),r.setValue(a.x,a.y,o.z),e.addLine(i,r,n,n),i.setValue(o.x,a.y,a.z),r.setValue(o.x,a.y,o.z),e.addLine(i,r,n,n),i.setValue(a.x,a.y,o.z),r.setValue(o.x,a.y,o.z),e.addLine(i,r,n,n),i.setValue(a.x,a.y,a.z),r.setValue(a.x,o.y,a.z),e.addLine(i,r,n,n),i.setValue(a.x,a.y,o.z),r.setValue(a.x,o.y,o.z),e.addLine(i,r,n,n),i.setValue(o.x,a.y,a.z),r.setValue(o.x,o.y,a.z),e.addLine(i,r,n,n),i.setValue(o.x,a.y,o.z),r.setValue(o.x,o.y,o.z),e.addLine(i,r,n,n),i.setValue(a.x,o.y,a.z),r.setValue(o.x,o.y,a.z),e.addLine(i,r,n,n),i.setValue(a.x,o.y,a.z),r.setValue(a.x,o.y,o.z),e.addLine(i,r,n,n),i.setValue(o.x,o.y,a.z),r.setValue(o.x,o.y,o.z),e.addLine(i,r,n,n),i.setValue(a.x,o.y,o.z),r.setValue(o.x,o.y,o.z),e.addLine(i,r,n,n)}},{key:"_getHierarchyPath",value:function(e,t,n){n.length=0;for(var i=t;i!==e;){var r=i._parent;if(!r)return null;n.push(r.getChildIndex(i)),i=r}return n}},{key:"_getNodeByHierarchyPath",value:function(e,t){for(var n=e,i=t.length-1;i>=0;i--)n=n.getChildAt(t[i]);return n}}]),z}();gt._tempVector3_0=new D,gt._tempVector3_1=new D,gt._tempArray16_0=new Float32Array(16),gt._tempArray16_1=new Float32Array(16),gt._tempArray16_2=new Float32Array(16),gt._tempArray16_3=new Float32Array(16),gt._compIdToNode=new Object;var yt=function(e){function k(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:.1,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:ce.COLLISIONFILTERGROUP_DEFAULTFILTER,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:ce.COLLISIONFILTERGROUP_ALLFILTER;return _classCallCheck(this,k),(e=_possibleConstructorReturn(this,_getPrototypeOf(k).call(this,i,r)))._upAxis=new D(0,1,0),e._maxSlope=45,e._jumpSpeed=10,e._fallSpeed=55,e._gravity=new D(0,3*-9.8,0),e._btKinematicCharacter=null,e._stepHeight=t,n&&(e._upAxis=n),e._controlBySimulation=!0,e}return _inherits(k,ze),_createClass(k,[{key:"_constructCharacter",value:function(){var e=F.Physics3D._bullet;this._btKinematicCharacter&&e.btKinematicCharacterController_destroy(this._btKinematicCharacter);var t=k._btTempVector30;e.btVector3_setValue(t,this._upAxis.x,this._upAxis.y,this._upAxis.z),this._btKinematicCharacter=e.btKinematicCharacterController_create(this._btColliderObject,this._colliderShape._btShape,this._stepHeight,t),this.fallSpeed=this._fallSpeed,this.maxSlope=this._maxSlope,this.jumpSpeed=this._jumpSpeed,this.gravity=this._gravity}},{key:"_onShapeChange",value:function(e){_get(_getPrototypeOf(k.prototype),"_onShapeChange",this).call(this,e),this._constructCharacter()}},{key:"_onAdded",value:function(){var e=F.Physics3D._bullet,t=e.btPairCachingGhostObject_create();e.btCollisionObject_setUserIndex(t,this.id),e.btCollisionObject_setCollisionFlags(t,ze.COLLISIONFLAGS_CHARACTER_OBJECT),this._btColliderObject=t,this._colliderShape&&this._constructCharacter(),_get(_getPrototypeOf(k.prototype),"_onAdded",this).call(this)}},{key:"_addToSimulation",value:function(){this._simulation._characters.push(this),this._simulation._addCharacter(this,this._collisionGroup,this._canCollideWith)}},{key:"_removeFromSimulation",value:function(){this._simulation._removeCharacter(this);var e=this._simulation._characters;e.splice(e.indexOf(this),1)}},{key:"_cloneTo",value:function(e){_get(_getPrototypeOf(k.prototype),"_cloneTo",this).call(this,e);var t=e;t.stepHeight=this._stepHeight,t.upAxis=this._upAxis,t.maxSlope=this._maxSlope,t.jumpSpeed=this._jumpSpeed,t.fallSpeed=this._fallSpeed,t.gravity=this._gravity}},{key:"_onDestroy",value:function(){F.Physics3D._bullet.btKinematicCharacterController_destroy(this._btKinematicCharacter),_get(_getPrototypeOf(k.prototype),"_onDestroy",this).call(this),this._btKinematicCharacter=null}},{key:"move",value:function(e){var t=k._btVector30,n=F.Physics3D._bullet;n.btVector3_setValue(t,-e.x,e.y,e.z),n.btKinematicCharacterController_setWalkDirection(this._btKinematicCharacter,t)}},{key:"jump",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t=F.Physics3D._bullet,n=k._btVector30;e?(gt._convertToBulletVec3(e,n,!0),t.btKinematicCharacterController_jump(this._btKinematicCharacter,n)):(t.btVector3_setValue(n,0,0,0),t.btKinematicCharacterController_jump(this._btKinematicCharacter,n))}},{key:"fallSpeed",get:function(){return this._fallSpeed},set:function(e){this._fallSpeed=e,F.Physics3D._bullet.btKinematicCharacterController_setFallSpeed(this._btKinematicCharacter,e)}},{key:"jumpSpeed",get:function(){return this._jumpSpeed},set:function(e){this._jumpSpeed=e,F.Physics3D._bullet.btKinematicCharacterController_setJumpSpeed(this._btKinematicCharacter,e)}},{key:"gravity",get:function(){return this._gravity},set:function(e){this._gravity=e;var t=F.Physics3D._bullet,n=k._btTempVector30;t.btVector3_setValue(n,-e.x,e.y,e.z),t.btKinematicCharacterController_setGravity(this._btKinematicCharacter,n)}},{key:"maxSlope",get:function(){return this._maxSlope},set:function(e){this._maxSlope=e,F.Physics3D._bullet.btKinematicCharacterController_setMaxSlope(this._btKinematicCharacter,e/180*Math.PI)}},{key:"isGrounded",get:function(){return F.Physics3D._bullet.btKinematicCharacterController_onGround(this._btKinematicCharacter)}},{key:"stepHeight",get:function(){return this._stepHeight},set:function(e){this._stepHeight=e,F.Physics3D._bullet.btKinematicCharacterController_setStepHeight(this._btKinematicCharacter,e)}},{key:"upAxis",get:function(){return this._upAxis},set:function(e){this._upAxis=e;var t=k._btTempVector30;gt._convertToBulletVec3(e,t,!1),F.Physics3D._bullet.btKinematicCharacterController_setUp(this._btKinematicCharacter,t)}}],[{key:"__init__",value:function(){k._btTempVector30=F.Physics3D._bullet.btVector3_create(0,0,0)}}]),k}();yt.UPAXIS_X=0,yt.UPAXIS_Y=1,yt.UPAXIS_Z=2;var St=function(e){function W(e,t){var n;return _classCallCheck(this,W),(n=_possibleConstructorReturn(this,_getPrototypeOf(W).call(this,e,t)))._isTrigger=!1,n}return _inherits(W,ze),_createClass(W,[{key:"_onAdded",value:function(){_get(_getPrototypeOf(W.prototype),"_onAdded",this).call(this),this.isTrigger=this._isTrigger}},{key:"_cloneTo",value:function(e){_get(_getPrototypeOf(W.prototype),"_cloneTo",this).call(this,e),e.isTrigger=this._isTrigger}},{key:"isTrigger",get:function(){return this._isTrigger},set:function(e){this._isTrigger=e;var t=F.Physics3D._bullet;if(this._btColliderObject){var n=t.btCollisionObject_getCollisionFlags(this._btColliderObject);e?0==(n&ze.COLLISIONFLAGS_NO_CONTACT_RESPONSE)&&t.btCollisionObject_setCollisionFlags(this._btColliderObject,n|ze.COLLISIONFLAGS_NO_CONTACT_RESPONSE):0!=(n&ze.COLLISIONFLAGS_NO_CONTACT_RESPONSE)&&t.btCollisionObject_setCollisionFlags(this._btColliderObject,n^ze.COLLISIONFLAGS_NO_CONTACT_RESPONSE)}}}]),W}(),Rt=function(e){function X(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:ce.COLLISIONFILTERGROUP_DEFAULTFILTER,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:ce.COLLISIONFILTERGROUP_ALLFILTER;return _classCallCheck(this,X),(e=_possibleConstructorReturn(this,_getPrototypeOf(X).call(this,t,n)))._isKinematic=!1,e._mass=1,e._gravity=new D(0,-10,0),e._angularDamping=0,e._linearDamping=0,e._overrideGravity=!1,e._totalTorque=new D(0,0,0),e._totalForce=new D(0,0,0),e._linearVelocity=new D,e._angularVelocity=new D,e._linearFactor=new D(1,1,1),e._angularFactor=new D(1,1,1),e._detectCollisions=!0,e._controlBySimulation=!0,e}return _inherits(X,St),_createClass(X,[{key:"_updateMass",value:function(e){if(this._btColliderObject&&this._colliderShape){var t=F.Physics3D._bullet;t.btCollisionShape_calculateLocalInertia(this._colliderShape._btShape,e,X._btInertia),t.btRigidBody_setMassProps(this._btColliderObject,e,X._btInertia),t.btRigidBody_updateInertiaTensor(this._btColliderObject)}}},{key:"_onScaleChange",value:function(e){_get(_getPrototypeOf(X.prototype),"_onScaleChange",this).call(this,e),this._updateMass(this._isKinematic?0:this._mass)}},{key:"_derivePhysicsTransformation",value:function(e){var t=F.Physics3D._bullet,n=this._btColliderObject,i=t.btCollisionObject_getWorldTransform(n),r=X._btTransform0;t.btTransform_equal(r,i),this._innerDerivePhysicsTransformation(r,e),t.btRigidBody_setCenterOfMassTransform(n,r)}},{key:"_onAdded",value:function(){var e=F.Physics3D._bullet,t=e.layaMotionState_create();e.layaMotionState_set_rigidBodyID(t,this._id),this._btLayaMotionState=t;var n=e.btRigidBodyConstructionInfo_create(0,t,null,X._btVector3Zero),i=e.btRigidBody_create(n);e.btCollisionObject_setUserIndex(i,this.id),this._btColliderObject=i,_get(_getPrototypeOf(X.prototype),"_onAdded",this).call(this),this.mass=this._mass,this.linearFactor=this._linearFactor,this.angularFactor=this._angularFactor,this.linearDamping=this._linearDamping,this.angularDamping=this._angularDamping,this.overrideGravity=this._overrideGravity,this.gravity=this._gravity,this.isKinematic=this._isKinematic,e.btRigidBodyConstructionInfo_destroy(n)}},{key:"_onEnable",value:function(){_get(_getPrototypeOf(X.prototype),"_onEnable",this).call(this),this._constaintRigidbodyA&&this._constaintRigidbodyA.connectedBody._simulation&&(this._constaintRigidbodyA._createConstraint(),this._constaintRigidbodyA._onEnable()),this._constaintRigidbodyB&&this._constaintRigidbodyB.ownBody._simulation&&(this._constaintRigidbodyB._createConstraint(),this._constaintRigidbodyB._onEnable())}},{key:"_onShapeChange",value:function(e){if(_get(_getPrototypeOf(X.prototype),"_onShapeChange",this).call(this,e),this._isKinematic)this._updateMass(0);else{var t=F.Physics3D._bullet;t.btRigidBody_setCenterOfMassTransform(this._btColliderObject,t.btCollisionObject_getWorldTransform(this._btColliderObject)),this._updateMass(this._mass)}}},{key:"_parse",value:function(e){if(null!=e.friction&&(this.friction=e.friction),null!=e.rollingFriction&&(this.rollingFriction=e.rollingFriction),null!=e.restitution&&(this.restitution=e.restitution),null!=e.isTrigger&&(this.isTrigger=e.isTrigger),null!=e.mass&&(this.mass=e.mass),null!=e.linearDamping&&(this.linearDamping=e.linearDamping),null!=e.angularDamping&&(this.angularDamping=e.angularDamping),null!=e.overrideGravity&&(this.overrideGravity=e.overrideGravity),null!=e.linearFactor){var t=this.linearFactor;t.fromArray(e.linearFactor),this.linearFactor=t}if(null!=e.angularFactor){var n=this.angularFactor;n.fromArray(e.angularFactor),this.angularFactor=n}e.gravity&&(this.gravity.fromArray(e.gravity),this.gravity=this.gravity),_get(_getPrototypeOf(X.prototype),"_parse",this).call(this,e),this._parseShape(e.shapes),null!=e.isKinematic&&(this.isKinematic=e.isKinematic)}},{key:"_onDestroy",value:function(){F.Physics3D._bullet.btMotionState_destroy(this._btLayaMotionState),_get(_getPrototypeOf(X.prototype),"_onDestroy",this).call(this),this._btLayaMotionState=null,this._gravity=null,this._totalTorque=null,this._linearVelocity=null,this._angularVelocity=null,this._linearFactor=null,this._angularFactor=null,this.constaintRigidbodyA&&this.constaintRigidbodyA._breakConstrained(),this.constaintRigidbodyB&&(this.constaintRigidbodyB.connectedBody=null,this.constaintRigidbodyB._onDisable())}},{key:"_addToSimulation",value:function(){this._simulation._addRigidBody(this,this._collisionGroup,this._detectCollisions?this._canCollideWith:0)}},{key:"_removeFromSimulation",value:function(){this._simulation._removeRigidBody(this)}},{key:"_cloneTo",value:function(e){_get(_getPrototypeOf(X.prototype),"_cloneTo",this).call(this,e);var t=e;t.isKinematic=this._isKinematic,t.mass=this._mass,t.gravity=this._gravity,t.angularDamping=this._angularDamping,t.linearDamping=this._linearDamping,t.overrideGravity=this._overrideGravity,t.linearVelocity=this._linearVelocity,t.angularVelocity=this._angularVelocity,t.linearFactor=this._linearFactor,t.angularFactor=this._angularFactor,t.detectCollisions=this._detectCollisions}},{key:"applyForce",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if(null==this._btColliderObject)throw"Attempted to call a Physics function that is avaliable only when the Entity has been already added to the Scene.";var n=F.Physics3D._bullet,i=X._btTempVector30;if(n.btVector3_setValue(i,-e.x,e.y,e.z),t){var r=X._btTempVector31;n.btVector3_setValue(r,-t.x,t.y,t.z),n.btRigidBody_applyForce(this._btColliderObject,i,r)}else n.btRigidBody_applyCentralForce(this._btColliderObject,i)}},{key:"applyTorque",value:function(e){if(null==this._btColliderObject)throw"Attempted to call a Physics function that is avaliable only when the Entity has been already added to the Scene.";var t=F.Physics3D._bullet,n=X._btTempVector30;t.btVector3_setValue(n,-e.x,e.y,e.z),t.btRigidBody_applyTorque(this._btColliderObject,n)}},{key:"applyImpulse",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if(null==this._btColliderObject)throw"Attempted to call a Physics function that is avaliable only when the Entity has been already added to the Scene.";var n=F.Physics3D._bullet;n.btVector3_setValue(X._btImpulse,-e.x,e.y,e.z),t?(n.btVector3_setValue(X._btImpulseOffset,-t.x,t.y,t.z),n.btRigidBody_applyImpulse(this._btColliderObject,X._btImpulse,X._btImpulseOffset)):n.btRigidBody_applyCentralImpulse(this._btColliderObject,X._btImpulse)}},{key:"applyTorqueImpulse",value:function(e){if(null==this._btColliderObject)throw"Attempted to call a Physics function that is avaliable only when the Entity has been already added to the Scene.";var t=F.Physics3D._bullet,n=X._btTempVector30;t.btVector3_setValue(n,-e.x,e.y,e.z),t.btRigidBody_applyTorqueImpulse(this._btColliderObject,n)}},{key:"wakeUp",value:function(){this._btColliderObject&&F.Physics3D._bullet.btCollisionObject_activate(this._btColliderObject,!1)}},{key:"clearForces",value:function(){var e=this._btColliderObject;if(null==e)throw"Attempted to call a Physics function that is avaliable only when the Entity has been already added to the Scene.";var t=F.Physics3D._bullet;t.btRigidBody_clearForces(e);var n=X._btVector3Zero;t.btCollisionObject_setInterpolationLinearVelocity(e,n),t.btRigidBody_setLinearVelocity(e,n),t.btCollisionObject_setInterpolationAngularVelocity(e,n),t.btRigidBody_setAngularVelocity(e,n)}},{key:"mass",get:function(){return this._mass},set:function(e){e=Math.max(e,1e-7),this._mass=e,this._isKinematic||this._updateMass(e)}},{key:"isKinematic",get:function(){return this._isKinematic},set:function(e){this._isKinematic=e,this._controlBySimulation=!e;var t=F.Physics3D._bullet,n=!!(this._simulation&&this._enabled&&this._colliderShape);n&&this._removeFromSimulation();var i=this._btColliderObject,r=t.btCollisionObject_getCollisionFlags(i);e?(r|=ze.COLLISIONFLAGS_KINEMATIC_OBJECT,t.btCollisionObject_setCollisionFlags(i,r),t.btCollisionObject_forceActivationState(this._btColliderObject,ze.ACTIVATIONSTATE_DISABLE_DEACTIVATION),this._enableProcessCollisions=!1,this._updateMass(0)):((r&ze.COLLISIONFLAGS_KINEMATIC_OBJECT)>0&&(r^=ze.COLLISIONFLAGS_KINEMATIC_OBJECT),t.btCollisionObject_setCollisionFlags(i,r),t.btCollisionObject_setActivationState(this._btColliderObject,ze.ACTIVATIONSTATE_ACTIVE_TAG),this._enableProcessCollisions=!0,this._updateMass(this._mass));var a=X._btVector3Zero;t.btCollisionObject_setInterpolationLinearVelocity(i,a),t.btRigidBody_setLinearVelocity(i,a),t.btCollisionObject_setInterpolationAngularVelocity(i,a),t.btRigidBody_setAngularVelocity(i,a),n&&this._addToSimulation()}},{key:"linearDamping",get:function(){return this._linearDamping},set:function(e){this._linearDamping=e,this._btColliderObject&&F.Physics3D._bullet.btRigidBody_setDamping(this._btColliderObject,e,this._angularDamping)}},{key:"angularDamping",get:function(){return this._angularDamping},set:function(e){this._angularDamping=e,this._btColliderObject&&F.Physics3D._bullet.btRigidBody_setDamping(this._btColliderObject,this._linearDamping,e)}},{key:"overrideGravity",get:function(){return this._overrideGravity},set:function(e){this._overrideGravity=e;var t=F.Physics3D._bullet;if(this._btColliderObject){var n=t.btRigidBody_getFlags(this._btColliderObject);e?0==(n&X._BT_DISABLE_WORLD_GRAVITY)&&t.btRigidBody_setFlags(this._btColliderObject,n|X._BT_DISABLE_WORLD_GRAVITY):(n&X._BT_DISABLE_WORLD_GRAVITY)>0&&t.btRigidBody_setFlags(this._btColliderObject,n^X._BT_DISABLE_WORLD_GRAVITY)}}},{key:"gravity",get:function(){var e=F.Physics3D._bullet;return X._btGravity=e.btRigidBody_getGravity(this._btColliderObject),gt._convertToLayaVec3(X._btGravity,this._gravity,!0),this._gravity},set:function(e){this._gravity=e;var t=F.Physics3D._bullet;t.btVector3_setValue(X._btGravity,-e.x,e.y,e.z),t.btRigidBody_setGravity(this._btColliderObject,X._btGravity)}},{key:"totalForce",get:function(){if(this._btColliderObject){var e=F.Physics3D._bullet.btRigidBody_getTotalForce(this._btColliderObject);return gt._convertToLayaVec3(e,this._totalForce,!0),this._totalForce}return null}},{key:"linearFactor",get:function(){return this._linearFactor},set:function(e){this._linearFactor=e;var t=X._btTempVector30;gt._convertToBulletVec3(e,t,!1),F.Physics3D._bullet.btRigidBody_setLinearFactor(this._btColliderObject,t)}},{key:"linearVelocity",get:function(){return this._btColliderObject&&gt._convertToLayaVec3(F.Physics3D._bullet.btRigidBody_getLinearVelocity(this._btColliderObject),this._linearVelocity,!0),this._linearVelocity},set:function(e){if(this._linearVelocity=e,this._btColliderObject){var t=X._btTempVector30;gt._convertToBulletVec3(e,t,!0),this.isSleeping&&this.wakeUp(),F.Physics3D._bullet.btRigidBody_setLinearVelocity(this._btColliderObject,t)}}},{key:"angularFactor",get:function(){return this._angularFactor},set:function(e){this._angularFactor=e;var t=X._btTempVector30;gt._convertToBulletVec3(e,t,!1),F.Physics3D._bullet.btRigidBody_setAngularFactor(this._btColliderObject,t)}},{key:"angularVelocity",get:function(){return this._btColliderObject&&gt._convertToLayaVec3(F.Physics3D._bullet.btRigidBody_getAngularVelocity(this._btColliderObject),this._angularVelocity,!0),this._angularVelocity},set:function(e){if(this._angularVelocity=e,this._btColliderObject){var t=X._btTempVector30;gt._convertToBulletVec3(e,t,!0),this.isSleeping&&this.wakeUp(),F.Physics3D._bullet.btRigidBody_setAngularVelocity(this._btColliderObject,t)}}},{key:"totalTorque",get:function(){if(this._btColliderObject){var e=F.Physics3D._bullet.btRigidBody_getTotalTorque(this._btColliderObject);return gt._convertToLayaVec3(e,this._totalTorque,!0),this._totalTorque}return null}},{key:"detectCollisions",get:function(){return this._detectCollisions},set:function(e){this._detectCollisions!==e&&(this._detectCollisions=e,this._colliderShape&&this._enabled&&this._simulation&&(this._simulation._removeRigidBody(this),this._simulation._addRigidBody(this,this._collisionGroup,e?this._canCollideWith:0)))}},{key:"isSleeping",get:function(){return!!this._btColliderObject&&F.Physics3D._bullet.btCollisionObject_getActivationState(this._btColliderObject)===ze.ACTIVATIONSTATE_ISLAND_SLEEPING}},{key:"sleepLinearVelocity",get:function(){return F.Physics3D._bullet.btRigidBody_getLinearSleepingThreshold(this._btColliderObject)},set:function(e){var t=F.Physics3D._bullet;t.btRigidBody_setSleepingThresholds(this._btColliderObject,e,t.btRigidBody_getAngularSleepingThreshold(this._btColliderObject))}},{key:"sleepAngularVelocity",get:function(){return F.Physics3D._bullet.btRigidBody_getAngularSleepingThreshold(this._btColliderObject)},set:function(e){var t=F.Physics3D._bullet;t.btRigidBody_setSleepingThresholds(this._btColliderObject,t.btRigidBody_getLinearSleepingThreshold(this._btColliderObject),e)}},{key:"btColliderObject",get:function(){return this._btColliderObject}},{key:"constaintRigidbodyA",set:function(e){this._constaintRigidbodyA=e},get:function(){return this._constaintRigidbodyA}},{key:"constaintRigidbodyB",set:function(e){this._constaintRigidbodyB=e},get:function(){return this._constaintRigidbodyB}}],[{key:"__init__",value:function(){var e=F.Physics3D._bullet;X._btTempVector30=e.btVector3_create(0,0,0),X._btTempVector31=e.btVector3_create(0,0,0),X._btVector3Zero=e.btVector3_create(0,0,0),X._btInertia=e.btVector3_create(0,0,0),X._btImpulse=e.btVector3_create(0,0,0),X._btImpulseOffset=e.btVector3_create(0,0,0),X._btGravity=e.btVector3_create(0,0,0),X._btTransform0=e.btTransform_create()}}]),X}();Rt.TYPE_STATIC=0,Rt.TYPE_DYNAMIC=1,Rt.TYPE_KINEMATIC=2,Rt._BT_DISABLE_WORLD_GRAVITY=1,Rt._BT_ENABLE_GYROPSCOPIC_FORCE=2;var Ct=function(){function Y(){_classCallCheck(this,Y)}return _createClass(Y,null,[{key:"__bulletinit__",value:function(){this._bullet=window.Physics3D,this._bullet&&(ne.__init__(),Q.__init__(),ie.__init__(),ze.__init__(),Et.__init__(),he.__init__(),Oe.__init__(),yt.__init__(),Rt.__init__())}},{key:"__cannoninit__",value:function(){this._cannon=window.CANNON,this._cannon&&(t.CannonColliderShape.__init__(),t.CannonPhysicsComponent.__init__(),t.CannonPhysicsSimulation.__init__(),t.CannonBoxColliderShape.__init__(),t.CannonRigidbody3D.__init__())}}]),Y}();Ct._bullet=null,Ct._cannon=null,Ct._enablePhysics=!1;var It=function(){function j(){_classCallCheck(this,j),this._defaultPhysicsMemory=16,this._maxLightCount=32,this._lightClusterCount=new D(12,12,12),this._editerEnvironment=!1,this.isAntialias=!0,this.isAlpha=!1,this.premultipliedAlpha=!0,this.isStencil=!0,this.enableMultiLight=!0,this.octreeCulling=!1,this.octreeInitialSize=64,this.octreeInitialCenter=new D(0,0,0),this.octreeMinNodeSize=2,this.octreeLooseness=1.25,this.debugFrustumCulling=!1,this.pbrRenderQuality=e.PBRRenderQuality.High,this.isUseCannonPhysicsEngine=!1,this._maxAreaLightCountPerClusterAverage=Math.min(4*Math.floor(2048/this._lightClusterCount.z-1),this._maxLightCount)}return _createClass(j,[{key:"cloneTo",value:function(e){var t=e;t._defaultPhysicsMemory=this._defaultPhysicsMemory,t._editerEnvironment=this._editerEnvironment,t.isAntialias=this.isAntialias,t.isAlpha=this.isAlpha,t.premultipliedAlpha=this.premultipliedAlpha,t.isStencil=this.isStencil,t.octreeCulling=this.octreeCulling,this.octreeInitialCenter.cloneTo(t.octreeInitialCenter),t.octreeInitialSize=this.octreeInitialSize,t.octreeMinNodeSize=this.octreeMinNodeSize,t.octreeLooseness=this.octreeLooseness,t.debugFrustumCulling=this.debugFrustumCulling,t.maxLightCount=this.maxLightCount,t.enableMultiLight=this.enableMultiLight;var n=t.lightClusterCount;this.lightClusterCount.cloneTo(n),t.lightClusterCount=n,t.pbrRenderQuality=this.pbrRenderQuality}},{key:"clone",value:function(){var e=new j;return this.cloneTo(e),e}},{key:"defaultPhysicsMemory",get:function(){return this._defaultPhysicsMemory},set:function(e){if(e<16)throw"defaultPhysicsMemory must large than 16M";this._defaultPhysicsMemory=e}},{key:"maxLightCount",get:function(){return this._maxLightCount},set:function(e){e>2048?(this._maxLightCount=2048,console.warn("Config3D: maxLightCount must less equal 2048.")):this._maxLightCount=e}},{key:"lightClusterCount",get:function(){return this._lightClusterCount},set:function(e){e.x>128||e.y>128||e.z>128?(this._lightClusterCount.setValue(Math.min(e.x,128),Math.min(e.y,128),Math.min(e.z,128)),console.warn("Config3D: lightClusterCount X and YZ must less equal 128.")):e.cloneTo(this._lightClusterCount);var t=4*Math.floor(2048/this._lightClusterCount.z-1);t<this._maxLightCount&&console.warn("Config3D: if the area light(PointLightSpotLight) count is large than "+t+",maybe the far away culster will ingonre some light."),this._maxAreaLightCountPerClusterAverage=Math.min(t,this._maxLightCount)}}],[{key:"useCannonPhysics",get:function(){return j._config.isUseCannonPhysicsEngine},set:function(e){j._config.isUseCannonPhysicsEngine=e,e&&(Ct.__cannoninit__(),F.Scene3D.cannonPhysicsSettings||(F.Scene3D.cannonPhysicsSettings=new t.CannonPhysicsSettings))}}]),j}();It._config=new It,window.Config3D=It;var Dt=function(){function Z(){_classCallCheck(this,Z),this._ownerPath=[],this._propertys=[],this._keyFrames=[]}return _createClass(Z,[{key:"_setOwnerPathCount",value:function(e){this._ownerPath.length=e}},{key:"_setOwnerPathByIndex",value:function(e,t){this._ownerPath[e]=t}},{key:"_joinOwnerPath",value:function(e){return this._ownerPath.join(e)}},{key:"_setPropertyCount",value:function(e){this._propertys.length=e}},{key:"_setPropertyByIndex",value:function(e,t){this._propertys[e]=t}},{key:"_joinProperty",value:function(e){return this._propertys.join(e)}},{key:"_setKeyframeCount",value:function(e){this._keyFrames.length=e}},{key:"_setKeyframeByIndex",value:function(e,t){this._keyFrames[e]=t}},{key:"getOwnerPathByIndex",value:function(e){return this._ownerPath[e]}},{key:"getPropertyByIndex",value:function(e){return this._propertys[e]}},{key:"getKeyframeByIndex",value:function(e){return this._keyFrames[e]}},{key:"ownerPathCount",get:function(){return this._ownerPath.length}},{key:"propertyCount",get:function(){return this._propertys.length}},{key:"keyFramesCount",get:function(){return this._keyFrames.length}}]),Z}(),Lt=function q(){_classCallCheck(this,q)},Pt=function(){function Q(){_classCallCheck(this,Q)}return _createClass(Q,[{key:"cloneTo",value:function(e){e.time=this.time}},{key:"clone",value:function(){var e=new Q;return this.cloneTo(e),e}}]),Q}(),Bt=function(e){function K(){return _classCallCheck(this,K),_possibleConstructorReturn(this,_getPrototypeOf(K).call(this))}return _inherits(K,Pt),_createClass(K,[{key:"cloneTo",value:function(e){_get(_getPrototypeOf(K.prototype),"cloneTo",this).call(this,e);var t=e;t.inTangent=this.inTangent,t.outTangent=this.outTangent,t.value=this.value}}]),K}(),zt=function(e){function J(){var e;return _classCallCheck(this,J),(e=_possibleConstructorReturn(this,_getPrototypeOf(J).call(this))).inTangent=new o,e.outTangent=new o,e.value=new Z,e}return _inherits(J,Pt),_createClass(J,[{key:"cloneTo",value:function(e){_get(_getPrototypeOf(J.prototype),"cloneTo",this).call(this,e);var t=e;this.inTangent.cloneTo(t.inTangent),this.outTangent.cloneTo(t.outTangent),this.value.cloneTo(t.value)}}]),J}(),Yt=function(e){function $(){var e;return _classCallCheck(this,$),(e=_possibleConstructorReturn(this,_getPrototypeOf($).call(this))).inTangent=new D,e.outTangent=new D,e.value=new D,e}return _inherits($,Pt),_createClass($,[{key:"cloneTo",value:function(e){_get(_getPrototypeOf($.prototype),"cloneTo",this).call(this,e);var t=e;this.inTangent.cloneTo(t.inTangent),this.outTangent.cloneTo(t.outTangent),this.value.cloneTo(t.value)}}]),$}(),rn=function(){function ee(){_classCallCheck(this,ee)}return _createClass(ee,null,[{key:"READ_DATA",value:function(){ee._DATA.offset=ee._reader.getUint32(),ee._DATA.size=ee._reader.getUint32()}},{key:"READ_BLOCK",value:function(){for(var e=ee._BLOCK.count=ee._reader.getUint16(),t=ee._BLOCK.blockStarts=[],n=ee._BLOCK.blockLengths=[],i=0;i<e;i++)t.push(ee._reader.getUint32()),n.push(ee._reader.getUint32())}},{key:"READ_STRINGS",value:function(){var e=ee._reader.getUint32(),t=ee._reader.getUint16(),n=ee._reader.pos;ee._reader.pos=e+ee._DATA.offset;for(var i=0;i<t;i++)ee._strings[i]=ee._reader.readUTFString();ee._reader.pos=n}},{key:"parse",value:function(e,t){ee._animationClip=e,ee._reader=t,ee.READ_DATA(),ee.READ_BLOCK(),ee.READ_STRINGS();for(var n=0,i=ee._BLOCK.count;n<i;n++){var r=t.getUint16(),a=ee._strings[r],o=ee["READ_"+a];if(null==o)throw new Error("model file err,no this function:"+r+" "+a);o.call(null)}}},{key:"READ_ANIMATIONS",value:function(){var e,t,n,i=ee._reader,r=[],a=i.getUint16();for(r.length=a,e=0;e<a;e++)r[e]=i.getFloat32();var o=ee._animationClip;o.name=ee._strings[i.getUint16()];var s=o._duration=i.getFloat32();o.islooping=!!i.getByte(),o._frameRate=i.getInt16();var l=i.getInt16(),u=o._nodes;u.count=l;var _=o._nodesMap={},c=o._nodesDic={};for(e=0;e<l;e++){n=new Dt,u.setNodeByIndex(e,n),n._indexInList=e;var h=n.type=i.getUint8(),d=i.getUint16();for(n._setOwnerPathCount(d),t=0;t<d;t++)n._setOwnerPathByIndex(t,ee._strings[i.getUint16()]);var f=n._joinOwnerPath("/"),m=_[f];m||(_[f]=m=[]),m.push(n),n.propertyOwner=ee._strings[i.getUint16()];var p=i.getUint16();for(n._setPropertyCount(p),t=0;t<p;t++)n._setPropertyByIndex(t,ee._strings[i.getUint16()]);var v=f+"."+n.propertyOwner+"."+n._joinProperty(".");c[v]=n,n.fullPath=v;var E=i.getUint16();for(n._setKeyframeCount(E),t=0;t<E;t++)switch(h){case 0:var T=new Bt;n._setKeyframeByIndex(t,T),T.time=r[i.getUint16()],T.inTangent=i.getFloat32(),T.outTangent=i.getFloat32(),T.value=i.getFloat32();break;case 1:case 3:case 4:var g=new Yt;n._setKeyframeByIndex(t,g),g.time=r[i.getUint16()];var y=g.inTangent,S=g.outTangent,R=g.value;y.x=i.getFloat32(),y.y=i.getFloat32(),y.z=i.getFloat32(),S.x=i.getFloat32(),S.y=i.getFloat32(),S.z=i.getFloat32(),R.x=i.getFloat32(),R.y=i.getFloat32(),R.z=i.getFloat32();break;case 2:var C=new zt;n._setKeyframeByIndex(t,C),C.time=r[i.getUint16()];var A=C.inTangent,I=C.outTangent,x=C.value;A.x=i.getFloat32(),A.y=i.getFloat32(),A.z=i.getFloat32(),A.w=i.getFloat32(),I.x=i.getFloat32(),I.y=i.getFloat32(),I.z=i.getFloat32(),I.w=i.getFloat32(),x.x=i.getFloat32(),x.y=i.getFloat32(),x.z=i.getFloat32(),x.w=i.getFloat32();break;default:throw"AnimationClipParser03:unknown type."}}var D=i.getUint16();for(e=0;e<D;e++){var M=new Lt;M.time=Math.min(s,i.getFloat32()),M.eventName=ee._strings[i.getUint16()];var L=[],O=i.getUint16();for(O>0&&(M.params=L=[]),t=0;t<O;t++)switch(i.getByte()){case 0:L.push(!!i.getByte());break;case 1:L.push(i.getInt32());break;case 2:L.push(i.getFloat32());break;case 3:L.push(ee._strings[i.getUint16()]);break;default:throw new Error("unknown type.")}o.addEvent(M)}}}]),ee}();rn._strings=[],rn._BLOCK={count:0},rn._DATA={offset:0,size:0};var an=function(){function te(){_classCallCheck(this,te)}return _createClass(te,null,[{key:"READ_DATA",value:function(){te._DATA.offset=te._reader.getUint32(),te._DATA.size=te._reader.getUint32()}},{key:"READ_BLOCK",value:function(){for(var e=te._BLOCK.count=te._reader.getUint16(),t=te._BLOCK.blockStarts=[],n=te._BLOCK.blockLengths=[],i=0;i<e;i++)t.push(te._reader.getUint32()),n.push(te._reader.getUint32())}},{key:"READ_STRINGS",value:function(){var e=te._reader.getUint32(),t=te._reader.getUint16(),n=te._reader.pos;te._reader.pos=e+te._DATA.offset;for(var i=0;i<t;i++)te._strings[i]=te._reader.readUTFString();te._reader.pos=n}},{key:"parse",value:function(e,t,n){te._animationClip=e,te._reader=t,te._version=n,te.READ_DATA(),te.READ_BLOCK(),te.READ_STRINGS();for(var i=0,r=te._BLOCK.count;i<r;i++){var a=t.getUint16(),o=te._strings[a],s=te["READ_"+o];if(null==s)throw new Error("model file err,no this function:"+a+" "+o);s.call(null)}te._version=null,te._reader=null,te._animationClip=null}},{key:"READ_ANIMATIONS",value:function(){var e,n,i,r=te._reader,a=[],o=r.getUint16();for(a.length=o,e=0;e<o;e++)a[e]=r.getFloat32();var s=te._animationClip;s.name=te._strings[r.getUint16()];var l=s._duration=r.getFloat32();s.islooping=!!r.getByte(),s._frameRate=r.getInt16();var u=r.getInt16(),_=s._nodes;_.count=u;var c=s._nodesMap={},h=s._nodesDic={};for(e=0;e<u;e++){i=new Dt,_.setNodeByIndex(e,i),i._indexInList=e;var d=i.type=r.getUint8(),f=r.getUint16();for(i._setOwnerPathCount(f),n=0;n<f;n++)i._setOwnerPathByIndex(n,te._strings[r.getUint16()]);var m=i._joinOwnerPath("/"),p=c[m];p||(c[m]=p=[]),p.push(i),i.propertyOwner=te._strings[r.getUint16()];var v=r.getUint16();for(i._setPropertyCount(v),n=0;n<v;n++)i._setPropertyByIndex(n,te._strings[r.getUint16()]);var E=m+"."+i.propertyOwner+"."+i._joinProperty(".");h[E]=i,i.fullPath=E;var T=r.getUint16();switch(i._setKeyframeCount(T),te._version){case"LAYAANIMATION:04":for(n=0;n<T;n++)switch(d){case 0:var g=new Bt;i._setKeyframeByIndex(n,g),g.time=a[r.getUint16()],g.inTangent=r.getFloat32(),g.outTangent=r.getFloat32(),g.value=r.getFloat32();break;case 1:case 3:case 4:var y=new Yt;i._setKeyframeByIndex(n,y),y.time=a[r.getUint16()];var S=y.inTangent,R=y.outTangent,C=y.value;S.x=r.getFloat32(),S.y=r.getFloat32(),S.z=r.getFloat32(),R.x=r.getFloat32(),R.y=r.getFloat32(),R.z=r.getFloat32(),C.x=r.getFloat32(),C.y=r.getFloat32(),C.z=r.getFloat32();break;case 2:var A=new zt;i._setKeyframeByIndex(n,A),A.time=a[r.getUint16()];var I=A.inTangent,x=A.outTangent,D=A.value;I.x=r.getFloat32(),I.y=r.getFloat32(),I.z=r.getFloat32(),I.w=r.getFloat32(),x.x=r.getFloat32(),x.y=r.getFloat32(),x.z=r.getFloat32(),x.w=r.getFloat32(),D.x=r.getFloat32(),D.y=r.getFloat32(),D.z=r.getFloat32(),D.w=r.getFloat32();break;default:throw"AnimationClipParser04:unknown type."}break;case"LAYAANIMATION:COMPRESSION_04":for(n=0;n<T;n++)switch(d){case 0:g=new Bt,i._setKeyframeByIndex(n,g),g.time=a[r.getUint16()],g.inTangent=t.HalfFloatUtils.convertToNumber(r.getUint16()),g.outTangent=t.HalfFloatUtils.convertToNumber(r.getUint16()),g.value=t.HalfFloatUtils.convertToNumber(r.getUint16());break;case 1:case 3:case 4:y=new Yt,i._setKeyframeByIndex(n,y),y.time=a[r.getUint16()],S=y.inTangent,R=y.outTangent,C=y.value,S.x=t.HalfFloatUtils.convertToNumber(r.getUint16()),S.y=t.HalfFloatUtils.convertToNumber(r.getUint16()),S.z=t.HalfFloatUtils.convertToNumber(r.getUint16()),R.x=t.HalfFloatUtils.convertToNumber(r.getUint16()),R.y=t.HalfFloatUtils.convertToNumber(r.getUint16()),R.z=t.HalfFloatUtils.convertToNumber(r.getUint16()),C.x=t.HalfFloatUtils.convertToNumber(r.getUint16()),C.y=t.HalfFloatUtils.convertToNumber(r.getUint16()),C.z=t.HalfFloatUtils.convertToNumber(r.getUint16());break;case 2:A=new zt,i._setKeyframeByIndex(n,A),A.time=a[r.getUint16()],I=A.inTangent,x=A.outTangent,D=A.value,I.x=t.HalfFloatUtils.convertToNumber(r.getUint16()),I.y=t.HalfFloatUtils.convertToNumber(r.getUint16()),I.z=t.HalfFloatUtils.convertToNumber(r.getUint16()),I.w=t.HalfFloatUtils.convertToNumber(r.getUint16()),x.x=t.HalfFloatUtils.convertToNumber(r.getUint16()),x.y=t.HalfFloatUtils.convertToNumber(r.getUint16()),x.z=t.HalfFloatUtils.convertToNumber(r.getUint16()),x.w=t.HalfFloatUtils.convertToNumber(r.getUint16()),D.x=t.HalfFloatUtils.convertToNumber(r.getUint16()),D.y=t.HalfFloatUtils.convertToNumber(r.getUint16()),D.z=t.HalfFloatUtils.convertToNumber(r.getUint16()),D.w=t.HalfFloatUtils.convertToNumber(r.getUint16());break;default:throw"AnimationClipParser04:unknown type."}}}var M=r.getUint16();for(e=0;e<M;e++){var L=new Lt;L.time=Math.min(l,r.getFloat32()),L.eventName=te._strings[r.getUint16()];var O=[],N=r.getUint16();for(N>0&&(L.params=O=[]),n=0;n<N;n++)switch(r.getByte()){case 0:O.push(!!r.getByte());break;case 1:O.push(r.getInt32());break;case 2:O.push(r.getFloat32());break;case 3:O.push(te._strings[r.getUint16()]);break;default:throw new Error("unknown type.")}s.addEvent(L)}}}]),te}();an._strings=[],an._BLOCK={count:0},an._DATA={offset:0,size:0};var on=function(){function ie(){_classCallCheck(this,ie),this._nodes=[]}return _createClass(ie,[{key:"getNodeByIndex",value:function(e){return this._nodes[e]}},{key:"setNodeByIndex",value:function(e,t){this._nodes[e]=t}},{key:"count",get:function(){return this._nodes.length},set:function(e){this._nodes.length=e}}]),ie}(),sn=function(e){function re(){var e;return _classCallCheck(this,re),(e=_possibleConstructorReturn(this,_getPrototypeOf(re).call(this)))._duration=0,e._frameRate=0,e._nodes=new on,e.islooping=!1,e._animationEvents=[],e}return _inherits(re,t.Resource),_createClass(re,[{key:"duration",value:function(){return this._duration}},{key:"_hermiteInterpolate",value:function(e,t,n,i){var r=e.outTangent,a=t.inTangent;if(Number.isFinite(r)&&Number.isFinite(a)){var o=n*n,s=o*n,l=s-2*o+n,u=s-o,_=-2*s+3*o;return(2*s-3*o+1)*e.value+l*r*i+u*a*i+_*t.value}return e.value}},{key:"_hermiteInterpolateVector3",value:function(e,t,n,i,r){var a=e.value,o=e.outTangent,s=t.value,l=t.inTangent,u=n*n,_=u*n,c=2*_-3*u+1,h=_-2*u+n,d=_-u,f=-2*_+3*u,m=o.x,p=l.x;Number.isFinite(m)&&Number.isFinite(p)?r.x=c*a.x+h*m*i+d*p*i+f*s.x:r.x=a.x,m=o.y,p=l.y,Number.isFinite(m)&&Number.isFinite(p)?r.y=c*a.y+h*m*i+d*p*i+f*s.y:r.y=a.y,m=o.z,p=l.z,Number.isFinite(m)&&Number.isFinite(p)?r.z=c*a.z+h*m*i+d*p*i+f*s.z:r.z=a.z}},{key:"_hermiteInterpolateQuaternion",value:function(e,t,n,i,r){var a=e.value,o=e.outTangent,s=t.value,l=t.inTangent,u=n*n,_=u*n,c=2*_-3*u+1,h=_-2*u+n,d=_-u,f=-2*_+3*u,m=o.x,p=l.x;Number.isFinite(m)&&Number.isFinite(p)?r.x=c*a.x+h*m*i+d*p*i+f*s.x:r.x=a.x,m=o.y,p=l.y,Number.isFinite(m)&&Number.isFinite(p)?r.y=c*a.y+h*m*i+d*p*i+f*s.y:r.y=a.y,m=o.z,p=l.z,Number.isFinite(m)&&Number.isFinite(p)?r.z=c*a.z+h*m*i+d*p*i+f*s.z:r.z=a.z,m=o.w,p=l.w,Number.isFinite(m)&&Number.isFinite(p)?r.w=c*a.w+h*m*i+d*p*i+f*s.w:r.w=a.w}},{key:"_evaluateClipDatasRealTime",value:function(e,t,n,i,r,a){for(var o=0,s=e.count;o<s;o++){var l,u=e.getNodeByIndex(o),_=u.type,c=u._keyFrames,h=c.length,d=n[o];if(r)for(-1!==d&&t<c[d].time&&(d=-1,n[o]=d),l=d+1;l<h&&!(c[l].time>t);)d++,l++,n[o]=d;else for((l=d+1)!==h&&t>c[l].time&&(d=h-1,n[o]=d),l=d+1;d>-1&&!(c[d].time<t);)d--,l--,n[o]=d;var f=l===h;switch(_){case 0:if(-1!==d){var m=c[d];if(f)a[o]=m.value;else{var p,v=c[l],E=v.time-m.time;p=0!==E?(t-m.time)/E:0,a[o]=this._hermiteInterpolate(m,v,p,E)}}else a[o]=c[0].value;i&&(a[o]=a[o]-c[0].value);break;case 1:case 4:var T=a[o];if(this._evaluateFrameNodeVector3DatasRealTime(c,d,f,t,T),i){var g=c[0].value;T.x-=g.x,T.y-=g.y,T.z-=g.z}break;case 2:var y=a[o];if(this._evaluateFrameNodeQuaternionDatasRealTime(c,d,f,t,y),i){var S=re._tempQuaternion0,R=c[0].value;gt.quaternionConjugate(R,S),Z.multiply(S,y,y)}break;case 3:T=a[o],this._evaluateFrameNodeVector3DatasRealTime(c,d,f,t,T),i&&(g=c[0].value,T.x/=g.x,T.y/=g.y,T.z/=g.z);break;default:throw"AnimationClip:unknown node type."}}}},{key:"_evaluateClipDatasRealTimeForNative",value:function(e,n,i,r){t.LayaGL.instance.evaluateClipDatasRealTime(e._nativeObj,n,i,r)}},{key:"_evaluateFrameNodeVector3DatasRealTime",value:function(e,t,n,i,r){if(-1!==t){var a=e[t];if(n){var o=a.value;r.x=o.x,r.y=o.y,r.z=o.z}else{var s,l=e[t+1],u=a.time,_=l.time-u;s=0!==_?(i-u)/_:0,this._hermiteInterpolateVector3(a,l,s,_,r)}}else{var c=e[0].value;r.x=c.x,r.y=c.y,r.z=c.z}}},{key:"_evaluateFrameNodeQuaternionDatasRealTime",value:function(e,t,n,i,r){if(-1!==t){var a=e[t];if(n){var o=a.value;r.x=o.x,r.y=o.y,r.z=o.z,r.w=o.w}else{var s,l=e[t+1],u=a.time,_=l.time-u;s=0!==_?(i-u)/_:0,this._hermiteInterpolateQuaternion(a,l,s,_,r)}}else{var c=e[0].value;r.x=c.x,r.y=c.y,r.z=c.z,r.w=c.w}}},{key:"_binarySearchEventIndex",value:function(e){for(var t,n=0,i=this._animationEvents.length-1;n<=i;){t=Math.floor((n+i)/2);var r=this._animationEvents[t].time;if(r==e)return t;r>e?i=t-1:n=t+1}return n}},{key:"addEvent",value:function(e){var t=this._binarySearchEventIndex(e.time);this._animationEvents.splice(t,0,e)}},{key:"_disposeResource",value:function(){this._nodes=null,this._nodesMap=null}}],[{key:"_parse",value:function(e){var n=new re,i=new t.Byte(e),r=i.readUTFString();switch(r){case"LAYAANIMATION:03":rn.parse(n,i);break;case"LAYAANIMATION:04":case"LAYAANIMATION:COMPRESSION_04":an.parse(n,i,r);break;default:throw"unknown animationClip version."}return n}},{key:"load",value:function(e,n){t.ILaya.loader.create(e,n,null,re.ANIMATIONCLIP)}}]),re}();sn.ANIMATIONCLIP="ANIMATIONCLIP",sn._tempQuaternion0=new Z;var ln=function(){function ne(){_classCallCheck(this,ne),this._currentState=null}return _createClass(ne,[{key:"_resetPlayState",value:function(e,t){this._finish=!1,this._startPlayTime=e,this._elapsedTime=e,this._playEventIndex=0,this._lastIsFront=!0,this._normalizedTime=this._elapsedTime/t;var n=this._normalizedTime%1;this._normalizedPlayTime=n<0?n+1:n}},{key:"_cloneTo",value:function(e){e._finish=this._finish,e._startPlayTime=this._startPlayTime,e._elapsedTime=this._elapsedTime,e._normalizedTime=this._normalizedTime,e._normalizedPlayTime=this._normalizedPlayTime,e._playEventIndex=this._playEventIndex,e._lastIsFront=this._lastIsFront}},{key:"normalizedTime",get:function(){return this._normalizedTime}},{key:"duration",get:function(){return this._duration}},{key:"animatorState",get:function(){return this._currentState}}]),ne}(),un=function(){function ae(e){_classCallCheck(this,ae),this._referenceCount=0,this._playType=-1,this._crossDuration=-1,this._crossMark=0,this._crossNodesOwnersCount=0,this._crossNodesOwners=[],this._crossNodesOwnersIndicesMap={},this._srcCrossClipNodeIndices=[],this._destCrossClipNodeIndices=[],this._statesMap={},this._states=[],this._playStateInfo=new ln,this._crossPlayStateInfo=new ln,this.blendingMode=ae.BLENDINGMODE_OVERRIDE,this.defaultWeight=1,this.playOnWake=!0,this.name=e}return _createClass(ae,[{key:"_removeClip",value:function(e,t,n,i){var r=i._clip,a=e[n];if(e.splice(n,1),delete t[i.name],this._animator){var o=r._nodes,s=a._nodeOwners;r._removeReference();for(var l=0,u=o.count;l<u;l++)this._animator._removeKeyframeNodeOwner(s,o.getNodeByIndex(l))}}},{key:"_getReferenceCount",value:function(){return this._referenceCount}},{key:"_addReference",value:function(){for(var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,t=0,n=this._states.length;t<n;t++)this._states[t]._addReference(e);this._referenceCount+=e}},{key:"_removeReference",value:function(){for(var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,t=0,n=this._states.length;t<n;t++)this._states[t]._removeReference(e);this._referenceCount-=e}},{key:"_clearReference",value:function(){this._removeReference(-this._referenceCount)}},{key:"getCurrentPlayState",value:function(){return this._playStateInfo}},{key:"getAnimatorState",value:function(e){return this._statesMap[e]||null}},{key:"addState",value:function(e){var t=e.name;if(this._statesMap[t])throw"AnimatorControllerLayer:this stat's name has exist.";this._statesMap[t]=e,this._states.push(e),this._animator&&(e._clip._addReference(),this._animator._getOwnersByClip(e))}},{key:"removeState",value:function(e){for(var t=this._states,n=-1,i=0,r=t.length;i<r;i++)if(t[i]===e){n=i;break}-1!==n&&this._removeClip(t,this._statesMap,n,e)}},{key:"destroy",value:function(){this._clearReference(),this._statesMap=null,this._states=[],this._playStateInfo=null,this._crossPlayStateInfo=null,this._defaultState=null}},{key:"cloneTo",value:function(e){var t=e;t.name=this.name,t.blendingMode=this.blendingMode,t.defaultWeight=this.defaultWeight,t.playOnWake=this.playOnWake}},{key:"clone",value:function(){var e=new ae(this.name);return this.cloneTo(e),e}},{key:"defaultState",get:function(){return this._defaultState},set:function(e){this._defaultState=e,this._statesMap[e.name]=e}}]),ae}();un.BLENDINGMODE_OVERRIDE=0,un.BLENDINGMODE_ADDTIVE=1;var _n=function(){function se(){_classCallCheck(this,se),this._referenceCount=0,this._clip=null,this._nodeOwners=[],this._currentFrameIndices=null,this._realtimeDatas=[],this._scripts=null,this.speed=1,this.clipStart=0,this.clipEnd=1}return _createClass(se,[{key:"_getReferenceCount",value:function(){return this._referenceCount}},{key:"_addReference",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;this._clip&&this._clip._addReference(e),this._referenceCount+=e}},{key:"_removeReference",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;this._clip&&this._clip._removeReference(e),this._referenceCount-=e}},{key:"_clearReference",value:function(){this._removeReference(-this._referenceCount)}},{key:"_resetFrameIndices",value:function(){for(var e=0,t=this._currentFrameIndices.length;e<t;e++)this._currentFrameIndices[e]=-1}},{key:"addScript",value:function(e){var t=new e;return this._scripts=this._scripts||[],this._scripts.push(t),t}},{key:"getScript",value:function(e){if(this._scripts)for(var t=0,n=this._scripts.length;t<n;t++){var i=this._scripts[t];if(i instanceof e)return i}return null}},{key:"getScripts",value:function(e){var t=null;if(this._scripts)for(var n=0,i=this._scripts.length;n<i;n++){var r=this._scripts[n];r instanceof e&&(t=t||[]).push(r)}return t}},{key:"cloneTo",value:function(e){var t=e;t.name=this.name,t.speed=this.speed,t.clipStart=this.clipStart,t.clipEnd=this.clipEnd,t.clip=this._clip}},{key:"clone",value:function(){var e=new se;return this.cloneTo(e),e}},{key:"clip",get:function(){return this._clip},set:function(e){if(this._clip!==e){if(this._clip&&this._referenceCount>0&&this._clip._removeReference(this._referenceCount),e){var t=this._realtimeDatas,n=e._nodes,i=n.count;this._currentFrameIndices=new Int16Array(i),this._resetFrameIndices(),this._referenceCount>0&&e._addReference(this._referenceCount),this._realtimeDatas.length=i;for(var r=0;r<i;r++)switch(n.getNodeByIndex(r).type){case 0:break;case 1:case 3:case 4:t[r]=new D;break;case 2:t[r]=new Z;break;default:throw"AnimationClipParser04:unknown type."}}this._clip=e}}}]),se}(),cn=function(){function oe(){_classCallCheck(this,oe),this.indexInList=-1,this.referenceCount=0,this.updateMark=-1,this.type=-1,this.fullPath=null,this.propertyOwner=null,this.property=null,this.defaultValue=null,this.value=null,this.crossFixedValue=null}return _createClass(oe,[{key:"saveCrossFixedValue",value:function(){if(this.propertyOwner)switch(this.type){case 0:this.crossFixedValue=this.value;break;case 1:case 3:case 4:case 2:this.value.cloneTo(this.crossFixedValue);break;default:throw"Animator:unknown type."}}}]),oe}(),hn=function(e){function le(){var e;return _classCallCheck(this,le),(e=_possibleConstructorReturn(this,_getPrototypeOf(le).call(this)))._keyframeNodeOwners=[],e._linkAvatarSpritesData={},e._linkAvatarSprites=[],e._renderableSprites=[],e.cullingMode=le.CULLINGMODE_CULLCOMPLETELY,e._controllerLayers=[],e._linkSprites={},e._speed=1,e._keyframeNodeOwnerMap={},e._updateMark=0,e}return _inherits(le,t.Component),_createClass(le,[{key:"_linkToSprites",value:function(e){for(var t in e){for(var n=this.owner,i=e[t],r=0,a=i.length;r<a;r++){var o=i[r];if(""===o)break;if(!(n=n.getChildByName(o)))break}n&&this.linkSprite3DToAvatarNode(t,n)}}},{key:"_addKeyframeNodeOwner",value:function(e,t,n){var i=t._indexInList,r=t.fullPath,a=this._keyframeNodeOwnerMap[r];if(a)a.referenceCount++,e[i]=a;else{for(var o=n,s=0,l=t.propertyCount;s<l&&(o=o[t.getPropertyByIndex(s)]);s++);(a=this._keyframeNodeOwnerMap[r]=new cn).fullPath=r,a.indexInList=this._keyframeNodeOwners.length,a.referenceCount=1,a.propertyOwner=n;var u=t.propertyCount,_=[];for(s=0;s<u;s++)_[s]=t.getPropertyByIndex(s);if(a.property=_,a.type=t.type,o)if(0===t.type)a.defaultValue=o;else{var c=new o.constructor;o.cloneTo(c),a.defaultValue=c,a.value=new o.constructor,a.crossFixedValue=new o.constructor}this._keyframeNodeOwners.push(a),e[i]=a}}},{key:"_removeKeyframeNodeOwner",value:function(e,t){var n=t.fullPath,i=this._keyframeNodeOwnerMap[n];i&&(i.referenceCount--,0===i.referenceCount&&(delete this._keyframeNodeOwnerMap[n],this._keyframeNodeOwners.splice(this._keyframeNodeOwners.indexOf(i),1)),e[t._indexInList]=null)}},{key:"_getOwnersByClip",value:function(e){var t=e._clip._nodes,n=t.count,i=e._nodeOwners;i.length=n;for(var r=0;r<n;r++){for(var a=t.getNodeByIndex(r),o=this._avatar?this._avatarNodeMap[this._avatar._rootNode.name]:this.owner,s=0,l=a.ownerPathCount;s<l;s++){var u=a.getOwnerPathByIndex(s);if(""===u)break;if(!(o=o.getChildByName(u)))break}if(o){var _=a.propertyOwner;_&&(o=o[_]),o&&this._addKeyframeNodeOwner(i,a,o)}}}},{key:"_updatePlayer",value:function(e,t,n,i){var r=e._clip._duration*(e.clipEnd-e.clipStart),a=t._elapsedTime,o=a+n;t._lastElapsedTime=a,t._elapsedTime=o;var s=o/r;t._normalizedTime=s;var l=s%1;t._normalizedPlayTime=l<0?l+1:l,t._duration=r;var u=e._scripts;if(!i&&o>=r){if(t._finish=!0,t._elapsedTime=r,t._normalizedPlayTime=1,u)for(var _=0,c=u.length;_<c;_++)u[_].onStateExit()}else if(u)for(_=0,c=u.length;_<c;_++)u[_].onStateUpdate()}},{key:"_eventScript",value:function(e,t,n,i,r){if(r)for(var a=t.length;n<a;n++){var o=t[n];if(!(o.time<=i))break;for(var s=0,l=e.length;s<l;s++){var u=e[s],_=u[o.eventName];_&&_.apply(u,o.params)}}else for(;n>=0&&(o=t[n]).time>=i;n--)for(s=0,l=e.length;s<l;s++)(_=(u=e[s])[o.eventName])&&_.apply(u,o.params);return n}},{key:"_updateEventScript",value:function(e,t){var n=this.owner._scripts;if(n){var i=e._clip,r=i._animationEvents,a=i._duration,o=t._elapsedTime,s=o%a,l=Math.abs(Math.floor(o/a)-Math.floor(t._lastElapsedTime/a)),u=t._elapsedTime>=t._lastElapsedTime;t._lastIsFront!==u&&(u?t._playEventIndex++:t._playEventIndex--,t._lastIsFront=u);var _=t._playEventIndex;if(u){var c=this._eventScript(n,r,t._playEventIndex,l>0?a:s,!0);_===t._playEventIndex&&(t._playEventIndex=c);for(var h=0,d=l-1;h<d;h++)this._eventScript(n,r,0,a,!0);l>0&&s>0&&(t._playEventIndex=this._eventScript(n,r,0,s,!0))}else{c=this._eventScript(n,r,t._playEventIndex,l>0?0:s,!1),_===t._playEventIndex&&(t._playEventIndex=c);var f=r.length-1;for(h=0,d=l-1;h<d;h++)this._eventScript(n,r,f,0,!1);l>0&&s>0&&(t._playEventIndex=this._eventScript(n,r,f,s,!1))}}}},{key:"_updateClipDatas",value:function(e,t,n){var i=e._clip,r=i._duration,a=e.clipStart*r+n._normalizedPlayTime*n._duration,o=e._currentFrameIndices,s=n._elapsedTime>n._lastElapsedTime;i._evaluateClipDatasRealTime(i._nodes,a,o,t,s,e._realtimeDatas)}},{key:"_applyFloat",value:function(e,t,n,i,r,a,o){if(n.updateMark===this._updateMark)if(i)e[t]+=r*o;else{var s=e[t];e[t]=s+r*(o-s)}else if(a)e[t]=i?n.defaultValue+o:o;else if(i)e[t]=n.defaultValue+r*o;else{var l=n.defaultValue;e[t]=l+r*(o-l)}}},{key:"_applyPositionAndRotationEuler",value:function(e,t,n,i,r,a){if(e.updateMark===this._updateMark)if(t)a.x+=n*r.x,a.y+=n*r.y,a.z+=n*r.z;else{var o=a.x,s=a.y,l=a.z;a.x=o+n*(r.x-o),a.y=s+n*(r.y-s),a.z=l+n*(r.z-l)}else if(i)if(t){var u=e.defaultValue;a.x=u.x+r.x,a.y=u.y+r.y,a.z=u.z+r.z}else a.x=r.x,a.y=r.y,a.z=r.z;else if(u=e.defaultValue,t)a.x=u.x+n*r.x,a.y=u.y+n*r.y,a.z=u.z+n*r.z;else{var _=u.x,c=u.y,h=u.z;a.x=_+n*(r.x-_),a.y=c+n*(r.y-c),a.z=h+n*(r.z-h)}}},{key:"_applyRotation",value:function(e,t,n,i,r,a){if(e.updateMark===this._updateMark)if(t){var o=le._tempQuaternion1;gt.quaternionWeight(r,n,o),o.normalize(o),Z.multiply(a,o,a)}else Z.lerp(a,r,n,a);else if(i)if(t){var s=e.defaultValue;Z.multiply(s,r,a)}else a.x=r.x,a.y=r.y,a.z=r.z,a.w=r.w;else s=e.defaultValue,t?(o=le._tempQuaternion1,gt.quaternionWeight(r,n,o),o.normalize(o),Z.multiply(s,o,a)):Z.lerp(s,r,n,a)}},{key:"_applyScale",value:function(e,t,n,i,r,a){if(e.updateMark===this._updateMark)if(t){var o=le._tempVector31;gt.scaleWeight(r,n,o),a.x=a.x*o.x,a.y=a.y*o.y,a.z=a.z*o.z}else gt.scaleBlend(a,r,n,a);else if(i)if(t){var s=e.defaultValue;a.x=s.x*r.x,a.y=s.y*r.y,a.z=s.z*r.z}else a.x=r.x,a.y=r.y,a.z=r.z;else s=e.defaultValue,t?(o=le._tempVector31,gt.scaleWeight(r,n,o),a.x=s.x*o.x,a.y=s.y*o.y,a.z=s.z*o.z):gt.scaleBlend(s,r,n,a)}},{key:"_applyCrossData",value:function(e,t,n,i,r,a,o){var s=e.propertyOwner;if(s){switch(e.type){case 0:for(var l=e.property,u=l.length-1,_=0;_<u&&(s=s[l[_]]);_++);var c=r+o*(a-r);e.value=c,s&&this._applyFloat(s,l[u],e,t,n,i,c);break;case 1:var h=s.localPosition,d=e.value,f=r.x,m=r.y,p=r.z;d.x=f+o*(a.x-f),d.y=m+o*(a.y-m),d.z=p+o*(a.z-p),this._applyPositionAndRotationEuler(e,t,n,i,d,h),s.localPosition=h;break;case 2:var v=s.localRotation,E=e.value;Z.lerp(r,a,o,E),this._applyRotation(e,t,n,i,E,v),s.localRotation=v;break;case 3:var T=s.localScale,g=e.value;gt.scaleBlend(r,a,o,g),this._applyScale(e,t,n,i,g,T),s.localScale=T;break;case 4:var y=s.localRotationEuler,S=e.value;f=r.x,m=r.y,p=r.z,S.x=f+o*(a.x-f),S.y=m+o*(a.y-m),S.z=p+o*(a.z-p),this._applyPositionAndRotationEuler(e,t,n,i,S,y),s.localRotationEuler=y}e.updateMark=this._updateMark}}},{key:"_setClipDatasToNode",value:function(e,t,n,i){for(var r=e._realtimeDatas,a=e._clip._nodes,o=e._nodeOwners,s=0,l=a.count;s<l;s++){var u=o[s];if(u){var _=u.propertyOwner;if(_){switch(u.type){case 0:for(var c=u.property,h=c.length-1,d=0;d<h&&(_=_[c[d]]);d++);_&&this._applyFloat(_,c[h],u,t,n,i,r[s]);break;case 1:var f=_.localPosition;this._applyPositionAndRotationEuler(u,t,n,i,r[s],f),_.localPosition=f;break;case 2:var m=_.localRotation;this._applyRotation(u,t,n,i,r[s],m),_.localRotation=m;break;case 3:var p=_.localScale;this._applyScale(u,t,n,i,r[s],p),_.localScale=p;break;case 4:var v=_.localRotationEuler;this._applyPositionAndRotationEuler(u,t,n,i,r[s],v),_.localRotationEuler=v}u.updateMark=this._updateMark}}}}},{key:"_setCrossClipDatasToNode",value:function(e,t,n,i,r){for(var a=e._crossNodesOwners,o=e._crossNodesOwnersCount,s=e.blendingMode!==un.BLENDINGMODE_OVERRIDE,l=e.defaultWeight,u=n._realtimeDatas,_=e._destCrossClipNodeIndices,c=n._nodeOwners,h=t._realtimeDatas,d=e._srcCrossClipNodeIndices,f=t._nodeOwners,m=0;m<o;m++){var p=a[m];if(p){var v=d[m],E=_[m],T=-1!==v?h[v]:c[E].defaultValue,g=-1!==E?u[E]:f[v].defaultValue;this._applyCrossData(p,s,l,r,T,g,i)}}}},{key:"_setFixedCrossClipDatasToNode",value:function(e,t,n,i){for(var r=e._crossNodesOwners,a=e._crossNodesOwnersCount,o=e.blendingMode!==un.BLENDINGMODE_OVERRIDE,s=e.defaultWeight,l=t._realtimeDatas,u=e._destCrossClipNodeIndices,_=0;_<a;_++){var c=r[_];if(c){var h=u[_],d=c.crossFixedValue,f=-1!==h?l[h]:c.defaultValue;this._applyCrossData(c,o,s,i,d,f,n)}}}},{key:"_revertDefaultKeyframeNodes",value:function(e){for(var t=e._nodeOwners,n=0,i=t.length;n<i;n++){var r=t[n];if(r){var a=r.propertyOwner;if(a)switch(r.type){case 0:for(var o=r.property,s=o.length-1,l=0;l<s&&(a=a[o[l]]);l++);a[o[s]]=r.defaultValue;break;case 1:var u=a.localPosition,_=r.defaultValue;u.x=_.x,u.y=_.y,u.z=_.z,a.localPosition=u;break;case 2:var c=a.localRotation,h=r.defaultValue;c.x=h.x,c.y=h.y,c.z=h.z,c.w=h.w,a.localRotation=c;break;case 3:var d=a.localScale;_=r.defaultValue,d.x=_.x,d.y=_.y,d.z=_.z,a.localScale=d;break;case 4:var f=a.localRotationEuler;_=r.defaultValue,f.x=_.x,f.y=_.y,f.z=_.z,a.localRotationEuler=f;break;default:throw"Animator:unknown type."}}}}},{key:"_onAdded",value:function(){var e=this.owner._parent;this.owner._setHierarchyAnimator(this,e?e._hierarchyAnimator:null),this.owner._changeAnimatorToLinkSprite3DNoAvatar(this,!0,[])}},{key:"_onDestroy",value:function(){for(var e=0,t=this._controllerLayers.length;e<t;e++)this._controllerLayers[e]._removeReference();var n=this.owner._parent;this.owner._clearHierarchyAnimator(this,n?n._hierarchyAnimator:null)}},{key:"_onEnable",value:function(){this.owner._scene._animatorPool.add(this);for(var e=0,t=this._controllerLayers.length;e<t;e++)this._controllerLayers[e].playOnWake&&this.getDefaultState(e)&&this.play(null,e,0)}},{key:"_onDisable",value:function(){this.owner._scene._animatorPool.remove(this)}},{key:"_handleSpriteOwnersBySprite",value:function(e,t,n){for(var i=0,r=this._controllerLayers.length;i<r;i++)for(var a=this._controllerLayers[i]._states,o=0,s=a.length;o<s;o++){var l=a[o],u=l._clip,_=t.join("/"),c=u._nodesMap[_];if(c)for(var h=l._nodeOwners,d=0,f=c.length;d<f;d++)e?this._addKeyframeNodeOwner(h,c[d],n):this._removeKeyframeNodeOwner(h,c[d])}}},{key:"_parse",value:function(e){var n=e.avatar;if(n){this.avatar=t.Loader.getRes(n.path);var i=n.linkSprites;this._linkSprites=i,this._linkToSprites(i)}for(var r=e.playOnWake,a=e.layers,o=0;o<a.length;o++){var s=a[o],l=new un(s.name);l.defaultWeight=0===o?1:s.weight;var u=s.blendingMode;u&&(l.blendingMode=u),this.addControllerLayer(l);for(var _=s.states,c=0,h=_.length;c<h;c++){var d=_[c],f=d.clipPath;if(f){var m,p=d.name;if(m=t.Loader.getRes(f)){var v=new _n;v.name=p,v.clip=m,l.addState(v),0===c&&(this.getControllerLayer(o).defaultState=v)}}}void 0!==r&&(l.playOnWake=r)}var E=e.cullingMode;void 0!==E&&(this.cullingMode=E)}},{key:"_update",value:function(){var e=this.owner._scene.timer._delta/1e3;if(0!==this._speed&&0!==e){var t;if(this.cullingMode===le.CULLINGMODE_CULLCOMPLETELY){t=!1;for(var n=0,i=this._renderableSprites.length;n<i;n++)if(this._renderableSprites[n]._render.isRender){t=!0;break}}else t=!0;for(this._updateMark++,n=0,i=this._controllerLayers.length;n<i;n++){var r=this._controllerLayers[n],a=r._playStateInfo,o=r._crossPlayStateInfo;switch(c=r.blendingMode!==un.BLENDINGMODE_OVERRIDE,r._playType){case 0:var s=a._currentState,l=s._clip,u=this._speed*s.speed,_=a._finish;if(_||this._updatePlayer(s,a,e*u,l.islooping),t){var c=r.blendingMode!==un.BLENDINGMODE_OVERRIDE;this._updateClipDatas(s,c,a),this._setClipDatasToNode(s,c,r.defaultWeight,0===n),_||this._updateEventScript(s,a)}break;case 1:l=(s=a._currentState)._clip;var h=r._crossPlayState,d=h._clip,f=r._crossDuration,m=o._startPlayTime,p=d._duration-m,v=f>p?p/f:1,E=this._speed*h.speed;this._updatePlayer(h,o,e*v*E,d.islooping);var T=(o._elapsedTime-m)/v/f;T>=1?t&&(this._updateClipDatas(h,c,o),this._setClipDatasToNode(h,c,r.defaultWeight,0===n),r._playType=0,a._currentState=h,o._cloneTo(a)):(a._finish||(u=this._speed*s.speed,this._updatePlayer(s,a,e*u,l.islooping),t&&this._updateClipDatas(s,c,a)),t&&(this._updateClipDatas(h,c,o),this._setCrossClipDatasToNode(r,s,h,T,0===n))),t&&(this._updateEventScript(s,a),this._updateEventScript(h,o));break;case 2:d=(h=r._crossPlayState)._clip,f=r._crossDuration,m=o._startPlayTime,v=f>(p=d._duration-m)?p/f:1,E=this._speed*h.speed,this._updatePlayer(h,o,e*v*E,d.islooping),t&&((T=(o._elapsedTime-m)/v/f)>=1?(this._updateClipDatas(h,c,o),this._setClipDatasToNode(h,c,1,0===n),r._playType=0,a._currentState=h,o._cloneTo(a)):(this._updateClipDatas(h,c,o),this._setFixedCrossClipDatasToNode(r,h,T,0===n)),this._updateEventScript(h,o))}}t&&this._avatar&&this._updateAvatarNodesToSprite()}}},{key:"_cloneTo",value:function(e){var t=e;t.avatar=this.avatar,t.cullingMode=this.cullingMode;for(var n=0,i=this._controllerLayers.length;n<i;n++){var r=this._controllerLayers[n];t.addControllerLayer(r.clone());for(var a=r._states,o=0,s=a.length;o<s;o++){var l=a[o].clone(),u=t.getControllerLayer(n);u.addState(l),0==o&&(u.defaultState=l)}}t._linkSprites=this._linkSprites,t._linkToSprites(this._linkSprites)}},{key:"getDefaultState",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return this._controllerLayers[e].defaultState}},{key:"addState",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;this._controllerLayers[t].addState(e),console.warn("Animator:this function is discard,please use animatorControllerLayer.addState() instead.")}},{key:"removeState",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;this._controllerLayers[t].removeState(e),console.warn("Animator:this function is discard,please use animatorControllerLayer.removeState() instead.")}},{key:"addControllerLayer",value:function(e){this._controllerLayers.push(e),e._animator=this,e._addReference();for(var t=e._states,n=0,i=t.length;n<i;n++)this._getOwnersByClip(t[n])}},{key:"getControllerLayer",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return this._controllerLayers[e]}},{key:"play",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Number.NEGATIVE_INFINITY,i=this._controllerLayers[t];if(i){var r=i.defaultState;if(!e&&!r)throw new Error("Animator:must have default clip value,please set clip property.");var a=i._playStateInfo,o=a._currentState,s=e?i._statesMap[e]:r,l=s._clip._duration,u=s._clip._duration*(s.clipEnd-s.clipStart);o!==s?(n!==Number.NEGATIVE_INFINITY?a._resetPlayState(l*n,u):a._resetPlayState(0,u),null!==o&&o!==s&&this._revertDefaultKeyframeNodes(o),i._playType=0,a._currentState=s):n!==Number.NEGATIVE_INFINITY&&(a._resetPlayState(l*n,u),i._playType=0);var _=s._scripts;if(_)for(var c=0,h=_.length;c<h;c++)_[c].onStateEnter()}else console.warn("Invalid layerIndex "+t+".")}},{key:"crossFade",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:Number.NEGATIVE_INFINITY,r=this._controllerLayers[n];if(r){var a=r._statesMap[e];if(a){var o=r._playType;if(-1===o)return void this.play(e,n,i);var s=r._crossPlayStateInfo,l=r._crossNodesOwners,u=r._crossNodesOwnersIndicesMap,_=r._playStateInfo._currentState,c=a._nodeOwners,h=r._destCrossClipNodeIndices,d=a._clip,f=d._nodes,m=d._nodesDic,p=0;switch(o){case 0:var v=_._nodeOwners,E=r._srcCrossClipNodeIndices,T=_._clip,g=T._nodes,y=T._nodesDic;r._playType=1;var S=++r._crossMark;p=r._crossNodesOwnersCount=0;for(var R=0,C=g.count;R<C;R++){var A=g.getNodeByIndex(R),I=A._indexInList,x=v[I];if(x){var D=A.fullPath;E[p]=I;var M=m[D];h[p]=M?M._indexInList:-1,u[D]=S,l[p]=x,p++}}for(R=0,C=f.count;R<C;R++){var L=(M=f.getNodeByIndex(R))._indexInList,O=c[L];if(O){var N=M.fullPath;y[N]||(E[p]=-1,h[p]=L,u[N]=S,l[p]=O,p++)}}break;case 1:case 2:for(r._playType=2,R=0,C=l.length;R<C;R++){var P=l[R];P.saveCrossFixedValue(),M=m[P.fullPath],h[R]=M?M._indexInList:-1}for(p=r._crossNodesOwnersCount,S=r._crossMark,R=0,C=f.count;R<C;R++)(O=c[L=(M=f.getNodeByIndex(R))._indexInList])&&u[N=M.fullPath]!==S&&(h[p]=L,u[N]=S,P=c[L],l[p]=P,P.saveCrossFixedValue(),p++)}r._crossNodesOwnersCount=p,r._crossPlayState=a,r._crossDuration=_._clip._duration*t,i!==Number.NEGATIVE_INFINITY?s._resetPlayState(d._duration*i,r._crossDuration):s._resetPlayState(0,r._crossDuration);var b=a._scripts;if(b)for(R=0,C=b.length;R<C;R++)b[R].onStateEnter()}else console.warn("Invalid name "+n+".")}else console.warn("Invalid layerIndex "+n+".")}},{key:"getCurrentAnimatorPlayState",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return this._controllerLayers[e]._playStateInfo}},{key:"_isLinkSpriteToAnimationNodeData",value:function(e,t,n){var i=this._linkAvatarSpritesData[t];if(n)i||(this._linkAvatarSpritesData[t]=i=[]),i.push(e);else{var r=i.indexOf(e);i.splice(r,1)}}},{key:"_getAvatarOwnersAndInitDatasAsync",value:function(){for(var e=0,t=this._controllerLayers.length;e<t;e++)for(var n=this._controllerLayers[e]._states,i=0,r=n.length;i<r;i++)this._getOwnersByClip(n[i]);for(var a in this._avatar._cloneDatasToAnimator(this),this._linkAvatarSpritesData){var o=this._linkAvatarSpritesData[a];if(o)for(var s=0,l=o.length;s<l;s++)this._isLinkSpriteToAnimationNode(o[s],a,!0)}}},{key:"_isLinkSpriteToAnimationNode",value:function(e,t,n){if(this._avatar){var i=this._avatarNodeMap[t];if(i)if(n){e._transform._dummy=i.transform,this._linkAvatarSprites.push(e);var r=i.transform,a=e.transform;if(!a.owner.isStatic&&r){var o=a.worldMatrix,s=this.owner._transform._parent;if(s)gt.matrix4x4MultiplyMFM(s.worldMatrix,r.getWorldMatrix(),o);else for(var l=o.elements,u=r.getWorldMatrix(),_=0;_<16;_++)l[_]=u[_];a.worldMatrix=o}}else e._transform._dummy=null,this._linkAvatarSprites.splice(this._linkAvatarSprites.indexOf(e),1)}}},{key:"_updateAvatarNodesToSprite",value:function(){for(var e=0,t=this._linkAvatarSprites.length;e<t;e++){var n=this._linkAvatarSprites[e],i=n.transform._dummy,r=n.transform;if(!r.owner.isStatic&&i){var a=r.worldMatrix,o=this.owner._transform;gt.matrix4x4MultiplyMFM(o.worldMatrix,i.getWorldMatrix(),a),r.worldMatrix=a}}}},{key:"linkSprite3DToAvatarNode",value:function(e,t){return this._isLinkSpriteToAnimationNodeData(t,e,!0),this._isLinkSpriteToAnimationNode(t,e,!0),!0}},{key:"unLinkSprite3DToAvatarNode",value:function(e){var t=e.transform._dummy;if(t){var n=t._owner.name;return this._isLinkSpriteToAnimationNodeData(e,n,!1),this._isLinkSpriteToAnimationNode(e,n,!1),!0}return!1}},{key:"_updateAnimationNodeWorldMatix",value:function(e,n,i,r,a){t.LayaGL.instance.updateAnimationNodeWorldMatix(e,n,i,a,r)}},{key:"speed",get:function(){return this._speed},set:function(e){this._speed=e}},{key:"avatar",get:function(){return this._avatar},set:function(e){if(this._avatar!==e)if(this._avatar=e,e)this._getAvatarOwnersAndInitDatasAsync(),this.owner._changeHierarchyAnimatorAvatar(this,e);else{var t=this.owner._parent;this.owner._changeHierarchyAnimatorAvatar(this,t?t._hierarchyAnimator._avatar:null)}}}],[{key:"_update",value:function(e){for(var t=e._animatorPool,n=t.elements,i=0,r=t.length;i<r;i++){var a=n[i];a&&a.enabled&&a._update()}}}]),le}();hn._tempVector31=new D,hn._tempQuaternion1=new Z,hn.CULLINGMODE_ALWAYSANIMATE=0,hn.CULLINGMODE_CULLCOMPLETELY=2;var dn=function he(){_classCallCheck(this,he),this.invertY=!1,this.configPipeLineMode="Forward"};dn._instance=new dn;var fn=function(e){function _e(e,n){var i,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:t.RenderTextureFormat.R8G8B8,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:t.RenderTextureDepthFormat.DEPTH_16;return _classCallCheck(this,_e),(i=_possibleConstructorReturn(this,_getPrototypeOf(_e).call(this,r,!1)))._inPool=!1,i._isCameraTarget=!1,i._glTextureType=t.LayaGL.instance.TEXTURE_2D,i._width=e,i._height=n,i._depthStencilFormat=a,i._mipmapCount=1,i._create(e,n),i}return _inherits(_e,t.BaseTexture),_createClass(_e,[{key:"_create",value:function(e,n){var i=t.LayaGL.instance,r=i,a=this._glTextureType,o=t.LayaGL.layaGPUInstance,s=o._isWebGL2,l=this._format;if(this._frameBuffer=i.createFramebuffer(),i.bindFramebuffer(i.FRAMEBUFFER,this._frameBuffer),l!==t.RenderTextureFormat.Depth&&l!==t.RenderTextureFormat.ShadowMap){switch(t.WebGLContext.bindTexture(i,a,this._glTexture),l){case t.RenderTextureFormat.R8G8B8:s?r.texStorage2D(a,this._mipmapCount,r.RGB8,e,n):i.texImage2D(a,0,i.RGB,e,n,0,i.RGB,i.UNSIGNED_BYTE,null);break;case t.RenderTextureFormat.R8G8B8A8:s?r.texStorage2D(a,this._mipmapCount,r.RGBA8,e,n):i.texImage2D(a,0,i.RGBA,e,n,0,i.RGBA,i.UNSIGNED_BYTE,null);break;case t.RenderTextureFormat.Alpha8:s?r.texStorage2D(a,0,r.R8,e,n):i.texImage2D(a,0,i.ALPHA,e,n,0,i.ALPHA,i.UNSIGNED_BYTE,null);break;case t.RenderTextureFormat.R16G16B16A16:s?r.texStorage2D(a,this._mipmapCount,r.RGBA16F,e,n):i.texImage2D(a,0,i.RGBA,e,n,0,i.RGBA,o._oesTextureHalfFloat.HALF_FLOAT_OES,null)}i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,i.TEXTURE_2D,this._glTexture,0)}if(l==t.RenderTextureFormat.Depth||l==t.RenderTextureFormat.ShadowMap){switch(t.WebGLContext.bindTexture(i,a,this._glTexture),this._depthStencilFormat){case t.RenderTextureDepthFormat.DEPTH_16:s?r.texStorage2D(a,this._mipmapCount,r.DEPTH_COMPONENT16,e,n):i.texImage2D(a,0,i.DEPTH_COMPONENT,e,n,0,i.DEPTH_COMPONENT,i.UNSIGNED_SHORT,null),i.framebufferTexture2D(i.FRAMEBUFFER,i.DEPTH_ATTACHMENT,i.TEXTURE_2D,this._glTexture,0);break;case t.RenderTextureDepthFormat.DEPTHSTENCIL_24_8:s?r.texStorage2D(a,this._mipmapCount,r.DEPTH24_STENCIL8,e,n):i.texImage2D(a,0,i.DEPTH_STENCIL,e,n,0,i.DEPTH_STENCIL,o._webgl_depth_texture.UNSIGNED_INT_24_8_WEBGL,null),i.framebufferTexture2D(i.FRAMEBUFFER,i.DEPTH_STENCIL_ATTACHMENT,i.TEXTURE_2D,this._glTexture,0);break;default:throw"RenderTexture: depth format RenderTexture must use depthFormat with DEPTH_16 and DEPTHSTENCIL_16_8."}s&&l==t.RenderTextureFormat.ShadowMap&&r.texParameteri(a,r.TEXTURE_COMPARE_MODE,r.COMPARE_REF_TO_TEXTURE)}else if(this._depthStencilFormat!==t.RenderTextureDepthFormat.DEPTHSTENCIL_NONE){switch(this._depthStencilBuffer=i.createRenderbuffer(),i.bindRenderbuffer(i.RENDERBUFFER,this._depthStencilBuffer),this._depthStencilFormat){case t.RenderTextureDepthFormat.DEPTH_16:i.renderbufferStorage(i.RENDERBUFFER,i.DEPTH_COMPONENT16,e,n),i.framebufferRenderbuffer(i.FRAMEBUFFER,i.DEPTH_ATTACHMENT,i.RENDERBUFFER,this._depthStencilBuffer);break;case t.RenderTextureDepthFormat.STENCIL_8:i.renderbufferStorage(i.RENDERBUFFER,i.STENCIL_INDEX8,e,n),i.framebufferRenderbuffer(i.FRAMEBUFFER,i.STENCIL_ATTACHMENT,i.RENDERBUFFER,this._depthStencilBuffer);break;case t.RenderTextureDepthFormat.DEPTHSTENCIL_24_8:i.renderbufferStorage(i.RENDERBUFFER,i.DEPTH_STENCIL,e,n),i.framebufferRenderbuffer(i.FRAMEBUFFER,i.DEPTH_STENCIL_ATTACHMENT,i.RENDERBUFFER,this._depthStencilBuffer);break;default:throw"RenderTexture: unkonw depth format."}i.bindRenderbuffer(i.RENDERBUFFER,null)}i.bindFramebuffer(i.FRAMEBUFFER,null),this._setWarpMode(i.TEXTURE_WRAP_S,this._wrapModeU),this._setWarpMode(i.TEXTURE_WRAP_T,this._wrapModeV),this._setFilterMode(this._filterMode),this._setAnisotropy(this._anisoLevel),this._readyed=!0,this._activeResource(),this._setGPUMemory(e*n*4)}},{key:"_start",value:function(){var e=t.LayaGL.instance;e.bindFramebuffer(e.FRAMEBUFFER,this._frameBuffer),_e._currentActive=this,this._isCameraTarget&&(dn._instance.invertY=!0),this._readyed=!1}},{key:"_end",value:function(){var e=t.LayaGL.instance;e.bindFramebuffer(e.FRAMEBUFFER,null),_e._currentActive=null,this._isCameraTarget&&(dn._instance.invertY=!1),this._readyed=!0}},{key:"getData",value:function(e,n,i,r,a){if(t.Render.isConchApp&&2==window.conchConfig.threadMode)throw"native 2 thread mode use getDataAsync";var o=t.LayaGL.instance;return o.bindFramebuffer(o.FRAMEBUFFER,this._frameBuffer),o.checkFramebufferStatus(o.FRAMEBUFFER)===o.FRAMEBUFFER_COMPLETE?(o.readPixels(e,n,i,r,o.RGBA,o.UNSIGNED_BYTE,a),o.bindFramebuffer(o.FRAMEBUFFER,null),a):(o.bindFramebuffer(o.FRAMEBUFFER,null),null)}},{key:"_disposeResource",value:function(){if(this._frameBuffer){var e=t.LayaGL.instance;e.deleteTexture(this._glTexture),e.deleteFramebuffer(this._frameBuffer),e.deleteRenderbuffer(this._depthStencilBuffer),this._glTexture=null,this._frameBuffer=null,this._depthStencilBuffer=null,this._setGPUMemory(0)}}},{key:"getDataAsync",value:function(e,n,i,r,a){var o=t.LayaGL.instance;o.bindFramebuffer(o.FRAMEBUFFER,this._frameBuffer),o.readPixelsAsync(e,n,i,r,o.RGBA,o.UNSIGNED_BYTE,function(e){a(new Uint8Array(e))}),o.bindFramebuffer(o.FRAMEBUFFER,null)}},{key:"depthStencilFormat",get:function(){return this._depthStencilFormat}},{key:"defaulteTexture",get:function(){return t.Texture2D.grayTexture}}],[{key:"createFromPool",value:function(e,n){for(var i,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:t.RenderTextureFormat.R8G8B8,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:t.RenderTextureDepthFormat.DEPTH_16,o=0,s=_e._pool.length;o<s;o++)if((i=_e._pool[o])._width==e&&i._height==n&&i._format==r&&i._depthStencilFormat==a){i._inPool=!1;var l=_e._pool[s-1];return _e._pool[o]=l,_e._pool.length-=1,i}return(i=new _e(e,n,r,a)).lock=!0,i}},{key:"recoverToPool",value:function(e){e._inPool||(_e._pool.push(e),e._inPool=!0)}},{key:"currentActive",get:function(){return _e._currentActive}}]),_e}();fn._pool=[];var mn=function(){function ce(){_classCallCheck(this,ce),this._mask=[],this._length=0}return _createClass(ce,[{key:"_intersectionDefineDatas",value:function(e){for(var t=e._mask,n=this._mask,i=this._length-1;i>=0;i--){var r=n[i]&t[i];0==r&&i==this._length-1?this._length--:n[i]=r}}},{key:"add",value:function(e){var t=e._index,n=t+1,i=this._mask,r=this._length;if(r<n){for(i.length<n&&(i.length=n);r<t;r++)i[r]=0;i[t]=e._value,this._length=n}else i[t]|=e._value}},{key:"remove",value:function(e){var t=e._index,n=this._mask,i=this._length-1;if(!(t>i)){var r=n[t]&~e._value;t==i&&0===r?this._length--:n[t]=r}}},{key:"addDefineDatas",value:function(e){var t=e._mask,n=e._length,i=this._mask,r=this._length;if(r<n){i.length=n;for(var a=0;a<r;a++)i[a]|=t[a];for(;a<n;a++)i[a]=t[a];this._length=n}else for(a=0;a<n;a++)i[a]|=t[a]}},{key:"removeDefineDatas",value:function(e){for(var t=e._mask,n=this._mask,i=this._length-1,r=Math.min(e._length,i);r>=0;r--){var a=n[r]&~t[r];r==i&&0===a?(i--,this._length--):n[r]=a}}},{key:"has",value:function(e){var t=e._index;return!(t>=this._length)&&0!=(this._mask[t]&e._value)}},{key:"clear",value:function(){this._length=0}},{key:"cloneTo",value:function(e){var t=e,n=t._mask,i=this._mask,r=this._length;n.length=r;for(var a=0;a<r;a++)n[a]=i[a];t._length=r}},{key:"clone",value:function(){var e=new ce;return this.cloneTo(e),e}}]),ce}(),pn=function(e){function de(e,n){var i,r=arguments.length>2&&void 0!==arguments[2]&&arguments[2];_classCallCheck(this,de),(i=_possibleConstructorReturn(this,_getPrototypeOf(de).call(this)))._vertexDeclaration=null,i._float32Reader=null;var a=t.LayaGL.instance;return i._bufferUsage=n,i._bufferType=a.ARRAY_BUFFER,i._canRead=r,i._byteLength=e,i.bind(),a.bufferData(i._bufferType,i._byteLength,i._bufferUsage),r&&(i._buffer=new Uint8Array(e),i._float32Reader=new Float32Array(i._buffer.buffer)),i}return _inherits(de,t.Buffer),_createClass(de,[{key:"bind",value:function(){if(t.Buffer._bindedVertexBuffer!==this._glBuffer){var e=t.LayaGL.instance;return e.bindBuffer(e.ARRAY_BUFFER,this._glBuffer),t.Buffer._bindedVertexBuffer=this._glBuffer,!0}return!1}},{key:"orphanStorage",value:function(){this.bind(),t.LayaGL.instance.bufferData(this._bufferType,this._byteLength,this._bufferUsage)}},{key:"setData",value:function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:Number.MAX_SAFE_INTEGER;if(this.bind(),0!==i||r!==Number.MAX_SAFE_INTEGER){var a=new Uint8Array(e,i,r);t.LayaGL.instance.bufferSubData(this._bufferType,n,a),this._canRead&&this._buffer.set(a,n)}else t.LayaGL.instance.bufferSubData(this._bufferType,n,e),this._canRead&&this._buffer.set(new Uint8Array(e),n)}},{key:"getUint8Data",value:function(){if(this._canRead)return this._buffer;throw new Error("Can't read data from VertexBuffer with only write flag!")}},{key:"getFloat32Data",value:function(){if(this._canRead)return this._float32Reader;throw new Error("Can't read data from VertexBuffer with only write flag!")}},{key:"markAsUnreadbale",value:function(){this._canRead=!1,this._buffer=null,this._float32Reader=null}},{key:"destroy",value:function(){_get(_getPrototypeOf(de.prototype),"destroy",this).call(this),this._buffer=null,this._float32Reader=null,this._vertexDeclaration=null,this._byteLength=0}},{key:"vertexDeclaration",get:function(){return this._vertexDeclaration},set:function(e){this._vertexDeclaration=e}},{key:"canRead",get:function(){return this._canRead}}]),de}();pn.DATATYPE_FLOAT32ARRAY=0,pn.DATATYPE_UINT8ARRAY=1;var vn=function(){function ue(){_classCallCheck(this,ue)}return _createClass(ue,null,[{key:"__init__",value:function(){var e=t.LayaGL.instance;ue._elementInfos={single:[1,e.FLOAT,0],vector2:[2,e.FLOAT,0],vector3:[3,e.FLOAT,0],vector4:[4,e.FLOAT,0],color:[4,e.FLOAT,0],byte4:[4,e.UNSIGNED_BYTE,0],short2:[2,e.FLOAT,0],short4:[4,e.FLOAT,0],normalizedshort2:[2,e.FLOAT,0],normalizedshort4:[4,e.FLOAT,0],halfvector2:[2,e.FLOAT,0],halfvector4:[4,e.FLOAT,0]}}},{key:"getElementInfos",value:function(e){var t=ue._elementInfos[e];if(t)return t;throw"VertexElementFormat: this vertexElementFormat is not implement."}}]),ue}();vn.Single="single",vn.Vector2="vector2",vn.Vector3="vector3",vn.Vector4="vector4",vn.Color="color",vn.Byte4="byte4",vn.Short2="short2",vn.Short4="short4",vn.NormalizedShort2="normalizedshort2",vn.NormalizedShort4="normalizedshort4",vn.HalfVector2="halfvector2",vn.HalfVector4="halfvector4";var En=function(){function me(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;_classCallCheck(this,me),this._ownerResource=null,this._data=null,this._defineDatas=new mn,this._runtimeCopyValues=[],this._ownerResource=e,this._initData()}return _createClass(me,[{key:"_initData",value:function(){this._data={}}},{key:"getData",value:function(){return this._data}},{key:"addDefine",value:function(e){this._defineDatas.add(e)}},{key:"removeDefine",value:function(e){this._defineDatas.remove(e)}},{key:"hasDefine",value:function(e){return this._defineDatas.has(e)}},{key:"clearDefine",value:function(){this._defineDatas.clear()}},{key:"getBool",value:function(e){return this._data[e]}},{key:"setBool",value:function(e,t){this._data[e]=t}},{key:"getInt",value:function(e){return this._data[e]}},{key:"setInt",value:function(e,t){this._data[e]=t}},{key:"getNumber",value:function(e){return this._data[e]}},{key:"setNumber",value:function(e,t){this._data[e]=t}},{key:"getVector2",value:function(e){return this._data[e]}},{key:"setVector2",value:function(e,t){this._data[e]=t}},{key:"getVector3",value:function(e){return this._data[e]}},{key:"setVector3",value:function(e,t){this._data[e]=t}},{key:"getVector",value:function(e){return this._data[e]}},{key:"setVector",value:function(e,t){this._data[e]=t}},{key:"getQuaternion",value:function(e){return this._data[e]}},{key:"setQuaternion",value:function(e,t){this._data[e]=t}},{key:"getMatrix4x4",value:function(e){return this._data[e]}},{key:"setMatrix4x4",value:function(e,t){this._data[e]=t}},{key:"getBuffer",value:function(e){return this._data[e]}},{key:"setBuffer",value:function(e,t){this._data[e]=t}},{key:"setTexture",value:function(e,t){var n=this._data[e];this._data[e]=t,this._ownerResource&&this._ownerResource.referenceCount>0&&(n&&n._removeReference(),t&&t._addReference())}},{key:"getTexture",value:function(e){return this._data[e]}},{key:"setAttribute",value:function(e,t){this._data[e]=t}},{key:"getAttribute",value:function(e){return this._data[e]}},{key:"getLength",value:function(){return this._data.length}},{key:"setLength",value:function(e){this._data.length=e}},{key:"cloneTo",value:function(e){var n=e,i=n._data;for(var a in this._data){var s=this._data[a];if(null!=s)if("number"==typeof s)i[a]=s;else if("number"==typeof s)i[a]=s;else if("boolean"==typeof s)i[a]=s;else if(s instanceof r){var l=i[a]||(i[a]=new r);s.cloneTo(l),i[a]=l}else if(s instanceof D){var u=i[a]||(i[a]=new D);s.cloneTo(u),i[a]=u}else if(s instanceof o){var _=i[a]||(i[a]=new o);s.cloneTo(_),i[a]=_}else if(s instanceof q){var c=i[a]||(i[a]=new q);s.cloneTo(c),i[a]=c}else s instanceof t.BaseTexture&&(i[a]=s)}this._defineDatas.cloneTo(n._defineDatas)}},{key:"clone",value:function(){var e=new me;return this.cloneTo(e),e}},{key:"cloneToForNative",value:function(e){var n=e;this._int32Data.length-n._int32Data.length>0&&n.needRenewArrayBufferForNative(this._int32Data.length),n._int32Data.set(this._int32Data,0);var i=n._nativeArray,a=this._nativeArray.length;i.length=a;for(var s=0;s<a;s++){var l=this._nativeArray[s];if(l)if("number"==typeof l)i[s]=l,n.setNumber(s,l);else if("number"==typeof l)i[s]=l,n.setInt(s,l);else if("boolean"==typeof l)i[s]=l,n.setBool(s,l);else if(l instanceof r){var u=i[s]||(i[s]=new r);l.cloneTo(u),i[s]=u,n.setVector2(s,u)}else if(l instanceof D){var _=i[s]||(i[s]=new D);l.cloneTo(_),i[s]=_,n.setVector3(s,_)}else if(l instanceof o){var c=i[s]||(i[s]=new o);l.cloneTo(c),i[s]=c,n.setVector(s,c)}else if(l instanceof q){var h=i[s]||(i[s]=new q);l.cloneTo(h),i[s]=h,n.setMatrix4x4(s,h)}else l instanceof t.BaseTexture&&(i[s]=l,n.setTexture(s,l))}this._defineDatas.cloneTo(n._defineDatas)}},{key:"_initDataForNative",value:function(){this._frameCount=-1,this._runtimeCopyValues.length=0,this._nativeArray=[],this._data=new ArrayBuffer(32),this._int32Data=new Int32Array(this._data),this._float32Data=new Float32Array(this._data),t.LayaGL.instance.createArrayBufferRef(this._data,t.LayaGL.ARRAY_BUFFER_TYPE_DATA,!0)}},{key:"needRenewArrayBufferForNative",value:function(e){if(e>=this._int32Data.length){var n=4*(e+1),i=this._int32Data,r=this._data.conchRef,a=this._data._ptrID;this._data=new ArrayBuffer(n),this._int32Data=new Int32Array(this._data),this._float32Data=new Float32Array(this._data),this._data.conchRef=r,this._data._ptrID=a,i&&this._int32Data.set(i,0);var o=t.LayaGL.instance;o.updateArrayBufferRef?o.updateArrayBufferRef(this._data._ptrID,r.isSyncToRender(),this._data):window.conch.updateArrayBufferRef(this._data._ptrID,r.isSyncToRender(),this._data)}}},{key:"getDataForNative",value:function(){return this._nativeArray}},{key:"getIntForNative",value:function(e){return this._int32Data[e]}},{key:"setIntForNative",value:function(e,t){this.needRenewArrayBufferForNative(e),this._int32Data[e]=t,this._nativeArray[e]=t}},{key:"getBoolForNative",value:function(e){return 1==this._int32Data[e]}},{key:"setBoolForNative",value:function(e,t){this.needRenewArrayBufferForNative(e),this._int32Data[e]=t?1:0,this._nativeArray[e]=t}},{key:"getNumberForNative",value:function(e){return this._float32Data[e]}},{key:"setNumberForNative",value:function(e,t){this.needRenewArrayBufferForNative(e),this._float32Data[e]=t,this._nativeArray[e]=t}},{key:"getMatrix4x4ForNative",value:function(e){return this._nativeArray[e]}},{key:"setMatrix4x4ForNative",value:function(e,t){this.needRenewArrayBufferForNative(e),this._nativeArray[e]=t;var n=this.setReferenceForNative(t.elements);this._int32Data[e]=n}},{key:"getVectorForNative",value:function(e){return this._nativeArray[e]}},{key:"setVectorForNative",value:function(e,t){this.needRenewArrayBufferForNative(e),this._nativeArray[e]=t,t.elements||t.forNativeElement();var n=this.setReferenceForNative(t.elements);this._int32Data[e]=n}},{key:"getVector2ForNative",value:function(e){return this._nativeArray[e]}},{key:"setVector2ForNative",value:function(e,t){this.needRenewArrayBufferForNative(e),this._nativeArray[e]=t,t.elements||t.forNativeElement();var n=this.setReferenceForNative(t.elements);this._int32Data[e]=n}},{key:"getVector3ForNative",value:function(e){return this._nativeArray[e]}},{key:"setVector3ForNative",value:function(e,t){this.needRenewArrayBufferForNative(e),this._nativeArray[e]=t,t.elements||t.forNativeElement();var n=this.setReferenceForNative(t.elements);this._int32Data[e]=n}},{key:"getQuaternionForNative",value:function(e){return this._nativeArray[e]}},{key:"setQuaternionForNative",value:function(e,t){this.needRenewArrayBufferForNative(e),this._nativeArray[e]=t,t.elements||t.forNativeElement();var n=this.setReferenceForNative(t.elements);this._int32Data[e]=n}},{key:"getBufferForNative",value:function(e){return this._nativeArray[e]}},{key:"setBufferForNative",value:function(e,t){this.needRenewArrayBufferForNative(e),this._nativeArray[e]=t;var n=this.setReferenceForNative(t);this._int32Data[e]=n}},{key:"getAttributeForNative",value:function(e){return this._nativeArray[e]}},{key:"setAttributeForNative",value:function(e,n){this._nativeArray[e]=n,n._ptrID||t.LayaGL.instance.createArrayBufferRef(n,t.LayaGL.ARRAY_BUFFER_TYPE_DATA,!0),t.LayaGL.instance.syncBufferToRenderThread(n),this._int32Data[e]=n._ptrID}},{key:"getTextureForNative",value:function(e){return this._nativeArray[e]}},{key:"setTextureForNative",value:function(e,t){if(t){this.needRenewArrayBufferForNative(e);var n=this._nativeArray[e];this._nativeArray[e]=t;var i=t._getSource()||t.defaulteTexture._getSource();this._int32Data[e]=i.id,this._ownerResource&&this._ownerResource.referenceCount>0&&(n&&n._removeReference(),t&&t._addReference())}}},{key:"setReferenceForNative",value:function(e){this.clearRuntimeCopyArray();var n=0,i=0;return me._SET_RUNTIME_VALUE_MODE_REFERENCE_?(t.LayaGL.instance.createArrayBufferRefs(e,t.LayaGL.ARRAY_BUFFER_TYPE_DATA,!0,t.LayaGL.ARRAY_BUFFER_REF_REFERENCE),n=0,i=e.getPtrID(n)):(t.LayaGL.instance.createArrayBufferRefs(e,t.LayaGL.ARRAY_BUFFER_TYPE_DATA,!0,t.LayaGL.ARRAY_BUFFER_REF_COPY),n=e.getRefNum()-1,i=e.getPtrID(n),this._runtimeCopyValues.push({obj:e,refID:n,ptrID:i})),t.LayaGL.instance.syncBufferToRenderThread(e,n),i}},{key:"clearRuntimeCopyArray",value:function(){var e=t.Stat.loopCount;if(this._frameCount!=e){this._frameCount=e;for(var n=0,i=this._runtimeCopyValues.length;n<i;n++)this._runtimeCopyValues[n].obj.clearRefNum();this._runtimeCopyValues.length=0}}}],[{key:"setRuntimeValueMode",value:function(e){me._SET_RUNTIME_VALUE_MODE_REFERENCE_=e}}]),me}();En._SET_RUNTIME_VALUE_MODE_REFERENCE_=!0;var Tn=function(){function fe(e,t){_classCallCheck(this,fe),this._id=++fe._uniqueIDCounter,this._vertexElementsDic={},this._vertexStride=e,this._vertexElements=t;var n=t.length;this._shaderValues=new En(null);for(var i=0;i<n;i++){var r=t[i],a=r._elementUsage;this._vertexElementsDic[a]=r;var o=new Int32Array(5),s=vn.getElementInfos(r._elementFormat);o[0]=s[0],o[1]=s[1],o[2]=s[2],o[3]=this._vertexStride,o[4]=r._offset,this._shaderValues.setAttribute(a,o)}}return _createClass(fe,[{key:"getVertexElementByIndex",value:function(e){return this._vertexElements[e]}},{key:"getVertexElementByUsage",value:function(e){return this._vertexElementsDic[e]}},{key:"id",get:function(){return this._id}},{key:"vertexStride",get:function(){return this._vertexStride}},{key:"vertexElementCount",get:function(){return this._vertexElements.length}}]),fe}();Tn._uniqueIDCounter=1;var gn=function(){function Te(e,t,n){_classCallCheck(this,Te),this._offset=e,this._elementFormat=t,this._elementUsage=n}return _createClass(Te,[{key:"offset",get:function(){return this._offset}},{key:"elementFormat",get:function(){return this._elementFormat}},{key:"elementUsage",get:function(){return this._elementUsage}}]),Te}(),yn=function(e){function Ee(){return _classCallCheck(this,Ee),_possibleConstructorReturn(this,_getPrototypeOf(Ee).call(this))}return _inherits(Ee,t.BufferStateBase),_createClass(Ee,[{key:"applyVertexBuffer",value:function(e){if(t.BufferStateBase._curBindedBufferState!==this)throw"BufferState: must call bind() function first.";var n=t.LayaGL.instance,i=e.vertexDeclaration,r=i._shaderValues.getData();for(var a in this.vertexDeclaration=i,e.bind(),r){var o=parseInt(a),s=r[a];n.enableVertexAttribArray(o),n.vertexAttribPointer(o,s[0],s[1],!!s[2],s[3],s[4])}}},{key:"applyVertexBuffers",value:function(e){if(t.BufferStateBase._curBindedBufferState!==this)throw"BufferState: must call bind() function first.";for(var n=t.LayaGL.instance,i=0,r=e.length;i<r;i++){var a=e[i],o=a.vertexDeclaration._shaderValues.getData();for(var s in a.bind(),o){var l=parseInt(s),u=o[s];n.enableVertexAttribArray(l),n.vertexAttribPointer(l,u[0],u[1],!!u[2],u[3],u[4])}}}},{key:"applyInstanceVertexBuffer",value:function(e){if(t.LayaGL.layaGPUInstance.supportInstance()){if(t.BufferStateBase._curBindedBufferState!==this)throw"BufferState: must call bind() function first.";var n=t.LayaGL.instance,i=e.vertexDeclaration._shaderValues.getData();for(var r in e.bind(),i){var a=parseInt(r),o=i[r];n.enableVertexAttribArray(a),n.vertexAttribPointer(a,o[0],o[1],!!o[2],o[3],o[4]),t.LayaGL.layaGPUInstance.vertexAttribDivisor(a,1)}}}},{key:"applyIndexBuffer",value:function(e){if(t.BufferStateBase._curBindedBufferState!==this)throw"BufferState: must call bind() function first.";this._bindedIndexBuffer!==e&&(e._bindForVAO(),this._bindedIndexBuffer=e)}}]),Ee}(),Sn=function(e){function pe(){var e;_classCallCheck(this,pe),(e=_possibleConstructorReturn(this,_getPrototypeOf(pe).call(this)))._bufferState=new yn,e._bufferStateInvertUV=new yn;var n=t.LayaGL.instance;return e._vertexBuffer=new pn(64,n.STATIC_DRAW,!1),e._vertexBuffer.vertexDeclaration=pe._vertexDeclaration,e._vertexBuffer.setData(pe._vertices.buffer),e._bufferState.bind(),e._bufferState.applyVertexBuffer(e._vertexBuffer),e._bufferState.unBind(),e._vertexBufferInvertUV=new pn(64,n.STATIC_DRAW,!1),e._vertexBufferInvertUV.vertexDeclaration=pe._vertexDeclaration,e._vertexBufferInvertUV.setData(pe._verticesInvertUV.buffer),e._bufferStateInvertUV.bind(),e._bufferStateInvertUV.applyVertexBuffer(e._vertexBufferInvertUV),e._bufferStateInvertUV.unBind(),e._setGPUMemory(e._vertexBuffer._byteLength+e._vertexBufferInvertUV._byteLength),e}return _inherits(pe,t.Resource),_createClass(pe,[{key:"render",value:function(){var e=t.LayaGL.instance;this._bufferState.bind(),e.drawArrays(e.TRIANGLE_STRIP,0,4),t.Stat.renderBatches++}},{key:"renderInvertUV",value:function(){var e=t.LayaGL.instance;this._bufferStateInvertUV.bind(),e.drawArrays(e.TRIANGLE_STRIP,0,4),t.Stat.renderBatches++}},{key:"destroy",value:function(){_get(_getPrototypeOf(pe.prototype),"destroy",this).call(this),this._bufferState.destroy(),this._vertexBuffer.destroy(),this._bufferStateInvertUV.destroy(),this._vertexBufferInvertUV.destroy(),this._setGPUMemory(0)}}],[{key:"__init__",value:function(){pe._vertexDeclaration=new Tn(16,[new gn(0,vn.Vector4,pe.SCREENQUAD_POSITION_UV)]),pe.instance=new pe,pe.instance.lock=!0}}]),pe}();Sn.SCREENQUAD_POSITION_UV=0,Sn._vertices=new Float32Array([1,1,1,1,1,-1,1,0,-1,1,0,1,-1,-1,0,0]),Sn._verticesInvertUV=new Float32Array([1,1,1,0,1,-1,1,1,-1,1,0,0,-1,-1,0,1]);var Rn=function(e){function ge(){var e;_classCallCheck(this,ge),(e=_possibleConstructorReturn(this,_getPrototypeOf(ge).call(this)))._bufferState=new yn,e._bufferStateInvertUV=new yn;var n=t.LayaGL.instance;return e._vertexBuffer=new pn(48,n.STATIC_DRAW,!1),e._vertexBuffer.vertexDeclaration=ge._vertexDeclaration,e._vertexBuffer.setData(ge._vertices.buffer),e._bufferState.bind(),e._bufferState.applyVertexBuffer(e._vertexBuffer),e._bufferState.unBind(),e._vertexBufferInvertUV=new pn(48,n.STATIC_DRAW,!1),e._vertexBufferInvertUV.vertexDeclaration=ge._vertexDeclaration,e._vertexBufferInvertUV.setData(ge._verticesInvertUV.buffer),e._bufferStateInvertUV.bind(),e._bufferStateInvertUV.applyVertexBuffer(e._vertexBufferInvertUV),e._bufferStateInvertUV.unBind(),e._setGPUMemory(e._vertexBuffer._byteLength+e._vertexBufferInvertUV._byteLength),e}return _inherits(ge,t.Resource),_createClass(ge,[{key:"render",value:function(){var e=t.LayaGL.instance;this._bufferState.bind(),e.drawArrays(e.TRIANGLES,0,3),t.Stat.renderBatches++}},{key:"renderInvertUV",value:function(){var e=t.LayaGL.instance;this._bufferStateInvertUV.bind(),e.drawArrays(e.TRIANGLES,0,3),t.Stat.renderBatches++}},{key:"destroy",value:function(){_get(_getPrototypeOf(ge.prototype),"destroy",this).call(this),this._bufferState.destroy(),this._vertexBuffer.destroy(),this._bufferStateInvertUV.destroy(),this._vertexBufferInvertUV.destroy(),this._setGPUMemory(0)}}],[{key:"__init__",value:function(){ge._vertexDeclaration=new Tn(16,[new gn(0,vn.Vector4,ge.SCREENTRIANGLE_POSITION_UV)]),ge.instance=new ge,ge.instance.lock=!0}}]),ge}();Rn.SCREENTRIANGLE_POSITION_UV=0,Rn._vertices=new Float32Array([-1,-1,0,0,-1,3,0,2,3,-1,2,0]),Rn._verticesInvertUV=new Float32Array([-1,-1,0,1,-1,3,0,-1,3,-1,2,1]);var Cn=function Se(e,t){_classCallCheck(this,Se),this._index=e,this._value=t},An=function(){function Re(e,t,n,i){_classCallCheck(this,Re),this._subShaderIndex=0,this._passIndex=0,this.setValue(e,t,n,i)}return _createClass(Re,[{key:"setValue",value:function(e,t,n,i){if(!e)throw"ShaderVariantInfo:Shader can't be null.";var r=e.getSubShaderAt(t);if(!r)throw"ShaderVariantInfo:Shader don't have subShaderIndex of ".concat(t,".");var a=r._passes[n];if(!a)throw"ShaderVariantInfo:Shader don't have passIndex of ".concat(n,".");for(var o=a._validDefine,s=0,l=i.length;s<l;s++){var u=i[s];if(!o.has(F.Shader3D.getDefineByName(u)))throw"ShaderVariantInfo:Invalid defineName ".concat(u," in ").concat(e._name," subShaderIndex of ").concat(t," passIndex of ").concat(n,".")}this._shader=e,this._subShaderIndex=t,this._passIndex=n,this._defineNames=i}},{key:"equal",value:function(e){if(this._shader!==e._shader||this._subShaderIndex!==e._subShaderIndex||this._passIndex!==e._passIndex)return!1;var t=this._defineNames,n=e._defineNames;if(t.length!==n.length)return!1;for(var i=0,r=this._defineNames.length;i<r;i++)if(t[i]!==n[i])return!1;return!0}},{key:"clone",value:function(){return new Re(this._shader,this._subShaderIndex,this._passIndex,this._defineNames.slice())}},{key:"shader",get:function(){return this._shader}},{key:"subShaderIndex",get:function(){return this._subShaderIndex}},{key:"passIndex",get:function(){return this._passIndex}},{key:"defineNames",get:function(){return this._defineNames}}]),Re}(),In=function(){function ve(){_classCallCheck(this,ve),this._allCompiled=!1,this._variants=[]}return _createClass(ve,[{key:"add",value:function(e){for(var t=0,n=this._variants.length;t<n;t++)if(this._variants[t].equal(e))return!1;return this._variants.push(e.clone()),this._allCompiled=!1,!0}},{key:"remove",value:function(e){for(var t=0,n=this._variants.length;t<n;t++)if(this._variants[t].equal(e))return this._variants.splice(t,1),!0;return!1}},{key:"contatins",value:function(e){for(var t=0,n=this._variants.length;t<n;t++)if(this._variants[t].equal(e))return!0;return!1}},{key:"getByIndex",value:function(e){return this._variants[e]}},{key:"clear",value:function(){this._variants.length=0}},{key:"compile",value:function(){if(!this._allCompiled){for(var e=this._variants,t=0,n=e.length;t<n;t++){var i=e[t];F.Shader3D.compileShaderByDefineNames(i._shader._name,i._subShaderIndex,i._passIndex,i._defineNames)}this._allCompiled=!0}}},{key:"allCompiled",get:function(){return this._allCompiled}},{key:"variantCount",get:function(){return this._variants.length}}]),ve}(),xn=function(){function Ae(e,t,n,i,r){_classCallCheck(this,Ae),this._attributeMap=null,this._uniformMap=null,this._enableInstancing=!1,this._supportReflectionProbe=!1,this._subShaders=[],this._name=e,this._attributeMap=t,this._uniformMap=n,this._enableInstancing=i,this._supportReflectionProbe=r}return _createClass(Ae,[{key:"addSubShader",value:function(e){this._subShaders.push(e),e._owner=this}},{key:"getSubShaderAt",value:function(e){return this._subShaders[e]}},{key:"name",get:function(){return this._name}}],[{key:"_getNamesByDefineData",value:function(e,t){var n=Ae._maskMap,i=e._mask;t.length=0;for(var r=0,a=e._length;r<a;r++)for(var o=n[r],s=i[r],l=0;l<32;l++){var u=1<<l;if(s>0&&u>s)break;s&u&&t.push(o[u])}}},{key:"getDefineByName",value:function(e){var t=Ae._defineMap[e];if(!t){var n=Ae._maskMap,i=Ae._defineCounter,r=Math.floor(i/32),a=1<<i%32;t=new Cn(r,a),Ae._defineMap[e]=t,r==n.length&&(n.length++,n[r]={}),n[r][a]=e,Ae._defineCounter++}return t}},{key:"propertyNameToID",value:function(e){if(null!=Ae._propertyNameMap[e])return Ae._propertyNameMap[e];var t=Ae._propertyNameCounter++;return Ae._propertyNameMap[e]=t,t}},{key:"addInclude",value:function(e,n){n=n.replace(t.ShaderCompile._clearCR,""),t.ShaderCompile.addInclude(e,n)}},{key:"compileShaderByDefineNames",value:function(e,t,n,i){var r=Ae.find(e);if(r){var a=r.getSubShaderAt(t);if(a){var o=a._passes[n];if(o){var s=Ae._compileDefineDatas;s.clear();for(var l=0,u=i.length;l<u;l++)s.add(Ae.getDefineByName(i[l]));o.withCompile(s)}else console.warn("Shader3D: unknown passIndex.")}else console.warn("Shader3D: unknown subShaderIndex.")}else console.warn("Shader3D: unknown shader name.")}},{key:"add",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,i=arguments.length>3&&void 0!==arguments[3]&&arguments[3],r=arguments.length>4&&void 0!==arguments[4]&&arguments[4];return Ae._preCompileShader[e]=new Ae(e,t,n,i,r)}},{key:"find",value:function(e){return Ae._preCompileShader[e]}},{key:"compileShader",value:function(e,t,n){var i=Ae.find(e);if(i){var r=i.getSubShaderAt(t);if(r){var a=r._passes[n];if(a){var o=Ae._compileDefineDatas,s=o._mask;s.length=0;for(var l=0,u=arguments.length<=3?0:arguments.length-3;l<u;l++)s.push(l+3<3||arguments.length<=l+3?void 0:arguments[l+3]);o._length=arguments.length<=3?0:arguments.length-3,a.withCompile(o)}else console.warn("Shader3D: unknown passIndex.")}else console.warn("Shader3D: unknown subShaderIndex.")}else console.warn("Shader3D: unknown shader name.")}}]),Ae}();xn._compileDefineDatas=new mn,xn.RENDER_STATE_CULL=0,xn.RENDER_STATE_BLEND=1,xn.RENDER_STATE_BLEND_SRC=2,xn.RENDER_STATE_BLEND_DST=3,xn.RENDER_STATE_BLEND_SRC_RGB=4,xn.RENDER_STATE_BLEND_DST_RGB=5,xn.RENDER_STATE_BLEND_SRC_ALPHA=6,xn.RENDER_STATE_BLEND_DST_ALPHA=7,xn.RENDER_STATE_BLEND_CONST_COLOR=8,xn.RENDER_STATE_BLEND_EQUATION=9,xn.RENDER_STATE_BLEND_EQUATION_RGB=10,xn.RENDER_STATE_BLEND_EQUATION_ALPHA=11,xn.RENDER_STATE_DEPTH_TEST=12,xn.RENDER_STATE_DEPTH_WRITE=13,xn.PERIOD_CUSTOM=0,xn.PERIOD_MATERIAL=1,xn.PERIOD_SPRITE=2,xn.PERIOD_CAMERA=3,xn.PERIOD_SCENE=4,xn._propertyNameCounter=0,xn._propertyNameMap={},xn._defineCounter=0,xn._defineMap={},xn._preCompileShader={},xn._maskMap=[],xn.debugMode=!1,xn.debugShaderVariantCollection=new In;var Dn=function(){function xe(){_classCallCheck(this,xe),this._commandBuffer=null}return _createClass(xe,[{key:"run",value:function(){}},{key:"recover",value:function(){this._commandBuffer=null}},{key:"setContext",value:function(e){this._context=e}}],[{key:"__init__",value:function(){xe._screenShaderData=new En,xe._screenShader=xn.find("BlitScreen")}}]),xe}();Dn.SCREENTEXTURE_NAME="u_MainTex",Dn.SCREENTEXTUREOFFSETSCALE_NAME="u_OffsetScale",Dn.MAINTEXTURE_TEXELSIZE_NAME="u_MainTex_TexelSize",Dn.SCREENTEXTURE_ID=xn.propertyNameToID(Dn.SCREENTEXTURE_NAME),Dn.SCREENTEXTUREOFFSETSCALE_ID=xn.propertyNameToID(Dn.SCREENTEXTUREOFFSETSCALE_NAME),Dn.MAINTEXTURE_TEXELSIZE_ID=xn.propertyNameToID(Dn.MAINTEXTURE_TEXELSIZE_NAME);var Mn=function(e){function Ie(){var e;return _classCallCheck(this,Ie),(e=_possibleConstructorReturn(this,_getPrototypeOf(Ie).apply(this,arguments)))._source=null,e._dest=null,e._offsetScale=null,e._shader=null,e._shaderData=null,e._subShader=0,e._sourceTexelSize=new o,e._screenType=0,e._drawDefineCavans=!1,e}return _inherits(Ie,Dn),_createClass(Ie,[{key:"run",value:function(){var e;if(this._source)e=this._source;else{if(!this._commandBuffer._camera._internalRenderTexture)throw"camera internalRenderTexture is null,please set camera enableBuiltInRenderTexture";e=this._commandBuffer._camera._internalRenderTexture}var n=this._shader||Dn._screenShader,i=this._shaderData||Dn._screenShaderData,r=this._dest||this._drawDefineCavans?this._dest:this._commandBuffer._camera._internalRenderTexture;t.LayaGL.instance.viewport(0,0,r?r.width:dn.clientWidth,r?r.height:dn.clientHeight),i.setTexture(Dn.SCREENTEXTURE_ID,e),i.setVector(Dn.SCREENTEXTUREOFFSETSCALE_ID,this._offsetScale||Ie._defaultOffsetScale),this._sourceTexelSize.setValue(1/e.width,1/e.height,e.width,e.height),i.setVector(Dn.MAINTEXTURE_TEXELSIZE_ID,this._sourceTexelSize),fn.currentActive&&fn.currentActive._end(),r&&r._start();for(var a=n.getSubShaderAt(this._subShader)._passes,o=0,s=a.length;o<s;o++){var l=Ie._compileDefine;i._defineDatas.cloneTo(l);var u=a[o].withCompile(l);switch(u.bind(),u.uploadUniforms(u._materialUniformParamsMap,i,!0),u.uploadRenderStateBlendDepth(i),u.uploadRenderStateFrontFace(i,!1,null),this._screenType){case Ie._SCREENTYPE_QUAD:dn._instance.invertY?Sn.instance.renderInvertUV():Sn.instance.render();break;case Ie._SCREENTYPE_TRIANGLE:dn._instance.invertY?Rn.instance.renderInvertUV():Rn.instance.render();break;default:throw"BlitScreenQuadCMD:unknown screen Type."}}r&&r._end()}},{key:"recover",value:function(){Ie._pool.push(this),this._source=null,this._dest=null,this._offsetScale=null,this._shader=null,this._shaderData=null,this._drawDefineCavans=!1,_get(_getPrototypeOf(Ie.prototype),"recover",this).call(this)}}],[{key:"create",value:function(e,t){var n,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,s=arguments.length>6&&void 0!==arguments[6]?arguments[6]:Ie._SCREENTYPE_QUAD,l=arguments.length>7&&void 0!==arguments[7]?arguments[7]:null,u=arguments.length>8&&void 0!==arguments[8]&&arguments[8];return(n=Ie._pool.length>0?Ie._pool.pop():new Ie)._source=e,n._dest=t,n._offsetScale=i,n._shader=r,n._shaderData=a,n._subShader=o,n._screenType=s,n._commandBuffer=l,n._drawDefineCavans=u,n}}]),Ie}();Mn._SCREENTYPE_QUAD=0,Mn._SCREENTYPE_TRIANGLE=1,Mn._compileDefine=new mn,Mn._pool=[],Mn._defaultOffsetScale=new o(0,0,1,1);var Ln=function(e){function De(){var e;return _classCallCheck(this,De),(e=_possibleConstructorReturn(this,_getPrototypeOf(De).apply(this,arguments)))._renderTexture=null,e}return _inherits(De,Dn),_createClass(De,[{key:"run",value:function(){fn.currentActive&&fn.currentActive._end(),t.LayaGL.instance.viewport(0,0,this._renderTexture.width,this._renderTexture.height),this._renderTexture._start()}},{key:"recover",value:function(){De._pool.push(this),this._renderTexture=null}}],[{key:"create",value:function(e){var t;return(t=De._pool.length>0?De._pool.pop():new De)._renderTexture=e,t}}]),De}();Ln._pool=[],(l=e.ShaderDataType||(e.ShaderDataType={}))[l.Int=0]="Int",l[l.Bool=1]="Bool",l[l.Number=2]="Number",l[l.Vector2=3]="Vector2",l[l.Vector3=4]="Vector3",l[l.Vector4=5]="Vector4",l[l.Quaternion=6]="Quaternion",l[l.Matrix4x4=7]="Matrix4x4",l[l.Buffer=8]="Buffer",l[l.Texture=9]="Texture";var On=function(t){function Ce(){var e;return _classCallCheck(this,Ce),(e=_possibleConstructorReturn(this,_getPrototypeOf(Ce).apply(this,arguments)))._shaderData=null,e._nameID=0,e._value=null,e._dataType=-1,e}return _inherits(Ce,Dn),_createClass(Ce,[{key:"run",value:function(){switch(this._dataType){case e.ShaderDataType.Int:this._shaderData.setInt(this._nameID,this._value);break;case e.ShaderDataType.Number:this._shaderData.setNumber(this._nameID,this._value);break;case e.ShaderDataType.Bool:this._shaderData.setBool(this._nameID,this._value);break;case e.ShaderDataType.Matrix4x4:this._shaderData.setMatrix4x4(this._nameID,this._value);break;case e.ShaderDataType.Quaternion:this._shaderData.setQuaternion(this._nameID,this._value);break;case e.ShaderDataType.Texture:this._shaderData.setTexture(this._nameID,this._value);break;case e.ShaderDataType.Vector4:this._shaderData.setVector(this._nameID,this._value);break;case e.ShaderDataType.Vector2:this._shaderData.setVector2(this._nameID,this._value);break;case e.ShaderDataType.Vector3:this._shaderData.setVector3(this._nameID,this._value);break;case e.ShaderDataType.Buffer:this._shaderData.setBuffer(this._nameID,this._value);break;default:throw"no type shaderValue on this CommendBuffer"}}},{key:"recover",value:function(){Ce._pool.push(this),this._shaderData=null,this._nameID=0,this._value=null,this._dataType=-1}}],[{key:"create",value:function(e,t,n,i,r){var a;return(a=Ce._pool.length>0?Ce._pool.pop():new Ce)._shaderData=e,a._nameID=t,a._value=n,a._dataType=i,a._commandBuffer=r,a}}]),Ce}();On._pool=[];var Nn=function(e){function Me(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,n=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return _classCallCheck(this,Me),(e=_possibleConstructorReturn(this,_getPrototypeOf(Me).call(this)))._needProcessCollisions=!1,e._needProcessTriggers=!1,e._id=++Me._uniqueIDCounter,e._transform=new oe(_assertThisInitialized(e)),e._isStatic=n,e.layer=0,e.name=t||"New Sprite3D",e}return _inherits(Me,t.Node),_createClass(Me,[{key:"_setCreateURL",value:function(e){this._url=t.URL.formatURL(e)}},{key:"_changeAnimatorsToLinkSprite3D",value:function(e,t,n){var i=this.getComponent(hn);if(i&&(i.avatar||e._changeAnimatorToLinkSprite3DNoAvatar(i,t,n)),this._parent&&this._parent instanceof Me){n.unshift(this._parent.name);var r=this._parent;r._hierarchyAnimator&&r._changeAnimatorsToLinkSprite3D(e,t,n)}}},{key:"_setHierarchyAnimator",value:function(e,t){this._changeHierarchyAnimator(e),this._changeAnimatorAvatar(e.avatar);for(var n=0,i=this._children.length;n<i;n++){var r=this._children[n];r._hierarchyAnimator==t&&r._setHierarchyAnimator(e,t)}}},{key:"_clearHierarchyAnimator",value:function(e,t){this._changeHierarchyAnimator(t),this._changeAnimatorAvatar(t?t.avatar:null);for(var n=0,i=this._children.length;n<i;n++){var r=this._children[n];r._hierarchyAnimator==e&&r._clearHierarchyAnimator(e,t)}}},{key:"_changeHierarchyAnimatorAvatar",value:function(e,t){this._changeAnimatorAvatar(t);for(var n=0,i=this._children.length;n<i;n++){var r=this._children[n];r._hierarchyAnimator==e&&r._changeHierarchyAnimatorAvatar(e,t)}}},{key:"_changeAnimatorToLinkSprite3DNoAvatar",value:function(e,t,n){e._handleSpriteOwnersBySprite(t,n,this);for(var i=0,r=this._children.length;i<r;i++){var a=this._children[i],o=n.length;n.push(a.name),a._changeAnimatorToLinkSprite3DNoAvatar(e,t,n),n.splice(o,1)}}},{key:"_changeHierarchyAnimator",value:function(e){this._hierarchyAnimator=e}},{key:"_changeAnimatorAvatar",value:function(e){}},{key:"_onAdded",value:function(){if(this._parent instanceof Me){var e=this._parent;this.transform._setParent(e.transform),e._hierarchyAnimator&&(!this._hierarchyAnimator&&this._setHierarchyAnimator(e._hierarchyAnimator,null),e._changeAnimatorsToLinkSprite3D(this,!0,[this.name]))}_get(_getPrototypeOf(Me.prototype),"_onAdded",this).call(this)}},{key:"_onRemoved",value:function(){if(_get(_getPrototypeOf(Me.prototype),"_onRemoved",this).call(this),this._parent instanceof Me){var e=this._parent;this.transform._setParent(null),e._hierarchyAnimator&&(this._hierarchyAnimator==e._hierarchyAnimator&&this._clearHierarchyAnimator(e._hierarchyAnimator,null),e._changeAnimatorsToLinkSprite3D(this,!1,[this.name]))}}},{key:"_parse",value:function(e,t){if(void 0!==e.isStatic&&(this._isStatic=e.isStatic),void 0!==e.active&&(this.active=e.active),null!=e.name&&(this.name=e.name),void 0!==e.position){var n=this.transform.localPosition;n.fromArray(e.position),this.transform.localPosition=n}if(void 0!==e.rotationEuler){var i=this.transform.localRotationEuler;i.fromArray(e.rotationEuler),this.transform.localRotationEuler=i}if(void 0!==e.rotation){var r=this.transform.localRotation;r.fromArray(e.rotation),this.transform.localRotation=r}if(void 0!==e.scale){var a=this.transform.localScale;a.fromArray(e.scale),this.transform.localScale=a}null!=e.layer&&(this.layer=e.layer)}},{key:"_cloneTo",value:function(e,t,n){if(this.destroyed)throw new Error("Sprite3D: Can't be cloned if the Sprite3D has destroyed.");var i=e,r=this._transform,a=i._transform;i.name=this.name,i.destroyed=this.destroyed,i.active=this.active,a.localPosition=r.localPosition,a.localRotation=r.localRotation,a.localScale=r.localScale,i._isStatic=this._isStatic,i.layer=this.layer,_get(_getPrototypeOf(Me.prototype),"_cloneTo",this).call(this,i,t,n)}},{key:"clone",value:function(){var e=Me._createSprite3DInstance(this);return Me._parseSprite3DInstance(this,e,this,e),e}},{key:"destroy",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];this.destroyed||(_get(_getPrototypeOf(Me.prototype),"destroy",this).call(this,e),this._transform=null,this._scripts=null,this._url&&t.Loader.clearRes(this._url))}},{key:"_create",value:function(){return new Me}},{key:"id",get:function(){return this._id}},{key:"layer",get:function(){return this._layer},set:function(e){if(this._layer!==e){if(!(e>=0&&e<=30))throw new Error("Layer value must be 0-30.");this._layer=e}}},{key:"url",get:function(){return this._url}},{key:"isStatic",get:function(){return this._isStatic}},{key:"transform",get:function(){return this._transform}}],[{key:"__init__",value:function(){}},{key:"instantiate",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,a=e.clone();t&&t.addChild(a);var o=a.transform;if(n){var s=o.worldMatrix;e.transform.worldMatrix.cloneTo(s),o.worldMatrix=s}else i&&(o.position=i),r&&(o.rotation=r);return a}},{key:"load",value:function(e,n,i){t.Laya.loader.create(e,n,i,Me.HIERARCHY)}},{key:"_createSprite3DInstance",value:function(e){for(var t=e._create(),n=e._children,i=0,r=n.length;i<r;i++){var a=Me._createSprite3DInstance(n[i]);t.addChild(a)}return t}},{key:"_parseSprite3DInstance",value:function(e,t,n,i){for(var r=n._children,a=i._children,o=0,s=r.length;o<s;o++)Me._parseSprite3DInstance(e,t,r[o],a[o]);n._cloneTo(i,e,t)}}]),Me}();Nn.HIERARCHY="HIERARCHY",Nn.WORLDMATRIX=xn.propertyNameToID("u_WorldMat"),Nn.MVPMATRIX=xn.propertyNameToID("u_MvpMatrix"),Nn._uniqueIDCounter=0;var Pn=function(e){function ye(){var e;return _classCallCheck(this,ye),(e=_possibleConstructorReturn(this,_getPrototypeOf(ye).call(this)))._projectionViewWorldMatrix=new q,e._renderShaderValue=new En,e._renderShaderValue=new En(null),e}return _inherits(ye,Dn),_createClass(ye,[{key:"run",value:function(){var e=this._material._shader.getSubShaderAt(this._subShaderIndex);this.setContext(this._commandBuffer._context);var t=this._context,n=t.invertY,i=t.scene,r=t.cameraShaderValue,a=t.projectionViewMatrix;q.multiply(a,this._matrix,this._projectionViewWorldMatrix),this._renderShaderValue.setMatrix4x4(Nn.WORLDMATRIX,this._matrix),this._renderShaderValue.setMatrix4x4(Nn.MVPMATRIX,this._projectionViewWorldMatrix);for(var o=t.pipelineMode,s=e._passes,l=0,u=s.length;l<u;l++){var _=s[l];if(_._pipelineMode===o){var c=ye._compileDefine;i._shaderValues._defineDatas.cloneTo(c),c.addDefineDatas(this._renderShaderValue._defineDatas),c.addDefineDatas(this._material._shaderValues._defineDatas);var h=t.shader=_.withCompile(c);h.bind(),h.uploadUniforms(h._sceneUniformParamsMap,i._shaderValues,!0),h.uploadUniforms(h._spriteUniformParamsMap,this._renderShaderValue,!0),h.uploadUniforms(h._cameraUniformParamsMap,r,!0);var d=this._material._shaderValues;h.uploadUniforms(h._materialUniformParamsMap,d,!0),h.uploadRenderStateBlendDepth(d),h.uploadRenderStateFrontFace(d,n,this._matrix.getInvertFront())}}var f,m=this._mesh._subMeshes;if(-1==this._subMeshIndex)for(var p=0,v=m.length;p<v;p++)(f=m[p])._prepareRender(t)&&f._render(t);else(f=(m=this._mesh._subMeshes)[this._subMeshIndex])._prepareRender(t)&&f._render(t)}},{key:"recover",value:function(){ye._pool.push(this),this._renderShaderValue.clearDefine(),this._renderShaderValue._initData()}}],[{key:"create",value:function(e,t,n,i,r,a){var o;return(o=ye._pool.length>0?ye._pool.pop():new ye)._mesh=e,o._matrix=t,o._material=n,o._subMeshIndex=i,o._subShaderIndex=r,o._commandBuffer=a,o}}]),ye}();Pn._pool=[],Pn._compileDefine=new mn;var bn=function(e){function Le(){var e;return _classCallCheck(this,Le),(e=_possibleConstructorReturn(this,_getPrototypeOf(Le).apply(this,arguments)))._clearColor=!1,e._clearDepth=!1,e._backgroundColor=new o,e._depth=1,e}return _inherits(Le,Dn),_createClass(Le,[{key:"run",value:function(){var e,n=t.LayaGL.instance,i=this._backgroundColor;this._clearColor&&(n.clearColor(i.x,i.y,i.z,i.w),e|=n.COLOR_BUFFER_BIT),this._clearDepth&&(n.clearDepth(this._depth),e|=n.DEPTH_BUFFER_BIT),(this._clearColor||this._clearDepth)&&n.clear(e)}},{key:"recover",value:function(){}}],[{key:"create",value:function(e,t,n){var i,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,a=arguments.length>4?arguments[4]:void 0;return(i=Le._pool.length>0?Le._pool.pop():new Le)._clearColor=e,i._clearDepth=t,n.cloneTo(i._backgroundColor),i._depth=r,i._commandBuffer=a,i}}]),Le}();bn._pool=[];var wn=function Oe(){_classCallCheck(this,Oe),this.updateMark=-1,this.pointLightCount=0,this.spotLightCount=0,this.indices=[]},kn=function(){function Ne(e,t,n,i){_classCallCheck(this,Ne),this._updateMark=0,this._depthSliceParam=new r,this._xSlices=e,this._ySlices=t,this._zSlices=n;var a=e*t,o=n*(1+Math.ceil(i/4));this._clusterTexture=gt._createFloatTextureBuffer(a,o),this._clusterTexture.lock=!0,this._clusterPixels=new Float32Array(a*o*4);for(var s=new Array(this._zSlices),l=0;l<this._zSlices;l++){s[l]=new Array(this._ySlices);for(var u=0;u<this._ySlices;u++){s[l][u]=new Array(this._xSlices);for(var _=0;_<this._xSlices;_++)s[l][u][_]=new wn}}this._clusterDatas=s}return _createClass(Ne,[{key:"_placePointLightToClusters",value:function(e,t){for(var n=this._clusterDatas,i=this._updateMark,r=t.zMin,a=t.zMax;r<a;r++)for(var o=t.yMin,s=t.yMax;o<s;o++)for(var l=t.xMin,u=t.xMax;l<u;l++){var _=n[r][o][l];_.updateMark!=i&&(_.pointLightCount=0,_.spotLightCount=0,_.updateMark=i);var c=_.indices,h=_.pointLightCount++;h<c.length?c[h]=e:c.push(e)}}},{key:"_placeSpotLightToClusters",value:function(e,t){for(var n=this._clusterDatas,i=this._updateMark,r=t.zMin,a=t.zMax;r<a;r++)for(var o=t.yMin,s=t.yMax;o<s;o++)for(var l=t.xMin,u=t.xMax;l<u;l++){var _=n[r][o][l];_.updateMark!=i&&(_.pointLightCount=0,_.spotLightCount=0,_.updateMark=i);var c=_.indices,h=_.pointLightCount+_.spotLightCount++;h<c.length?c[h]=e:c.push(e)}}},{key:"_insertConePlane",value:function(e,t,n,i,r){var a=Ne._tempVector36,o=Ne._tempVector37;D.cross(r,t,a),D.cross(a,t,o),D.normalize(o,o);var s=n*Math.tan(i),l=e.x+n*t.x+s*o.x,u=e.y+n*t.y+s*o.y,_=e.z+n*t.z+s*o.z;return l*r.x+u*r.y+_*r.z<=0||e.x*r.x+e.y*r.y+e.z*r.z<=0}},{key:"_shrinkSphereLightZPerspective",value:function(e,t,n,i,r){var a=n.z,o=a-i,s=a+i;if(o>t||s<=e)return!1;var l=this._depthSliceParam;return r.zMin=Math.floor(Math.log2(Math.max(o,e))*l.x-l.y),r.zMax=Math.min(Math.ceil(Math.log2(s)*l.x-l.y),this._zSlices),!0}},{key:"_shrinkSpotLightZPerspective",value:function(e,t,n,i,r,a,o){var s=i.x,l=i.y,u=i.z,_=Math.tan(a)*r,c=n.x,h=n.y,d=n.z,f=s-c,m=l-h,p=u-d,v=f*f+m*m+p*p,E=Math.sqrt(1-p*p/v),T=Math.max(Math.min(d,u-E*_),n.z-r),g=Math.min(Math.max(d,u+E*_),n.z+r);if(T>t||g<=e)return!1;var y=this._depthSliceParam;return o.zMin=Math.floor(Math.log2(Math.max(T,e))*y.x-y.y),o.zMax=Math.min(Math.ceil(Math.log2(g)*y.x-y.y),this._zSlices),!0}},{key:"_shrinkSphereLightByBoundOrth",value:function(e,t,n,i,r,a,o){var s=r.z,l=s-a,u=s+a;if(l>i||u<=n)return!1;var _=r.x,c=_-a,h=_+a;if(c>e||h<=-e)return!1;var d=r.y,f=d-a,m=d+a;if(f>t||m<=-t)return!1;var p=this._xSlices,v=this._ySlices,E=this._depthSliceParam,T=2*e/p,g=2*t/v;return o.xMin=Math.max(Math.floor((c+e)/T),0),o.xMax=Math.min(Math.ceil((h+e)/T),p),o.yMin=Math.max(Math.floor((t-m)/g),0),o.yMax=Math.min(Math.ceil((t-f)/g),v),o.zMin=Math.floor(Math.log2(Math.max(l,n))*E.x-E.y),o.zMax=Math.min(Math.ceil(Math.log2(u)*E.x-E.y),this._zSlices),!0}},{key:"_shrinkSpotLightByBoundOrth",value:function(e,t,n,i,r,a,o,s,l){var u=a.x,_=a.y,c=a.z,h=Math.tan(s)*o,d=r.x,f=r.y,m=r.z,p=u-d,v=_-f,E=c-m,T=p*p+v*v+E*E,g=Math.sqrt(1-E*E/T),y=Math.max(Math.min(m,c-g*h),r.z-o),S=Math.min(Math.max(m,c+g*h),r.z+o);if(y>i||S<=n)return!1;var R=Math.sqrt(1-p*p/T),C=Math.max(Math.min(d,u-R*h),r.x-o),A=Math.min(Math.max(d,u+R*h),r.x+o);if(C>e||A<=-e)return!1;var I=Math.sqrt(1-v*v/T),x=Math.max(Math.min(f,_-I*h),r.y-o),D=Math.min(Math.max(f,_+I*h),r.y+o);if(x>t||D<=-t)return!1;var M=this._xSlices,L=this._ySlices,O=this._depthSliceParam,N=2*e/M,P=2*t/L;return l.xMin=Math.max(Math.floor((C+e)/N),0),l.xMax=Math.min(Math.ceil((A+e)/N),M),l.yMin=Math.max(Math.floor((t-D)/P),0),l.yMax=Math.min(Math.ceil((t-x)/P),L),l.zMin=Math.floor(Math.log2(Math.max(y,n))*O.x-O.y),l.zMax=Math.min(Math.ceil(Math.log2(S)*O.x-O.y),this._zSlices),!0}},{key:"_shrinkXYByRadiusPerspective",value:function(e,t,n,i,r){var a,o,s,l,u,_=e.x,c=e.y,h=e.z,d=this._ySlices+1;for(u=0;u<d;u++)if(c*(f=r[u]).y+h*f.z<t){o=Math.max(0,u-1);break}if(u==d)return!1;for(l=this._ySlices,u=o+1;u<d;u++)if(c*(f=r[u]).y+h*f.z<=-t){l=Math.max(0,u);break}for(d=this._xSlices+1,u=0;u<d;u++)if(_*(f=i[u]).x+h*f.z<t){a=Math.max(0,u-1);break}for(s=this._xSlices,u=a+1;u<d;u++){var f;if(_*(f=i[u]).x+h*f.z<=-t){s=Math.max(0,u);break}}return n.xMin=a,n.xMax=s,n.yMin=o,n.yMax=l,!0}},{key:"_shrinkSpotXYByConePerspective",value:function(e,t,n,i,r,a,o){for(var s,l,u,_,c=Ne._tempVector32,h=r.yMax+1,d=r.yMin+1;d<h;d++)if(this._insertConePlane(e,t,n,i,o[d])){l=Math.max(0,d-1);break}for(_=r.yMax,d=l+1;d<h;d++){var f=o[d];if(c.setValue(0,-f.y,-f.z),!this._insertConePlane(e,t,n,i,c)){_=Math.max(0,d);break}}for(h=r.xMax+1,d=r.xMin+1;d<h;d++)if(this._insertConePlane(e,t,n,i,a[d])){s=Math.max(0,d-1);break}for(u=r.xMax,d=s+1;d<h;d++)if(f=a[d],c.setValue(-f.x,0,-f.z),!this._insertConePlane(e,t,n,i,c)){u=Math.max(0,d);break}r.xMin=s,r.xMax=u,r.yMin=l,r.yMax=_}},{key:"_updatePointLightPerspective",value:function(e,t,n,i,r,a,o){var s=Ne._tempLightBound,l=Ne._tempVector30;D.transformV3ToV3(i._transform.position,n,l),l.z*=-1,this._shrinkSphereLightZPerspective(e,t,l,i.range,s)&&this._shrinkXYByRadiusPerspective(l,i.range,s,a,o)&&this._placePointLightToClusters(r,s)}},{key:"_updateSpotLightPerspective",value:function(e,t,n,i,r,a,o){var s=Ne._tempLightBound,l=Ne._tempVector30,u=Ne._tempVector31,_=Ne._tempVector34,c=i._transform.position,h=i.range;i._transform.worldMatrix.getForward(u),D.normalize(u,u),D.scale(u,h,_),D.add(c,_,_),D.transformV3ToV3(c,n,l),D.transformV3ToV3(_,n,_),l.z*=-1,_.z*=-1;var d=i.spotAngle/2*Math.PI/180;if(this._shrinkSpotLightZPerspective(e,t,l,_,h,d,s)&&this._shrinkXYByRadiusPerspective(l,h,s,a,o)){var f=Ne._tempVector33;f.x=_.x-l.x,f.y=_.y-l.y,f.z=_.z-l.z,D.normalize(f,f),this._shrinkSpotXYByConePerspective(l,f,h,d,s,a,o),this._placeSpotLightToClusters(r,s)}}},{key:"_updatePointLightOrth",value:function(e,t,n,i,r,a,o){var s=Ne._tempLightBound,l=Ne._tempVector30;D.transformV3ToV3(a._transform.position,r,l),l.z*=-1,this._shrinkSphereLightByBoundOrth(e,t,n,i,l,a.range,s)&&this._placePointLightToClusters(o,s)}},{key:"_updateSpotLightOrth",value:function(e,t,n,i,r,a,o){var s=Ne._tempLightBound,l=Ne._tempVector30,u=Ne._tempVector31,_=Ne._tempVector34,c=a._transform.position,h=a.range;a._transform.worldMatrix.getForward(u),D.normalize(u,u),D.scale(u,h,_),D.add(c,_,_),D.transformV3ToV3(c,r,l),D.transformV3ToV3(_,r,_),l.z*=-1,_.z*=-1;var d=a.spotAngle/2*Math.PI/180;this._shrinkSpotLightByBoundOrth(e,t,n,i,l,_,h,d,s)&&this._placeSpotLightToClusters(o,s)}},{key:"update",value:function(e,t){this._updateMark++;var n=e.nearPlane;this._depthSliceParam.x=It._config.lightClusterCount.z/Math.log2(e.farPlane/n),this._depthSliceParam.y=Math.log2(n)*this._depthSliceParam.x;var i=e.nearPlane,r=e.farPlane,a=e.viewMatrix,o=t._directionLights._length,s=t._pointLights,l=s._length,u=s._elements,_=t._spotLights,c=_._length,h=_._elements;if(e.orthographic){for(var d=e.orthographicVerticalSize/2,f=d*e.aspectRatio,m=0;m<l;m++,o++)this._updatePointLightOrth(f,d,i,r,a,u[m],o);for(m=0;m<c;m++,o++)this._updateSpotLightOrth(f,d,i,r,a,h[m],o)}else{e._updateClusterPlaneXY();var p=e._clusterXPlanes,v=e._clusterYPlanes;for(m=0;m<l;m++,o++)this._updatePointLightPerspective(i,r,a,u[m],o,p,v);for(m=0;m<c;m++,o++)this._updateSpotLightPerspective(i,r,a,h[m],o,p,v)}if(l+c>0){for(var E=this._xSlices,T=this._ySlices,g=this._zSlices,y=E*T*4,S=y*g,R=this._clusterPixels,C=R.length,A=this._clusterDatas,I=this._updateMark,x=!0,D=0;D<g;D++)for(var M=0;M<T;M++)for(var L=0;L<E;L++){var O=A[D][M][L],N=4*(L+M*E+D*E*T);if(O.updateMark!==I)R[N]=0,R[N+1]=0;else if(x){var P=O.indices,b=O.pointLightCount,w=O.spotLightCount,k=b+w;if(S+k<C)for(R[N]=b,R[N+1]=w,R[N+2]=Math.floor(S/y),R[N+3]=S%y,m=0;m<k;m++)R[S++]=P[m];else{for(k=C-(S+k),b=Math.min(b,k),R[N]=b,R[N+1]=Math.min(w,k-b),R[N+2]=Math.floor(S/y),R[N+3]=S%y,m=0;m<k;m++)R[S++]=P[m];x=!1}}}var V=this._clusterTexture.width;this._clusterTexture.setSubPixels(0,0,V,Math.ceil(S/(4*V)),R)}}}]),Ne}();kn._tempVector30=new D,kn._tempVector31=new D,kn._tempVector32=new D,kn._tempVector33=new D,kn._tempVector34=new D,kn._tempVector35=new D,kn._tempVector36=new D,kn._tempVector37=new D,kn._tempLightBound=new(function(){return function _class(){_classCallCheck(this,_class)}}());var Vn=function(){function Pe(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;_classCallCheck(this,Pe),this.normal=e,this.distance=t}return _createClass(Pe,[{key:"normalize",value:function(){var e=this.normal.x,t=this.normal.y,n=this.normal.z,i=1/Math.sqrt(e*e+t*t+n*n);this.normal.x=e*i,this.normal.y=t*i,this.normal.z=n*i,this.distance*=i}},{key:"cloneTo",value:function(e){var t=e;this.normal.cloneTo(t.normal),t.distance=this.distance}},{key:"clone",value:function(){var e=new Pe(new D);return this.cloneTo(e),e}}],[{key:"createPlaneBy3P",value:function(e,t,n,i){var r=t.x-e.x,a=t.y-e.y,o=t.z-e.z,s=n.x-e.x,l=n.y-e.y,u=n.z-e.z,_=a*u-o*l,c=o*s-r*u,h=r*l-a*s,d=1/Math.sqrt(_*_+c*c+h*h),f=_*d,m=c*d,p=h*d,v=i.normal;v.x=f,v.y=m,v.z=p,i.distance=-(f*e.x+m*e.y+p*e.z)}}]),Pe}();Vn.PlaneIntersectionType_Back=0,Vn.PlaneIntersectionType_Front=1,Vn.PlaneIntersectionType_Intersecting=2;var Bn=function be(e,t){_classCallCheck(this,be),this.origin=e,this.direction=t},Fn=function we(){_classCallCheck(this,we)};Fn.Disjoint=0,Fn.Contains=1,Fn.Intersects=2;var Un=function(){function Ve(){_classCallCheck(this,Ve)}return _createClass(Ve,null,[{key:"distancePlaneToPoint",value:function(e,t){return D.dot(e.normal,t)-e.distance}},{key:"distanceBoxToPoint",value:function(e,t){var n=e.min,i=n.x,r=n.y,a=n.z,o=e.max,s=o.x,l=o.y,u=o.z,_=t.x,c=t.y,h=t.z,d=0;return _<i&&(d+=(i-_)*(i-_)),_>s&&(d+=(s-_)*(s-_)),c<r&&(d+=(r-c)*(r-c)),c>l&&(d+=(l-c)*(l-c)),h<a&&(d+=(a-h)*(a-h)),h>u&&(d+=(u-h)*(u-h)),Math.sqrt(d)}},{key:"distanceBoxToBox",value:function(e,t){var n,i=e.min,r=i.x,a=i.y,o=i.z,s=e.max,l=s.x,u=s.y,_=s.z,c=t.min,h=c.x,d=c.y,f=c.z,m=t.max,p=m.x,v=m.y,E=m.z,T=0;return r>p?T+=(n=r-p)*n:h>l&&(T+=(n=h-l)*n),a>v?T+=(n=a-v)*n:d>u&&(T+=(n=d-u)*n),o>E?T+=(n=o-E)*n:f>_&&(T+=(n=f-_)*n),Math.sqrt(T)}},{key:"distanceSphereToPoint",value:function(e,t){var n=Math.sqrt(D.distanceSquared(e.center,t));return n-=e.radius,Math.max(n,0)}},{key:"distanceSphereToSphere",value:function(e,t){var n=Math.sqrt(D.distanceSquared(e.center,t.center));return n-=e.radius+t.radius,Math.max(n,0)}},{key:"intersectsRayAndTriangleRD",value:function(e,t,n,r,a){var o=e.origin,s=o.x,l=o.y,u=o.z,_=e.direction,c=_.x,h=_.y,d=_.z,f=t.x,m=t.y,p=t.z,v=n.x,E=n.y,T=n.z,g=r.x,y=r.y,S=r.z,R=Ve._tempV30.x,C=Ve._tempV30.y,A=Ve._tempV30.z;R=v-f,C=E-m,A=T-p;var I=Ve._tempV31.x,x=Ve._tempV31.y,D=Ve._tempV31.z;I=g-f,x=y-m,D=S-p;var M=Ve._tempV32.x,L=Ve._tempV32.y,O=Ve._tempV32.z,N=R*(M=h*D-d*x)+C*(L=d*I-c*D)+A*(O=c*x-h*I);if(i.isZero(N))return!1;var P=1/N,b=Ve._tempV33.x,w=Ve._tempV33.y,k=Ve._tempV33.z,V=(b=s-f)*M+(w=l-m)*L+(k=u-p)*O;if((V*=P)<0||V>1)return!1;var B=Ve._tempV34.x,F=Ve._tempV34.y,U=Ve._tempV34.z,G=c*(B=w*A-k*C)+h*(F=k*R-b*A)+d*(U=b*C-w*R);if((G*=P)<0||V+G>1)return!1;var H=I*B+x*F+D*U;return!((H*=P)<0)}},{key:"intersectsRayAndTriangleRP",value:function(e,t,n,i,r){return Ve.intersectsRayAndTriangleRD(e,t,n,i,void 0)?(D.scale(e.direction,void 0,Ve._tempV30),D.add(e.origin,Ve._tempV30,r),!0):(r=D._ZERO,!1)}},{key:"intersectsRayAndPoint",value:function(e,t){D.subtract(e.origin,t,Ve._tempV30);var n=D.dot(Ve._tempV30,e.direction),r=D.dot(Ve._tempV30,Ve._tempV30)-i.zeroTolerance;return!(r>0&&n>0||n*n-r<0)}},{key:"intersectsRayAndRay",value:function(e,t,n){var r=e.origin,a=r.x,o=r.y,s=r.z,l=e.direction,u=l.x,_=l.y,c=l.z,h=t.origin,d=h.x,f=h.y,m=h.z,p=t.direction,v=p.x,E=p.y,T=p.z;D.cross(l,p,Ve._tempV30);var g=Ve._tempV30,y=D.scalarLength(Ve._tempV30);if(i.isZero(y)&&i.nearEqual(d,a)&&i.nearEqual(f,o)&&i.nearEqual(m,s))return!0;y*=y;var S=d-a,R=f-o,C=m-s,A=v,I=E,x=T,M=g.x,L=g.y,O=g.z,N=S*I*O+R*x*M+C*A*L-S*x*L-R*A*O-C*I*M;A=u,I=_,x=c;var P=N/y;D.scale(l,P,Ve._tempV30),D.scale(p,P,Ve._tempV31),D.add(r,Ve._tempV30,Ve._tempV32),D.add(h,Ve._tempV31,Ve._tempV33);var b=Ve._tempV32,w=Ve._tempV33;return!!(i.nearEqual(w.x,b.x)&&i.nearEqual(w.y,b.y)&&i.nearEqual(w.z,b.z))}},{key:"intersectsPlaneAndTriangle",value:function(e,t,n,i){var r=Ve.intersectsPlaneAndPoint(e,t),a=Ve.intersectsPlaneAndPoint(e,n),o=Ve.intersectsPlaneAndPoint(e,i);return r==Vn.PlaneIntersectionType_Front&&a==Vn.PlaneIntersectionType_Front&&o==Vn.PlaneIntersectionType_Front?Vn.PlaneIntersectionType_Front:r==Vn.PlaneIntersectionType_Back&&a==Vn.PlaneIntersectionType_Back&&o==Vn.PlaneIntersectionType_Back?Vn.PlaneIntersectionType_Back:Vn.PlaneIntersectionType_Intersecting}},{key:"intersectsRayAndPlaneRD",value:function(e,t){var n=t.normal,r=D.dot(n,e.direction);if(Math.abs(r)<i.zeroTolerance)return-1;var a=D.dot(n,e.origin),o=(-t.distance-a)/r;if(o<0){if(o<-i.zeroTolerance)return-1;o=0}return o}},{key:"intersectsRayAndPlaneRP",value:function(e,t,n){var i=Ve.intersectsRayAndPlaneRD(e,t);if(-1==i)return n.setValue(0,0,0),!1;var r=Ve._tempV30;return D.scale(e.direction,i,r),D.add(e.origin,r,n),!0}},{key:"intersectsRayAndBoxRD",value:function(e,t){var n=e.origin,r=n.x,a=n.y,o=n.z,s=e.direction,l=s.x,u=s.y,_=s.z,c=t.min,h=c.x,d=c.y,f=c.z,m=t.max,p=m.x,v=m.y,E=m.z,T=0,g=i.MaxValue;if(i.isZero(l)){if(r<h||r>p)return-1}else{var y=1/l,S=(h-r)*y,R=(p-r)*y;if(S>R){var C=S;S=R,R=C}if((T=Math.max(S,T))>(g=Math.min(R,g)))return-1}if(i.isZero(u)){if(a<d||a>v)return-1}else{var A=1/u,I=(d-a)*A,x=(v-a)*A;if(I>x){var D=I;I=x,x=D}if((T=Math.max(I,T))>(g=Math.min(x,g)))return-1}if(i.isZero(_)){if(o<f||o>E)return-1}else{var M=1/_,L=(f-o)*M,O=(E-o)*M;if(L>O){var N=L;L=O,O=N}if((T=Math.max(L,T))>(g=Math.min(O,g)))return-1}return T}},{key:"intersectsRayAndBoxRP",value:function(e,t,n){var i=Ve.intersectsRayAndBoxRD(e,t);return-1===i?(D._ZERO.cloneTo(n),i):(D.scale(e.direction,i,Ve._tempV30),D.add(e.origin,Ve._tempV30,Ve._tempV31),Ve._tempV31.cloneTo(n),i)}},{key:"intersectsRayAndSphereRD",value:function(e,t){var n=t.radius;D.subtract(e.origin,t.center,Ve._tempV30);var i=D.dot(Ve._tempV30,e.direction),r=D.dot(Ve._tempV30,Ve._tempV30)-n*n;if(r>0&&i>0)return-1;var a=i*i-r;if(a<0)return-1;var o=-i-Math.sqrt(a);return o<0&&(o=0),o}},{key:"intersectsRayAndSphereRP",value:function(e,t,n){var i=Ve.intersectsRayAndSphereRD(e,t);return-1===i?(D._ZERO.cloneTo(n),i):(D.scale(e.direction,i,Ve._tempV30),D.add(e.origin,Ve._tempV30,Ve._tempV31),Ve._tempV31.cloneTo(n),i)}},{key:"intersectsSphereAndTriangle",value:function(e,t,n,i){var r=e.center,a=e.radius;return Ve.closestPointPointTriangle(r,t,n,i,Ve._tempV30),D.subtract(Ve._tempV30,r,Ve._tempV31),D.dot(Ve._tempV31,Ve._tempV31)<=a*a}},{key:"intersectsPlaneAndPoint",value:function(e,t){var n=D.dot(e.normal,t)+e.distance;return n>0?Vn.PlaneIntersectionType_Front:n<0?Vn.PlaneIntersectionType_Back:Vn.PlaneIntersectionType_Intersecting}},{key:"intersectsPlaneAndPlane",value:function(e,t){D.cross(e.normal,t.normal,Ve._tempV30);var n=D.dot(Ve._tempV30,Ve._tempV30);return!i.isZero(n)}},{key:"intersectsPlaneAndPlaneRL",value:function(e,t,n){var r=e.normal,a=t.normal;D.cross(r,a,Ve._tempV34);var o=D.dot(Ve._tempV34,Ve._tempV34);return!i.isZero(o)&&(D.scale(a,e.distance,Ve._tempV30),D.scale(r,t.distance,Ve._tempV31),D.subtract(Ve._tempV30,Ve._tempV31,Ve._tempV32),D.cross(Ve._tempV32,Ve._tempV34,Ve._tempV33),D.normalize(Ve._tempV34,Ve._tempV34),!0)}},{key:"intersectsPlaneAndBox",value:function(e,t){var n=e.distance,i=e.normal,r=i.x,a=i.y,o=i.z,s=t.min,l=s.x,u=s.y,_=s.z,c=t.max,h=c.x,d=c.y,f=c.z;Ve._tempV30.x=r>0?l:h,Ve._tempV30.y=a>0?u:d,Ve._tempV30.z=o>0?_:f,Ve._tempV31.x=r>0?h:l,Ve._tempV31.y=a>0?d:u,Ve._tempV31.z=o>0?f:_;var m=D.dot(i,Ve._tempV30);return m+n>0?Vn.PlaneIntersectionType_Front:(m=D.dot(i,Ve._tempV31))+n<0?Vn.PlaneIntersectionType_Back:Vn.PlaneIntersectionType_Intersecting}},{key:"intersectsPlaneAndSphere",value:function(e,t){var n=t.radius,i=D.dot(e.normal,t.center)+e.distance;return i>n?Vn.PlaneIntersectionType_Front:i<-n?Vn.PlaneIntersectionType_Back:Vn.PlaneIntersectionType_Intersecting}},{key:"intersectsBoxAndBox",value:function(e,t){var n=e.min,i=e.max,r=t.min,a=t.max;return!(n.x>a.x||r.x>i.x||n.y>a.y||r.y>i.y||n.z>a.z||r.z>i.z)}},{key:"intersectsBoxAndSphere",value:function(e,t){var n=t.center,i=t.radius,r=Ve._tempV30;return D.Clamp(n,e.min,e.max,r),D.distanceSquared(n,r)<=i*i}},{key:"intersectsSphereAndSphere",value:function(e,t){var n=e.radius+t.radius;return D.distanceSquared(e.center,t.center)<=n*n}},{key:"boxContainsPoint",value:function(e,t){var n=e.min,i=e.max;return n.x<=t.x&&i.x>=t.x&&n.y<=t.y&&i.y>=t.y&&n.z<=t.z&&i.z>=t.z?Fn.Contains:Fn.Disjoint}},{key:"boxContainsBox",value:function(e,t){var n=e.min,i=n.x,r=n.y,a=n.z,o=e.max,s=o.x,l=o.y,u=o.z,_=t.min,c=_.x,h=_.y,d=_.z,f=t.max,m=f.x,p=f.y,v=f.z;return s<c||i>m||l<h||r>p||u<d||a>v?Fn.Disjoint:i<=c&&m<=s&&r<=h&&p<=l&&a<=d&&v<=u?Fn.Contains:Fn.Intersects}},{key:"boxContainsSphere",value:function(e,t){var n=e.min,i=n.x,r=n.y,a=n.z,o=e.max,s=o.x,l=o.y,u=o.z,_=t.center,c=_.x,h=_.y,d=_.z,f=t.radius;return D.Clamp(_,n,o,Ve._tempV30),D.distanceSquared(_,Ve._tempV30)>f*f?Fn.Disjoint:i+f<=c&&c<=s-f&&s-i>f&&r+f<=h&&h<=l-f&&l-r>f&&a+f<=d&&d<=u-f&&u-a>f?Fn.Contains:Fn.Intersects}},{key:"sphereContainsPoint",value:function(e,t){return D.distanceSquared(t,e.center)<=e.radius*e.radius?Fn.Contains:Fn.Disjoint}},{key:"sphereContainsTriangle",value:function(e,t,n,i){var r=Ve.sphereContainsPoint(e,t),a=Ve.sphereContainsPoint(e,n),o=Ve.sphereContainsPoint(e,i);return r==Fn.Contains&&a==Fn.Contains&&o==Fn.Contains?Fn.Contains:Ve.intersectsSphereAndTriangle(e,t,n,i)?Fn.Intersects:Fn.Disjoint}},{key:"sphereContainsBox",value:function(e,t){var n=e.center,i=(n.x,n.y,n.z,e.radius),r=t.min,a=(r.x,r.y,r.z,t.max),o=(a.x,a.y,a.z,Ve._tempV30);if(o.x,o.y,o.z,!Ve.intersectsBoxAndSphere(t,e))return Fn.Disjoint;var s=i*i;return D.scalarLengthSquared(Ve._tempV30)>s?Fn.Intersects:D.scalarLengthSquared(Ve._tempV30)>s?Fn.Intersects:D.scalarLengthSquared(Ve._tempV30)>s?Fn.Intersects:D.scalarLengthSquared(Ve._tempV30)>s?Fn.Intersects:D.scalarLengthSquared(Ve._tempV30)>s?Fn.Intersects:D.scalarLengthSquared(Ve._tempV30)>s?Fn.Intersects:D.scalarLengthSquared(Ve._tempV30)>s?Fn.Intersects:D.scalarLengthSquared(Ve._tempV30)>s?Fn.Intersects:Fn.Contains}},{key:"sphereContainsSphere",value:function(e,t){var n=e.radius,i=t.radius,r=D.distance(e.center,t.center);return n+i<r?Fn.Disjoint:n-i<r?Fn.Intersects:Fn.Contains}},{key:"closestPointPointTriangle",value:function(e,t,n,i,r){D.subtract(n,t,Ve._tempV30),D.subtract(i,t,Ve._tempV31),D.subtract(e,t,Ve._tempV32),D.subtract(e,n,Ve._tempV33),D.subtract(e,i,Ve._tempV34);var a=D.dot(Ve._tempV30,Ve._tempV32),o=D.dot(Ve._tempV31,Ve._tempV32),s=D.dot(Ve._tempV30,Ve._tempV33),l=D.dot(Ve._tempV31,Ve._tempV33),u=D.dot(Ve._tempV30,Ve._tempV34),_=D.dot(Ve._tempV31,Ve._tempV34);if(a<=0&&o<=0)t.cloneTo(r);else if(s>=0&&l<=s)n.cloneTo(r);else{var c=a*l-s*o;if(c<=0&&a>=0&&s<=0){var h=a/(a-s);return D.scale(Ve._tempV30,h,r),void D.add(t,r,r)}if(_>=0&&u<=_)i.cloneTo(r);else{var d=u*o-a*_;if(d<=0&&o>=0&&_<=0){var f=o/(o-_);return D.scale(Ve._tempV31,f,r),void D.add(t,r,r)}var m=s*_-u*l;if(m<=0&&l-s>=0&&u-_>=0){var p=(l-s)/(l-s+(u-_));return D.subtract(i,n,r),D.scale(r,p,r),void D.add(n,r,r)}var v=1/(m+d+c),E=d*v,T=c*v;D.scale(Ve._tempV30,E,Ve._tempV35),D.scale(Ve._tempV31,T,Ve._tempV36),D.add(Ve._tempV35,Ve._tempV36,r),D.add(t,r,r)}}}},{key:"closestPointPlanePoint",value:function(e,t,n){var i=e.normal,r=D.dot(i,t)-e.distance;D.scale(i,r,Ve._tempV30),D.subtract(t,Ve._tempV30,n)}},{key:"closestPointBoxPoint",value:function(e,t,n){D.max(t,e.min,Ve._tempV30),D.min(Ve._tempV30,e.max,n)}},{key:"closestPointSpherePoint",value:function(e,t,n){var i=e.center;D.subtract(t,i,n),D.normalize(n,n),D.scale(n,e.radius,n),D.add(n,i,n)}},{key:"closestPointSphereSphere",value:function(e,t,n){var i=e.center;D.subtract(t.center,i,n),D.normalize(n,n),D.scale(n,e.radius,n),D.add(n,i,n)}}]),Ve}();Un._tempV30=new D,Un._tempV31=new D,Un._tempV32=new D,Un._tempV33=new D,Un._tempV34=new D,Un._tempV35=new D,Un._tempV36=new D,(u=e.FrustumCorner||(e.FrustumCorner={}))[u.FarBottomLeft=0]="FarBottomLeft",u[u.FarTopLeft=1]="FarTopLeft",u[u.FarTopRight=2]="FarTopRight",u[u.FarBottomRight=3]="FarBottomRight",u[u.nearBottomLeft=4]="nearBottomLeft",u[u.nearTopLeft=5]="nearTopLeft",u[u.nearTopRight=6]="nearTopRight",u[u.nearBottomRight=7]="nearBottomRight",u[u.unknown=8]="unknown";var Gn=function(){function Be(e){_classCallCheck(this,Be),this._matrix=e,this._near=new Vn(new D),this._far=new Vn(new D),this._left=new Vn(new D),this._right=new Vn(new D),this._top=new Vn(new D),this._bottom=new Vn(new D),Be.getPlanesFromMatrix(this._matrix,this._near,this._far,this._left,this._right,this._top,this._bottom)}return _createClass(Be,[{key:"equalsBoundFrustum",value:function(e){return this._matrix.equalsOtherMatrix(e.matrix)}},{key:"equalsObj",value:function(e){if(e instanceof Be){var t=e;return this.equalsBoundFrustum(t)}return!1}},{key:"getPlane",value:function(e){switch(e){case 0:return this._near;case 1:return this._far;case 2:return this._left;case 3:return this._right;case 4:return this._top;case 5:return this._bottom;default:return null}}},{key:"getCorners",value:function(t){Be.get3PlaneInterPoint(this._near,this._bottom,this._right,t[e.FrustumCorner.nearBottomRight]),Be.get3PlaneInterPoint(this._near,this._top,this._right,t[e.FrustumCorner.nearTopRight]),Be.get3PlaneInterPoint(this._near,this._top,this._left,t[e.FrustumCorner.nearTopLeft]),Be.get3PlaneInterPoint(this._near,this._bottom,this._left,t[e.FrustumCorner.nearBottomLeft]),Be.get3PlaneInterPoint(this._far,this._bottom,this._right,t[e.FrustumCorner.FarBottomRight]),Be.get3PlaneInterPoint(this._far,this._top,this._right,t[e.FrustumCorner.FarTopRight]),Be.get3PlaneInterPoint(this._far,this._top,this._left,t[e.FrustumCorner.FarTopLeft]),Be.get3PlaneInterPoint(this._far,this._bottom,this._left,t[e.FrustumCorner.FarBottomLeft])}},{key:"containsPoint",value:function(e){for(var t=Vn.PlaneIntersectionType_Front,n=Vn.PlaneIntersectionType_Front,i=0;i<6;i++){switch(i){case 0:n=Un.intersectsPlaneAndPoint(this._near,e);break;case 1:n=Un.intersectsPlaneAndPoint(this._far,e);break;case 2:n=Un.intersectsPlaneAndPoint(this._left,e);break;case 3:n=Un.intersectsPlaneAndPoint(this._right,e);break;case 4:n=Un.intersectsPlaneAndPoint(this._top,e);break;case 5:n=Un.intersectsPlaneAndPoint(this._bottom,e)}switch(n){case Vn.PlaneIntersectionType_Back:return Fn.Disjoint;case Vn.PlaneIntersectionType_Intersecting:t=Vn.PlaneIntersectionType_Intersecting}}switch(t){case Vn.PlaneIntersectionType_Intersecting:return Fn.Intersects;default:return Fn.Contains}}},{key:"intersects",value:function(e){var t=e.min,n=e.max,i=t.x,r=t.y,a=t.z,o=n.x,s=n.y,l=n.z,u=this._near.normal;if(this._near.distance+u.x*(u.x<0?i:o)+u.y*(u.y<0?r:s)+u.z*(u.z<0?a:l)<0)return!1;var _=this._left.normal;if(this._left.distance+_.x*(_.x<0?i:o)+_.y*(_.y<0?r:s)+_.z*(_.z<0?a:l)<0)return!1;var c=this._right.normal;if(this._right.distance+c.x*(c.x<0?i:o)+c.y*(c.y<0?r:s)+c.z*(c.z<0?a:l)<0)return!1;var h=this._bottom.normal;if(this._bottom.distance+h.x*(h.x<0?i:o)+h.y*(h.y<0?r:s)+h.z*(h.z<0?a:l)<0)return!1;var d=this._top.normal;if(this._top.distance+d.x*(d.x<0?i:o)+d.y*(d.y<0?r:s)+d.z*(d.z<0?a:l)<0)return!1;var f=this._far.normal;return!(this._far.distance+f.x*(f.x<0?i:o)+f.y*(f.y<0?r:s)+f.z*(f.z<0?a:l)<0)}},{key:"containsBoundBox",value:function(e){for(var t=Be._tempV30,n=Be._tempV31,i=e.min,r=e.max,a=Fn.Contains,o=0;o<6;o++){var s=this.getPlane(o),l=s.normal;if(l.x>=0?(t.x=r.x,n.x=i.x):(t.x=i.x,n.x=r.x),l.y>=0?(t.y=r.y,n.y=i.y):(t.y=i.y,n.y=r.y),l.z>=0?(t.z=r.z,n.z=i.z):(t.z=i.z,n.z=r.z),Un.intersectsPlaneAndPoint(s,t)===Vn.PlaneIntersectionType_Back)return Fn.Disjoint;Un.intersectsPlaneAndPoint(s,n)===Vn.PlaneIntersectionType_Back&&(a=Fn.Intersects)}return a}},{key:"containsBoundSphere",value:function(e){for(var t=Vn.PlaneIntersectionType_Front,n=Vn.PlaneIntersectionType_Front,i=0;i<6;i++){switch(i){case 0:n=Un.intersectsPlaneAndSphere(this._near,e);break;case 1:n=Un.intersectsPlaneAndSphere(this._far,e);break;case 2:n=Un.intersectsPlaneAndSphere(this._left,e);break;case 3:n=Un.intersectsPlaneAndSphere(this._right,e);break;case 4:n=Un.intersectsPlaneAndSphere(this._top,e);break;case 5:n=Un.intersectsPlaneAndSphere(this._bottom,e)}switch(n){case Vn.PlaneIntersectionType_Back:return Fn.Disjoint;case Vn.PlaneIntersectionType_Intersecting:t=Vn.PlaneIntersectionType_Intersecting}}switch(t){case Vn.PlaneIntersectionType_Intersecting:return Fn.Intersects;default:return Fn.Contains}}},{key:"matrix",get:function(){return this._matrix},set:function(e){e.cloneTo(this._matrix),Be.getPlanesFromMatrix(this._matrix,this._near,this._far,this._left,this._right,this._top,this._bottom)}},{key:"near",get:function(){return this._near}},{key:"far",get:function(){return this._far}},{key:"left",get:function(){return this._left}},{key:"right",get:function(){return this._right}},{key:"top",get:function(){return this._top}},{key:"bottom",get:function(){return this._bottom}}],[{key:"getPlanesFromMatrix",value:function(e,t,n,i,r,a,o){var s=e.elements,l=s[0],u=s[1],_=s[2],c=s[3],h=s[4],d=s[5],f=s[6],m=s[7],p=s[8],v=s[9],E=s[10],T=s[11],g=s[12],y=s[13],S=s[14],R=s[15],C=t.normal;C.x=_,C.y=f,C.z=E,t.distance=S,t.normalize();var A=n.normal;A.x=c-_,A.y=m-f,A.z=T-E,n.distance=R-S,n.normalize();var I=i.normal;I.x=c+l,I.y=m+h,I.z=T+p,i.distance=R+g,i.normalize();var x=r.normal;x.x=c-l,x.y=m-h,x.z=T-p,r.distance=R-g,r.normalize();var D=a.normal;D.x=c-u,D.y=m-d,D.z=T-v,a.distance=R-y,a.normalize();var M=o.normal;M.x=c+u,M.y=m+d,M.z=T+v,o.distance=R+y,o.normalize()}},{key:"get3PlaneInterPoint",value:function(e,t,n,i){var r=e.normal,a=t.normal,o=n.normal;D.cross(a,o,Be._tempV30),D.cross(o,r,Be._tempV31),D.cross(r,a,Be._tempV32);var s=D.dot(r,Be._tempV30),l=D.dot(a,Be._tempV31),u=D.dot(o,Be._tempV32);D.scale(Be._tempV30,-e.distance/s,Be._tempV33),D.scale(Be._tempV31,-t.distance/l,Be._tempV34),D.scale(Be._tempV32,-n.distance/u,Be._tempV35),D.add(Be._tempV33,Be._tempV34,Be._tempV36),D.add(Be._tempV35,Be._tempV36,i)}}]),Be}();Gn._tempV30=new D,Gn._tempV31=new D,Gn._tempV32=new D,Gn._tempV33=new D,Gn._tempV34=new D,Gn._tempV35=new D,Gn._tempV36=new D;var Hn=function(){function Fe(e,t,n,i){_classCallCheck(this,Fe),this.minDepth=0,this.maxDepth=1,this.x=e,this.y=t,this.width=n,this.height=i}return _createClass(Fe,[{key:"project",value:function(e,t,n){D.transformV3ToV4(e,t,n);var i=n.x,r=n.y,a=n.z,o=n.w;1!==o&&(i/=o,r/=o,a/=o),n.x=.5*(i+1)*this.width+this.x,n.y=.5*(1-r)*this.height+this.y,n.z=a*(this.maxDepth-this.minDepth)+this.minDepth}},{key:"unprojectFromMat",value:function(e,t,n){var i=t.elements;n.x=(e.x-this.x)/this.width*2-1,n.y=-((e.y-this.y)/this.height*2-1),n.z=(e.z-this.minDepth)/(this.maxDepth-this.minDepth);var r=n.x*i[3]+n.y*i[7]+n.z*i[11]+i[15];D.transformV3ToV3(n,t,n),1!==r&&(n.x=n.x/r,n.y=n.y/r,n.z=n.z/r)}},{key:"unprojectFromWVP",value:function(e,t,n,i,r){q.multiply(t,n,Fe._tempMatrix4x4),i&&q.multiply(Fe._tempMatrix4x4,i,Fe._tempMatrix4x4),Fe._tempMatrix4x4.invert(Fe._tempMatrix4x4),this.unprojectFromMat(e,Fe._tempMatrix4x4,r)}},{key:"cloneTo",value:function(e){e.x=this.x,e.y=this.y,e.width=this.width,e.height=this.height,e.minDepth=this.minDepth,e.maxDepth=this.maxDepth}}]),Fe}();Hn._tempMatrix4x4=new q;var zn=function(){function Ue(){_classCallCheck(this,Ue)}return _createClass(Ue,null,[{key:"calculateCursorRay",value:function(e,t,n,i,r,a){var o=e.x,s=e.y,l=Ue._tempVector30,u=l;u.x=o,u.y=s,u.z=t.minDepth;var _=Ue._tempVector31,c=_;c.x=o,c.y=s,c.z=t.maxDepth;var h=a.origin,d=Ue._tempVector32;t.unprojectFromWVP(l,n,i,r,h),t.unprojectFromWVP(_,n,i,r,d);var f=a.direction;f.x=d.x-h.x,f.y=d.y-h.y,f.z=d.z-h.z,D.normalize(a.direction,a.direction)}},{key:"rayIntersectsTriangle",value:function(e,t,n,i){var r=Ue._tempVector30,a=Ue._tempVector31;D.subtract(n,t,r),D.subtract(i,t,a);var o,s=Ue._tempVector32;if(D.cross(e.direction,a,s),(o=D.dot(r,s))>-Number.MIN_VALUE&&o<Number.MIN_VALUE)return Number.NaN;var l,u=1/o,_=Ue._tempVector33;if(D.subtract(e.origin,t,_),l=D.dot(_,s),(l*=u)<0||l>1)return Number.NaN;var c,h,d=Ue._tempVector34;return D.cross(_,r,d),c=D.dot(e.direction,d),(c*=u)<0||l+c>1?Number.NaN:(h=D.dot(a,d),(h*=u)<0?Number.NaN:h)}}]),Ue}();zn._tempVector30=new D,zn._tempVector31=new D,zn._tempVector32=new D,zn._tempVector33=new D,zn._tempVector34=new D,(_=e.IndexFormat||(e.IndexFormat={}))[_.UInt8=0]="UInt8",_[_.UInt16=1]="UInt16",_[_.UInt32=2]="UInt32";var Wn=function(n){function Ge(n,i){var r,a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:35044,o=arguments.length>3&&void 0!==arguments[3]&&arguments[3];switch(_classCallCheck(this,Ge),(r=_possibleConstructorReturn(this,_getPrototypeOf(Ge).call(this)))._indexType=n,r._indexCount=i,r._bufferUsage=a,r._bufferType=t.LayaGL.instance.ELEMENT_ARRAY_BUFFER,r._canRead=o,n){case e.IndexFormat.UInt32:r._indexTypeByteCount=4;break;case e.IndexFormat.UInt16:r._indexTypeByteCount=2;break;case e.IndexFormat.UInt8:r._indexTypeByteCount=1;break;default:throw new Error("unidentification index type.")}var s=r._indexTypeByteCount*i,l=t.BufferStateBase._curBindedBufferState;if(r._byteLength=s,l?l._bindedIndexBuffer===_assertThisInitialized(r)?t.LayaGL.instance.bufferData(r._bufferType,s,r._bufferUsage):(l.unBind(),r.bind(),t.LayaGL.instance.bufferData(r._bufferType,s,r._bufferUsage),l.bind()):(r.bind(),t.LayaGL.instance.bufferData(r._bufferType,s,r._bufferUsage)),o)switch(n){case e.IndexFormat.UInt32:r._buffer=new Uint32Array(i);break;case e.IndexFormat.UInt16:r._buffer=new Uint16Array(i);break;case e.IndexFormat.UInt8:r._buffer=new Uint8Array(i)}return r}return _inherits(Ge,t.Buffer),_createClass(Ge,[{key:"_bindForVAO",value:function(){if(!t.BufferStateBase._curBindedBufferState)throw"IndexBuffer3D: must bind current BufferState.";var e=t.LayaGL.instance;e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this._glBuffer)}},{key:"bind",value:function(){if(t.BufferStateBase._curBindedBufferState)throw"IndexBuffer3D: must unbind current BufferState.";if(t.Buffer._bindedIndexBuffer!==this._glBuffer){var e=t.LayaGL.instance;return e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this._glBuffer),t.Buffer._bindedIndexBuffer=this._glBuffer,!0}return!1}},{key:"setData",value:function(n){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:4294967295,o=this._indexTypeByteCount;if(0!==r||4294967295!==a)switch(this._indexType){case e.IndexFormat.UInt32:n=new Uint32Array(n.buffer,r*o,a);break;case e.IndexFormat.UInt16:n=new Uint16Array(n.buffer,r*o,a);break;case e.IndexFormat.UInt8:n=new Uint8Array(n.buffer,r*o,a)}var s=t.BufferStateBase._curBindedBufferState;if(s?s._bindedIndexBuffer===this?t.LayaGL.instance.bufferSubData(this._bufferType,i*o,n):(s.unBind(),this.bind(),t.LayaGL.instance.bufferSubData(this._bufferType,i*o,n),s.bind()):(this.bind(),t.LayaGL.instance.bufferSubData(this._bufferType,i*o,n)),this._canRead)if(0!==i||0!==r||4294967295!==a){var l=this._buffer.length-i;a>l&&(a=l);for(var u=0;u<a;u++)this._buffer[i+u]=n[u]}else this._buffer=n}},{key:"getData",value:function(){if(this._canRead)return this._buffer;throw new Error("Can't read data from VertexBuffer with only write flag!")}},{key:"destroy",value:function(){_get(_getPrototypeOf(Ge.prototype),"destroy",this).call(this),this._buffer=null,this._byteLength=0,this._indexCount=0}},{key:"indexType",get:function(){return this._indexType}},{key:"indexTypeByteCount",get:function(){return this._indexTypeByteCount}},{key:"indexCount",get:function(){return this._indexCount}},{key:"canRead",get:function(){return this._canRead}}]),Ge}(),Xn=function(){function He(){_classCallCheck(this,He)}return _createClass(He,null,[{key:"__init__",value:function(){He.instanceWorldMatrixDeclaration=new Tn(64,[new gn(0,vn.Vector4,He.MESH_WORLDMATRIX_ROW0),new gn(16,vn.Vector4,He.MESH_WORLDMATRIX_ROW1),new gn(32,vn.Vector4,He.MESH_WORLDMATRIX_ROW2),new gn(48,vn.Vector4,He.MESH_WORLDMATRIX_ROW3)]),He.instanceSimpleAnimatorDeclaration=new Tn(16,[new gn(0,vn.Vector4,He.MESH_SIMPLEANIMATOR)])}},{key:"getVertexDeclaration",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],n=He._vertexDeclarationMap[e+(t?"_0":"_1")];if(!n){for(var i=e.split(","),r=0,a=[],o=0,s=i.length;o<s;o++){var l;switch(i[o]){case"POSITION":l=new gn(r,vn.Vector3,He.MESH_POSITION0),r+=12;break;case"NORMAL":l=new gn(r,vn.Vector3,He.MESH_NORMAL0),r+=12;break;case"COLOR":l=new gn(r,vn.Vector4,He.MESH_COLOR0),r+=16;break;case"UV":l=new gn(r,vn.Vector2,He.MESH_TEXTURECOORDINATE0),r+=8;break;case"UV1":l=new gn(r,vn.Vector2,He.MESH_TEXTURECOORDINATE1),r+=8;break;case"BLENDWEIGHT":l=new gn(r,vn.Vector4,He.MESH_BLENDWEIGHT0),r+=16;break;case"BLENDINDICES":t?(l=new gn(r,vn.Vector4,He.MESH_BLENDINDICES0),r+=16):(l=new gn(r,vn.Byte4,He.MESH_BLENDINDICES0),r+=4);break;case"TANGENT":l=new gn(r,vn.Vector4,He.MESH_TANGENT0),r+=16;break;default:throw"VertexMesh: unknown vertex flag."}a.push(l)}n=new Tn(r,a),He._vertexDeclarationMap[e+(t?"_0":"_1")]=n}return n}}]),He}();Xn.MESH_POSITION0=0,Xn.MESH_COLOR0=1,Xn.MESH_TEXTURECOORDINATE0=2,Xn.MESH_NORMAL0=3,Xn.MESH_TANGENT0=4,Xn.MESH_BLENDINDICES0=5,Xn.MESH_BLENDWEIGHT0=6,Xn.MESH_TEXTURECOORDINATE1=7,Xn.MESH_WORLDMATRIX_ROW0=8,Xn.MESH_WORLDMATRIX_ROW1=9,Xn.MESH_WORLDMATRIX_ROW2=10,Xn.MESH_WORLDMATRIX_ROW3=11,Xn.MESH_SIMPLEANIMATOR=12,Xn.MESH_CUSTOME0=12,Xn.MESH_CUSTOME1=13,Xn.MESH_CUSTOME2=14,Xn.MESH_CUSTOME3=15,Xn._vertexDeclarationMap={};var Yn=function(){function ze(){_classCallCheck(this,ze)}return _createClass(ze,[{key:"_render",value:function(e){}}]),ze}(),jn=function(n){function ke(){var n;_classCallCheck(this,ke),n=_possibleConstructorReturn(this,_getPrototypeOf(ke).call(this));var i=t.LayaGL.instance,r=new Float32Array([-1,1,-1,1,1,-1,1,1,1,-1,1,1,-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,1]),a=new Uint8Array([0,1,2,2,3,0,4,7,6,6,5,4,0,3,7,7,4,0,1,5,6,6,2,1,3,2,6,6,7,3,0,4,5,5,1,0]),o=Xn.getVertexDeclaration("POSITION");n._vertexBuffer=new pn(8*o.vertexStride,i.STATIC_DRAW,!1),n._vertexBuffer.vertexDeclaration=o,n._indexBuffer=new Wn(e.IndexFormat.UInt8,36,i.STATIC_DRAW,!1),n._vertexBuffer.setData(r.buffer),n._indexBuffer.setData(a);var s=new yn;return s.bind(),s.applyVertexBuffer(n._vertexBuffer),s.applyIndexBuffer(n._indexBuffer),s.unBind(),n._bufferState=s,n}return _inherits(ke,Yn),_createClass(ke,[{key:"_render",value:function(e){var n=t.LayaGL.instance;n.drawElements(n.TRIANGLES,36,n.UNSIGNED_BYTE,0),t.Stat.trianglesFaces+=12,t.Stat.renderBatches++}}],[{key:"__init__",value:function(){ke.instance=new ke}}]),ke}(),Zn=function(){function We(){_classCallCheck(this,We),this._mesh=jn.instance}return _createClass(We,[{key:"_isAvailable",value:function(){return!(!this._material||!this._mesh)}},{key:"_render",value:function(e){if(this._material&&this._mesh){var n=t.LayaGL.instance,i=e.scene,r=e.cameraShaderValue,a=e.camera,o=En._SET_RUNTIME_VALUE_MODE_REFERENCE_;t.ILaya.Render.supportWebGLPlusRendering&&En.setRuntimeValueMode(!1),t.WebGLContext.setCullFace(n,!1),t.WebGLContext.setDepthFunc(n,n.LEQUAL),t.WebGLContext.setDepthMask(n,!1);var s=We._compileDefine;this._material._shaderValues._defineDatas.cloneTo(s);var l=e.shader=this._material._shader.getSubShaderAt(0)._passes[0].withCompile(s),u=l.bind(),_=t.Stat.loopCount!==l._uploadMark,c=l._uploadScene!==i||_;(c||u)&&(l.uploadUniforms(l._sceneUniformParamsMap,i._shaderValues,c),l._uploadScene=i);var h=l._uploadCameraShaderValue!==r||_;if(h||u){var d=We._tempMatrix0,f=We._tempMatrix1;a.viewMatrix.cloneTo(d),a.projectionMatrix.cloneTo(f),d.setTranslationVector(D._ZERO),a.orthographic&&q.createPerspective(a.fieldOfView,a.aspectRatio,a.nearPlane,a.farPlane,f);var m=1/Math.tan(3.1416*a.fieldOfView/180*.5);f.elements[0]=m/a.aspectRatio,f.elements[5]=m,f.elements[10]=-.999999,f.elements[11]=-1,f.elements[14]=-0,a._applyViewProject(e,d,f),l.uploadUniforms(l._cameraUniformParamsMap,r,h),l._uploadCameraShaderValue=r}var p=l._uploadMaterial!==this._material||_;(p||u)&&(l.uploadUniforms(l._materialUniformParamsMap,this._material._shaderValues,p),l._uploadMaterial=this._material),this._mesh._bufferState.bind(),this._mesh._render(e),t.ILaya.Render.supportWebGLPlusRendering&&En.setRuntimeValueMode(o),t.WebGLContext.setDepthFunc(n,n.LESS),t.WebGLContext.setDepthMask(n,!0),a._applyViewProject(e,a.viewMatrix,a.projectionMatrix)}}},{key:"destroy",value:function(){this._material&&(this._material._removeReference(),this._material=null)}},{key:"material",get:function(){return this._material},set:function(e){this._material!==e&&(this._material&&this._material._removeReference(),e&&e._addReference(),this._material=e)}},{key:"mesh",get:function(){return this._mesh},set:function(e){this._mesh!==e&&(this._mesh=e)}}]),We}();Zn._tempMatrix0=new q,Zn._tempMatrix1=new q,Zn._compileDefine=new mn;var qn=function(e){function Xe(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:.3,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1e3;return _classCallCheck(this,Xe),(e=_possibleConstructorReturn(this,_getPrototypeOf(Xe).call(this)))._skyRenderer=new Zn,e._forward=new D,e._up=new D,e.clearColor=new o(100/255,149/255,237/255,1),e._shaderValues=new En(null),e._fieldOfView=60,e._useUserProjectionMatrix=!1,e._orthographic=!1,e._orthographicVerticalSize=10,e.renderingOrder=0,e._nearPlane=t,e._farPlane=n,e.cullingMask=2147483647,e.useOcclusionCulling=!0,e}return _inherits(Xe,Nn),_createClass(Xe,[{key:"_sortCamerasByRenderingOrder",value:function(){if(this.displayedInStage)for(var e=this.scene._cameraPool,t=e.length-1,n=0;n<t;n++)if(e[n].renderingOrder>e[t].renderingOrder){var i=e[n];e[n]=e[t],e[t]=i}}},{key:"_calculateProjectionMatrix",value:function(){}},{key:"_onScreenSizeChanged",value:function(){this._calculateProjectionMatrix()}},{key:"_prepareCameraToRender",value:function(){var e=this._shaderValues;this.transform.getForward(this._forward),this.transform.getUp(this._up),e.setVector3(Xe.CAMERAPOS,this.transform.position),e.setVector3(Xe.CAMERADIRECTION,this._forward),e.setVector3(Xe.CAMERAUP,this._up)}},{key:"render",value:function(){arguments.length>0&&void 0!==arguments[0]&&arguments[0],arguments.length>1&&void 0!==arguments[1]&&arguments[1]}},{key:"addLayer",value:function(e){this.cullingMask|=Math.pow(2,e)}},{key:"removeLayer",value:function(e){this.cullingMask&=~Math.pow(2,e)}},{key:"addAllLayers",value:function(){this.cullingMask=2147483647}},{key:"removeAllLayers",value:function(){this.cullingMask=0}},{key:"resetProjectionMatrix",value:function(){this._useUserProjectionMatrix=!1,this._calculateProjectionMatrix()}},{key:"_onActive",value:function(){this._scene._addCamera(this),_get(_getPrototypeOf(Xe.prototype),"_onActive",this).call(this)}},{key:"_onInActive",value:function(){this._scene._removeCamera(this),_get(_getPrototypeOf(Xe.prototype),"_onInActive",this).call(this)}},{key:"_parse",value:function(e,n){_get(_getPrototypeOf(Xe.prototype),"_parse",this).call(this,e,n),this.orthographic=e.orthographic,void 0!==e.orthographicVerticalSize&&(this.orthographicVerticalSize=e.orthographicVerticalSize),void 0!==e.fieldOfView&&(this.fieldOfView=e.fieldOfView),this.nearPlane=e.nearPlane,this.farPlane=e.farPlane;var i=e.clearColor;this.clearColor=new o(i[0],i[1],i[2],i[3]);var r=e.skyboxMaterial;r&&(this._skyRenderer.material=t.Loader.getRes(r.path))}},{key:"destroy",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];this._skyRenderer.destroy(),this._skyRenderer=null,t.Laya.stage.off(t.Event.RESIZE,this,this._onScreenSizeChanged),_get(_getPrototypeOf(Xe.prototype),"destroy",this).call(this,e)}},{key:"_create",value:function(){return new Xe}},{key:"skyRenderer",get:function(){return this._skyRenderer}},{key:"fieldOfView",get:function(){return this._fieldOfView},set:function(e){this._fieldOfView=e,this._calculateProjectionMatrix()}},{key:"nearPlane",get:function(){return this._nearPlane},set:function(e){this._nearPlane=e,this._calculateProjectionMatrix()}},{key:"farPlane",get:function(){return this._farPlane},set:function(e){this._farPlane=e,this._calculateProjectionMatrix()}},{key:"orthographic",get:function(){return this._orthographic},set:function(e){this._orthographic=e,this._calculateProjectionMatrix()}},{key:"orthographicVerticalSize",get:function(){return this._orthographicVerticalSize},set:function(e){this._orthographicVerticalSize=e,this._calculateProjectionMatrix()}},{key:"renderingOrder",get:function(){return this._renderingOrder},set:function(e){this._renderingOrder=e,this._sortCamerasByRenderingOrder()}}]),Xe}();qn._tempMatrix4x40=new q,qn.CAMERAPOS=xn.propertyNameToID("u_CameraPos"),qn.VIEWMATRIX=xn.propertyNameToID("u_View"),qn.PROJECTMATRIX=xn.propertyNameToID("u_Projection"),qn.VIEWPROJECTMATRIX=xn.propertyNameToID("u_ViewProjection"),qn.CAMERADIRECTION=xn.propertyNameToID("u_CameraDirection"),qn.CAMERAUP=xn.propertyNameToID("u_CameraUp"),qn.VIEWPORT=xn.propertyNameToID("u_Viewport"),qn.PROJECTION_PARAMS=xn.propertyNameToID("u_ProjectionParams"),qn.DEPTHTEXTURE=xn.propertyNameToID("u_CameraDepthTexture"),qn.DEPTHNORMALSTEXTURE=xn.propertyNameToID("u_CameraDepthNormalsTexture"),qn.DEPTHZBUFFERPARAMS=xn.propertyNameToID("u_ZBufferParams"),qn.SHADERDEFINE_DEPTH=xn.getDefineByName("DEPTHMAP"),qn.SHADERDEFINE_DEPTHNORMALS=xn.getDefineByName("DEPTHNORMALSMAP"),qn.RENDERINGTYPE_DEFERREDLIGHTING="DEFERREDLIGHTING",qn.RENDERINGTYPE_FORWARDRENDERING="FORWARDRENDERING",qn._invertYScaleMatrix=new q(1,0,0,0,0,-1,0,0,0,0,1,0,0,0,0,1),qn._invertYProjectionMatrix=new q,qn._invertYProjectionViewMatrix=new q,qn.CLEARFLAG_SOLIDCOLOR=0,qn.CLEARFLAG_SKY=1,qn.CLEARFLAG_DEPTHONLY=2,qn.CLEARFLAG_NONE=3,(c=e.ShadowMode||(e.ShadowMode={}))[c.None=0]="None",c[c.Hard=1]="Hard",c[c.SoftLow=2]="SoftLow",c[c.SoftHigh=3]="SoftHigh";var Qn=function Ye(){_classCallCheck(this,Ye)};(h=e.LightType||(e.LightType={}))[h.Directional=0]="Directional",h[h.Spot=1]="Spot",h[h.Point=2]="Point";var Kn=function(t){function je(){var t;return _classCallCheck(this,je),(t=_possibleConstructorReturn(this,_getPrototypeOf(je).call(this)))._shadowMode=e.ShadowMode.None,t._isAlternate=!1,t._shadowResolution=2048,t._shadowDistance=50,t._shadowDepthBias=1,t._shadowNormalBias=1,t._shadowNearPlane=.1,t._shadowStrength=1,t._lightWoldMatrix=new q,t._intensity=1,t._intensityColor=new D,t.color=new D(1,1,1),t._lightmapBakedType=je.LIGHTMAPBAKEDTYPE_REALTIME,t}return _inherits(je,Nn),_createClass(je,[{key:"_parse",value:function(e,t){_get(_getPrototypeOf(je.prototype),"_parse",this).call(this,e,t);var n=e.color;this.color.fromArray(n),this.intensity=e.intensity,this.lightmapBakedType=e.lightmapBakedType}},{key:"_cloneTo",value:function(e,t,n){_get(_getPrototypeOf(je.prototype),"_cloneTo",this).call(this,e,t,n);var i=e;i.color=this.color.clone(),i.intensity=this.intensity,i.lightmapBakedType=this.lightmapBakedType}},{key:"_addToScene",value:function(){var e=this._scene,t=It._config.maxLightCount;e._lightCount<t?(e._lightCount++,this._addToLightQueue(),this._isAlternate=!1):(e._alternateLights.add(this),this._isAlternate=!0,console.warn("LightSprite:light count has large than maxLightCount,the latest added light will be ignore."))}},{key:"_removeFromScene",value:function(){var e=this._scene;if(this._isAlternate)e._alternateLights.remove(this);else if(e._lightCount--,this._removeFromLightQueue(),e._alternateLights._length>0){var t=e._alternateLights.shift();t._addToLightQueue(),t._isAlternate=!1,e._lightCount++}}},{key:"_addToLightQueue",value:function(){}},{key:"_removeFromLightQueue",value:function(){}},{key:"_onActive",value:function(){_get(_getPrototypeOf(je.prototype),"_onActive",this).call(this),this.lightmapBakedType!==je.LIGHTMAPBAKEDTYPE_BAKED&&this._addToScene()}},{key:"_onInActive",value:function(){_get(_getPrototypeOf(je.prototype),"_onInActive",this).call(this),this.lightmapBakedType!==je.LIGHTMAPBAKEDTYPE_BAKED&&this._removeFromScene()}},{key:"_create",value:function(){return new je}},{key:"intensity",get:function(){return this._intensity},set:function(e){this._intensity=e}},{key:"shadowMode",get:function(){return this._shadowMode},set:function(e){this._shadowMode=e}},{key:"shadowDistance",get:function(){return this._shadowDistance},set:function(e){this._shadowDistance=e}},{key:"shadowResolution",get:function(){return this._shadowResolution},set:function(e){this._shadowResolution=e}},{key:"shadowDepthBias",get:function(){return this._shadowDepthBias},set:function(e){this._shadowDepthBias=e}},{key:"shadowNormalBias",get:function(){return this._shadowNormalBias},set:function(e){this._shadowNormalBias=e}},{key:"shadowStrength",get:function(){return this._shadowStrength},set:function(e){this._shadowStrength=e}},{key:"shadowNearPlane",get:function(){return this._shadowNearPlane},set:function(e){this._shadowNearPlane=e}},{key:"lightmapBakedType",get:function(){return this._lightmapBakedType},set:function(e){this._lightmapBakedType!==e&&(this._lightmapBakedType=e,this.activeInHierarchy&&(e!==je.LIGHTMAPBAKEDTYPE_BAKED?this._addToScene():this._removeFromScene()))}},{key:"lightWorldMatrix",get:function(){var e=this.transform.position,t=this.transform.rotation;return q.createAffineTransformation(e,t,D._ONE,this._lightWoldMatrix),this._lightWoldMatrix}},{key:"diffuseColor",get:function(){return console.log("LightSprite: discard property,please use color property instead."),this.color},set:function(e){console.log("LightSprite: discard property,please use color property instead."),this.color=e}}]),je}();Kn.LIGHTMAPBAKEDTYPE_REALTIME=0,Kn.LIGHTMAPBAKEDTYPE_MIXED=1,Kn.LIGHTMAPBAKEDTYPE_BAKED=2,(d=e.ShadowCascadesMode||(e.ShadowCascadesMode={}))[d.NoCascades=0]="NoCascades",d[d.TwoCascades=1]="TwoCascades",d[d.FourCascades=2]="FourCascades",function(e){e[e.Near=0]="Near",e[e.Far=1]="Far",e[e.Left=2]="Left",e[e.Right=3]="Right",e[e.Bottom=4]="Bottom",e[e.Top=5]="Top"}(f||(f={}));var Jn=function(){function Ze(){_classCallCheck(this,Ze)}return _createClass(Ze,null,[{key:"supportShadow",value:function(){return t.LayaGL.layaGPUInstance._isWebGL2||t.SystemUtils.supportRenderTextureFormat(t.RenderTextureFormat.Depth)}},{key:"init",value:function(){t.LayaGL.layaGPUInstance._isWebGL2?Ze._shadowTextureFormat=t.RenderTextureFormat.ShadowMap:Ze._shadowTextureFormat=t.RenderTextureFormat.Depth}},{key:"getTemporaryShadowTexture",value:function(e,n,i){var r=fn.createFromPool(e,n,Ze._shadowTextureFormat,i);return r.filterMode=t.FilterMode.Bilinear,r.wrapModeU=t.WarpMode.Clamp,r.wrapModeV=t.WarpMode.Clamp,r}},{key:"getShadowBias",value:function(t,n,r,a){var o;t._lightType==e.LightType.Directional?o=2/n.elements[0]:t._lightType==e.LightType.Spot?o=Math.tan(.5*t.spotAngle*i.Deg2Rad)*t.range:(console.warn("ShadowUtils:Only spot and directional shadow casters are supported now."),o=0);var s=o/r,l=-t._shadowDepthBias*s,u=-t._shadowNormalBias*s;if(t.shadowMode==e.ShadowMode.SoftHigh){l*=2.5,u*=2.5}a.setValue(l,u,0,0)}},{key:"getCameraFrustumPlanes",value:function(e,t){Gn.getPlanesFromMatrix(e,t[f.Near],t[f.Far],t[f.Left],t[f.Right],t[f.Top],t[f.Bottom])}},{key:"getFarWithRadius",value:function(e,t){return Math.sqrt(e*e/t)}},{key:"getCascadesSplitDistance",value:function(t,n,i,r,a,o,s,l){l[0]=i;var u=r-i,_=Math.tan(.5*a),c=1+_*_*(o*o+1);switch(s){case e.ShadowCascadesMode.NoCascades:l[1]=Ze.getFarWithRadius(r,c);break;case e.ShadowCascadesMode.TwoCascades:l[1]=Ze.getFarWithRadius(i+u*t,c),l[2]=Ze.getFarWithRadius(r,c);break;case e.ShadowCascadesMode.FourCascades:l[1]=Ze.getFarWithRadius(i+u*n.x,c),l[2]=Ze.getFarWithRadius(i+u*n.y,c),l[3]=Ze.getFarWithRadius(i+u*n.z,c),l[4]=Ze.getFarWithRadius(r,c)}}},{key:"applySliceTransform",value:function(e,t,n,i,r){var a=Ze._tempMatrix0.elements,o=1/t,s=1/n;a[0]=e.resolution*o,a[5]=e.resolution*s,a[12]=e.offsetX*o,a[13]=e.offsetY*s,a[1]=a[2]=a[2]=a[4]=a[6]=a[7]=a[8]=a[9]=a[11]=a[14]=0,a[10]=a[15]=1;var l=16*i;gt._mulMatrixArray(a,r,l,r,l)}},{key:"getDirectionLightShadowCullPlanes",value:function(t,n,i,r,a,o){var s=Ze._frustumCorners,l=Ze._backPlaneFaces,u=Ze._frustumPlaneNeighbors,_=Ze._frustumTwoPlaneCorners,c=Ze._edgePlanePoint2,h=o.cullPlanes,d=t[f.Near],m=t[f.Far],p=t[f.Left],v=t[f.Right],E=t[f.Bottom],T=t[f.Top],g=i[n]-r,y=Ze._adjustNearPlane,S=Ze._adjustFarPlane;d.normal.cloneTo(y.normal),m.normal.cloneTo(S.normal),y.distance=d.distance-g,S.distance=Math.min(-d.distance+o.sphereCenterZ+o.splitBoundSphere.radius,m.distance),Gn.get3PlaneInterPoint(y,E,v,s[e.FrustumCorner.nearBottomRight]),Gn.get3PlaneInterPoint(y,T,v,s[e.FrustumCorner.nearTopRight]),Gn.get3PlaneInterPoint(y,T,p,s[e.FrustumCorner.nearTopLeft]),Gn.get3PlaneInterPoint(y,E,p,s[e.FrustumCorner.nearBottomLeft]),Gn.get3PlaneInterPoint(S,E,v,s[e.FrustumCorner.FarBottomRight]),Gn.get3PlaneInterPoint(S,T,v,s[e.FrustumCorner.FarTopRight]),Gn.get3PlaneInterPoint(S,T,p,s[e.FrustumCorner.FarTopLeft]),Gn.get3PlaneInterPoint(S,E,p,s[e.FrustumCorner.FarBottomLeft]);for(var R=0,C=0;C<6;C++){var A;switch(C){case f.Near:A=y;break;case f.Far:A=S;break;default:A=t[C]}D.dot(A.normal,a)<0&&(A.cloneTo(h[R]),l[R]=C,R++)}var I=R;for(C=0;C<R;C++)for(var x=l[C],M=u[x],L=0;L<4;L++){for(var O=M[L],N=!0,P=0;P<R;P++)if(O==l[P]){N=!1;break}if(N){var b=_[x][O],w=s[b[0]],k=s[b[1]];D.add(w,a,c),Vn.createPlaneBy3P(w,k,c,h[I++])}}o.cullPlaneCount=I}},{key:"getBoundSphereByFrustum",value:function(e,t,n,i,r,a,o){var s,l,u=Math.sqrt(1+i*i)*Math.tan(n/2),_=u*u,c=t-e,h=t+e;_>c/h?(s=t,l=t*u):(s=.5*h*(1+_),l=.5*Math.sqrt(c*c+2*(t*t+e*e)*_+h*h*_*_));var d=o.center;return o.radius=l,D.scale(a,s,d),D.add(r,d,d),s}},{key:"getMaxTileResolutionInAtlas",value:function(e,t,n){for(var i=Math.min(e,t),r=Math.floor(e/i)*Math.floor(t/i);r<n;)i=Math.floor(i>>1),r=Math.floor(e/i)*Math.floor(t/i);return i}},{key:"getDirectionalLightMatrices",value:function(e,t,n,i,r,a,o,s){var l=o.splitBoundSphere,u=l.center,_=l.radius,c=a/2,h=_*c/(c-Ze.atlasBorderSize),d=2*h,f=a/d,m=d/a,p=Math.ceil(D.dot(u,e)*f)*m,v=Math.ceil(D.dot(u,t)*f)*m,E=D.dot(u,n);u.x=e.x*p+t.x*v+n.x*E,u.y=e.y*p+t.y*v+n.y*E,u.z=e.z*p+t.z*v+n.z*E;var T=o.position,g=o.viewMatrix,y=o.projectionMatrix,S=o.viewProjectMatrix;o.resolution=a,o.offsetX=i%2*a,o.offsetY=Math.floor(i/2)*a,D.scale(n,_+r,T),D.subtract(u,T,T),q.createLookAt(T,u,e,g),q.createOrthoOffCenter(-h,h,-h,h,0,2*_+r,y),q.multiply(y,g,S),gt._mulMatrixArray(Ze._shadowMapScaleOffsetMatrix.elements,S.elements,0,s,16*i)}},{key:"getSpotLightShadowData",value:function(e,t,n,i,r,a){var o=e.position=t.transform.position;e.resolution=n,a.setValue(1/n,1/n,n,n),e.offsetX=0,e.offsetY=0;var s=t.lightWorldMatrix,l=e.viewMatrix,u=e.projectionMatrix,_=e.viewProjectMatrix,c=e.cameraCullInfo.boundFrustum;s.invert(l),q.createPerspective(3.1416*t.spotAngle/180,1,.1,t.range,u),i.y=t.shadowStrength,q.multiply(u,l,_),c.matrix=_,_.cloneTo(r),e.cameraCullInfo.position=o}},{key:"prepareShadowReceiverShaderValues",value:function(e,t,n,i,r,a,o,s,l){if(a.setValue(1/t,1/n,t,n),o.setValue(e._shadowStrength,0,0,0),r>1){for(var u=16*r,_=64;u<_;u++)s[u]=0;for(u=0;u<r;u++){var c=i[u].splitBoundSphere,h=c.center,d=c.radius,f=4*u;l[f]=h.x,l[f+1]=h.y,l[f+2]=h.z,l[f+3]=d*d}for(u=4*r,_=16;u<_;u++)l[u]=0}}}]),Ze}();Jn._tempMatrix0=new q,Jn._shadowMapScaleOffsetMatrix=new q(.5,0,0,0,0,.5,0,0,0,0,1,0,.5,.5,0,1),Jn._frustumCorners=[new D,new D,new D,new D,new D,new D,new D,new D],Jn._adjustNearPlane=new Vn(new D),Jn._adjustFarPlane=new Vn(new D),Jn._backPlaneFaces=new Array(5),Jn._edgePlanePoint2=new D,Jn._frustumPlaneNeighbors=[[f.Left,f.Right,f.Top,f.Bottom],[f.Left,f.Right,f.Top,f.Bottom],[f.Near,f.Far,f.Top,f.Bottom],[f.Near,f.Far,f.Top,f.Bottom],[f.Near,f.Far,f.Left,f.Right],[f.Near,f.Far,f.Left,f.Right]],Jn._frustumTwoPlaneCorners=[[[e.FrustumCorner.unknown,e.FrustumCorner.unknown],[e.FrustumCorner.unknown,e.FrustumCorner.unknown],[e.FrustumCorner.nearBottomLeft,e.FrustumCorner.nearTopLeft],[e.FrustumCorner.nearTopRight,e.FrustumCorner.nearBottomRight],[e.FrustumCorner.nearBottomRight,e.FrustumCorner.nearBottomLeft],[e.FrustumCorner.nearTopLeft,e.FrustumCorner.nearTopRight]],[[e.FrustumCorner.unknown,e.FrustumCorner.unknown],[e.FrustumCorner.unknown,e.FrustumCorner.unknown],[e.FrustumCorner.FarTopLeft,e.FrustumCorner.FarBottomLeft],[e.FrustumCorner.FarBottomRight,e.FrustumCorner.FarTopRight],[e.FrustumCorner.FarBottomLeft,e.FrustumCorner.FarBottomRight],[e.FrustumCorner.FarTopRight,e.FrustumCorner.FarTopLeft]],[[e.FrustumCorner.nearTopLeft,e.FrustumCorner.nearBottomLeft],[e.FrustumCorner.FarBottomLeft,e.FrustumCorner.FarTopLeft],[e.FrustumCorner.unknown,e.FrustumCorner.unknown],[e.FrustumCorner.unknown,e.FrustumCorner.unknown],[e.FrustumCorner.nearBottomLeft,e.FrustumCorner.FarBottomLeft],[e.FrustumCorner.FarTopLeft,e.FrustumCorner.nearTopLeft]],[[e.FrustumCorner.nearBottomRight,e.FrustumCorner.nearTopRight],[e.FrustumCorner.FarTopRight,e.FrustumCorner.FarBottomRight],[e.FrustumCorner.unknown,e.FrustumCorner.unknown],[e.FrustumCorner.unknown,e.FrustumCorner.unknown],[e.FrustumCorner.FarBottomRight,e.FrustumCorner.nearBottomRight],[e.FrustumCorner.nearTopRight,e.FrustumCorner.FarTopRight]],[[e.FrustumCorner.nearBottomLeft,e.FrustumCorner.nearBottomRight],[e.FrustumCorner.FarBottomRight,e.FrustumCorner.FarBottomLeft],[e.FrustumCorner.FarBottomLeft,e.FrustumCorner.nearBottomLeft],[e.FrustumCorner.nearBottomRight,e.FrustumCorner.FarBottomRight],[e.FrustumCorner.unknown,e.FrustumCorner.unknown],[e.FrustumCorner.unknown,e.FrustumCorner.unknown]],[[e.FrustumCorner.nearTopRight,e.FrustumCorner.nearTopLeft],[e.FrustumCorner.FarTopLeft,e.FrustumCorner.FarTopRight],[e.FrustumCorner.nearTopLeft,e.FrustumCorner.FarTopLeft],[e.FrustumCorner.FarTopRight,e.FrustumCorner.nearTopRight],[e.FrustumCorner.unknown,e.FrustumCorner.unknown],[e.FrustumCorner.unknown,e.FrustumCorner.unknown]]],Jn.atlasBorderSize=4,(m=e.DepthTextureMode||(e.DepthTextureMode={}))[m.None=0]="None",m[m.Depth=1]="Depth",m[m.DepthNormals=2]="DepthNormals",m[m.MotionVectors=4]="MotionVectors";var $n=function(){function qe(){_classCallCheck(this,qe),this._zBufferParams=new o}return _createClass(qe,[{key:"update",value:function(n,i){switch(this._viewPort=n.viewport,this._camera=n,i){case e.DepthTextureMode.Depth:n.depthTexture=this._depthTexture=fn.createFromPool(this._viewPort.width,this._viewPort.height,t.RenderTextureFormat.Depth,t.RenderTextureDepthFormat.DEPTH_16);break;case e.DepthTextureMode.DepthNormals:n.depthNormalTexture=this._depthNormalsTexture=fn.createFromPool(this._viewPort.width,this._viewPort.height,t.RenderTextureFormat.R8G8B8A8,t.RenderTextureDepthFormat.DEPTH_16);break;case e.DepthTextureMode.MotionVectors:break;default:throw"there is UnDefined type of DepthTextureMode"}}},{key:"render",value:function(n,i){var r=n.scene;switch(i){case e.DepthTextureMode.Depth:var a=r._shaderValues;n.pipelineMode="ShadowCaster",En.setRuntimeValueMode(!1),this._depthTexture._start(),a.setVector(qe.DEFINE_SHADOW_BIAS,qe.SHADOW_BIAS);var o=t.LayaGL.instance,s=this._viewPort.x,l=this._viewPort.y;o.enable(o.SCISSOR_TEST),o.viewport(s,l,this._viewPort.width,this._viewPort.height),o.scissor(s,l,this._viewPort.width,this._viewPort.height),o.clear(o.DEPTH_BUFFER_BIT),r._opaqueQueue._render(n),this._depthTexture._end(),En.setRuntimeValueMode(!0),this._setupDepthModeShaderValue(i,this._camera),n.pipelineMode=n.configPipeLineMode;break;case e.DepthTextureMode.DepthNormals:a=r._shaderValues,n.pipelineMode="DepthNormal",En.setRuntimeValueMode(!1),this._depthNormalsTexture._start(),o=t.LayaGL.instance,s=this._viewPort.x,l=this._viewPort.y,o.enable(o.SCISSOR_TEST),o.viewport(s,l,this._viewPort.width,this._viewPort.height),o.scissor(s,l,this._viewPort.width,this._viewPort.height),o.clearColor(0,0,1,0),o.clear(o.DEPTH_BUFFER_BIT|o.COLOR_BUFFER_BIT),r._opaqueQueue._render(n),this._depthNormalsTexture._end(),En.setRuntimeValueMode(!0),this._setupDepthModeShaderValue(i,this._camera),n.pipelineMode=n.configPipeLineMode;break;case e.DepthTextureMode.MotionVectors:break;default:throw"there is UnDefined type of DepthTextureMode"}}},{key:"_setupDepthModeShaderValue",value:function(t,n){switch(t){case e.DepthTextureMode.Depth:var i=n.farPlane,r=n.nearPlane;this._zBufferParams.setValue(1-i/r,i/r,(r-i)/(r*i),1/r),n._shaderValues.setVector(qe.DEFINE_SHADOW_BIAS,qe.SHADOW_BIAS),n._shaderValues.setTexture(qe.DEPTHTEXTURE,this._depthTexture),n._shaderValues.setVector(qe.DEPTHZBUFFERPARAMS,this._zBufferParams);break;case e.DepthTextureMode.DepthNormals:n._shaderValues.setTexture(qe.DEPTHNORMALSTEXTURE,this._depthNormalsTexture);break;case e.DepthTextureMode.MotionVectors:break;default:throw"there is UnDefined type of DepthTextureMode"}}},{key:"cleanUp",value:function(){this._depthTexture&&fn.recoverToPool(this._depthTexture),this._depthNormalsTexture&&fn.recoverToPool(this._depthNormalsTexture),this._depthTexture=null,this._depthNormalsTexture=null}}]),qe}();$n.SHADOW_BIAS=new o,$n.DEFINE_SHADOW_BIAS=xn.propertyNameToID("u_ShadowBias"),$n.DEPTHTEXTURE=xn.propertyNameToID("u_CameraDepthTexture"),$n.DEPTHNORMALSTEXTURE=xn.propertyNameToID("u_CameraDepthNormalsTexture"),$n.DEPTHZBUFFERPARAMS=xn.propertyNameToID("u_ZBufferParams"),(E=e.CameraClearFlags||(e.CameraClearFlags={}))[E.SolidColor=0]="SolidColor",E[E.Sky=1]="Sky",E[E.DepthOnly=2]="DepthOnly",E[E.Nothing=3]="Nothing",(T=e.CameraEventFlags||(e.CameraEventFlags={}))[T.BeforeForwardOpaque=0]="BeforeForwardOpaque",T[T.BeforeSkyBox=2]="BeforeSkyBox",T[T.BeforeTransparent=4]="BeforeTransparent",T[T.BeforeImageEffect=6]="BeforeImageEffect",T[T.AfterEveryThing=8]="AfterEveryThing";var si=function(n){function Qe(){var n,i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.3,s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1e3;return _classCallCheck(this,Qe),(n=_possibleConstructorReturn(this,_getPrototypeOf(Qe).call(this,a,s)))._updateViewMatrix=!0,n._postProcess=null,n._enableHDR=!1,n._viewportParams=new o,n._projectionParams=new o,n._needBuiltInRenderTexture=!1,n._offScreenRenderTexture=null,n._internalRenderTexture=null,n._cameraEventCommandBuffer={},n._clusterPlaneCacheFlag=new r(-1,-1),n._screenOffsetScale=new o,n.enableRender=!0,n.clearFlag=e.CameraClearFlags.SolidColor,n._viewMatrix=new q,n._projectionMatrix=new q,n._projectionViewMatrix=new q,n._viewport=new Hn(0,0,0,0),n._normalizedViewport=new Hn(0,0,1,1),n._aspectRatio=i,n._boundFrustum=new Gn(new q),n._calculateProjectionMatrix(),t.Laya.stage.on(t.Event.RESIZE,_assertThisInitialized(n),n._onScreenSizeChanged),n.transform.on(t.Event.TRANSFORM_CHANGED,_assertThisInitialized(n),n._onTransformChanged),n}return _inherits(Qe,qn),_createClass(Qe,[{key:"_calculationViewport",value:function(e,t,n){var i=e.x*t,r=e.y*n,a=i+Math.max(e.width*t,0),o=r+Math.max(e.height*n,0),s=Math.ceil(i),l=Math.ceil(r),u=Math.floor(a),_=Math.floor(o),c=s-i>=.5?Math.floor(i):s,h=l-r>=.5?Math.floor(r):l,d=a-u>=.5?Math.ceil(a):u,f=o-_>=.5?Math.ceil(o):_;this._viewport.x=c,this._viewport.y=h,this._viewport.width=d-c,this._viewport.height=f-h}},{key:"_calculateProjectionMatrix",value:function(){if(!this._useUserProjectionMatrix)if(this._orthographic){var e=.5*this.orthographicVerticalSize,t=e*this.aspectRatio;q.createOrthoOffCenter(-t,t,-e,e,this.nearPlane,this.farPlane,this._projectionMatrix)}else q.createPerspective(3.1416*this.fieldOfView/180,this.aspectRatio,this.nearPlane,this.farPlane,this._projectionMatrix)}},{key:"_isLayerVisible",value:function(e){return 0!=(Math.pow(2,e)&this.cullingMask)}},{key:"_onTransformChanged",value:function(e){(e&=oe.TRANSFORM_WORLDMATRIX)&&(this._updateViewMatrix=!0)}},{key:"_parse",value:function(e,t){_get(_getPrototypeOf(Qe.prototype),"_parse",this).call(this,e,t);var n=e.clearFlag;void 0!==n&&(this.clearFlag=n);var i=e.viewport;this.normalizedViewport=new Hn(i[0],i[1],i[2],i[3]);var r=e.enableHDR;void 0!==r&&(this.enableHDR=r)}},{key:"_getCanvasWidth",value:function(){return this._offScreenRenderTexture?this._offScreenRenderTexture.width:dn.clientWidth}},{key:"_getCanvasHeight",value:function(){return this._offScreenRenderTexture?this._offScreenRenderTexture.height:dn.clientHeight}},{key:"_getRenderTexture",value:function(){return this._internalRenderTexture||this._offScreenRenderTexture}},{key:"_needInternalRenderTexture",value:function(){return!!(this._postProcess&&this._postProcess.enable||this._enableHDR||this._needBuiltInRenderTexture)}},{key:"_getRenderTextureFormat",value:function(){return this._enableHDR?t.RenderTextureFormat.R16G16B16A16:t.RenderTextureFormat.R8G8B8}},{key:"_prepareCameraToRender",value:function(){_get(_getPrototypeOf(Qe.prototype),"_prepareCameraToRender",this).call(this);var e=this.viewport;this._viewportParams.setValue(e.x,e.y,e.width,e.height),this._projectionParams.setValue(this._nearPlane,this._farPlane,dn._instance.invertY?-1:1,1/this.farPlane),this._shaderValues.setVector(qn.VIEWPORT,this._viewportParams),this._shaderValues.setVector(qn.PROJECTION_PARAMS,this._projectionParams)}},{key:"_applyViewProject",value:function(e,t,n){var i,r=this._shaderValues;e.invertY?(q.multiply(qn._invertYScaleMatrix,n,qn._invertYProjectionMatrix),q.multiply(qn._invertYProjectionMatrix,t,qn._invertYProjectionViewMatrix),n=qn._invertYProjectionMatrix,i=qn._invertYProjectionViewMatrix):(q.multiply(n,t,this._projectionViewMatrix),i=this._projectionViewMatrix),e.viewMatrix=t,e.projectionMatrix=n,e.projectionViewMatrix=i,r.setMatrix4x4(qn.VIEWMATRIX,t),r.setMatrix4x4(qn.PROJECTMATRIX,n),r.setMatrix4x4(qn.VIEWPROJECTMATRIX,i)}},{key:"_updateClusterPlaneXY",value:function(){var e=this.fieldOfView,t=this.aspectRatio;if(this._clusterPlaneCacheFlag.x!==e||this._clusterPlaneCacheFlag.y!==t){var n=It._config.lightClusterCount,i=n.x,r=n.y,a=i+1,o=r+1,s=this._clusterXPlanes,l=this._clusterYPlanes;if(!s){s=this._clusterXPlanes=new Array(a),l=this._clusterYPlanes=new Array(o);for(var u=0;u<a;u++)s[u]=new D;for(u=0;u<o;u++)l[u]=new D}var _=Math.tan(this.fieldOfView/2*Math.PI/180),c=this.aspectRatio*_,h=2*_/i,d=2*c/r;for(u=0;u<a;u++){var f=d*u-c,m=1/Math.sqrt(1+f*f);s[u].setValue(m,0,-f*m)}for(u=0;u<o;u++){f=_-h*u;var p=-1/Math.sqrt(1+f*f);l[u].setValue(0,p,-f*p)}this._clusterPlaneCacheFlag.x=e,this._clusterPlaneCacheFlag.y=t}}},{key:"_applyCommandBuffer",value:function(e,n){var i=t.LayaGL.instance,r=this._cameraEventCommandBuffer[e];r&&0!=r.length&&(r.forEach(function(e){e._context=n,e._apply()}),fn.currentActive&&fn.currentActive._end(),this._internalRenderTexture?this._internalRenderTexture._start():i.bindFramebuffer(i.FRAMEBUFFER,null),i.viewport(0,0,n.viewport.width,n.viewport.height))}},{key:"_renderShadowMap",value:function(t,n){var i,r=t._mainDirectionLight,a=r&&r.shadowMode!==e.ShadowMode.None&&Jn.supportShadow();a?(t._shaderValues.removeDefine(Qn.SHADERDEFINE_SHADOW_SPOT),t._shaderValues.addDefine(Qn.SHADERDEFINE_SHADOW),(i=F.Scene3D._shadowCasterPass).update(this,r,F.ShadowLightType.DirectionLight),i.render(n,t,F.ShadowLightType.DirectionLight)):t._shaderValues.removeDefine(Qn.SHADERDEFINE_SHADOW);var o=t._mainSpotLight,s=o&&o.shadowMode!==e.ShadowMode.None&&Jn.supportShadow();return s?(t._shaderValues.removeDefine(Qn.SHADERDEFINE_SHADOW),t._shaderValues.addDefine(Qn.SHADERDEFINE_SHADOW_SPOT),(i=F.Scene3D._shadowCasterPass).update(this,o,F.ShadowLightType.SpotLight),i.render(n,t,F.ShadowLightType.SpotLight)):t._shaderValues.removeDefine(Qn.SHADERDEFINE_SHADOW_SPOT),a&&t._shaderValues.addDefine(Qn.SHADERDEFINE_SHADOW),s&&t._shaderValues.addDefine(Qn.SHADERDEFINE_SHADOW_SPOT),a||s}},{key:"_preRenderMainPass",value:function(n,i,r,a){n.camera=this,n.cameraShaderValue=this._shaderValues,Qe._updateMark++,i._preRenderScript();var o=t.LayaGL.instance;if(r&&!this._offScreenRenderTexture&&(this.clearFlag==e.CameraClearFlags.DepthOnly||this.clearFlag==e.CameraClearFlags.Nothing))if(this._enableHDR){var s=fn.createFromPool(a.width,a.height,t.RenderTextureFormat.R8G8B8,t.RenderTextureDepthFormat.DEPTH_16);s.filterMode=t.FilterMode.Bilinear,t.WebGLContext.bindTexture(o,o.TEXTURE_2D,s._getSource()),o.copyTexSubImage2D(o.TEXTURE_2D,0,0,0,a.x,dn.clientHeight-(a.y+a.height),a.width,a.height);var l=Mn.create(s,this._internalRenderTexture);l.run(),l.recover(),fn.recoverToPool(s)}else t.WebGLContext.bindTexture(o,o.TEXTURE_2D,this._internalRenderTexture._getSource()),o.copyTexSubImage2D(o.TEXTURE_2D,0,0,0,a.x,dn.clientHeight-(a.y+a.height),a.width,a.height)}},{key:"_renderMainPass",value:function(n,i,r,a,o,s){var l=t.LayaGL.instance,u=this._getRenderTexture();if(n.viewport=i,this._prepareCameraToRender(),It._config._multiLighting&&kn.instance.update(this,r),r._preCulling(n,this,a,o),0!=this.depthTextureMode&&(this._applyViewProject(n,this.viewMatrix,this._projectionMatrix),this._renderDepthMode(n)),u&&u._start(),this._applyViewProject(n,this.viewMatrix,this._projectionMatrix),r._clear(l,n),this._applyCommandBuffer(e.CameraEventFlags.BeforeForwardOpaque,n),r._renderScene(n,F.Scene3D.SCENERENDERFLAG_RENDERQPAQUE),this._applyCommandBuffer(e.CameraEventFlags.BeforeSkyBox,n),r._renderScene(n,F.Scene3D.SCENERENDERFLAG_SKYBOX),this._applyCommandBuffer(e.CameraEventFlags.BeforeTransparent,n),r._renderScene(n,F.Scene3D.SCENERENDERFLAG_RENDERTRANSPARENT),r._postRenderScript(),this._applyCommandBuffer(e.CameraEventFlags.BeforeImageEffect,n),u&&u._end(),s){if(this._postProcess&&this._postProcess.enable)this._postProcess._render(),this._postProcess._applyPostProcessCommandBuffers();else if(this._enableHDR||this._needBuiltInRenderTexture){var _=this._getCanvasWidth(),c=this._getCanvasHeight();this._screenOffsetScale.setValue(i.x/_,i.y/c,i.width/_,i.height/c);var h=Mn.create(this._internalRenderTexture,this._offScreenRenderTexture?this._offScreenRenderTexture:null,this._screenOffsetScale,null,null,0,Mn._SCREENTYPE_QUAD,null,!0);h.run(),h.recover()}fn.recoverToPool(this._internalRenderTexture)}this._applyCommandBuffer(e.CameraEventFlags.AfterEveryThing,n)}},{key:"_renderDepthMode",value:function(t){var n=this._depthTextureMode;0!=(n&e.DepthTextureMode.Depth)&&(Qe.depthPass.update(this,e.DepthTextureMode.Depth),Qe.depthPass.render(t,e.DepthTextureMode.Depth)),0!=(n&e.DepthTextureMode.DepthNormals)&&(Qe.depthPass.update(this,e.DepthTextureMode.DepthNormals),Qe.depthPass.render(t,e.DepthTextureMode.DepthNormals))}},{key:"_aftRenderMainPass",value:function(e){e&&F.Scene3D._shadowCasterPass.cleanUp(),Qe.depthPass.cleanUp()}},{key:"render",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if(this.activeInHierarchy){var i=this.viewport,r=this._needInternalRenderTexture(),a=dn._instance,o=a.scene=this._scene;a.pipelineMode=a.configPipeLineMode,r?(this._internalRenderTexture=fn.createFromPool(i.width,i.height,this._getRenderTextureFormat(),t.RenderTextureDepthFormat.DEPTH_16),this._internalRenderTexture.filterMode=t.FilterMode.Bilinear):this._internalRenderTexture=null;var s=this._renderShadowMap(o,a);this._preRenderMainPass(a,o,r,i),this._renderMainPass(a,i,o,e,n,r),this._aftRenderMainPass(s)}}},{key:"viewportPointToRay",value:function(e,t){zn.calculateCursorRay(e,this.viewport,this._projectionMatrix,this.viewMatrix,null,t)}},{key:"normalizedViewportPointToRay",value:function(e,t){var n=Qe._tempVector20,i=this.viewport;n.x=e.x*i.width,n.y=e.y*i.height,zn.calculateCursorRay(n,this.viewport,this._projectionMatrix,this.viewMatrix,null,t)}},{key:"worldToViewportPoint",value:function(e,n){q.multiply(this._projectionMatrix,this._viewMatrix,this._projectionViewMatrix),this.viewport.project(e,this._projectionViewMatrix,n),n.x=n.x/t.Laya.stage.clientScaleX,n.y=n.y/t.Laya.stage.clientScaleY}},{key:"worldToNormalizedViewportPoint",value:function(e,n){q.multiply(this._projectionMatrix,this._viewMatrix,this._projectionViewMatrix),this.normalizedViewport.project(e,this._projectionViewMatrix,n),n.x=n.x/t.Laya.stage.clientScaleX,n.y=n.y/t.Laya.stage.clientScaleY}},{key:"convertScreenCoordToOrthographicCoord",value:function(e,n){if(this._orthographic){var i=dn.clientWidth,r=dn.clientHeight,a=this.orthographicVerticalSize*this.aspectRatio/i,o=this.orthographicVerticalSize/r;return n.x=(-i/2+e.x*t.Laya.stage.clientScaleX)*a,n.y=(r/2-e.y*t.Laya.stage.clientScaleY)*o,n.z=(this.nearPlane-this.farPlane)*(e.z+1)/2-this.nearPlane,D.transformCoordinate(n,this.transform.worldMatrix,n),!0}return!1}},{key:"destroy",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];this._offScreenRenderTexture=null,this.transform.off(t.Event.TRANSFORM_CHANGED,this,this._onTransformChanged),_get(_getPrototypeOf(Qe.prototype),"destroy",this).call(this,e)}},{key:"addCommandBuffer",value:function(e,t){var n=this._cameraEventCommandBuffer[e];n||(n=this._cameraEventCommandBuffer[e]=[]),n.indexOf(t)<0&&n.push(t),t._camera=this}},{key:"removeCommandBuffer",value:function(e,t){var n=this._cameraEventCommandBuffer[e];if(!n)throw"Camera:unknown event.";var i=n.indexOf(t);-1!=i&&n.splice(i,1)}},{key:"removeCommandBuffers",value:function(e){this._cameraEventCommandBuffer[e]&&(this._cameraEventCommandBuffer[e].length=0)}},{key:"_create",value:function(){return new Qe}},{key:"aspectRatio",get:function(){if(0===this._aspectRatio){var e=this.viewport;return e.width/e.height}return this._aspectRatio},set:function(e){if(e<0)throw new Error("Camera: the aspect ratio has to be a positive real number.");this._aspectRatio=e,this._calculateProjectionMatrix()}},{key:"viewport",get:function(){return this._offScreenRenderTexture?this._calculationViewport(this._normalizedViewport,this._offScreenRenderTexture.width,this._offScreenRenderTexture.height):this._calculationViewport(this._normalizedViewport,dn.clientWidth,dn.clientHeight),this._viewport},set:function(e){var t,n;this._offScreenRenderTexture?(t=this._offScreenRenderTexture.width,n=this._offScreenRenderTexture.height):(t=dn.clientWidth,n=dn.clientHeight),this._normalizedViewport.x=e.x/t,this._normalizedViewport.y=e.y/n,this._normalizedViewport.width=e.width/t,this._normalizedViewport.height=e.height/n,this._calculationViewport(this._normalizedViewport,t,n),this._calculateProjectionMatrix()}},{key:"normalizedViewport",get:function(){return this._normalizedViewport},set:function(e){var t,n;this._offScreenRenderTexture?(t=this._offScreenRenderTexture.width,n=this._offScreenRenderTexture.height):(t=dn.clientWidth,n=dn.clientHeight),this._normalizedViewport!==e&&e.cloneTo(this._normalizedViewport),this._calculationViewport(e,t,n),this._calculateProjectionMatrix()}},{key:"viewMatrix",get:function(){if(this._updateViewMatrix){var e=this.transform.getWorldLossyScale(),t=e.x,n=e.y,i=e.z,r=this._viewMatrix.elements;this.transform.worldMatrix.cloneTo(this._viewMatrix),r[0]/=t,r[1]/=t,r[2]/=t,r[4]/=n,r[5]/=n,r[6]/=n,r[8]/=i,r[9]/=i,r[10]/=i,this._viewMatrix.invert(this._viewMatrix),this._updateViewMatrix=!1}return this._viewMatrix}},{key:"projectionMatrix",get:function(){return this._projectionMatrix},set:function(e){this._projectionMatrix=e,this._useUserProjectionMatrix=!0}},{key:"projectionViewMatrix",get:function(){return q.multiply(this.projectionMatrix,this.viewMatrix,this._projectionViewMatrix),this._projectionViewMatrix}},{key:"boundFrustum",get:function(){return this._boundFrustum.matrix=this.projectionViewMatrix,this._boundFrustum}},{key:"renderTarget",get:function(){return this._offScreenRenderTexture},set:function(e){var t=this._offScreenRenderTexture;t!==e&&(t&&(t._isCameraTarget=!1),e&&(e._isCameraTarget=!0),this._offScreenRenderTexture=e,this._calculateProjectionMatrix())}},{key:"postProcess",get:function(){return this._postProcess},set:function(e){this._postProcess=e,e&&e&&e._init(this)}},{key:"enableHDR",get:function(){return this._enableHDR},set:function(e){!e||t.SystemUtils.supportRenderTextureFormat(t.RenderTextureFormat.R16G16B16A16)?this._enableHDR=e:console.warn("Camera:can't enable HDR in this device.")}},{key:"enableBuiltInRenderTexture",get:function(){return this._needBuiltInRenderTexture},set:function(e){this._needBuiltInRenderTexture=e}},{key:"depthTextureMode",get:function(){return this._depthTextureMode},set:function(e){this._depthTextureMode=e}},{key:"depthTexture",get:function(){return this._depthTexture},set:function(e){this._depthTexture=e}},{key:"depthNormalTexture",get:function(){return this._depthNormalsTexture},set:function(e){this._depthNormalsTexture=e}}],[{key:"drawRenderTextureByScene",value:function(e,n,i){e.renderTarget!=i&&(e.renderTarget&&fn.recoverToPool(e.renderTarget),e.renderTarget=i);var r=e.viewport,a=e._needInternalRenderTexture(),o=dn._instance;n=o.scene=n,o.pipelineMode=o.configPipeLineMode,a?(e._internalRenderTexture=fn.createFromPool(r.width,r.height,e._getRenderTextureFormat(),t.RenderTextureDepthFormat.DEPTH_16),e._internalRenderTexture.filterMode=t.FilterMode.Bilinear):e._internalRenderTexture=null;var s=e._renderShadowMap(n,o);return e._preRenderMainPass(o,n,a,r),e._renderMainPass(o,r,n,null,null,a),e._aftRenderMainPass(s),e.renderTarget}}]),Qe}();si._tempVector20=new r,si._updateMark=0,si.depthPass=new $n;var ci=function(){function Ke(){_classCallCheck(this,Ke),this.renderSubShader=null,this.renderType=Ke.RENDERTYPE_NORMAL}return _createClass(Ke,[{key:"getInvertFront",value:function(){return this._transform._isFrontFaceInvert}},{key:"setTransform",value:function(e){this._transform=e}},{key:"setGeometry",value:function(e){this._geometry=e}},{key:"addToOpaqueRenderQueue",value:function(e,t){t.elements.add(this)}},{key:"addToTransparentRenderQueue",value:function(e,t){t.elements.add(this),t.lastTransparentBatched=!1,t.lastTransparentRenderElement=this}},{key:"_update",value:function(e,t,n,i){var r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0;if(this.material){var a=this.material._shader.getSubShaderAt(0);if(this.renderSubShader=null,n)if(i){var o=a.getFlag(i);if(!o)return;for(var s=n._subShaders,l=0,u=s.length;l<u;l++){var _=s[l];if(o===_.getFlag(i)){this.renderSubShader=_;break}}if(!this.renderSubShader)return}else this.renderSubShader=n.getSubShaderAt(r);else this.renderSubShader=a;var c=e._getRenderQueue(this.material.renderQueue);c.isTransparent?this.addToTransparentRenderQueue(t,c):this.addToOpaqueRenderQueue(t,c)}}},{key:"_render",value:function(e){var t,n,i,r=e.invertY,a=si._updateMark,o=e.scene,s=e.cameraShaderValue,l=this._transform,u=this._geometry;e.renderElement=this,a!==this.render._updateMark||this.renderType!==this.render._updateRenderType?(this.render._renderUpdate(e,l),this.render._renderUpdateWithCamera(e,l),this.render._updateMark=a,this.render._updateRenderType=this.renderType):this.renderType==Ke.RENDERTYPE_INSTANCEBATCH&&(this.render._renderUpdate(e,l),this.render._renderUpdateWithCamera(e,l));var _=e.pipelineMode;if(u._prepareRender(e))for(var c=this.renderSubShader._passes,h=0,d=c.length;h<d;h++){var f=c[h];if(f._pipelineMode===_){var m=Ke._compileDefine;o._shaderValues._defineDatas.cloneTo(m),m.addDefineDatas(this.render._shaderValues._defineDatas),m.addDefineDatas(this.material._shaderValues._defineDatas);var p=e.shader=f.withCompile(m),v=p.bind(),E=a!==p._uploadMark,T=p._uploadScene!==o||E;(T||v)&&(p.uploadUniforms(p._sceneUniformParamsMap,o._shaderValues,T),p._uploadScene=o);var g=p._uploadRender!==this.render||p._uploadRenderType!==this.renderType||E;(g||v)&&(p.uploadUniforms(p._spriteUniformParamsMap,this.render._shaderValues,g),p._uploadRender=this.render,p._uploadRenderType=this.renderType);var y=p._uploadCameraShaderValue!==s||E;(y||v)&&(p.uploadUniforms(p._cameraUniformParamsMap,s,y),p._uploadCameraShaderValue=s);var S=p._uploadMaterial!==this.material||E;(S||v)&&(p.uploadUniforms(p._materialUniformParamsMap,this.material._shaderValues,S),p._uploadMaterial=this.material);var R=this.material._shaderValues;t!==this.material||n!==p?(p.uploadRenderStateBlendDepth(R),p.uploadRenderStateFrontFace(R,r,this.getInvertFront()),t=this.material,n=p,i=this.render):i!==this.render&&(p.uploadRenderStateFrontFace(R,r,this.getInvertFront()),i=this.render),u._render(e),p._uploadMark=a}}this.renderType!==Ke.RENDERTYPE_NORMAL&&this.render._revertBatchRenderUpdate(e)}},{key:"destroy",value:function(){this._transform=null,this._geometry=null,this.material=null,this.render=null}}]),Ke}();ci.RENDERTYPE_NORMAL=0,ci.RENDERTYPE_STATICBATCH=1,ci.RENDERTYPE_INSTANCEBATCH=2,ci.RENDERTYPE_VERTEXBATCH=3,ci._compileDefine=new mn;var pi=function(e){function Je(){return _classCallCheck(this,Je),_possibleConstructorReturn(this,_getPrototypeOf(Je).apply(this,arguments))}return _inherits(Je,Dn),_createClass(Je,[{key:"_elementRender",value:function(e,t){var n,i,r,a=t.invertY,o=si._updateMark,s=t.scene;this._render._scene=t.scene;var l=t.cameraShaderValue,u=e._transform,_=e._geometry;t.renderElement=e,o!==e.render._updateMark||e.renderType!==e.render._updateRenderType?(e.render._renderUpdate(t,u),e.render._renderUpdateWithCamera(t,u),e.render._updateMark=o,e.render._updateRenderType=e.renderType):e.renderType==ci.RENDERTYPE_INSTANCEBATCH&&(e.render._renderUpdate(t,u),e.render._renderUpdateWithCamera(t,u));var c=t.pipelineMode;if(_._prepareRender(t))for(var h=e.renderSubShader._passes,d=0,f=h.length;d<f;d++){var m=h[d];if(m._pipelineMode===c){var p=Je._compileDefine;s._shaderValues._defineDatas.cloneTo(p),p.addDefineDatas(e.render._shaderValues._defineDatas),p.addDefineDatas(this._material._shaderValues._defineDatas);var v=t.shader=m.withCompile(p),E=v.bind(),T=o!==v._uploadMark,g=v._uploadScene!==s||T;(g||E)&&(v.uploadUniforms(v._sceneUniformParamsMap,s._shaderValues,g),v._uploadScene=s);var y=v._uploadRender!==e.render||v._uploadRenderType!==e.renderType||T;(y||E)&&(v.uploadUniforms(v._spriteUniformParamsMap,e.render._shaderValues,y),v._uploadRender=e.render,v._uploadRenderType=e.renderType);var S=v._uploadCameraShaderValue!==l||T;(S||E)&&(v.uploadUniforms(v._cameraUniformParamsMap,l,S),v._uploadCameraShaderValue=l);var R=v._uploadMaterial!==this._material||T;(R||E)&&(v.uploadUniforms(v._materialUniformParamsMap,this._material._shaderValues,R),v._uploadMaterial=this._material);var C=this._material._shaderValues;n!==this._material||i!==v?(v.uploadRenderStateBlendDepth(C),v.uploadRenderStateFrontFace(C,a,e.getInvertFront()),n=this._material,i=v,r=e.render):r!==e.render&&(v.uploadRenderStateFrontFace(C,a,e.getInvertFront()),r=e.render),_._render(t),v._uploadMark=o}}e.renderType!==ci.RENDERTYPE_NORMAL&&e.render._revertBatchRenderUpdate(t)}},{key:"run",value:function(){if(!this._material)throw"This render command material cannot be empty";this.setContext(this._commandBuffer._context);for(var e=this._context,t=(e.scene,this._render._renderElements),n=0,i=t.length;n<i;n++){var r=t[n];this._renderElementUpdate(r),this._elementRender(r,e)}}},{key:"_renderElementUpdate",value:function(e){this._material&&(e.renderSubShader=this._material._shader.getSubShaderAt(this._subShaderIndex))}},{key:"recover",value:function(){Je._pool.push(this)}}],[{key:"create",value:function(e,t,n,i){var r;return(r=Je._pool.length>0?Je._pool.pop():new Je)._render=e,r._material=t,r._subShaderIndex=n,r._commandBuffer=i,r}}]),Je}();pi._pool=[],pi._compileDefine=new mn;var gi=function(t){function $e(){var e;return _classCallCheck(this,$e),(e=_possibleConstructorReturn(this,_getPrototypeOf($e).apply(this,arguments)))._nameID=0,e._value=null,e._dataType=-1,e}return _inherits($e,Dn),_createClass($e,[{key:"run",value:function(){var t=this._commandBuffer._camera.scene._shaderValues;switch(this._dataType){case e.ShaderDataType.Int:t.setInt(this._nameID,this._value);break;case e.ShaderDataType.Number:t.setNumber(this._nameID,this._value);break;case e.ShaderDataType.Bool:t.setBool(this._nameID,this._value);break;case e.ShaderDataType.Matrix4x4:t.setMatrix4x4(this._nameID,this._value);break;case e.ShaderDataType.Quaternion:t.setQuaternion(this._nameID,this._value);break;case e.ShaderDataType.Texture:t.setTexture(this._nameID,this._value);break;case e.ShaderDataType.Vector4:t.setVector(this._nameID,this._value);break;case e.ShaderDataType.Vector2:t.setVector2(this._nameID,this._value);break;case e.ShaderDataType.Vector3:t.setVector3(this._nameID,this._value);break;case e.ShaderDataType.Buffer:t.setBuffer(this._nameID,this._value);break;default:throw"no type shaderValue on this CommendBuffer"}}},{key:"recover",value:function(){$e._pool.push(this),this._nameID=0,this._value=null,this._dataType=-1}}],[{key:"create",value:function(e,t,n,i){var r;return(r=$e._pool.length>0?$e._pool.pop():new $e)._nameID=e,r._value=t,r._dataType=n,r._commandBuffer=i,r}}]),$e}();gi._pool=[];var Si=function et(){_classCallCheck(this,et)},Oi=function(e){function tt(){var e;_classCallCheck(this,tt),(e=_possibleConstructorReturn(this,_getPrototypeOf(tt).call(this)))._renderShaderValue=new En(null);var n=t.LayaGL.instance;return e._instanceWorldMatrixData=new Float32Array(16*tt.maxInstanceCount),e._instanceWorldMatrixBuffer=new pn(4*e._instanceWorldMatrixData.length,n.DYNAMIC_DRAW),e._instanceWorldMatrixBuffer.vertexDeclaration=Xn.instanceWorldMatrixDeclaration,e}return _inherits(tt,Dn),_createClass(tt,[{key:"_setInstanceBuffer",value:function(){var e=this._instanceBufferState=new yn;e.bind(),e.applyVertexBuffer(this._mesh._vertexBuffer),e.applyInstanceVertexBuffer(this._instanceWorldMatrixBuffer);var t=this._instanceProperty._propertyMap;for(var n in t)e.applyInstanceVertexBuffer(t[n]._vertexBuffer);e.applyIndexBuffer(this._mesh._indexBuffer),e.unBind()}},{key:"_updateWorldMatrixBuffer",value:function(){for(var e=this._instanceWorldMatrixData,t=this._drawnums,n=0;n<t;n++)e.set(this._matrixs[n].elements,16*n);var i=this._instanceWorldMatrixBuffer;i.orphanStorage(),i.setData(e.buffer,0,0,64*t)}},{key:"_render",value:function(e){var n=t.LayaGL.instance,i=this._drawnums,r=e._indexCount;this._instanceBufferState.bind(),t.LayaGL.layaGPUInstance.drawElementsInstanced(n.TRIANGLES,r,n.UNSIGNED_SHORT,2*e._indexStart,i),t.Stat.renderBatches++,t.Stat.trianglesFaces+=r*i/3}},{key:"run",value:function(){var e=this._material._shader.getSubShaderAt(this._subShaderIndex);this.setContext(this._commandBuffer._context);var t=this._context,n=t.invertY,i=t.scene,r=t.cameraShaderValue,a=t.pipelineMode;this._renderShaderValue.addDefine(Si.SHADERDEFINE_GPU_INSTANCE);for(var o=e._passes,s=0,l=o.length;s<l;s++){var u=o[s];if(u._pipelineMode===a){var _=tt._compileDefine;i._shaderValues._defineDatas.cloneTo(_),_.addDefineDatas(this._renderShaderValue._defineDatas),_.addDefineDatas(this._material._shaderValues._defineDatas);var c=t.shader=u.withCompile(_);c.bind(),c.uploadUniforms(c._sceneUniformParamsMap,i._shaderValues,!0),c.uploadUniforms(c._spriteUniformParamsMap,this._renderShaderValue,!0),c.uploadUniforms(c._cameraUniformParamsMap,r,!0);var h=this._material._shaderValues;c.uploadUniforms(c._materialUniformParamsMap,h,!0),c.uploadRenderStateBlendDepth(h),c.uploadRenderStateFrontFace(h,n,!1)}}var d=this._instanceProperty._propertyMap;for(var f in d)d[f].updateVertexBufferData(this._drawnums);var m,p=this._mesh._subMeshes;if(-1==this._subMeshIndex)for(var v=0,E=p.length;v<E;v++)(m=p[v])._prepareRender(t)&&this._render(m);else(m=this._mesh._subMeshes[this._subMeshIndex])._prepareRender(t)&&this._render(m)}},{key:"setWorldMatrix",value:function(e){if(e.length<this._drawnums)throw"worldMatrixArray length is less then drawnums";this._matrixs=e,this._matrixs&&this._updateWorldMatrixBuffer()}},{key:"setDrawNums",value:function(e){if(this._matrixs&&this._matrixs.length<e)throw"worldMatrixArray length is less then drawnums";this._drawnums=e,this._matrixs&&this._updateWorldMatrixBuffer()}},{key:"recover",value:function(){tt._pool.push(this),this._renderShaderValue.clearDefine(),this._renderShaderValue._initData(),this._instanceBufferState.destroy(),this._instanceBufferState=null}}],[{key:"create",value:function(e,t,n,i,r,a,o,s){var l;if(n&&n.length>1024||o>tt.maxInstanceCount)throw"the number of renderings exceeds the maximum number of merges";return(l=tt._pool.length>0?tt._pool.pop():new tt)._mesh=e,l._matrixs=n,l._material=i,l._subMeshIndex=t,l._subShaderIndex=r,l._commandBuffer=s,l._instanceProperty=a,l._drawnums=o,n||l._updateWorldMatrixBuffer(),l._setInstanceBuffer(),l}}]),tt}();Oi._pool=[],Oi._compileDefine=new mn,Oi.maxInstanceCount=1024;var Pi=function(){function it(){_classCallCheck(this,it),this._camera=null,this._commands=[]}return _createClass(it,[{key:"_apply",value:function(){for(var e=0,t=this._commands.length;e<t;e++)this._commands[e].run()}},{key:"setShaderDataTexture",value:function(t,n,i){this._commands.push(On.create(t,n,i,e.ShaderDataType.Texture,this))}},{key:"setGlobalTexture",value:function(t,n){this._commands.push(gi.create(t,n,e.ShaderDataType.Texture,this))}},{key:"setShaderDataVector",value:function(t,n,i){this._commands.push(On.create(t,n,i,e.ShaderDataType.Vector4,this))}},{key:"setGlobalVector",value:function(t,n){this._commands.push(gi.create(t,n,e.ShaderDataType.Vector4,this))}},{key:"setShaderDataVector3",value:function(t,n,i){this._commands.push(On.create(t,n,i,e.ShaderDataType.Vector3,this))}},{key:"setGlobalVector3",value:function(t,n){this._commands.push(gi.create(t,n,e.ShaderDataType.Vector3,this))}},{key:"setShaderDataVector2",value:function(t,n,i){this._commands.push(On.create(t,n,i,e.ShaderDataType.Vector2,this))}},{key:"setGlobalVector2",value:function(t,n){this._commands.push(gi.create(t,n,e.ShaderDataType.Vector2,this))}},{key:"setShaderDataNumber",value:function(t,n,i){this._commands.push(On.create(t,n,i,e.ShaderDataType.Number,this))}},{key:"setGlobalNumber",value:function(t,n){this._commands.push(gi.create(t,n,e.ShaderDataType.Number,this))}},{key:"setShaderDataInt",value:function(t,n,i){this._commands.push(On.create(t,n,i,e.ShaderDataType.Int,this))}},{key:"setGlobalInt",value:function(t,n){this._commands.push(gi.create(t,n,e.ShaderDataType.Int,this))}},{key:"setShaderDataMatrix",value:function(t,n,i){this._commands.push(On.create(t,n,i,e.ShaderDataType.Matrix4x4,this))}},{key:"setGlobalMatrix",value:function(t,n){this._commands.push(gi.create(t,n,e.ShaderDataType.Matrix4x4,this))}},{key:"blitScreenQuad",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0;this._commands.push(Mn.create(e,t,n,i,r,a,Mn._SCREENTYPE_QUAD,this))}},{key:"blitScreenQuadByMaterial",value:function(e,t){var n,i,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0;a&&(n=a._shader,i=a.shaderData),this._commands.push(Mn.create(e,t,r,n,i,o,Mn._SCREENTYPE_QUAD,this))}},{key:"blitScreenTriangle",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,o=arguments.length>6&&void 0!==arguments[6]&&arguments[6];this._commands.push(Mn.create(e,t,n,i,r,a,Mn._SCREENTYPE_TRIANGLE,this,o))}},{key:"setRenderTarget",value:function(e){this._commands.push(Ln.create(e))}},{key:"clearRenderTarget",value:function(e,t,n){var i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1;this._commands.push(bn.create(e,t,n,i,this))}},{key:"drawMesh",value:function(e,t,n,i,r){this._commands.push(Pn.create(e,t,n,i,r,this))}},{key:"drawRender",value:function(e,t,n){this._commands.push(pi.create(e,t,n,this))}},{key:"drawMeshInstance",value:function(e,n,i,r,a,o,s){if(!t.LayaGL.layaGPUInstance.supportInstance())return null;var l=Oi.create(e,n,i,r,a,o,s,this);return this._commands.push(l),l}},{key:"clear",value:function(){for(var e=0,t=this._commands.length;e<t;e++)this._commands[e].recover();this._commands.length=0}}]),it}(),bi=function rt(){_classCallCheck(this,rt),this.source=null,this.destination=null,this.camera=null,this.compositeShaderData=null,this.command=null,this.deferredReleaseTextures=[]},Vi=function(){function nt(){_classCallCheck(this,nt),this._compositeShader=xn.find("PostProcessComposite"),this._compositeShaderData=new En,this._effects=[],this._enable=!0,this._context=null,this._context=new bi,this._context.compositeShaderData=this._compositeShaderData,this._context.command=new Pi}return _createClass(nt,[{key:"_init",value:function(e){this._context.camera=e,this._context.command._camera=e}},{key:"_render",value:function(){var e=En._SET_RUNTIME_VALUE_MODE_REFERENCE_;t.ILaya.Render.supportWebGLPlusRendering&&En.setRuntimeValueMode(!1);var n=this._context.camera,i=n.viewport,r=n._internalRenderTexture,a=r;this._context.command.clear(),this._context.source=a,this._context.destination=r,this._context.compositeShaderData.clearDefine(),this._context.compositeShaderData.setTexture(nt.SHADERVALUE_AUTOEXPOSURETEX,t.Texture2D.whiteTexture);for(var o=0,s=this._effects.length;o<s;o++)this._effects[o].render(this._context);this._compositeShaderData.addDefine(nt.SHADERDEFINE_FINALPASS);var l=n._offScreenRenderTexture||null;this._context.destination=l;var u=n._getCanvasWidth(),_=n._getCanvasHeight();n._screenOffsetScale.setValue(i.x/u,i.y/_,i.width/u,i.height/_),this._context.command.blitScreenTriangle(this._context.source,l,n._screenOffsetScale,this._compositeShader,this._compositeShaderData,0,!0),fn.recoverToPool(a);var c=this._context.deferredReleaseTextures;for(o=0,s=c.length;o<s;o++)fn.recoverToPool(c[o]);c.length=0,t.ILaya.Render.supportWebGLPlusRendering&&En.setRuntimeValueMode(e)}},{key:"addEffect",value:function(e){this._effects.push(e)}},{key:"removeEffect",value:function(e){var t=this._effects.indexOf(e);-1!==t&&this._effects.splice(t,1)}},{key:"_applyPostProcessCommandBuffers",value:function(){this._context.command._apply()}},{key:"enable",get:function(){return this._enable},set:function(e){this._enable=e}}],[{key:"__init__",value:function(){nt.SHADERDEFINE_BLOOM_LOW=xn.getDefineByName("BLOOM_LOW"),nt.SHADERDEFINE_BLOOM=xn.getDefineByName("BLOOM"),nt.SHADERDEFINE_FINALPASS=xn.getDefineByName("FINALPASS")}}]),nt}();Vi.SHADERVALUE_MAINTEX=xn.propertyNameToID("u_MainTex"),Vi.SHADERVALUE_BLOOMTEX=xn.propertyNameToID("u_BloomTex"),Vi.SHADERVALUE_AUTOEXPOSURETEX=xn.propertyNameToID("u_AutoExposureTex"),Vi.SHADERVALUE_BLOOM_DIRTTEX=xn.propertyNameToID("u_Bloom_DirtTex"),Vi.SHADERVALUE_BLOOMTEX_TEXELSIZE=xn.propertyNameToID("u_BloomTex_TexelSize"),Vi.SHADERVALUE_BLOOM_DIRTTILEOFFSET=xn.propertyNameToID("u_Bloom_DirtTileOffset"),Vi.SHADERVALUE_BLOOM_SETTINGS=xn.propertyNameToID("u_Bloom_Settings"),Vi.SHADERVALUE_BLOOM_COLOR=xn.propertyNameToID("u_Bloom_Color");var Bi=function(e){function at(e){var t;return _classCallCheck(this,at),(t=_possibleConstructorReturn(this,_getPrototypeOf(at).call(this)))._owner=e,t._children=[],t._localMatrix=new Float32Array(16),t._localPosition=new D,t._localRotation=new Z,t._localScale=new D,t._worldMatrix=new Float32Array(16),t._localQuaternionUpdate=!1,t._locaEulerlUpdate=!1,t._localUpdate=!1,t._worldUpdate=!0,t}return _inherits(at,t.EventDispatcher),_createClass(at,[{key:"_getlocalMatrix",value:function(){return this._localUpdate&&(gt._createAffineTransformationArray(this._localPosition,this._localRotation,this._localScale,this._localMatrix),this._localUpdate=!1),this._localMatrix}},{key:"_onWorldTransform",value:function(){if(!this._worldUpdate){this._worldUpdate=!0,this.event(t.Event.TRANSFORM_CHANGED);for(var e=0,n=this._children.length;e<n;e++)this._children[e]._onWorldTransform()}}},{key:"getWorldMatrix",value:function(){if(this._worldUpdate){if(null!=this._parent)gt.matrix4x4MultiplyFFF(this._parent.getWorldMatrix(),this._getlocalMatrix(),this._worldMatrix);else{var e=this._worldMatrix;e[1]=e[2]=e[3]=e[4]=e[6]=e[7]=e[8]=e[9]=e[11]=e[12]=e[13]=e[14]=0,e[0]=e[5]=e[10]=e[15]=1}this._worldUpdate=!1}return this._worldMatrix}},{key:"setParent",value:function(e){if(this._parent!==e){if(this._parent){var t=this._parent._children,n=t.indexOf(this);t.splice(n,1)}e&&(e._children.push(this),e&&this._onWorldTransform()),this._parent=e}}},{key:"localPosition",get:function(){return this._localPosition},set:function(e){this._localPosition=e,this._localUpdate=!0,this._onWorldTransform()}},{key:"localRotation",get:function(){if(this._localQuaternionUpdate){var e=this._localRotationEuler;Z.createFromYawPitchRoll(e.y/at._angleToRandin,e.x/at._angleToRandin,e.z/at._angleToRandin,this._localRotation),this._localQuaternionUpdate=!1}return this._localRotation},set:function(e){this._localRotation=e,this._locaEulerlUpdate=!0,this._localQuaternionUpdate=!1,this._localUpdate=!0,this._onWorldTransform()}},{key:"localScale",get:function(){return this._localScale},set:function(e){this._localScale=e,this._localUpdate=!0,this._onWorldTransform()}},{key:"localRotationEuler",get:function(){if(this._locaEulerlUpdate){this._localRotation.getYawPitchRoll(at._tempVector3);var e=at._tempVector3,t=this._localRotationEuler;t.x=e.y*at._angleToRandin,t.y=e.x*at._angleToRandin,t.z=e.z*at._angleToRandin,this._locaEulerlUpdate=!1}return this._localRotationEuler},set:function(e){this._localRotationEuler=e,this._locaEulerlUpdate=!1,this._localQuaternionUpdate=!0,this._localUpdate=!0,this._onWorldTransform()}}]),at}();Bi._tempVector3=new D,Bi._angleToRandin=180/Math.PI;var Fi=function(){function st(){_classCallCheck(this,st),this._parent=null,this.name=null,this._worldMatrixIndex=0,this._children=[],this.transform=new Bi(this)}return _createClass(st,[{key:"addChild",value:function(e){e._parent=this,e.transform.setParent(this.transform),this._children.push(e)}},{key:"removeChild",value:function(e){var t=this._children.indexOf(e);-1!==t&&this._children.splice(t,1)}},{key:"getChildByName",value:function(e){for(var t=0,n=this._children.length;t<n;t++){var i=this._children[t];if(i.name===e)return i}return null}},{key:"getChildByIndex",value:function(e){return this._children[e]}},{key:"getChildCount",value:function(){return this._children.length}},{key:"cloneTo",value:function(e){var t=e;t.name=this.name;for(var n=0,i=this._children.length;n<i;n++){var r=this._children[n],a=r.clone();t.addChild(a);var o=r.transform,s=a.transform,l=s.localPosition,u=s.localRotation,_=s.localScale;o.localPosition.cloneTo(l),o.localRotation.cloneTo(u),o.localScale.cloneTo(_),s.localPosition=l,s.localRotation=u,s.localScale=_}}},{key:"clone",value:function(){var e=new st;return this.cloneTo(e),e}},{key:"_cloneNative",value:function(e,t,n,i,r,a,o){var s=o._nativeCurCloneCount;r[s]=a;var l=new st;return l._worldMatrixIndex=s,this._cloneToNative(l,e,t,n,i,r,s,o),l}},{key:"_cloneToNative",value:function(e,t,n,i,r,a,o,s){var l=e;l.name=this.name;for(var u=0,_=this._children.length;u<_;u++){var c=this._children[u];s._nativeCurCloneCount++;var h=c._cloneNative(t,n,i,r,a,o,s);l.addChild(h);var d=c.transform,f=h.transform,m=f.localPosition,p=f.localRotation,v=f.localScale;d.localPosition.cloneTo(m),d.localRotation.cloneTo(p),d.localScale.cloneTo(v),f.localPosition=m,f.localRotation=p,f.localScale=v}}}]),st}(),Ui=function(e){function ot(){var e;return _classCallCheck(this,ot),(e=_possibleConstructorReturn(this,_getPrototypeOf(ot).call(this)))._nativeNodeCount=0,e._nativeCurCloneCount=0,e}return _inherits(ot,t.Resource),_createClass(ot,[{key:"_initCloneToAnimator",value:function(e,t){t._avatarNodeMap[e.name]=e;for(var n=0,i=e.getChildCount();n<i;n++)this._initCloneToAnimator(e.getChildByIndex(n),t)}},{key:"_parseNode",value:function(e,t){var n=e.props.name;t.name=n;var i=e.props,r=t.transform,a=r.localPosition,o=r.localRotation,s=r.localScale;a.fromArray(i.translate),o.fromArray(i.rotation),s.fromArray(i.scale),r.localPosition=a,r.localRotation=o,r.localScale=s;for(var l=e.child,u=0,_=l.length;u<_;u++){var c=l[u],h=new Fi;t.addChild(h),this._parseNode(c,h)}}},{key:"_cloneDatasToAnimator",value:function(e){var t;t=this._rootNode.clone();var n=this._rootNode.transform,i=t.transform,r=i.localPosition,a=i.localRotation,o=i.localScale;n.localPosition.cloneTo(r),n.localRotation.cloneTo(a),n.localScale.cloneTo(o),i.localPosition=r,i.localRotation=a,i.localScale=o,e._avatarNodeMap={},this._initCloneToAnimator(t,e)}},{key:"cloneTo",value:function(e){var t=e,n=this._rootNode.clone();t._rootNode=n}},{key:"clone",value:function(){var e=new ot;return this.cloneTo(e),e}},{key:"_cloneDatasToAnimatorNative",value:function(e){var t=new Float32Array(3*this._nativeNodeCount),n=new Float32Array(4*this._nativeNodeCount),i=new Float32Array(3*this._nativeNodeCount),r=new Float32Array(16*this._nativeNodeCount),a=new Int16Array(this._nativeNodeCount);e._animationNodeLocalPositions=t,e._animationNodeLocalRotations=n,e._animationNodeLocalScales=i,e._animationNodeWorldMatrixs=r,e._animationNodeParentIndices=a,this._nativeCurCloneCount=0;var o=this._rootNode._cloneNative(t,n,i,r,a,-1,this),s=this._rootNode.transform,l=o.transform,u=l.localPosition,_=l.localRotation,c=l.localScale;s.localPosition.cloneTo(u),s.localRotation.cloneTo(_),s.localScale.cloneTo(c),l.localPosition=u,l.localRotation=_,l.localScale=c,e._avatarNodeMap={},this._initCloneToAnimator(o,e)}}],[{key:"_parse",value:function(e){arguments.length>1&&void 0!==arguments[1]&&arguments[1],arguments.length>2&&void 0!==arguments[2]&&arguments[2];var t=new ot;if(t._rootNode=new Fi,e.version){var n=e.rootNode;n&&t._parseNode(n,t._rootNode)}return t}},{key:"load",value:function(e,n){t.ILaya.loader.create(e,n,null,ot.AVATAR)}}]),ot}();Ui.AVATAR="AVATAR";var Gi=function(e){function lt(){var e;return _classCallCheck(this,lt),(e=_possibleConstructorReturn(this,_getPrototypeOf(lt).call(this)))._shaderValues=new En(_assertThisInitialized(e)),e.renderQueue=lt.RENDERQUEUE_OPAQUE,e._alphaTest=!1,e}return _inherits(lt,t.Resource),_createClass(lt,[{key:"_removeTetxureReference",value:function(){var e=this._shaderValues.getData();for(var n in e){var i=e[n];i&&i instanceof t.BaseTexture&&i._removeReference()}}},{key:"_disposeResource",value:function(){this._referenceCount>0&&this._removeTetxureReference(),this._shaderValues=null}},{key:"_addReference",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;_get(_getPrototypeOf(lt.prototype),"_addReference",this).call(this,e);var n=this._shaderValues.getData();for(var i in n){var r=n[i];r&&r instanceof t.BaseTexture&&r._addReference()}}},{key:"_removeReference",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;_get(_getPrototypeOf(lt.prototype),"_removeReference",this).call(this,e),this._removeTetxureReference()}},{key:"setShaderName",value:function(e){if(this._shader=xn.find(e),!this._shader)throw new Error("BaseMaterial: unknown shader name.")}},{key:"cloneTo",value:function(e){var t=e;t.name=this.name,t.renderQueue=this.renderQueue,this._shaderValues.cloneTo(t._shaderValues)}},{key:"clone",value:function(){var e=new lt;return this.cloneTo(e),e}},{key:"shaderData",get:function(){return this._shaderValues}},{key:"alphaTestValue",get:function(){return this._shaderValues.getNumber(lt.ALPHATESTVALUE)},set:function(e){this._shaderValues.setNumber(lt.ALPHATESTVALUE,e)}},{key:"alphaTest",get:function(){return this._alphaTest},set:function(e){this._alphaTest=e,e?this._shaderValues.addDefine(lt.SHADERDEFINE_ALPHATEST):this._shaderValues.removeDefine(lt.SHADERDEFINE_ALPHATEST)}},{key:"depthWrite",get:function(){return this._shaderValues.getBool(lt.DEPTH_WRITE)},set:function(e){this._shaderValues.setBool(lt.DEPTH_WRITE,e)}},{key:"cull",get:function(){return this._shaderValues.getInt(lt.CULL)},set:function(e){this._shaderValues.setInt(lt.CULL,e)}},{key:"blend",get:function(){return this._shaderValues.getInt(lt.BLEND)},set:function(e){this._shaderValues.setInt(lt.BLEND,e)}},{key:"blendSrc",get:function(){return this._shaderValues.getInt(lt.BLEND_SRC)},set:function(e){this._shaderValues.setInt(lt.BLEND_SRC,e)}},{key:"blendDst",get:function(){return this._shaderValues.getInt(lt.BLEND_DST)},set:function(e){this._shaderValues.setInt(lt.BLEND_DST,e)}},{key:"depthTest",get:function(){return this._shaderValues.getInt(lt.DEPTH_TEST)},set:function(e){this._shaderValues.setInt(lt.DEPTH_TEST,e)}},{key:"_defineDatas",get:function(){return this._shaderValues._defineDatas}}],[{key:"load",value:function(e,n){t.Laya.loader.create(e,n,null,lt.MATERIAL)}},{key:"__initDefine__",value:function(){lt.SHADERDEFINE_ALPHATEST=xn.getDefineByName("ALPHATEST")}},{key:"_parse",value:function(e){arguments.length>1&&void 0!==arguments[1]&&arguments[1],arguments.length>2&&void 0!==arguments[2]&&arguments[2];var n,i=e,a=i.props,s=a.type,l=t.ClassUtils.getRegClass(s);if(!l)throw"_getSprite3DHierarchyInnerUrls : "+e.type+" ";switch(n=new l,i.version){case"LAYAMATERIAL:01":case"LAYAMATERIAL:02":var u,_;for(var c in a)switch(c){case"type":break;case"vectors":var h=a[c];for(u=0,_=h.length;u<_;u++){var d=h[u],f=d.value;switch(f.length){case 2:n[d.name]=new r(f[0],f[1]);break;case 3:n[d.name]=new D(f[0],f[1],f[2]);break;case 4:n[d.name]=new o(f[0],f[1],f[2],f[3]);break;default:throw new Error("BaseMaterial:unkonwn color length.")}}break;case"textures":var m=a[c];for(u=0,_=m.length;u<_;u++){var p=m[u],v=p.path;v&&(n[p.name]=t.Loader.getRes(v))}break;case"defines":var E=a[c];for(u=0,_=E.length;u<_;u++){var T=xn.getDefineByName(E[u]);n._shaderValues.addDefine(T)}break;case"renderStates":var g=a[c][0],y=n;y.blend=g.blend,y.cull=g.cull,y.depthTest=g.depthTest,y.depthWrite=g.depthWrite,y.blendSrc=g.srcBlend,y.blendDst=g.dstBlend;break;case"cull":n.cull=a[c];break;case"blend":n.blend=a[c];break;case"depthWrite":n.depthWrite=a[c];break;case"srcBlend":n.blendSrc=a[c];break;case"dstBlend":n.blendDst=a[c];break;default:n[c]=a[c]}break;default:throw new Error("BaseMaterial:unkonwn version.")}return n}}]),lt}();Gi.MATERIAL="MATERIAL",Gi.RENDERQUEUE_OPAQUE=2e3,Gi.RENDERQUEUE_ALPHATEST=2450,Gi.RENDERQUEUE_TRANSPARENT=3e3,Gi.ALPHATESTVALUE=xn.propertyNameToID("u_AlphaTestValue"),Gi.CULL=xn.propertyNameToID("s_Cull"),Gi.BLEND=xn.propertyNameToID("s_Blend"),Gi.BLEND_SRC=xn.propertyNameToID("s_BlendSrc"),Gi.BLEND_DST=xn.propertyNameToID("s_BlendDst"),Gi.DEPTH_TEST=xn.propertyNameToID("s_DepthTest"),Gi.DEPTH_WRITE=xn.propertyNameToID("s_DepthWrite");var Hi=function(){function ht(){_classCallCheck(this,ht)}return _createClass(ht,null,[{key:"load",value:function(e,n){t.Laya.loader.create(e,n,null,Gi.MATERIAL)}},{key:"__initDefine__",value:function(){ht.SHADERDEFINE_ALPHATEST=Gi.SHADERDEFINE_ALPHATEST}}]),ht}();Hi.MATERIAL="MATERIAL",Hi.RENDERQUEUE_OPAQUE=2e3,Hi.RENDERQUEUE_ALPHATEST=2450,Hi.RENDERQUEUE_TRANSPARENT=3e3,Hi.ALPHATESTVALUE=xn.propertyNameToID("u_AlphaTestValue");var Wi=function(){function _t(){_classCallCheck(this,_t),this.cull=_t.CULL_BACK,this.blend=_t.BLEND_DISABLE,this.srcBlend=_t.BLENDPARAM_ONE,this.dstBlend=_t.BLENDPARAM_ZERO,this.srcBlendRGB=_t.BLENDPARAM_ONE,this.dstBlendRGB=_t.BLENDPARAM_ZERO,this.srcBlendAlpha=_t.BLENDPARAM_ONE,this.dstBlendAlpha=_t.BLENDPARAM_ZERO,this.blendConstColor=new o(1,1,1,1),this.blendEquation=_t.BLENDEQUATION_ADD,this.blendEquationRGB=_t.BLENDEQUATION_ADD,this.blendEquationAlpha=_t.BLENDEQUATION_ADD,this.depthTest=_t.DEPTHTEST_LEQUAL,this.depthWrite=!0}return _createClass(_t,[{key:"cloneTo",value:function(e){var t=e;t.cull=this.cull,t.blend=this.blend,t.srcBlend=this.srcBlend,t.dstBlend=this.dstBlend,t.srcBlendRGB=this.srcBlendRGB,t.dstBlendRGB=this.dstBlendRGB,t.srcBlendAlpha=this.srcBlendAlpha,t.dstBlendAlpha=this.dstBlendAlpha,this.blendConstColor.cloneTo(t.blendConstColor),t.blendEquation=this.blendEquation,t.blendEquationRGB=this.blendEquationRGB,t.blendEquationAlpha=this.blendEquationAlpha,t.depthTest=this.depthTest,t.depthWrite=this.depthWrite}},{key:"clone",value:function(){var e=new _t;return this.cloneTo(e),e}}]),_t}();Wi.CULL_NONE=0,Wi.CULL_FRONT=1,Wi.CULL_BACK=2,Wi.BLEND_DISABLE=0,Wi.BLEND_ENABLE_ALL=1,Wi.BLEND_ENABLE_SEPERATE=2,Wi.BLENDPARAM_ZERO=0,Wi.BLENDPARAM_ONE=1,Wi.BLENDPARAM_SRC_COLOR=768,Wi.BLENDPARAM_ONE_MINUS_SRC_COLOR=769,Wi.BLENDPARAM_DST_COLOR=774,Wi.BLENDPARAM_ONE_MINUS_DST_COLOR=775,Wi.BLENDPARAM_SRC_ALPHA=770,Wi.BLENDPARAM_ONE_MINUS_SRC_ALPHA=771,Wi.BLENDPARAM_DST_ALPHA=772,Wi.BLENDPARAM_ONE_MINUS_DST_ALPHA=773,Wi.BLENDPARAM_SRC_ALPHA_SATURATE=776,Wi.BLENDEQUATION_ADD=32774,Wi.BLENDEQUATION_SUBTRACT=32778,Wi.BLENDEQUATION_REVERSE_SUBTRACT=32779,Wi.DEPTHTEST_OFF=0,Wi.DEPTHTEST_NEVER=512,Wi.DEPTHTEST_LESS=513,Wi.DEPTHTEST_EQUAL=514,Wi.DEPTHTEST_LEQUAL=515,Wi.DEPTHTEST_GREATER=516,Wi.DEPTHTEST_NOTEQUAL=517,Wi.DEPTHTEST_GEQUAL=518,Wi.DEPTHTEST_ALWAYS=519;var Ki=function(e){function ct(){var e;_classCallCheck(this,ct),(e=_possibleConstructorReturn(this,_getPrototypeOf(ct).call(this)))._enableVertexColor=!1,e._enableTransmission=!1,e.setShaderName("BLINNPHONG"),e._albedoIntensity=1,e._albedoColor=new o(1,1,1,1);var t=e._shaderValues;return t.setVector(ct.ALBEDOCOLOR,new o(1,1,1,1)),t.setVector(ct.MATERIALSPECULAR,new o(1,1,1,1)),t.setNumber(ct.SHININESS,.078125),t.setNumber(Gi.ALPHATESTVALUE,.5),t.setVector(ct.TILINGOFFSET,new o(1,1,0,0)),e._enableLighting=!0,e.renderMode=ct.RENDERMODE_OPAQUE,e}return _inherits(ct,Gi),_createClass(ct,[{key:"clone",value:function(){var e=new ct;return this.cloneTo(e),e}},{key:"cloneTo",value:function(e){_get(_getPrototypeOf(ct.prototype),"cloneTo",this).call(this,e);var t=e;t._enableLighting=this._enableLighting,t._albedoIntensity=this._albedoIntensity,t._enableVertexColor=this._enableVertexColor,this._albedoColor.cloneTo(t._albedoColor)}},{key:"_ColorR",get:function(){return this._albedoColor.x},set:function(e){this._albedoColor.x=e,this.albedoColor=this._albedoColor}},{key:"_ColorG",get:function(){return this._albedoColor.y},set:function(e){this._albedoColor.y=e,this.albedoColor=this._albedoColor}},{key:"_ColorB",get:function(){return this._albedoColor.z},set:function(e){this._albedoColor.z=e,this.albedoColor=this._albedoColor}},{key:"_ColorA",get:function(){return this._albedoColor.w},set:function(e){this._albedoColor.w=e,this.albedoColor=this._albedoColor}},{key:"_Color",get:function(){return this._shaderValues.getVector(ct.ALBEDOCOLOR)},set:function(e){this.albedoColor=e}},{key:"_SpecColorR",get:function(){return this._shaderValues.getVector(ct.MATERIALSPECULAR).x},set:function(e){this._shaderValues.getVector(ct.MATERIALSPECULAR).x=e}},{key:"_SpecColorG",get:function(){return this._shaderValues.getVector(ct.MATERIALSPECULAR).y},set:function(e){this._shaderValues.getVector(ct.MATERIALSPECULAR).y=e}},{key:"_SpecColorB",get:function(){return this._shaderValues.getVector(ct.MATERIALSPECULAR).z},set:function(e){this._shaderValues.getVector(ct.MATERIALSPECULAR).z=e}},{key:"_SpecColorA",get:function(){return this._shaderValues.getVector(ct.MATERIALSPECULAR).w},set:function(e){this._shaderValues.getVector(ct.MATERIALSPECULAR).w=e}},{key:"_SpecColor",get:function(){return this._shaderValues.getVector(ct.MATERIALSPECULAR)},set:function(e){this.specularColor=e}},{key:"_AlbedoIntensity",get:function(){return this._albedoIntensity},set:function(e){if(this._albedoIntensity!==e){var t=this._shaderValues.getVector(ct.ALBEDOCOLOR);o.scale(this._albedoColor,e,t),this._albedoIntensity=e,this._shaderValues.setVector(ct.ALBEDOCOLOR,t)}}},{key:"_Shininess",get:function(){return this._shaderValues.getNumber(ct.SHININESS)},set:function(e){e=Math.max(0,Math.min(1,e)),this._shaderValues.setNumber(ct.SHININESS,e)}},{key:"_MainTex_STX",get:function(){return this._shaderValues.getVector(ct.TILINGOFFSET).x},set:function(e){var t=this._shaderValues.getVector(ct.TILINGOFFSET);t.x=e,this.tilingOffset=t}},{key:"_MainTex_STY",get:function(){return this._shaderValues.getVector(ct.TILINGOFFSET).y},set:function(e){var t=this._shaderValues.getVector(ct.TILINGOFFSET);t.y=e,this.tilingOffset=t}},{key:"_MainTex_STZ",get:function(){return this._shaderValues.getVector(ct.TILINGOFFSET).z},set:function(e){var t=this._shaderValues.getVector(ct.TILINGOFFSET);t.z=e,this.tilingOffset=t}},{key:"_MainTex_STW",get:function(){return this._shaderValues.getVector(ct.TILINGOFFSET).w},set:function(e){var t=this._shaderValues.getVector(ct.TILINGOFFSET);t.w=e,this.tilingOffset=t}},{key:"_MainTex_ST",get:function(){return this._shaderValues.getVector(ct.TILINGOFFSET)},set:function(e){this.tilingOffset=e}},{key:"_Cutoff",get:function(){return this.alphaTestValue},set:function(e){this.alphaTestValue=e}},{key:"renderMode",set:function(e){switch(e){case ct.RENDERMODE_OPAQUE:this.alphaTest=!1,this.renderQueue=Gi.RENDERQUEUE_OPAQUE,this.depthWrite=!0,this.cull=Wi.CULL_BACK,this.blend=Wi.BLEND_DISABLE,this.depthTest=Wi.DEPTHTEST_LESS;break;case ct.RENDERMODE_CUTOUT:this.renderQueue=Gi.RENDERQUEUE_ALPHATEST,this.alphaTest=!0,this.depthWrite=!0,this.cull=Wi.CULL_BACK,this.blend=Wi.BLEND_DISABLE,this.depthTest=Wi.DEPTHTEST_LESS;break;case ct.RENDERMODE_TRANSPARENT:this.renderQueue=Gi.RENDERQUEUE_TRANSPARENT,this.alphaTest=!1,this.depthWrite=!1,this.cull=Wi.CULL_BACK,this.blend=Wi.BLEND_ENABLE_ALL,this.blendSrc=Wi.BLENDPARAM_SRC_ALPHA,this.blendDst=Wi.BLENDPARAM_ONE_MINUS_SRC_ALPHA,this.depthTest=Wi.DEPTHTEST_LESS;break;default:throw new Error("Material:renderMode value error.")}}},{key:"enableVertexColor",get:function(){return this._enableVertexColor},set:function(e){this._enableVertexColor=e,e?this._shaderValues.addDefine(ct.SHADERDEFINE_ENABLEVERTEXCOLOR):this._shaderValues.removeDefine(ct.SHADERDEFINE_ENABLEVERTEXCOLOR)}},{key:"tilingOffsetX",get:function(){return this._MainTex_STX},set:function(e){this._MainTex_STX=e}},{key:"tilingOffsetY",get:function(){return this._MainTex_STY},set:function(e){this._MainTex_STY=e}},{key:"tilingOffsetZ",get:function(){return this._MainTex_STZ},set:function(e){this._MainTex_STZ=e}},{key:"tilingOffsetW",get:function(){return this._MainTex_STW},set:function(e){this._MainTex_STW=e}},{key:"tilingOffset",get:function(){return this._shaderValues.getVector(ct.TILINGOFFSET)},set:function(e){e?this._shaderValues.setVector(ct.TILINGOFFSET,e):this._shaderValues.getVector(ct.TILINGOFFSET).setValue(1,1,0,0)}},{key:"albedoColorR",get:function(){return this._ColorR},set:function(e){this._ColorR=e}},{key:"albedoColorG",get:function(){return this._ColorG},set:function(e){this._ColorG=e}},{key:"albedoColorB",get:function(){return this._ColorB},set:function(e){this._ColorB=e}},{key:"albedoColorA",get:function(){return this._ColorA},set:function(e){this._ColorA=e}},{key:"albedoColor",get:function(){return this._albedoColor},set:function(e){var t=this._shaderValues.getVector(ct.ALBEDOCOLOR);o.scale(e,this._albedoIntensity,t),this._albedoColor=e,this._shaderValues.setVector(ct.ALBEDOCOLOR,t)}},{key:"albedoIntensity",get:function(){return this._albedoIntensity},set:function(e){this._AlbedoIntensity=e}},{key:"specularColorR",get:function(){return this._SpecColorR},set:function(e){this._SpecColorR=e}},{key:"specularColorG",get:function(){return this._SpecColorG},set:function(e){this._SpecColorG=e}},{key:"specularColorB",get:function(){return this._SpecColorB},set:function(e){this._SpecColorB=e}},{key:"specularColorA",get:function(){return this._SpecColorA},set:function(e){this._SpecColorA=e}},{key:"specularColor",get:function(){return this._shaderValues.getVector(ct.MATERIALSPECULAR)},set:function(e){this._shaderValues.setVector(ct.MATERIALSPECULAR,e)}},{key:"shininess",get:function(){return this._Shininess},set:function(e){this._Shininess=e}},{key:"albedoTexture",get:function(){return this._shaderValues.getTexture(ct.ALBEDOTEXTURE)},set:function(e){e?this._shaderValues.addDefine(ct.SHADERDEFINE_DIFFUSEMAP):this._shaderValues.removeDefine(ct.SHADERDEFINE_DIFFUSEMAP),this._shaderValues.setTexture(ct.ALBEDOTEXTURE,e)}},{key:"normalTexture",get:function(){return this._shaderValues.getTexture(ct.NORMALTEXTURE)},set:function(e){e?this._shaderValues.addDefine(ct.SHADERDEFINE_NORMALMAP):this._shaderValues.removeDefine(ct.SHADERDEFINE_NORMALMAP),this._shaderValues.setTexture(ct.NORMALTEXTURE,e)}},{key:"specularTexture",get:function(){return this._shaderValues.getTexture(ct.SPECULARTEXTURE)},set:function(e){e?this._shaderValues.addDefine(ct.SHADERDEFINE_SPECULARMAP):this._shaderValues.removeDefine(ct.SHADERDEFINE_SPECULARMAP),this._shaderValues.setTexture(ct.SPECULARTEXTURE,e)}},{key:"enableTransmission",get:function(){return this._enableTransmission},set:function(e){this._enableTransmission=e,e?this._shaderValues.addDefine(ct.SHADERDEFINE_ENABLETRANSMISSION):this._shaderValues.removeDefine(ct.SHADERDEFINE_ENABLETRANSMISSION)}},{key:"transmissionRate",get:function(){return this._shaderValues.getNumber(ct.TRANSMISSIONRATE)}},{key:"transmissionRata",set:function(e){this._shaderValues.setNumber(ct.TRANSMISSIONRATE,e)}},{key:"backDiffuse",get:function(){return this._shaderValues.getNumber(ct.IBACKDIFFUSE)},set:function(e){this._shaderValues.setNumber(ct.IBACKDIFFUSE,Math.max(e,1))}},{key:"backScale",get:function(){return this._shaderValues.getNumber(ct.IBACKSCALE)},set:function(e){this._shaderValues.setNumber(ct.IBACKSCALE,e)}},{key:"thinknessTexture",get:function(){return this._shaderValues.getTexture(ct.THINKNESSTEXTURE)},set:function(e){e?this._shaderValues.addDefine(ct.SHADERDEFINE_THICKNESSMAP):this._shaderValues.removeDefine(ct.SHADERDEFINE_THICKNESSMAP),this._shaderValues.setTexture(ct.THINKNESSTEXTURE,e)}},{key:"transmissionColor",get:function(){return this._shaderValues.getVector(ct.TRANSMISSIONCOLOR)},set:function(e){this._shaderValues.setVector(ct.TRANSMISSIONCOLOR,e)}}],[{key:"__initDefine__",value:function(){ct.SHADERDEFINE_DIFFUSEMAP=xn.getDefineByName("DIFFUSEMAP"),ct.SHADERDEFINE_NORMALMAP=xn.getDefineByName("NORMALMAP"),ct.SHADERDEFINE_SPECULARMAP=xn.getDefineByName("SPECULARMAP"),ct.SHADERDEFINE_ENABLEVERTEXCOLOR=xn.getDefineByName("ENABLEVERTEXCOLOR"),ct.SHADERDEFINE_ENABLETRANSMISSION=xn.getDefineByName("ENABLETRANSMISSION"),ct.SHADERDEFINE_THICKNESSMAP=xn.getDefineByName("THICKNESSMAP")}}]),ct}();Ki.RENDERMODE_OPAQUE=0,Ki.RENDERMODE_CUTOUT=1,Ki.RENDERMODE_TRANSPARENT=2,Ki.ALBEDOTEXTURE=xn.propertyNameToID("u_DiffuseTexture"),Ki.NORMALTEXTURE=xn.propertyNameToID("u_NormalTexture"),Ki.SPECULARTEXTURE=xn.propertyNameToID("u_SpecularTexture"),Ki.ALBEDOCOLOR=xn.propertyNameToID("u_DiffuseColor"),Ki.MATERIALSPECULAR=xn.propertyNameToID("u_MaterialSpecular"),Ki.SHININESS=xn.propertyNameToID("u_Shininess"),Ki.TILINGOFFSET=xn.propertyNameToID("u_TilingOffset"),Ki.TRANSMISSIONRATE=xn.propertyNameToID("u_TransmissionRate"),Ki.IBACKDIFFUSE=xn.propertyNameToID("u_BackDiffuse"),Ki.IBACKSCALE=xn.propertyNameToID("u_BackScale"),Ki.THINKNESSTEXTURE=xn.propertyNameToID("u_ThinknessTexture"),Ki.TRANSMISSIONCOLOR=xn.propertyNameToID("u_TransmissionColor");var er=function(e){function dt(){var e;return _classCallCheck(this,dt),(e=_possibleConstructorReturn(this,_getPrototypeOf(dt).call(this))).setShaderName("Effect"),e._color=new o(1,1,1,1),e._shaderValues.setVector(dt.TILINGOFFSET,new o(1,1,0,0)),e._shaderValues.setVector(dt.TINTCOLOR,new o(1,1,1,1)),e.renderMode=dt.RENDERMODE_ADDTIVE,e}return _inherits(dt,Gi),_createClass(dt,[{key:"clone",value:function(){var e=new dt;return this.cloneTo(e),e}},{key:"_TintColorR",get:function(){return this._color.x},set:function(e){this._color.x=e,this.color=this._color}},{key:"_TintColorG",get:function(){return this._color.y},set:function(e){this._color.y=e,this.color=this._color}},{key:"_TintColorB",get:function(){return this._color.z},set:function(e){this._color.z=e,this.color=this._color}},{key:"_TintColorA",get:function(){return this._color.w},set:function(e){this._color.w=e,this.color=this._color}},{key:"_TintColor",get:function(){return this._shaderValues.getVector(dt.TINTCOLOR)},set:function(e){this.color=e}},{key:"_MainTex_STX",get:function(){return this._shaderValues.getVector(dt.TILINGOFFSET).x},set:function(e){var t=this._shaderValues.getVector(dt.TILINGOFFSET);t.x=e,this.tilingOffset=t}},{key:"_MainTex_STY",get:function(){return this._shaderValues.getVector(dt.TILINGOFFSET).y},set:function(e){var t=this._shaderValues.getVector(dt.TILINGOFFSET);t.y=e,this.tilingOffset=t}},{key:"_MainTex_STZ",get:function(){return this._shaderValues.getVector(dt.TILINGOFFSET).z},set:function(e){var t=this._shaderValues.getVector(dt.TILINGOFFSET);t.z=e,this.tilingOffset=t}},{key:"_MainTex_STW",get:function(){return this._shaderValues.getVector(dt.TILINGOFFSET).w},set:function(e){var t=this._shaderValues.getVector(dt.TILINGOFFSET);t.w=e,this.tilingOffset=t}},{key:"_MainTex_ST",get:function(){return this._shaderValues.getVector(dt.TILINGOFFSET)},set:function(e){this.tilingOffset=e}},{key:"renderMode",set:function(e){switch(e){case dt.RENDERMODE_ADDTIVE:this.renderQueue=Gi.RENDERQUEUE_TRANSPARENT,this.alphaTest=!1,this.depthWrite=!1,this.cull=Wi.CULL_NONE,this.blend=Wi.BLEND_ENABLE_ALL,this.blendSrc=Wi.BLENDPARAM_SRC_ALPHA,this.blendDst=Wi.BLENDPARAM_ONE,this.depthTest=Wi.DEPTHTEST_LESS,this._shaderValues.addDefine(dt.SHADERDEFINE_ADDTIVEFOG);break;case dt.RENDERMODE_ALPHABLENDED:this.renderQueue=Gi.RENDERQUEUE_TRANSPARENT,this.alphaTest=!1,this.depthWrite=!1,this.cull=Wi.CULL_NONE,this.blend=Wi.BLEND_ENABLE_ALL,this.blendSrc=Wi.BLENDPARAM_SRC_ALPHA,this.blendDst=Wi.BLENDPARAM_ONE_MINUS_SRC_ALPHA,this.depthTest=Wi.DEPTHTEST_LESS,this._shaderValues.removeDefine(dt.SHADERDEFINE_ADDTIVEFOG);break;default:throw new Error("MeshEffectMaterial : renderMode value error.")}}},{key:"colorR",get:function(){return this._TintColorR},set:function(e){this._TintColorR=e}},{key:"colorG",get:function(){return this._TintColorG},set:function(e){this._TintColorG=e}},{key:"colorB",get:function(){return this._TintColorB},set:function(e){this._TintColorB=e}},{key:"colorA",get:function(){return this._TintColorA},set:function(e){this._TintColorA=e}},{key:"color",get:function(){return this._shaderValues.getVector(dt.TINTCOLOR)},set:function(e){this._shaderValues.setVector(dt.TINTCOLOR,e)}},{key:"texture",get:function(){return this._shaderValues.getTexture(dt.MAINTEXTURE)},set:function(e){e?this._shaderValues.addDefine(dt.SHADERDEFINE_MAINTEXTURE):this._shaderValues.removeDefine(dt.SHADERDEFINE_MAINTEXTURE),this._shaderValues.setTexture(dt.MAINTEXTURE,e)}},{key:"tilingOffsetX",get:function(){return this._MainTex_STX},set:function(e){this._MainTex_STX=e}},{key:"tilingOffsetY",get:function(){return this._MainTex_STY},set:function(e){this._MainTex_STY=e}},{key:"tilingOffsetZ",get:function(){return this._MainTex_STZ},set:function(e){this._MainTex_STZ=e}},{key:"tilingOffsetW",get:function(){return this._MainTex_STW},set:function(e){this._MainTex_STW=e}},{key:"tilingOffset",get:function(){return this._shaderValues.getVector(dt.TILINGOFFSET)},set:function(e){e?this._shaderValues.setVector(dt.TILINGOFFSET,e):this._shaderValues.getVector(dt.TILINGOFFSET).setValue(1,1,0,0)}}],[{key:"__initDefine__",value:function(){dt.SHADERDEFINE_MAINTEXTURE=xn.getDefineByName("MAINTEXTURE"),dt.SHADERDEFINE_ADDTIVEFOG=xn.getDefineByName("ADDTIVEFOG")}}]),dt}();er.RENDERMODE_ADDTIVE=0,er.RENDERMODE_ALPHABLENDED=1,er.MAINTEXTURE=xn.propertyNameToID("u_AlbedoTexture"),er.TINTCOLOR=xn.propertyNameToID("u_AlbedoColor"),er.TILINGOFFSET=xn.propertyNameToID("u_TilingOffset");var rr=function(e){function ut(){var e;return _classCallCheck(this,ut),(e=_possibleConstructorReturn(this,_getPrototypeOf(ut).call(this))).setShaderName("ExtendTerrain"),e.renderMode=ut.RENDERMODE_OPAQUE,e}return _inherits(ut,Gi),_createClass(ut,[{key:"_setDetailNum",value:function(e){switch(e){case 1:this._shaderValues.addDefine(ut.SHADERDEFINE_DETAIL_NUM1),this._shaderValues.removeDefine(ut.SHADERDEFINE_DETAIL_NUM2),this._shaderValues.removeDefine(ut.SHADERDEFINE_DETAIL_NUM3),this._shaderValues.removeDefine(ut.SHADERDEFINE_DETAIL_NUM4),this._shaderValues.removeDefine(ut.SHADERDEFINE_DETAIL_NUM5);break;case 2:this._shaderValues.addDefine(ut.SHADERDEFINE_DETAIL_NUM2),this._shaderValues.removeDefine(ut.SHADERDEFINE_DETAIL_NUM1),this._shaderValues.removeDefine(ut.SHADERDEFINE_DETAIL_NUM3),this._shaderValues.removeDefine(ut.SHADERDEFINE_DETAIL_NUM4),this._shaderValues.removeDefine(ut.SHADERDEFINE_DETAIL_NUM5);break;case 3:this._shaderValues.addDefine(ut.SHADERDEFINE_DETAIL_NUM3),this._shaderValues.removeDefine(ut.SHADERDEFINE_DETAIL_NUM1),this._shaderValues.removeDefine(ut.SHADERDEFINE_DETAIL_NUM2),this._shaderValues.removeDefine(ut.SHADERDEFINE_DETAIL_NUM4),this._shaderValues.removeDefine(ut.SHADERDEFINE_DETAIL_NUM5);break;case 4:this._shaderValues.addDefine(ut.SHADERDEFINE_DETAIL_NUM4),this._shaderValues.removeDefine(ut.SHADERDEFINE_DETAIL_NUM1),this._shaderValues.removeDefine(ut.SHADERDEFINE_DETAIL_NUM2),this._shaderValues.removeDefine(ut.SHADERDEFINE_DETAIL_NUM3),this._shaderValues.removeDefine(ut.SHADERDEFINE_DETAIL_NUM5);break;case 5:this._shaderValues.addDefine(ut.SHADERDEFINE_DETAIL_NUM5),this._shaderValues.removeDefine(ut.SHADERDEFINE_DETAIL_NUM1),this._shaderValues.removeDefine(ut.SHADERDEFINE_DETAIL_NUM2),this._shaderValues.removeDefine(ut.SHADERDEFINE_DETAIL_NUM3),this._shaderValues.removeDefine(ut.SHADERDEFINE_DETAIL_NUM4)}}},{key:"clone",value:function(){var e=new ut;return this.cloneTo(e),e}},{key:"splatAlphaTexture",get:function(){return this._shaderValues.getTexture(ut.SPLATALPHATEXTURE)},set:function(e){this._shaderValues.setTexture(ut.SPLATALPHATEXTURE,e)}},{key:"diffuseTexture1",get:function(){return this._shaderValues.getTexture(ut.DIFFUSETEXTURE1)},set:function(e){this._shaderValues.setTexture(ut.DIFFUSETEXTURE1,e),this._setDetailNum(1)}},{key:"diffuseTexture2",get:function(){return this._shaderValues.getTexture(ut.DIFFUSETEXTURE2)},set:function(e){this._shaderValues.setTexture(ut.DIFFUSETEXTURE2,e),this._setDetailNum(2)}},{key:"diffuseTexture3",get:function(){return this._shaderValues.getTexture(ut.DIFFUSETEXTURE3)},set:function(e){this._shaderValues.setTexture(ut.DIFFUSETEXTURE3,e),this._setDetailNum(3)}},{key:"diffuseTexture4",get:function(){return this._shaderValues.getTexture(ut.DIFFUSETEXTURE4)},set:function(e){this._shaderValues.setTexture(ut.DIFFUSETEXTURE4,e),this._setDetailNum(4)}},{key:"diffuseTexture5",get:function(){return this._shaderValues.getTexture(ut.DIFFUSETEXTURE5)},set:function(e){this._shaderValues.setTexture(ut.DIFFUSETEXTURE5,e),this._setDetailNum(5)}},{key:"diffuseScaleOffset1",set:function(e){this._shaderValues.setVector(ut.DIFFUSESCALEOFFSET1,e)}},{key:"diffuseScaleOffset2",set:function(e){this._shaderValues.setVector(ut.DIFFUSESCALEOFFSET2,e)}},{key:"diffuseScaleOffset3",set:function(e){this._shaderValues.setVector(ut.DIFFUSESCALEOFFSET3,e)}},{key:"diffuseScaleOffset4",set:function(e){this._shaderValues.setVector(ut.DIFFUSESCALEOFFSET4,e)}},{key:"diffuseScaleOffset5",set:function(e){this._shaderValues.setVector(ut.DIFFUSESCALEOFFSET5,e)}},{key:"renderMode",set:function(e){switch(e){case ut.RENDERMODE_OPAQUE:this.renderQueue=Gi.RENDERQUEUE_OPAQUE,this.depthWrite=!0,this.cull=Wi.CULL_BACK,this.blend=Wi.BLEND_DISABLE,this.depthTest=Wi.DEPTHTEST_LESS;break;case ut.RENDERMODE_TRANSPARENT:this.renderQueue=Gi.RENDERQUEUE_OPAQUE,this.depthWrite=!1,this.cull=Wi.CULL_BACK,this.blend=Wi.BLEND_ENABLE_ALL,this.blendSrc=Wi.BLENDPARAM_SRC_ALPHA,this.blendDst=Wi.BLENDPARAM_ONE_MINUS_SRC_ALPHA,this.depthTest=Wi.DEPTHTEST_LEQUAL;break;default:throw new Error("ExtendTerrainMaterial:renderMode value error.")}}}],[{key:"__initDefine__",value:function(){ut.SHADERDEFINE_DETAIL_NUM1=xn.getDefineByName("ExtendTerrain_DETAIL_NUM1"),ut.SHADERDEFINE_DETAIL_NUM2=xn.getDefineByName("ExtendTerrain_DETAIL_NUM2"),ut.SHADERDEFINE_DETAIL_NUM3=xn.getDefineByName("ExtendTerrain_DETAIL_NUM3"),ut.SHADERDEFINE_DETAIL_NUM4=xn.getDefineByName("ExtendTerrain_DETAIL_NUM4"),ut.SHADERDEFINE_DETAIL_NUM5=xn.getDefineByName("ExtendTerrain_DETAIL_NUM5")}}]),ut}();rr.RENDERMODE_OPAQUE=1,rr.RENDERMODE_TRANSPARENT=2,rr.SPLATALPHATEXTURE=xn.propertyNameToID("u_SplatAlphaTexture"),rr.DIFFUSETEXTURE1=xn.propertyNameToID("u_DiffuseTexture1"),rr.DIFFUSETEXTURE2=xn.propertyNameToID("u_DiffuseTexture2"),rr.DIFFUSETEXTURE3=xn.propertyNameToID("u_DiffuseTexture3"),rr.DIFFUSETEXTURE4=xn.propertyNameToID("u_DiffuseTexture4"),rr.DIFFUSETEXTURE5=xn.propertyNameToID("u_DiffuseTexture5"),rr.DIFFUSESCALEOFFSET1=xn.propertyNameToID("u_DiffuseScaleOffset1"),rr.DIFFUSESCALEOFFSET2=xn.propertyNameToID("u_DiffuseScaleOffset2"),rr.DIFFUSESCALEOFFSET3=xn.propertyNameToID("u_DiffuseScaleOffset3"),rr.DIFFUSESCALEOFFSET4=xn.propertyNameToID("u_DiffuseScaleOffset4"),rr.DIFFUSESCALEOFFSET5=xn.propertyNameToID("u_DiffuseScaleOffset5"),(g=e.PBRRenderMode||(e.PBRRenderMode={}))[g.Opaque=0]="Opaque",g[g.Cutout=1]="Cutout",g[g.Fade=2]="Fade",g[g.Transparent=3]="Transparent";var or=function(t){function mt(){var t;return _classCallCheck(this,mt),(t=_possibleConstructorReturn(this,_getPrototypeOf(mt).call(this)))._enableEmission=!1,t._shaderValues.setVector(mt.ALBEDOCOLOR,new o(1,1,1,1)),t._shaderValues.setVector(mt.EMISSIONCOLOR,new o(1,1,1,1)),t._shaderValues.setVector(mt.TILINGOFFSET,new o(1,1,0,0)),t._shaderValues.setNumber(mt.SMOOTHNESS,.5),t._shaderValues.setNumber(mt.SMOOTHNESSSCALE,1),t._shaderValues.setNumber(mt.OCCLUSIONSTRENGTH,1),t._shaderValues.setNumber(mt.NORMALSCALE,1),t._shaderValues.setNumber(mt.PARALLAXSCALE,.001),t._shaderValues.setNumber(Gi.ALPHATESTVALUE,.5),t.renderMode=e.PBRRenderMode.Opaque,t}return _inherits(mt,Gi),_createClass(mt,[{key:"albedoColor",get:function(){return this._shaderValues.getVector(mt.ALBEDOCOLOR)},set:function(e){this._shaderValues.setVector(mt.ALBEDOCOLOR,e)}},{key:"albedoTexture",get:function(){return this._shaderValues.getTexture(mt.ALBEDOTEXTURE)},set:function(e){e?this._shaderValues.addDefine(mt.SHADERDEFINE_ALBEDOTEXTURE):this._shaderValues.removeDefine(mt.SHADERDEFINE_ALBEDOTEXTURE),this._shaderValues.setTexture(mt.ALBEDOTEXTURE,e)}},{key:"normalTexture",get:function(){return this._shaderValues.getTexture(mt.NORMALTEXTURE)},set:function(e){e?this._shaderValues.addDefine(mt.SHADERDEFINE_NORMALTEXTURE):this._shaderValues.removeDefine(mt.SHADERDEFINE_NORMALTEXTURE),this._shaderValues.setTexture(mt.NORMALTEXTURE,e)}},{key:"normalTextureScale",get:function(){return this._shaderValues.getNumber(mt.NORMALSCALE)},set:function(e){this._shaderValues.setNumber(mt.NORMALSCALE,e)}},{key:"parallaxTexture",get:function(){return this._shaderValues.getTexture(mt.PARALLAXTEXTURE)},set:function(e){e?this._shaderValues.addDefine(mt.SHADERDEFINE_PARALLAXTEXTURE):this._shaderValues.removeDefine(mt.SHADERDEFINE_PARALLAXTEXTURE),this._shaderValues.setTexture(mt.PARALLAXTEXTURE,e)}},{key:"parallaxTextureScale",get:function(){return this._shaderValues.getNumber(mt.PARALLAXSCALE)},set:function(e){this._shaderValues.setNumber(mt.PARALLAXSCALE,Math.max(.005,Math.min(.08,e)))}},{key:"occlusionTexture",get:function(){return this._shaderValues.getTexture(mt.OCCLUSIONTEXTURE)},set:function(e){e?this._shaderValues.addDefine(mt.SHADERDEFINE_OCCLUSIONTEXTURE):this._shaderValues.removeDefine(mt.SHADERDEFINE_OCCLUSIONTEXTURE),this._shaderValues.setTexture(mt.OCCLUSIONTEXTURE,e)}},{key:"occlusionTextureStrength",get:function(){return this._shaderValues.getNumber(mt.OCCLUSIONSTRENGTH)},set:function(e){this._shaderValues.setNumber(mt.OCCLUSIONSTRENGTH,Math.max(0,Math.min(1,e)))}},{key:"smoothness",get:function(){return this._shaderValues.getNumber(mt.SMOOTHNESS)},set:function(e){this._shaderValues.setNumber(mt.SMOOTHNESS,Math.max(0,Math.min(1,e)))}},{key:"smoothnessTextureScale",get:function(){return this._shaderValues.getNumber(mt.SMOOTHNESSSCALE)},set:function(e){this._shaderValues.setNumber(mt.SMOOTHNESSSCALE,Math.max(0,Math.min(1,e)))}},{key:"enableEmission",get:function(){return this._enableEmission},set:function(e){e?this._shaderValues.addDefine(mt.SHADERDEFINE_EMISSION):this._shaderValues.removeDefine(mt.SHADERDEFINE_EMISSION),this._enableEmission=e}},{key:"emissionColor",get:function(){return this._shaderValues.getVector(mt.EMISSIONCOLOR)},set:function(e){this._shaderValues.setVector(mt.EMISSIONCOLOR,e)}},{key:"emissionTexture",get:function(){return this._shaderValues.getTexture(mt.EMISSIONTEXTURE)},set:function(e){e?this._shaderValues.addDefine(mt.SHADERDEFINE_EMISSIONTEXTURE):this._shaderValues.removeDefine(mt.SHADERDEFINE_EMISSIONTEXTURE),this._shaderValues.setTexture(mt.EMISSIONTEXTURE,e)}},{key:"tilingOffset",get:function(){return this._shaderValues.getVector(mt.TILINGOFFSET)},set:function(e){e?this._shaderValues.setVector(mt.TILINGOFFSET,e):this._shaderValues.getVector(mt.TILINGOFFSET).setValue(1,1,0,0)}},{key:"renderMode",set:function(t){switch(t){case e.PBRRenderMode.Opaque:this.alphaTest=!1,this.renderQueue=Gi.RENDERQUEUE_OPAQUE,this.depthWrite=!0,this.cull=Wi.CULL_BACK,this.blend=Wi.BLEND_DISABLE,this.depthTest=Wi.DEPTHTEST_LESS,this._shaderValues.removeDefine(mt.SHADERDEFINE_TRANSPARENTBLEND);break;case e.PBRRenderMode.Cutout:this.renderQueue=Gi.RENDERQUEUE_ALPHATEST,this.alphaTest=!0,this.depthWrite=!0,this.cull=Wi.CULL_BACK,this.blend=Wi.BLEND_DISABLE,this.depthTest=Wi.DEPTHTEST_LESS,this._shaderValues.removeDefine(mt.SHADERDEFINE_TRANSPARENTBLEND);break;case e.PBRRenderMode.Fade:this.renderQueue=Gi.RENDERQUEUE_TRANSPARENT,this.alphaTest=!1,this.depthWrite=!1,this.cull=Wi.CULL_BACK,this.blend=Wi.BLEND_ENABLE_ALL,this.blendSrc=Wi.BLENDPARAM_SRC_ALPHA,this.blendDst=Wi.BLENDPARAM_ONE_MINUS_SRC_ALPHA,this.depthTest=Wi.DEPTHTEST_LESS,this._shaderValues.removeDefine(mt.SHADERDEFINE_TRANSPARENTBLEND);break;case e.PBRRenderMode.Transparent:this.renderQueue=Gi.RENDERQUEUE_TRANSPARENT,this.alphaTest=!1,this.depthWrite=!1,this.cull=Wi.CULL_BACK,this.blend=Wi.BLEND_ENABLE_ALL,this.blendSrc=Wi.BLENDPARAM_ONE,this.blendDst=Wi.BLENDPARAM_ONE_MINUS_SRC_ALPHA,this.depthTest=Wi.DEPTHTEST_LESS,this._shaderValues.addDefine(mt.SHADERDEFINE_TRANSPARENTBLEND);break;default:throw new Error("PBRMaterial:unknown renderMode value.")}}}],[{key:"__init__",value:function(){mt.SHADERDEFINE_ALBEDOTEXTURE=xn.getDefineByName("ALBEDOTEXTURE"),mt.SHADERDEFINE_NORMALTEXTURE=xn.getDefineByName("NORMALTEXTURE"),mt.SHADERDEFINE_PARALLAXTEXTURE=xn.getDefineByName("PARALLAXTEXTURE"),mt.SHADERDEFINE_OCCLUSIONTEXTURE=xn.getDefineByName("OCCLUSIONTEXTURE"),mt.SHADERDEFINE_EMISSION=xn.getDefineByName("EMISSION"),mt.SHADERDEFINE_EMISSIONTEXTURE=xn.getDefineByName("EMISSIONTEXTURE"),mt.SHADERDEFINE_TRANSPARENTBLEND=xn.getDefineByName("TRANSPARENTBLEND"),mt.SHADERDEFINE_LAYA_PBR_BRDF_HIGH=xn.getDefineByName("LAYA_PBR_BRDF_HIGH"),mt.SHADERDEFINE_LAYA_PBR_BRDF_LOW=xn.getDefineByName("LAYA_PBR_BRDF_LOW")}}]),mt}();or.ALBEDOTEXTURE=xn.propertyNameToID("u_AlbedoTexture"),or.ALBEDOCOLOR=xn.propertyNameToID("u_AlbedoColor"),or.TILINGOFFSET=xn.propertyNameToID("u_TilingOffset"),or.NORMALTEXTURE=xn.propertyNameToID("u_NormalTexture"),or.NORMALSCALE=xn.propertyNameToID("u_NormalScale"),or.SMOOTHNESS=xn.propertyNameToID("u_Smoothness"),or.SMOOTHNESSSCALE=xn.propertyNameToID("u_SmoothnessScale"),or.OCCLUSIONTEXTURE=xn.propertyNameToID("u_OcclusionTexture"),or.OCCLUSIONSTRENGTH=xn.propertyNameToID("u_occlusionStrength"),or.PARALLAXTEXTURE=xn.propertyNameToID("u_ParallaxTexture"),or.PARALLAXSCALE=xn.propertyNameToID("u_ParallaxScale"),or.EMISSIONTEXTURE=xn.propertyNameToID("u_EmissionTexture"),or.EMISSIONCOLOR=xn.propertyNameToID("u_EmissionColor"),or.renderQuality=e.PBRRenderQuality.High;var sr,cr,fr,vr,Ir,Mr='#if defined(GL_FRAGMENT_PRECISION_HIGH)//ifdefined\n\tprecision highp float;\n\tprecision highp int;\n#else\n\tprecision mediump float;\n\tprecision mediump int;\n#endif\n\n#include "Lighting.glsl";\n\nattribute vec4 a_Position;\nattribute vec3 a_Normal;\n\n#ifdef BONE\n\tconst int c_MaxBoneCount = 24;\n\tattribute vec4 a_BoneIndices;\n\tattribute vec4 a_BoneWeights;\n\tuniform mat4 u_Bones[c_MaxBoneCount];\n#endif\n\n#ifdef GPU_INSTANCE\n\tattribute mat4 a_WorldMat;\n#else\n\tuniform mat4 u_WorldMat;\n#endif\n\nuniform mat4 u_ViewProjection;\nuniform vec4 u_ProjectionParams;\n\n//\nvarying vec4 depthNormals;\n\n\nvec4 depthNormalsVertex()\n{\n\tmat4 worldMat;\n\t#ifdef GPU_INSTANCE\n\t\tworldMat = a_WorldMat;\n\t#else\n\t\tworldMat = u_WorldMat;\n\t#endif\n\t\n\t#ifdef BONE\n\t\tmat4 skinTransform;\n\t \t#ifdef SIMPLEBONE\n\t\t\tfloat currentPixelPos;\n\t\t\t#ifdef GPU_INSTANCE\n\t\t\t\tcurrentPixelPos = a_SimpleTextureParams.x+a_SimpleTextureParams.y;\n\t\t\t#else\n\t\t\t\tcurrentPixelPos = u_SimpleAnimatorParams.x+u_SimpleAnimatorParams.y;\n\t\t\t#endif\n\t\t\tfloat offset = 1.0/u_SimpleAnimatorTextureSize;\n\t\t\tskinTransform =  loadMatFromTexture(currentPixelPos,int(a_BoneIndices.x),offset) * a_BoneWeights.x;\n\t\t\tskinTransform += loadMatFromTexture(currentPixelPos,int(a_BoneIndices.y),offset) * a_BoneWeights.y;\n\t\t\tskinTransform += loadMatFromTexture(currentPixelPos,int(a_BoneIndices.z),offset) * a_BoneWeights.z;\n\t\t\tskinTransform += loadMatFromTexture(currentPixelPos,int(a_BoneIndices.w),offset) * a_BoneWeights.w;\n\t\t#else\n\t\t\tskinTransform =  u_Bones[int(a_BoneIndices.x)] * a_BoneWeights.x;\n\t\t\tskinTransform += u_Bones[int(a_BoneIndices.y)] * a_BoneWeights.y;\n\t\t\tskinTransform += u_Bones[int(a_BoneIndices.z)] * a_BoneWeights.z;\n\t\t\tskinTransform += u_Bones[int(a_BoneIndices.w)] * a_BoneWeights.w;\n\t\t#endif\n\t\tworldMat = worldMat * skinTransform;\n\t#endif\n\n\tvec4 positionWS = worldMat * a_Position;\n\n\tmat3 worldInvMat;\n\t#ifdef BONE\n\t\tworldInvMat=INVERSE_MAT(mat3(worldMat*skinTransform));\n\t#else\n\t\tworldInvMat=INVERSE_MAT(mat3(worldMat));\n\t#endif  \n\n\tvec3 normalWS = normalize(a_Normal*worldInvMat);//if no normalize will cause precision problem\n\n\tdepthNormals.xyz = normalWS;\n\tvec4 positionCS = u_ViewProjection * positionWS;\n\tdepthNormals.w = (positionCS.z * 2.0 - positionCS.w)*u_ProjectionParams.w;\n\t\n    return positionCS;\n}\n\nvoid main()\n{\n\tvec4 positionCS =  depthNormalsVertex();\n\tgl_Position=remapGLPositionZ(positionCS);\n}',Ur='#if defined(GL_FRAGMENT_PRECISION_HIGH)//ifdefined\n\tprecision highp float;\n\tprecision highp int;\n#else\n\tprecision mediump float;\n\tprecision mediump int;\n#endif\n#include "DepthNormalUtil.glsl";\n\nvarying vec4 depthNormals;\n\nvoid main()\n{\n\tgl_FragColor=depthNormalsFragment(depthNormals);\n}',Zr=function vt(){_classCallCheck(this,vt),this.textureID=-1},qr=function(e){function At(e,t,n,i,r){var a;return _classCallCheck(this,At),(a=_possibleConstructorReturn(this,_getPrototypeOf(At).call(this)))._stateParamsMap=[],a._uploadMark=-1,a._uploadRenderType=-1,a._vs=e,a._ps=t,a._attributeMap=n,a._uniformMap=i,a._shaderPass=r,a._globaluniformMap={},a._create(),a.lock=!0,a}return _inherits(At,t.Resource),_createClass(At,[{key:"_create",value:function(){var e=t.LayaGL.instance;for(var n in this._program=e.createProgram(),this._vshader=this._createShader(e,this._vs,e.VERTEX_SHADER),this._pshader=this._createShader(e,this._ps,e.FRAGMENT_SHADER),e.attachShader(this._program,this._vshader),e.attachShader(this._program,this._pshader),this._attributeMap)e.bindAttribLocation(this._program,this._attributeMap[n],n);if(e.linkProgram(this._program),!t.Render.isConchApp&&xn.debugMode&&!e.getProgramParameter(this._program,e.LINK_STATUS))throw e.getProgramInfoLog(this._program);var i=[],r=[],a=[],o=[],s=[];this._customUniformParamsMap=[];var l,u,_,c=e.getProgramParameter(this._program,e.ACTIVE_UNIFORMS);for(t.WebGLContext.useProgram(e,this._program),this._curActTexIndex=0,u=0;u<c;u++){var h=e.getActiveUniform(this._program,u),d=h.name;(l=new Zr).location=e.getUniformLocation(this._program,d),d.indexOf("[0]")>0?(l.name=d=d.substr(0,d.length-3),l.isArray=!0):(l.name=d,l.isArray=!1),l.type=h.type,this._addShaderUnifiormFun(l);var f=this._uniformMap[d];if(null!=f)switch(l.dataOffset=xn.propertyNameToID(d),f){case xn.PERIOD_CUSTOM:s.push(l);break;case xn.PERIOD_MATERIAL:o.push(l);break;case xn.PERIOD_SPRITE:a.push(l);break;case xn.PERIOD_CAMERA:r.push(l);break;case xn.PERIOD_SCENE:i.push(l);break;default:throw new Error("Shader3D: period is unkonw.")}else l.dataOffset=xn.propertyNameToID(d),this._globaluniformMap[d]=xn.PERIOD_SCENE,i.push(l)}for(this._sceneUniformParamsMap=t.LayaGL.instance.createCommandEncoder(4*i.length*5+4,64,!0),u=0,_=i.length;u<_;u++)this._sceneUniformParamsMap.addShaderUniform(i[u]);for(this._cameraUniformParamsMap=t.LayaGL.instance.createCommandEncoder(4*r.length*5+4,64,!0),u=0,_=r.length;u<_;u++)this._cameraUniformParamsMap.addShaderUniform(r[u]);for(this._spriteUniformParamsMap=t.LayaGL.instance.createCommandEncoder(4*a.length*5+4,64,!0),u=0,_=a.length;u<_;u++)this._spriteUniformParamsMap.addShaderUniform(a[u]);for(this._materialUniformParamsMap=t.LayaGL.instance.createCommandEncoder(4*o.length*5+4,64,!0),u=0,_=o.length;u<_;u++)this._materialUniformParamsMap.addShaderUniform(o[u]);for(this._customUniformParamsMap.length=s.length,u=0,_=s.length;u<_;u++){var m=s[u];this._customUniformParamsMap[m.dataOffset]=m}var p=this._shaderPass._stateMap;for(var v in p)this._stateParamsMap[p[v]]=xn.propertyNameToID(v)}},{key:"_getRenderState",value:function(e,t){var n=this._stateParamsMap[t];return null==n?null:e[n]}},{key:"_disposeResource",value:function(){t.LayaGL.instance.deleteShader(this._vshader),t.LayaGL.instance.deleteShader(this._pshader),t.LayaGL.instance.deleteProgram(this._program),this._vshader=this._pshader=this._program=null,this._setGPUMemory(0),this._curActTexIndex=0}},{key:"_addShaderUnifiormFun",value:function(e){var n=t.LayaGL.instance;e.caller=this;var i=e.isArray;switch(e.type){case n.BOOL:e.fun=this._uniform1i,e.uploadedValue=new Array(1);break;case n.INT:e.fun=i?this._uniform1iv:this._uniform1i,e.uploadedValue=new Array(1);break;case n.FLOAT:e.fun=i?this._uniform1fv:this._uniform1f,e.uploadedValue=new Array(1);break;case n.FLOAT_VEC2:e.fun=i?this._uniform_vec2v:this._uniform_vec2,e.uploadedValue=new Array(2);break;case n.FLOAT_VEC3:e.fun=i?this._uniform_vec3v:this._uniform_vec3,e.uploadedValue=new Array(3);break;case n.FLOAT_VEC4:e.fun=i?this._uniform_vec4v:this._uniform_vec4,e.uploadedValue=new Array(4);break;case n.FLOAT_MAT2:e.fun=this._uniformMatrix2fv;break;case n.FLOAT_MAT3:e.fun=this._uniformMatrix3fv;break;case n.FLOAT_MAT4:e.fun=i?this._uniformMatrix4fv:this._uniformMatrix4f;break;case n.SAMPLER_2D:case n.SAMPLER_2D_SHADOW:n.uniform1i(e.location,this._curActTexIndex),e.textureID=t.WebGLContext._glTextureIDs[this._curActTexIndex++],e.fun=this._uniform_sampler2D;break;case 35679:n.uniform1i(e.location,this._curActTexIndex),e.textureID=t.WebGLContext._glTextureIDs[this._curActTexIndex++],e.fun=this._uniform_sampler3D;break;case n.SAMPLER_CUBE:n.uniform1i(e.location,this._curActTexIndex),e.textureID=t.WebGLContext._glTextureIDs[this._curActTexIndex++],e.fun=this._uniform_samplerCube;break;default:throw new Error("compile shader err!")}}},{key:"_createShader",value:function(e,t,n){var i=e.createShader(n);if(e.shaderSource(i,t),e.compileShader(i),xn.debugMode&&!e.getShaderParameter(i,e.COMPILE_STATUS))throw e.getShaderInfoLog(i);return i}},{key:"_uniform1f",value:function(e,n){var i=e.uploadedValue;return i[0]!==n?(t.LayaGL.instance.uniform1f(e.location,i[0]=n),1):0}},{key:"_uniform1fv",value:function(e,n){if(n.length<4){var i=e.uploadedValue;return i[0]!==n[0]||i[1]!==n[1]||i[2]!==n[2]||i[3]!==n[3]?(t.LayaGL.instance.uniform1fv(e.location,n),i[0]=n[0],i[1]=n[1],i[2]=n[2],i[3]=n[3],1):0}return t.LayaGL.instance.uniform1fv(e.location,n),1}},{key:"_uniform_vec2",value:function(e,n){var i=e.uploadedValue;return i[0]!==n.x||i[1]!==n.y?(t.LayaGL.instance.uniform2f(e.location,i[0]=n.x,i[1]=n.y),1):0}},{key:"_uniform_vec2v",value:function(e,n){if(n.length<2){var i=e.uploadedValue;return i[0]!==n[0]||i[1]!==n[1]||i[2]!==n[2]||i[3]!==n[3]?(t.LayaGL.instance.uniform2fv(e.location,n),i[0]=n[0],i[1]=n[1],i[2]=n[2],i[3]=n[3],1):0}return t.LayaGL.instance.uniform2fv(e.location,n),1}},{key:"_uniform_vec3",value:function(e,n){var i=e.uploadedValue;return i[0]!==n.x||i[1]!==n.y||i[2]!==n.z?(t.LayaGL.instance.uniform3f(e.location,i[0]=n.x,i[1]=n.y,i[2]=n.z),1):0}},{key:"_uniform_vec3v",value:function(e,n){return t.LayaGL.instance.uniform3fv(e.location,n),1}},{key:"_uniform_vec4",value:function(e,n){var i=e.uploadedValue;return i[0]!==n.x||i[1]!==n.y||i[2]!==n.z||i[3]!==n.w?(t.LayaGL.instance.uniform4f(e.location,i[0]=n.x,i[1]=n.y,i[2]=n.z,i[3]=n.w),1):0}},{key:"_uniform_vec4v",value:function(e,n){return t.LayaGL.instance.uniform4fv(e.location,n),1}},{key:"_uniformMatrix2fv",value:function(e,n){return t.LayaGL.instance.uniformMatrix2fv(e.location,!1,n),1}},{key:"_uniformMatrix3fv",value:function(e,n){return t.LayaGL.instance.uniformMatrix3fv(e.location,!1,n),1}},{key:"_uniformMatrix4f",value:function(e,n){var i=n.elements;return t.LayaGL.instance.uniformMatrix4fv(e.location,!1,i),1}},{key:"_uniformMatrix4fv",value:function(e,n){return t.LayaGL.instance.uniformMatrix4fv(e.location,!1,n),1}},{key:"_uniform1i",value:function(e,n){var i=e.uploadedValue;return i[0]!==n?(t.LayaGL.instance.uniform1i(e.location,i[0]=n),1):0}},{key:"_uniform1iv",value:function(e,n){return t.LayaGL.instance.uniform1iv(e.location,n),1}},{key:"_uniform_ivec2",value:function(e,n){var i=e.uploadedValue;return i[0]!==n[0]||i[1]!==n[1]?(t.LayaGL.instance.uniform2i(e.location,i[0]=n[0],i[1]=n[1]),1):0}},{key:"_uniform_ivec2v",value:function(e,n){return t.LayaGL.instance.uniform2iv(e.location,n),1}},{key:"_uniform_vec3i",value:function(e,n){var i=e.uploadedValue;return i[0]!==n[0]||i[1]!==n[1]||i[2]!==n[2]?(t.LayaGL.instance.uniform3i(e.location,i[0]=n[0],i[1]=n[1],i[2]=n[2]),1):0}},{key:"_uniform_vec3vi",value:function(e,n){return t.LayaGL.instance.uniform3iv(e.location,n),1}},{key:"_uniform_vec4i",value:function(e,n){var i=e.uploadedValue;return i[0]!==n[0]||i[1]!==n[1]||i[2]!==n[2]||i[3]!==n[3]?(t.LayaGL.instance.uniform4i(e.location,i[0]=n[0],i[1]=n[1],i[2]=n[2],i[3]=n[3]),1):0}},{key:"_uniform_vec4vi",value:function(e,n){return t.LayaGL.instance.uniform4iv(e.location,n),1}},{key:"_uniform_sampler2D",value:function(e,n){var i=n._getSource()||n.defaulteTexture._getSource(),r=t.LayaGL.instance;return t.WebGLContext.activeTexture(r,e.textureID),t.WebGLContext.bindTexture(r,r.TEXTURE_2D,i),0}},{key:"_uniform_sampler3D",value:function(e,n){var i=n._getSource()||n.defaulteTexture._getSource(),r=t.LayaGL.instance;return t.WebGLContext.activeTexture(r,e.textureID),t.WebGLContext.bindTexture(r,WebGL2RenderingContext.TEXTURE_3D,i),0}},{key:"_uniform_samplerCube",value:function(e,n){var i=n._getSource()||n.defaulteTexture._getSource(),r=t.LayaGL.instance;return t.WebGLContext.activeTexture(r,e.textureID),t.WebGLContext.bindTexture(r,r.TEXTURE_CUBE_MAP,i),0}},{key:"bind",value:function(){return t.WebGLContext.useProgram(t.LayaGL.instance,this._program)}},{key:"uploadUniforms",value:function(e,n,i){t.Stat.shaderCall+=t.LayaGLRunner.uploadShaderUniforms(t.LayaGL.instance,e,n,i)}},{key:"uploadRenderStateBlendDepth",value:function(e){var n=t.LayaGL.instance,i=this._shaderPass.renderState,r=e.getData(),a=this._getRenderState(r,xn.RENDER_STATE_DEPTH_WRITE),o=this._getRenderState(r,xn.RENDER_STATE_DEPTH_TEST),s=this._getRenderState(r,xn.RENDER_STATE_BLEND);switch(null==a&&(a=i.depthWrite),null==o&&(o=i.depthTest),null==s&&(s=i.blend),t.WebGLContext.setDepthMask(n,a),o===Wi.DEPTHTEST_OFF?t.WebGLContext.setDepthTest(n,!1):(t.WebGLContext.setDepthTest(n,!0),t.WebGLContext.setDepthFunc(n,o)),s){case Wi.BLEND_DISABLE:t.WebGLContext.setBlend(n,!1);break;case Wi.BLEND_ENABLE_ALL:var l=this._getRenderState(r,xn.RENDER_STATE_BLEND_EQUATION),u=this._getRenderState(r,xn.RENDER_STATE_BLEND_SRC),_=this._getRenderState(r,xn.RENDER_STATE_BLEND_DST);null==l&&(l=i.blendEquation),null==u&&(u=i.srcBlend),null==_&&(_=i.dstBlend),t.WebGLContext.setBlend(n,!0),t.WebGLContext.setBlendEquation(n,l),t.WebGLContext.setBlendFunc(n,u,_);break;case Wi.BLEND_ENABLE_SEPERATE:var c=this._getRenderState(r,xn.RENDER_STATE_BLEND_EQUATION_RGB),h=this._getRenderState(r,xn.RENDER_STATE_BLEND_EQUATION_ALPHA),d=this._getRenderState(r,xn.RENDER_STATE_BLEND_SRC_RGB),f=this._getRenderState(r,xn.RENDER_STATE_BLEND_DST_RGB),m=this._getRenderState(r,xn.RENDER_STATE_BLEND_SRC_ALPHA),p=this._getRenderState(r,xn.RENDER_STATE_BLEND_DST_ALPHA);null==c&&(c=i.blendEquationRGB),null==h&&(h=i.blendEquationAlpha),null==d&&(d=i.srcBlendRGB),null==f&&(f=i.dstBlendRGB),null==m&&(m=i.srcBlendAlpha),null==p&&(p=i.dstBlendAlpha),t.WebGLContext.setBlend(n,!0),t.WebGLContext.setBlendEquationSeparate(n,c,h),t.WebGLContext.setBlendFuncSeperate(n,d,f,m,p)}}},{key:"uploadRenderStateFrontFace",value:function(e,n,i){var r,a=t.LayaGL.instance,o=this._shaderPass.renderState,s=e.getData(),l=this._getRenderState(s,xn.RENDER_STATE_CULL);switch(null==l&&(l=o.cull),l){case Wi.CULL_NONE:t.WebGLContext.setCullFace(a,!1);break;case Wi.CULL_FRONT:t.WebGLContext.setCullFace(a,!0),r=n?i?a.CCW:a.CW:i?a.CW:a.CCW,t.WebGLContext.setFrontFace(a,r);break;case Wi.CULL_BACK:t.WebGLContext.setCullFace(a,!0),r=n?i?a.CW:a.CCW:i?a.CCW:a.CW,t.WebGLContext.setFrontFace(a,r)}}},{key:"uploadCustomUniform",value:function(e,n){t.Stat.shaderCall+=t.LayaGLRunner.uploadCustomUniform(t.LayaGL.instance,this._customUniformParamsMap,e,n)}},{key:"_uniformMatrix2fvForNative",value:function(e,n){return t.LayaGL.instance.uniformMatrix2fvEx(e.location,!1,n),1}},{key:"_uniformMatrix3fvForNative",value:function(e,n){return t.LayaGL.instance.uniformMatrix3fvEx(e.location,!1,n),1}},{key:"_uniformMatrix4fvForNative",value:function(e,n){return t.LayaGL.instance.uniformMatrix4fvEx(e.location,!1,n),1}}]),At}(),ea=function(e){function xt(){return _classCallCheck(this,xt),_possibleConstructorReturn(this,_getPrototypeOf(xt).call(this))}return _inherits(xt,Ye),_createClass(xt,[{key:"add",value:function(e){if(-1!==e._getIndexInList())throw"SimpleSingletonList:"+e+" has  in  SingletonList.";this._add(e),e._setIndexInList(this.length++)}},{key:"remove",value:function(e){var t=e._getIndexInList();if(this.length--,t!==this.length){var n=this.elements[this.length];this.elements[t]=n,n._setIndexInList(t)}e._setIndexInList(-1)}},{key:"clear",value:function(){for(var e=this.elements,t=0,n=this.length;t<n;t++)e[t]._setIndexInList(-1);this.length=0}}]),xt}(),ta=function(){function It(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1;_classCallCheck(this,It),this.r=e,this.g=t,this.b=n,this.a=i}return _createClass(It,[{key:"toLinear",value:function(e){e.r=It.gammaToLinearSpace(this.r),e.g=It.gammaToLinearSpace(this.g),e.b=It.gammaToLinearSpace(this.b)}},{key:"toGamma",value:function(e){e.r=It.linearToGammaSpace(this.r),e.g=It.linearToGammaSpace(this.g),e.b=It.linearToGammaSpace(this.b)}},{key:"cloneTo",value:function(e){var t=e;t.r=this.r,t.g=this.g,t.b=this.b,t.a=this.a}},{key:"clone",value:function(){var e=new It;return this.cloneTo(e),e}},{key:"forNativeElement",value:function(){}}],[{key:"gammaToLinearSpace",value:function(e){return e<=.04045?e/12.92:e<1?Math.pow((e+.055)/1.055,2.4):Math.pow(e,2.4)}},{key:"linearToGammaSpace",value:function(e){return e<=0?0:e<=.0031308?12.92*e:e<=1?1.055*Math.pow(e,.41666)-.055:Math.pow(e,.41666)}}]),It}();ta.RED=new ta(1,0,0,1),ta.GREEN=new ta(0,1,0,1),ta.BLUE=new ta(0,0,1,1),ta.CYAN=new ta(0,1,1,1),ta.YELLOW=new ta(1,.92,.016,1),ta.MAGENTA=new ta(1,0,1,1),ta.GRAY=new ta(.5,.5,.5,1),ta.WHITE=new ta(1,1,1,1),ta.BLACK=new ta(0,0,0,1);var na=function Dt(){_classCallCheck(this,Dt)},ia=function Ct(){_classCallCheck(this,Ct)},ra=function(){function Mt(){_classCallCheck(this,Mt)}return _createClass(Mt,null,[{key:"__init__",value:function(){}},{key:"_drawTraversalCullingBound",value:function(e,t){for(var n=e.elements,i=0,r=e.length;i<r;i++){var a=Mt._tempColor0;a.r=0,a.g=1,a.b=0,a.a=1,gt._drawBound(t,n[i].bounds._getBoundBox(),a)}}},{key:"_traversalCulling",value:function(e,n,i,r,a,o,s){for(var l=r.elements,u=e.boundFrustum,_=e.position,c=e.cullingMask,h=t.Stat.loopCount,d=0,f=r.length;d<f;d++){var m=l[d];if((s?m._castShadow&&m._enable:0!=(Math.pow(2,m._owner._layer)&c)&&m._enable)&&(t.Stat.frustumCulling++,!e.useOcclusionCulling||m._needRender(u,i))){m._renderMark=h,m._distanceForSort=D.distance(m.bounds.getCenter(),_);for(var p=m._renderElements,v=0,E=p.length;v<E;v++)p[v]._update(n,i,a,o)}}}},{key:"renderObjectCulling",value:function(e,t,n,i,r,a){var o=t._opaqueQueue,s=t._transparentQueue,l=t._renders;t._clearRenderQueue();var u=t._octree;if(u&&(u.updateMotionObjects(),u.shrinkRootIfPossible(),u.getCollidingWithFrustum(e,n,i,r,a)),Mt._traversalCulling(e,t,n,l,i,r,a),Mt.debugFrustumCulling){var _=t._debugTool;_.clear(),u&&(u.drawAllBounds(_),u.drawAllObjects(_)),Mt._drawTraversalCullingBound(l,_)}var c=o.elements.length;c>0&&o._quickSort(0,c-1),(c=s.elements.length)>0&&s._quickSort(0,c-1)}},{key:"cullingShadow",value:function(e,n,i){var r=n._renders;n._clearRenderQueue();for(var a=n._opaqueQueue,o=e.position,s=e.cullPlaneCount,l=e.cullPlanes,u=r.elements,_=t.Stat.loopCount,c=0,h=r.length;c<h;c++){var d=u[c];if(d._castShadow&&d._enable){t.Stat.frustumCulling++;for(var f=d.bounds,m=f.getMin(),p=f.getMax(),v=m.x,E=m.y,T=m.z,g=p.x,y=p.y,S=p.z,R=!0,C=0;C<s;C++){var A=l[C],I=A.normal;if(A.distance+I.x*(I.x<0?v:g)+I.y*(I.y<0?E:y)+I.z*(I.z<0?T:S)<0){R=!1;break}}if(R){d._renderMark=_,d._distanceForSort=D.distance(f.getCenter(),o);for(var x=d._renderElements,M=(C=0,x.length);C<M;C++)x[C]._update(n,i,null,null)}}}return a.elements.length>0}},{key:"cullingSpotShadow",value:function(e,n,i){var r=n._renders;n._clearRenderQueue();for(var a=n._opaqueQueue,o=r.elements,s=t.Stat.loopCount,l=0,u=r.length;l<u;l++){var _=o[l];if(_._castShadow&&_._enable&&_._needRender(e.boundFrustum,i)){var c=_.bounds;_._renderMark=s,_._distanceForSort=D.distance(c.getCenter(),e.position);for(var h=_._renderElements,d=0,f=h.length;d<f;d++)h[d]._update(n,i,null,null)}}return a.elements.length>0}},{key:"renderObjectCullingNative",value:function(e,n,i,r,a,o){var s,l,u,_=n._opaqueQueue,c=n._transparentQueue;n._clearRenderQueue();var h=r.length,d=r.elements;for(s=0;s<h;s++)d[s].bounds,d[s]._updateForNative&&d[s]._updateForNative(i);Mt.cullingNative(e._boundFrustumBuffer,Mt._cullingBuffer,n._cullingBufferIndices,h,n._cullingBufferResult);var f=t.Stat.loopCount,m=i.camera._transform.position;for(s=0;s<h;s++){var p=d[s];if(!e.useOcclusionCulling||e._isLayerVisible(p._owner._layer)&&p._enable&&n._cullingBufferResult[s]){p._renderMark=f,p._distanceForSort=D.distance(p.bounds.getCenter(),m);var v=p._renderElements;for(l=0,u=v.length;l<u;l++)v[l]._update(n,i,a,o)}}var E=_.elements.length;E>0&&_._quickSort(0,E-1),(E=c.elements.length)>0&&c._quickSort(0,E-1)}},{key:"cullingNative",value:function(e,n,i,r,a){return t.LayaGL.instance.culling(e,n,i,r,a)}}]),Mt}();ra._tempColor0=new ta,ra._cameraCullInfo=new na,ra._shadowCullInfo=new ia,ra.debugFrustumCulling=!1;var aa=function(){function yt(){_classCallCheck(this,yt),this._coefficients=new Float32Array(27)}return _createClass(yt,[{key:"getCoefficient",value:function(e,t){return this._coefficients[9*e+t]}},{key:"setCoefficient",value:function(e,t,n){this._coefficients[9*e+t]=n}},{key:"setCoefficients",value:function(e,t,n,i,r,a,o,s,l,u){var _=9*e;this._coefficients[_]=t,this._coefficients[++_]=n,this._coefficients[++_]=i,this._coefficients[++_]=r,this._coefficients[++_]=a,this._coefficients[++_]=o,this._coefficients[++_]=s,this._coefficients[++_]=l,this._coefficients[++_]=u}},{key:"cloneTo",value:function(e){if(this!==e)for(var t=this._coefficients,n=e._coefficients,i=0;i<27;i++)n[i]=t[i]}}]),yt}();aa._default=new aa;var oa=function Lt(){_classCallCheck(this,Lt),this._pressedSprite=null,this._pressedLoopCount=-1,this.sprite=null,this.mousePositionX=0,this.mousePositionY=0},sa=function(){function Ot(){_classCallCheck(this,Ot),this._indexInList=-1,this._identifier=-1,this._position=new r}return _createClass(Ot,[{key:"_getIndexInList",value:function(){return this._indexInList}},{key:"_setIndexInList",value:function(e){this._indexInList=e}},{key:"identifier",get:function(){return this._identifier}},{key:"position",get:function(){return this._position}}]),Ot}(),la=function(){function Nt(){var e=this;_classCallCheck(this,Nt),this._eventList=[],this._mouseTouch=new oa,this._touchPool=[],this._touches=new ea,this._multiTouchEnabled=!0,this._pushEventList=function(t){t.cancelable&&t.preventDefault(),e._eventList.push(t)}.bind(this)}return _createClass(Nt,[{key:"__init__",value:function(e,t){this._scene=t,e.oncontextmenu=function(e){return!1}}},{key:"_onCanvasEvent",value:function(e){e.addEventListener("mousedown",this._pushEventList),e.addEventListener("mouseup",this._pushEventList,!0),e.addEventListener("mousemove",this._pushEventList,!0),e.addEventListener("touchstart",this._pushEventList),e.addEventListener("touchend",this._pushEventList,!0),e.addEventListener("touchmove",this._pushEventList,!0),e.addEventListener("touchcancel",this._pushEventList,!0)}},{key:"_offCanvasEvent",value:function(e){e.removeEventListener("mousedown",this._pushEventList),e.removeEventListener("mouseup",this._pushEventList,!0),e.removeEventListener("mousemove",this._pushEventList,!0),e.removeEventListener("touchstart",this._pushEventList),e.removeEventListener("touchend",this._pushEventList,!0),e.removeEventListener("touchmove",this._pushEventList,!0),e.removeEventListener("touchcancel",this._pushEventList,!0),this._eventList.length=0,this._touches.clear()}},{key:"touchCount",value:function(){return this._touches.length}},{key:"_getTouch",value:function(e,t){var n=this._touchPool[e];return 0==t&&n&&-1!=n._getIndexInList()||1==t&&n&&-1==n._getIndexInList()?null:(n||(n=new sa,this._touchPool[e]=n,n._identifier=e),n)}},{key:"_mouseTouchDown",value:function(){var e=this._mouseTouch,n=e.sprite;if(e._pressedSprite=n,e._pressedLoopCount=t.Stat.loopCount,n){var i=n._scripts;if(i)for(var r=0,a=i.length;r<a;r++)i[r].onMouseDown()}}},{key:"_mouseTouchUp",value:function(){var e,t,n=this._mouseTouch,i=n._pressedSprite;n._pressedSprite=null,n._pressedLoopCount=-1;var r=n.sprite;if(r&&r===i){var a=r._scripts;if(a)for(e=0,t=a.length;e<t;e++)a[e].onMouseClick()}if(i){var o=i._scripts;if(o)for(e=0,t=o.length;e<t;e++)o[e].onMouseUp()}}},{key:"_mouseTouchRayCast",value:function(t){var n=Nt._tempHitResult0,i=Nt._tempVector20,r=Nt._tempRay0;n.succeeded=!1;var a=this._mouseTouch.mousePositionX,o=this._mouseTouch.mousePositionY;i.x=a,i.y=o;for(var s=t.length-1;s>=0;s--){var l=t[s],u=l.viewport;if(i.x>=u.x&&i.y>=u.y&&i.x<=u.width&&i.y<=u.height&&(l.viewportPointToRay(i,r),this._scene._physicsSimulation.rayCast(r,n)||l.clearFlag===e.CameraClearFlags.SolidColor||l.clearFlag===e.CameraClearFlags.Sky))break}var _=this._mouseTouch,c=_.sprite;if(n.succeeded){var h=n.collider.owner;_.sprite=h;var d=h._scripts;if(c!==h&&d)for(var f=0,m=d.length;f<m;f++)d[f].onMouseEnter()}else _.sprite=null;if(c&&c!==h){var p=c._scripts;if(p)for(f=0,m=p.length;f<m;f++)p[f].onMouseOut()}}},{key:"_changeTouches",value:function(e,n){for(var i=0,r=0,a=this._touches.length,o=0,s=e.length;o<s;o++){var l=e[o],u=l.identifier;if(this._multiTouchEnabled||0===this._touches.length||0!=n){var _=this._getTouch(u,n);if(1!=n||_){var c=this._touchPool[u]._position,h=Nt._tempPoint;h.setTo(l.pageX,l.pageY),t.ILaya.stage._canvasTransform.invertTransformPoint(h);var d=h.x,f=h.y;switch(n){case 0:_&&this._touches.add(_),i+=d,r+=f;break;case 1:_&&this._touches.remove(_),i-=d,r-=f;break;case 2:i=d-c.x,r=f-c.y}c.x=d,c.y=f}}}var m=this._touches.length;0===m?(this._mouseTouch.mousePositionX=0,this._mouseTouch.mousePositionY=0):(this._mouseTouch.mousePositionX=(this._mouseTouch.mousePositionX*a+i)/m,this._mouseTouch.mousePositionY=(this._mouseTouch.mousePositionY*a+r)/m)}},{key:"_update",value:function(){var e,n,i,r,a=Ct._enablePhysics&&!Et.disableSimulation;n=this._eventList.length;var o=this._scene._cameraPool;if(n>0){var s=!1;for(e=0;e<n;e++){var l=this._eventList[e];switch(l.type){case"mousedown":a&&this._mouseTouchDown();break;case"mouseup":a&&this._mouseTouchUp();break;case"mousemove":var u=Nt._tempPoint;u.setTo(l.pageX,l.pageY),t.ILaya.stage._canvasTransform.invertTransformPoint(u),this._mouseTouch.mousePositionX=u.x,this._mouseTouch.mousePositionY=u.y,a&&(s=!0);break;case"touchstart":var _=this._touches.length;this._changeTouches(l.changedTouches,0),a&&(!It._config.isUseCannonPhysicsEngine&&this._mouseTouchRayCast(o),0===_&&this._mouseTouchDown());break;case"touchend":case"touchcancel":this._changeTouches(l.changedTouches,1),a&&0===this._touches.length&&this._mouseTouchUp();break;case"touchmove":this._changeTouches(l.changedTouches,2),a&&(s=!0);break;default:throw"Input3D:unkonwn event type."}}s&&!It._config.isUseCannonPhysicsEngine&&this._mouseTouchRayCast(o),this._eventList.length=0}if(a){var c=this._mouseTouch,h=c._pressedSprite;if(h&&t.Stat.loopCount>c._pressedLoopCount){var d=h._scripts;if(d)for(i=0,r=d.length;i<r;i++)d[i].onMouseDrag()}var f=c.sprite;if(f){var m=f._scripts;if(m)for(i=0,r=m.length;i<r;i++)m[i].onMouseOver()}}}},{key:"getTouch",value:function(e){return e<this._touches.length?this._touches.elements[e]:null}},{key:"multiTouchEnabled",get:function(){return this._multiTouchEnabled},set:function(e){this._multiTouchEnabled=e}}]),Nt}();la._tempPoint=new t.Point,la._tempVector20=new r,la._tempRay0=new Bn(new D,new D),la._tempHitResult0=new ft;var ua=function Pt(){_classCallCheck(this,Pt),this.flags=0,this.maxSubSteps=1,this.fixedTimeStep=1/60},_a=function(){function bt(e,t){_classCallCheck(this,bt),this._position=e,this._textureCoordinate0=t}return _createClass(bt,[{key:"position",get:function(){return this._position}},{key:"textureCoordinate0",get:function(){return this._textureCoordinate0}},{key:"vertexDeclaration",get:function(){return bt._vertexDeclaration}}],[{key:"__init__",value:function(){bt._vertexDeclaration=new Tn(20,[new gn(0,vn.Vector3,Xn.MESH_POSITION0),new gn(12,vn.Vector2,Xn.MESH_TEXTURECOORDINATE0)])}},{key:"vertexDeclaration",get:function(){return bt._vertexDeclaration}}]),bt}(),ca=function(n){function wt(){var n,i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:48,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:48;_classCallCheck(this,wt),n=_possibleConstructorReturn(this,_getPrototypeOf(wt).call(this));var a=t.LayaGL.instance;n._stacks=i,n._slices=r;for(var o=_a.vertexDeclaration,s=o.vertexStride/4,l=(n._stacks+1)*(n._slices+1),u=3*n._stacks*(n._slices+1)*2,_=new Float32Array(l*s),c=new Uint16Array(u),h=Math.PI/n._stacks,d=2*Math.PI/n._slices,f=0,m=0,p=0,v=0;v<n._stacks+1;v++)for(var E=Math.sin(v*h),T=Math.cos(v*h),g=0;g<n._slices+1;g++){var y=E*Math.sin(g*d),S=E*Math.cos(g*d);_[m+0]=y*wt._radius,_[m+1]=T*wt._radius,_[m+2]=S*wt._radius,_[m+3]=-g/n._slices+.75,_[m+4]=v/n._stacks,m+=s,v!=n._stacks-1&&(c[p++]=f+1,c[p++]=f,c[p++]=f+(n._slices+1),c[p++]=f+(n._slices+1),c[p++]=f,c[p++]=f+n._slices,f++)}n._vertexBuffer=new pn(4*_.length,a.STATIC_DRAW,!1),n._vertexBuffer.vertexDeclaration=o,n._indexBuffer=new Wn(e.IndexFormat.UInt16,c.length,a.STATIC_DRAW,!1),n._vertexBuffer.setData(_.buffer),n._indexBuffer.setData(c);var R=new yn;return R.bind(),R.applyVertexBuffer(n._vertexBuffer),R.applyIndexBuffer(n._indexBuffer),R.unBind(),n._bufferState=R,n}return _inherits(wt,Yn),_createClass(wt,[{key:"_render",value:function(e){var n=t.LayaGL.instance,i=this._indexBuffer.indexCount;n.drawElements(n.TRIANGLES,i,n.UNSIGNED_SHORT,0),t.Stat.trianglesFaces+=i/3,t.Stat.renderBatches++}},{key:"stacks",get:function(){return this._stacks}},{key:"slices",get:function(){return this._slices}}],[{key:"__init__",value:function(){wt.instance=new wt}}]),wt}();ca._radius=1,(sr=e.TextureCubeFace||(e.TextureCubeFace={}))[sr.PositiveX=0]="PositiveX",sr[sr.NegativeX=1]="NegativeX",sr[sr.PositiveY=2]="PositiveY",sr[sr.NegativeY=3]="NegativeY",sr[sr.PositiveZ=4]="PositiveZ",sr[sr.NegativeZ=5]="NegativeZ";var ha=function(n){function Vt(e){var n,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:t.TextureFormat.R8G8B8,r=arguments.length>2&&void 0!==arguments[2]&&arguments[2];_classCallCheck(this,Vt),(n=_possibleConstructorReturn(this,_getPrototypeOf(Vt).call(this,i,r)))._glTextureType=t.LayaGL.instance.TEXTURE_CUBE_MAP,n._width=e,n._height=e;var a=t.LayaGL.instance;if(n._setWarpMode(a.TEXTURE_WRAP_S,n._wrapModeU),n._setWarpMode(a.TEXTURE_WRAP_T,n._wrapModeV),n._setFilterMode(n._filterMode),n._setAnisotropy(n._anisoLevel),n._mipmap){n._mipmapCount=Math.ceil(Math.log2(e))+1;for(var o=0;o<n._mipmapCount;o++)n._setPixels([],o,Math.max(e>>o,1),Math.max(e>>o,1));n._setGPUMemory(e*e*4*(1+1/3)*6)}else n._mipmapCount=1,n._setGPUMemory(e*e*4*6);return n}return _inherits(Vt,t.BaseTexture),_createClass(Vt,[{key:"_setPixels",value:function(e,n,i,r){var a=t.LayaGL.instance,o=this._getGLFormat();t.WebGLContext.bindTexture(a,this._glTextureType,this._glTexture),this.format===t.TextureFormat.R8G8B8?(a.pixelStorei(a.UNPACK_ALIGNMENT,1),a.texImage2D(a.TEXTURE_CUBE_MAP_POSITIVE_Z,n,o,i,r,0,o,a.UNSIGNED_BYTE,e[0]),a.texImage2D(a.TEXTURE_CUBE_MAP_NEGATIVE_Z,n,o,i,r,0,o,a.UNSIGNED_BYTE,e[1]),a.texImage2D(a.TEXTURE_CUBE_MAP_POSITIVE_X,n,o,i,r,0,o,a.UNSIGNED_BYTE,e[2]),a.texImage2D(a.TEXTURE_CUBE_MAP_NEGATIVE_X,n,o,i,r,0,o,a.UNSIGNED_BYTE,e[3]),a.texImage2D(a.TEXTURE_CUBE_MAP_POSITIVE_Y,n,o,i,r,0,o,a.UNSIGNED_BYTE,e[4]),a.texImage2D(a.TEXTURE_CUBE_MAP_NEGATIVE_Y,n,o,i,r,0,o,a.UNSIGNED_BYTE,e[5]),a.pixelStorei(a.UNPACK_ALIGNMENT,4)):(a.texImage2D(a.TEXTURE_CUBE_MAP_POSITIVE_Z,n,o,i,r,0,o,a.UNSIGNED_BYTE,e[0]),a.texImage2D(a.TEXTURE_CUBE_MAP_NEGATIVE_Z,n,o,i,r,0,o,a.UNSIGNED_BYTE,e[1]),a.texImage2D(a.TEXTURE_CUBE_MAP_POSITIVE_X,n,o,i,r,0,o,a.UNSIGNED_BYTE,e[2]),a.texImage2D(a.TEXTURE_CUBE_MAP_NEGATIVE_X,n,o,i,r,0,o,a.UNSIGNED_BYTE,e[3]),a.texImage2D(a.TEXTURE_CUBE_MAP_POSITIVE_Y,n,o,i,r,0,o,a.UNSIGNED_BYTE,e[4]),a.texImage2D(a.TEXTURE_CUBE_MAP_NEGATIVE_Y,n,o,i,r,0,o,a.UNSIGNED_BYTE,e[5]))}},{key:"setSixSideImageSources",value:function(e){for(var n,i,r=arguments.length>1&&void 0!==arguments[1]&&arguments[1],a=0;a<6;a++){var o=e[a];if(!o)return void console.log("TextureCube: image Source can't be null.");var s=o.width,l=o.height;if(a>0&&n!==s)return void console.log("TextureCube: each side image's width and height must same.");if((n=s)!==(i=l))return void console.log("TextureCube: each side image's width and height must same.")}this._width=n,this._height=i;var u=t.LayaGL.instance;t.WebGLContext.bindTexture(u,this._glTextureType,this._glTexture);var _=this._getGLFormat();if(t.Render.isConchApp){if(1==r)for(var c=0;c<6;c++)e[c].setPremultiplyAlpha(r);u.texImage2D(u.TEXTURE_CUBE_MAP_POSITIVE_Z,0,u.RGBA,u.RGBA,u.UNSIGNED_BYTE,e[0]),u.texImage2D(u.TEXTURE_CUBE_MAP_NEGATIVE_Z,0,u.RGBA,u.RGBA,u.UNSIGNED_BYTE,e[1]),u.texImage2D(u.TEXTURE_CUBE_MAP_POSITIVE_X,0,u.RGBA,u.RGBA,u.UNSIGNED_BYTE,e[2]),u.texImage2D(u.TEXTURE_CUBE_MAP_NEGATIVE_X,0,u.RGBA,u.RGBA,u.UNSIGNED_BYTE,e[3]),u.texImage2D(u.TEXTURE_CUBE_MAP_POSITIVE_Y,0,u.RGBA,u.RGBA,u.UNSIGNED_BYTE,e[4]),u.texImage2D(u.TEXTURE_CUBE_MAP_NEGATIVE_Y,0,u.RGBA,u.RGBA,u.UNSIGNED_BYTE,e[5])}else r&&u.pixelStorei(u.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),u.texImage2D(u.TEXTURE_CUBE_MAP_POSITIVE_Z,0,_,_,u.UNSIGNED_BYTE,e[0]),u.texImage2D(u.TEXTURE_CUBE_MAP_NEGATIVE_Z,0,_,_,u.UNSIGNED_BYTE,e[1]),u.texImage2D(u.TEXTURE_CUBE_MAP_POSITIVE_X,0,_,_,u.UNSIGNED_BYTE,e[2]),u.texImage2D(u.TEXTURE_CUBE_MAP_NEGATIVE_X,0,_,_,u.UNSIGNED_BYTE,e[3]),u.texImage2D(u.TEXTURE_CUBE_MAP_POSITIVE_Y,0,_,_,u.UNSIGNED_BYTE,e[4]),u.texImage2D(u.TEXTURE_CUBE_MAP_NEGATIVE_Y,0,_,_,u.UNSIGNED_BYTE,e[5]),r&&u.pixelStorei(u.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1);this._mipmap&&this._isPot(n)&&this._isPot(i)?(u.generateMipmap(this._glTextureType),this._setGPUMemory(n*i*4*(1+1/3)*6)):this._setGPUMemory(n*i*4*6),this._setWarpMode(u.TEXTURE_WRAP_S,this._wrapModeU),this._setWarpMode(u.TEXTURE_WRAP_T,this._wrapModeV),this._setFilterMode(this._filterMode),this._readyed=!0,this._activeResource()}},{key:"setSixSidePixels",value:function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;if(!e)throw new Error("TextureCube:pixels can't be null.");var i=Math.max(this._width>>n,1),r=Math.max(this._height>>n,1),a=i*r*this._getFormatByteCount();if(e[0].length<a)throw"TextureCube:pixels length should at least "+a+".";if(this._setPixels(e,n,i,r),0===n){var o=t.LayaGL.instance;this._setWarpMode(o.TEXTURE_WRAP_S,this._wrapModeU),this._setWarpMode(o.TEXTURE_WRAP_T,this._wrapModeV)}this._readyed=!0,this._activeResource()}},{key:"setImageSource",value:function(n,i){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,a=this._width,o=this._height;if(!i||a===i.width&&o===i.height){var s=t.LayaGL.instance;t.WebGLContext.bindTexture(s,this._glTextureType,this._glTexture);var l=this._getGLFormat();switch(n){case e.TextureCubeFace.NegativeX:s.texImage2D(s.TEXTURE_CUBE_MAP_NEGATIVE_X,r,l,l,s.UNSIGNED_BYTE,i);break;case e.TextureCubeFace.PositiveX:s.texImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X,r,l,l,s.UNSIGNED_BYTE,i);break;case e.TextureCubeFace.NegativeY:s.texImage2D(s.TEXTURE_CUBE_MAP_NEGATIVE_Y,r,l,l,s.UNSIGNED_BYTE,i);break;case e.TextureCubeFace.PositiveY:s.texImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_Y,r,l,l,s.UNSIGNED_BYTE,i);break;case e.TextureCubeFace.NegativeZ:s.texImage2D(s.TEXTURE_CUBE_MAP_NEGATIVE_Z,r,l,l,s.UNSIGNED_BYTE,i);break;case e.TextureCubeFace.PositiveZ:s.texImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_Z,r,l,l,s.UNSIGNED_BYTE,i)}this._mipmap&&this._isPot(a)&&this._isPot(o)?(s.generateMipmap(this._glTextureType),this._setGPUMemory(a*o*4*(1+1/3)*6)):this._setGPUMemory(a*o*4*6),this._setWarpMode(s.TEXTURE_WRAP_S,this._wrapModeU),this._setWarpMode(s.TEXTURE_WRAP_T,this._wrapModeV),this._setFilterMode(this._filterMode),this._readyed=!0}else console.log("TextureCube: imageSource's width and height must same.")}},{key:"defaulteTexture",get:function(){return Vt.grayTexture}}],[{key:"__init__",value:function(){var e=new Vt(1,t.TextureFormat.R8G8B8,!1),n=new Vt(1,t.TextureFormat.R8G8B8,!1),i=new Uint8Array(3);i[0]=0,i[1]=0,i[2]=0,e.setSixSidePixels([i,i,i,i,i,i]),e.lock=!0,i[0]=128,i[1]=128,i[2]=128,n.setSixSidePixels([i,i,i,i,i,i]),n.lock=!0,Vt._grayTexture=n,Vt._blackTexture=e}},{key:"_parse",value:function(e){arguments.length>1&&void 0!==arguments[1]&&arguments[1];var t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,n=t?new Vt(0,t[0],t[1]):new Vt(0);return n.setSixSideImageSources(e),n}},{key:"_parseBin",value:function(e){arguments.length>1&&void 0!==arguments[1]&&arguments[1];var t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,n=t?new Vt(0,t[0],t[1]):new Vt(0);return n.setSixSideImageSources(e),n}},{key:"load",value:function(e,n){var i=t.LoaderManager.createMap[t.Utils.getFilecompatibleExtension(e)]?t.Utils.getFilecompatibleExtension(e):t.Utils.getFileExtension(e),r=t.LoaderManager.createMap[i]?t.LoaderManager.createMap[i][0]:null;t.ILaya.loader.create(e,n,null,r)}},{key:"blackTexture",get:function(){return Vt._blackTexture}},{key:"grayTexture",get:function(){return Vt._grayTexture}}]),Vt}();ha.TEXTURECUBE="TEXTURECUBE",ha.TEXTURECUBEBIN="TEXTURECUBEBIN";var da=function(){function Bt(){_classCallCheck(this,Bt),this._length=0,this._elements=[]}return _createClass(Bt,[{key:"add",value:function(e){this._length===this._elements.length?this._elements.push(e):this._elements[this._length]=e,this._length++}},{key:"remove",value:function(e){var t=this._elements.indexOf(e);if(this._length--,t!==this._length){var n=this._elements[this._length];this._elements[t]=n}}},{key:"shift",value:function(){return this._length--,this._elements.shift()}},{key:"getBrightestLight",value:function(){for(var e,t=-1,n=this._elements,i=0;i<this._length;i++){var r=n[i]._intensity;t<r&&(t=r,e=i)}return e}},{key:"normalLightOrdering",value:function(e){var t=this._elements[0];this._elements[0]=this._elements[e],this._elements[e]=t}}]),Bt}(),fa=function(e){function Ft(){return _classCallCheck(this,Ft),_possibleConstructorReturn(this,_getPrototypeOf(Ft).apply(this,arguments))}return _inherits(Ft,da),_createClass(Ft,[{key:"remove",value:function(e){var t=this._elements.indexOf(e);this._elements.splice(t,1),this._length--}}]),Ft}(),ma=function(e){function Ut(){var e;return _classCallCheck(this,Ut),(e=_possibleConstructorReturn(this,_getPrototypeOf(Ut).call(this))).setShaderName("LineShader"),e._shaderValues.setVector(Ut.COLOR,new o(1,1,1,1)),e}return _inherits(Ut,Gi),_createClass(Ut,[{key:"clone",value:function(){var e=new Ut;return this.cloneTo(e),e}},{key:"color",get:function(){return this._shaderValues.getVector(Ut.COLOR)},set:function(e){this._shaderValues.setVector(Ut.COLOR,e)}}],[{key:"__initDefine__",value:function(){}}]),Ut}();ma.COLOR=xn.propertyNameToID("u_Color");var pa=function(){function Gt(e,t){_classCallCheck(this,Gt),this.min=e,this.max=t}return _createClass(Gt,[{key:"_rotateExtents",value:function(e,t,n){var i=e.x,r=e.y,a=e.z,o=t.elements;n.x=Math.abs(o[0]*i)+Math.abs(o[4]*r)+Math.abs(o[8]*a),n.y=Math.abs(o[1]*i)+Math.abs(o[5]*r)+Math.abs(o[9]*a),n.z=Math.abs(o[2]*i)+Math.abs(o[6]*r)+Math.abs(o[10]*a)}},{key:"getCorners",value:function(e){e.length=8;var t=this.min.x,n=this.min.y,i=this.min.z,r=this.max.x,a=this.max.y,o=this.max.z;e[0]=new D(t,a,o),e[1]=new D(r,a,o),e[2]=new D(r,n,o),e[3]=new D(t,n,o),e[4]=new D(t,a,i),e[5]=new D(r,a,i),e[6]=new D(r,n,i),e[7]=new D(t,n,i)}},{key:"getCenter",value:function(e){D.add(this.min,this.max,e),D.scale(e,.5,e)}},{key:"getExtent",value:function(e){D.subtract(this.max,this.min,e),D.scale(e,.5,e)}},{key:"setCenterAndExtent",value:function(e,t){D.subtract(e,t,this.min),D.add(e,t,this.max)}},{key:"tranform",value:function(e,t){var n=Gt._tempVector30,i=Gt._tempVector31;this.getCenter(n),this.getExtent(i),D.transformCoordinate(n,e,n),this._rotateExtents(i,e,i),t.setCenterAndExtent(n,i)}},{key:"toDefault",value:function(){this.min.toDefault(),this.max.toDefault()}},{key:"cloneTo",value:function(e){var t=e;this.min.cloneTo(t.min),this.max.cloneTo(t.max)}},{key:"clone",value:function(){var e=new Gt(new D,new D);return this.cloneTo(e),e}}],[{key:"createfromPoints",value:function(e,t){if(null==e)throw new Error("points");var n=t.min,i=t.max;n.x=Number.MAX_VALUE,n.y=Number.MAX_VALUE,n.z=Number.MAX_VALUE,i.x=-Number.MAX_VALUE,i.y=-Number.MAX_VALUE,i.z=-Number.MAX_VALUE;for(var r=0,a=e.length;r<a;++r)D.min(n,e[r],n),D.max(i,e[r],i)}},{key:"merge",value:function(e,t,n){D.min(e.min,t.min,n.min),D.max(e.max,t.max,n.max)}}]),Gt}();pa._tempVector30=new D,pa._tempVector31=new D;var va=function(){function Ht(e,t){_classCallCheck(this,Ht),this._updateFlag=0,this._center=new D,this._extent=new D,this._boundBox=new pa(new D,new D),e.cloneTo(this._boundBox.min),t.cloneTo(this._boundBox.max),this._setUpdateFlag(Ht._UPDATE_CENTER|Ht._UPDATE_EXTENT,!0)}return _createClass(Ht,[{key:"setMin",value:function(e){var t=this._boundBox.min;e!==t&&e.cloneTo(t),this._setUpdateFlag(Ht._UPDATE_CENTER|Ht._UPDATE_EXTENT,!0),this._setUpdateFlag(Ht._UPDATE_MIN,!1)}},{key:"getMin",value:function(){var e=this._boundBox.min;return this._getUpdateFlag(Ht._UPDATE_MIN)&&(this._getMin(this.getCenter(),this.getExtent(),e),this._setUpdateFlag(Ht._UPDATE_MIN,!1)),e}},{key:"setMax",value:function(e){var t=this._boundBox.max;e!==t&&e.cloneTo(t),this._setUpdateFlag(Ht._UPDATE_CENTER|Ht._UPDATE_EXTENT,!0),this._setUpdateFlag(Ht._UPDATE_MAX,!1)}},{key:"getMax",value:function(){var e=this._boundBox.max;return this._getUpdateFlag(Ht._UPDATE_MAX)&&(this._getMax(this.getCenter(),this.getExtent(),e),this._setUpdateFlag(Ht._UPDATE_MAX,!1)),e}},{key:"setCenter",value:function(e){e!==this._center&&e.cloneTo(this._center),this._setUpdateFlag(Ht._UPDATE_MIN|Ht._UPDATE_MAX,!0),this._setUpdateFlag(Ht._UPDATE_CENTER,!1)}},{key:"getCenter",value:function(){return this._getUpdateFlag(Ht._UPDATE_CENTER)&&(this._getCenter(this.getMin(),this.getMax(),this._center),this._setUpdateFlag(Ht._UPDATE_CENTER,!1)),this._center}},{key:"setExtent",value:function(e){e!==this._extent&&e.cloneTo(this._extent),this._setUpdateFlag(Ht._UPDATE_MIN|Ht._UPDATE_MAX,!0),this._setUpdateFlag(Ht._UPDATE_EXTENT,!1)}},{key:"getExtent",value:function(){return this._getUpdateFlag(Ht._UPDATE_EXTENT)&&(this._getExtent(this.getMin(),this.getMax(),this._extent),this._setUpdateFlag(Ht._UPDATE_EXTENT,!1)),this._extent}},{key:"_getUpdateFlag",value:function(e){return 0!=(this._updateFlag&e)}},{key:"_setUpdateFlag",value:function(e,t){t?this._updateFlag|=e:this._updateFlag&=~e}},{key:"_getCenter",value:function(e,t,n){D.add(e,t,n),D.scale(n,.5,n)}},{key:"_getExtent",value:function(e,t,n){D.subtract(t,e,n),D.scale(n,.5,n)}},{key:"_getMin",value:function(e,t,n){D.subtract(e,t,n)}},{key:"_getMax",value:function(e,t,n){D.add(e,t,n)}},{key:"_rotateExtents",value:function(e,t,n){var i=e.x,r=e.y,a=e.z,o=t.elements;n.x=Math.abs(o[0]*i)+Math.abs(o[4]*r)+Math.abs(o[8]*a),n.y=Math.abs(o[1]*i)+Math.abs(o[5]*r)+Math.abs(o[9]*a),n.z=Math.abs(o[2]*i)+Math.abs(o[6]*r)+Math.abs(o[10]*a)}},{key:"_tranform",value:function(e,t){var n=t._center,i=t._extent;D.transformCoordinate(this.getCenter(),e,n),this._rotateExtents(this.getExtent(),e,i),t._boundBox.setCenterAndExtent(n,i),t._updateFlag=0}},{key:"_getBoundBox",value:function(){if(this._updateFlag&Ht._UPDATE_MIN){var e=this._boundBox.min;this._getMin(this.getCenter(),this.getExtent(),e),this._setUpdateFlag(Ht._UPDATE_MIN,!1)}if(this._updateFlag&Ht._UPDATE_MAX){var t=this._boundBox.max;this._getMax(this.getCenter(),this.getExtent(),t),this._setUpdateFlag(Ht._UPDATE_MAX,!1)}return this._boundBox}},{key:"calculateBoundsintersection",value:function(e){var t=this.getMax(),n=this.getMin(),i=e.getMax(),r=e.getMin(),a=Ht.TEMP_VECTOR3_MAX0,o=Ht.TEMP_VECTOR3_MAX1,s=this.getExtent(),l=e.getExtent();return a.setValue(Math.max(t.x,i.x)-Math.min(n.x,r.x),Math.max(t.y,i.y)-Math.min(n.y,r.y),Math.max(t.z,i.z)-Math.min(n.z,r.z)),o.setValue(2*(s.x+l.x),2*(s.y+l.y),2*(s.z+l.z)),a.x>o.x||a.y>o.y||a.z>o.z?-1:(o.x-a.x)*(o.y-a.y)*(o.z-a.z)}},{key:"cloneTo",value:function(e){var t=e;this.getMin().cloneTo(t._boundBox.min),this.getMax().cloneTo(t._boundBox.max),this.getCenter().cloneTo(t._center),this.getExtent().cloneTo(t._extent),t._updateFlag=0}},{key:"clone",value:function(){var e=new Ht(new D,new D);return this.cloneTo(e),e}}]),Ht}();va._UPDATE_MIN=1,va._UPDATE_MAX=2,va._UPDATE_CENTER=4,va._UPDATE_EXTENT=8,va.TEMP_VECTOR3_MAX0=new D,va.TEMP_VECTOR3_MAX1=new D;var Ea=function(){function zt(){_classCallCheck(this,zt),this._destroyed=!1}return _createClass(zt,[{key:"_getType",value:function(){throw"GeometryElement:must override it."}},{key:"_prepareRender",value:function(e){return!0}},{key:"_render",value:function(e){throw"GeometryElement:must override it."}},{key:"destroy",value:function(){this._destroyed||(this._destroyed=!0)}},{key:"destroyed",get:function(){return this._destroyed}}]),zt}();Ea._typeCounter=0;var Ta=function(){function kt(){_classCallCheck(this,kt)}return _createClass(kt,[{key:"vertexDeclaration",get:function(){return kt._vertexDeclaration}}],[{key:"__init__",value:function(){kt._vertexDeclaration=new Tn(28,[new gn(0,vn.Vector3,Xn.MESH_POSITION0),new gn(12,vn.Vector4,Xn.MESH_COLOR0)])}},{key:"vertexDeclaration",get:function(){return kt._vertexDeclaration}}]),kt}(),ga=function(e){function Wt(e,n){var i;_classCallCheck(this,Wt),(i=_possibleConstructorReturn(this,_getPrototypeOf(Wt).call(this)))._floatCountPerVertices=7,i._minUpdate=Number.MAX_VALUE,i._maxUpdate=Number.MIN_VALUE,i._bufferState=new yn,i._floatBound=new Float32Array(6),i._calculateBound=!1,i._maxLineCount=0,i._lineCount=0;var r=2*n;i._owner=e,i._maxLineCount=n,i._vertices=new Float32Array(r*i._floatCountPerVertices),i._vertexBuffer=new pn(Ta.vertexDeclaration.vertexStride*r,t.LayaGL.instance.STATIC_DRAW,!1),i._vertexBuffer.vertexDeclaration=Ta.vertexDeclaration,i._bufferState.bind(),i._bufferState.applyVertexBuffer(i._vertexBuffer),i._bufferState.unBind();var a=Wt._tempVector0,o=Wt._tempVector1;return a.setValue(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),o.setValue(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),i._bounds=new va(a,o),i}return _inherits(Wt,Ea),_createClass(Wt,[{key:"_getType",value:function(){return Wt._type}},{key:"_resizeLineData",value:function(e){var n=2*e,i=this._vertices;this._vertexBuffer.destroy(),this._maxLineCount=e;var r=n*this._floatCountPerVertices;this._vertices=new Float32Array(r),this._vertexBuffer=new pn(Ta.vertexDeclaration.vertexStride*n,t.LayaGL.instance.STATIC_DRAW,!1),this._vertexBuffer.vertexDeclaration=Ta.vertexDeclaration,r<i.length?(this._vertices.set(new Float32Array(i.buffer,0,r)),this._vertexBuffer.setData(this._vertices.buffer,0,0,4*r)):(this._vertices.set(i),this._vertexBuffer.setData(this._vertices.buffer,0,0,4*i.length)),this._bufferState.bind(),this._bufferState.applyVertexBuffer(this._vertexBuffer),this._bufferState.unBind()}},{key:"_updateLineVertices",value:function(e,t,n,i,r){t&&(this._vertices[e+0]=t.x,this._vertices[e+1]=t.y,this._vertices[e+2]=t.z),i&&(this._vertices[e+3]=i.r,this._vertices[e+4]=i.g,this._vertices[e+5]=i.b,this._vertices[e+6]=i.a),n&&(this._vertices[e+7]=n.x,this._vertices[e+8]=n.y,this._vertices[e+9]=n.z),r&&(this._vertices[e+10]=r.r,this._vertices[e+11]=r.g,this._vertices[e+12]=r.b,this._vertices[e+13]=r.a),this._minUpdate=Math.min(this._minUpdate,e),this._maxUpdate=Math.max(this._maxUpdate,e+2*this._floatCountPerVertices);var a=this._bounds,o=this._floatBound,s=a.getMin(),l=a.getMax();D.min(s,t,s),D.min(s,n,s),D.max(l,t,l),D.max(l,n,l),a.setMin(s),a.setMax(l),o[0]=s.x,o[1]=s.y,o[2]=s.z,o[3]=l.x,o[4]=l.y,o[5]=l.z}},{key:"_reCalculateBound",value:function(){if(this._calculateBound){var e=this._vertices,t=Wt._tempVector0,n=Wt._tempVector1;t.setValue(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),n.setValue(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);for(var i=0;i<2*this._lineCount;++i){var r=this._floatCountPerVertices*i,a=e[r+0],o=e[r+1],s=e[r+2];t.x=Math.min(a,t.x),t.y=Math.min(o,t.y),t.z=Math.min(s,t.z),n.x=Math.max(a,n.x),n.y=Math.max(o,n.y),n.z=Math.max(s,n.z)}this._bounds.setMin(t),this._bounds.setMax(n);var l=this._floatBound;l[0]=t.x,l[1]=t.y,l[2]=t.z,l[3]=n.x,l[4]=n.y,l[5]=n.z,this._calculateBound=!1}}},{key:"_removeLineData",value:function(e){var t=2*this._floatCountPerVertices,n=e+1,i=e*t,r=this._vertices,a=new Float32Array(r.buffer,n*t*4,(this._lineCount-n)*t);r.set(a,i),this._minUpdate=Math.min(this._minUpdate,i),this._maxUpdate=Math.max(this._maxUpdate,i+a.length),this._lineCount--;var o=this._floatBound,s=r[i],l=r[i+1],u=r[i+2],_=r[i+7],c=r[i+8],h=r[i+9],d=o[0],f=o[1],m=o[2],p=o[3],v=o[4],E=o[5];s!==d&&s!==p&&l!==f&&l!==v&&u!==m&&u!==E&&_!==d&&_!==p&&c!==f&&c!==v&&h!==m&&h!==E||(this._calculateBound=!0)}},{key:"_updateLineData",value:function(e,t,n,i,r){var a=2*this._floatCountPerVertices;this._updateLineVertices(e*a,t,n,i,r)}},{key:"_updateLineDatas",value:function(e,t){for(var n=2*this._floatCountPerVertices,i=t.length,r=0;r<i;r++){var a=t[r];this._updateLineVertices((e+r)*n,a.startPosition,a.endPosition,a.startColor,a.endColor)}}},{key:"_getLineData",value:function(e,t){var n=t.startPosition,i=t.startColor,r=t.endPosition,a=t.endColor,o=this._vertices,s=e*this._floatCountPerVertices*2;n.x=o[s+0],n.y=o[s+1],n.z=o[s+2],i.r=o[s+3],i.g=o[s+4],i.b=o[s+5],i.a=o[s+6],r.x=o[s+7],r.y=o[s+8],r.z=o[s+9],a.r=o[s+10],a.g=o[s+11],a.b=o[s+12],a.a=o[s+13]}},{key:"_prepareRender",value:function(e){return!0}},{key:"_render",value:function(e){if(this._minUpdate!==Number.MAX_VALUE&&this._maxUpdate!==Number.MIN_VALUE&&(this._vertexBuffer.setData(this._vertices.buffer,4*this._minUpdate,4*this._minUpdate,4*(this._maxUpdate-this._minUpdate)),this._minUpdate=Number.MAX_VALUE,this._maxUpdate=Number.MIN_VALUE),this._lineCount>0){this._bufferState.bind();var n=t.LayaGL.instance;n.drawArrays(n.LINES,0,2*this._lineCount),t.Stat.renderBatches++}}},{key:"destroy",value:function(){this._destroyed||(_get(_getPrototypeOf(Wt.prototype),"destroy",this).call(this),this._bufferState.destroy(),this._vertexBuffer.destroy(),this._bufferState=null,this._vertexBuffer=null,this._vertices=null)}}]),Wt}();ga._tempVector0=new D,ga._tempVector1=new D,ga._type=Ea._typeCounter++;var ya=function(e){function Xt(e){return _classCallCheck(this,Xt),_possibleConstructorReturn(this,_getPrototypeOf(Xt).call(this,e))}return _inherits(Xt,Nn),_createClass(Xt,[{key:"_onInActive",value:function(){_get(_getPrototypeOf(Xt.prototype),"_onInActive",this).call(this),this._scene._removeRenderObject(this._render)}},{key:"_onActive",value:function(){_get(_getPrototypeOf(Xt.prototype),"_onActive",this).call(this),this._scene._addRenderObject(this._render)}},{key:"_onActiveInScene",value:function(){if(_get(_getPrototypeOf(Xt.prototype),"_onActiveInScene",this).call(this),F.Laya3D._editerEnvironment){var e=this._scene,t=new o;e._allotPickColorByID(this.id,t),e._pickIdToSprite[this.id]=this,this._render._shaderValues.setVector(Xt.PICKCOLOR,t)}}},{key:"_addToInitStaticBatchManager",value:function(){}},{key:"_setBelongScene",value:function(e){_get(_getPrototypeOf(Xt.prototype),"_setBelongScene",this).call(this,e),this._render._setBelongScene(e)}},{key:"_setUnBelongScene",value:function(){this._render._shaderValues.removeDefine(Xt.SAHDERDEFINE_LIGHTMAP),_get(_getPrototypeOf(Xt.prototype),"_setUnBelongScene",this).call(this)}},{key:"_changeHierarchyAnimator",value:function(e){if(this._hierarchyAnimator){var t=this._hierarchyAnimator._renderableSprites;t.splice(t.indexOf(this),1)}e&&e._renderableSprites.push(this),_get(_getPrototypeOf(Xt.prototype),"_changeHierarchyAnimator",this).call(this,e)}},{key:"destroy",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];_get(_getPrototypeOf(Xt.prototype),"destroy",this).call(this,e),this._render._destroy(),this._render=null}},{key:"_create",value:function(){return new Xt(this.name)}}],[{key:"__init__",value:function(){Xt.SHADERDEFINE_RECEIVE_SHADOW=xn.getDefineByName("RECEIVESHADOW"),Xt.SAHDERDEFINE_LIGHTMAP=xn.getDefineByName("LIGHTMAP"),Xt.SHADERDEFINE_LIGHTMAP_DIRECTIONAL=xn.getDefineByName("LIGHTMAP_DIRECTIONAL")}}]),Xt}();ya.LIGHTMAPSCALEOFFSET=xn.propertyNameToID("u_LightmapScaleOffset"),ya.LIGHTMAP=xn.propertyNameToID("u_LightMap"),ya.LIGHTMAP_DIRECTION=xn.propertyNameToID("u_LightMapDirection"),ya.PICKCOLOR=xn.propertyNameToID("u_PickColor"),ya.REFLECTIONTEXTURE=xn.propertyNameToID("u_ReflectTexture"),ya.REFLECTIONCUBE_HDR_PARAMS=xn.propertyNameToID("u_ReflectCubeHDRParams"),ya.REFLECTIONCUBE_PROBEPOSITION=xn.propertyNameToID("u_SpecCubeProbePosition"),ya.REFLECTIONCUBE_PROBEBOXMAX=xn.propertyNameToID("u_SpecCubeBoxMax"),ya.REFLECTIONCUBE_PROBEBOXMIN=xn.propertyNameToID("u_SpecCubeBoxMin");var Sa=function Yt(){_classCallCheck(this,Yt),this.updateMark=-1,this.indexInList=-1,this.batched=!1},Ra=function(e){function jt(){var e;_classCallCheck(this,jt),(e=_possibleConstructorReturn(this,_getPrototypeOf(jt).call(this))).instanceWorldMatrixData=new Float32Array(16*jt.maxInstanceCount),e.instanceSimpleAnimatorData=new Float32Array(4*jt.maxInstanceCount);var n=t.LayaGL.instance;return e.instanceWorldMatrixBuffer=new pn(4*e.instanceWorldMatrixData.length,n.DYNAMIC_DRAW),e.instanceWorldMatrixBuffer.vertexDeclaration=Xn.instanceWorldMatrixDeclaration,e.instanceSimpleAnimatorBuffer=new pn(4*e.instanceSimpleAnimatorData.length,n.DYNAMIC_DRAW),e.instanceSimpleAnimatorBuffer.vertexDeclaration=Xn.instanceSimpleAnimatorDeclaration,e}return _inherits(jt,Ea),_createClass(jt,[{key:"_render",value:function(e){var n=t.LayaGL.instance,i=e.renderElement,r=i.instanceSubMesh,a=i.instanceBatchElementList.length,o=r._indexCount;r._mesh._instanceBufferState.bind(),t.LayaGL.layaGPUInstance.drawElementsInstanced(n.TRIANGLES,o,n.UNSIGNED_SHORT,2*r._indexStart,a),t.Stat.renderBatches++,t.Stat.savedRenderBatches+=a-1,t.Stat.trianglesFaces+=o*a/3}}],[{key:"__init__",value:function(){jt.instance=new jt}}]),jt}();Ra.maxInstanceCount=1024;var Ca=function(e){function Zt(){var e;return _classCallCheck(this,Zt),(e=_possibleConstructorReturn(this,_getPrototypeOf(Zt).call(this)))._dynamicWorldPositionNormalNeedUpdate=!0,e}return _inherits(Zt,ci),_createClass(Zt,[{key:"_onWorldMatrixChanged",value:function(){this._dynamicWorldPositionNormalNeedUpdate=!0}},{key:"_computeWorldPositionsAndNormals",value:function(e,t,n,i){if(this._dynamicWorldPositionNormalNeedUpdate){for(var r=this._geometry,a=r._vertexBuffer,o=a.vertexDeclaration.vertexStride/4,s=a.getFloat32Data(),l=this._transform.worldMatrix,u=this._transform.rotation,_=r._indices,c=0;c<i;c++){var h=(n?_[c]:c)*o,d=3*c;gt.transformVector3ArrayToVector3ArrayCoordinate(s,h+e,l,this._dynamicWorldPositions,d),-1!==t&&gt.transformVector3ArrayByQuat(s,h+t,u,this._dynamicWorldNormals,d)}this._dynamicWorldPositionNormalNeedUpdate=!1}}},{key:"setTransform",value:function(e){this._transform!==e&&(this._transform&&this._transform.off(t.Event.TRANSFORM_CHANGED,this,this._onWorldMatrixChanged),e&&e.on(t.Event.TRANSFORM_CHANGED,this,this._onWorldMatrixChanged),this._dynamicWorldPositionNormalNeedUpdate=!0,this._transform=e)}},{key:"setGeometry",value:function(e){if(this._geometry!==e){var t=e,n=t._mesh;if(n){var i=n._subMeshes.length>1,r=i?t._indexCount:n._vertexCount;if(r<=F.SubMeshDynamicBatch.maxAllowVertexCount){var a=3*r;this._dynamicVertexBatch=!0,this._dynamicWorldPositions=new Float32Array(a),this._dynamicWorldNormals=new Float32Array(a),this._dynamicVertexCount=r,this._dynamicMultiSubMesh=i}else this._dynamicVertexBatch=!1}this._geometry=e}}},{key:"addToOpaqueRenderQueue",value:function(e,n){var i=this.staticBatch,r=n.elements,a=r.elements;if(!i||this.render._probReflection&&!this.render._probReflection._isScene)if(this.renderSubShader._owner._enableInstancing&&t.LayaGL.layaGPUInstance.supportInstance()&&this.render.lightmapIndex<0&&(!this.render._probReflection||this.render._probReflection._isScene)){var o=this._geometry,s=F.MeshRenderDynamicBatchManager.instance,l=s.getInstanceBatchOpaquaMark(this.render.receiveShadow,this.material.id,o._id,this._transform._isFrontFaceInvert);if(s._updateCountMark===l.updateMark){var u=l.indexInList;if(l.batched){var _=a[u].instanceBatchElementList;_.length===Ra.maxInstanceCount?(l.updateMark=s._updateCountMark,l.indexInList=r.length,l.batched=!1,r.add(this)):_.add(this)}else{var c=a[u],h=c.render,d=s._getBatchRenderElementFromPool();d.renderType=ci.RENDERTYPE_INSTANCEBATCH,d.setGeometry(Ra.instance),d.material=c.material,d.setTransform(null),d.render=h,d.instanceSubMesh=o,d.renderSubShader=c.renderSubShader;var f=d.instanceBatchElementList;f.length=0,f.add(c),f.add(this),a[u]=d,l.batched=!0}}else l.updateMark=s._updateCountMark,l.indexInList=r.length,l.batched=!1,r.add(this)}else if(this._dynamicVertexBatch){var m=this._geometry._vertexBuffer.vertexDeclaration,p=F.MeshRenderDynamicBatchManager.instance,v=p.getVertexBatchOpaquaMark(this.render.lightmapIndex+1,this.render.receiveShadow,this.material.id,m.id);if(p._updateCountMark===v.updateMark){var E=v.indexInList;if(v.batched)a[E].vertexBatchElementList.add(this);else{var T=a[E],g=T.render,y=p._getBatchRenderElementFromPool();y.renderType=ci.RENDERTYPE_VERTEXBATCH,y.setGeometry(F.SubMeshDynamicBatch.instance),y.material=T.material,y.setTransform(null),y.render=g,y.vertexBatchVertexDeclaration=m,y.renderSubShader=T.renderSubShader;var S=y.vertexBatchElementList;S.length=0,S.add(T),S.add(this),a[E]=y,v.batched=!0}}else v.updateMark=p._updateCountMark,v.indexInList=r.length,v.batched=!1,r.add(this)}else r.add(this);else{var R=F.MeshRenderStaticBatchManager.instance,C=R.getBatchOpaquaMark(this.render.lightmapIndex+1,this.render.receiveShadow,this.material.id,i._batchID);if(R._updateCountMark===C.updateMark){var A=C.indexInList;if(C.batched)a[A].staticBatchElementList.add(this);else{var I=a[A],x=I.render,D=R._getBatchRenderElementFromPool();D.renderType=ci.RENDERTYPE_STATICBATCH,D.setGeometry(i),D.material=I.material;var M=i.batchOwner,L=M?M._transform:null;D.setTransform(L),D.render=x,D.renderSubShader=I.renderSubShader;var O=D.staticBatchElementList;O.length=0,O.add(I),O.add(this),a[A]=D,C.batched=!0}}else C.updateMark=R._updateCountMark,C.indexInList=r.length,C.batched=!1,r.add(this)}}},{key:"addToTransparentRenderQueue",value:function(e,n){var i=this.staticBatch,r=n.elements,a=r.elements;if(i){var o=F.MeshRenderStaticBatchManager.instance,s=n.lastTransparentRenderElement;if(s){var l=s.render;if(s._geometry._getType()!==this._geometry._getType()||s.staticBatch!==i||s.material!==this.material||l.receiveShadow!==this.render.receiveShadow||l.lightmapIndex!==this.render.lightmapIndex)r.add(this),n.lastTransparentBatched=!1;else{if(n.lastTransparentBatched)a[r.length-1].staticBatchElementList.add(this);else{var u=o._getBatchRenderElementFromPool();u.renderType=ci.RENDERTYPE_STATICBATCH,u.setGeometry(i),u.material=s.material;var _=i.batchOwner,c=_?_._transform:null;u.setTransform(c),u.render=this.render,u.renderSubShader=s.renderSubShader;var h=u.staticBatchElementList;h.length=0,h.add(s),h.add(this),a[r.length-1]=u}n.lastTransparentBatched=!0}}else r.add(this),n.lastTransparentBatched=!1}else if(this.renderSubShader._owner._enableInstancing&&t.LayaGL.layaGPUInstance.supportInstance()&&this.render.lightmapIndex<0&&(!this.render._probReflection||this.render._probReflection._isScene)){var d=this._geometry,f=F.MeshRenderDynamicBatchManager.instance,m=n.lastTransparentRenderElement;if(m){var p=m.render;if(m._geometry._getType()!==this._geometry._getType()||m._geometry!==d||m.material!==this.material||p.receiveShadow!==this.render.receiveShadow)r.add(this),n.lastTransparentBatched=!1;else if(n.lastTransparentBatched){var v=a[r.length-1].instanceBatchElementList;v.length===Ra.maxInstanceCount?(r.add(this),n.lastTransparentBatched=!1):(v.add(this),n.lastTransparentBatched=!0)}else{var E=f._getBatchRenderElementFromPool();E.renderType=ci.RENDERTYPE_INSTANCEBATCH,E.setGeometry(Ra.instance),E.material=m.material,E.setTransform(null),E.render=this.render,E.instanceSubMesh=d,E.renderSubShader=m.renderSubShader;var T=E.instanceBatchElementList;T.length=0,T.add(m),T.add(this),a[r.length-1]=E,n.lastTransparentBatched=!0}}else r.add(this),n.lastTransparentBatched=!1}else if(this._dynamicVertexBatch){var g=this._geometry._vertexBuffer.vertexDeclaration,y=F.MeshRenderDynamicBatchManager.instance,S=n.lastTransparentRenderElement;if(S){var R=S.render;if(S._dynamicVertexBatch&&S._geometry._getType()===this._geometry._getType()&&S._geometry._vertexBuffer._vertexDeclaration===g&&S.material===this.material&&R.receiveShadow===this.render.receiveShadow&&R.lightmapIndex===this.render.lightmapIndex){if(n.lastTransparentBatched)a[r.length-1].vertexBatchElementList.add(this);else{var C=y._getBatchRenderElementFromPool();C.renderType=ci.RENDERTYPE_VERTEXBATCH,C.setGeometry(F.SubMeshDynamicBatch.instance),C.material=S.material,C.setTransform(null),C.render=this.render,C.vertexBatchVertexDeclaration=g,C.renderSubShader=S.renderSubShader;var A=C.vertexBatchElementList;A.length=0,A.add(S),A.add(this),a[r.length-1]=C}n.lastTransparentBatched=!0}else r.add(this),n.lastTransparentBatched=!1}else r.add(this),n.lastTransparentBatched=!1}else r.add(this);n.lastTransparentRenderElement=this}},{key:"getInvertFront",value:function(){switch(this.renderType){case ci.RENDERTYPE_NORMAL:return this._transform._isFrontFaceInvert;case ci.RENDERTYPE_STATICBATCH:case ci.RENDERTYPE_VERTEXBATCH:return!1;case ci.RENDERTYPE_INSTANCEBATCH:return this.instanceBatchElementList.elements[0]._transform._isFrontFaceInvert;default:throw"SubMeshRenderElement: unknown renderType"}}},{key:"destroy",value:function(){_get(_getPrototypeOf(Zt.prototype),"destroy",this).call(this),this._dynamicWorldPositions=null,this._dynamicWorldNormals=null,this.staticBatch=null,this.staticBatchElementList=null,this.vertexBatchElementList=null,this.vertexBatchVertexDeclaration=null}}]),Zt}(),Aa=function(){function qt(){_classCallCheck(this,qt),this._initBatchSprites=[],this._staticBatches={},this._batchRenderElementPoolIndex=0,this._batchRenderElementPool=[]}return _createClass(qt,[{key:"_partition",value:function(e,t,n){for(var i=e[Math.floor((n+t)/2)];t<=n;){for(;this._compare(e[t],i)<0;)t++;for(;this._compare(e[n],i)>0;)n--;if(t<n){var r=e[t];e[t]=e[n],e[n]=r,t++,n--}else if(t===n){t++;break}}return t}},{key:"_quickSort",value:function(e,t,n){if(e.length>1){var i=this._partition(e,t,n),r=i-1;t<r&&this._quickSort(e,t,r),i<n&&this._quickSort(e,i,n)}}},{key:"_compare",value:function(e,t){throw"StaticBatch:must override this function."}},{key:"_initStaticBatchs",value:function(e){throw"StaticBatch:must override this function."}},{key:"_getBatchRenderElementFromPool",value:function(){throw"StaticBatch:must override this function."}},{key:"_addBatchSprite",value:function(e){this._initBatchSprites.push(e)}},{key:"_clear",value:function(){this._batchRenderElementPoolIndex=0}},{key:"_garbageCollection",value:function(){throw"StaticBatchManager: must override it."}},{key:"dispose",value:function(){this._staticBatches=null}}],[{key:"_addToStaticBatchQueue",value:function(e,t){e instanceof ya&&t.push(e);for(var n=0,i=e.numChildren;n<i;n++)qt._addToStaticBatchQueue(e._children[n],t)}},{key:"_registerManager",value:function(e){qt._managers.push(e)}},{key:"combine",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;t||(t=[],e&&qt._addToStaticBatchQueue(e,t));var n=t.length;if(n>0){for(var i=0;i<n;i++){var r=t[i];r.destroyed||(r._render._isPartOfStaticBatch?console.warn("StaticBatchManager: Sprite "+r.name+" has a part of Static Batch,it will be ignore."):r._addToInitStaticBatchManager())}for(var a=0,o=qt._managers.length;a<o;a++)qt._managers[a]._initStaticBatchs(e)}}}]),qt}();Aa._managers=[];var Ia=function(n){function Qt(e,t){var n;return _classCallCheck(this,Qt),(n=_possibleConstructorReturn(this,_getPrototypeOf(Qt).call(this)))._bufferState=new yn,n._batchID=Qt._batchIDCounter++,n._batchElements=[],n._currentBatchVertexCount=0,n._currentBatchIndexCount=0,n._vertexDeclaration=t,n.batchOwner=e,n}return _inherits(Qt,Ea),_createClass(Qt,[{key:"_getStaticBatchBakedVertexs",value:function(e,t,n,i,r,a){var o,s=a._vertexBuffer,l=s.vertexDeclaration,u=l.getVertexElementByUsage(Xn.MESH_POSITION0)._offset/4,_=l.getVertexElementByUsage(Xn.MESH_NORMAL0),c=_?_._offset/4:-1,h=l.getVertexElementByUsage(Xn.MESH_COLOR0),d=h?h._offset/4:-1,f=l.getVertexElementByUsage(Xn.MESH_TEXTURECOORDINATE0),m=f?f._offset/4:-1,p=l.getVertexElementByUsage(Xn.MESH_TEXTURECOORDINATE1),v=p?p._offset/4:-1,E=l.getVertexElementByUsage(Xn.MESH_TANGENT0),T=E?E._offset/4:-1,g=l.vertexStride/4,y=s.getFloat32Data();n?(n.worldMatrix.invert(Qt._tempMatrix4x40),o=Qt._tempMatrix4x41,q.multiply(Qt._tempMatrix4x40,i.worldMatrix,o)):o=i.worldMatrix;var S=Qt._tempMatrix4x42;o.invert(S),S.transpose();var R=Qt._tempQuaternion0;o.decomposeTransRotScale(Qt._tempVector30,R,Qt._tempVector31);for(var C=r.lightmapScaleOffset,A=a.vertexCount,I=0;I<A;I++){var x,D,M=I*g,L=18*(I+t);gt.transformVector3ArrayToVector3ArrayCoordinate(y,M+u,o,e,L+0),-1!==c&&gt.transformVector3ArrayToVector3ArrayNormal(y,M+c,S,e,L+3);var O=L+6;if(-1!==d){var N=M+d;for(x=0,D=4;x<D;x++)e[O+x]=y[N+x]}else for(x=0,D=4;x<D;x++)e[O+x]=1;if(-1!==m){var P=M+m;e[L+10]=y[P],e[L+11]=y[P+1]}if(C&&(-1!==v?gt.transformLightingMapTexcoordArray(y,M+v,C,e,L+12):gt.transformLightingMapTexcoordArray(y,M+m,C,e,L+12)),-1!==T){var b=M+T;gt.transformVector3ArrayToVector3ArrayNormal(y,b,S,e,L+14),e[L+17]=y[b+3]}}return A}},{key:"addTest",value:function(e){var t=e.meshFilter.sharedMesh.vertexCount;return!(this._currentBatchVertexCount+t>Qt.maxBatchVertexCount)}},{key:"add",value:function(e){var t=e.meshFilter.sharedMesh,n=t.vertexCount;this._batchElements.push(e);var i=e._render;i._isPartOfStaticBatch=!0,i._staticBatch=this;for(var r=i._renderElements,a=0,o=r.length;a<o;a++)r[a].staticBatch=this;this._currentBatchIndexCount+=t._indexBuffer.indexCount,this._currentBatchVertexCount+=n}},{key:"remove",value:function(e){var t=e.meshFilter.sharedMesh,n=this._batchElements.indexOf(e);if(-1!==n){this._batchElements.splice(n,1);for(var i=e._render._renderElements,r=0,a=i.length;r<a;r++)i[r].staticBatch=null;this._currentBatchIndexCount=this._currentBatchIndexCount-t._indexBuffer.indexCount,this._currentBatchVertexCount=this._currentBatchVertexCount-t.vertexCount,e._render._isPartOfStaticBatch=!1}}},{key:"finishInit",value:function(){this._vertexBuffer&&(this._vertexBuffer.destroy(),this._indexBuffer.destroy(),t.Resource._addGPUMemory(-(this._vertexBuffer._byteLength+this._indexBuffer._byteLength)));var n=t.LayaGL.instance,i=0,r=0,a=this.batchOwner,o=this._vertexDeclaration.vertexStride/4,s=new Float32Array(o*this._currentBatchVertexCount),l=new Uint16Array(this._currentBatchIndexCount);this._vertexBuffer=new pn(this._vertexDeclaration.vertexStride*this._currentBatchVertexCount,n.STATIC_DRAW),this._vertexBuffer.vertexDeclaration=this._vertexDeclaration,this._indexBuffer=new Wn(e.IndexFormat.UInt16,this._currentBatchIndexCount,n.STATIC_DRAW);for(var u=0,_=this._batchElements.length;u<_;u++){for(var c,h=this._batchElements[u],d=h.meshFilter.sharedMesh,f=this._getStaticBatchBakedVertexs(s,i,a?a._transform:null,h._transform,h._render,d),m=d._indexBuffer.getData(),p=i,v=r+m.length,E=h._render._renderElements,T=0,g=d.subMeshCount;T<g;T++){var y=d._subMeshes[T],S=r+y._indexStart,R=E[T];R.staticBatchIndexStart=S,R.staticBatchIndexEnd=S+y._indexCount}if(l.set(m,r),a?h._transform._isFrontFaceInvert!==a.transform._isFrontFaceInvert:h._transform._isFrontFaceInvert)for(c=r;c<v;c+=3){l[c]=p+l[c];var C=l[c+1],A=l[c+2];l[c+1]=p+A,l[c+2]=p+C}else for(c=r;c<v;c+=3)l[c]=p+l[c],l[c+1]=p+l[c+1],l[c+2]=p+l[c+2];r+=m.length,i+=f}this._vertexBuffer.setData(s.buffer),this._indexBuffer.setData(l);var I=this._vertexBuffer._byteLength+this._indexBuffer._byteLength;t.Resource._addGPUMemory(I),this._bufferState.bind(),this._bufferState.applyVertexBuffer(this._vertexBuffer),this._bufferState.applyIndexBuffer(this._indexBuffer),this._bufferState.unBind()}},{key:"_render",value:function(e){this._bufferState.bind();for(var n=t.LayaGL.instance,i=e.renderElement.staticBatchElementList,r=i.elements,a=0,o=0,s=i.length,l=1;l<s;l++)if(r[l-1].staticBatchIndexEnd!==r[l].staticBatchIndexStart){var u=r[a].staticBatchIndexStart,_=r[o].staticBatchIndexEnd-u;n.drawElements(n.TRIANGLES,_,n.UNSIGNED_SHORT,2*u),a=++o,t.Stat.trianglesFaces+=_/3}else o++;u=r[a].staticBatchIndexStart,_=r[o].staticBatchIndexEnd-u,n.drawElements(n.TRIANGLES,_,n.UNSIGNED_SHORT,2*u),t.Stat.renderBatches++,t.Stat.savedRenderBatches+=s-1,t.Stat.trianglesFaces+=_/3}},{key:"dispose",value:function(){var e=this._vertexBuffer._byteLength+this._indexBuffer._byteLength;t.Resource._addGPUMemory(-e),this._batchElements=null,this.batchOwner=null,this._vertexDeclaration=null,this._bufferState.destroy(),this._vertexBuffer.destroy(),this._indexBuffer.destroy(),this._vertexBuffer=null,this._indexBuffer=null,this._bufferState=null}}]),Qt}();Ia._tempVector30=new D,Ia._tempVector31=new D,Ia._tempQuaternion0=new Z,Ia._tempMatrix4x40=new q,Ia._tempMatrix4x41=new q,Ia._tempMatrix4x42=new q,Ia.maxBatchVertexCount=65535,Ia._batchIDCounter=0;var xa=function(e){function Kt(){var e;return _classCallCheck(this,Kt),(e=_possibleConstructorReturn(this,_getPrototypeOf(Kt).call(this)))._opaqueBatchMarks=[],e._updateCountMark=0,e}return _inherits(Kt,Aa),_createClass(Kt,[{key:"_compare",value:function(e,t){var n=e._render,i=t._render,r=e.meshFilter.sharedMesh,a=t.meshFilter.sharedMesh,o=n.lightmapIndex-i.lightmapIndex;if(0===o){var s=(n.receiveShadow?1:0)-(i.receiveShadow?1:0);if(0===s){var l=n.sharedMaterial&&i.sharedMaterial?n.sharedMaterial.id-i.sharedMaterial.id:0;if(0===l){var u=r._vertexBuffer.vertexDeclaration.id-a._vertexBuffer.vertexDeclaration.id;return 0===u?a._indexBuffer.indexCount-r._indexBuffer.indexCount:u}return l}return s}return o}},{key:"_getBatchRenderElementFromPool",value:function(){var e=this._batchRenderElementPool[this._batchRenderElementPoolIndex++];return e||(e=new Ca,this._batchRenderElementPool[this._batchRenderElementPoolIndex-1]=e,e.staticBatchElementList=new Ye),e}},{key:"_getStaticBatch",value:function(e,t,n){var i=e[n];return i||(i=e[n]=new Ia(t,Kt._verDec),this._staticBatches[i._batchID]=i),i}},{key:"_initStaticBatchs",value:function(e){var t=this._initBatchSprites;this._quickSort(t,0,t.length-1);for(var n,i=[],r=!1,a=0,o=0,s=t.length;o<s;o++){var l=t[o];r?n.addTest(l)?n.add(l):(r=!1,a++):o!==s-1&&((n=this._getStaticBatch(i,e,a)).add(l),r=!0)}for(o=0,s=i.length;o<s;o++){var u=i[o];u&&u.finishInit()}this._initBatchSprites.length=0}},{key:"_removeRenderSprite",value:function(e){var t=e._render,n=t._staticBatch,i=n._batchElements,r=i.indexOf(e);if(-1!==r){i.splice(r,1),t._staticBatch=null;for(var a=t._renderElements,o=0,s=a.length;o<s;o++)a[o].staticBatch=null}0===i.length&&(delete this._staticBatches[n._batchID],n.dispose())}},{key:"_clear",value:function(){_get(_getPrototypeOf(Kt.prototype),"_clear",this).call(this),this._updateCountMark++}},{key:"_garbageCollection",value:function(){for(var e in this._staticBatches){var t=this._staticBatches[e];0===t._batchElements.length&&(t.dispose(),delete this._staticBatches[e])}}},{key:"getBatchOpaquaMark",value:function(e,t,n,i){var r=t?1:0,a=this._opaqueBatchMarks[e]||(this._opaqueBatchMarks[e]=[]),o=a[r]||(a[r]=[]),s=o[n]||(o[n]=[]);return s[i]||(s[i]=new Sa)}}],[{key:"__init__",value:function(){Kt._verDec=Xn.getVertexDeclaration("POSITION,NORMAL,COLOR,UV,UV1,TANGENT")}}]),Kt}();xa.instance=new xa,(cr=e.ReflectionProbeMode||(e.ReflectionProbeMode={}))[cr.off=0]="off",cr[cr.simple=1]="simple";var Da=function(e){function Jt(){var e;return _classCallCheck(this,Jt),(e=_possibleConstructorReturn(this,_getPrototypeOf(Jt).call(this)))._boxProjection=!1,e._size=new D,e._offset=new D,e._reflectionHDRParams=new o,e._reflectionDecodeFormat=t.TextureDecodeFormat.Normal,e._isScene=!1,e}return _inherits(Jt,Nn),_createClass(Jt,[{key:"_parse",value:function(e,n){_get(_getPrototypeOf(Jt.prototype),"_parse",this).call(this,e,n),this._boxProjection=e.boxProjection,this._importance=e.importance,this._reflectionTexture=t.Loader.getRes(e.reflection);var i=this.transform.position;this._size.fromArray(e.boxSize),D.scale(this._size,.5,Jt.TEMPVECTOR3),this._offset.fromArray(e.boxOffset);var r=new D,a=new D;D.add(i,Jt.TEMPVECTOR3,a),D.add(a,this._offset,a),D.subtract(i,Jt.TEMPVECTOR3,r),D.add(r,this._offset,r),this._reflectionDecodeFormat=e.reflectionDecodingFormat,this.intensity=e.intensity,this._bounds?(this._bounds.setMin(r),this._bounds.setMax(a)):this.bounds=new va(r,a)}},{key:"_setIndexInReflectionList",value:function(e){this._indexInReflectProbList=e}},{key:"_getIndexInReflectionList",value:function(){return this._indexInReflectProbList}},{key:"_onActive",value:function(){_get(_getPrototypeOf(Jt.prototype),"_onActive",this).call(this),this._reflectionTexture&&this.scene._reflectionProbeManager.add(this)}},{key:"_onInActive",value:function(){_get(_getPrototypeOf(Jt.prototype),"_onInActive",this).call(this),this.reflectionTexture&&this.scene._reflectionProbeManager.remove(this)}},{key:"destroy",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];this.destroyed||(_get(_getPrototypeOf(Jt.prototype),"destroy",this).call(this,e),this._reflectionTexture&&this._reflectionTexture._removeReference(),this._reflectionTexture=null,this._bounds=null)}},{key:"_cloneTo",value:function(e,t,n){var i=e;i.bounds=this.bounds,i.boxProjection=this.boxProjection,i.importance=this.importance,i._size=this._size,i._offset=this._offset,i.intensity=this.intensity,i.reflectionHDRParams=this.reflectionHDRParams,_get(_getPrototypeOf(Jt.prototype),"_cloneTo",this).call(this,e,t,n)}},{key:"boxProjection",get:function(){return this._boxProjection},set:function(e){this._boxProjection=e}},{key:"importance",get:function(){return this._importance},set:function(e){this._importance=e}},{key:"intensity",get:function(){return this._intensity},set:function(e){e=Math.max(Math.min(e,1),0),this._reflectionHDRParams.x=e,this._reflectionDecodeFormat==t.TextureDecodeFormat.RGBM&&(this._reflectionHDRParams.x*=5),this._intensity=e}},{key:"reflectionTexture",get:function(){return this._reflectionTexture},set:function(e){this._reflectionTexture=e,this._reflectionTexture._addReference()}},{key:"bounds",get:function(){return this._bounds},set:function(e){this._bounds=e}},{key:"boundsMax",get:function(){return this._bounds.getMax()}},{key:"boundsMin",get:function(){return this._bounds.getMin()}},{key:"probePosition",get:function(){return this.transform.position}},{key:"reflectionHDRParams",get:function(){return this._reflectionHDRParams},set:function(e){this._reflectionHDRParams=e}}]),Jt}();Da.TEMPVECTOR3=new D,Da.defaultTextureHDRDecodeValues=new o(1,1,0,0);var Ma=function(n){function $t(n){var i;return _classCallCheck(this,$t),(i=_possibleConstructorReturn(this,_getPrototypeOf($t).call(this)))._lightmapScaleOffset=new o(1,1,0,0),i._indexInList=-1,i._indexInCastShadowList=-1,i._boundsChange=!0,i._castShadow=!1,i._supportOctree=!0,i._sharedMaterials=[],i._renderMark=-1,i._indexInOctreeMotionList=-1,i._reflectionMode=e.ReflectionProbeMode.simple,i._updateMark=-1,i._updateRenderType=-1,i._isPartOfStaticBatch=!1,i._staticBatch=null,i._id=++$t._uniqueIDCounter,i._indexInCastShadowList=-1,i._bounds=new va(D._ZERO,D._ZERO),i._renderElements=[],i._owner=n,i._enable=!0,i._materialsInstance=[],i._shaderValues=new En(null),i.lightmapIndex=-1,i.receiveShadow=!1,i.sortingFudge=0,n&&i._owner.transform.on(t.Event.TRANSFORM_CHANGED,_assertThisInitialized(i),i._onWorldMatNeedChange),i}return _inherits($t,t.EventDispatcher),_createClass($t,[{key:"_getOctreeNode",value:function(){return this._octreeNode}},{key:"_setOctreeNode",value:function(e){e||-1!==this._indexInOctreeMotionList&&this._octreeNode._octree.removeMotionObject(this),this._octreeNode=e}},{key:"_getIndexInMotionList",value:function(){return this._indexInOctreeMotionList}},{key:"_setIndexInMotionList",value:function(e){this._indexInOctreeMotionList=e}},{key:"_changeMaterialReference",value:function(e,t){e&&e._removeReference(),t._addReference()}},{key:"_getInstanceMaterial",value:function(e,t){var n=e.clone();return n.name=n.name+"(Instance)",this._materialsInstance[t]=!0,this._changeMaterialReference(this._sharedMaterials[t],n),this._sharedMaterials[t]=n,n}},{key:"_isSupportReflection",value:function(){this._surportReflectionProbe=!1;for(var e=this._sharedMaterials,t=0,n=e.length;t<n;t++){var i=e[t];this._surportReflectionProbe=this._surportReflectionProbe||i&&i._shader._supportReflectionProbe}}},{key:"_addReflectionProbeUpdate",value:function(){this._surportReflectionProbe&&1==this._reflectionMode&&this._scene._reflectionProbeManager.addMotionObject(this)}},{key:"_applyLightMapParams",value:function(){var e=this._scene.lightmaps,t=this._shaderValues,n=this._lightmapIndex;if(n>=0&&n<e.length){var i=e[n];t.setTexture(ya.LIGHTMAP,i.lightmapColor),t.addDefine(ya.SAHDERDEFINE_LIGHTMAP),i.lightmapDirection?(t.setTexture(ya.LIGHTMAP_DIRECTION,i.lightmapDirection),t.addDefine(ya.SHADERDEFINE_LIGHTMAP_DIRECTIONAL)):t.removeDefine(ya.SHADERDEFINE_LIGHTMAP_DIRECTIONAL)}else t.removeDefine(ya.SAHDERDEFINE_LIGHTMAP),t.removeDefine(ya.SHADERDEFINE_LIGHTMAP_DIRECTIONAL)}},{key:"_onWorldMatNeedChange",value:function(e){this._boundsChange=!0,this._octreeNode&&(e&=oe.TRANSFORM_WORLDPOSITION|oe.TRANSFORM_WORLDQUATERNION|oe.TRANSFORM_WORLDSCALE)&&-1===this._indexInOctreeMotionList&&this._octreeNode._octree.addMotionObject(this),this._addReflectionProbeUpdate()}},{key:"_calculateBoundingBox",value:function(){throw"BaseRender: must override it."}},{key:"_getIndexInList",value:function(){return this._indexInList}},{key:"_setIndexInList",value:function(e){this._indexInList=e}},{key:"_setBelongScene",value:function(e){this._scene=e}},{key:"_needRender",value:function(e,t){return!0}},{key:"_OctreeNoRender",value:function(){}},{key:"_renderUpdate",value:function(e,t){}},{key:"_renderUpdateWithCamera",value:function(e,t){}},{key:"_revertBatchRenderUpdate",value:function(e){}},{key:"_destroy",value:function(){-1!==this._indexInOctreeMotionList&&this._octreeNode._octree.removeMotionObject(this),this.offAll();var e=0,t=0;for(e=0,t=this._renderElements.length;e<t;e++)this._renderElements[e].destroy();for(e=0,t=this._sharedMaterials.length;e<t;e++)this._sharedMaterials[e].destroyed||this._sharedMaterials[e]._removeReference();this._renderElements=null,this._owner=null,this._sharedMaterials=null,this._bounds=null,this._lightmapScaleOffset=null}},{key:"markAsUnStatic",value:function(){this._isPartOfStaticBatch&&(xa.instance._removeRenderSprite(this._owner),this._isPartOfStaticBatch=!1)}},{key:"id",get:function(){return this._id}},{key:"lightmapIndex",get:function(){return this._lightmapIndex},set:function(e){this._lightmapIndex=e}},{key:"lightmapScaleOffset",get:function(){return this._lightmapScaleOffset},set:function(e){if(!e)throw"BaseRender: lightmapScaleOffset can't be null.";this._lightmapScaleOffset=e,this._shaderValues.setVector(ya.LIGHTMAPSCALEOFFSET,e)}},{key:"enable",get:function(){return this._enable},set:function(e){this._enable=!!e}},{key:"material",get:function(){var e=this._sharedMaterials[0];if(e&&!this._materialsInstance[0]){var t=this._getInstanceMaterial(e,0),n=this._renderElements[0];n&&(n.material=t)}return this._sharedMaterials[0]},set:function(e){this.sharedMaterial=e,this._isSupportReflection()}},{key:"materials",get:function(){for(var e=0,t=this._sharedMaterials.length;e<t;e++)if(!this._materialsInstance[e]){var n=this._getInstanceMaterial(this._sharedMaterials[e],e),i=this._renderElements[e];i&&(i.material=n)}return this._sharedMaterials.slice()},set:function(e){this.sharedMaterials=e,this._isSupportReflection()}},{key:"sharedMaterial",get:function(){return this._sharedMaterials[0]},set:function(e){var t=this._sharedMaterials[0];if(t!==e){this._sharedMaterials[0]=e,this._materialsInstance[0]=!1,this._changeMaterialReference(t,e);var n=this._renderElements[0];n&&(n.material=e)}this._isSupportReflection()}},{key:"sharedMaterials",get:function(){return this._sharedMaterials.slice()},set:function(e){for(var t=this._materialsInstance,n=this._sharedMaterials,i=0,r=n.length;i<r;i++){var a=n[i];a&&a._removeReference()}if(!e)throw new Error("BaseRender: shadredMaterials value can't be null.");var o=e.length;for(t.length=o,n.length=o,i=0;i<o;i++){a=n[i];var s=e[i];if(a!==s){t[i]=!1;var l=this._renderElements[i];l&&(l.material=s)}s&&s._addReference(),n[i]=s}this._isSupportReflection()}},{key:"bounds",get:function(){return this._boundsChange&&(this._calculateBoundingBox(),this._boundsChange=!1),this._bounds}},{key:"receiveShadow",set:function(e){this._receiveShadow!==e&&(this._receiveShadow=e,e?this._shaderValues.addDefine(ya.SHADERDEFINE_RECEIVE_SHADOW):this._shaderValues.removeDefine(ya.SHADERDEFINE_RECEIVE_SHADOW))},get:function(){return this._receiveShadow}},{key:"castShadow",get:function(){return this._castShadow},set:function(e){this._castShadow=e}},{key:"isPartOfStaticBatch",get:function(){return this._isPartOfStaticBatch}},{key:"isRender",get:function(){return-1==this._renderMark||this._renderMark==t.Stat.loopCount-1}},{key:"reflectionMode",set:function(e){this._reflectionMode=e},get:function(){return this._reflectionMode}}]),$t}();Ma._tempBoundBoxCorners=[new D,new D,new D,new D,new D,new D,new D,new D],Ma._uniqueIDCounter=0,Ma._defaultLightmapScaleOffset=new o(1,1,0,0);var La=function(e){function ei(e){var t;return _classCallCheck(this,ei),(t=_possibleConstructorReturn(this,_getPrototypeOf(ei).call(this,e)))._projectionViewWorldMatrix=new q,t}return _inherits(ei,Ma),_createClass(ei,[{key:"_calculateBoundingBox",value:function(){var e=this._owner.transform.worldMatrix,t=this._owner._geometryFilter;t._reCalculateBound(),t._bounds._tranform(e,this._bounds)}},{key:"_renderUpdateWithCamera",value:function(e,t){var n=e.projectionViewMatrix,i=this._shaderValues;if(t){var r=t.worldMatrix;i.setMatrix4x4(Nn.WORLDMATRIX,r),q.multiply(n,r,this._projectionViewWorldMatrix),i.setMatrix4x4(Nn.MVPMATRIX,this._projectionViewWorldMatrix)}else i.setMatrix4x4(Nn.WORLDMATRIX,q.DEFAULT),i.setMatrix4x4(Nn.MVPMATRIX,n)}}]),ei}(),Oa=function(e){function ti(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:2,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return _classCallCheck(this,ti),(e=_possibleConstructorReturn(this,_getPrototypeOf(ti).call(this,n)))._isRenderActive=!1,e._isInRenders=!1,e._geometryFilter=new ga(_assertThisInitialized(e),t),e._render=new La(_assertThisInitialized(e)),e._changeRenderObjects(0,ma.defaultMaterial),e}return _inherits(ti,ya),_createClass(ti,[{key:"_onInActive",value:function(){t.Stat.spriteCount--,0!=this._geometryFilter._lineCount&&this._isRenderActive&&(this._scene._removeRenderObject(this._render),this._isInRenders=!1),this._isRenderActive=!1}},{key:"_onActive",value:function(){t.Stat.spriteCount++,this._isRenderActive=!0,0!=this._geometryFilter._lineCount&&(this._scene._addRenderObject(this._render),this._isInRenders=!0)}},{key:"_changeRenderObjects",value:function(e,t){var n=this._render._renderElements;t||(t=ma.defaultMaterial);var i=n[e];i||(i=n[e]=new ci),i.setTransform(this._transform),i.setGeometry(this._geometryFilter),i.render=this._render,i.material=t}},{key:"addLine",value:function(e,t,n,i){if(this._geometryFilter._lineCount===this._geometryFilter._maxLineCount)throw"PixelLineSprite3D: lineCount has equal with maxLineCount.";this._geometryFilter._updateLineData(this._geometryFilter._lineCount++,e,t,n,i),this._isRenderActive&&!this._isInRenders&&this._geometryFilter._lineCount>0&&(this._scene._addRenderObject(this._render),this._isInRenders=!0)}},{key:"addLines",value:function(e){var t=this._geometryFilter._lineCount,n=e.length;if(t+n>this._geometryFilter._maxLineCount)throw"PixelLineSprite3D: lineCount plus lines count must less than maxLineCount.";this._geometryFilter._updateLineDatas(t,e),this._geometryFilter._lineCount+=n,this._isRenderActive&&!this._isInRenders&&this._geometryFilter._lineCount>0&&(this._scene._addRenderObject(this._render),this._isInRenders=!0)}},{key:"removeLine",value:function(e){if(!(e<this._geometryFilter._lineCount))throw"PixelLineSprite3D: index must less than lineCount.";this._geometryFilter._removeLineData(e),this._isRenderActive&&this._isInRenders&&0==this._geometryFilter._lineCount&&(this._scene._removeRenderObject(this._render),this._isInRenders=!1)}},{key:"setLine",value:function(e,t,n,i,r){if(!(e<this._geometryFilter._lineCount))throw"PixelLineSprite3D: index must less than lineCount.";this._geometryFilter._updateLineData(e,t,n,i,r)}},{key:"getLine",value:function(e,t){if(!(e<this.lineCount))throw"PixelLineSprite3D: index must less than lineCount.";this._geometryFilter._getLineData(e,t)}},{key:"clear",value:function(){this._geometryFilter._lineCount=0,this._isRenderActive&&this._isInRenders&&(this._scene._removeRenderObject(this._render),this._isInRenders=!1)}},{key:"_create",value:function(){return new ti}},{key:"maxLineCount",get:function(){return this._geometryFilter._maxLineCount},set:function(e){this._geometryFilter._resizeLineData(e),this._geometryFilter._lineCount=Math.min(this._geometryFilter._lineCount,e)}},{key:"lineCount",get:function(){return this._geometryFilter._lineCount},set:function(e){if(e>this.maxLineCount)throw"PixelLineSprite3D: lineCount can't large than maxLineCount";this._geometryFilter._lineCount=e}},{key:"pixelLineRenderer",get:function(){return this._render}}]),ti}(),Na=function(){function ii(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];_classCallCheck(this,ii),this.isTransparent=!1,this.elements=new Ye,this.lastTransparentRenderElement=null,this.lastTransparentBatched=!1,this.isTransparent=e}return _createClass(ii,[{key:"_compare",value:function(e,t){var n=e.material.renderQueue-t.material.renderQueue;return 0===n?(this.isTransparent?t.render._distanceForSort-e.render._distanceForSort:e.render._distanceForSort-t.render._distanceForSort)+t.render.sortingFudge-e.render.sortingFudge:n}},{key:"_partitionRenderObject",value:function(e,t){for(var n=this.elements.elements,i=n[Math.floor((t+e)/2)];e<=t;){for(;this._compare(n[e],i)<0;)e++;for(;this._compare(n[t],i)>0;)t--;if(e<t){var r=n[e];n[e]=n[t],n[t]=r,e++,t--}else if(e===t){e++;break}}return e}},{key:"_quickSort",value:function(e,t){if(this.elements.length>1){var n=this._partitionRenderObject(e,t),i=n-1;e<i&&this._quickSort(e,i),n<t&&this._quickSort(n,t)}}},{key:"_render",value:function(e){for(var t=this.elements.elements,n=0,i=this.elements.length;n<i;n++)t[n]._render(e)}},{key:"clear",value:function(){this.elements.length=0,this.lastTransparentRenderElement=null,this.lastTransparentBatched=!1}}]),ii}(),Pa=function(){function ri(e,t,n,i){_classCallCheck(this,ri),this._bounds=new pa(new D,new D),this._objects=[],this._isContaion=!1,this.center=new D,this.baseLength=0,this._setValues(e,t,n,i)}return _createClass(ri,[{key:"_setValues",value:function(e,t,n,i){this._octree=e,this._parent=t,this.baseLength=n,i.cloneTo(this.center);var r=this._bounds.min,a=this._bounds.max,o=e._looseness*n/2;r.setValue(i.x-o,i.y-o,i.z-o),a.setValue(i.x+o,i.y+o,i.z+o)}},{key:"_getChildBound",value:function(e){if(null!=this._children&&this._children[e])return this._children[e]._bounds;var t=this.baseLength/4,n=this.baseLength/2*this._octree._looseness/2,i=ri._tempBoundBox,r=i.min,a=i.max;switch(e){case 0:r.x=this.center.x-t-n,r.y=this.center.y+t-n,r.z=this.center.z-t-n,a.x=this.center.x-t+n,a.y=this.center.y+t+n,a.z=this.center.z-t+n;break;case 1:r.x=this.center.x+t-n,r.y=this.center.y+t-n,r.z=this.center.z-t-n,a.x=this.center.x+t+n,a.y=this.center.y+t+n,a.z=this.center.z-t+n;break;case 2:r.x=this.center.x-t-n,r.y=this.center.y+t-n,r.z=this.center.z+t-n,a.x=this.center.x-t+n,a.y=this.center.y+t+n,a.z=this.center.z+t+n;break;case 3:r.x=this.center.x+t-n,r.y=this.center.y+t-n,r.z=this.center.z+t-n,a.x=this.center.x+t+n,a.y=this.center.y+t+n,a.z=this.center.z+t+n;break;case 4:r.x=this.center.x-t-n,r.y=this.center.y-t-n,r.z=this.center.z-t-n,a.x=this.center.x-t+n,a.y=this.center.y-t+n,a.z=this.center.z-t+n;break;case 5:r.x=this.center.x+t-n,r.y=this.center.y-t-n,r.z=this.center.z-t-n,a.x=this.center.x+t+n,a.y=this.center.y-t+n,a.z=this.center.z-t+n;break;case 6:r.x=this.center.x-t-n,r.y=this.center.y-t-n,r.z=this.center.z+t-n,a.x=this.center.x-t+n,a.y=this.center.y-t+n,a.z=this.center.z+t+n;break;case 7:r.x=this.center.x+t-n,r.y=this.center.y-t-n,r.z=this.center.z+t-n,a.x=this.center.x+t+n,a.y=this.center.y-t+n,a.z=this.center.z+t+n}return i}},{key:"_getChildCenter",value:function(e){if(null!=this._children)return this._children[e].center;var t=this.baseLength/4,n=ri._tempVector30;switch(e){case 0:n.x=this.center.x-t,n.y=this.center.y+t,n.z=this.center.z-t;break;case 1:n.x=this.center.x+t,n.y=this.center.y+t,n.z=this.center.z-t;break;case 2:n.x=this.center.x-t,n.y=this.center.y+t,n.z=this.center.z+t;break;case 3:n.x=this.center.x+t,n.y=this.center.y+t,n.z=this.center.z+t;break;case 4:n.x=this.center.x-t,n.y=this.center.y-t,n.z=this.center.z-t;break;case 5:n.x=this.center.x+t,n.y=this.center.y-t,n.z=this.center.z-t;break;case 6:n.x=this.center.x-t,n.y=this.center.y-t,n.z=this.center.z+t;break;case 7:n.x=this.center.x+t,n.y=this.center.y-t,n.z=this.center.z+t}return n}},{key:"_getChild",value:function(e){var t=this.baseLength/4;switch(this._children||(this._children=[]),e){case 0:return this._children[0]||(this._children[0]=new ri(this._octree,this,this.baseLength/2,new D(this.center.x+-t,this.center.y+t,this.center.z-t)));case 1:return this._children[1]||(this._children[1]=new ri(this._octree,this,this.baseLength/2,new D(this.center.x+t,this.center.y+t,this.center.z-t)));case 2:return this._children[2]||(this._children[2]=new ri(this._octree,this,this.baseLength/2,new D(this.center.x-t,this.center.y+t,this.center.z+t)));case 3:return this._children[3]||(this._children[3]=new ri(this._octree,this,this.baseLength/2,new D(this.center.x+t,this.center.y+t,this.center.z+t)));case 4:return this._children[4]||(this._children[4]=new ri(this._octree,this,this.baseLength/2,new D(this.center.x-t,this.center.y-t,this.center.z-t)));case 5:return this._children[5]||(this._children[5]=new ri(this._octree,this,this.baseLength/2,new D(this.center.x+t,this.center.y-t,this.center.z-t)));case 6:return this._children[6]||(this._children[6]=new ri(this._octree,this,this.baseLength/2,new D(this.center.x-t,this.center.y-t,this.center.z+t)));case 7:return this._children[7]||(this._children[7]=new ri(this._octree,this,this.baseLength/2,new D(this.center.x+t,this.center.y-t,this.center.z+t)));default:throw"BoundsOctreeNode: unknown index."}}},{key:"_shouldMerge",value:function(){for(var e=this._objects.length,t=0;t<8;t++){var n=this._children[t];if(n){if(null!=n._children)return!1;e+=n._objects.length}}return e<=ri._NUM_OBJECTS_ALLOWED}},{key:"_mergeChildren",value:function(){for(var e=0;e<8;e++){var t=this._children[e];if(t){t._parent=null;for(var n=t._objects,i=n.length-1;i>=0;i--){var r=n[i];this._objects.push(r),r._setOctreeNode(this)}}}this._children=null}},{key:"_merge",value:function(){if(null===this._children){var e=this._parent;e&&e._shouldMerge()&&(e._mergeChildren(),e._merge())}}},{key:"_checkAddNode",value:function(e){if(null==this._children){if(this._objects.length<ri._NUM_OBJECTS_ALLOWED||this.baseLength/2<this._octree._minSize)return this;for(var t=this._objects.length-1;t>=0;t--){var n=this._objects[t],i=this._bestFitChild(n.bounds.getCenter());ri._encapsulates(this._getChildBound(i),n.bounds._getBoundBox())&&(this._objects.splice(this._objects.indexOf(n),1),this._getChild(i)._add(n))}}var r=this._bestFitChild(e.bounds.getCenter());return ri._encapsulates(this._getChildBound(r),e.bounds._getBoundBox())?this._getChild(r)._checkAddNode(e):this}},{key:"_add",value:function(e){var t=this._checkAddNode(e);t._objects.push(e),e._setOctreeNode(t)}},{key:"_remove",value:function(e){var t=this._objects.indexOf(e);this._objects.splice(t,1),e._setOctreeNode(null),this._merge()}},{key:"_addUp",value:function(e){return Un.boxContainsBox(this._bounds,e.bounds._getBoundBox())===Fn.Contains?(this._add(e),!0):!!this._parent&&this._parent._addUp(e)}},{key:"_getCollidingWithFrustum",value:function(e,n,i,r,a,o){var s=e.boundFrustum,l=e.position,u=e.cullingMask;if(i){var _=s.containsBoundBox(this._bounds);if(t.Stat.octreeNodeCulling++,_===Fn.Disjoint){for(var c=0,h=this._objects.length;c<h;c++)this._objects[c]._OctreeNoRender();return}i=_===Fn.Intersects}this._isContaion=!i;var d=n.scene,f=t.Stat.loopCount;for(c=0,h=this._objects.length;c<h;c++){var m=this._objects[c];if(o?m._castShadow&&m._enable:0!=(Math.pow(2,m._owner._layer)&u)&&m._enable){if(i&&(t.Stat.frustumCulling++,!m._needRender(s,n)))continue;m._renderMark=f,m._distanceForSort=D.distance(m.bounds.getCenter(),l);for(var p=m._renderElements,v=0,E=p.length;v<E;v++)p[v]._update(d,n,r,a)}}if(null!=this._children)for(c=0;c<8;c++){var T=this._children[c];T&&T._getCollidingWithFrustum(e,n,i,r,a,o)}}},{key:"_getCollidingWithBoundBox",value:function(e,t,n){if(t){var i=Un.boxContainsBox(this._bounds,e);if(i===Fn.Disjoint)return;t=i===Fn.Intersects}if(t)for(var r=0,a=this._objects.length;r<a;r++){var o=this._objects[r];Un.intersectsBoxAndBox(o.bounds._getBoundBox(),e)&&n.push(o)}if(null!=this._children)for(r=0;r<8;r++)this._children[r]._getCollidingWithBoundBox(e,t,n)}},{key:"_bestFitChild",value:function(e){return(e.x<=this.center.x?0:1)+(e.y>=this.center.y?0:4)+(e.z<=this.center.z?0:2)}},{key:"_update",value:function(e){if(Un.boxContainsBox(this._bounds,e.bounds._getBoundBox())===Fn.Contains){var t=this._checkAddNode(e);if(t!==e._getOctreeNode()){t._objects.push(e),e._setOctreeNode(t);var n=this._objects.indexOf(e);this._objects.splice(n,1),this._merge()}return!0}if(this._parent){var i=this._parent._addUp(e);return i&&(n=this._objects.indexOf(e),this._objects.splice(n,1),this._merge()),i}return!1}},{key:"add",value:function(e){return!!ri._encapsulates(this._bounds,e.bounds._getBoundBox())&&(this._add(e),!0)}},{key:"remove",value:function(e){return e._getOctreeNode()===this&&(this._remove(e),!0)}},{key:"update",value:function(e){return e._getOctreeNode()===this&&this._update(e)}},{key:"shrinkIfPossible",value:function(e){if(this.baseLength<2*e)return this;for(var t=-1,n=0,i=this._objects.length;n<i;n++){var r=this._objects[n],a=this._bestFitChild(r.bounds.getCenter());if(0!=n&&a!=t)return this;var o=this._getChildBound(a);if(!ri._encapsulates(o,r.bounds._getBoundBox()))return this;0==n&&(t=a)}if(null==this._children){if(-1!=t){var s=this._getChildCenter(t);this._setValues(this._octree,null,this.baseLength/2,s)}return this}var l=!1;for(n=0,i=this._children.length;n<i;n++){var u=this._children[n];if(u&&u.hasAnyObjects()){if(l)return this;if(t>=0&&t!=n)return this;l=!0,t=n}}if(-1!=t){var _=this._children[t];return _._parent=null,_}return this}},{key:"hasAnyObjects",value:function(){if(this._objects.length>0)return!0;if(null!=this._children)for(var e=0;e<8;e++){var t=this._children[e];if(t&&t.hasAnyObjects())return!0}return!1}},{key:"getCollidingWithBoundBox",value:function(e,t){this._getCollidingWithBoundBox(e,!0,t)}},{key:"getCollidingWithRay",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Number.MAX_VALUE,i=Un.intersectsRayAndBoxRD(e,this._bounds);if(!(-1==i||i>n)){for(var r=0,a=this._objects.length;r<a;r++){var o=this._objects[r];-1!==(i=Un.intersectsRayAndBoxRD(e,o.bounds._getBoundBox()))&&i<=n&&t.push(o)}if(null!=this._children)for(r=0;r<8;r++)this._children[r].getCollidingWithRay(e,t,n)}}},{key:"getCollidingWithFrustum",value:function(e,t,n,i,r){this._getCollidingWithFrustum(e,t,!0,n,i,r)}},{key:"isCollidingWithBoundBox",value:function(e){if(!Un.intersectsBoxAndBox(this._bounds,e))return!1;for(var t=0,n=this._objects.length;t<n;t++){var i=this._objects[t];if(Un.intersectsBoxAndBox(i.bounds._getBoundBox(),e))return!0}if(null!=this._children)for(t=0;t<8;t++)if(this._children[t].isCollidingWithBoundBox(e))return!0;return!1}},{key:"isCollidingWithRay",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Number.MAX_VALUE,n=Un.intersectsRayAndBoxRD(e,this._bounds);if(-1==n||n>t)return!1;for(var i=0,r=this._objects.length;i<r;i++){var a=this._objects[i];if(-1!==(n=Un.intersectsRayAndBoxRD(e,a.bounds._getBoundBox()))&&n<=t)return!0}if(null!=this._children)for(i=0;i<8;i++)if(this._children[i].isCollidingWithRay(e,t))return!0;return!1}},{key:"getBound",value:function(){return this._bounds}},{key:"drawAllBounds",value:function(e,t,n){if(null!==this._children||0!=this._objects.length){t++;var i=ri._tempColor0;if(this._isContaion)i.r=0,i.g=0,i.b=1;else{var r=n?t/n:0;i.r=1-r,i.g=r,i.b=0}if(i.a=.3,gt._drawBound(e,this._bounds,i),null!=this._children)for(var a=0;a<8;a++){var o=this._children[a];o&&o.drawAllBounds(e,t,n)}}}},{key:"drawAllObjects",value:function(e,t,n){t++;var i=ri._tempColor0;if(this._isContaion)i.r=0,i.g=0,i.b=1;else{var r=n?t/n:0;i.r=1-r,i.g=r,i.b=0}i.a=1;for(var a=0,o=this._objects.length;a<o;a++)gt._drawBound(e,this._objects[a].bounds._getBoundBox(),i);if(null!=this._children)for(a=0;a<8;a++){var s=this._children[a];s&&s.drawAllObjects(e,t,n)}}}],[{key:"_encapsulates",value:function(e,t){return Un.boxContainsBox(e,t)==Fn.Contains}}]),ri}();Pa._tempVector30=new D,Pa._tempColor0=new ta,Pa._tempBoundBox=new pa(new D,new D),Pa._NUM_OBJECTS_ALLOWED=8;var ba=function(e){function ni(){return _classCallCheck(this,ni),_possibleConstructorReturn(this,_getPrototypeOf(ni).call(this))}return _inherits(ni,Ye),_createClass(ni,[{key:"add",value:function(e){if(-1!==e._getIndexInMotionList())throw"OctreeMotionList:element has  in  PhysicsUpdateList.";this._add(e),e._setIndexInMotionList(this.length++)}},{key:"remove",value:function(e){var t=e._getIndexInMotionList();if(this.length--,t!==this.length){var n=this.elements[this.length];this.elements[t]=n,n._setIndexInMotionList(t)}e._setIndexInMotionList(-1)}}]),ni}(),wa=function(){function ai(e,t,n,i){_classCallCheck(this,ai),this._motionObjects=new ba,this.count=0,n>e&&(console.warn("Minimum node size must be at least as big as the initial world size. Was: "+n+" Adjusted to: "+e),n=e),this._initialSize=e,this._minSize=n,this._looseness=Math.min(Math.max(i,1),2),this._rootNode=new Pa(this,null,e,t)}return _createClass(ai,[{key:"_getMaxDepth",value:function(e,t){t++;var n=e._children;if(null!=n)for(var i=t,r=0,a=n.length;r<a;r++){var o=n[r];o&&(t=Math.max(this._getMaxDepth(o,i),t))}return t}},{key:"_grow",value:function(e){var t=e.x>=0?1:-1,n=e.y>=0?1:-1,i=e.z>=0?1:-1,r=this._rootNode,a=this._rootNode.baseLength/2,o=2*this._rootNode.baseLength,s=this._rootNode.center,l=new D(s.x+t*a,s.y+n*a,s.z+i*a);if(this._rootNode=new Pa(this,null,o,l),r.hasAnyObjects()){for(var u=this._rootNode._bestFitChild(r.center),_=[],c=0;c<8;c++)c==u&&(r._parent=this._rootNode,_[c]=r);this._rootNode._children=_}}},{key:"add",value:function(e){for(var t=0;!this._rootNode.add(e);){var n=ai._tempVector30;if(D.subtract(e.bounds.getCenter(),this._rootNode.center,n),this._grow(n),++t>20)throw"Aborted Add operation as it seemed to be going on forever ("+(t-1)+") attempts at growing the octree."}this.count++}},{key:"remove",value:function(e){var t=e._getOctreeNode().remove(e);return t&&this.count--,t}},{key:"update",value:function(e){var t=0,n=e._getOctreeNode();if(n){for(;!n._update(e);){var i=ai._tempVector30;if(D.subtract(e.bounds.getCenter(),this._rootNode.center,i),this._grow(i),++t>20)throw"Aborted Add operation as it seemed to be going on forever ("+(t-1)+") attempts at growing the octree."}return!0}return!1}},{key:"shrinkRootIfPossible",value:function(){this._rootNode=this._rootNode.shrinkIfPossible(this._initialSize)}},{key:"addMotionObject",value:function(e){this._motionObjects.add(e)}},{key:"removeMotionObject",value:function(e){this._motionObjects.remove(e)}},{key:"updateMotionObjects",value:function(){for(var e=this._motionObjects.elements,t=0,n=this._motionObjects.length;t<n;t++){var i=e[t];this.update(i),i._setIndexInMotionList(-1)}this._motionObjects.length=0}},{key:"isCollidingWithBoundBox",value:function(e){return this._rootNode.isCollidingWithBoundBox(e)}},{key:"isCollidingWithRay",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Number.MAX_VALUE;return this._rootNode.isCollidingWithRay(e,t)}},{key:"getCollidingWithBoundBox",value:function(e,t){this._rootNode.getCollidingWithBoundBox(e,t)}},{key:"getCollidingWithRay",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Number.MAX_VALUE;this._rootNode.getCollidingWithRay(e,t,n)}},{key:"getCollidingWithFrustum",value:function(e,t,n,i,r){this._rootNode.getCollidingWithFrustum(e,t,n,i,r)}},{key:"getMaxBounds",value:function(){return this._rootNode.getBound()}},{key:"drawAllBounds",value:function(e){var t=this._getMaxDepth(this._rootNode,-1);this._rootNode.drawAllBounds(e,-1,t)}},{key:"drawAllObjects",value:function(e){var t=this._getMaxDepth(this._rootNode,-1);this._rootNode.drawAllObjects(e,-1,t)}}]),ai}();wa._tempVector30=new D;var ka=function si(){_classCallCheck(this,si)},Va=function(){function oi(e,t){_classCallCheck(this,oi),this.center=e,this.radius=t}return _createClass(oi,[{key:"toDefault",value:function(){this.center.toDefault(),this.radius=0}},{key:"intersectsRayDistance",value:function(e){return Un.intersectsRayAndSphereRD(e,this)}},{key:"intersectsRayPoint",value:function(e,t){return Un.intersectsRayAndSphereRP(e,this,t)}},{key:"cloneTo",value:function(e){var t=e;this.center.cloneTo(t.center),t.radius=this.radius}},{key:"clone",value:function(){var e=new oi(new D,0);return this.cloneTo(e),e}}],[{key:"createFromSubPoints",value:function(e,t,n,i){if(null==e)throw new Error("points");if(t<0||t>=e.length)throw new Error("start"+t+"Must be in the range [0, "+(e.length-1)+"]");if(n<0||t+n>e.length)throw new Error("count"+n+"Must be in the range <= "+e.length+"}");var r=t+n,a=oi._tempVector3;a.x=0,a.y=0,a.z=0;for(var o=t;o<r;++o)D.add(e[o],a,a);var s=i.center;D.scale(a,1/n,s);var l=0;for(o=t;o<r;++o){var u=D.distanceSquared(s,e[o]);u>l&&(l=u)}i.radius=Math.sqrt(l)}},{key:"createfromPoints",value:function(e,t){if(null==e)throw new Error("points");oi.createFromSubPoints(e,0,e.length,t)}}]),oi}();Va._tempVector3=new D;var Ba=function li(){_classCallCheck(this,li),this.cameraShaderValue=new En,this.position=new D,this.viewMatrix=new q,this.projectionMatrix=new q,this.viewProjectMatrix=new q,this.cullPlanes=[new Vn(new D),new Vn(new D),new Vn(new D),new Vn(new D),new Vn(new D),new Vn(new D),new Vn(new D),new Vn(new D),new Vn(new D),new Vn(new D)],this.splitBoundSphere=new Va(new D,0)},Fa=function hi(){_classCallCheck(this,hi),this.cameraShaderValue=new En,this.position=new D,this.viewMatrix=new q,this.projectionMatrix=new q,this.viewProjectMatrix=new q,this.cameraCullInfo=new na};(fr=e.ShadowLightType||(e.ShadowLightType={}))[fr.DirectionLight=0]="DirectionLight",fr[fr.SpotLight=1]="SpotLight",fr[fr.PointLight=2]="PointLight";var Ua=function(){function _i(){_classCallCheck(this,_i),this._shadowBias=new o,this._shadowParams=new o,this._shadowMapSize=new o,this._shadowSpotMapSize=new o,this._shadowMatrices=new Float32Array(16*_i._maxCascades),this._shadowSpotMatrices=new q,this._splitBoundSpheres=new Float32Array(4*_i._maxCascades),this._cascadeCount=0,this._shadowMapWidth=0,this._shadowMapHeight=0,this._shadowSliceDatas=[new Ba,new Ba,new Ba,new Ba],this._shadowSpotData=new Fa,this._lightUp=new D,this._lightSide=new D,this._lightForward=new D,this._shadowSpotData.cameraCullInfo.boundFrustum=new Gn(new q)}return _createClass(_i,[{key:"_setupShadowCasterShaderValues",value:function(t,n,i,r,a,o,s){switch(n.setVector(_i.SHADOW_BIAS,o),s){case e.LightType.Directional:n.setVector3(_i.SHADOW_LIGHT_DIRECTION,r);break;case e.LightType.Spot:n.setVector(_i.SHADOW_PARAMS,a);break;case e.LightType.Point:}var l=i.cameraShaderValue;l.setMatrix4x4(qn.VIEWMATRIX,i.viewMatrix),l.setMatrix4x4(qn.PROJECTMATRIX,i.projectionMatrix),l.setMatrix4x4(qn.VIEWPROJECTMATRIX,i.viewProjectMatrix),t.viewMatrix=i.viewMatrix,t.projectionMatrix=i.projectionMatrix,t.projectionViewMatrix=i.viewProjectMatrix}},{key:"_setupShadowReceiverShaderValues",value:function(t){var n=this._light;switch(n.shadowCascadesMode!==e.ShadowCascadesMode.NoCascades?t.addDefine(Qn.SHADERDEFINE_SHADOW_CASCADE):t.removeDefine(Qn.SHADERDEFINE_SHADOW_CASCADE),n.shadowMode){case e.ShadowMode.Hard:t.removeDefine(Qn.SHADERDEFINE_SHADOW_SOFT_SHADOW_LOW),t.removeDefine(Qn.SHADERDEFINE_SHADOW_SOFT_SHADOW_HIGH);break;case e.ShadowMode.SoftLow:t.addDefine(Qn.SHADERDEFINE_SHADOW_SOFT_SHADOW_LOW),t.removeDefine(Qn.SHADERDEFINE_SHADOW_SOFT_SHADOW_HIGH);break;case e.ShadowMode.SoftHigh:t.addDefine(Qn.SHADERDEFINE_SHADOW_SOFT_SHADOW_HIGH),t.removeDefine(Qn.SHADERDEFINE_SHADOW_SOFT_SHADOW_LOW)}t.setTexture(_i.SHADOW_MAP,this._shadowDirectLightMap),t.setBuffer(_i.SHADOW_MATRICES,this._shadowMatrices),t.setVector(_i.SHADOW_MAP_SIZE,this._shadowMapSize),t.setVector(_i.SHADOW_PARAMS,this._shadowParams),t.setBuffer(_i.SHADOW_SPLIT_SPHERES,this._splitBoundSpheres)}},{key:"_setupSpotShadowReceiverShaderValues",value:function(t){switch(this._light.shadowMode){case e.ShadowMode.Hard:t.removeDefine(Qn.SHADERDEFINE_SHADOW_SPOT_SOFT_SHADOW_HIGH),t.removeDefine(Qn.SHADERDEFINE_SHADOW_SPOT_SOFT_SHADOW_LOW);break;case e.ShadowMode.SoftLow:t.addDefine(Qn.SHADERDEFINE_SHADOW_SPOT_SOFT_SHADOW_LOW),t.removeDefine(Qn.SHADERDEFINE_SHADOW_SPOT_SOFT_SHADOW_HIGH);break;case e.ShadowMode.SoftHigh:t.addDefine(Qn.SHADERDEFINE_SHADOW_SPOT_SOFT_SHADOW_HIGH),t.removeDefine(Qn.SHADERDEFINE_SHADOW_SPOT_SOFT_SHADOW_LOW)}t.setTexture(_i.SHADOW_SPOTMAP,this._shadowSpotLightMap),t.setMatrix4x4(_i.SHADOW_SPOTMATRICES,this._shadowSpotMatrices),t.setVector(_i.SHADOW_SPOTMAP_SIZE,this._shadowSpotMapSize),t.setVector(_i.SHADOW_PARAMS,this._shadowParams)}},{key:"update",value:function(t,n,r){switch(r){case e.ShadowLightType.DirectionLight:this._light=n;var a=(C=_i._tempMatrix0).elements,o=this._lightUp,s=this._lightSide,l=this._lightForward;q.createFromQuaternion(n._transform.rotation,C),s.setValue(a[0],a[1],a[2]),o.setValue(a[4],a[5],a[6]),l.setValue(-a[8],-a[9],-a[10]);var u,_,c,h,d=n._shadowResolution,f=n._shadowCascadesMode;f==e.ShadowCascadesMode.NoCascades?(u=1,_=d,c=d,h=d):(u=f==e.ShadowCascadesMode.TwoCascades?2:4,c=2*(_=Jn.getMaxTileResolutionInAtlas(d,d,u)),h=f==e.ShadowCascadesMode.TwoCascades?_:2*_),this._cascadeCount=u,this._shadowMapWidth=c,this._shadowMapHeight=h;var m=_i._cascadesSplitDistance,p=_i._frustumPlanes,v=t.nearPlane,E=Math.min(t.farPlane,n._shadowDistance),T=this._shadowMatrices,g=this._splitBoundSpheres;Jn.getCascadesSplitDistance(n._shadowTwoCascadeSplits,n._shadowFourCascadeSplits,v,E,t.fieldOfView*i.Deg2Rad,t.aspectRatio,f,m),Jn.getCameraFrustumPlanes(t.projectionViewMatrix,p);var y=_i._tempVector30;t._transform.getForward(y),D.normalize(y,y);for(var S=0;S<u;S++){var R=this._shadowSliceDatas[S];R.sphereCenterZ=Jn.getBoundSphereByFrustum(m[S],m[S+1],t.fieldOfView*i.Deg2Rad,t.aspectRatio,t._transform.position,y,R.splitBoundSphere),Jn.getDirectionLightShadowCullPlanes(p,S,m,v,l,R),Jn.getDirectionalLightMatrices(o,s,l,S,n._shadowNearPlane,_,R,T),u>1&&Jn.applySliceTransform(R,c,h,S,T)}Jn.prepareShadowReceiverShaderValues(n,c,h,this._shadowSliceDatas,u,this._shadowMapSize,this._shadowParams,T,g);break;case e.ShadowLightType.SpotLight:this._light=n;var C=_i._tempMatrix0,A=(l=this._lightForward,this._light._shadowResolution);this._shadowMapWidth=A,this._shadowMapHeight=A;var I=this._shadowSpotData;Jn.getSpotLightShadowData(I,this._light,A,this._shadowParams,this._shadowSpotMatrices,this._shadowSpotMapSize);break;case e.ShadowLightType.PointLight:break;default:throw"There is no shadow of this type"}}},{key:"render",value:function(n,i,r){switch(r){case e.ShadowLightType.DirectionLight:var a=i._shaderValues;n.pipelineMode="ShadowCaster",En.setRuntimeValueMode(!1),(p=this._shadowDirectLightMap=Jn.getTemporaryShadowTexture(this._shadowMapWidth,this._shadowMapHeight,t.RenderTextureDepthFormat.DEPTH_16))._start();for(var o=this._light,s=0,l=this._cascadeCount;s<l;s++){var u=this._shadowSliceDatas[s];Jn.getShadowBias(o,u.projectionMatrix,u.resolution,this._shadowBias),this._setupShadowCasterShaderValues(n,a,u,this._lightForward,this._shadowParams,this._shadowBias,e.LightType.Directional);var _=ra._shadowCullInfo;_.position=u.position,_.cullPlanes=u.cullPlanes,_.cullPlaneCount=u.cullPlaneCount,_.cullSphere=u.splitBoundSphere,_.direction=this._lightForward;var c=ra.cullingShadow(_,i,n);n.cameraShaderValue=u.cameraShaderValue,si._updateMark++;var h=t.LayaGL.instance,d=u.resolution,f=u.offsetX,m=u.offsetY;h.enable(h.SCISSOR_TEST),h.viewport(f,m,d,d),h.scissor(f,m,d,d),h.clear(h.DEPTH_BUFFER_BIT),c&&(h.scissor(f+1,m+1,d-2,d-2),i._opaqueQueue._render(n))}p._end(),this._setupShadowReceiverShaderValues(a),En.setRuntimeValueMode(!0),n.pipelineMode=n.configPipeLineMode;break;case e.ShadowLightType.SpotLight:a=i._shaderValues,n.pipelineMode="ShadowCaster",En.setRuntimeValueMode(!1);var p,v=this._light;(p=this._shadowSpotLightMap=Jn.getTemporaryShadowTexture(this._shadowMapWidth,this._shadowMapHeight,t.RenderTextureDepthFormat.DEPTH_16))._start();var E=this._shadowSpotData;Jn.getShadowBias(v,E.projectionMatrix,E.resolution,this._shadowBias),this._setupShadowCasterShaderValues(n,a,E,this._light.transform.position,this._shadowParams,this._shadowBias,e.LightType.Spot),c=ra.cullingSpotShadow(E.cameraCullInfo,i,n),n.cameraShaderValue=E.cameraShaderValue,si._updateMark++,(h=t.LayaGL.instance).enable(h.SCISSOR_TEST),h.viewport(E.offsetX,E.offsetY,E.resolution,E.resolution),h.scissor(E.offsetX,E.offsetY,E.resolution,E.resolution),h.clear(h.DEPTH_BUFFER_BIT),c&&(h.scissor(E.offsetX,E.offsetY,E.resolution,E.resolution),i._opaqueQueue._render(n)),p._end(),this._setupSpotShadowReceiverShaderValues(a),En.setRuntimeValueMode(!0),n.pipelineMode=n.configPipeLineMode;break;case e.ShadowLightType.PointLight:break;default:throw"There is no shadow of this type"}}},{key:"cleanUp",value:function(){this._shadowDirectLightMap&&fn.recoverToPool(this._shadowDirectLightMap),this._shadowSpotLightMap&&fn.recoverToPool(this._shadowSpotLightMap),this._shadowDirectLightMap=null,this._shadowSpotLightMap=null,this._light=null}}]),_i}();Ua._tempVector30=new D,Ua._tempMatrix0=new q,Ua.SHADOW_BIAS=xn.propertyNameToID("u_ShadowBias"),Ua.SHADOW_LIGHT_DIRECTION=xn.propertyNameToID("u_ShadowLightDirection"),Ua.SHADOW_SPLIT_SPHERES=xn.propertyNameToID("u_ShadowSplitSpheres"),Ua.SHADOW_MATRICES=xn.propertyNameToID("u_ShadowMatrices"),Ua.SHADOW_MAP_SIZE=xn.propertyNameToID("u_ShadowMapSize"),Ua.SHADOW_MAP=xn.propertyNameToID("u_ShadowMap"),Ua.SHADOW_PARAMS=xn.propertyNameToID("u_ShadowParams"),Ua.SHADOW_SPOTMAP_SIZE=xn.propertyNameToID("u_SpotShadowMapSize"),Ua.SHADOW_SPOTMAP=xn.propertyNameToID("u_SpotShadowMap"),Ua.SHADOW_SPOTMATRICES=xn.propertyNameToID("u_SpotViewProjectMatrix"),Ua._maxCascades=4,Ua._cascadesSplitDistance=new Array(Ua._maxCascades+1),Ua._frustumPlanes=new Array(new Vn(new D),new Vn(new D),new Vn(new D),new Vn(new D),new Vn(new D),new Vn(new D));var Ga=function(){function ci(){_classCallCheck(this,ci),this._batchRenderElementPool=[]}return _createClass(ci,[{key:"_clear",value:function(){this._batchRenderElementPoolIndex=0}},{key:"_getBatchRenderElementFromPool",value:function(){throw"StaticBatch:must override this function."}},{key:"dispose",value:function(){}}],[{key:"_registerManager",value:function(e){ci._managers.push(e)}}]),ci}();Ga._managers=[];var Ha=function(e){function di(){return _classCallCheck(this,di),_possibleConstructorReturn(this,_getPrototypeOf(di).call(this))}return _inherits(di,Ye),_createClass(di,[{key:"add",value:function(e){this._add(e),e._setIndexInReflectionList(this.length++)}},{key:"remove",value:function(e){var t=e._getIndexInReflectionList();if(this.length--,t!==this.length){var n=this.elements[this.length];this.elements[t]=n,n._setIndexInReflectionList(t)}e._setIndexInReflectionList(-1)}}]),di}(),za=function(){function ui(){_classCallCheck(this,ui),this._reflectionProbes=new Ha,this._motionObjects=new Ye,this._needUpdateAllRender=!1,this._sceneReflectionProbe=new Da,this._sceneReflectionProbe.bounds=new va(new D(0,0,0),new D(0,0,0)),this._sceneReflectionProbe.boxProjection=!1,this._sceneReflectionProbe._isScene=!0}return _createClass(ui,[{key:"_updateMotionObjects",value:function(e){if(0!=this._reflectionProbes.length){for(var t,n,i=this._reflectionProbes.elements,r=0,a=e.bounds,o=0,s=this._reflectionProbes.length;o<s;o++){var l=i[o];if(t){if(t.importance>l.importance)continue;if((n=a.calculateBoundsintersection(l.bounds))<r&&t.importance==l.importance)continue}else if((n=a.calculateBoundsintersection(l.bounds))<r)continue;t=l,r=n}!t&&this._sceneReflectionProbe&&(t=this._sceneReflectionProbe),e._probReflection=t}else e._probReflection=this._sceneReflectionProbe}},{key:"add",value:function(e){this._reflectionProbes.add(e),this._needUpdateAllRender=!0}},{key:"remove",value:function(e){this._reflectionProbes.remove(e),this._needUpdateAllRender=!0}},{key:"addMotionObject",value:function(e){this._motionObjects.add(e)}},{key:"update",value:function(){for(var e=this._motionObjects.elements,t=0,n=this._motionObjects.length;t<n;t++)this._updateMotionObjects(e[t]);this.clearMotionObjects()}},{key:"updateAllRenderObjects",value:function(e){for(var t=e.elements,n=0,i=e.length;n<i;n++)this._updateMotionObjects(t[n]);this._needUpdateAllRender=!1}},{key:"clearMotionObjects",value:function(){this._motionObjects.length=0}},{key:"destroy",value:function(){}},{key:"sceneReflectionProbe",set:function(e){this._sceneReflectionProbe.reflectionTexture=e}},{key:"sceneReflectionCubeHDRParam",set:function(e){this._sceneReflectionProbe.reflectionHDRParams=e}}]),ui}();(vr=e.AmbientMode||(e.AmbientMode={}))[vr.SolidColor=0]="SolidColor",vr[vr.SphericalHarmonics=1]="SphericalHarmonics";var Wa=function(n){function mi(){var n;_classCallCheck(this,mi),(n=_possibleConstructorReturn(this,_getPrototypeOf(mi).call(this)))._lightCount=0,n._pointLights=new da,n._spotLights=new da,n._directionLights=new da,n._alternateLights=new fa,n._lightmaps=[],n._skyRenderer=new Zn,n._input=new la,n._timer=t.ILaya.timer,n._time=0,n._shCoefficients=new Array(7),n._ambientMode=e.AmbientMode.SolidColor,n._ambientSphericalHarmonics=new aa,n._ambientSphericalHarmonicsIntensity=1,n._reflectionDecodeFormat=t.TextureDecodeFormat.Normal,n._reflectionIntensity=1,n._collsionTestList=[],n._renders=new ea,n._opaqueQueue=new Na(!1),n._transparentQueue=new Na(!0),n._cameraPool=[],n._animatorPool=new ea,n._scriptPool=new Array,n._tempScriptPool=new Array,n._needClearScriptPool=!1,n._reflectionCubeHDRParams=new o,n._reflectionProbeManager=new za,n.currentCreationLayer=Math.pow(2,0),n.enableLight=!0,n._key=new t.SubmitKey,n._pickIdToSprite=new Object,n._reflectionMode=0,!It._config.isUseCannonPhysicsEngine&&Ct._bullet?n._physicsSimulation=new Et(mi.physicsSettings):Ct._cannon&&(n._cannonPhysicsSimulation=new t.CannonPhysicsSimulation(mi.cannonPhysicsSettings)),n._shaderValues=new En(null),n.enableFog=!1,n.fogStart=300,n.fogRange=1e3,n.fogColor=new D(.7,.7,.7),n.ambientColor=new D(.212,.227,.259),n.reflectionIntensity=1,n.reflection=ha.blackTexture;for(var i=0;i<7;i++)n._shCoefficients[i]=new o;if(n._reflectionProbeManager.sceneReflectionCubeHDRParam=n._reflectionCubeHDRParams,n._scene=_assertThisInitialized(n),n._input.__init__(t.Render.canvas,_assertThisInitialized(n)),mi.octreeCulling&&(n._octree=new wa(mi.octreeInitialSize,mi.octreeInitialCenter,mi.octreeMinNodeSize,mi.octreeLooseness)),ra.debugFrustumCulling){n._debugTool=new Oa;var r=new ma;r.renderQueue=Gi.RENDERQUEUE_TRANSPARENT,r.alphaTest=!1,r.depthWrite=!1,r.cull=Wi.CULL_BACK,r.blend=Wi.BLEND_ENABLE_ALL,r.blendSrc=Wi.BLENDPARAM_SRC_ALPHA,r.blendDst=Wi.BLENDPARAM_ONE_MINUS_SRC_ALPHA,r.depthTest=Wi.DEPTHTEST_LESS,n._debugTool.pixelLineRenderer.sharedMaterial=r}return n}return _inherits(mi,t.Sprite),_createClass(mi,[{key:"_applySHCoefficients",value:function(e,t){for(var n=this._shCoefficients,i=0;i<3;i++){var r=n[i],a=n[i+3];r.setValue(e.getCoefficient(i,3)*t,e.getCoefficient(i,1)*t,e.getCoefficient(i,2)*t,(e.getCoefficient(i,0)-e.getCoefficient(i,6))*t),a.setValue(e.getCoefficient(i,4)*t,e.getCoefficient(i,5)*t,3*e.getCoefficient(i,6)*t,e.getCoefficient(i,7)*t)}n[6].setValue(e.getCoefficient(0,8)*t,e.getCoefficient(1,8)*t,e.getCoefficient(2,8)*t,1);var o=this._shaderValues;o.setVector(mi.AMBIENTSHAR,n[0]),o.setVector(mi.AMBIENTSHAG,n[1]),o.setVector(mi.AMBIENTSHAB,n[2]),o.setVector(mi.AMBIENTSHBR,n[3]),o.setVector(mi.AMBIENTSHBG,n[4]),o.setVector(mi.AMBIENTSHBB,n[5]),o.setVector(mi.AMBIENTSHC,n[6])}},{key:"_update",value:function(){var e=this.timer._delta/1e3;this._time+=e,this._shaderValues.setNumber(mi.TIME,this._time);var n=this._physicsSimulation;if(!Ct._enablePhysics||Et.disableSimulation||It._config.isUseCannonPhysicsEngine||(n._updatePhysicsTransformFromRender(),ze._addUpdateList=!1,n._simulate(e),n._updateCharacters(),ze._addUpdateList=!0,n._updateCollisions(),n._eventScripts()),Ct._cannon&&It._config.isUseCannonPhysicsEngine){var i=this._cannonPhysicsSimulation;i._updatePhysicsTransformFromRender(),t.CannonPhysicsComponent._addUpdateList=!1,i._simulate(e),t.CannonPhysicsComponent._addUpdateList=!0,i._updateCollisions(),i._eventScripts()}this._input._update(),this._clearScript(),this._updateScript(),hn._update(this),t.VideoTexture._update(),this._reflectionProbeManager._needUpdateAllRender?this._reflectionProbeManager.updateAllRenderObjects(this._renders):this._reflectionProbeManager.update(),this._lateUpdateScript()}},{key:"_binarySearchIndexInCameraPool",value:function(e){for(var t,n=0,i=this._cameraPool.length-1;n<=i;){t=Math.floor((n+i)/2);var r=this._cameraPool[t]._renderingOrder;if(r==e._renderingOrder)return t;r>e._renderingOrder?i=t-1:n=t+1}return n}},{key:"_allotPickColorByID",value:function(e,t){var n=Math.floor(e/65025);e-=255*n*255;var i=Math.floor(e/255),r=e-=255*i;t.x=n/255,t.y=i/255,t.z=r/255,t.w=1}},{key:"_searchIDByPickColor",value:function(e){return 255*e.x*255+255*e.y+e.z}},{key:"onEnable",value:function(){this._input._onCanvasEvent(t.Render.canvas)}},{key:"onDisable",value:function(){this._input._offCanvasEvent(t.Render.canvas)}},{key:"_setCreateURL",value:function(e){this._url=t.URL.formatURL(e)}},{key:"_getGroup",value:function(){return this._group}},{key:"_setGroup",value:function(e){this._group=e}},{key:"_clearScript",value:function(){if(this._needClearScriptPool){for(var e=this._scriptPool,t=0,n=e.length;t<n;t++){var i=e[t];i&&(i._indexInPool=this._tempScriptPool.length,this._tempScriptPool.push(i))}this._scriptPool=this._tempScriptPool,e.length=0,this._tempScriptPool=e,this._needClearScriptPool=!1}}},{key:"_updateScript",value:function(){for(var e=this._scriptPool,t=0,n=e.length;t<n;t++){var i=e[t];i&&i.enabled&&i.onUpdate()}}},{key:"_lateUpdateScript",value:function(){for(var e=this._scriptPool,t=0,n=e.length;t<n;t++){var i=e[t];i&&i.enabled&&i.onLateUpdate()}}},{key:"_onActive",value:function(){_get(_getPrototypeOf(mi.prototype),"_onActive",this).call(this),t.ILaya.stage._scene3Ds.push(this)}},{key:"_onInActive",value:function(){_get(_getPrototypeOf(mi.prototype),"_onInActive",this).call(this);var e=t.ILaya.stage._scene3Ds;e.splice(e.indexOf(this),1)}},{key:"_prepareSceneToRender",value:function(){var e=this._shaderValues;if(It._config._multiLighting){var t=mi._lightTexture,n=mi._lightPixles,i=t.width,r=4*i,a=0,o=this._directionLights._length,s=this._directionLights._elements;if(o>0){var l=this._directionLights.getBrightestLight();this._mainDirectionLight=s[l],this._directionLights.normalLightOrdering(l);for(var u=0;u<o;u++,a++){var _=(y=s[u])._direction,c=y._intensityColor,h=r*a;D.scale(y.color,y._intensity,c),y.transform.worldMatrix.getForward(_),D.normalize(_,_),n[h]=c.x,n[h+1]=c.y,n[h+2]=c.z,n[h+4]=_.x,n[h+5]=_.y,n[h+6]=_.z,0==u&&(e.setVector3(mi.SUNLIGHTDIRCOLOR,c),e.setVector3(mi.SUNLIGHTDIRECTION,_))}e.addDefine(Qn.SHADERDEFINE_DIRECTIONLIGHT)}else e.removeDefine(Qn.SHADERDEFINE_DIRECTIONLIGHT);var d=this._pointLights._length;if(d>0){var f=this._pointLights._elements,m=this._pointLights.getBrightestLight();for(this._mainPointLight=f[m],this._pointLights.normalLightOrdering(m),u=0;u<d;u++,a++){var p=(S=f[u]).transform.position;c=S._intensityColor,h=r*a,D.scale(S.color,S._intensity,c),n[h]=c.x,n[h+1]=c.y,n[h+2]=c.z,n[h+3]=S.range,n[h+4]=p.x,n[h+5]=p.y,n[h+6]=p.z}e.addDefine(Qn.SHADERDEFINE_POINTLIGHT)}else e.removeDefine(Qn.SHADERDEFINE_POINTLIGHT);var v=this._spotLights._length;if(v>0){var E=this._spotLights._elements,T=this._spotLights.getBrightestLight();for(this._mainSpotLight=E[T],this._spotLights.normalLightOrdering(T),u=0;u<v;u++,a++){var g=E[u];_=g._direction,p=g.transform.position,c=g._intensityColor,h=r*a,D.scale(g.color,g._intensity,c),g.transform.worldMatrix.getForward(_),D.normalize(_,_),n[h]=c.x,n[h+1]=c.y,n[h+2]=c.z,n[h+3]=g.range,n[h+4]=p.x,n[h+5]=p.y,n[h+6]=p.z,n[h+7]=g.spotAngle*Math.PI/180,n[h+8]=_.x,n[h+9]=_.y,n[h+10]=_.z}e.addDefine(Qn.SHADERDEFINE_SPOTLIGHT)}else e.removeDefine(Qn.SHADERDEFINE_SPOTLIGHT);a>0&&t.setSubPixels(0,0,i,a,n,0),e.setTexture(mi.LIGHTBUFFER,t),e.setInt(mi.DIRECTIONLIGHTCOUNT,this._directionLights._length),e.setTexture(mi.CLUSTERBUFFER,kn.instance._clusterTexture)}else{if(this._directionLights._length>0){var y=this._directionLights._elements[0];this._mainDirectionLight=y,D.scale(y.color,y._intensity,y._intensityColor),y.transform.worldMatrix.getForward(y._direction),D.normalize(y._direction,y._direction),e.setVector3(mi.LIGHTDIRCOLOR,y._intensityColor),e.setVector3(mi.LIGHTDIRECTION,y._direction),e.setVector3(mi.SUNLIGHTDIRCOLOR,y._intensityColor),e.setVector3(mi.SUNLIGHTDIRECTION,y._direction),e.addDefine(Qn.SHADERDEFINE_DIRECTIONLIGHT)}else e.removeDefine(Qn.SHADERDEFINE_DIRECTIONLIGHT);if(this._pointLights._length>0){var S=this._pointLights._elements[0];this._mainPointLight=S,D.scale(S.color,S._intensity,S._intensityColor),e.setVector3(mi.POINTLIGHTCOLOR,S._intensityColor),e.setVector3(mi.POINTLIGHTPOS,S.transform.position),e.setNumber(mi.POINTLIGHTRANGE,S.range),e.addDefine(Qn.SHADERDEFINE_POINTLIGHT)}else e.removeDefine(Qn.SHADERDEFINE_POINTLIGHT);if(this._spotLights._length>0){var R=this._spotLights._elements[0];this._mainSpotLight=R,D.scale(R.color,R._intensity,R._intensityColor),e.setVector3(mi.SPOTLIGHTCOLOR,R._intensityColor),e.setVector3(mi.SPOTLIGHTPOS,R.transform.position),R.transform.worldMatrix.getForward(R._direction),D.normalize(R._direction,R._direction),e.setVector3(mi.SPOTLIGHTDIRECTION,R._direction),e.setNumber(mi.SPOTLIGHTRANGE,R.range),e.setNumber(mi.SPOTLIGHTSPOTANGLE,R.spotAngle*Math.PI/180),e.addDefine(Qn.SHADERDEFINE_SPOTLIGHT)}else e.removeDefine(Qn.SHADERDEFINE_SPOTLIGHT)}}},{key:"_addScript",value:function(e){var t=this._scriptPool;e._indexInPool=t.length,t.push(e)}},{key:"_removeScript",value:function(e){this._scriptPool[e._indexInPool]=null,e._indexInPool=-1,this._needClearScriptPool=!0}},{key:"_preRenderScript",value:function(){for(var e=this._scriptPool,t=0,n=e.length;t<n;t++){var i=e[t];i&&i.enabled&&i.onPreRender()}}},{key:"_postRenderScript",value:function(){for(var e=this._scriptPool,t=0,n=e.length;t<n;t++){var i=e[t];i&&i.enabled&&i.onPostRender()}}},{key:"_addCamera",value:function(e){for(var t=this._binarySearchIndexInCameraPool(e),n=e._renderingOrder,i=this._cameraPool.length;t<i&&this._cameraPool[t]._renderingOrder<=n;)t++;this._cameraPool.splice(t,0,e)}},{key:"_removeCamera",value:function(e){this._cameraPool.splice(this._cameraPool.indexOf(e),1)}},{key:"_preCulling",value:function(e,t,n,i){var r=ra._cameraCullInfo;r.position=t._transform.position,r.cullingMask=t.cullingMask,r.boundFrustum=t.boundFrustum,r.useOcclusionCulling=t.useOcclusionCulling,ra.renderObjectCulling(r,this,e,n,i,!1)}},{key:"_clear",value:function(n,i){var r,a,o,s=i.viewport,l=i.camera,u=l._getRenderTexture(),_=s.width,c=s.height;l._needInternalRenderTexture()?(r=0,a=0):(r=s.x,a=l._getCanvasHeight()-s.y-c),n.viewport(r,a,_,c);var h=l.clearFlag;switch(h!==e.CameraClearFlags.Sky||l.skyRenderer._isAvailable()||this._skyRenderer._isAvailable()||(h=e.CameraClearFlags.SolidColor),h){case e.CameraClearFlags.SolidColor:var d=l.clearColor;if(n.enable(n.SCISSOR_TEST),n.scissor(r,a,_,c),d?n.clearColor(d.x,d.y,d.z,d.w):n.clearColor(0,0,0,0),u)switch(o=n.COLOR_BUFFER_BIT,u.depthStencilFormat){case t.RenderTextureDepthFormat.DEPTH_16:o|=n.DEPTH_BUFFER_BIT;break;case t.RenderTextureDepthFormat.STENCIL_8:o|=n.STENCIL_BUFFER_BIT;break;case t.RenderTextureDepthFormat.DEPTHSTENCIL_24_8:o|=n.DEPTH_BUFFER_BIT,o|=n.STENCIL_BUFFER_BIT}else o=n.COLOR_BUFFER_BIT|n.DEPTH_BUFFER_BIT;t.WebGLContext.setDepthMask(n,!0),n.clear(o),n.disable(n.SCISSOR_TEST);break;case e.CameraClearFlags.Sky:case e.CameraClearFlags.DepthOnly:if(n.enable(n.SCISSOR_TEST),n.scissor(r,a,_,c),u)switch(u.depthStencilFormat){case t.RenderTextureDepthFormat.DEPTH_16:o=n.DEPTH_BUFFER_BIT;break;case t.RenderTextureDepthFormat.STENCIL_8:o=n.STENCIL_BUFFER_BIT;break;case t.RenderTextureDepthFormat.DEPTHSTENCIL_24_8:o=n.DEPTH_BUFFER_BIT|n.STENCIL_BUFFER_BIT}else o=n.DEPTH_BUFFER_BIT;t.WebGLContext.setDepthMask(n,!0),n.clear(o),n.disable(n.SCISSOR_TEST);break;case e.CameraClearFlags.Nothing:break;default:throw new Error("Scene3D:camera clearFlag invalid.")}}},{key:"_renderScene",value:function(t,n){var i=t.camera;switch(n){case mi.SCENERENDERFLAG_RENDERQPAQUE:this._opaqueQueue._render(t);break;case mi.SCENERENDERFLAG_SKYBOX:i.clearFlag===e.CameraClearFlags.Sky&&(i.skyRenderer._isAvailable()?i.skyRenderer._render(t):this._skyRenderer._isAvailable()&&this._skyRenderer._render(t));break;case mi.SCENERENDERFLAG_RENDERTRANSPARENT:if(this._transparentQueue._render(t),ra.debugFrustumCulling)for(var r=this._debugTool._render._renderElements,a=0,o=r.length;a<o;a++)r[a]._update(this,t,null,null),r[a]._render(t)}}},{key:"_parse",value:function(e,n){var i=e.lightmaps;if(i){for(var r=i.length,a=new Array(r),o=0;o<r;o++){var s=new ka,l=i[o];l.path?s.lightmapColor=t.Loader.getRes(l.path):(s.lightmapColor=t.Loader.getRes(l.color.path),l.direction&&(s.lightmapDirection=t.Loader.getRes(l.direction.path))),a[o]=s}this.lightmaps=a}var u=e.ambientColor;if(u){var _=this.ambientColor;_.fromArray(u),this.ambientColor=_}var c=e.sky;if(c)switch(this._skyRenderer.material=t.Loader.getRes(c.material.path),c.mesh){case"SkyBox":this._skyRenderer.mesh=jn.instance;break;case"SkyDome":this._skyRenderer.mesh=ca.instance;break;default:this.skyRenderer.mesh=jn.instance}this.enableFog=e.enableFog,this.fogStart=e.fogStart,this.fogRange=e.fogRange;var h=e.fogColor;if(h){var d=this.fogColor;d.fromArray(h),this.fogColor=d}var f=e.ambientSphericalHarmonics;if(f){var m=this.ambientSphericalHarmonics;for(o=0;o<3;o++){var p=9*o;m.setCoefficients(o,f[p],f[p+1],f[p+2],f[p+3],f[p+4],f[p+5],f[p+6],f[p+7],f[p+8])}this.ambientSphericalHarmonics=m}var v=e.reflection;null!=v&&(this.reflection=t.Loader.getRes(v));var E=e.reflectionDecodingFormat;null!=E&&(this.reflectionDecodingFormat=E);var T=e.ambientMode;null!=T&&(this.ambientMode=T);var g=e.ambientSphericalHarmonicsIntensity;null!=g&&(this.ambientSphericalHarmonicsIntensity=g);var y=e.reflectionIntensity;null!=y&&(this.reflectionIntensity=y)}},{key:"_addRenderObject",value:function(e){this._octree&&e._supportOctree?this._octree.add(e):this._renders.add(e),e._addReflectionProbeUpdate()}},{key:"_removeRenderObject",value:function(e){this._octree&&e._supportOctree?this._octree.remove(e):this._renders.remove(e)}},{key:"_getRenderQueue",value:function(e){return e<=2500?this._opaqueQueue:this._transparentQueue}},{key:"_clearRenderQueue",value:function(){this._opaqueQueue.clear(),this._transparentQueue.clear();for(var e=Aa._managers,t=0,n=e.length;t<n;t++)e[t]._clear();var i=Ga._managers;for(t=0,n=i.length;t<n;t++)i[t]._clear()}},{key:"destroy",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];if(!this.destroyed){_get(_getPrototypeOf(mi.prototype),"destroy",this).call(this,e),this._skyRenderer.destroy(),this._skyRenderer=null,this._directionLights=null,this._pointLights=null,this._spotLights=null,this._alternateLights=null,this._shaderValues=null,this._renders=null,this._cameraPool=null,this._octree=null,this._physicsSimulation&&this._physicsSimulation._destroy(),this._reflection._removeReference(),this._reflection=null;var n=this._lightmaps;if(n)for(var i=0,r=n.length;i<r;i++){var a=n[i];a.lightmapColor&&a.lightmapColor._removeReference(),a.lightmapDirection&&a.lightmapDirection._removeReference()}this._lightmaps=null,this._reflectionProbeManager.destroy(),t.Loader.clearRes(this.url)}}},{key:"render",value:function(e){e._curSubmit=t.SubmitBase.RENDERBASE,this._children.length>0&&e.addRenderObject(this)}},{key:"renderSubmit",value:function(){var e,n,i;for(this._prepareSceneToRender(),e=0,i=(n=this._cameraPool.length)-1;e<n;e++){t.Render.supportWebGLPlusRendering&&En.setRuntimeValueMode(e==i);var r=this._cameraPool[e];r.enableRender&&r.render()}return t.Context.set2DRenderConfig(),1}},{key:"getRenderType",value:function(){return 0}},{key:"releaseRender",value:function(){}},{key:"reUse",value:function(e,t){return 0}},{key:"setGlobalShaderValue",value:function(t,n,i){var r=xn.propertyNameToID(t);switch(n){case e.ShaderDataType.Int:this._shaderValues.setInt(r,i);break;case e.ShaderDataType.Number:this._shaderValues.setNumber(r,i);break;case e.ShaderDataType.Bool:this._shaderValues.setBool(r,i);break;case e.ShaderDataType.Matrix4x4:this._shaderValues.setMatrix4x4(r,i);break;case e.ShaderDataType.Quaternion:this._shaderValues.setQuaternion(r,i);break;case e.ShaderDataType.Texture:this._shaderValues.setTexture(r,i);break;case e.ShaderDataType.Vector4:this._shaderValues.setVector(r,i);break;case e.ShaderDataType.Vector2:this._shaderValues.setVector2(r,i);break;case e.ShaderDataType.Vector3:this._shaderValues.setVector3(r,i);break;case e.ShaderDataType.Buffer:this._shaderValues.setBuffer(r,i)}}},{key:"setlightmaps",value:function(e){for(var t=this._lightmaps,n=0,i=t.length;n<i;n++)t[n].lightmapColor._removeReference();if(!e)throw new Error("Scene3D: value value can't be null.");var r=e.length;for(t.length=r,n=0;n<r;n++){var a=e[n];a._addReference(),t[n]||(t[n]=new ka),t[n].lightmapColor=a}}},{key:"getlightmaps",value:function(){for(var e=new Array(this._lightmaps.length),t=0;t<this._lightmaps.length;t++)e[t]=this._lightmaps[t].lightmapColor;return e}},{key:"url",get:function(){return this._url}},{key:"enableFog",get:function(){return this._enableFog},set:function(e){this._enableFog!==e&&(this._enableFog=e,e?this._shaderValues.addDefine(Qn.SHADERDEFINE_FOG):this._shaderValues.removeDefine(Qn.SHADERDEFINE_FOG))}},{key:"fogColor",get:function(){return this._shaderValues.getVector3(mi.FOGCOLOR)},set:function(e){this._shaderValues.setVector3(mi.FOGCOLOR,e)}},{key:"fogStart",get:function(){return this._shaderValues.getNumber(mi.FOGSTART)},set:function(e){this._shaderValues.setNumber(mi.FOGSTART,e)}},{key:"fogRange",get:function(){return this._shaderValues.getNumber(mi.FOGRANGE)},set:function(e){this._shaderValues.setNumber(mi.FOGRANGE,e)}},{key:"ambientMode",get:function(){return this._ambientMode},set:function(t){if(this._ambientMode!==t){switch(t){case e.AmbientMode.SolidColor:this._shaderValues.removeDefine(Qn.SHADERDEFINE_GI_AMBIENT_SH);break;case e.AmbientMode.SphericalHarmonics:this._shaderValues.addDefine(Qn.SHADERDEFINE_GI_AMBIENT_SH);break;default:throw"Scene3D: unknown ambientMode."}this._ambientMode=t}}},{key:"ambientColor",get:function(){return this._shaderValues.getVector3(mi.AMBIENTCOLOR)},set:function(e){this._shaderValues.setVector3(mi.AMBIENTCOLOR,e)}},{key:"ambientSphericalHarmonics",get:function(){return this._ambientSphericalHarmonics},set:function(e){var t=e||aa._default;this._applySHCoefficients(t,Math.pow(this._ambientSphericalHarmonicsIntensity,2.2)),this._ambientSphericalHarmonics!=e&&e.cloneTo(this._ambientSphericalHarmonics)}},{key:"ambientSphericalHarmonicsIntensity",get:function(){return this._ambientSphericalHarmonicsIntensity},set:function(e){if(e=Math.max(Math.min(e,8),0),this._ambientSphericalHarmonicsIntensity!==e){var t=this._ambientSphericalHarmonics||aa._default;this._applySHCoefficients(t,Math.pow(e,2.2)),this._ambientSphericalHarmonicsIntensity=e}}},{key:"reflection",get:function(){return this._reflection},set:function(e){e=e||ha.blackTexture,this._reflection!=e&&(e._addReference(),this._reflectionProbeManager.sceneReflectionProbe=e,this._reflection=e,this._reflectionProbeManager._needUpdateAllRender=!0)}},{key:"reflectionDecodingFormat",get:function(){return this._reflectionDecodeFormat},set:function(e){this._reflectionDecodeFormat!=e&&(this._reflectionCubeHDRParams.x=this._reflectionIntensity,this._reflectionDecodeFormat==t.TextureDecodeFormat.RGBM&&(this._reflectionCubeHDRParams.x*=5),this._reflectionDecodeFormat=e,this._reflectionProbeManager.sceneReflectionCubeHDRParam=this._reflectionCubeHDRParams)}},{key:"reflectionIntensity",get:function(){return this._reflectionIntensity},set:function(e){e=Math.max(Math.min(e,1),0),this._reflectionCubeHDRParams.x=e,this._reflectionDecodeFormat==t.TextureDecodeFormat.RGBM&&(this._reflectionCubeHDRParams.x*=5),this._reflectionIntensity=e,this._reflectionProbeManager.sceneReflectionCubeHDRParam=this._reflectionCubeHDRParams}},{key:"skyRenderer",get:function(){return this._skyRenderer}},{key:"physicsSimulation",get:function(){return this._physicsSimulation}},{key:"cannonPhysicsSimulation",get:function(){return this._cannonPhysicsSimulation}},{key:"timer",get:function(){return this._timer},set:function(e){this._timer=e}},{key:"input",get:function(){return this._input}},{key:"lightmaps",get:function(){return this._lightmaps.slice()},set:function(e){var t=this._lightmaps;if(t)for(var n=0,i=t.length;n<i;n++)(a=t[n]).lightmapColor._removeReference(),a.lightmapDirection._removeReference();if(e){var r=e.length;for(t.length=r,n=0;n<r;n++){var a;(a=e[n]).lightmapColor&&a.lightmapColor._addReference(),a.lightmapDirection&&a.lightmapDirection._addReference(),t[n]=a}}else t.length=0}},{key:"customReflection",get:function(){return this._reflection},set:function(e){this._reflection!=e&&(e._addReference(),this._reflectionProbeManager.sceneReflectionProbe=e,this._reflection=e)}},{key:"reflectionMode",get:function(){return this._reflectionMode},set:function(e){this._reflectionMode=e}}],[{key:"__init__",value:function(){var n=It._config;if(n._multiLighting){var i=n.maxLightCount,r=n.lightClusterCount;kn.instance=new kn(r.x,r.y,r.z,Math.min(n.maxLightCount,n._maxAreaLightCountPerClusterAverage)),mi._lightTexture=gt._createFloatTextureBuffer(4,i),mi._lightTexture.lock=!0,mi._lightPixles=new Float32Array(4*i*4)}Qn.SHADERDEFINE_FOG=xn.getDefineByName("FOG"),Qn.SHADERDEFINE_DIRECTIONLIGHT=xn.getDefineByName("DIRECTIONLIGHT"),Qn.SHADERDEFINE_POINTLIGHT=xn.getDefineByName("POINTLIGHT"),Qn.SHADERDEFINE_SPOTLIGHT=xn.getDefineByName("SPOTLIGHT"),Qn.SHADERDEFINE_SHADOW=xn.getDefineByName("SHADOW"),Qn.SHADERDEFINE_SHADOW_CASCADE=xn.getDefineByName("SHADOW_CASCADE"),Qn.SHADERDEFINE_SHADOW_SOFT_SHADOW_LOW=xn.getDefineByName("SHADOW_SOFT_SHADOW_LOW"),Qn.SHADERDEFINE_SHADOW_SOFT_SHADOW_HIGH=xn.getDefineByName("SHADOW_SOFT_SHADOW_HIGH"),Qn.SHADERDEFINE_GI_AMBIENT_SH=xn.getDefineByName("GI_AMBIENT_SH"),Qn.SHADERDEFINE_SHADOW_SPOT=xn.getDefineByName("SHADOW_SPOT"),Qn.SHADERDEFINE_SHADOW_SPOT_SOFT_SHADOW_LOW=xn.getDefineByName("SHADOW_SPOT_SOFT_SHADOW_LOW"),Qn.SHADERDEFINE_SHADOW_SPOT_SOFT_SHADOW_HIGH=xn.getDefineByName("SHADOW_SPOT_SOFT_SHADOW_HIGH");var a=It._config,o=mi._configDefineValues;switch(a._multiLighting||o.add(xn.SHADERDEFINE_LEGACYSINGALLIGHTING),t.LayaGL.layaGPUInstance._isWebGL2?o.add(xn.SHADERDEFINE_GRAPHICS_API_GLES3):o.add(xn.SHADERDEFINE_GRAPHICS_API_GLES2),a.pbrRenderQuality){case e.PBRRenderQuality.High:o.add(or.SHADERDEFINE_LAYA_PBR_BRDF_HIGH);break;case e.PBRRenderQuality.Low:o.add(or.SHADERDEFINE_LAYA_PBR_BRDF_LOW);break;default:throw"Scene3D:unknown shader quality."}a.isUseCannonPhysicsEngine?mi.cannonPhysicsSettings=new t.CannonPhysicsSettings:mi.physicsSettings=new ua}},{key:"load",value:function(e,n,i){t.ILaya.loader.create(e,n,i,mi.HIERARCHY)}}]),mi}();Wa._shadowCasterPass=new Ua,Wa.HIERARCHY="HIERARCHY",Wa.octreeCulling=!1,Wa.octreeInitialSize=64,Wa.octreeInitialCenter=new D(0,0,0),Wa.octreeMinNodeSize=2,Wa.octreeLooseness=1.25,Wa.REFLECTIONMODE_SKYBOX=0,Wa.REFLECTIONMODE_CUSTOM=1,Wa.SCENERENDERFLAG_RENDERQPAQUE=0,Wa.SCENERENDERFLAG_SKYBOX=1,Wa.SCENERENDERFLAG_RENDERTRANSPARENT=2,Wa.FOGCOLOR=xn.propertyNameToID("u_FogColor"),Wa.FOGSTART=xn.propertyNameToID("u_FogStart"),Wa.FOGRANGE=xn.propertyNameToID("u_FogRange"),Wa.DIRECTIONLIGHTCOUNT=xn.propertyNameToID("u_DirationLightCount"),Wa.LIGHTBUFFER=xn.propertyNameToID("u_LightBuffer"),Wa.CLUSTERBUFFER=xn.propertyNameToID("u_LightClusterBuffer"),Wa.SUNLIGHTDIRECTION=xn.propertyNameToID("u_SunLight.direction"),Wa.SUNLIGHTDIRCOLOR=xn.propertyNameToID("u_SunLight.color"),Wa.AMBIENTSHAR=xn.propertyNameToID("u_AmbientSHAr"),Wa.AMBIENTSHAG=xn.propertyNameToID("u_AmbientSHAg"),Wa.AMBIENTSHAB=xn.propertyNameToID("u_AmbientSHAb"),Wa.AMBIENTSHBR=xn.propertyNameToID("u_AmbientSHBr"),Wa.AMBIENTSHBG=xn.propertyNameToID("u_AmbientSHBg"),Wa.AMBIENTSHBB=xn.propertyNameToID("u_AmbientSHBb"),Wa.AMBIENTSHC=xn.propertyNameToID("u_AmbientSHC"),Wa.LIGHTDIRECTION=xn.propertyNameToID("u_DirectionLight.direction"),Wa.LIGHTDIRCOLOR=xn.propertyNameToID("u_DirectionLight.color"),Wa.POINTLIGHTPOS=xn.propertyNameToID("u_PointLight.position"),Wa.POINTLIGHTRANGE=xn.propertyNameToID("u_PointLight.range"),Wa.POINTLIGHTATTENUATION=xn.propertyNameToID("u_PointLight.attenuation"),Wa.POINTLIGHTCOLOR=xn.propertyNameToID("u_PointLight.color"),Wa.SPOTLIGHTPOS=xn.propertyNameToID("u_SpotLight.position"),Wa.SPOTLIGHTDIRECTION=xn.propertyNameToID("u_SpotLight.direction"),Wa.SPOTLIGHTSPOTANGLE=xn.propertyNameToID("u_SpotLight.spot"),Wa.SPOTLIGHTRANGE=xn.propertyNameToID("u_SpotLight.range"),Wa.SPOTLIGHTCOLOR=xn.propertyNameToID("u_SpotLight.color"),Wa.AMBIENTCOLOR=xn.propertyNameToID("u_AmbientColor"),Wa.TIME=xn.propertyNameToID("u_Time"),Wa._configDefineValues=new mn;var Xa=function(e){function fi(e,t,n,i){var r;for(var a in _classCallCheck(this,fi),(r=_possibleConstructorReturn(this,_getPrototypeOf(fi).call(this,t,n,null)))._cacheSharders={},r._cacheShaderHierarchy=1,r._renderState=new Wi,r._validDefine=new mn,r._tags={},r._owner=e,r._stateMap=i,r.defs)r._validDefine.add(xn.getDefineByName(a));return _possibleConstructorReturn(r)}return _inherits(fi,t.ShaderCompile),_createClass(fi,[{key:"_compileToTree",value:function(e,n,i,r,a){var o,s,l,u,_,c,h,d,f,m,p;for(f=i;f<n.length;f++)if(!((l=n[f]).length<1)&&0!==(c=l.indexOf("//"))){if(c>=0&&(l=l.substr(0,c)),o=d||new t.ShaderNode(r),d=null,o.text=l,o.noCompile=!0,(c=l.indexOf("#"))>=0){for(u="#",p=c+1,m=l.length;p<m;p++){var v=l.charAt(p);if(" "===v||"\t"===v||"?"===v)break;u+=v}switch(o.name=u,u){case"#ifdef":case"#ifndef":if(o.src=l,o.noCompile=null!=l.match(/[!&|()=<>]/),o.noCompile?console.log("function():Boolean{return "+l.substr(c+o.name.length)+"}"):(h=l.replace(/^\s*/,"").split(/\s+/),o.setCondition(h[1],"#ifdef"===u?t.ShaderCompile.IFDEF_YES:t.ShaderCompile.IFDEF_ELSE),o.text="//"+o.text),o.setParent(e),e=o,a)for(h=l.substr(p).split(t.ShaderCompile._splitToWordExps3),p=0;p<h.length;p++)(l=h[p]).length&&(a[l]=!0);continue;case"#if":case"#elif":if(o.src=l,o.noCompile=!0,"#elif"==u&&((s=(e=e.parent).childs[e.childs.length-1]).text=s.src,s.noCompile=!0,s.condition=null),o.setParent(e),e=o,a)for(h=l.substr(p).split(t.ShaderCompile._splitToWordExps3),p=0;p<h.length;p++)(l=h[p]).length&&"defined"!=l&&(a[l]=!0);continue;case"#else":o.src=l,s=(e=e.parent).childs[e.childs.length-1],o.noCompile=s.noCompile,o.noCompile||(o.condition=s.condition,o.conditionType=s.conditionType==t.ShaderCompile.IFDEF_YES?t.ShaderCompile.IFDEF_ELSE:t.ShaderCompile.IFDEF_YES,o.text="//"+o.text+" "+s.text+" "+o.conditionType),o.setParent(e),e=o;continue;case"#endif":s=(e=e.parent).childs[e.childs.length-1],o.noCompile=s.noCompile,o.noCompile||(o.text="//"+o.text),o.setParent(e);continue;case"#include":h=t.ShaderCompile.splitToWords(l,null);var E=t.ShaderCompile.includes[h[1]];if(!E)throw"ShaderCompile error no this include file:"+h[1];if((c=h[0].indexOf("?"))<0){o.setParent(e),l=E.getWith("with"==h[2]?h[3]:null),this._compileToTree(o,l.split("\n"),0,r,a),o.text="";continue}o.setCondition(h[0].substr(c+1),t.ShaderCompile.IFDEF_YES),o.text=E.getWith("with"==h[2]?h[3]:null);break;case"#import":_=(h=t.ShaderCompile.splitToWords(l,null))[1],r.push({node:o,file:t.ShaderCompile.includes[_],ofs:o.text.length});continue}}else{if((s=e.childs[e.childs.length-1])&&!s.name){r.length>0&&t.ShaderCompile.splitToWords(l,s),d=o,s.text+="\n"+l;continue}r.length>0&&t.ShaderCompile.splitToWords(l,o)}o.setParent(e)}}},{key:"_resizeCacheShaderMap",value:function(e,t,n){var i=this._cacheShaderHierarchy-1;if(t==i){for(var r in e)for(var a=e[r],o=0,s=n-i;o<s;o++)o==s-1?e[0]=a:e=e[0==o?r:0]={};this._cacheShaderHierarchy=n}else for(var r in e)this._resizeCacheShaderMap(e[r],++t,n)}},{key:"_addDebugShaderVariantCollection",value:function(e,t,n){var i=xn._debugShaderVariantInfo,r=this._owner,a=r._owner,o=e._mask;xn._getNamesByDefineData(e,t),n.length=o.length;for(var s=0,l=o.length;s<l;s++)n[s]=o[s];i?i.setValue(a,a._subShaders.indexOf(r),r._passes.indexOf(this),t):xn._debugShaderVariantInfo=i=new An(a,a._subShaders.indexOf(r),r._passes.indexOf(this),t),xn.debugShaderVariantCollection.add(i)}},{key:"withCompile",value:function(e){var n,i=fi._debugDefineString,r=fi._debugDefineMask;e._intersectionDefineDatas(this._validDefine),xn.debugMode&&(n=e._length,this._addDebugShaderVariantCollection(e,i,r)),e.addDefineDatas(Wa._configDefineValues);var a=this._cacheSharders,o=e._length;o>this._cacheShaderHierarchy&&(this._resizeCacheShaderMap(a,0,o),this._cacheShaderHierarchy=o);for(var s=e._mask,l=e._length-1,u=this._cacheShaderHierarchy-1,_=0;_<u;_++){var c=l<_?0:s[_],h=a[c];h||(a[c]=h={}),a=h}var d=l<u?0:s[u],f=a[d];if(f)return f;var m=fi._defineString;xn._getNamesByDefineData(e,m);var p,v,E=It._config,T=E.lightClusterCount,g={},y="";t.WebGL._isWebGL2?(p="#version 300 es\n\n\t\t\t\t#define attribute in\n\t\t\t\t#define varying out\n\t\t\t\t#define texture2D texture\n",v="#version 300 es\n\n\t\t\t\t#define varying in\n\t\t\t\tout highp vec4 pc_fragColor;\n\t\t\t\t#define gl_FragColor pc_fragColor\n\t\t\t\t#define gl_FragDepthEXT gl_FragDepth\n\t\t\t\t#define texture2D texture\n\t\t\t\t#define textureCube texture\n\t\t\t\t#define texture2DProj textureProj\n\t\t\t\t#define texture2DLodEXT textureLod\n\t\t\t\t#define texture2DProjLodEXT textureProjLod\n\t\t\t\t#define textureCubeLodEXT textureLod\n\t\t\t\t#define texture2DGradEXT textureGrad\n\t\t\t\t#define texture2DProjGradEXT textureProjGrad\n\t\t\t\t#define textureCubeGradEXT textureGrad\n"):(p="",v="#ifdef GL_EXT_shader_texture_lod\n\t\t\t\t\t#extension GL_EXT_shader_texture_lod : enable\n\t\t\t\t#endif\n\t\t\t\t#if !defined(GL_EXT_shader_texture_lod)\n\t\t\t\t\t#define texture1DLodEXT texture1D\n\t\t\t\t\t#define texture2DLodEXT texture2D\n\t\t\t\t\t#define texture2DProjLodEXT texture2DProj\n\t\t\t\t\t#define texture3DLodEXT texture3D\n\t\t\t\t\t#define textureCubeLodEXT textureCube\n\t\t\t\t#endif\n"),y+="#define MAX_LIGHT_COUNT "+E.maxLightCount+"\n",y+="#define MAX_LIGHT_COUNT_PER_CLUSTER "+E._maxAreaLightCountPerClusterAverage+"\n",y+="#define CLUSTER_X_COUNT "+T.x+"\n",y+="#define CLUSTER_Y_COUNT "+T.y+"\n",y+="#define CLUSTER_Z_COUNT "+T.z+"\n",y+="#define SHADER_CAPAILITY_LEVEL "+t.SystemUtils._shaderCapailityLevel+"\n",_=0;for(var S=m.length;_<S;_++){var R=m[_];y+="#define "+R+"\n",g[R]=!0}var C=this._VS.toscript(g,[]),A="";0==C[0].indexOf("#version")&&(A=C[0]+"\n",C.shift());var I=this._PS.toscript(g,[]),x="";if(0==I[0].indexOf("#version")&&(x=I[0]+"\n",I.shift()),f=new qr(A+p+y+C.join("\n"),x+v+y+I.join("\n"),this._owner._attributeMap,this._owner._uniformMap||this._owner._owner._uniformMap,this),a[d]=f,xn.debugMode){var D="",M="";for(_=0,S=n;_<S;_++)M+=_==S-1?r[_]:r[_]+",";for(_=0,S=i.length;_<S;_++)D+=_==S-1?i[_]:i[_]+",";console.log("%cLayaAir: Shader Compile Information---ShaderName:"+this._owner._owner._name+" SubShaderIndex:"+this._owner._owner._subShaders.indexOf(this._owner)+" PassIndex:"+this._owner._passes.indexOf(this)+" DefineMask:["+M+"] DefineNames:["+D+"]","color:green")}return f}},{key:"setTag",value:function(e,t){t?this._tags[e]=t:delete this._tags[e]}},{key:"getTag",value:function(e){return this._tags[e]}},{key:"renderState",get:function(){return this._renderState}}]),fi}();Xa._defineString=[],Xa._debugDefineString=[],Xa._debugDefineMask=[];var Ya=function(){function Ti(e,t){_classCallCheck(this,Ti),this._flags={},this._passes=[],this._attributeMap=e,this._uniformMap=t}return _createClass(Ti,[{key:"setFlag",value:function(e,t){t?this._flags[e]=t:delete this._flags[e]}},{key:"getFlag",value:function(e){return this._flags[e]}},{key:"addShaderPass",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"Forward",r=new Xa(this,e,t,n);return r._pipelineMode=i,this._passes.push(r),r}}]),Ti}();(Ir=e.PBRSpecularSmoothnessSource||(e.PBRSpecularSmoothnessSource={}))[Ir.SpecularTextureAlpha=0]="SpecularTextureAlpha",Ir[Ir.AlbedoTextureAlpha=1]="AlbedoTextureAlpha";var ja,Za,qa,Qa=function(e){function Ei(){var e;return _classCallCheck(this,Ei),(e=_possibleConstructorReturn(this,_getPrototypeOf(Ei).call(this))).setShaderName("PBRSpecular"),e._shaderValues.setVector(Ei.SPECULARCOLOR,new o(.2,.2,.2,1)),e}return _inherits(Ei,or),_createClass(Ei,[{key:"clone",value:function(){var e=new Ei;return this.cloneTo(e),e}},{key:"specularTexture",get:function(){return this._shaderValues.getTexture(Ei.SPECULARTEXTURE)},set:function(e){e?this._shaderValues.addDefine(Ei.SHADERDEFINE_SPECULARGLOSSTEXTURE):this._shaderValues.removeDefine(Ei.SHADERDEFINE_SPECULARGLOSSTEXTURE),this._shaderValues.setTexture(Ei.SPECULARTEXTURE,e)}},{key:"specularColor",get:function(){return this._shaderValues.getVector(Ei.SPECULARCOLOR)},set:function(e){this._shaderValues.setVector(Ei.SPECULARCOLOR,e)}}],[{key:"__init__",value:function(){Ei.SHADERDEFINE_SPECULARGLOSSTEXTURE=xn.getDefineByName("SPECULARGLOSSTEXTURE"),Ei.SHADERDEFINE_SMOOTHNESSSOURCE_ALBEDOTEXTURE_ALPHA=xn.getDefineByName("SMOOTHNESSSOURCE_ALBEDOTEXTURE_ALPHA");var e={a_Position:Xn.MESH_POSITION0,a_Normal:Xn.MESH_NORMAL0,a_Tangent0:Xn.MESH_TANGENT0,a_Texcoord0:Xn.MESH_TEXTURECOORDINATE0,a_Texcoord1:Xn.MESH_TEXTURECOORDINATE1,a_BoneWeights:Xn.MESH_BLENDWEIGHT0,a_BoneIndices:Xn.MESH_BLENDINDICES0,a_WorldMat:Xn.MESH_WORLDMATRIX_ROW0},t={u_Bones:xn.PERIOD_CUSTOM,u_MvpMatrix:xn.PERIOD_SPRITE,u_WorldMat:xn.PERIOD_SPRITE,u_LightmapScaleOffset:xn.PERIOD_SPRITE,u_LightMap:xn.PERIOD_SPRITE,u_LightMapDirection:xn.PERIOD_SPRITE,u_SimpleAnimatorTexture:xn.PERIOD_SPRITE,u_SimpleAnimatorParams:xn.PERIOD_SPRITE,u_SimpleAnimatorTextureSize:xn.PERIOD_SPRITE,u_ReflectCubeHDRParams:xn.PERIOD_SPRITE,u_ReflectTexture:xn.PERIOD_SPRITE,u_SpecCubeProbePosition:xn.PERIOD_SPRITE,u_SpecCubeBoxMax:xn.PERIOD_SPRITE,u_SpecCubeBoxMin:xn.PERIOD_SPRITE,u_CameraPos:xn.PERIOD_CAMERA,u_View:xn.PERIOD_CAMERA,u_ProjectionParams:xn.PERIOD_CAMERA,u_Viewport:xn.PERIOD_CAMERA,u_ViewProjection:xn.PERIOD_CAMERA,u_AlphaTestValue:xn.PERIOD_MATERIAL,u_AlbedoColor:xn.PERIOD_MATERIAL,u_EmissionColor:xn.PERIOD_MATERIAL,u_AlbedoTexture:xn.PERIOD_MATERIAL,u_NormalTexture:xn.PERIOD_MATERIAL,u_ParallaxTexture:xn.PERIOD_MATERIAL,u_OcclusionTexture:xn.PERIOD_MATERIAL,u_EmissionTexture:xn.PERIOD_MATERIAL,u_Smoothness:xn.PERIOD_MATERIAL,u_SmoothnessScale:xn.PERIOD_MATERIAL,u_occlusionStrength:xn.PERIOD_MATERIAL,u_NormalScale:xn.PERIOD_MATERIAL,u_ParallaxScale:xn.PERIOD_MATERIAL,u_TilingOffset:xn.PERIOD_MATERIAL,u_SpecGlossTexture:xn.PERIOD_MATERIAL,u_SpecularColor:xn.PERIOD_MATERIAL,u_AmbientColor:xn.PERIOD_SCENE,u_FogStart:xn.PERIOD_SCENE,u_FogRange:xn.PERIOD_SCENE,u_FogColor:xn.PERIOD_SCENE,u_DirationLightCount:xn.PERIOD_SCENE,u_LightBuffer:xn.PERIOD_SCENE,u_LightClusterBuffer:xn.PERIOD_SCENE,u_ShadowBias:xn.PERIOD_SCENE,u_ShadowLightDirection:xn.PERIOD_SCENE,u_ShadowMap:xn.PERIOD_SCENE,u_ShadowParams:xn.PERIOD_SCENE,u_ShadowSplitSpheres:xn.PERIOD_SCENE,u_ShadowMatrices:xn.PERIOD_SCENE,u_ShadowMapSize:xn.PERIOD_SCENE,u_SpotShadowMap:xn.PERIOD_SCENE,u_SpotViewProjectMatrix:xn.PERIOD_SCENE,u_ShadowLightPosition:xn.PERIOD_SCENE,u_AmbientSHAr:xn.PERIOD_SCENE,u_AmbientSHAg:xn.PERIOD_SCENE,u_AmbientSHAb:xn.PERIOD_SCENE,u_AmbientSHBr:xn.PERIOD_SCENE,u_AmbientSHBg:xn.PERIOD_SCENE,u_AmbientSHBb:xn.PERIOD_SCENE,u_AmbientSHC:xn.PERIOD_SCENE,"u_DirectionLight.direction":xn.PERIOD_SCENE,"u_DirectionLight.color":xn.PERIOD_SCENE,"u_PointLight.position":xn.PERIOD_SCENE,"u_PointLight.range":xn.PERIOD_SCENE,"u_PointLight.color":xn.PERIOD_SCENE,"u_SpotLight.position":xn.PERIOD_SCENE,"u_SpotLight.direction":xn.PERIOD_SCENE,"u_SpotLight.range":xn.PERIOD_SCENE,"u_SpotLight.spot":xn.PERIOD_SCENE,"u_SpotLight.color":xn.PERIOD_SCENE},n={s_Cull:xn.RENDER_STATE_CULL,s_Blend:xn.RENDER_STATE_BLEND,s_BlendSrc:xn.RENDER_STATE_BLEND_SRC,s_BlendDst:xn.RENDER_STATE_BLEND_DST,s_DepthTest:xn.RENDER_STATE_DEPTH_TEST,s_DepthWrite:xn.RENDER_STATE_DEPTH_WRITE},i=xn.add("PBRSpecular",e,t,!0,!0),r=new Ya(e,t);i.addSubShader(r),r.addShaderPass('#include "PBRVSInput.glsl";\n#include "Lighting.glsl";\n#include "PBRVertex.glsl";\n\nvoid main()\n{\n\tvertexForward();\n\tgl_Position=remapGLPositionZ(gl_Position);\n}','#if defined(GL_FRAGMENT_PRECISION_HIGH)//ifdefined\n\tprecision highp float;\n\tprecision highp int;\n#else\n\tprecision mediump float;\n\tprecision mediump int;\n#endif\n\n#define SETUP_BRDF_INPUT specularSetup\n\n#include "Lighting.glsl";\n#include "PBRFSInput.glsl";\n#include "LayaPBRBRDF.glsl";\n#include "GlobalIllumination.glsl";\n#include "Shadow.glsl"\n#include "PBRCore.glsl";\n\nvoid main()\n{\n\tfragmentForward();\n}',n,"Forward"),r.addShaderPass('#include "ShadowCasterVS.glsl"\n\nvoid main()\n{\n\tvec4 positionCS =  shadowCasterVertex();\n\tgl_Position=remapGLPositionZ(positionCS);\n}','#if defined(GL_FRAGMENT_PRECISION_HIGH)//ifdefined\n\tprecision highp float;\n\tprecision highp int;\n#else\n\tprecision mediump float;\n\tprecision mediump int;\n#endif\n\n#include "ShadowCasterFS.glsl"\n\nvoid main()\n{\n\tgl_FragColor=shadowCasterFragment();\n}',n,"ShadowCaster"),r.addShaderPass(Mr,Ur,n,"DepthNormal")}}]),Ei}();Qa.SPECULARTEXTURE=xn.propertyNameToID("u_SpecGlossTexture"),Qa.SPECULARCOLOR=xn.propertyNameToID("u_SpecularColor"),(ja=e.PBRMetallicSmoothnessSource||(e.PBRMetallicSmoothnessSource={}))[ja.MetallicGlossTextureAlpha=0]="MetallicGlossTextureAlpha",ja[ja.AlbedoTextureAlpha=1]="AlbedoTextureAlpha";var Ka=function(e){function Ri(){var e;return _classCallCheck(this,Ri),(e=_possibleConstructorReturn(this,_getPrototypeOf(Ri).call(this)))._smoothnessSource=0,e.setShaderName("PBR"),e._shaderValues.setNumber(Ri.METALLIC,0),e}return _inherits(Ri,or),_createClass(Ri,[{key:"clone",value:function(){var e=new Ri;return this.cloneTo(e),e}},{key:"metallicGlossTexture",get:function(){return this._shaderValues.getTexture(Ri.METALLICGLOSSTEXTURE)},set:function(e){e?this._shaderValues.addDefine(Ri.SHADERDEFINE_METALLICGLOSSTEXTURE):this._shaderValues.removeDefine(Ri.SHADERDEFINE_METALLICGLOSSTEXTURE),this._shaderValues.setTexture(Ri.METALLICGLOSSTEXTURE,e)}},{key:"metallic",get:function(){return this._shaderValues.getNumber(Ri.METALLIC)},set:function(e){this._shaderValues.setNumber(Ri.METALLIC,Math.max(0,Math.min(1,e)))}},{key:"smoothnessSource",get:function(){return this._smoothnessSource},set:function(e){e?this._shaderValues.addDefine(Ri.SHADERDEFINE_SMOOTHNESSSOURCE_ALBEDOTEXTURE_ALPHA):this._shaderValues.removeDefine(Ri.SHADERDEFINE_SMOOTHNESSSOURCE_ALBEDOTEXTURE_ALPHA),this._smoothnessSource=e}}],[{key:"__init__",value:function(){Ri.SHADERDEFINE_METALLICGLOSSTEXTURE=xn.getDefineByName("METALLICGLOSSTEXTURE"),Ri.SHADERDEFINE_SMOOTHNESSSOURCE_ALBEDOTEXTURE_ALPHA=xn.getDefineByName("SMOOTHNESSSOURCE_ALBEDOTEXTURE_ALPHA");var e={a_Position:Xn.MESH_POSITION0,a_Normal:Xn.MESH_NORMAL0,a_Tangent0:Xn.MESH_TANGENT0,a_Texcoord0:Xn.MESH_TEXTURECOORDINATE0,a_Texcoord1:Xn.MESH_TEXTURECOORDINATE1,a_BoneWeights:Xn.MESH_BLENDWEIGHT0,a_BoneIndices:Xn.MESH_BLENDINDICES0,a_WorldMat:Xn.MESH_WORLDMATRIX_ROW0},t={u_Bones:xn.PERIOD_CUSTOM,u_MvpMatrix:xn.PERIOD_SPRITE,u_WorldMat:xn.PERIOD_SPRITE,u_LightmapScaleOffset:xn.PERIOD_SPRITE,u_LightMap:xn.PERIOD_SPRITE,u_LightMapDirection:xn.PERIOD_SPRITE,u_SimpleAnimatorTexture:xn.PERIOD_SPRITE,u_SimpleAnimatorParams:xn.PERIOD_SPRITE,u_SimpleAnimatorTextureSize:xn.PERIOD_SPRITE,u_ReflectCubeHDRParams:xn.PERIOD_SPRITE,u_ReflectTexture:xn.PERIOD_SPRITE,u_SpecCubeProbePosition:xn.PERIOD_SPRITE,u_SpecCubeBoxMax:xn.PERIOD_SPRITE,u_SpecCubeBoxMin:xn.PERIOD_SPRITE,u_CameraPos:xn.PERIOD_CAMERA,u_View:xn.PERIOD_CAMERA,u_ProjectionParams:xn.PERIOD_CAMERA,u_Viewport:xn.PERIOD_CAMERA,u_ViewProjection:xn.PERIOD_CAMERA,u_AlphaTestValue:xn.PERIOD_MATERIAL,u_AlbedoColor:xn.PERIOD_MATERIAL,u_EmissionColor:xn.PERIOD_MATERIAL,u_AlbedoTexture:xn.PERIOD_MATERIAL,u_NormalTexture:xn.PERIOD_MATERIAL,u_ParallaxTexture:xn.PERIOD_MATERIAL,u_OcclusionTexture:xn.PERIOD_MATERIAL,u_EmissionTexture:xn.PERIOD_MATERIAL,u_Smoothness:xn.PERIOD_MATERIAL,u_SmoothnessScale:xn.PERIOD_MATERIAL,u_occlusionStrength:xn.PERIOD_MATERIAL,u_NormalScale:xn.PERIOD_MATERIAL,u_ParallaxScale:xn.PERIOD_MATERIAL,u_TilingOffset:xn.PERIOD_MATERIAL,u_MetallicGlossTexture:xn.PERIOD_MATERIAL,u_Metallic:xn.PERIOD_MATERIAL,u_AmbientColor:xn.PERIOD_SCENE,u_FogStart:xn.PERIOD_SCENE,u_FogRange:xn.PERIOD_SCENE,u_FogColor:xn.PERIOD_SCENE,u_DirationLightCount:xn.PERIOD_SCENE,u_LightBuffer:xn.PERIOD_SCENE,u_LightClusterBuffer:xn.PERIOD_SCENE,u_ShadowBias:xn.PERIOD_SCENE,u_ShadowLightDirection:xn.PERIOD_SCENE,u_ShadowMap:xn.PERIOD_SCENE,u_ShadowParams:xn.PERIOD_SCENE,u_ShadowSplitSpheres:xn.PERIOD_SCENE,u_ShadowMatrices:xn.PERIOD_SCENE,u_ShadowMapSize:xn.PERIOD_SCENE,u_SpotShadowMap:xn.PERIOD_SCENE,u_SpotViewProjectMatrix:xn.PERIOD_SCENE,u_ShadowLightPosition:xn.PERIOD_SCENE,u_AmbientSHAr:xn.PERIOD_SCENE,u_AmbientSHAg:xn.PERIOD_SCENE,u_AmbientSHAb:xn.PERIOD_SCENE,u_AmbientSHBr:xn.PERIOD_SCENE,u_AmbientSHBg:xn.PERIOD_SCENE,u_AmbientSHBb:xn.PERIOD_SCENE,u_AmbientSHC:xn.PERIOD_SCENE,"u_DirectionLight.direction":xn.PERIOD_SCENE,"u_DirectionLight.color":xn.PERIOD_SCENE,"u_PointLight.position":xn.PERIOD_SCENE,"u_PointLight.range":xn.PERIOD_SCENE,"u_PointLight.color":xn.PERIOD_SCENE,"u_SpotLight.position":xn.PERIOD_SCENE,"u_SpotLight.direction":xn.PERIOD_SCENE,"u_SpotLight.range":xn.PERIOD_SCENE,"u_SpotLight.spot":xn.PERIOD_SCENE,"u_SpotLight.color":xn.PERIOD_SCENE},n={s_Cull:xn.RENDER_STATE_CULL,s_Blend:xn.RENDER_STATE_BLEND,s_BlendSrc:xn.RENDER_STATE_BLEND_SRC,s_BlendDst:xn.RENDER_STATE_BLEND_DST,s_DepthTest:xn.RENDER_STATE_DEPTH_TEST,s_DepthWrite:xn.RENDER_STATE_DEPTH_WRITE},i=xn.add("PBR",e,t,!0,!0),r=new Ya(e,t);i.addSubShader(r),r.addShaderPass('#if defined(GL_FRAGMENT_PRECISION_HIGH)//ifdefined\n\tprecision highp float;\n\tprecision highp int;\n#else\n\tprecision mediump float;\n\tprecision mediump int;\n#endif\n#include "Lighting.glsl";\n#include "LayaUtile.glsl"\n#include "Shadow.glsl"\n#include "PBRVSInput.glsl";\n#include "PBRVertex.glsl";\n\nvoid main()\n{\n\tvertexForward();\n\tgl_Position=remapGLPositionZ(gl_Position);\n}','#if defined(GL_FRAGMENT_PRECISION_HIGH)//ifdefined\n\tprecision highp float;\n\tprecision highp int;\n#else\n\tprecision mediump float;\n\tprecision mediump int;\n#endif\n\n#include "Lighting.glsl";\n#include "Shadow.glsl"\n#include "PBRFSInput.glsl";\n#include "LayaPBRBRDF.glsl";\n#include "GlobalIllumination.glsl";\n#include "PBRCore.glsl";\n\nvoid main()\n{\n\tfragmentForward();\n}',n,"Forward"),r.addShaderPass('#include "ShadowCasterVS.glsl"\n\nvoid main()\n{\n\tvec4 positionCS =  shadowCasterVertex();\n\tgl_Position=remapGLPositionZ(positionCS);\n}','#if defined(GL_FRAGMENT_PRECISION_HIGH)//ifdefined\n\tprecision highp float;\n\tprecision highp int;\n#else\n\tprecision mediump float;\n\tprecision mediump int;\n#endif\n\n#include "ShadowCasterFS.glsl"\n\nvoid main()\n{\n\tgl_FragColor=shadowCasterFragment();\n}',n,"ShadowCaster"),r.addShaderPass(Mr,Ur,n,"DepthNormal")}}]),Ri}();Ka.METALLICGLOSSTEXTURE=xn.propertyNameToID("u_MetallicGlossTexture"),Ka.METALLIC=xn.propertyNameToID("u_Metallic");var Ja=function(e){function vi(){var e;return _classCallCheck(this,vi),(e=_possibleConstructorReturn(this,_getPrototypeOf(vi).call(this))).setShaderName("SkyBox"),e.tintColor=new o(.5,.5,.5,.5),e.exposure=1,e.rotation=0,e}return _inherits(vi,Gi),_createClass(vi,[{key:"clone",value:function(){var e=new vi;return this.cloneTo(e),e}},{key:"tintColor",get:function(){return this._shaderValues.getVector(vi.TINTCOLOR)},set:function(e){this._shaderValues.setVector(vi.TINTCOLOR,e)}},{key:"exposure",get:function(){return this._shaderValues.getNumber(vi.EXPOSURE)},set:function(e){this._shaderValues.setNumber(vi.EXPOSURE,e)}},{key:"rotation",get:function(){return this._shaderValues.getNumber(vi.ROTATION)},set:function(e){this._shaderValues.setNumber(vi.ROTATION,e)}},{key:"textureCube",get:function(){return this._shaderValues.getTexture(vi.TEXTURECUBE)},set:function(e){this._shaderValues.setTexture(vi.TEXTURECUBE,e)}}],[{key:"__initDefine__",value:function(){}}]),vi}();Ja.TINTCOLOR=xn.propertyNameToID("u_TintColor"),Ja.EXPOSURE=xn.propertyNameToID("u_Exposure"),Ja.ROTATION=xn.propertyNameToID("u_Rotation"),Ja.TEXTURECUBE=xn.propertyNameToID("u_CubeTexture");var $a=function(e){function Ai(){var e;return _classCallCheck(this,Ai),(e=_possibleConstructorReturn(this,_getPrototypeOf(Ai).call(this))).setShaderName("SkyBoxProcedural"),e.sunDisk=Ai.SUN_HIGH_QUALITY,e.sunSize=.04,e.sunSizeConvergence=5,e.atmosphereThickness=1,e.skyTint=new o(.5,.5,.5,1),e.groundTint=new o(.369,.349,.341,1),e.exposure=1.3,e}return _inherits(Ai,Gi),_createClass(Ai,[{key:"clone",value:function(){var e=new Ai;return this.cloneTo(e),e}},{key:"sunDisk",get:function(){return this._sunDisk},set:function(e){switch(e){case Ai.SUN_HIGH_QUALITY:this._shaderValues.removeDefine(Ai.SHADERDEFINE_SUN_SIMPLE),this._shaderValues.addDefine(Ai.SHADERDEFINE_SUN_HIGH_QUALITY);break;case Ai.SUN_SIMPLE:this._shaderValues.removeDefine(Ai.SHADERDEFINE_SUN_HIGH_QUALITY),this._shaderValues.addDefine(Ai.SHADERDEFINE_SUN_SIMPLE);break;case Ai.SUN_NODE:this._shaderValues.removeDefine(Ai.SHADERDEFINE_SUN_HIGH_QUALITY),this._shaderValues.removeDefine(Ai.SHADERDEFINE_SUN_SIMPLE);break;default:throw"SkyBoxProceduralMaterial: unknown sun value."}this._sunDisk=e}},{key:"sunSize",get:function(){return this._shaderValues.getNumber(Ai.SUNSIZE)},set:function(e){e=Math.min(Math.max(0,e),1),this._shaderValues.setNumber(Ai.SUNSIZE,e)}},{key:"sunSizeConvergence",get:function(){return this._shaderValues.getNumber(Ai.SUNSIZECONVERGENCE)},set:function(e){e=Math.min(Math.max(0,e),20),this._shaderValues.setNumber(Ai.SUNSIZECONVERGENCE,e)}},{key:"atmosphereThickness",get:function(){return this._shaderValues.getNumber(Ai.ATMOSPHERETHICKNESS)},set:function(e){e=Math.min(Math.max(0,e),5),this._shaderValues.setNumber(Ai.ATMOSPHERETHICKNESS,e)}},{key:"skyTint",get:function(){return this._shaderValues.getVector(Ai.SKYTINT)},set:function(e){this._shaderValues.setVector(Ai.SKYTINT,e)}},{key:"groundTint",get:function(){return this._shaderValues.getVector(Ai.GROUNDTINT)},set:function(e){this._shaderValues.setVector(Ai.GROUNDTINT,e)}},{key:"exposure",get:function(){return this._shaderValues.getNumber(Ai.EXPOSURE)},set:function(e){e=Math.min(Math.max(0,e),8),this._shaderValues.setNumber(Ai.EXPOSURE,e)}}],[{key:"__initDefine__",value:function(){Ai.SHADERDEFINE_SUN_HIGH_QUALITY=xn.getDefineByName("SUN_HIGH_QUALITY"),Ai.SHADERDEFINE_SUN_SIMPLE=xn.getDefineByName("SUN_SIMPLE")}}]),Ai}();$a.SUN_NODE=0,$a.SUN_SIMPLE=1,$a.SUN_HIGH_QUALITY=2,$a.SUNSIZE=xn.propertyNameToID("u_SunSize"),$a.SUNSIZECONVERGENCE=xn.propertyNameToID("u_SunSizeConvergence"),$a.ATMOSPHERETHICKNESS=xn.propertyNameToID("u_AtmosphereThickness"),$a.SKYTINT=xn.propertyNameToID("u_SkyTint"),$a.GROUNDTINT=xn.propertyNameToID("u_GroundTint"),$a.EXPOSURE=xn.propertyNameToID("u_Exposure");var eo=function(e){function xi(){var e;return _classCallCheck(this,xi),(e=_possibleConstructorReturn(this,_getPrototypeOf(xi).call(this)))._albedoColor=new o(1,1,1,1),e._albedoIntensity=1,e._enableVertexColor=!1,e.setShaderName("Unlit"),e._shaderValues.setVector(xi.ALBEDOCOLOR,new o(1,1,1,1)),e._shaderValues.setVector(xi.TILINGOFFSET,new o(1,1,0,0)),e.renderMode=xi.RENDERMODE_OPAQUE,e}return _inherits(xi,Gi),_createClass(xi,[{key:"clone",value:function(){var e=new xi;return this.cloneTo(e),e}},{key:"_ColorR",get:function(){return this._albedoColor.x},set:function(e){this._albedoColor.x=e,this.albedoColor=this._albedoColor}},{key:"_ColorG",get:function(){return this._albedoColor.y},set:function(e){this._albedoColor.y=e,this.albedoColor=this._albedoColor}},{key:"_ColorB",get:function(){return this._albedoColor.z},set:function(e){this._albedoColor.z=e,this.albedoColor=this._albedoColor}},{key:"_ColorA",get:function(){return this._albedoColor.w},set:function(e){this._albedoColor.w=e,this.albedoColor=this._albedoColor}},{key:"_Color",get:function(){return this._shaderValues.getVector(xi.ALBEDOCOLOR)},set:function(e){this.albedoColor=e}},{key:"_AlbedoIntensity",get:function(){return this._albedoIntensity},set:function(e){if(this._albedoIntensity!==e){var t=this._shaderValues.getVector(xi.ALBEDOCOLOR);o.scale(this._albedoColor,e,t),this._albedoIntensity=e,this._shaderValues.setVector(xi.ALBEDOCOLOR,t)}}},{key:"_MainTex_STX",get:function(){return this._shaderValues.getVector(xi.TILINGOFFSET).x},set:function(e){var t=this._shaderValues.getVector(xi.TILINGOFFSET);t.x=e,this.tilingOffset=t}},{key:"_MainTex_STY",get:function(){return this._shaderValues.getVector(xi.TILINGOFFSET).y},set:function(e){var t=this._shaderValues.getVector(xi.TILINGOFFSET);t.y=e,this.tilingOffset=t}},{key:"_MainTex_STZ",get:function(){return this._shaderValues.getVector(xi.TILINGOFFSET).z},set:function(e){var t=this._shaderValues.getVector(xi.TILINGOFFSET);t.z=e,this.tilingOffset=t}},{key:"_MainTex_STW",get:function(){return this._shaderValues.getVector(xi.TILINGOFFSET).w},set:function(e){var t=this._shaderValues.getVector(xi.TILINGOFFSET);t.w=e,this.tilingOffset=t}},{key:"_MainTex_ST",get:function(){return this._shaderValues.getVector(xi.TILINGOFFSET)},set:function(e){this.tilingOffset=e}},{key:"_Cutoff",get:function(){return this.alphaTestValue},set:function(e){this.alphaTestValue=e}},{key:"albedoColorR",get:function(){return this._ColorR},set:function(e){this._ColorR=e}},{key:"albedoColorG",get:function(){return this._ColorG},set:function(e){this._ColorG=e}},{key:"albedoColorB",get:function(){return this._ColorB},set:function(e){this._ColorB=e}},{key:"albedoColorA",get:function(){return this._ColorA},set:function(e){this._ColorA=e}},{key:"albedoColor",get:function(){return this._albedoColor},set:function(e){var t=this._shaderValues.getVector(xi.ALBEDOCOLOR);o.scale(e,this._albedoIntensity,t),this._albedoColor=e,this._shaderValues.setVector(xi.ALBEDOCOLOR,t)}},{key:"albedoIntensity",get:function(){return this._albedoIntensity},set:function(e){this._AlbedoIntensity=e}},{key:"albedoTexture",get:function(){return this._shaderValues.getTexture(xi.ALBEDOTEXTURE)},set:function(e){e?this._shaderValues.addDefine(xi.SHADERDEFINE_ALBEDOTEXTURE):this._shaderValues.removeDefine(xi.SHADERDEFINE_ALBEDOTEXTURE),this._shaderValues.setTexture(xi.ALBEDOTEXTURE,e)}},{key:"tilingOffsetX",get:function(){return this._MainTex_STX},set:function(e){this._MainTex_STX=e}},{key:"tilingOffsetY",get:function(){return this._MainTex_STY},set:function(e){this._MainTex_STY=e}},{key:"tilingOffsetZ",get:function(){return this._MainTex_STZ},set:function(e){this._MainTex_STZ=e}},{key:"tilingOffsetW",get:function(){return this._MainTex_STW},set:function(e){this._MainTex_STW=e}},{key:"tilingOffset",get:function(){return this._shaderValues.getVector(xi.TILINGOFFSET)},set:function(e){e?this._shaderValues.setVector(xi.TILINGOFFSET,e):this._shaderValues.getVector(xi.TILINGOFFSET).setValue(1,1,0,0)}},{key:"enableVertexColor",get:function(){return this._enableVertexColor},set:function(e){this._enableVertexColor=e,e?this._shaderValues.addDefine(xi.SHADERDEFINE_ENABLEVERTEXCOLOR):this._shaderValues.removeDefine(xi.SHADERDEFINE_ENABLEVERTEXCOLOR)}},{key:"renderMode",set:function(e){switch(e){case xi.RENDERMODE_OPAQUE:this.alphaTest=!1,this.renderQueue=Gi.RENDERQUEUE_OPAQUE,this.depthWrite=!0,this.cull=Wi.CULL_BACK,this.blend=Wi.BLEND_DISABLE,this.depthTest=Wi.DEPTHTEST_LESS;break;case xi.RENDERMODE_CUTOUT:this.renderQueue=Gi.RENDERQUEUE_ALPHATEST,this.alphaTest=!0,this.depthWrite=!0,this.cull=Wi.CULL_BACK,this.blend=Wi.BLEND_DISABLE,this.depthTest=Wi.DEPTHTEST_LESS;break;case xi.RENDERMODE_TRANSPARENT:this.renderQueue=Gi.RENDERQUEUE_TRANSPARENT,this.alphaTest=!1,this.depthWrite=!1,this.cull=Wi.CULL_BACK,this.blend=Wi.BLEND_ENABLE_ALL,this.blendSrc=Wi.BLENDPARAM_SRC_ALPHA,this.blendDst=Wi.BLENDPARAM_ONE_MINUS_SRC_ALPHA,this.depthTest=Wi.DEPTHTEST_LESS;break;default:throw new Error("UnlitMaterial : renderMode value error.")}}}],[{key:"__initDefine__",value:function(){xi.SHADERDEFINE_ALBEDOTEXTURE=xn.getDefineByName("ALBEDOTEXTURE"),xi.SHADERDEFINE_ENABLEVERTEXCOLOR=xn.getDefineByName("ENABLEVERTEXCOLOR")}}]),xi}();eo.RENDERMODE_OPAQUE=0,eo.RENDERMODE_CUTOUT=1,eo.RENDERMODE_TRANSPARENT=2,eo.RENDERMODE_ADDTIVE=3,eo.ALBEDOTEXTURE=xn.propertyNameToID("u_AlbedoTexture"),eo.ALBEDOCOLOR=xn.propertyNameToID("u_AlbedoColor"),eo.TILINGOFFSET=xn.propertyNameToID("u_TilingOffset");var to=function(e){function Ii(){var e;return _classCallCheck(this,Ii),(e=_possibleConstructorReturn(this,_getPrototypeOf(Ii).call(this))).setShaderName("WaterPrimary"),e._shaderValues.setVector(Ii.HORIZONCOLOR,new o(.172,.463,.435,0)),e._shaderValues.setNumber(Ii.WAVESCALE,.15),e._shaderValues.setVector(Ii.WAVESPEED,new o(19,9,-16,-7)),e}return _inherits(Ii,Gi),_createClass(Ii,[{key:"clone",value:function(){var e=new Ii;return this.cloneTo(e),e}},{key:"horizonColor",get:function(){return this._shaderValues.getVector(Ii.HORIZONCOLOR)},set:function(e){this._shaderValues.setVector(Ii.HORIZONCOLOR,e)}},{key:"mainTexture",get:function(){return this._shaderValues.getTexture(Ii.MAINTEXTURE)},set:function(e){e?this._shaderValues.addDefine(Ii.SHADERDEFINE_MAINTEXTURE):this._shaderValues.removeDefine(Ii.SHADERDEFINE_MAINTEXTURE),this._shaderValues.setTexture(Ii.MAINTEXTURE,e)}},{key:"normalTexture",get:function(){return this._shaderValues.getTexture(Ii.NORMALTEXTURE)},set:function(e){e?this._shaderValues.addDefine(Ii.SHADERDEFINE_NORMALTEXTURE):this._shaderValues.removeDefine(Ii.SHADERDEFINE_NORMALTEXTURE),this._shaderValues.setTexture(Ii.NORMALTEXTURE,e)}},{key:"waveScale",get:function(){return this._shaderValues.getNumber(Ii.WAVESCALE)},set:function(e){this._shaderValues.setNumber(Ii.WAVESCALE,e)}},{key:"waveSpeed",get:function(){return this._shaderValues.getVector(Ii.WAVESPEED)},set:function(e){this._shaderValues.setVector(Ii.WAVESPEED,e)}}],[{key:"__initDefine__",value:function(){Ii.SHADERDEFINE_MAINTEXTURE=xn.getDefineByName("MAINTEXTURE"),Ii.SHADERDEFINE_NORMALTEXTURE=xn.getDefineByName("NORMALTEXTURE")}}]),Ii}();to.HORIZONCOLOR=xn.propertyNameToID("u_HorizonColor"),to.MAINTEXTURE=xn.propertyNameToID("u_MainTexture"),to.NORMALTEXTURE=xn.propertyNameToID("u_NormalTexture"),to.WAVESCALE=xn.propertyNameToID("u_WaveScale"),to.WAVESPEED=xn.propertyNameToID("u_WaveSpeed");var no=function(t){function Di(e){var t;return _classCallCheck(this,Di),(t=_possibleConstructorReturn(this,_getPrototypeOf(Di).call(this,e)))._revertStaticBatchDefineUV1=!1,t._projectionViewWorldMatrix=new q,t}return _inherits(Di,Ma),_createClass(Di,[{key:"_createRenderElement",value:function(){return new Ca}},{key:"_onMeshChange",value:function(e){if(e){var t=e.subMeshCount;this._renderElements.length=t;for(var n=0;n<t;n++){var i=this._renderElements[n];if(!i){var r=this.sharedMaterials[n];(i=this._renderElements[n]=this._createRenderElement()).setTransform(this._owner._transform),i.render=this,i.material=r||Ki.defaultMaterial}i.setGeometry(e.getSubMesh(n))}}else this._renderElements.length=0;this._boundsChange=!0}},{key:"_calculateBoundingBox",value:function(){var e=this._owner.meshFilter.sharedMesh;if(e){var t=this._owner.transform.worldMatrix;e.bounds._tranform(t,this._bounds)}}},{key:"_needRender",value:function(e,t){return!e||e.intersects(this.bounds._getBoundBox())}},{key:"_renderUpdate",value:function(t,n){this._applyLightMapParams();var i=t.renderElement;switch(i.renderType){case ci.RENDERTYPE_NORMAL:this._shaderValues.setMatrix4x4(Nn.WORLDMATRIX,n.worldMatrix);break;case ci.RENDERTYPE_STATICBATCH:n?this._shaderValues.setMatrix4x4(Nn.WORLDMATRIX,n.worldMatrix):this._shaderValues.setMatrix4x4(Nn.WORLDMATRIX,q.DEFAULT),this._shaderValues.hasDefine(Si.SHADERDEFINE_UV1)?this._revertStaticBatchDefineUV1=!1:(this._shaderValues.addDefine(Si.SHADERDEFINE_UV1),this._revertStaticBatchDefineUV1=!0),this._shaderValues.setVector(ya.LIGHTMAPSCALEOFFSET,Ma._defaultLightmapScaleOffset);break;case ci.RENDERTYPE_VERTEXBATCH:this._shaderValues.setMatrix4x4(Nn.WORLDMATRIX,q.DEFAULT);break;case ci.RENDERTYPE_INSTANCEBATCH:for(var r=Ra.instance.instanceWorldMatrixData,a=i.instanceBatchElementList,o=a.elements,s=a.length,l=0;l<s;l++)r.set(o[l]._transform.worldMatrix.elements,16*l);var u=Ra.instance.instanceWorldMatrixBuffer;u.orphanStorage(),u.setData(r.buffer,0,0,16*s*4),this._shaderValues.addDefine(Si.SHADERDEFINE_GPU_INSTANCE)}this._probReflection&&(this._reflectionMode==e.ReflectionProbeMode.off?(this._shaderValues.removeDefine(Si.SHADERDEFINE_SPECCUBE_BOX_PROJECTION),this._shaderValues.setVector(ya.REFLECTIONCUBE_HDR_PARAMS,Da.defaultTextureHDRDecodeValues),this._shaderValues.setTexture(ya.REFLECTIONTEXTURE,ha.blackTexture)):(this._probReflection.boxProjection?(this._shaderValues.addDefine(Si.SHADERDEFINE_SPECCUBE_BOX_PROJECTION),this._shaderValues.setVector3(ya.REFLECTIONCUBE_PROBEPOSITION,this._probReflection.probePosition),this._shaderValues.setVector3(ya.REFLECTIONCUBE_PROBEBOXMAX,this._probReflection.boundsMax),this._shaderValues.setVector3(ya.REFLECTIONCUBE_PROBEBOXMIN,this._probReflection.boundsMin)):this._shaderValues.removeDefine(Si.SHADERDEFINE_SPECCUBE_BOX_PROJECTION),this._shaderValues.setTexture(ya.REFLECTIONTEXTURE,this._probReflection.reflectionTexture),this._shaderValues.setVector(ya.REFLECTIONCUBE_HDR_PARAMS,this._probReflection.reflectionHDRParams)))}},{key:"_renderUpdateWithCamera",value:function(e,t){var n=e.projectionViewMatrix;if(n)switch(e.renderElement.renderType){case ci.RENDERTYPE_NORMAL:case ci.RENDERTYPE_STATICBATCH:case ci.RENDERTYPE_VERTEXBATCH:t?(q.multiply(n,t.worldMatrix,this._projectionViewWorldMatrix),this._shaderValues.setMatrix4x4(Nn.MVPMATRIX,this._projectionViewWorldMatrix)):this._shaderValues.setMatrix4x4(Nn.MVPMATRIX,n)}}},{key:"_revertBatchRenderUpdate",value:function(e){switch(e.renderElement.renderType){case ci.RENDERTYPE_STATICBATCH:this._revertStaticBatchDefineUV1&&this._shaderValues.removeDefine(Si.SHADERDEFINE_UV1),this._shaderValues.setVector(ya.LIGHTMAPSCALEOFFSET,this.lightmapScaleOffset);break;case ci.RENDERTYPE_INSTANCEBATCH:this._shaderValues.removeDefine(Si.SHADERDEFINE_GPU_INSTANCE)}}},{key:"_destroy",value:function(){this._isPartOfStaticBatch&&xa.instance._removeRenderSprite(this._owner),_get(_getPrototypeOf(Di.prototype),"_destroy",this).call(this)}}]),Di}(),io=function(){function Ci(e){_classCallCheck(this,Ci),this._owner=e}return _createClass(Ci,[{key:"_getMeshDefine",value:function(e,t){t.length=0;for(var n=0,i=e._subMeshes.length;n<i;n++)for(var r=e.getSubMesh(n)._vertexBuffer._vertexDeclaration._vertexElements,a=0,o=r.length;a<o;a++)switch(r[a]._elementUsage){case Xn.MESH_COLOR0:t.push(Si.SHADERDEFINE_COLOR);break;case Xn.MESH_TEXTURECOORDINATE0:t.push(Si.SHADERDEFINE_UV0);break;case Xn.MESH_TEXTURECOORDINATE1:t.push(Si.SHADERDEFINE_UV1)}}},{key:"destroy",value:function(){this._owner=null,this._sharedMesh&&(this._sharedMesh._removeReference(),this._sharedMesh=null)}},{key:"sharedMesh",get:function(){return this._sharedMesh},set:function(e){if(this._sharedMesh!==e){var t=this._owner._render._shaderValues,n=this._sharedMesh;if(n){n._removeReference(),this._getMeshDefine(n,Ci._meshVerticeDefine);for(var i=0,r=Ci._meshVerticeDefine.length;i<r;i++)t.removeDefine(Ci._meshVerticeDefine[i])}if(e)for(e._addReference(),this._getMeshDefine(e,Ci._meshVerticeDefine),i=0,r=Ci._meshVerticeDefine.length;i<r;i++)t.addDefine(Ci._meshVerticeDefine[i]);this._owner._render._onMeshChange(e),this._sharedMesh=e}}}]),Ci}();io._meshVerticeDefine=[];var ro=function(n){function Mi(){var n;_classCallCheck(this,Mi),(n=_possibleConstructorReturn(this,_getPrototypeOf(Mi).call(this)))._bufferState=new yn;var i=t.LayaGL.instance,r=Xn.getVertexDeclaration("POSITION,NORMAL,COLOR,UV,UV1,TANGENT").vertexStride*Mi.maxIndicesCount;n._vertices=new Float32Array(r/4),n._vertexBuffer=new pn(r,i.DYNAMIC_DRAW),n._indices=new Int16Array(Mi.maxIndicesCount),n._indexBuffer=new Wn(e.IndexFormat.UInt16,n._indices.length,i.DYNAMIC_DRAW);var a=n._vertexBuffer._byteLength+n._indexBuffer._byteLength;return t.Resource._addMemory(a,a),n}return _inherits(Mi,Ea),_createClass(Mi,[{key:"_getBatchVertices",value:function(e,t,n,i,r){var a=e.vertexStride/4,o=r._vertexBuffer.getFloat32Data(),s=i._dynamicMultiSubMesh,l=i._dynamicVertexCount;i._computeWorldPositionsAndNormals(this._positionOffset,this._normalOffset,s,l);for(var u=i._dynamicWorldPositions,_=i._dynamicWorldNormals,c=r._indices,h=0;h<l;h++){var d=(s?c[h]:h)*a,f=(h+n)*a,m=3*h,p=f+this._positionOffset;t[p]=u[m],t[p+1]=u[m+1],t[p+2]=u[m+2],-1!==this._normalOffset&&(t[p=f+this._normalOffset]=_[m],t[p+1]=_[m+1],t[p+2]=_[m+2]),-1!==this._colorOffset&&(p=f+this._colorOffset,m=d+this._colorOffset,t[p]=o[m],t[p+1]=o[m+1],t[p+2]=o[m+2],t[p+3]=o[m+3]),-1!==this._uv0Offset&&(p=f+this._uv0Offset,m=d+this._uv0Offset,t[p]=o[m],t[p+1]=o[m+1]),-1!==this._sTangentOffset&&(p=f+this._sTangentOffset,m=d+this._sTangentOffset,t[p]=o[m],t[p+1]=o[m+1],t[p+2]=o[m+2],t[p+3]=o[m+3],p=f+this._sTangentOffset,m=d+this._sTangentOffset,t[p]=o[m],t[p+1]=o[m+1],t[p+2]=o[m+2],t[p+3]=o[m+3])}}},{key:"_getBatchIndices",value:function(e,t,n,i,r,a){var o,s,l,u=r._indices,_=i._isFrontFaceInvert;if(a)if(_)for(o=0,s=u.length;o<s;o+=3){var c=n+o;e[l=t+o]=c,e[l+1]=c+2,e[l+2]=c+1}else for(o=0,s=u.length;o<s;o+=3)c=n+o,e[l=t+o]=c,e[l+1]=c+1,e[l+2]=c+2;else if(_)for(o=0,s=u.length;o<s;o+=3)e[l=t+o]=n+u[o],e[l+1]=n+u[o+2],e[l+2]=n+u[o+1];else for(o=0,s=u.length;o<s;o+=3)e[l=t+o]=n+u[o],e[l+1]=n+u[o+1],e[l+2]=n+u[o+2]}},{key:"_flush",value:function(e,n){var i=t.LayaGL.instance;this._vertexBuffer.setData(this._vertices.buffer,0,0,e*this._bufferState.vertexDeclaration.vertexStride),this._indexBuffer.setData(this._indices,0,0,n),i.drawElements(i.TRIANGLES,n,i.UNSIGNED_SHORT,0)}},{key:"_prepareRender",value:function(e){var t=e.renderElement.vertexBatchVertexDeclaration;this._bufferState=F.MeshRenderDynamicBatchManager.instance._getBufferState(t),this._positionOffset=t.getVertexElementByUsage(Xn.MESH_POSITION0)._offset/4;var n=t.getVertexElementByUsage(Xn.MESH_NORMAL0);this._normalOffset=n?n._offset/4:-1;var i=t.getVertexElementByUsage(Xn.MESH_COLOR0);this._colorOffset=i?i._offset/4:-1;var r=t.getVertexElementByUsage(Xn.MESH_TEXTURECOORDINATE0);this._uv0Offset=r?r._offset/4:-1;var a=t.getVertexElementByUsage(Xn.MESH_TEXTURECOORDINATE1);this._uv1Offset=a?a._offset/4:-1;var o=t.getVertexElementByUsage(Xn.MESH_TANGENT0);return this._sTangentOffset=o?o._offset/4:-1,!0}},{key:"_render",value:function(e){this._bufferState.bind();for(var n=e.renderElement,i=n.vertexBatchVertexDeclaration,r=n.vertexBatchElementList,a=0,o=0,s=0,l=r.length,u=r.elements,_=0;_<l;_++){var c=u[_],h=c._geometry,d=h._indexCount;o+d>Mi.maxIndicesCount&&(this._flush(a,o),s++,t.Stat.trianglesFaces+=o/3,a=o=0);var f=c._transform;this._getBatchVertices(i,this._vertices,a,c,h),this._getBatchIndices(this._indices,o,a,f,h,c._dynamicMultiSubMesh),a+=c._dynamicVertexCount,o+=d}this._flush(a,o),s++,t.Stat.renderBatches+=s,t.Stat.savedRenderBatches+=l-s,t.Stat.trianglesFaces+=o/3}}],[{key:"__init__",value:function(){Mi.instance=new Mi}}]),Mi}();ro.maxAllowVertexCount=10,ro.maxAllowAttribueCount=900,ro.maxIndicesCount=32e3;var ao=function(e){function yi(){var e;return _classCallCheck(this,yi),(e=_possibleConstructorReturn(this,_getPrototypeOf(yi).call(this)))._instanceBatchOpaqueMarks=[],e._vertexBatchOpaqueMarks=[],e._cacheBufferStates=[],e._updateCountMark=0,e}return _inherits(yi,Ga),_createClass(yi,[{key:"getInstanceBatchOpaquaMark",value:function(e,t,n,i){var r=this._instanceBatchOpaqueMarks[e?0:1]||(this._instanceBatchOpaqueMarks[e?0:1]=[]),a=r[t]||(r[t]=[]),o=a[n]||(a[n]=[]);return o[i?1:0]||(o[i?1:0]=new Sa)}},{key:"getVertexBatchOpaquaMark",value:function(e,t,n,i){var r=this._vertexBatchOpaqueMarks[e]||(this._vertexBatchOpaqueMarks[e]=[]),a=r[t?0:1]||(r[t?0:1]=[]),o=a[n]||(a[n]=[]);return o[i]||(o[i]=new Sa)}},{key:"_getBufferState",value:function(e){var t=this._cacheBufferStates[e.id];if(!t){var n=ro.instance;(t=new yn).bind();var i=n._vertexBuffer;i.vertexDeclaration=e,t.applyVertexBuffer(i),t.applyIndexBuffer(n._indexBuffer),t.unBind(),this._cacheBufferStates[e.id]=t}return t}},{key:"_getBatchRenderElementFromPool",value:function(){var e=this._batchRenderElementPool[this._batchRenderElementPoolIndex++];return e||(e=new Ca,this._batchRenderElementPool[this._batchRenderElementPoolIndex-1]=e,e.vertexBatchElementList=new Ye,e.instanceBatchElementList=new Ye),e}},{key:"_clear",value:function(){_get(_getPrototypeOf(yi.prototype),"_clear",this).call(this),this._updateCountMark++}}]),yi}();ao.instance=new ao;var oo=function(e){function Li(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return _classCallCheck(this,Li),(e=_possibleConstructorReturn(this,_getPrototypeOf(Li).call(this,n)))._meshFilter=new io(_assertThisInitialized(e)),e._render=new no(_assertThisInitialized(e)),t&&(e._meshFilter.sharedMesh=t),e}return _inherits(Li,ya),_createClass(Li,[{key:"_parse",value:function(e,n){_get(_getPrototypeOf(Li.prototype),"_parse",this).call(this,e,n);var i=this.meshRenderer,r=e.lightmapIndex;null!=r&&(i.lightmapIndex=r);var a=e.lightmapScaleOffset;a&&(i.lightmapScaleOffset=new o(a[0],a[1],a[2],a[3])),null!=e.meshPath&&(this.meshFilter.sharedMesh=t.Loader.getRes(e.meshPath)),null!=e.enableRender&&(i.enable=e.enableRender),null!=e.receiveShadows&&(i.receiveShadow=e.receiveShadows),null!=e.castShadow&&(i.castShadow=e.castShadow);var s=e.materials;if(s){var l=i.sharedMaterials,u=s.length;l.length=u;for(var _=0;_<u;_++)l[_]=t.Loader.getRes(s[_].path);i.sharedMaterials=l}}},{key:"_addToInitStaticBatchManager",value:function(){this.meshFilter.sharedMesh&&xa.instance._addBatchSprite(this)}},{key:"_cloneTo",value:function(e,t,n){var i=e;i._meshFilter.sharedMesh=this._meshFilter.sharedMesh;var r=this._render,a=i._render;a.enable=r.enable,a.sharedMaterials=r.sharedMaterials,a.castShadow=r.castShadow;var o=r.lightmapScaleOffset;o&&(a.lightmapScaleOffset=o.clone()),a.lightmapIndex=r.lightmapIndex,a.receiveShadow=r.receiveShadow,a.sortingFudge=r.sortingFudge,_get(_getPrototypeOf(Li.prototype),"_cloneTo",this).call(this,e,t,n)}},{key:"destroy",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];this.destroyed||(_get(_getPrototypeOf(Li.prototype),"destroy",this).call(this,e),this._meshFilter.destroy())}},{key:"_create",value:function(){return new Li}},{key:"meshFilter",get:function(){return this._meshFilter}},{key:"meshRenderer",get:function(){return this._render}}],[{key:"__init__",value:function(){Si.SHADERDEFINE_UV0=xn.getDefineByName("UV"),Si.SHADERDEFINE_COLOR=xn.getDefineByName("COLOR"),Si.SHADERDEFINE_UV1=xn.getDefineByName("UV1"),Si.SHADERDEFINE_GPU_INSTANCE=xn.getDefineByName("GPU_INSTANCE"),Si.SHADERDEFINE_SPECCUBE_BOX_PROJECTION=xn.getDefineByName("SPECCUBE_BOX_PROJECTION"),Aa._registerManager(xa.instance),Ga._registerManager(ao.instance)}}]),Li}(),so=function Oi(){_classCallCheck(this,Oi)};so.Blend=0,so.Fixed=1;var lo=function(){function Ni(e,t){_classCallCheck(this,Ni),this._mode=0,this._maxColorRGBKeysCount=0,this._maxColorAlphaKeysCount=0,this._colorRGBKeysCount=0,this._colorAlphaKeysCount=0,this._alphaElements=null,this._rgbElements=null,this._maxColorRGBKeysCount=e,this._maxColorAlphaKeysCount=t,this._rgbElements=new Float32Array(4*e),this._alphaElements=new Float32Array(2*t)}return _createClass(Ni,[{key:"addColorRGB",value:function(e,t){if(this._colorRGBKeysCount<this._maxColorRGBKeysCount){var n=4*this._colorRGBKeysCount;this._rgbElements[n]=e,this._rgbElements[n+1]=t.r,this._rgbElements[n+2]=t.g,this._rgbElements[n+3]=t.b,this._colorRGBKeysCount++}else console.warn("Gradient:warning:data count must lessEqual than "+this._maxColorRGBKeysCount)}},{key:"addColorAlpha",value:function(e,t){if(this._colorAlphaKeysCount<this._maxColorAlphaKeysCount){var n=2*this._colorAlphaKeysCount;this._alphaElements[n]=e,this._alphaElements[n+1]=t,this._colorAlphaKeysCount++}else console.warn("Gradient:warning:data count must lessEqual than "+this._maxColorAlphaKeysCount)}},{key:"updateColorRGB",value:function(e,t,n){if(e<this._colorRGBKeysCount){var i=4*e;this._rgbElements[i]=t,this._rgbElements[i+1]=n.r,this._rgbElements[i+2]=n.g,this._rgbElements[i+3]=n.b}else console.warn("Gradient:warning:index must lessEqual than colorRGBKeysCount:"+this._colorRGBKeysCount)}},{key:"updateColorAlpha",value:function(e,t,n){if(e<this._colorAlphaKeysCount){var i=2*e;this._alphaElements[i]=t,this._alphaElements[i+1]=n}else console.warn("Gradient:warning:index must lessEqual than colorAlphaKeysCount:"+this._colorAlphaKeysCount)}},{key:"evaluateColorRGB",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,i=arguments.length>3&&void 0!==arguments[3]&&arguments[3];e=Math.min(Math.max(e,0),1);var r=this._rgbElements,a=n;if(i)for(var o=a;o>=0;o--){var s=4*o;if(e===(d=r[s]))return t.r=r[s+1],t.g=r[s+2],t.b=r[s+3],a;switch(this._mode){case so.Blend:if(e>d){if(e>(h=r[s+4]))throw"Gradient:wrong startSearchIndex.";var l=h-d,u=h-e,_=e-d;return t.r=(u*r[s+1]+_*r[s+5])/l,t.g=(u*r[s+2]+_*r[s+6])/l,t.b=(u*r[s+3]+_*r[s+7])/l,a}a--;continue;case so.Fixed:if(e>d){if(e>r[s+4])throw"Gradient:wrong startSearchIndex.";return t.r=r[s+5],t.g=r[s+6],t.b=r[s+7],a}a--;continue;default:throw"Gradient:unknown mode."}}else{o=0;for(var c=this._rgbElements.length;o<c;o++){var h;if(e===(h=r[s=4*o]))return t.r=r[s+1],t.g=r[s+2],t.b=r[s+3],a;switch(this._mode){case so.Blend:if(e<h){var d;if(e<(d=r[s-4]))throw"Gradient:wrong startSearchIndex.";return l=h-d,u=h-e,_=e-d,t.r=(u*r[s-3]+_*r[s+1])/l,t.g=(u*r[s-2]+_*r[s+2])/l,t.b=(u*r[s-1]+_*r[s+3])/l,a}a++;continue;case so.Fixed:if(e<h){if(e<r[s-4])throw"Gradient:wrong startSearchIndex.";return t.r=r[s+1],t.g=r[s+2],t.b=r[s+3],a}a++;continue;default:throw"Gradient:unknown mode."}}}return a}},{key:"evaluateColorAlpha",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,i=arguments.length>3&&void 0!==arguments[3]&&arguments[3];e=Math.min(Math.max(e,0),1);var r=this._alphaElements,a=n;if(i)for(var o=a;o>=0;o--){if(e===(d=r[c=2*o]))return t.a=r[c+1],a;switch(this._mode){case so.Blend:if(e>d){if(e>(h=r[c+2]))throw"Gradient:wrong startSearchIndex.";var s=h-d,l=h-e,u=e-d;return t.a=(l*r[c+1]+u*r[c+3])/s,a}a--;continue;case so.Fixed:if(e>d){if(e>r[c+2])throw"Gradient:wrong startSearchIndex.";return t.a=r[c+3],a}a--;continue;default:throw"Gradient:unknown mode."}}else{o=a;for(var _=this._alphaElements.length;o<_;o++){var c,h;if(e===(h=r[c=2*o]))return t.a=r[c+1],a;switch(this._mode){case so.Blend:if(e<h){var d;if(e<(d=r[c-2]))throw"Gradient:wrong startSearchIndex.";return s=h-d,l=h-e,u=e-d,t.a=(l*r[c-1]+u*r[c+1])/s,a}a++;continue;case so.Fixed:if(e<h){if(e<r[c-2])throw"Gradient:wrong startSearchIndex.";return t.a=r[c+1],a}a++;continue;default:throw"Gradient:unknown mode."}}}return a}},{key:"cloneTo",value:function(e){var t,n,i=e;i._colorAlphaKeysCount=this._colorAlphaKeysCount;var r=i._alphaElements;for(t=0,n=this._alphaElements.length;t<n;t++)r[t]=this._alphaElements[t];i._colorRGBKeysCount=this._colorRGBKeysCount;var a=i._rgbElements;for(t=0,n=this._rgbElements.length;t<n;t++)a[t]=this._rgbElements[t]}},{key:"clone",value:function(){var e=new Ni(this._maxColorRGBKeysCount,this._maxColorAlphaKeysCount);return this.cloneTo(e),e}},{key:"mode",get:function(){return this._mode},set:function(e){this._mode=e}},{key:"colorRGBKeysCount",get:function(){return this._colorRGBKeysCount}},{key:"colorAlphaKeysCount",get:function(){return this._colorAlphaKeysCount}},{key:"maxColorRGBKeysCount",get:function(){return this._maxColorRGBKeysCount}},{key:"maxColorAlphaKeysCount",get:function(){return this._maxColorAlphaKeysCount}}]),Ni}(),uo=function(){function Pi(e,t,n){_classCallCheck(this,Pi),this._time=e,this._minCount=t,this._maxCount=n}return _createClass(Pi,[{key:"cloneTo",value:function(e){var t=e;t._time=this._time,t._minCount=this._minCount,t._maxCount=this._maxCount}},{key:"clone",value:function(){var e=new Pi(this._time,this._minCount,this._maxCount);return this.cloneTo(e),e}},{key:"time",get:function(){return this._time}},{key:"minCount",get:function(){return this._minCount}},{key:"maxCount",get:function(){return this._maxCount}}]),Pi}(),_o=function(){function bi(){_classCallCheck(this,bi),this._type=0,this._constant=null,this._constantMin=null,this._constantMax=null,this._gradient=null,this._gradientMin=null,this._gradientMax=null}return _createClass(bi,[{key:"cloneTo",value:function(e){var t=e;t._type=this._type,this._constant.cloneTo(t._constant),this._constantMin.cloneTo(t._constantMin),this._constantMax.cloneTo(t._constantMax),this._gradient.cloneTo(t._gradient),this._gradientMin.cloneTo(t._gradientMin),this._gradientMax.cloneTo(t._gradientMax)}},{key:"clone",value:function(){var e=new bi;return this.cloneTo(e),e}},{key:"type",get:function(){return this._type}},{key:"constant",get:function(){return this._constant}},{key:"constantMin",get:function(){return this._constantMin}},{key:"constantMax",get:function(){return this._constantMax}},{key:"gradient",get:function(){return this._gradient}},{key:"gradientMin",get:function(){return this._gradientMin}},{key:"gradientMax",get:function(){return this._gradientMax}}],[{key:"createByConstant",value:function(e){var t=new bi;return t._type=0,t._constant=e,t}},{key:"createByGradient",value:function(e){var t=new bi;return t._type=1,t._gradient=e,t}},{key:"createByRandomTwoConstant",value:function(e,t){var n=new bi;return n._type=2,n._constantMin=e,n._constantMax=t,n}},{key:"createByRandomTwoGradient",value:function(e,t){var n=new bi;return n._type=3,n._gradientMin=e,n._gradientMax=t,n}}]),bi}(),co=function(){function wi(e){_classCallCheck(this,wi),this._color=e}return _createClass(wi,[{key:"cloneTo",value:function(e){var t=e;this._color.cloneTo(t._color),t.enable=this.enable}},{key:"clone",value:function(){var e;switch(this._color.type){case 0:e=_o.createByConstant(this._color.constant.clone());break;case 1:e=_o.createByGradient(this._color.gradient.clone());break;case 2:e=_o.createByRandomTwoConstant(this._color.constantMin.clone(),this._color.constantMax.clone());break;case 3:e=_o.createByRandomTwoGradient(this._color.gradientMin.clone(),this._color.gradientMax.clone())}var t=new wi(e);return t.enable=this.enable,t}},{key:"color",get:function(){return this._color}}]),wi}(),ho=function(){function Vi(){_classCallCheck(this,Vi),this._type=0,this._constant=0,this._overTime=null,this._constantMin=0,this._constantMax=0,this._overTimeMin=null,this._overTimeMax=null}return _createClass(Vi,[{key:"cloneTo",value:function(e){var t=e;t._type=this._type,t._constant=this._constant,this._overTime&&this._overTime.cloneTo(t._overTime),t._constantMin=this._constantMin,t._constantMax=this._constantMax,this._overTimeMin&&this._overTimeMin.cloneTo(t._overTimeMin),this._overTimeMax&&this._overTimeMax.cloneTo(t._overTimeMax)}},{key:"clone",value:function(){var e=new Vi;return this.cloneTo(e),e}},{key:"type",get:function(){return this._type}},{key:"constant",get:function(){return this._constant}},{key:"frameOverTimeData",get:function(){return this._overTime}},{key:"constantMin",get:function(){return this._constantMin}},{key:"constantMax",get:function(){return this._constantMax}},{key:"frameOverTimeDataMin",get:function(){return this._overTimeMin}},{key:"frameOverTimeDataMax",get:function(){return this._overTimeMax}}],[{key:"createByConstant",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=new Vi;return t._type=0,t._constant=e,t}},{key:"createByOverTime",value:function(e){var t=new Vi;return t._type=1,t._overTime=e,t}},{key:"createByRandomTwoConstant",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=new Vi;return n._type=2,n._constantMin=e,n._constantMax=t,n}},{key:"createByRandomTwoOverTime",value:function(e,t){var n=new Vi;return n._type=3,n._overTimeMin=e,n._overTimeMax=t,n}}]),Vi}(),fo=function(){function Bi(){_classCallCheck(this,Bi),this._type=0,this._separateAxes=!1,this._constant=0,this._constantSeparate=null,this._gradient=null,this._gradientX=null,this._gradientY=null,this._gradientZ=null,this._gradientW=null,this._constantMin=0,this._constantMax=0,this._constantMinSeparate=null,this._constantMaxSeparate=null,this._gradientMin=null,this._gradientMax=null,this._gradientXMin=null,this._gradientXMax=null,this._gradientYMin=null,this._gradientYMax=null,this._gradientZMin=null,this._gradientZMax=null,this._gradientWMin=null,this._gradientWMax=null}return _createClass(Bi,[{key:"cloneTo",value:function(e){var t=e;t._type=this._type,t._separateAxes=this._separateAxes,t._constant=this._constant,this._constantSeparate.cloneTo(t._constantSeparate),this._gradient.cloneTo(t._gradient),this._gradientX.cloneTo(t._gradientX),this._gradientY.cloneTo(t._gradientY),this._gradientZ.cloneTo(t._gradientZ),t._constantMin=this._constantMin,t._constantMax=this._constantMax,this._constantMinSeparate.cloneTo(t._constantMinSeparate),this._constantMaxSeparate.cloneTo(t._constantMaxSeparate),this._gradientMin.cloneTo(t._gradientMin),this._gradientMax.cloneTo(t._gradientMax),this._gradientXMin.cloneTo(t._gradientXMin),this._gradientXMax.cloneTo(t._gradientXMax),this._gradientYMin.cloneTo(t._gradientYMin),this._gradientYMax.cloneTo(t._gradientYMax),this._gradientZMin.cloneTo(t._gradientZMin),this._gradientZMax.cloneTo(t._gradientZMax)}},{key:"clone",value:function(){var e=new Bi;return this.cloneTo(e),e}},{key:"type",get:function(){return this._type}},{key:"separateAxes",get:function(){return this._separateAxes}},{key:"constant",get:function(){return this._constant}},{key:"constantSeparate",get:function(){return this._constantSeparate}},{key:"gradient",get:function(){return this._gradient}},{key:"gradientX",get:function(){return this._gradientX}},{key:"gradientY",get:function(){return this._gradientY}},{key:"gradientZ",get:function(){return this._gradientZ}},{key:"gradientW",get:function(){return this._gradientW}},{key:"constantMin",get:function(){return this._constantMin}},{key:"constantMax",get:function(){return this._constantMax}},{key:"constantMinSeparate",get:function(){return this._constantMinSeparate}},{key:"constantMaxSeparate",get:function(){return this._constantMaxSeparate}},{key:"gradientMin",get:function(){return this._gradientMin}},{key:"gradientMax",get:function(){return this._gradientMax}},{key:"gradientXMin",get:function(){return this._gradientXMin}},{key:"gradientXMax",get:function(){return this._gradientXMax}},{key:"gradientYMin",get:function(){return this._gradientYMin}},{key:"gradientYMax",get:function(){return this._gradientYMax}},{key:"gradientZMin",get:function(){return this._gradientZMin}},{key:"gradientZMax",get:function(){return this._gradientZMax}},{key:"gradientWMin",get:function(){return this._gradientWMin}},{key:"gradientWMax",get:function(){return this._gradientWMax}}],[{key:"createByConstant",value:function(e){var t=new Bi;return t._type=0,t._separateAxes=!1,t._constant=e,t}},{key:"createByConstantSeparate",value:function(e){var t=new Bi;return t._type=0,t._separateAxes=!0,t._constantSeparate=e,t}},{key:"createByGradient",value:function(e){var t=new Bi;return t._type=1,t._separateAxes=!1,t._gradient=e,t}},{key:"createByGradientSeparate",value:function(e,t,n){var i=new Bi;return i._type=1,i._separateAxes=!0,i._gradientX=e,i._gradientY=t,i._gradientZ=n,i}},{key:"createByRandomTwoConstant",value:function(e,t){var n=new Bi;return n._type=2,n._separateAxes=!1,n._constantMin=e,n._constantMax=t,n}},{key:"createByRandomTwoConstantSeparate",value:function(e,t){var n=new Bi;return n._type=2,n._separateAxes=!0,n._constantMinSeparate=e,n._constantMaxSeparate=t,n}},{key:"createByRandomTwoGradient",value:function(e,t){var n=new Bi;return n._type=3,n._separateAxes=!1,n._gradientMin=e,n._gradientMax=t,n}},{key:"createByRandomTwoGradientSeparate",value:function(e,t,n,i,r,a,o,s){var l=new Bi;return l._type=3,l._separateAxes=!0,l._gradientXMin=e,l._gradientXMax=t,l._gradientYMin=n,l._gradientYMax=i,l._gradientZMin=r,l._gradientZMax=a,l._gradientWMin=o,l._gradientWMax=s,l}}]),Bi}(),mo=function(){function Fi(){_classCallCheck(this,Fi),this._currentLength=0,this._elements=new Float32Array(8)}return _createClass(Fi,[{key:"add",value:function(e,t){this._currentLength<8?(6===this._currentLength&&1!==e&&(e=1,console.log("Warning:the forth key is  be force set to 1.")),this._elements[this._currentLength++]=e,this._elements[this._currentLength++]=t):console.log("Warning:data count must lessEqual than 4")}},{key:"cloneTo",value:function(e){var t=e;t._currentLength=this._currentLength;for(var n=t._elements,i=0,r=this._elements.length;i<r;i++)n[i]=this._elements[i]}},{key:"clone",value:function(){var e=new Fi;return this.cloneTo(e),e}},{key:"gradientCount",get:function(){return this._currentLength/2}}]),Fi}(),po=function(){function Ui(){_classCallCheck(this,Ui),this._currentLength=0,this._elements=new Float32Array(8)}return _createClass(Ui,[{key:"add",value:function(e,t){this._currentLength<8?(6===this._currentLength&&1!==e&&(e=1,console.log("GradientDataNumber warning:the forth key is  be force set to 1.")),this._elements[this._currentLength++]=e,this._elements[this._currentLength++]=t):console.log("GradientDataNumber warning:data count must lessEqual than 4")}},{key:"getKeyByIndex",value:function(e){return this._elements[2*e]}},{key:"getValueByIndex",value:function(e){return this._elements[2*e+1]}},{key:"getAverageValue",value:function(){for(var e=0,t=0,n=0,i=this._currentLength-2;n<i;n+=2){var r=this._elements[n+1];r+=this._elements[n+3],e+=r*=this._elements[n+2]-this._elements[n],t++}return e/t}},{key:"cloneTo",value:function(e){var t=e;t._currentLength=this._currentLength;for(var n=t._elements,i=0,r=this._elements.length;i<r;i++)n[i]=this._elements[i]}},{key:"clone",value:function(){var e=new Ui;return this.cloneTo(e),e}},{key:"gradientCount",get:function(){return this._currentLength/2}}]),Ui}(),vo=function(){function Gi(){_classCallCheck(this,Gi),this._type=0,this._separateAxes=!1,this._gradient=null,this._gradientX=null,this._gradientY=null,this._gradientZ=null,this._constantMin=0,this._constantMax=0,this._constantMinSeparate=null,this._constantMaxSeparate=null,this._gradientMin=null,this._gradientMax=null,this._gradientXMin=null,this._gradientXMax=null,this._gradientYMin=null,this._gradientYMax=null,this._gradientZMin=null,this._gradientZMax=null}return _createClass(Gi,[{key:"getMaxSizeInGradient",value:function(){var e,t,n=arguments.length>0&&void 0!==arguments[0]&&arguments[0],i=-Number.MAX_VALUE;switch(this._type){case 0:if(this._separateAxes){for(e=0,t=this._gradientX.gradientCount;e<t;e++)i=Math.max(i,this._gradientX.getValueByIndex(e));for(e=0,t=this._gradientY.gradientCount;e<t;e++)i=Math.max(i,this._gradientY.getValueByIndex(e));if(n)for(e=0,t=this._gradientZ.gradientCount;e<t;e++)i=Math.max(i,this._gradientZ.getValueByIndex(e))}else for(e=0,t=this._gradient.gradientCount;e<t;e++)i=Math.max(i,this._gradient.getValueByIndex(e));break;case 1:this._separateAxes?(i=Math.max(this._constantMinSeparate.x,this._constantMaxSeparate.x),i=Math.max(i,this._constantMinSeparate.y),n&&(i=i=Math.max(i,this._constantMaxSeparate.z))):i=Math.max(this._constantMin,this._constantMax);break;case 2:if(this._separateAxes){for(e=0,t=this._gradientXMin.gradientCount;e<t;e++)i=Math.max(i,this._gradientXMin.getValueByIndex(e));for(e=0,t=this._gradientXMax.gradientCount;e<t;e++)i=Math.max(i,this._gradientXMax.getValueByIndex(e));for(e=0,t=this._gradientYMin.gradientCount;e<t;e++)i=Math.max(i,this._gradientYMin.getValueByIndex(e));for(e=0,t=this._gradientZMax.gradientCount;e<t;e++)i=Math.max(i,this._gradientZMax.getValueByIndex(e));if(n){for(e=0,t=this._gradientZMin.gradientCount;e<t;e++)i=Math.max(i,this._gradientZMin.getValueByIndex(e));for(e=0,t=this._gradientZMax.gradientCount;e<t;e++)i=Math.max(i,this._gradientZMax.getValueByIndex(e))}}else{for(e=0,t=this._gradientMin.gradientCount;e<t;e++)i=Math.max(i,this._gradientMin.getValueByIndex(e));for(e=0,t=this._gradientMax.gradientCount;e<t;e++)i=Math.max(i,this._gradientMax.getValueByIndex(e))}}return i}},{key:"cloneTo",value:function(e){var t=e;t._type=this._type,t._separateAxes=this._separateAxes,this._gradient.cloneTo(t._gradient),this._gradientX.cloneTo(t._gradientX),this._gradientY.cloneTo(t._gradientY),this._gradientZ.cloneTo(t._gradientZ),t._constantMin=this._constantMin,t._constantMax=this._constantMax,this._constantMinSeparate.cloneTo(t._constantMinSeparate),this._constantMaxSeparate.cloneTo(t._constantMaxSeparate),this._gradientMin.cloneTo(t._gradientMin),this._gradientMax.cloneTo(t._gradientMax),this._gradientXMin.cloneTo(t._gradientXMin),this._gradientXMax.cloneTo(t._gradientXMax),this._gradientYMin.cloneTo(t._gradientYMin),this._gradientYMax.cloneTo(t._gradientYMax),this._gradientZMin.cloneTo(t._gradientZMin),this._gradientZMax.cloneTo(t._gradientZMax)}},{key:"clone",value:function(){var e=new Gi;return this.cloneTo(e),e}},{key:"type",get:function(){return this._type}},{key:"separateAxes",get:function(){return this._separateAxes}},{key:"gradient",get:function(){return this._gradient}},{key:"gradientX",get:function(){return this._gradientX}},{key:"gradientY",get:function(){return this._gradientY}},{key:"gradientZ",get:function(){return this._gradientZ}},{key:"constantMin",get:function(){return this._constantMin}},{key:"constantMax",get:function(){return this._constantMax}},{key:"constantMinSeparate",get:function(){return this._constantMinSeparate}},{key:"constantMaxSeparate",get:function(){return this._constantMaxSeparate}},{key:"gradientMin",get:function(){return this._gradientMin}},{key:"gradientMax",get:function(){return this._gradientMax}},{key:"gradientXMin",get:function(){return this._gradientXMin}},{key:"gradientXMax",get:function(){return this._gradientXMax}},{key:"gradientYMin",get:function(){return this._gradientYMin}},{key:"gradientYMax",get:function(){return this._gradientYMax}},{key:"gradientZMin",get:function(){return this._gradientZMin}},{key:"gradientZMax",get:function(){return this._gradientZMax}}],[{key:"createByGradient",value:function(e){var t=new Gi;return t._type=0,t._separateAxes=!1,t._gradient=e,t}},{key:"createByGradientSeparate",value:function(e,t,n){var i=new Gi;return i._type=0,i._separateAxes=!0,i._gradientX=e,i._gradientY=t,i._gradientZ=n,i}},{key:"createByRandomTwoConstant",value:function(e,t){var n=new Gi;return n._type=1,n._separateAxes=!1,n._constantMin=e,n._constantMax=t,n}},{key:"createByRandomTwoConstantSeparate",value:function(e,t){var n=new Gi;return n._type=1,n._separateAxes=!0,n._constantMinSeparate=e,n._constantMaxSeparate=t,n}},{key:"createByRandomTwoGradient",value:function(e,t){var n=new Gi;return n._type=2,n._separateAxes=!1,n._gradientMin=e,n._gradientMax=t,n}},{key:"createByRandomTwoGradientSeparate",value:function(e,t,n,i,r,a){var o=new Gi;return o._type=2,o._separateAxes=!0,o._gradientXMin=e,o._gradientXMax=t,o._gradientYMin=n,o._gradientYMax=i,o._gradientZMin=r,o._gradientZMax=a,o}}]),Gi}(),Eo=function(){function Hi(){_classCallCheck(this,Hi),this._type=0,this._constant=null,this._gradientX=null,this._gradientY=null,this._gradientZ=null,this._constantMin=null,this._constantMax=null,this._gradientXMin=null,this._gradientXMax=null,this._gradientYMin=null,this._gradientYMax=null,this._gradientZMin=null,this._gradientZMax=null}return _createClass(Hi,[{key:"cloneTo",value:function(e){var t=e;t._type=this._type,this._constant.cloneTo(t._constant),this._gradientX.cloneTo(t._gradientX),this._gradientY.cloneTo(t._gradientY),this._gradientZ.cloneTo(t._gradientZ),this._constantMin.cloneTo(t._constantMin),this._constantMax.cloneTo(t._constantMax),this._gradientXMin.cloneTo(t._gradientXMin),this._gradientXMax.cloneTo(t._gradientXMax),this._gradientYMin.cloneTo(t._gradientYMin),this._gradientYMax.cloneTo(t._gradientYMax),this._gradientZMin.cloneTo(t._gradientZMin),this._gradientZMax.cloneTo(t._gradientZMax)}},{key:"clone",value:function(){var e=new Hi;return this.cloneTo(e),e}},{key:"type",get:function(){return this._type}},{key:"constant",get:function(){return this._constant}},{key:"gradientX",get:function(){return this._gradientX}},{key:"gradientY",get:function(){return this._gradientY}},{key:"gradientZ",get:function(){return this._gradientZ}},{key:"constantMin",get:function(){return this._constantMin}},{key:"constantMax",get:function(){return this._constantMax}},{key:"gradientXMin",get:function(){return this._gradientXMin}},{key:"gradientXMax",get:function(){return this._gradientXMax}},{key:"gradientYMin",get:function(){return this._gradientYMin}},{key:"gradientYMax",get:function(){return this._gradientYMax}},{key:"gradientZMin",get:function(){return this._gradientZMin}},{key:"gradientZMax",get:function(){return this._gradientZMax}}],[{key:"createByConstant",value:function(e){var t=new Hi;return t._type=0,t._constant=e,t}},{key:"createByGradient",value:function(e,t,n){var i=new Hi;return i._type=1,i._gradientX=e,i._gradientY=t,i._gradientZ=n,i}},{key:"createByRandomTwoConstant",value:function(e,t){var n=new Hi;return n._type=2,n._constantMin=e,n._constantMax=t,n}},{key:"createByRandomTwoGradient",value:function(e,t,n,i,r,a){var o=new Hi;return o._type=3,o._gradientXMin=e,o._gradientXMax=t,o._gradientYMin=n,o._gradientYMax=i,o._gradientZMin=r,o._gradientZMax=a,o}}]),Hi}(),To=function(){function zi(e){_classCallCheck(this,zi),this._angularVelocity=e}return _createClass(zi,[{key:"cloneTo",value:function(e){var t=e;this._angularVelocity.cloneTo(t._angularVelocity),t.enable=this.enable}},{key:"clone",value:function(){var e;switch(this._angularVelocity.type){case 0:e=this._angularVelocity.separateAxes?fo.createByConstantSeparate(this._angularVelocity.constantSeparate.clone()):fo.createByConstant(this._angularVelocity.constant);break;case 1:e=this._angularVelocity.separateAxes?fo.createByGradientSeparate(this._angularVelocity.gradientX.clone(),this._angularVelocity.gradientY.clone(),this._angularVelocity.gradientZ.clone()):fo.createByGradient(this._angularVelocity.gradient.clone());break;case 2:e=this._angularVelocity.separateAxes?fo.createByRandomTwoConstantSeparate(this._angularVelocity.constantMinSeparate.clone(),this._angularVelocity.constantMaxSeparate.clone()):fo.createByRandomTwoConstant(this._angularVelocity.constantMin,this._angularVelocity.constantMax);break;case 3:e=this._angularVelocity.separateAxes?fo.createByRandomTwoGradientSeparate(this._angularVelocity.gradientXMin.clone(),this._angularVelocity.gradientYMin.clone(),this._angularVelocity.gradientZMin.clone(),this._angularVelocity.gradientWMin.clone(),this._angularVelocity.gradientXMax.clone(),this._angularVelocity.gradientYMax.clone(),this._angularVelocity.gradientZMax.clone(),this._angularVelocity.gradientWMax.clone()):fo.createByRandomTwoGradient(this._angularVelocity.gradientMin.clone(),this._angularVelocity.gradientMax.clone())}var t=new zi(e);return t.enable=this.enable,t}},{key:"angularVelocity",get:function(){return this._angularVelocity}}]),zi}();(Za=e.ParticleSystemShapeType||(e.ParticleSystemShapeType={}))[Za.Box=0]="Box",Za[Za.Circle=1]="Circle",Za[Za.Cone=2]="Cone",Za[Za.Hemisphere=3]="Hemisphere",Za[Za.Sphere=4]="Sphere";var go=function(){function ki(){_classCallCheck(this,ki),this.enable=!0,this.randomDirection=0}return _createClass(ki,[{key:"_getShapeBoundBox",value:function(e){throw new Error("BaseShape: must override it.")}},{key:"_getSpeedBoundBox",value:function(e){throw new Error("BaseShape: must override it.")}},{key:"generatePositionAndDirection",value:function(e,t){arguments.length>2&&void 0!==arguments[2]&&arguments[2],arguments.length>3&&void 0!==arguments[3]&&arguments[3];throw new Error("BaseShape: must override it.")}},{key:"_calculateProceduralBounds",value:function(e,t,n){this._getShapeBoundBox(e);var i=e.min,r=e.max;D.multiply(i,t,i),D.multiply(r,t,r);var a=new pa(new D,new D);this.randomDirection?(a.min=new D(-1,-1,-1),a.max=new D(1,1,1)):this._getSpeedBoundBox(a);var o=new pa(new D,new D),s=o.min,l=o.max;D.scale(a.min,n.y,s),D.scale(a.max,n.y,l),D.add(e.min,s,s),D.add(e.max,l,l),D.min(e.min,s,e.min),D.max(e.max,s,e.max);var u=new pa(new D,new D),_=u.min,c=u.max;D.scale(a.min,n.x,_),D.scale(a.max,n.x,c),D.min(u.min,c,s),D.max(u.min,c,l),D.min(e.min,s,e.min),D.max(e.max,s,e.max)}},{key:"cloneTo",value:function(e){e.enable=this.enable}},{key:"clone",value:function(){var e=new ki;return this.cloneTo(e),e}}]),ki}(),yo=function(){function Wi(){_classCallCheck(this,Wi)}return _createClass(Wi,null,[{key:"_randomPointUnitArcCircle",value:function(e,t){var n,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;n=i?i.getFloat()*e:Math.random()*e,t.x=Math.cos(n),t.y=Math.sin(n)}},{key:"_randomPointInsideUnitArcCircle",value:function(e,t){var n,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;Wi._randomPointUnitArcCircle(e,t,i),n=i?Math.pow(i.getFloat(),.5):Math.pow(Math.random(),.5),t.x=t.x*n,t.y=t.y*n}},{key:"_randomPointUnitCircle",value:function(e){var t,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;t=n?n.getFloat()*Math.PI*2:Math.random()*Math.PI*2,e.x=Math.cos(t),e.y=Math.sin(t)}},{key:"_randomPointInsideUnitCircle",value:function(e){var t,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;Wi._randomPointUnitCircle(e),t=n?Math.pow(n.getFloat(),.5):Math.pow(Math.random(),.5),e.x=e.x*t,e.y=e.y*t}},{key:"_randomPointUnitSphere",value:function(e){var t,n,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;i?(t=e.z=2*i.getFloat()-1,n=i.getFloat()*Math.PI*2):(t=e.z=2*Math.random()-1,n=Math.random()*Math.PI*2);var r=Math.sqrt(1-t*t);e.x=r*Math.cos(n),e.y=r*Math.sin(n)}},{key:"_randomPointInsideUnitSphere",value:function(e){var t,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;Wi._randomPointUnitSphere(e),t=n?Math.pow(n.getFloat(),1/3):Math.pow(Math.random(),1/3),e.x=e.x*t,e.y=e.y*t,e.z=e.z*t}},{key:"_randomPointInsideHalfUnitBox",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;t?(e.x=t.getFloat()-.5,e.y=t.getFloat()-.5,e.z=t.getFloat()-.5):(e.x=Math.random()-.5,e.y=Math.random()-.5,e.z=Math.random()-.5)}}]),Wi}(),So=function(t){function Xi(){var t;return _classCallCheck(this,Xi),(t=_possibleConstructorReturn(this,_getPrototypeOf(Xi).call(this))).shapeType=e.ParticleSystemShapeType.Box,t.x=1,t.y=1,t.z=1,t}return _inherits(Xi,go),_createClass(Xi,[{key:"_getShapeBoundBox",value:function(e){var t=e.min;t.x=.5*-this.x,t.y=.5*-this.y,t.z=.5*-this.z;var n=e.max;n.x=.5*this.x,n.y=.5*this.y,n.z=.5*this.z}},{key:"_getSpeedBoundBox",value:function(e){var t=e.min;t.x=0,t.y=0,t.z=0;var n=e.max;n.x=0,n.y=1,n.z=0}},{key:"generatePositionAndDirection",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;n?(n.seed=i[16],yo._randomPointInsideHalfUnitBox(e,n),i[16]=n.seed):yo._randomPointInsideHalfUnitBox(e),e.x=this.x*e.x,e.y=this.y*e.y,e.z=this.z*e.z,this.randomDirection?n?(n.seed=i[17],yo._randomPointUnitSphere(t,n),i[17]=n.seed):yo._randomPointUnitSphere(t):(t.x=0,t.y=0,t.z=1)}},{key:"cloneTo",value:function(e){_get(_getPrototypeOf(Xi.prototype),"cloneTo",this).call(this,e);var t=e;t.x=this.x,t.y=this.y,t.z=this.z,t.randomDirection=this.randomDirection}},{key:"clone",value:function(){var e=new Xi;return this.cloneTo(e),e}}]),Xi}(),Ro=function(t){function Yi(){var t;return _classCallCheck(this,Yi),(t=_possibleConstructorReturn(this,_getPrototypeOf(Yi).call(this))).shapeType=e.ParticleSystemShapeType.Circle,t.radius=1,t.arc=2*Math.PI,t.emitFromEdge=!1,t}return _inherits(Yi,go),_createClass(Yi,[{key:"_getShapeBoundBox",value:function(e){var t=e.min;t.x=t.z=-this.radius,t.y=0;var n=e.max;n.x=n.z=this.radius,n.y=0}},{key:"_getSpeedBoundBox",value:function(e){var t=e.min;t.x=t.y=-1,t.z=0;var n=e.max;n.x=n.y=1,n.z=0}},{key:"generatePositionAndDirection",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,r=Yi._tempPositionPoint;n?(n.seed=i[16],this.emitFromEdge?yo._randomPointUnitArcCircle(this.arc,Yi._tempPositionPoint,n):yo._randomPointInsideUnitArcCircle(this.arc,Yi._tempPositionPoint,n),i[16]=n.seed):this.emitFromEdge?yo._randomPointUnitArcCircle(this.arc,Yi._tempPositionPoint):yo._randomPointInsideUnitArcCircle(this.arc,Yi._tempPositionPoint),e.x=-r.x,e.y=r.y,e.z=0,D.scale(e,this.radius,e),this.randomDirection?n?(n.seed=i[17],yo._randomPointUnitSphere(t,n),i[17]=n.seed):yo._randomPointUnitSphere(t):e.cloneTo(t)}},{key:"cloneTo",value:function(e){_get(_getPrototypeOf(Yi.prototype),"cloneTo",this).call(this,e);var t=e;t.radius=this.radius,t.arc=this.arc,t.emitFromEdge=this.emitFromEdge,t.randomDirection=this.randomDirection}},{key:"clone",value:function(){var e=new Yi;return this.cloneTo(e),e}}]),Yi}();Ro._tempPositionPoint=new r;var Co=function(t){function ji(){var t;return _classCallCheck(this,ji),(t=_possibleConstructorReturn(this,_getPrototypeOf(ji).call(this))).shapeType=e.ParticleSystemShapeType.Cone,t.angle=25/180*Math.PI,t.radius=1,t.length=5,t.emitType=0,t}return _inherits(ji,go),_createClass(ji,[{key:"_getShapeBoundBox",value:function(e){var t=this.radius+this.length*Math.sin(this.angle),n=this.length*Math.cos(this.angle),i=e.min;i.x=i.y=-t,i.z=0;var r=e.max;r.x=r.y=t,r.z=n}},{key:"_getSpeedBoundBox",value:function(e){var t=Math.sin(this.angle),n=e.min;n.x=n.y=-t,n.z=0;var i=e.max;i.x=i.y=t,i.z=1}},{key:"generatePositionAndDirection",value:function(e,t){var n,i,r,a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,s=ji._tempPositionPoint,l=Math.cos(this.angle),u=Math.sin(this.angle);switch(this.emitType){case 0:a?(a.seed=o[16],yo._randomPointInsideUnitCircle(ji._tempPositionPoint,a),o[16]=a.seed):yo._randomPointInsideUnitCircle(ji._tempPositionPoint),n=s.x,i=s.y,e.x=n*this.radius,e.y=i*this.radius,e.z=0,this.randomDirection?(a?(a.seed=o[17],yo._randomPointInsideUnitCircle(ji._tempDirectionPoint,a),o[17]=a.seed):yo._randomPointInsideUnitCircle(ji._tempDirectionPoint),r=ji._tempDirectionPoint,t.x=r.x*u,t.y=r.y*u):(t.x=n*u,t.y=i*u),t.z=l;break;case 1:a?(a.seed=o[16],yo._randomPointUnitCircle(ji._tempPositionPoint,a),o[16]=a.seed):yo._randomPointUnitCircle(ji._tempPositionPoint),n=s.x,i=s.y,e.x=n*this.radius,e.y=i*this.radius,e.z=0,this.randomDirection?(a?(a.seed=o[17],yo._randomPointInsideUnitCircle(ji._tempDirectionPoint,a),o[17]=a.seed):yo._randomPointInsideUnitCircle(ji._tempDirectionPoint),r=ji._tempDirectionPoint,t.x=r.x*u,t.y=r.y*u):(t.x=n*u,t.y=i*u),t.z=l;break;case 2:a?(a.seed=o[16],yo._randomPointInsideUnitCircle(ji._tempPositionPoint,a)):yo._randomPointInsideUnitCircle(ji._tempPositionPoint),n=s.x,i=s.y,e.x=n*this.radius,e.y=i*this.radius,e.z=0,t.x=n*u,t.y=i*u,t.z=l,D.normalize(t,t),a?(D.scale(t,this.length*a.getFloat(),t),o[16]=a.seed):D.scale(t,this.length*Math.random(),t),D.add(e,t,e),this.randomDirection&&(a?(a.seed=o[17],yo._randomPointUnitSphere(t,a),o[17]=a.seed):yo._randomPointUnitSphere(t));break;case 3:a?(a.seed=o[16],yo._randomPointUnitCircle(ji._tempPositionPoint,a)):yo._randomPointUnitCircle(ji._tempPositionPoint),n=s.x,i=s.y,e.x=n*this.radius,e.y=i*this.radius,e.z=0,t.x=n*u,t.y=i*u,t.z=l,D.normalize(t,t),a?(D.scale(t,this.length*a.getFloat(),t),o[16]=a.seed):D.scale(t,this.length*Math.random(),t),D.add(e,t,e),this.randomDirection&&(a?(a.seed=o[17],yo._randomPointUnitSphere(t,a),o[17]=a.seed):yo._randomPointUnitSphere(t));break;default:throw new Error("ConeShape:emitType is invalid.")}}},{key:"cloneTo",value:function(e){_get(_getPrototypeOf(ji.prototype),"cloneTo",this).call(this,e);var t=e;t.angle=this.angle,t.radius=this.radius,t.length=this.length,t.emitType=this.emitType,t.randomDirection=this.randomDirection}},{key:"clone",value:function(){var e=new ji;return this.cloneTo(e),e}}]),ji}();Co._tempPositionPoint=new r,Co._tempDirectionPoint=new r;var Ao=function(t){function Zi(){var t;return _classCallCheck(this,Zi),(t=_possibleConstructorReturn(this,_getPrototypeOf(Zi).call(this))).shapeType=e.ParticleSystemShapeType.Hemisphere,t.radius=1,t.emitFromShell=!1,t}return _inherits(Zi,go),_createClass(Zi,[{key:"_getShapeBoundBox",value:function(e){var t=e.min;t.x=t.y=t.z=-this.radius;var n=e.max;n.x=n.y=this.radius,n.z=0}},{key:"_getSpeedBoundBox",value:function(e){var t=e.min;t.x=t.y=-1,t.z=0;var n=e.max;n.x=n.y=n.z=1}},{key:"generatePositionAndDirection",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;n?(n.seed=i[16],this.emitFromShell?yo._randomPointUnitSphere(e,n):yo._randomPointInsideUnitSphere(e,n),i[16]=n.seed):this.emitFromShell?yo._randomPointUnitSphere(e):yo._randomPointInsideUnitSphere(e),D.scale(e,this.radius,e);var r=e.z;r<0&&(e.z=-1*r),this.randomDirection?n?(n.seed=i[17],yo._randomPointUnitSphere(t,n),i[17]=n.seed):yo._randomPointUnitSphere(t):e.cloneTo(t)}},{key:"cloneTo",value:function(e){_get(_getPrototypeOf(Zi.prototype),"cloneTo",this).call(this,e);var t=e;t.radius=this.radius,t.emitFromShell=this.emitFromShell,t.randomDirection=this.randomDirection}},{key:"clone",value:function(){var e=new Zi;return this.cloneTo(e),e}}]),Zi}(),Io=function(t){function qi(){var t;return _classCallCheck(this,qi),(t=_possibleConstructorReturn(this,_getPrototypeOf(qi).call(this))).shapeType=e.ParticleSystemShapeType.Sphere,t.radius=1,t.emitFromShell=!1,t}return _inherits(qi,go),_createClass(qi,[{key:"_getShapeBoundBox",value:function(e){var t=e.min;t.x=t.y=t.z=-this.radius;var n=e.max;n.x=n.y=n.z=this.radius}},{key:"_getSpeedBoundBox",value:function(e){var t=e.min;t.x=t.y=t.z=-1;var n=e.max;n.x=n.y=n.z=1}},{key:"generatePositionAndDirection",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;n?(n.seed=i[16],this.emitFromShell?yo._randomPointUnitSphere(e,n):yo._randomPointInsideUnitSphere(e,n),i[16]=n.seed):this.emitFromShell?yo._randomPointUnitSphere(e):yo._randomPointInsideUnitSphere(e),D.scale(e,this.radius,e),this.randomDirection?n?(n.seed=i[17],yo._randomPointUnitSphere(t,n),i[17]=n.seed):yo._randomPointUnitSphere(t):e.cloneTo(t)}},{key:"cloneTo",value:function(e){_get(_getPrototypeOf(qi.prototype),"cloneTo",this).call(this,e);var t=e;t.radius=this.radius,t.emitFromShell=this.emitFromShell,t.randomDirection=this.randomDirection}},{key:"clone",value:function(){var e=new qi;return this.cloneTo(e),e}}]),qi}(),xo=function(){function Qi(e){_classCallCheck(this,Qi),this._size=e}return _createClass(Qi,[{key:"cloneTo",value:function(e){var t=e;this._size.cloneTo(t._size),t.enable=this.enable}},{key:"clone",value:function(){var e;switch(this._size.type){case 0:e=this._size.separateAxes?vo.createByGradientSeparate(this._size.gradientX.clone(),this._size.gradientY.clone(),this._size.gradientZ.clone()):vo.createByGradient(this._size.gradient.clone());break;case 1:e=this._size.separateAxes?vo.createByRandomTwoConstantSeparate(this._size.constantMinSeparate.clone(),this._size.constantMaxSeparate.clone()):vo.createByRandomTwoConstant(this._size.constantMin,this._size.constantMax);break;case 2:e=this._size.separateAxes?vo.createByRandomTwoGradientSeparate(this._size.gradientXMin.clone(),this._size.gradientYMin.clone(),this._size.gradientZMin.clone(),this._size.gradientXMax.clone(),this._size.gradientYMax.clone(),this._size.gradientZMax.clone()):vo.createByRandomTwoGradient(this._size.gradientMin.clone(),this._size.gradientMax.clone())}var t=new Qi(e);return t.enable=this.enable,t}},{key:"size",get:function(){return this._size}}]),Qi}(),Do=function(){function Ki(){_classCallCheck(this,Ki),this._type=0,this._constant=0,this._constantMin=0,this._constantMax=0}return _createClass(Ki,[{key:"cloneTo",value:function(e){var t=e;t._type=this._type,t._constant=this._constant,t._constantMin=this._constantMin,t._constantMax=this._constantMax}},{key:"clone",value:function(){var e=new Ki;return this.cloneTo(e),e}},{key:"type",get:function(){return this._type}},{key:"constant",get:function(){return this._constant}},{key:"constantMin",get:function(){return this._constantMin}},{key:"constantMax",get:function(){return this._constantMax}}],[{key:"createByConstant",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=new Ki;return t._type=0,t._constant=e,t}},{key:"createByRandomTwoConstant",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=new Ki;return n._type=1,n._constantMin=e,n._constantMax=t,n}}]),Ki}(),Mo=function(){function Ji(e,t){_classCallCheck(this,Ji),this.type=0,this.randomRow=!1,this.rowIndex=0,this.cycles=0,this.enableUVChannels=0,this.enable=!1,this.tiles=new r(1,1),this.type=0,this.randomRow=!0,this.rowIndex=0,this.cycles=1,this.enableUVChannels=1,this._frame=e,this._startFrame=t}return _createClass(Ji,[{key:"cloneTo",value:function(e){var t=e;this.tiles.cloneTo(t.tiles),t.type=this.type,t.randomRow=this.randomRow,t.rowIndex=this.rowIndex,t.cycles=this.cycles,t.enableUVChannels=this.enableUVChannels,t.enable=this.enable,this._frame.cloneTo(t._frame),this._startFrame.cloneTo(t._startFrame)}},{key:"clone",value:function(){var e,t;switch(this._frame.type){case 0:e=ho.createByConstant(this._frame.constant);break;case 1:e=ho.createByOverTime(this._frame.frameOverTimeData.clone());break;case 2:e=ho.createByRandomTwoConstant(this._frame.constantMin,this._frame.constantMax);break;case 3:e=ho.createByRandomTwoOverTime(this._frame.frameOverTimeDataMin.clone(),this._frame.frameOverTimeDataMax.clone())}switch(this._startFrame.type){case 0:t=Do.createByConstant(this._startFrame.constant);break;case 1:t=Do.createByRandomTwoConstant(this._startFrame.constantMin,this._startFrame.constantMax)}var n=new Ji(e,t);return this.cloneTo(n),n}},{key:"frame",get:function(){return this._frame}},{key:"startFrame",get:function(){return this._startFrame}}]),Ji}(),Lo=function(){function $i(e){_classCallCheck(this,$i),this.enable=!1,this.space=0,this._velocity=e}return _createClass($i,[{key:"cloneTo",value:function(e){var t=e;this._velocity.cloneTo(t._velocity),t.enable=this.enable,t.space=this.space}},{key:"clone",value:function(){var e;switch(this._velocity.type){case 0:e=Eo.createByConstant(this._velocity.constant.clone());break;case 1:e=Eo.createByGradient(this._velocity.gradientX.clone(),this._velocity.gradientY.clone(),this._velocity.gradientZ.clone());break;case 2:e=Eo.createByRandomTwoConstant(this._velocity.constantMin.clone(),this._velocity.constantMax.clone());break;case 3:e=Eo.createByRandomTwoGradient(this._velocity.gradientXMin.clone(),this._velocity.gradientXMax.clone(),this._velocity.gradientYMin.clone(),this._velocity.gradientYMax.clone(),this._velocity.gradientZMin.clone(),this._velocity.gradientZMax.clone())}var t=new $i(e);return t.enable=this.enable,t.space=this.space,t}},{key:"velocity",get:function(){return this._velocity}}]),$i}(),Oo=function er(){_classCallCheck(this,er)};Oo.WORLDPOSITION=xn.propertyNameToID("u_WorldPosition"),Oo.WORLDROTATION=xn.propertyNameToID("u_WorldRotation"),Oo.POSITIONSCALE=xn.propertyNameToID("u_PositionScale"),Oo.SIZESCALE=xn.propertyNameToID("u_SizeScale"),Oo.SCALINGMODE=xn.propertyNameToID("u_ScalingMode"),Oo.GRAVITY=xn.propertyNameToID("u_Gravity"),Oo.THREEDSTARTROTATION=xn.propertyNameToID("u_ThreeDStartRotation"),Oo.STRETCHEDBILLBOARDLENGTHSCALE=xn.propertyNameToID("u_StretchedBillboardLengthScale"),Oo.STRETCHEDBILLBOARDSPEEDSCALE=xn.propertyNameToID("u_StretchedBillboardSpeedScale"),Oo.SIMULATIONSPACE=xn.propertyNameToID("u_SimulationSpace"),Oo.CURRENTTIME=xn.propertyNameToID("u_CurrentTime"),Oo.VOLVELOCITYCONST=xn.propertyNameToID("u_VOLVelocityConst"),Oo.VOLVELOCITYGRADIENTX=xn.propertyNameToID("u_VOLVelocityGradientX"),Oo.VOLVELOCITYGRADIENTY=xn.propertyNameToID("u_VOLVelocityGradientY"),Oo.VOLVELOCITYGRADIENTZ=xn.propertyNameToID("u_VOLVelocityGradientZ"),Oo.VOLVELOCITYCONSTMAX=xn.propertyNameToID("u_VOLVelocityConstMax"),Oo.VOLVELOCITYGRADIENTXMAX=xn.propertyNameToID("u_VOLVelocityGradientMaxX"),Oo.VOLVELOCITYGRADIENTYMAX=xn.propertyNameToID("u_VOLVelocityGradientMaxY"),Oo.VOLVELOCITYGRADIENTZMAX=xn.propertyNameToID("u_VOLVelocityGradientMaxZ"),Oo.VOLSPACETYPE=xn.propertyNameToID("u_VOLSpaceType"),Oo.COLOROVERLIFEGRADIENTALPHAS=xn.propertyNameToID("u_ColorOverLifeGradientAlphas"),Oo.COLOROVERLIFEGRADIENTCOLORS=xn.propertyNameToID("u_ColorOverLifeGradientColors"),Oo.MAXCOLOROVERLIFEGRADIENTALPHAS=xn.propertyNameToID("u_MaxColorOverLifeGradientAlphas"),Oo.MAXCOLOROVERLIFEGRADIENTCOLORS=xn.propertyNameToID("u_MaxColorOverLifeGradientColors"),Oo.SOLSIZEGRADIENT=xn.propertyNameToID("u_SOLSizeGradient"),Oo.SOLSIZEGRADIENTX=xn.propertyNameToID("u_SOLSizeGradientX"),Oo.SOLSIZEGRADIENTY=xn.propertyNameToID("u_SOLSizeGradientY"),Oo.SOLSizeGradientZ=xn.propertyNameToID("u_SOLSizeGradientZ"),Oo.SOLSizeGradientMax=xn.propertyNameToID("u_SOLSizeGradientMax"),Oo.SOLSIZEGRADIENTXMAX=xn.propertyNameToID("u_SOLSizeGradientMaxX"),Oo.SOLSIZEGRADIENTYMAX=xn.propertyNameToID("u_SOLSizeGradientMaxY"),Oo.SOLSizeGradientZMAX=xn.propertyNameToID("u_SOLSizeGradientMaxZ"),Oo.ROLANGULARVELOCITYCONST=xn.propertyNameToID("u_ROLAngularVelocityConst"),Oo.ROLANGULARVELOCITYCONSTSEPRARATE=xn.propertyNameToID("u_ROLAngularVelocityConstSeprarate"),Oo.ROLANGULARVELOCITYGRADIENT=xn.propertyNameToID("u_ROLAngularVelocityGradient"),Oo.ROLANGULARVELOCITYGRADIENTX=xn.propertyNameToID("u_ROLAngularVelocityGradientX"),Oo.ROLANGULARVELOCITYGRADIENTY=xn.propertyNameToID("u_ROLAngularVelocityGradientY"),Oo.ROLANGULARVELOCITYGRADIENTZ=xn.propertyNameToID("u_ROLAngularVelocityGradientZ"),Oo.ROLANGULARVELOCITYCONSTMAX=xn.propertyNameToID("u_ROLAngularVelocityConstMax"),Oo.ROLANGULARVELOCITYCONSTMAXSEPRARATE=xn.propertyNameToID("u_ROLAngularVelocityConstMaxSeprarate"),Oo.ROLANGULARVELOCITYGRADIENTMAX=xn.propertyNameToID("u_ROLAngularVelocityGradientMax"),Oo.ROLANGULARVELOCITYGRADIENTXMAX=xn.propertyNameToID("u_ROLAngularVelocityGradientMaxX"),Oo.ROLANGULARVELOCITYGRADIENTYMAX=xn.propertyNameToID("u_ROLAngularVelocityGradientMaxY"),Oo.ROLANGULARVELOCITYGRADIENTZMAX=xn.propertyNameToID("u_ROLAngularVelocityGradientMaxZ"),Oo.ROLANGULARVELOCITYGRADIENTWMAX=xn.propertyNameToID("u_ROLAngularVelocityGradientMaxW"),Oo.TEXTURESHEETANIMATIONCYCLES=xn.propertyNameToID("u_TSACycles"),Oo.TEXTURESHEETANIMATIONSUBUVLENGTH=xn.propertyNameToID("u_TSASubUVLength"),Oo.TEXTURESHEETANIMATIONGRADIENTUVS=xn.propertyNameToID("u_TSAGradientUVs"),Oo.TEXTURESHEETANIMATIONGRADIENTMAXUVS=xn.propertyNameToID("u_TSAMaxGradientUVs");var No=function(e){function tr(){var e;return _classCallCheck(this,tr),(e=_possibleConstructorReturn(this,_getPrototypeOf(tr).call(this))).setShaderName("PARTICLESHURIKEN"),e._color=new o(1,1,1,1),e._shaderValues.setVector(tr.TILINGOFFSET,new o(1,1,0,0)),e.renderMode=tr.RENDERMODE_ALPHABLENDED,e}return _inherits(tr,Gi),_createClass(tr,[{key:"clone",value:function(){var e=new tr;return this.cloneTo(e),e}},{key:"_TintColor",get:function(){return this.color},set:function(e){this.color=e}},{key:"_TintColorR",get:function(){return this._color.x},set:function(e){this._color.x=e,this.color=this._color}},{key:"_TintColorG",get:function(){return this._color.y},set:function(e){this._color.y=e,this.color=this._color}},{key:"_TintColorB",get:function(){return this._color.z},set:function(e){this._color.z=e,this.color=this._color}},{key:"_TintColorA",get:function(){return this._color.w},set:function(e){this._color.w=e,this.color=this._color}},{key:"_MainTex_ST",get:function(){return this._shaderValues.getVector(tr.TILINGOFFSET)},set:function(e){var t=this._shaderValues.getVector(tr.TILINGOFFSET);t.setValue(e.x,e.y,e.z,e.w),this.tilingOffset=t}},{key:"_MainTex_STX",get:function(){return this._shaderValues.getVector(tr.TILINGOFFSET).x},set:function(e){var t=this._shaderValues.getVector(tr.TILINGOFFSET);t.x=e,this.tilingOffset=t}},{key:"_MainTex_STY",get:function(){return this._shaderValues.getVector(tr.TILINGOFFSET).y},set:function(e){var t=this._shaderValues.getVector(tr.TILINGOFFSET);t.y=e,this.tilingOffset=t}},{key:"_MainTex_STZ",get:function(){return this._shaderValues.getVector(tr.TILINGOFFSET).z},set:function(e){var t=this._shaderValues.getVector(tr.TILINGOFFSET);t.z=e,this.tilingOffset=t}},{key:"_MainTex_STW",get:function(){return this._shaderValues.getVector(tr.TILINGOFFSET).w},set:function(e){var t=this._shaderValues.getVector(tr.TILINGOFFSET);t.w=e,this.tilingOffset=t}},{key:"renderMode",set:function(e){switch(e){case tr.RENDERMODE_ADDTIVE:this.renderQueue=Gi.RENDERQUEUE_TRANSPARENT,this.depthWrite=!1,this.cull=Wi.CULL_NONE,this.blend=Wi.BLEND_ENABLE_ALL,this.blendSrc=Wi.BLENDPARAM_SRC_ALPHA,this.blendDst=Wi.BLENDPARAM_ONE,this.alphaTest=!1,this._shaderValues.addDefine(tr.SHADERDEFINE_ADDTIVEFOG);break;case tr.RENDERMODE_ALPHABLENDED:this.renderQueue=Gi.RENDERQUEUE_TRANSPARENT,this.depthWrite=!1,this.cull=Wi.CULL_NONE,this.blend=Wi.BLEND_ENABLE_ALL,this.blendSrc=Wi.BLENDPARAM_SRC_ALPHA,this.blendDst=Wi.BLENDPARAM_ONE_MINUS_SRC_ALPHA,this.alphaTest=!1,this._shaderValues.removeDefine(tr.SHADERDEFINE_ADDTIVEFOG);break;default:throw new Error("ShurikenParticleMaterial : renderMode value error.")}}},{key:"colorR",get:function(){return this._TintColorR},set:function(e){this._TintColorR=e}},{key:"colorG",get:function(){return this._TintColorG},set:function(e){this._TintColorG=e}},{key:"colorB",get:function(){return this._TintColorB},set:function(e){this._TintColorB=e}},{key:"colorA",get:function(){return this._TintColorA},set:function(e){this._TintColorA=e}},{key:"color",get:function(){return this._shaderValues.getVector(tr.TINTCOLOR)},set:function(e){e?this._shaderValues.addDefine(tr.SHADERDEFINE_TINTCOLOR):this._shaderValues.removeDefine(tr.SHADERDEFINE_TINTCOLOR),this._shaderValues.setVector(tr.TINTCOLOR,e)}},{key:"tilingOffsetX",get:function(){return this._MainTex_STX},set:function(e){this._MainTex_STX=e}},{key:"tilingOffsetY",get:function(){return this._MainTex_STY},set:function(e){this._MainTex_STY=e}},{key:"tilingOffsetZ",get:function(){return this._MainTex_STZ},set:function(e){this._MainTex_STZ=e}},{key:"tilingOffsetW",get:function(){return this._MainTex_STW},set:function(e){this._MainTex_STW=e}},{key:"tilingOffset",get:function(){return this._shaderValues.getVector(tr.TILINGOFFSET)},set:function(e){e?this._shaderValues.setVector(tr.TILINGOFFSET,e):this._shaderValues.getVector(tr.TILINGOFFSET).setValue(1,1,0,0)}},{key:"texture",get:function(){return this._shaderValues.getTexture(tr.DIFFUSETEXTURE)},set:function(e){e?this._shaderValues.addDefine(tr.SHADERDEFINE_DIFFUSEMAP):this._shaderValues.removeDefine(tr.SHADERDEFINE_DIFFUSEMAP),this._shaderValues.setTexture(tr.DIFFUSETEXTURE,e)}}],[{key:"__initDefine__",value:function(){tr.SHADERDEFINE_DIFFUSEMAP=xn.getDefineByName("DIFFUSEMAP"),tr.SHADERDEFINE_TINTCOLOR=xn.getDefineByName("TINTCOLOR"),tr.SHADERDEFINE_ADDTIVEFOG=xn.getDefineByName("ADDTIVEFOG")}}]),tr}();No.RENDERMODE_ALPHABLENDED=0,No.RENDERMODE_ADDTIVE=1,No.DIFFUSETEXTURE=xn.propertyNameToID("u_texture"),No.TINTCOLOR=xn.propertyNameToID("u_Tintcolor"),No.TILINGOFFSET=xn.propertyNameToID("u_TilingOffset");var Po=function(e){function ir(e){var t;return _classCallCheck(this,ir),(t=_possibleConstructorReturn(this,_getPrototypeOf(ir).call(this,e)))._finalGravity=new D,t._mesh=null,t.stretchedBillboardCameraSpeedScale=0,t.stretchedBillboardSpeedScale=0,t.stretchedBillboardLengthScale=2,t.renderMode=0,t._supportOctree=!1,t}return _inherits(ir,Ma),_createClass(ir,[{key:"_calculateBoundingBox",value:function(){var e=this._owner.particleSystem;if(e._useCustomBounds)e.customBounds._tranform(this._owner.transform.worldMatrix,this._bounds);else if(e._simulationSupported()){if(e._generateBounds(),e._bounds._tranform(this._owner.transform.worldMatrix,this._bounds),0!=e.gravityModifier){var t=this._bounds.getMax(),n=this._bounds.getMin(),i=e._gravityOffset;t.y-=i.x,n.y-=i.y,this._bounds.setMax(t),this._bounds.setMin(n)}}else(n=this._bounds.getMin()).setValue(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),this._bounds.setMin(n),(t=this._bounds.getMax()).setValue(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._bounds.setMax(t)}},{key:"_needRender",value:function(e,t){return!e||!!e.intersects(this.bounds._getBoundBox())&&!!this._owner.particleSystem.isAlive}},{key:"_renderUpdate",value:function(e,t){var n=this._owner.particleSystem,i=this._shaderValues,r=this._owner.transform;switch(n.simulationSpace){case 0:break;case 1:i.setVector3(Oo.WORLDPOSITION,r.position),i.setQuaternion(Oo.WORLDROTATION,r.rotation);break;default:throw new Error("ShurikenParticleMaterial: SimulationSpace value is invalid.")}switch(n.scaleMode){case 0:var a=r.getWorldLossyScale();i.setVector3(Oo.POSITIONSCALE,a),i.setVector3(Oo.SIZESCALE,a);break;case 1:var o=r.localScale;i.setVector3(Oo.POSITIONSCALE,o),i.setVector3(Oo.SIZESCALE,o);break;case 2:i.setVector3(Oo.POSITIONSCALE,r.getWorldLossyScale()),i.setVector3(Oo.SIZESCALE,D._ONE)}D.scale(ce.gravity,n.gravityModifier,this._finalGravity),i.setVector3(Oo.GRAVITY,this._finalGravity),i.setInt(Oo.SIMULATIONSPACE,n.simulationSpace),i.setBool(Oo.THREEDSTARTROTATION,n.threeDStartRotation),i.setInt(Oo.SCALINGMODE,n.scaleMode),i.setNumber(Oo.STRETCHEDBILLBOARDLENGTHSCALE,this.stretchedBillboardLengthScale),i.setNumber(Oo.STRETCHEDBILLBOARDSPEEDSCALE,this.stretchedBillboardSpeedScale),i.setNumber(Oo.CURRENTTIME,n._currentTime)}},{key:"_destroy",value:function(){_get(_getPrototypeOf(ir.prototype),"_destroy",this).call(this),this._mesh&&(this._mesh._removeReference(),this._mesh=null)}},{key:"renderMode",get:function(){return this._renderMode},set:function(e){if(this._renderMode!==e){var t=this._shaderValues;switch(this._renderMode){case 0:t.removeDefine(Oo.SHADERDEFINE_RENDERMODE_BILLBOARD);break;case 1:t.removeDefine(Oo.SHADERDEFINE_RENDERMODE_STRETCHEDBILLBOARD);break;case 2:t.removeDefine(Oo.SHADERDEFINE_RENDERMODE_HORIZONTALBILLBOARD);break;case 3:t.removeDefine(Oo.SHADERDEFINE_RENDERMODE_VERTICALBILLBOARD);break;case 4:t.removeDefine(Oo.SHADERDEFINE_RENDERMODE_MESH)}switch(this._renderMode=e,e){case 0:t.addDefine(Oo.SHADERDEFINE_RENDERMODE_BILLBOARD);break;case 1:t.addDefine(Oo.SHADERDEFINE_RENDERMODE_STRETCHEDBILLBOARD);break;case 2:t.addDefine(Oo.SHADERDEFINE_RENDERMODE_HORIZONTALBILLBOARD);break;case 3:t.addDefine(Oo.SHADERDEFINE_RENDERMODE_VERTICALBILLBOARD);break;case 4:t.addDefine(Oo.SHADERDEFINE_RENDERMODE_MESH);break;default:throw new Error("ShurikenParticleRender: unknown renderMode Value.")}var n=this._owner.particleSystem;n&&n._initBufferDatas()}}},{key:"mesh",get:function(){return this._mesh},set:function(e){this._mesh!==e&&(this._mesh&&this._mesh._removeReference(),this._mesh=e,e&&e._addReference(),this._owner.particleSystem._initBufferDatas())}},{key:"bounds",get:function(){return this._boundsChange&&(this._calculateBoundingBox(),this._boundsChange=!1),this._bounds}}]),ir}(),bo=function rr(){_classCallCheck(this,rr)};bo.PARTICLE_CORNERTEXTURECOORDINATE0=5,bo.PARTICLE_POSITION0=1,bo.PARTICLE_COLOR0=2,bo.PARTICLE_TEXTURECOORDINATE0=3,bo.PARTICLE_SHAPEPOSITIONSTARTLIFETIME=4,bo.PARTICLE_DIRECTIONTIME=0,bo.PARTICLE_STARTCOLOR0=6,bo.PARTICLE_ENDCOLOR0=7,bo.PARTICLE_STARTSIZE=8,bo.PARTICLE_STARTROTATION=9,bo.PARTICLE_STARTSPEED=10,bo.PARTICLE_RANDOM0=11,bo.PARTICLE_RANDOM1=12,bo.PARTICLE_SIMULATIONWORLDPOSTION=13,bo.PARTICLE_SIMULATIONWORLDROTATION=14;var wo=function(e){function nr(e,t,n,i,r,a,o,s,l,u,_,c,h,d){var f;return _classCallCheck(this,nr),(f=_possibleConstructorReturn(this,_getPrototypeOf(nr).call(this)))._cornerTextureCoordinate=e,f._positionStartLifeTime=t,f._velocity=n,f._startColor=i,f._startSize=r,f._startRotation0=a,f._startRotation1=o,f._startRotation2=s,f._startLifeTime=l,f._time=u,f._startSpeed=_,f._randoms0=c,f._randoms1=h,f._simulationWorldPostion=d,f}return _inherits(nr,bo),_createClass(nr,[{key:"cornerTextureCoordinate",get:function(){return this._cornerTextureCoordinate}},{key:"positionStartLifeTime",get:function(){return this._positionStartLifeTime}},{key:"velocity",get:function(){return this._velocity}},{key:"startColor",get:function(){return this._startColor}},{key:"startSize",get:function(){return this._startSize}},{key:"startRotation0",get:function(){return this._startRotation0}},{key:"startRotation1",get:function(){return this._startRotation1}},{key:"startRotation2",get:function(){return this._startRotation2}},{key:"startLifeTime",get:function(){return this._startLifeTime}},{key:"time",get:function(){return this._time}},{key:"startSpeed",get:function(){return this._startSpeed}},{key:"random0",get:function(){return this._randoms0}},{key:"random1",get:function(){return this._randoms1}},{key:"simulationWorldPostion",get:function(){return this._simulationWorldPostion}}],[{key:"__init__",value:function(){nr._vertexDeclaration=new Tn(152,[new gn(0,vn.Vector4,bo.PARTICLE_CORNERTEXTURECOORDINATE0),new gn(16,vn.Vector4,bo.PARTICLE_SHAPEPOSITIONSTARTLIFETIME),new gn(32,vn.Vector4,bo.PARTICLE_DIRECTIONTIME),new gn(48,vn.Vector4,bo.PARTICLE_STARTCOLOR0),new gn(64,vn.Vector3,bo.PARTICLE_STARTSIZE),new gn(76,vn.Vector3,bo.PARTICLE_STARTROTATION),new gn(88,vn.Single,bo.PARTICLE_STARTSPEED),new gn(92,vn.Vector4,bo.PARTICLE_RANDOM0),new gn(108,vn.Vector4,bo.PARTICLE_RANDOM1),new gn(124,vn.Vector3,bo.PARTICLE_SIMULATIONWORLDPOSTION),new gn(136,vn.Vector4,bo.PARTICLE_SIMULATIONWORLDROTATION)])}},{key:"vertexDeclaration",get:function(){return nr._vertexDeclaration}}]),nr}(),ko=function(e){function ar(e,t,n,i,r,a,o,s,l,u,_,c,h,d){var f;return _classCallCheck(this,ar),(f=_possibleConstructorReturn(this,_getPrototypeOf(ar).call(this)))._cornerTextureCoordinate=e,f._positionStartLifeTime=t,f._velocity=n,f._startColor=i,f._startSize=r,f._startRotation0=a,f._startRotation1=o,f._startRotation2=s,f._startLifeTime=l,f._time=u,f._startSpeed=_,f._randoms0=c,f._randoms1=h,f._simulationWorldPostion=d,f}return _inherits(ar,bo),_createClass(ar,[{key:"cornerTextureCoordinate",get:function(){return this._cornerTextureCoordinate}},{key:"position",get:function(){return this._positionStartLifeTime}},{key:"velocity",get:function(){return this._velocity}},{key:"startColor",get:function(){return this._startColor}},{key:"startSize",get:function(){return this._startSize}},{key:"startRotation0",get:function(){return this._startRotation0}},{key:"startRotation1",get:function(){return this._startRotation1}},{key:"startRotation2",get:function(){return this._startRotation2}},{key:"startLifeTime",get:function(){return this._startLifeTime}},{key:"time",get:function(){return this._time}},{key:"startSpeed",get:function(){return this._startSpeed}},{key:"random0",get:function(){return this._randoms0}},{key:"random1",get:function(){return this._randoms1}},{key:"simulationWorldPostion",get:function(){return this._simulationWorldPostion}}],[{key:"__init__",value:function(){ar._vertexDeclaration=new Tn(172,[new gn(0,vn.Vector3,bo.PARTICLE_POSITION0),new gn(12,vn.Vector4,bo.PARTICLE_COLOR0),new gn(28,vn.Vector2,bo.PARTICLE_TEXTURECOORDINATE0),new gn(36,vn.Vector4,bo.PARTICLE_SHAPEPOSITIONSTARTLIFETIME),new gn(52,vn.Vector4,bo.PARTICLE_DIRECTIONTIME),new gn(68,vn.Vector4,bo.PARTICLE_STARTCOLOR0),new gn(84,vn.Vector3,bo.PARTICLE_STARTSIZE),new gn(96,vn.Vector3,bo.PARTICLE_STARTROTATION),new gn(108,vn.Single,bo.PARTICLE_STARTSPEED),new gn(112,vn.Vector4,bo.PARTICLE_RANDOM0),new gn(128,vn.Vector4,bo.PARTICLE_RANDOM1),new gn(144,vn.Vector3,bo.PARTICLE_SIMULATIONWORLDPOSTION),new gn(156,vn.Vector4,bo.PARTICLE_SIMULATIONWORLDROTATION)])}},{key:"vertexDeclaration",get:function(){return ar._vertexDeclaration}}]),ar}(),Vo=function(){function sr(e){_classCallCheck(this,sr),this._temp=new Uint32Array(1),this.seeds=new Uint32Array(4),this.seeds[0]=e,this.seeds[1]=1812433253*this.seeds[0]+1,this.seeds[2]=1812433253*this.seeds[1]+1,this.seeds[3]=1812433253*this.seeds[2]+1}return _createClass(sr,[{key:"getUint",value:function(){return this._temp[0]=this.seeds[0]^this.seeds[0]<<11,this.seeds[0]=this.seeds[1],this.seeds[1]=this.seeds[2],this.seeds[2]=this.seeds[3],this.seeds[3]=this.seeds[3]^this.seeds[3]>>>19^this._temp[0]^this._temp[0]>>>8,this.seeds[3]}},{key:"getFloat",value:function(){return this.getUint(),(8388607&this.seeds[3])*(1/8388607)}},{key:"getSignedFloat",value:function(){return 2*this.getFloat()-1}},{key:"seed",get:function(){return this.seeds[0]},set:function(e){this.seeds[0]=e,this.seeds[1]=1812433253*this.seeds[0]+1,this.seeds[2]=1812433253*this.seeds[1]+1,this.seeds[3]=1812433253*this.seeds[2]+1}}],[{key:"getFloatFromInt",value:function(e){return 1/8388607*(8388607&e)}},{key:"getByteFromInt",value:function(e){return(8388607&e)>>>15}}]),sr}(),Bo=function(){function or(){_classCallCheck(this,or),this._emissionRate=10,this._destroyed=!1,this._bursts=[]}return _createClass(or,[{key:"destroy",value:function(){this._bursts=null,this._destroyed=!0}},{key:"getBurstsCount",value:function(){return this._bursts.length}},{key:"getBurstByIndex",value:function(e){return this._bursts[e]}},{key:"addBurst",value:function(e){var t=this._bursts.length;if(t>0)for(var n=0;n<t;n++)this._bursts[n].time>e.time&&this._bursts.splice(n,0,e);this._bursts.push(e)}},{key:"removeBurst",value:function(e){var t=this._bursts.indexOf(e);-1!==t&&this._bursts.splice(t,1)}},{key:"removeBurstByIndex",value:function(e){this._bursts.splice(e,1)}},{key:"clearBurst",value:function(){this._bursts.length=0}},{key:"cloneTo",value:function(e){var t=e,n=t._bursts;n.length=this._bursts.length;for(var i=0,r=this._bursts.length;i<r;i++){var a=n[i];a?this._bursts[i].cloneTo(a):n[i]=this._bursts[i].clone()}t._emissionRate=this._emissionRate,t.enable=this.enable}},{key:"clone",value:function(){var e=new or;return this.cloneTo(e),e}},{key:"emissionRate",set:function(e){if(e<0)throw new Error("ParticleBaseShape:emissionRate value must large or equal than 0.");this._emissionRate=e},get:function(){return this._emissionRate}},{key:"destroyed",get:function(){return this._destroyed}}]),or}(),Fo=function(){function lr(){_classCallCheck(this,lr)}return _createClass(lr,null,[{key:"_getStartLifetimeFromGradient",value:function(e,n){for(var i=1,r=e.gradientCount;i<r;i++){var a=e.getKeyByIndex(i);if(a>=n){var o=e.getKeyByIndex(i-1),s=(n-o)/(a-o);return t.MathUtil.lerp(e.getValueByIndex(i-1),e.getValueByIndex(i),s)}}throw new Error("ShurikenParticleData: can't get value foam startLifeTimeGradient.")}},{key:"_randomInvertRoationArray",value:function(e,t,n,i,r){var a;i?(i.seed=r[6],a=i.getFloat(),r[6]=i.seed):a=Math.random(),a<n?(t.x=-e.x,t.y=-e.y,t.z=-e.z):(t.x=e.x,t.y=e.y,t.z=e.z)}},{key:"_randomInvertRoation",value:function(e,t,n,i){var r;return n?(n.seed=i[6],r=n.getFloat(),i[6]=n.seed):r=Math.random(),r<t&&(e=-e),e}},{key:"create",value:function(e,n){var i=e.autoRandomSeed,r=e._rand,a=e._randomSeeds;switch(e.startColorType){case 0:var s=e.startColorConstant;lr.startColor.x=s.x,lr.startColor.y=s.y,lr.startColor.z=s.z,lr.startColor.w=s.w;break;case 2:i?o.lerp(e.startColorConstantMin,e.startColorConstantMax,Math.random(),lr.startColor):(r.seed=a[3],o.lerp(e.startColorConstantMin,e.startColorConstantMax,r.getFloat(),lr.startColor),a[3]=r.seed)}var l=e.colorOverLifetime;if(l&&l.enable){var u=l.color;switch(u.type){case 0:lr.startColor.x=lr.startColor.x*u.constant.x,lr.startColor.y=lr.startColor.y*u.constant.y,lr.startColor.z=lr.startColor.z*u.constant.z,lr.startColor.w=lr.startColor.w*u.constant.w;break;case 2:var _;i?_=Math.random():(r.seed=a[10],_=r.getFloat(),a[10]=r.seed);var c=u.constantMin,h=u.constantMax;lr.startColor.x=lr.startColor.x*t.MathUtil.lerp(c.x,h.x,_),lr.startColor.y=lr.startColor.y*t.MathUtil.lerp(c.y,h.y,_),lr.startColor.z=lr.startColor.z*t.MathUtil.lerp(c.z,h.z,_),lr.startColor.w=lr.startColor.w*t.MathUtil.lerp(c.w,h.w,_)}}var d=lr.startSize;switch(e.startSizeType){case 0:if(e.threeDStartSize){var f=e.startSizeConstantSeparate;d[0]=f.x,d[1]=f.y,d[2]=f.z}else d[0]=d[1]=d[2]=e.startSizeConstant;break;case 2:if(e.threeDStartSize){var m=e.startSizeConstantMinSeparate,p=e.startSizeConstantMaxSeparate;i?(d[0]=t.MathUtil.lerp(m.x,p.x,Math.random()),d[1]=t.MathUtil.lerp(m.y,p.y,Math.random()),d[2]=t.MathUtil.lerp(m.z,p.z,Math.random())):(r.seed=a[4],d[0]=t.MathUtil.lerp(m.x,p.x,r.getFloat()),d[1]=t.MathUtil.lerp(m.y,p.y,r.getFloat()),d[2]=t.MathUtil.lerp(m.z,p.z,r.getFloat()),a[4]=r.seed)}else i?d[0]=d[1]=d[2]=t.MathUtil.lerp(e.startSizeConstantMin,e.startSizeConstantMax,Math.random()):(r.seed=a[4],d[0]=d[1]=d[2]=t.MathUtil.lerp(e.startSizeConstantMin,e.startSizeConstantMax,r.getFloat()),a[4]=r.seed)}var v=e.sizeOverLifetime;if(v&&v.enable&&1===v.size.type){var E,T=v.size;T.separateAxes?i?(d[0]=d[0]*t.MathUtil.lerp(T.constantMinSeparate.x,T.constantMaxSeparate.x,Math.random()),d[1]=d[1]*t.MathUtil.lerp(T.constantMinSeparate.y,T.constantMaxSeparate.y,Math.random()),d[2]=d[2]*t.MathUtil.lerp(T.constantMinSeparate.z,T.constantMaxSeparate.z,Math.random())):(r.seed=a[11],d[0]=d[0]*t.MathUtil.lerp(T.constantMinSeparate.x,T.constantMaxSeparate.x,r.getFloat()),d[1]=d[1]*t.MathUtil.lerp(T.constantMinSeparate.y,T.constantMaxSeparate.y,r.getFloat()),d[2]=d[2]*t.MathUtil.lerp(T.constantMinSeparate.z,T.constantMaxSeparate.z,r.getFloat()),a[11]=r.seed):(i?E=t.MathUtil.lerp(T.constantMin,T.constantMax,Math.random()):(r.seed=a[11],E=t.MathUtil.lerp(T.constantMin,T.constantMax,r.getFloat()),a[11]=r.seed),d[0]=d[0]*E,d[1]=d[1]*E,d[2]=d[2]*E)}var g=n.renderMode;if(1!==g)switch(e.startRotationType){case 0:if(e.threeDStartRotation){var y=e.startRotationConstantSeparate,S=lr._tempVector30;lr._randomInvertRoationArray(y,S,e.randomizeRotationDirection,i?null:r,a),lr.startRotation[0]=S.x,lr.startRotation[1]=S.y,lr.startRotation[2]=4!==g?-S.z:S.z}else lr.startRotation[0]=lr._randomInvertRoation(e.startRotationConstant,e.randomizeRotationDirection,i?null:r,a),lr.startRotation[1]=0,lr.startRotation[2]=0;break;case 2:if(e.threeDStartRotation){var R=e.startRotationConstantMinSeparate,C=e.startRotationConstantMaxSeparate,A=lr._tempVector30;i?(A.x=t.MathUtil.lerp(R.x,C.x,Math.random()),A.y=t.MathUtil.lerp(R.y,C.y,Math.random()),A.z=t.MathUtil.lerp(R.z,C.z,Math.random())):(r.seed=a[5],A.x=t.MathUtil.lerp(R.x,C.x,r.getFloat()),A.y=t.MathUtil.lerp(R.y,C.y,r.getFloat()),A.z=t.MathUtil.lerp(R.z,C.z,r.getFloat()),a[5]=r.seed),lr._randomInvertRoationArray(A,A,e.randomizeRotationDirection,i?null:r,a),lr.startRotation[0]=A.x,lr.startRotation[1]=A.y,lr.startRotation[2]=4!==g?-A.z:A.z}else i?lr.startRotation[0]=lr._randomInvertRoation(t.MathUtil.lerp(e.startRotationConstantMin,e.startRotationConstantMax,Math.random()),e.randomizeRotationDirection,i?null:r,a):(r.seed=a[5],lr.startRotation[0]=lr._randomInvertRoation(t.MathUtil.lerp(e.startRotationConstantMin,e.startRotationConstantMax,r.getFloat()),e.randomizeRotationDirection,i?null:r,a),a[5]=r.seed)}switch(e.startLifetimeType){case 0:lr.startLifeTime=e.startLifetimeConstant;break;case 1:lr.startLifeTime=lr._getStartLifetimeFromGradient(e.startLifeTimeGradient,e.emissionTime);break;case 2:i?lr.startLifeTime=t.MathUtil.lerp(e.startLifetimeConstantMin,e.startLifetimeConstantMax,Math.random()):(r.seed=a[7],lr.startLifeTime=t.MathUtil.lerp(e.startLifetimeConstantMin,e.startLifetimeConstantMax,r.getFloat()),a[7]=r.seed);break;case 3:var I=e.emissionTime;i?lr.startLifeTime=t.MathUtil.lerp(lr._getStartLifetimeFromGradient(e.startLifeTimeGradientMin,I),lr._getStartLifetimeFromGradient(e.startLifeTimeGradientMax,I),Math.random()):(r.seed=a[7],lr.startLifeTime=t.MathUtil.lerp(lr._getStartLifetimeFromGradient(e.startLifeTimeGradientMin,I),lr._getStartLifetimeFromGradient(e.startLifeTimeGradientMax,I),r.getFloat()),a[7]=r.seed)}var x=e.textureSheetAnimation;if(x&&x.enable){var D,M=x.tiles,L=M.x,O=M.y,N=1/L,P=1/O,b=x.startFrame;switch(b.type){case 0:D=b.constant;break;case 1:i?D=t.MathUtil.lerp(b.constantMin,b.constantMax,Math.random()):(r.seed=a[14],D=t.MathUtil.lerp(b.constantMin,b.constantMax,r.getFloat()),a[14]=r.seed)}var w=x.frame,k=x.cycles;switch(w.type){case 0:D+=w.constant*k;break;case 2:i?D+=t.MathUtil.lerp(w.constantMin,w.constantMax,Math.random())*k:(r.seed=a[15],D+=t.MathUtil.lerp(w.constantMin,w.constantMax,r.getFloat())*k,a[15]=r.seed)}var V=0;switch(x.type){case 0:V=Math.floor(D/L);break;case 1:x.randomRow?i?V=Math.floor(Math.random()*O):(r.seed=a[13],V=Math.floor(r.getFloat()*O),a[13]=r.seed):V=x.rowIndex}var B=Math.floor(D%L);lr.startUVInfo=lr.startUVInfo,lr.startUVInfo[0]=N,lr.startUVInfo[1]=P,lr.startUVInfo[2]=B*N,lr.startUVInfo[3]=V*P}else lr.startUVInfo=lr.startUVInfo,lr.startUVInfo[0]=1,lr.startUVInfo[1]=1,lr.startUVInfo[2]=0,lr.startUVInfo[3]=0}}]),lr}();Fo._tempVector30=new D,Fo.startColor=new o,Fo.startSize=new Float32Array(3),Fo.startRotation=new Float32Array(3),Fo.startUVInfo=new Float32Array(4);var Uo=function(n){function hr(e){var t;return _classCallCheck(this,hr),(t=_possibleConstructorReturn(this,_getPrototypeOf(hr).call(this)))._boundingSphere=null,t._boundingBox=null,t._boundingBoxCorners=null,t._bounds=null,t._gravityOffset=new r,t._customBounds=null,t._useCustomBounds=!1,t._owner=null,t._ownerRender=null,t._vertices=null,t._floatCountPerVertex=0,t._startLifeTimeIndex=0,t._timeIndex=0,t._simulateUpdate=!1,t._firstActiveElement=0,t._firstNewElement=0,t._firstFreeElement=0,t._firstRetiredElement=0,t._drawCounter=0,t._bufferMaxParticles=0,t._emission=null,t._shape=null,t._isEmitting=!1,t._isPlaying=!1,t._isPaused=!1,t._playStartDelay=0,t._frameRateTime=0,t._emissionTime=0,t._totalDelayTime=0,t._burstsIndex=0,t._velocityOverLifetime=null,t._colorOverLifetime=null,t._sizeOverLifetime=null,t._rotationOverLifetime=null,t._textureSheetAnimation=null,t._startLifetimeType=0,t._startLifetimeConstant=0,t._startLifeTimeGradient=null,t._startLifetimeConstantMin=0,t._startLifetimeConstantMax=0,t._startLifeTimeGradientMin=null,t._startLifeTimeGradientMax=null,t._maxStartLifetime=0,t._uvLength=new r,t._vertexStride=0,t._indexStride=0,t._vertexBuffer=null,t._indexBuffer=null,t._bufferState=new yn,t._updateMask=0,t._currentTime=0,t._startUpdateLoopCount=0,t._rand=null,t._randomSeeds=null,t.duration=0,t.looping=!1,t.prewarm=!1,t.startDelayType=0,t.startDelay=0,t.startDelayMin=0,t.startDelayMax=0,t.startSpeedType=0,t.startSpeedConstant=0,t.startSpeedConstantMin=0,t.startSpeedConstantMax=0,t.threeDStartSize=!1,t.startSizeType=0,t.startSizeConstant=0,t.startSizeConstantSeparate=null,t.startSizeConstantMin=0,t.startSizeConstantMax=0,t.startSizeConstantMinSeparate=null,t.startSizeConstantMaxSeparate=null,t.threeDStartRotation=!1,t.startRotationType=0,t.startRotationConstant=0,t.startRotationConstantSeparate=null,t.startRotationConstantMin=0,t.startRotationConstantMax=0,t.startRotationConstantMinSeparate=null,t.startRotationConstantMaxSeparate=null,t.randomizeRotationDirection=0,t.startColorType=0,t.startColorConstant=new o(1,1,1,1),t.startColorConstantMin=new o(0,0,0,0),t.startColorConstantMax=new o(1,1,1,1),t.gravityModifier=0,t.simulationSpace=0,t.simulationSpeed=1,t.scaleMode=1,t.playOnAwake=!1,t.randomSeed=null,t.autoRandomSeed=!1,t.isPerformanceMode=!1,t._firstActiveElement=0,t._firstNewElement=0,t._firstFreeElement=0,t._firstRetiredElement=0,t._owner=e,t._ownerRender=e.particleRenderer,t._boundingBoxCorners=[],t._boundingSphere=new Va(new D,Number.MAX_VALUE),t._boundingBox=new pa(new D(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),new D(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)),t._bounds=new va(t._boundingBox.min,t._boundingBox.max),t._useCustomBounds=!1,t._currentTime=0,t._isEmitting=!1,t._isPlaying=!1,t._isPaused=!1,t._burstsIndex=0,t._frameRateTime=0,t._emissionTime=0,t._totalDelayTime=0,t._simulateUpdate=!1,t._bufferMaxParticles=1,t.duration=5,t.looping=!0,t.prewarm=!1,t.startDelayType=0,t.startDelay=0,t.startDelayMin=0,t.startDelayMax=0,t._startLifetimeType=0,t._startLifetimeConstant=5,t._startLifeTimeGradient=new po,t._startLifetimeConstantMin=0,t._startLifetimeConstantMax=5,t._startLifeTimeGradientMin=new po,t._startLifeTimeGradientMax=new po,t._maxStartLifetime=5,t.startSpeedType=0,t.startSpeedConstant=5,t.startSpeedConstantMin=0,t.startSpeedConstantMax=5,t.threeDStartSize=!1,t.startSizeType=0,t.startSizeConstant=1,t.startSizeConstantSeparate=new D(1,1,1),t.startSizeConstantMin=0,t.startSizeConstantMax=1,t.startSizeConstantMinSeparate=new D(0,0,0),t.startSizeConstantMaxSeparate=new D(1,1,1),t.threeDStartRotation=!1,t.startRotationType=0,t.startRotationConstant=0,t.startRotationConstantSeparate=new D(0,0,0),t.startRotationConstantMin=0,t.startRotationConstantMax=0,t.startRotationConstantMinSeparate=new D(0,0,0),t.startRotationConstantMaxSeparate=new D(0,0,0),t.gravityModifier=0,t.simulationSpace=1,t.scaleMode=1,t.playOnAwake=!0,t._rand=new Vo(0),t.autoRandomSeed=!0,t.randomSeed=new Uint32Array(1),t._randomSeeds=new Uint32Array(hr._RANDOMOFFSET.length),t.isPerformanceMode=!0,t._emission=new Bo,t._emission.enable=!0,t}return _inherits(hr,Ea),_createClass(hr,[{key:"_getVertexBuffer",value:function(){return 0===(arguments.length>0&&void 0!==arguments[0]?arguments[0]:0)?this._vertexBuffer:null}},{key:"_getIndexBuffer",value:function(){return this._indexBuffer}},{key:"_generateBoundingSphere",value:function(){var e=this._boundingSphere.center;e.x=0,e.y=0,e.z=0,this._boundingSphere.radius=Number.MAX_VALUE}},{key:"_generateBounds",value:function(){var t=this._owner.particleRenderer,n=this._bounds.getMin(),i=this._bounds.getMax(),r=0;switch(this.startLifetimeType){case 0:r=this._startLifetimeConstant;break;case 2:r=this._startLifetimeConstantMax}var a=0;switch(this.startSpeedType){case 0:a=this.startSpeedConstant;break;case 2:a=this.startSpeedConstantMax}var o=0;if(this.threeDStartSize)switch(this.startSizeType){case 0:o=Math.max(this.startSizeConstantSeparate.x,this.startSizeConstantSeparate.y,this.startSizeConstantSeparate.z);break;case 2:o=Math.max(this.startSizeConstantMaxSeparate.x,this.startSizeConstantMaxSeparate.y,this.startSizeConstantMaxSeparate.z)}else switch(this.startSizeType){case 0:o=this.startSizeConstant;break;case 2:o=this.startSizeConstantMax}var s=hr._tempVector30,l=hr._tempVector31,u=hr._tempVector32,_=hr._tempVector33;if(s.setValue(0,0,1),l.setValue(0,0,0),u.setValue(0,0,0),_.setValue(0,0,0),this.shape&&this.shape.enable)switch(this.shape.shapeType){case e.ParticleSystemShapeType.Sphere:var c=this.shape;s.setValue(1,1,1),l.setValue(1,1,1),u.setValue(c.radius,c.radius,c.radius),_.setValue(c.radius,c.radius,c.radius);break;case e.ParticleSystemShapeType.Hemisphere:var h=this.shape;s.setValue(1,1,1),l.setValue(1,1,1),u.setValue(h.radius,h.radius,h.radius),_.setValue(h.radius,h.radius,0);break;case e.ParticleSystemShapeType.Cone:var d=this.shape;if(0==d.emitType||1==d.emitType){var f=d.angle,m=Math.sin(f);s.setValue(m,m,1),l.setValue(m,m,0),u.setValue(d.radius,d.radius,0),_.setValue(d.radius,d.radius,0);break}if(2==d.emitType||3==d.emitType){f=d.angle,m=Math.sin(f);var p=d.length;s.setValue(m,m,1),l.setValue(m,m,0);var v=Math.tan(f),E=d.radius+p*v;u.setValue(E,E,p),_.setValue(E,E,0)}break;case e.ParticleSystemShapeType.Box:var T=this.shape;0!=this.shape.randomDirection&&(s.setValue(1,1,1),l.setValue(1,1,1)),u.setValue(T.x/2,T.y/2,T.z/2),_.setValue(T.x/2,T.y/2,T.z/2);break;case e.ParticleSystemShapeType.Circle:var g=this.shape;s.setValue(1,1,1),l.setValue(1,1,1),u.setValue(g.radius,g.radius,0),_.setValue(g.radius,g.radius,0)}var y=0,S=4==t.renderMode;switch(t.renderMode){case 0:case 1:case 2:case 3:y=hr.halfKSqrtOf2;break;case 4:var R=t.mesh.bounds;y=Math.sqrt(Math.pow(R.getExtent().x,2)+Math.pow(R.getExtent().y,2)+Math.pow(R.getExtent().z,2))}var C=hr._tempVector36;if(C.setValue(1,1,1),this.sizeOverLifetime&&this.sizeOverLifetime.enable){var A=this.sizeOverLifetime.size.getMaxSizeInGradient(S);C.setValue(A,A,A)}var I=y*o;D.scale(C,I,C);var x=hr._tempVector34,M=hr._tempVector35;if(a>0?(D.scale(s,a,x),D.scale(l,a,M)):(D.scale(s,-a,M),D.scale(l,-a,x)),this.velocityOverLifetime&&this.velocityOverLifetime.enable){var L=this.velocityOverLifetime.velocity,O=hr._tempVector37;switch(O.setValue(0,0,0),L.type){case 0:L.constant.cloneTo(O);break;case 2:L.constantMax.cloneTo(O);break;case 1:var N=L.gradientX.getAverageValue(),P=L.gradientY.getAverageValue(),b=L.gradientZ.getAverageValue();O.setValue(N,P,b);break;case 3:var w=L.gradientXMax.getAverageValue(),k=L.gradientYMax.getAverageValue(),V=L.gradientZMax.getAverageValue();O.setValue(w,k,V)}1==this.velocityOverLifetime.space&&D.transformV3ToV3(O,this._owner.transform.worldMatrix,O),D.add(x,O,x),D.subtract(M,O,M),D.max(x,D._ZERO,x),D.max(M,D._ZERO,M)}D.scale(x,r,x),D.scale(M,r,M);var B=this.gravityModifier;if(0!=B){var F=.5*hr.g*B*r*r,U=x.y-F,G=M.y+F;U=U>0?U:0,G=G>0?G:0,this._gravityOffset.setValue(x.y-U,G-M.y)}D.add(x,C,i),D.add(i,u,i),D.add(M,C,n),D.add(n,_,n),D.scale(n,-1,n),this._bounds.setMin(n),this._bounds.setMax(i)}},{key:"_simulationSupported",value:function(){return 0!=this.simulationSpace}},{key:"_updateEmission",value:function(){if(this.isAlive)if(this._simulateUpdate)this._simulateUpdate=!1;else{var e=this._startUpdateLoopCount===t.Stat.loopCount||this._isPaused?0:this._owner._scene.timer._delta/1e3;e=Math.min(hr._maxElapsedTime,e*this.simulationSpeed),this._updateParticles(e)}}},{key:"_updateParticles",value:function(e){(4!==this._ownerRender.renderMode||this._ownerRender.mesh)&&(this._currentTime+=e,this._retireActiveParticles(),this._freeRetiredParticles(),this._totalDelayTime+=e,this._totalDelayTime<this._playStartDelay||this._emission.enable&&this._isEmitting&&!this._isPaused&&this._advanceTime(e,this._currentTime))}},{key:"_updateParticlesSimulationRestart",value:function(e){this._firstActiveElement=0,this._firstNewElement=0,this._firstFreeElement=0,this._firstRetiredElement=0,this._burstsIndex=0,this._frameRateTime=e,this._emissionTime=0,this._totalDelayTime=0,this._currentTime=e;var t=e;t<this._playStartDelay?this._totalDelayTime=t:this._emission.enable&&this._advanceTime(e,e)}},{key:"_retireActiveParticles",value:function(){for(;this._firstActiveElement!=this._firstNewElement;){var e=this._firstActiveElement*this._floatCountPerVertex*this._vertexStride,t=e+this._timeIndex;if(this._currentTime-this._vertices[t]+1e-4<this._vertices[e+this._startLifeTimeIndex])break;this._vertices[t]=this._drawCounter,this._firstActiveElement++,this._firstActiveElement>=this._bufferMaxParticles&&(this._firstActiveElement=0)}}},{key:"_freeRetiredParticles",value:function(){for(;this._firstRetiredElement!=this._firstActiveElement;)this._drawCounter,this._vertices[this._firstRetiredElement*this._floatCountPerVertex*this._vertexStride+this._timeIndex],this._firstRetiredElement++,this._firstRetiredElement>=this._bufferMaxParticles&&(this._firstRetiredElement=0)}},{key:"_burst",value:function(e,n){for(var i=0,r=this._emission._bursts,a=r.length;this._burstsIndex<a;this._burstsIndex++){var o,s=r[this._burstsIndex],l=s.time;if(!(e<=l&&l<n))break;this.autoRandomSeed?o=t.MathUtil.lerp(s.minCount,s.maxCount,Math.random()):(this._rand.seed=this._randomSeeds[0],o=t.MathUtil.lerp(s.minCount,s.maxCount,this._rand.getFloat()),this._randomSeeds[0]=this._rand.seed),i+=o}return i}},{key:"_advanceTime",value:function(e,t){var n,i=this._emissionTime;this._emissionTime+=e;var r=0;if(this._emissionTime>this.duration){if(!this.looping){for(r=Math.min(this.maxParticles-this.aliveParticleCount,r),n=0;n<r;n++)this.emit(t);return this._isPlaying=!1,void this.stop()}r+=this._burst(i,this._emissionTime),this._emissionTime-=this.duration,this._burstsIndex=0,r+=this._burst(0,this._emissionTime)}else r+=this._burst(i,this._emissionTime);for(r=Math.min(this.maxParticles-this.aliveParticleCount,r),n=0;n<r;n++)this.emit(t);var a=this.emission.emissionRate;if(a>0){var o=1/a;for(this._frameRateTime+=o,this._frameRateTime=this._currentTime-(this._currentTime-this._frameRateTime)%this._maxStartLifetime;this._frameRateTime<=t&&this.emit(this._frameRateTime);)this._frameRateTime+=o;this._frameRateTime=Math.floor(t/o)*o}}},{key:"_initBufferDatas",value:function(){if(this._vertexBuffer){var n=this._vertexBuffer._byteLength+2*this._indexBuffer.indexCount;this._vertexBuffer.destroy(),this._indexBuffer.destroy(),t.Resource._addMemory(-n,-n)}var i=t.LayaGL.instance,r=this._ownerRender,a=r.renderMode;if(-1!==a&&this.maxParticles>0){var o,s,l,u,_,c,h,d=0,f=(n=0,r.mesh);if(4===a){if(f){h=ko.vertexDeclaration,this._floatCountPerVertex=h.vertexStride/4,this._startLifeTimeIndex=12,this._timeIndex=16,this._vertexStride=f._vertexCount;var m=this._bufferMaxParticles*this._vertexStride,p=m%65535;if(Math.floor(m/65535)+1>1)throw new Error("ShurikenParticleSystem:the maxParticleCount multiply mesh vertexCount is large than 65535.");d=h.vertexStride*p,this._vertexBuffer=new pn(d,i.DYNAMIC_DRAW),this._vertexBuffer.vertexDeclaration=h,this._vertices=new Float32Array(this._floatCountPerVertex*p),this._indexStride=f._indexBuffer.indexCount;var v=f._indexBuffer.getData(),E=this._bufferMaxParticles*this._indexStride;for(this._indexBuffer=new Wn(e.IndexFormat.UInt16,E,i.STATIC_DRAW),o=new Uint16Array(E),n=d+2*E,_=0,s=0;s<this._bufferMaxParticles;s++){var T=s*this._vertexStride;for(l=0,u=v.length;l<u;l++)o[_++]=T+v[l]}this._indexBuffer.setData(o),this._bufferState.bind(),this._bufferState.applyVertexBuffer(this._vertexBuffer),this._bufferState.applyIndexBuffer(this._indexBuffer),this._bufferState.unBind()}}else{for(h=wo.vertexDeclaration,this._floatCountPerVertex=h.vertexStride/4,this._startLifeTimeIndex=7,this._timeIndex=11,this._vertexStride=4,d=h.vertexStride*this._bufferMaxParticles*this._vertexStride,this._vertexBuffer=new pn(d,i.DYNAMIC_DRAW),this._vertexBuffer.vertexDeclaration=h,this._vertices=new Float32Array(this._floatCountPerVertex*this._bufferMaxParticles*this._vertexStride),s=0;s<this._bufferMaxParticles;s++)c=s*this._floatCountPerVertex*this._vertexStride,this._vertices[c]=-.5,this._vertices[c+1]=-.5,this._vertices[c+2]=0,this._vertices[c+3]=1,c+=this._floatCountPerVertex,this._vertices[c]=.5,this._vertices[c+1]=-.5,this._vertices[c+2]=1,this._vertices[c+3]=1,c+=this._floatCountPerVertex,this._vertices[c]=.5,this._vertices[c+1]=.5,this._vertices[c+2]=1,this._vertices[c+3]=0,c+=this._floatCountPerVertex,this._vertices[c]=-.5,this._vertices[c+1]=.5,this._vertices[c+2]=0,this._vertices[c+3]=0;for(this._indexStride=6,this._indexBuffer=new Wn(e.IndexFormat.UInt16,6*this._bufferMaxParticles,i.STATIC_DRAW),o=new Uint16Array(6*this._bufferMaxParticles),s=0;s<this._bufferMaxParticles;s++){_=6*s;var g=s*this._vertexStride,y=g+2;o[_++]=g,o[_++]=y,o[_++]=g+1,o[_++]=g,o[_++]=g+3,o[_++]=y}this._indexBuffer.setData(o),n=d+6*this._bufferMaxParticles*2,this._bufferState.bind(),this._bufferState.applyVertexBuffer(this._vertexBuffer),this._bufferState.applyIndexBuffer(this._indexBuffer),this._bufferState.unBind()}t.Resource._addMemory(n,n)}}},{key:"destroy",value:function(){_get(_getPrototypeOf(hr.prototype),"destroy",this).call(this);var e=this._vertexBuffer._byteLength+2*this._indexBuffer.indexCount;t.Resource._addMemory(-e,-e),this._bufferState.destroy(),this._vertexBuffer.destroy(),this._indexBuffer.destroy(),this._emission.destroy(),this._boundingBox=null,this._boundingSphere=null,this._boundingBoxCorners=null,this._bounds=null,this._customBounds=null,this._bufferState=null,this._vertexBuffer=null,this._indexBuffer=null,this._owner=null,this._vertices=null,this._indexBuffer=null,this._emission=null,this._shape=null,this.startLifeTimeGradient=null,this.startLifeTimeGradientMin=null,this.startLifeTimeGradientMax=null,this.startSizeConstantSeparate=null,this.startSizeConstantMinSeparate=null,this.startSizeConstantMaxSeparate=null,this.startRotationConstantSeparate=null,this.startRotationConstantMinSeparate=null,this.startRotationConstantMaxSeparate=null,this.startColorConstant=null,this.startColorConstantMin=null,this.startColorConstantMax=null,this._velocityOverLifetime=null,this._colorOverLifetime=null,this._sizeOverLifetime=null,this._rotationOverLifetime=null,this._textureSheetAnimation=null}},{key:"emit",value:function(e){var t=hr._tempPosition,n=hr._tempDirection;return this._shape&&this._shape.enable?this.autoRandomSeed?this._shape.generatePositionAndDirection(t,n):this._shape.generatePositionAndDirection(t,n,this._rand,this._randomSeeds):(t.x=t.y=t.z=0,n.x=n.y=0,n.z=1),this.addParticle(t,n,e)}},{key:"addParticle",value:function(e,n,i){D.normalize(n,n);var r=this._firstFreeElement+1;if(r>=this._bufferMaxParticles&&(r=0),r===this._firstRetiredElement)return!1;var a,o,s,l,u,_,c,h,d,f,m=this._owner.transform;if(Fo.create(this,this._ownerRender),this._currentTime-i>=Fo.startLifeTime)return!0;switch(0==this.simulationSpace&&(a=m.position,o=m.rotation),this.startSpeedType){case 0:s=this.startSpeedConstant;break;case 2:this.autoRandomSeed?s=t.MathUtil.lerp(this.startSpeedConstantMin,this.startSpeedConstantMax,Math.random()):(this._rand.seed=this._randomSeeds[8],s=t.MathUtil.lerp(this.startSpeedConstantMin,this.startSpeedConstantMax,this._rand.getFloat()),this._randomSeeds[8]=this._rand.seed)}var p=this._velocityOverLifetime&&this._velocityOverLifetime.enable;if(p){var v=this._velocityOverLifetime.velocity.type;2===v||3===v?this.autoRandomSeed?(l=Math.random(),u=Math.random(),_=Math.random()):(this._rand.seed=this._randomSeeds[9],l=this._rand.getFloat(),u=this._rand.getFloat(),_=this._rand.getFloat(),this._randomSeeds[9]=this._rand.seed):p=!1}else p=!1;var E=this._colorOverLifetime&&this._colorOverLifetime.enable;E&&3===this._colorOverLifetime.color.type?this.autoRandomSeed?c=Math.random():(this._rand.seed=this._randomSeeds[10],c=this._rand.getFloat(),this._randomSeeds[10]=this._rand.seed):E=!1;var T=this._sizeOverLifetime&&this._sizeOverLifetime.enable;T&&3===this._sizeOverLifetime.size.type?this.autoRandomSeed?h=Math.random():(this._rand.seed=this._randomSeeds[11],h=this._rand.getFloat(),this._randomSeeds[11]=this._rand.seed):T=!1;var g=this._rotationOverLifetime&&this._rotationOverLifetime.enable;if(g){var y=this._rotationOverLifetime.angularVelocity.type;2===y||3===y?this.autoRandomSeed?d=Math.random():(this._rand.seed=this._randomSeeds[12],d=this._rand.getFloat(),this._randomSeeds[12]=this._rand.seed):g=!1}else g=!1;var S=this._textureSheetAnimation&&this._textureSheetAnimation.enable;S&&3===this._textureSheetAnimation.frame.type?this.autoRandomSeed?f=Math.random():(this._rand.seed=this._randomSeeds[15],f=this._rand.getFloat(),this._randomSeeds[15]=this._rand.seed):S=!1;var R,C,A,I,x,M,L=this._firstFreeElement*this._floatCountPerVertex*this._vertexStride,O=Fo.startUVInfo[0],N=Fo.startUVInfo[1],P=Fo.startUVInfo[2],b=Fo.startUVInfo[3],w=this._ownerRender;if(4===w.renderMode){var k=w.mesh._vertexBuffer;R=k.getFloat32Data();var V=k.vertexDeclaration;A=V.getVertexElementByUsage(Xn.MESH_POSITION0)._offset/4;var B=V.getVertexElementByUsage(Xn.MESH_COLOR0);I=B?B._offset/4:-1;var F=V.getVertexElementByUsage(Xn.MESH_TEXTURECOORDINATE0);x=F?F._offset/4:-1,C=V.vertexStride/4,M=0}else{this._vertices[L+2]=P,this._vertices[L+3]=b+N;var U=L+this._floatCountPerVertex;this._vertices[U+2]=P+O,this._vertices[U+3]=b+N;var G=U+this._floatCountPerVertex;this._vertices[G+2]=P+O,this._vertices[G+3]=b;var H=G+this._floatCountPerVertex;this._vertices[H+2]=P,this._vertices[H+3]=b}for(var z=L,W=L+this._floatCountPerVertex*this._vertexStride;z<W;z+=this._floatCountPerVertex){var X;if(4===w.renderMode){X=z;var Y=C*M++,j=Y+A;this._vertices[X++]=R[j++],this._vertices[X++]=R[j++],this._vertices[X++]=R[j],-1===I?(this._vertices[X++]=1,this._vertices[X++]=1,this._vertices[X++]=1,this._vertices[X++]=1):(j=Y+I,this._vertices[X++]=R[j++],this._vertices[X++]=R[j++],this._vertices[X++]=R[j++],this._vertices[X++]=R[j]),-1===x?(this._vertices[X++]=0,this._vertices[X++]=0):(j=Y+x,this._vertices[X++]=P+R[j++]*O,this._vertices[X++]=b+R[j]*N)}else X=z+4;switch(this._vertices[X++]=e.x,this._vertices[X++]=e.y,this._vertices[X++]=e.z,this._vertices[X++]=Fo.startLifeTime,this._vertices[X++]=n.x,this._vertices[X++]=n.y,this._vertices[X++]=n.z,this._vertices[X++]=i,this._vertices[X++]=Fo.startColor.x,this._vertices[X++]=Fo.startColor.y,this._vertices[X++]=Fo.startColor.z,this._vertices[X++]=Fo.startColor.w,this._vertices[X++]=Fo.startSize[0],this._vertices[X++]=Fo.startSize[1],this._vertices[X++]=Fo.startSize[2],this._vertices[X++]=Fo.startRotation[0],this._vertices[X++]=Fo.startRotation[1],this._vertices[X++]=Fo.startRotation[2],this._vertices[X++]=s,E&&(this._vertices[X+1]=c),T&&(this._vertices[X+2]=h),g&&(this._vertices[X+3]=d),S&&(this._vertices[X+4]=f),p&&(this._vertices[X+5]=l,this._vertices[X+6]=u,this._vertices[X+7]=_),this.simulationSpace){case 0:X+=8,this._vertices[X++]=a.x,this._vertices[X++]=a.y,this._vertices[X++]=a.z,this._vertices[X++]=o.x,this._vertices[X++]=o.y,this._vertices[X++]=o.z,this._vertices[X++]=o.w;break;case 1:break;default:throw new Error("ShurikenParticleMaterial: SimulationSpace value is invalid.")}}return this._firstFreeElement=r,!0}},{key:"addNewParticlesToVertexBuffer",value:function(){var e,t=this._vertexStride*this._floatCountPerVertex*4;this._firstNewElement<this._firstFreeElement?(e=this._firstNewElement*t,this._vertexBuffer.setData(this._vertices.buffer,e,e,(this._firstFreeElement-this._firstNewElement)*t)):(e=this._firstNewElement*t,this._vertexBuffer.setData(this._vertices.buffer,e,e,(this._bufferMaxParticles-this._firstNewElement)*t),this._firstFreeElement>0&&this._vertexBuffer.setData(this._vertices.buffer,0,0,this._firstFreeElement*t)),this._firstNewElement=this._firstFreeElement}},{key:"_getType",value:function(){return hr._type}},{key:"_prepareRender",value:function(e){return this._updateMask!=t.Stat.loopCount&&(this._updateMask=t.Stat.loopCount,this._updateEmission(),this._firstNewElement!=this._firstFreeElement&&this.addNewParticlesToVertexBuffer(),this._drawCounter++),this._firstActiveElement!=this._firstFreeElement}},{key:"_render",value:function(e){var n;this._bufferState.bind();var i=t.LayaGL.instance;this._firstActiveElement<this._firstFreeElement?(n=(this._firstFreeElement-this._firstActiveElement)*this._indexStride,i.drawElements(i.TRIANGLES,n,i.UNSIGNED_SHORT,2*this._firstActiveElement*this._indexStride),t.Stat.trianglesFaces+=n/3,t.Stat.renderBatches++):(n=(this._bufferMaxParticles-this._firstActiveElement)*this._indexStride,i.drawElements(i.TRIANGLES,n,i.UNSIGNED_SHORT,2*this._firstActiveElement*this._indexStride),t.Stat.trianglesFaces+=n/3,t.Stat.renderBatches++,this._firstFreeElement>0&&(n=this._firstFreeElement*this._indexStride,i.drawElements(i.TRIANGLES,n,i.UNSIGNED_SHORT,0),t.Stat.trianglesFaces+=n/3,t.Stat.renderBatches++))}},{key:"play",value:function(){if(this._burstsIndex=0,this._isEmitting=!0,this._isPlaying=!0,this._isPaused=!1,this._emissionTime=0,this._totalDelayTime=0,!this.autoRandomSeed)for(var e=0,n=this._randomSeeds.length;e<n;e++)this._randomSeeds[e]=this.randomSeed[0]+hr._RANDOMOFFSET[e];switch(this.startDelayType){case 0:this._playStartDelay=this.startDelay;break;case 1:this.autoRandomSeed?this._playStartDelay=t.MathUtil.lerp(this.startDelayMin,this.startDelayMax,Math.random()):(this._rand.seed=this._randomSeeds[2],this._playStartDelay=t.MathUtil.lerp(this.startDelayMin,this.startDelayMax,this._rand.getFloat()),this._randomSeeds[2]=this._rand.seed);break;default:throw new Error("Utils3D: startDelayType is invalid.")}this._frameRateTime=this._currentTime+this._playStartDelay,this._startUpdateLoopCount=t.Stat.loopCount}},{key:"pause",value:function(){this._isPaused=!0}},{key:"simulate",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];this._simulateUpdate=!0,t?this._updateParticlesSimulationRestart(e):(this._isPaused=!1,this._updateParticles(e)),this.pause()}},{key:"stop",value:function(){this._burstsIndex=0,this._isEmitting=!1,this._emissionTime=0}},{key:"cloneTo",value:function(e){var t=e;t._useCustomBounds=this._useCustomBounds,this._customBounds&&this._customBounds.cloneTo(t._customBounds),t.duration=this.duration,t.looping=this.looping,t.prewarm=this.prewarm,t.startDelayType=this.startDelayType,t.startDelay=this.startDelay,t.startDelayMin=this.startDelayMin,t.startDelayMax=this.startDelayMax,t._maxStartLifetime=this._maxStartLifetime,t.startLifetimeType=this.startLifetimeType,t.startLifetimeConstant=this.startLifetimeConstant,this.startLifeTimeGradient.cloneTo(t.startLifeTimeGradient),t.startLifetimeConstantMin=this.startLifetimeConstantMin,t.startLifetimeConstantMax=this.startLifetimeConstantMax,this.startLifeTimeGradientMin.cloneTo(t.startLifeTimeGradientMin),this.startLifeTimeGradientMax.cloneTo(t.startLifeTimeGradientMax),t.startSpeedType=this.startSpeedType,t.startSpeedConstant=this.startSpeedConstant,t.startSpeedConstantMin=this.startSpeedConstantMin,t.startSpeedConstantMax=this.startSpeedConstantMax,t.threeDStartSize=this.threeDStartSize,t.startSizeType=this.startSizeType,t.startSizeConstant=this.startSizeConstant,this.startSizeConstantSeparate.cloneTo(t.startSizeConstantSeparate),t.startSizeConstantMin=this.startSizeConstantMin,t.startSizeConstantMax=this.startSizeConstantMax,this.startSizeConstantMinSeparate.cloneTo(t.startSizeConstantMinSeparate),this.startSizeConstantMaxSeparate.cloneTo(t.startSizeConstantMaxSeparate),t.threeDStartRotation=this.threeDStartRotation,t.startRotationType=this.startRotationType,t.startRotationConstant=this.startRotationConstant,this.startRotationConstantSeparate.cloneTo(t.startRotationConstantSeparate),t.startRotationConstantMin=this.startRotationConstantMin,t.startRotationConstantMax=this.startRotationConstantMax,this.startRotationConstantMinSeparate.cloneTo(t.startRotationConstantMinSeparate),this.startRotationConstantMaxSeparate.cloneTo(t.startRotationConstantMaxSeparate),t.randomizeRotationDirection=this.randomizeRotationDirection,t.startColorType=this.startColorType,this.startColorConstant.cloneTo(t.startColorConstant),this.startColorConstantMin.cloneTo(t.startColorConstantMin),this.startColorConstantMax.cloneTo(t.startColorConstantMax),t.gravityModifier=this.gravityModifier,t.simulationSpace=this.simulationSpace,t.scaleMode=this.scaleMode,t.playOnAwake=this.playOnAwake,t.autoRandomSeed=this.autoRandomSeed,t.randomSeed[0]=this.randomSeed[0],t.maxParticles=this.maxParticles,this._emission&&(t._emission=this._emission.clone()),this.shape&&(t.shape=this.shape.clone()),this.velocityOverLifetime&&(t.velocityOverLifetime=this.velocityOverLifetime.clone()),this.colorOverLifetime&&(t.colorOverLifetime=this.colorOverLifetime.clone()),this.sizeOverLifetime&&(t.sizeOverLifetime=this.sizeOverLifetime.clone()),this.rotationOverLifetime&&(t.rotationOverLifetime=this.rotationOverLifetime.clone()),this.textureSheetAnimation&&(t.textureSheetAnimation=this.textureSheetAnimation.clone()),t.isPerformanceMode=this.isPerformanceMode,t._isEmitting=this._isEmitting,t._isPlaying=this._isPlaying,t._isPaused=this._isPaused,t._playStartDelay=this._playStartDelay,t._frameRateTime=this._frameRateTime,t._emissionTime=this._emissionTime,t._totalDelayTime=this._totalDelayTime,t._burstsIndex=this._burstsIndex}},{key:"clone",value:function(){var e=new hr(null);return this.cloneTo(e),e}},{key:"maxParticles",get:function(){return this._bufferMaxParticles-1},set:function(e){var t=e+1;t!==this._bufferMaxParticles&&(this._bufferMaxParticles=t,this._initBufferDatas())}},{key:"emission",get:function(){return this._emission}},{key:"aliveParticleCount",get:function(){return this._firstNewElement>=this._firstRetiredElement?this._firstNewElement-this._firstRetiredElement:this._bufferMaxParticles-this._firstRetiredElement+this._firstNewElement}},{key:"emissionTime",get:function(){return this._emissionTime>this.duration?this.duration:this._emissionTime}},{key:"shape",get:function(){return this._shape},set:function(e){this._shape!==e&&(e&&e.enable?this._owner._render._shaderValues.addDefine(Oo.SHADERDEFINE_SHAPE):this._owner._render._shaderValues.removeDefine(Oo.SHADERDEFINE_SHAPE),this._shape=e)}},{key:"isAlive",get:function(){return!!(this._isPlaying||this.aliveParticleCount>0)}},{key:"isEmitting",get:function(){return this._isEmitting}},{key:"isPlaying",get:function(){return this._isPlaying}},{key:"isPaused",get:function(){return this._isPaused}},{key:"startLifetimeType",get:function(){return this._startLifetimeType},set:function(e){var t,n;switch(this.startLifetimeType){case 0:this._maxStartLifetime=this.startLifetimeConstant;break;case 1:this._maxStartLifetime=-Number.MAX_VALUE;var i=i;for(t=0,n=i.gradientCount;t<n;t++)this._maxStartLifetime=Math.max(this._maxStartLifetime,i.getValueByIndex(t));break;case 2:this._maxStartLifetime=Math.max(this.startLifetimeConstantMin,this.startLifetimeConstantMax);break;case 3:this._maxStartLifetime=-Number.MAX_VALUE;var r=r;for(t=0,n=r.gradientCount;t<n;t++)this._maxStartLifetime=Math.max(this._maxStartLifetime,r.getValueByIndex(t));var a=a;for(t=0,n=a.gradientCount;t<n;t++)this._maxStartLifetime=Math.max(this._maxStartLifetime,a.getValueByIndex(t))}this._startLifetimeType=e}},{key:"startLifetimeConstant",get:function(){return this._startLifetimeConstant},set:function(e){0===this._startLifetimeType&&(this._maxStartLifetime=e),this._startLifetimeConstant=e}},{key:"startLifeTimeGradient",get:function(){return this._startLifeTimeGradient},set:function(e){if(1===this._startLifetimeType){this._maxStartLifetime=-Number.MAX_VALUE;for(var t=0,n=e.gradientCount;t<n;t++)this._maxStartLifetime=Math.max(this._maxStartLifetime,e.getValueByIndex(t))}this._startLifeTimeGradient=e}},{key:"startLifetimeConstantMin",get:function(){return this._startLifetimeConstantMin},set:function(e){2===this._startLifetimeType&&(this._maxStartLifetime=Math.max(e,this._startLifetimeConstantMax)),this._startLifetimeConstantMin=e}},{key:"startLifetimeConstantMax",get:function(){return this._startLifetimeConstantMax},set:function(e){2===this._startLifetimeType&&(this._maxStartLifetime=Math.max(this._startLifetimeConstantMin,e)),this._startLifetimeConstantMax=e}},{key:"startLifeTimeGradientMin",get:function(){return this._startLifeTimeGradientMin},set:function(e){if(3===this._startLifetimeType){var t,n;for(this._maxStartLifetime=-Number.MAX_VALUE,t=0,n=e.gradientCount;t<n;t++)this._maxStartLifetime=Math.max(this._maxStartLifetime,e.getValueByIndex(t));for(t=0,n=this._startLifeTimeGradientMax.gradientCount;t<n;t++)this._maxStartLifetime=Math.max(this._maxStartLifetime,this._startLifeTimeGradientMax.getValueByIndex(t))}this._startLifeTimeGradientMin=e}},{key:"startLifeTimeGradientMax",get:function(){return this._startLifeTimeGradientMax},set:function(e){if(3===this._startLifetimeType){var t,n;for(this._maxStartLifetime=-Number.MAX_VALUE,t=0,n=this._startLifeTimeGradientMin.gradientCount;t<n;t++)this._maxStartLifetime=Math.max(this._maxStartLifetime,this._startLifeTimeGradientMin.getValueByIndex(t));for(t=0,n=e.gradientCount;t<n;t++)this._maxStartLifetime=Math.max(this._maxStartLifetime,e.getValueByIndex(t))}this._startLifeTimeGradientMax=e}},{key:"velocityOverLifetime",get:function(){return this._velocityOverLifetime},set:function(e){var t=this._owner._render._shaderValues;if(e){var n=e.velocity,i=n.type;if(e.enable)switch(i){case 0:t.addDefine(Oo.SHADERDEFINE_VELOCITYOVERLIFETIMECONSTANT);break;case 1:t.addDefine(Oo.SHADERDEFINE_VELOCITYOVERLIFETIMECURVE);break;case 2:t.addDefine(Oo.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCONSTANT);break;case 3:t.addDefine(Oo.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCURVE)}else t.removeDefine(Oo.SHADERDEFINE_VELOCITYOVERLIFETIMECONSTANT),t.removeDefine(Oo.SHADERDEFINE_VELOCITYOVERLIFETIMECURVE),t.removeDefine(Oo.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCONSTANT),t.removeDefine(Oo.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCURVE);switch(i){case 0:t.setVector3(Oo.VOLVELOCITYCONST,n.constant);break;case 1:t.setBuffer(Oo.VOLVELOCITYGRADIENTX,n.gradientX._elements),t.setBuffer(Oo.VOLVELOCITYGRADIENTY,n.gradientY._elements),t.setBuffer(Oo.VOLVELOCITYGRADIENTZ,n.gradientZ._elements);break;case 2:t.setVector3(Oo.VOLVELOCITYCONST,n.constantMin),t.setVector3(Oo.VOLVELOCITYCONSTMAX,n.constantMax);break;case 3:t.setBuffer(Oo.VOLVELOCITYGRADIENTX,n.gradientXMin._elements),t.setBuffer(Oo.VOLVELOCITYGRADIENTXMAX,n.gradientXMax._elements),t.setBuffer(Oo.VOLVELOCITYGRADIENTY,n.gradientYMin._elements),t.setBuffer(Oo.VOLVELOCITYGRADIENTYMAX,n.gradientYMax._elements),t.setBuffer(Oo.VOLVELOCITYGRADIENTZ,n.gradientZMin._elements),t.setBuffer(Oo.VOLVELOCITYGRADIENTZMAX,n.gradientZMax._elements)}t.setInt(Oo.VOLSPACETYPE,e.space)}else t.removeDefine(Oo.SHADERDEFINE_VELOCITYOVERLIFETIMECONSTANT),t.removeDefine(Oo.SHADERDEFINE_VELOCITYOVERLIFETIMECURVE),t.removeDefine(Oo.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCONSTANT),t.removeDefine(Oo.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCURVE);this._velocityOverLifetime=e}},{key:"colorOverLifetime",get:function(){return this._colorOverLifetime},set:function(e){var t=this._owner._render._shaderValues;if(e){var n=e.color;if(e.enable)switch(n.type){case 1:t.addDefine(Oo.SHADERDEFINE_COLOROVERLIFETIME);break;case 3:t.addDefine(Oo.SHADERDEFINE_RANDOMCOLOROVERLIFETIME)}else t.removeDefine(Oo.SHADERDEFINE_COLOROVERLIFETIME),t.removeDefine(Oo.SHADERDEFINE_RANDOMCOLOROVERLIFETIME);switch(n.type){case 1:var i=n.gradient;t.setBuffer(Oo.COLOROVERLIFEGRADIENTALPHAS,i._alphaElements),t.setBuffer(Oo.COLOROVERLIFEGRADIENTCOLORS,i._rgbElements);break;case 3:var r=n.gradientMin,a=n.gradientMax;t.setBuffer(Oo.COLOROVERLIFEGRADIENTALPHAS,r._alphaElements),t.setBuffer(Oo.COLOROVERLIFEGRADIENTCOLORS,r._rgbElements),t.setBuffer(Oo.MAXCOLOROVERLIFEGRADIENTALPHAS,a._alphaElements),t.setBuffer(Oo.MAXCOLOROVERLIFEGRADIENTCOLORS,a._rgbElements)}}else t.removeDefine(Oo.SHADERDEFINE_COLOROVERLIFETIME),t.removeDefine(Oo.SHADERDEFINE_RANDOMCOLOROVERLIFETIME),t.setBuffer(Oo.COLOROVERLIFEGRADIENTALPHAS,i._alphaElements),t.setBuffer(Oo.COLOROVERLIFEGRADIENTCOLORS,i._rgbElements),t.setBuffer(Oo.COLOROVERLIFEGRADIENTALPHAS,r._alphaElements),t.setBuffer(Oo.COLOROVERLIFEGRADIENTCOLORS,r._rgbElements),t.setBuffer(Oo.MAXCOLOROVERLIFEGRADIENTALPHAS,a._alphaElements),t.setBuffer(Oo.MAXCOLOROVERLIFEGRADIENTCOLORS,a._rgbElements);this._colorOverLifetime=e}},{key:"sizeOverLifetime",get:function(){return this._sizeOverLifetime},set:function(e){var t=this._owner._render._shaderValues;if(e){var n=e.size,i=n.separateAxes,r=n.type;if(e.enable)switch(r){case 0:i?t.addDefine(Oo.SHADERDEFINE_SIZEOVERLIFETIMECURVESEPERATE):t.addDefine(Oo.SHADERDEFINE_SIZEOVERLIFETIMECURVE);break;case 2:i?t.addDefine(Oo.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVESSEPERATE):t.addDefine(Oo.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVES)}else t.removeDefine(Oo.SHADERDEFINE_SIZEOVERLIFETIMECURVE),t.removeDefine(Oo.SHADERDEFINE_SIZEOVERLIFETIMECURVESEPERATE),t.removeDefine(Oo.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVES),t.removeDefine(Oo.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVESSEPERATE);switch(r){case 0:i?(t.setBuffer(Oo.SOLSIZEGRADIENTX,n.gradientX._elements),t.setBuffer(Oo.SOLSIZEGRADIENTY,n.gradientY._elements),t.setBuffer(Oo.SOLSizeGradientZ,n.gradientZ._elements)):t.setBuffer(Oo.SOLSIZEGRADIENT,n.gradient._elements);break;case 2:i?(t.setBuffer(Oo.SOLSIZEGRADIENTX,n.gradientXMin._elements),t.setBuffer(Oo.SOLSIZEGRADIENTXMAX,n.gradientXMax._elements),t.setBuffer(Oo.SOLSIZEGRADIENTY,n.gradientYMin._elements),t.setBuffer(Oo.SOLSIZEGRADIENTYMAX,n.gradientYMax._elements),t.setBuffer(Oo.SOLSizeGradientZ,n.gradientZMin._elements),t.setBuffer(Oo.SOLSizeGradientZMAX,n.gradientZMax._elements)):(t.setBuffer(Oo.SOLSIZEGRADIENT,n.gradientMin._elements),t.setBuffer(Oo.SOLSizeGradientMax,n.gradientMax._elements))}}else t.removeDefine(Oo.SHADERDEFINE_SIZEOVERLIFETIMECURVE),t.removeDefine(Oo.SHADERDEFINE_SIZEOVERLIFETIMECURVESEPERATE),t.removeDefine(Oo.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVES),t.removeDefine(Oo.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVESSEPERATE);this._sizeOverLifetime=e}},{key:"rotationOverLifetime",get:function(){return this._rotationOverLifetime},set:function(e){var t=this._owner._render._shaderValues;if(e){var n=e.angularVelocity;if(!n)return;var i=n.separateAxes,r=n.type;if(e.enable)switch(i?t.addDefine(Oo.SHADERDEFINE_ROTATIONOVERLIFETIMESEPERATE):t.addDefine(Oo.SHADERDEFINE_ROTATIONOVERLIFETIME),r){case 0:t.addDefine(Oo.SHADERDEFINE_ROTATIONOVERLIFETIMECONSTANT);break;case 1:t.addDefine(Oo.SHADERDEFINE_ROTATIONOVERLIFETIMECURVE);break;case 2:t.addDefine(Oo.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCONSTANTS);break;case 3:t.addDefine(Oo.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCURVES)}else t.removeDefine(Oo.SHADERDEFINE_ROTATIONOVERLIFETIME),t.removeDefine(Oo.SHADERDEFINE_ROTATIONOVERLIFETIMESEPERATE),t.removeDefine(Oo.SHADERDEFINE_ROTATIONOVERLIFETIMECONSTANT),t.removeDefine(Oo.SHADERDEFINE_ROTATIONOVERLIFETIMECURVE),t.removeDefine(Oo.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCONSTANTS),t.removeDefine(Oo.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCURVES);switch(r){case 0:i?t.setVector3(Oo.ROLANGULARVELOCITYCONSTSEPRARATE,n.constantSeparate):t.setNumber(Oo.ROLANGULARVELOCITYCONST,n.constant);break;case 1:i?(t.setBuffer(Oo.ROLANGULARVELOCITYGRADIENTX,n.gradientX._elements),t.setBuffer(Oo.ROLANGULARVELOCITYGRADIENTY,n.gradientY._elements),t.setBuffer(Oo.ROLANGULARVELOCITYGRADIENTZ,n.gradientZ._elements)):t.setBuffer(Oo.ROLANGULARVELOCITYGRADIENT,n.gradient._elements);break;case 2:i?(t.setVector3(Oo.ROLANGULARVELOCITYCONSTSEPRARATE,n.constantMinSeparate),t.setVector3(Oo.ROLANGULARVELOCITYCONSTMAXSEPRARATE,n.constantMaxSeparate)):(t.setNumber(Oo.ROLANGULARVELOCITYCONST,n.constantMin),t.setNumber(Oo.ROLANGULARVELOCITYCONSTMAX,n.constantMax));break;case 3:i?(t.setBuffer(Oo.ROLANGULARVELOCITYGRADIENTX,n.gradientXMin._elements),t.setBuffer(Oo.ROLANGULARVELOCITYGRADIENTXMAX,n.gradientXMax._elements),t.setBuffer(Oo.ROLANGULARVELOCITYGRADIENTY,n.gradientYMin._elements),t.setBuffer(Oo.ROLANGULARVELOCITYGRADIENTYMAX,n.gradientYMax._elements),t.setBuffer(Oo.ROLANGULARVELOCITYGRADIENTZ,n.gradientZMin._elements),t.setBuffer(Oo.ROLANGULARVELOCITYGRADIENTZMAX,n.gradientZMax._elements)):(t.setBuffer(Oo.ROLANGULARVELOCITYGRADIENT,n.gradientMin._elements),t.setBuffer(Oo.ROLANGULARVELOCITYGRADIENTMAX,n.gradientMax._elements))}}else t.removeDefine(Oo.SHADERDEFINE_ROTATIONOVERLIFETIME),t.removeDefine(Oo.SHADERDEFINE_ROTATIONOVERLIFETIMESEPERATE),t.removeDefine(Oo.SHADERDEFINE_ROTATIONOVERLIFETIMECONSTANT),t.removeDefine(Oo.SHADERDEFINE_ROTATIONOVERLIFETIMECURVE),t.removeDefine(Oo.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCONSTANTS),t.removeDefine(Oo.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCURVES);this._rotationOverLifetime=e}},{key:"textureSheetAnimation",get:function(){return this._textureSheetAnimation},set:function(e){var t=this._owner._render._shaderValues;if(e){var n=e.frame,i=n.type;if(e.enable)switch(i){case 1:t.addDefine(Oo.SHADERDEFINE_TEXTURESHEETANIMATIONCURVE);break;case 3:t.addDefine(Oo.SHADERDEFINE_TEXTURESHEETANIMATIONRANDOMCURVE)}else t.removeDefine(Oo.SHADERDEFINE_TEXTURESHEETANIMATIONCURVE),t.removeDefine(Oo.SHADERDEFINE_TEXTURESHEETANIMATIONRANDOMCURVE);if(1===i||3===i){t.setNumber(Oo.TEXTURESHEETANIMATIONCYCLES,e.cycles);var r=e.tiles,a=this._uvLength;a.x=1/r.x,a.y=1/r.y,t.setVector2(Oo.TEXTURESHEETANIMATIONSUBUVLENGTH,this._uvLength)}switch(i){case 1:t.setBuffer(Oo.TEXTURESHEETANIMATIONGRADIENTUVS,n.frameOverTimeData._elements);break;case 3:t.setBuffer(Oo.TEXTURESHEETANIMATIONGRADIENTUVS,n.frameOverTimeDataMin._elements),t.setBuffer(Oo.TEXTURESHEETANIMATIONGRADIENTMAXUVS,n.frameOverTimeDataMax._elements)}}else t.removeDefine(Oo.SHADERDEFINE_TEXTURESHEETANIMATIONCURVE),t.removeDefine(Oo.SHADERDEFINE_TEXTURESHEETANIMATIONRANDOMCURVE);this._textureSheetAnimation=e}},{key:"customBounds",get:function(){return this._customBounds},set:function(e){this._useCustomBounds=!!e,this._customBounds=e}}]),hr}();Uo._RANDOMOFFSET=new Uint32Array([592910910,3276756734,322376503,306581307,1793934638,3737431713,2527743459,2368504881,4085612399,3774601268,326370691,1494990940,1089181156,3159510623,2941263940,2786374529,271901988,4233252447]),Uo.halfKSqrtOf2=.71,Uo.g=9.8,Uo._maxElapsedTime=1/3,Uo._tempVector30=new D,Uo._tempVector31=new D,Uo._tempVector32=new D,Uo._tempVector33=new D,Uo._tempVector34=new D,Uo._tempVector35=new D,Uo._tempVector36=new D,Uo._tempVector37=new D,Uo._tempPosition=new D,Uo._tempDirection=new D,Uo._type=Ea._typeCounter++;var Go=function(e){function _r(){var e;_classCallCheck(this,_r),(e=_possibleConstructorReturn(this,_getPrototypeOf(_r).call(this,null)))._render=new Po(_assertThisInitialized(e)),e._particleSystem=new Uo(_assertThisInitialized(e));var t=e._render._renderElements[0]=new ci;return t.setTransform(e._transform),t.render=e._render,t.setGeometry(e._particleSystem),t.material=No.defaultMaterial,e}return _inherits(_r,ya),_createClass(_r,[{key:"_parseModule",value:function(e,n){for(var i in n)switch(i){case"bases":var r=n.bases;for(var a in r)e[a]=r[a];break;case"vector2s":var o=n.vector2s;for(var a in o){var s=e[a],l=o[a];s.setValue(l[0],l[1]),e[a]=s}break;case"vector3s":var u=n.vector3s;for(var a in u){var _=e[a],c=u[a];_.setValue(c[0],c[1],c[2]),e[a]=_}break;case"vector4s":var h=n.vector4s;for(var a in h){var d=e[a],f=h[a];d.setValue(f[0],f[1],f[2],f[3]),e[a]=d}break;case"gradientDataNumbers":var m=n.gradientDataNumbers;for(var a in m){for(var p=e[a],v=n[a],E=0,T=v.length;E<T;E++){var g=v[E];p.add(g.key,g.value)}e[a]=p}break;case"resources":var y=n.resources;for(var a in y)e[a]=t.Loader.getRes(y[a]);break;case"bursts":var S=n.bursts;for(E=0,T=S.length;E<T;E++){var R=S[E];e.addBurst(new uo(R.time,R.min,R.max))}break;case"randomSeed":e.randomSeed[0]=n.randomSeed;break;case"shapeType":case"type":case"color":case"size":case"frame":case"startFrame":case"angularVelocity":case"velocity":break;default:throw"ShurikenParticle3D:unknown type."}}},{key:"_parse",value:function(e,t){if(_get(_getPrototypeOf(_r.prototype),"_parse",this).call(this,e,t),e.main){var n=this.particleSystem,i=this.particleRenderer;this._parseModule(i,e.renderer),this._parseModule(n,e.main),this._parseModule(n.emission,e.emission);var r=e.shape;if(r){var a;switch(r.shapeType){case 0:a=new Io;break;case 1:a=new Ao;break;case 2:a=new Co;break;case 3:a=new So;break;case 7:a=new Ro;break;default:throw"ShuriKenParticle3D:unknown shape type."}this._parseModule(a,r),n.shape=a}var s=e.velocityOverLifetime;if(s){var l,u=s.velocity;switch(u.type){case 0:var _=u.constant;l=Eo.createByConstant(_?new D(_[0],_[1],_[2]):new D(0,0,0));break;case 1:l=Eo.createByGradient(this._initParticleVelocity(u.gradientX),this._initParticleVelocity(u.gradientY),this._initParticleVelocity(u.gradientZ));break;case 2:var c=u.constantMin,h=u.constantMax;l=Eo.createByRandomTwoConstant(c?new D(c[0],c[1],c[2]):new D(0,0,0),h?new D(h[0],h[1],h[2]):new D(0,0,0));break;case 3:l=Eo.createByRandomTwoGradient(this._initParticleVelocity(u.gradientXMin),this._initParticleVelocity(u.gradientXMax),this._initParticleVelocity(u.gradientYMin),this._initParticleVelocity(u.gradientYMax),this._initParticleVelocity(u.gradientZMin),this._initParticleVelocity(u.gradientZMax))}var d=new Lo(l);this._parseModule(d,s),n.velocityOverLifetime=d}var f=e.colorOverLifetime;if(f){var m,p=f.color;switch(p.type){case 0:var v=p.constant;m=_o.createByConstant(v?new o(v[0],v[1],v[2],v[3]):new o(0,0,0,0));break;case 1:m=_o.createByGradient(this._initParticleColor(p.gradient));break;case 2:var E=p.constantMin,T=p.constantMax;m=_o.createByRandomTwoConstant(E?new o(E[0],E[1],E[2],E[3]):new o(0,0,0,0),E?new o(T[0],T[1],T[2],T[3]):new o(0,0,0,0));break;case 3:m=_o.createByRandomTwoGradient(this._initParticleColor(p.gradientMin),this._initParticleColor(p.gradientMax))}var g=new co(m);this._parseModule(g,f),n.colorOverLifetime=g}var y=e.sizeOverLifetime;if(y){var S,R=y.size;switch(R.type){case 0:S=R.separateAxes?vo.createByGradientSeparate(this._initParticleSize(R.gradientX),this._initParticleSize(R.gradientY),this._initParticleSize(R.gradientZ)):vo.createByGradient(this._initParticleSize(R.gradient));break;case 1:if(R.separateAxes){var C=R.constantMinSeparate,A=R.constantMaxSeparate;S=vo.createByRandomTwoConstantSeparate(C?new D(C[0],C[1],C[2]):new D(0,0,0),A?new D(A[0],A[1],A[2]):new D(0,0,0))}else S=vo.createByRandomTwoConstant(R.constantMin||0,R.constantMax||0);break;case 2:S=R.separateAxes?vo.createByRandomTwoGradientSeparate(this._initParticleSize(R.gradientXMin),this._initParticleSize(R.gradientYMin),this._initParticleSize(R.gradientZMin),this._initParticleSize(R.gradientXMax),this._initParticleSize(R.gradientYMax),this._initParticleSize(R.gradientZMax)):vo.createByRandomTwoGradient(this._initParticleSize(R.gradientMin),this._initParticleSize(R.gradientMax))}var I=new xo(S);this._parseModule(I,y),n.sizeOverLifetime=I}var x=e.rotationOverLifetime;if(x){var M,L=x.angularVelocity;switch(L.type){case 0:if(L.separateAxes){var O=L.constantSeparate;M=fo.createByConstantSeparate(O?new D(O[0],O[1],O[2]):new D(0,0,Math.PI/4))}else M=fo.createByConstant(L.constant||Math.PI/4);break;case 1:M=L.separateAxes?fo.createByGradientSeparate(this._initParticleRotation(L.gradientX),this._initParticleRotation(L.gradientY),this._initParticleRotation(L.gradientZ)):fo.createByGradient(this._initParticleRotation(L.gradient));break;case 2:if(L.separateAxes){var N=L.constantMinSeparate,P=L.constantMaxSeparate;M=fo.createByRandomTwoConstantSeparate(N?new D(N[0],N[1],N[2]):new D(0,0,0),P?new D(P[0],P[1],P[2]):new D(0,0,Math.PI/4))}else M=fo.createByRandomTwoConstant(L.constantMin||0,L.constantMax||Math.PI/4);break;case 3:L.separateAxes||(M=fo.createByRandomTwoGradient(this._initParticleRotation(L.gradientMin),this._initParticleRotation(L.gradientMax)))}var b=new To(M);this._parseModule(b,x),n.rotationOverLifetime=b}var w=e.textureSheetAnimation;if(w){var k,V=w.frame;switch(V.type){case 0:k=ho.createByConstant(V.constant);break;case 1:k=ho.createByOverTime(this._initParticleFrame(V.overTime));break;case 2:k=ho.createByRandomTwoConstant(V.constantMin,V.constantMax);break;case 3:k=ho.createByRandomTwoOverTime(this._initParticleFrame(V.overTimeMin),this._initParticleFrame(V.overTimeMax))}var B,F=w.startFrame;switch(F.type){case 0:B=Do.createByConstant(F.constant);break;case 1:B=Do.createByRandomTwoConstant(F.constantMin,F.constantMax)}var U=new Mo(k,B);this._parseModule(U,w),n.textureSheetAnimation=U}}else this._parseOld(e)}},{key:"_activeHierarchy",value:function(e){_get(_getPrototypeOf(_r.prototype),"_activeHierarchy",this).call(this,e),this.particleSystem.playOnAwake&&this.particleSystem.play()}},{key:"_inActiveHierarchy",value:function(e){_get(_getPrototypeOf(_r.prototype),"_inActiveHierarchy",this).call(this,e),this.particleSystem.isAlive&&this.particleSystem.simulate(0,!0)}},{key:"_cloneTo",value:function(e,t,n){var i=e,r=i._particleSystem;this._particleSystem.cloneTo(r);var a=i._render,o=this._render;a.sharedMaterials=o.sharedMaterials,a.enable=o.enable,a.renderMode=o.renderMode,a.mesh=o.mesh,a.stretchedBillboardCameraSpeedScale=o.stretchedBillboardCameraSpeedScale,a.stretchedBillboardSpeedScale=o.stretchedBillboardSpeedScale,a.stretchedBillboardLengthScale=o.stretchedBillboardLengthScale,a.sortingFudge=o.sortingFudge,_get(_getPrototypeOf(_r.prototype),"_cloneTo",this).call(this,e,t,n)}},{key:"destroy",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];this.destroyed||(_get(_getPrototypeOf(_r.prototype),"destroy",this).call(this,e),this._particleSystem.destroy(),this._particleSystem=null)}},{key:"_create",value:function(){return new _r}},{key:"_parseOld",value:function(e){var n,i,a,s=Math.PI/180,l=this.particleRenderer,u=e.material;u&&(a=t.Loader.getRes(u.path)),l.sharedMaterial=a;var _=e.meshPath;_&&(l.mesh=t.Loader.getRes(_)),l.renderMode=e.renderMode,l.stretchedBillboardCameraSpeedScale=e.stretchedBillboardCameraSpeedScale,l.stretchedBillboardSpeedScale=e.stretchedBillboardSpeedScale,l.stretchedBillboardLengthScale=e.stretchedBillboardLengthScale,l.sortingFudge=e.sortingFudge?e.sortingFudge:0;var c=this.particleSystem;c.isPerformanceMode=e.isPerformanceMode,c.duration=e.duration,c.looping=e.looping,c.prewarm=e.prewarm,c.startDelayType=e.startDelayType,c.startDelay=e.startDelay,c.startDelayMin=e.startDelayMin,c.startDelayMax=e.startDelayMax,c.startLifetimeType=e.startLifetimeType,c.startLifetimeConstant=e.startLifetimeConstant,c.startLifeTimeGradient=_r._initStartLife(e.startLifetimeGradient),c.startLifetimeConstantMin=e.startLifetimeConstantMin,c.startLifetimeConstantMax=e.startLifetimeConstantMax,c.startLifeTimeGradientMin=_r._initStartLife(e.startLifetimeGradientMin),c.startLifeTimeGradientMax=_r._initStartLife(e.startLifetimeGradientMax),c.startSpeedType=e.startSpeedType,c.startSpeedConstant=e.startSpeedConstant,c.startSpeedConstantMin=e.startSpeedConstantMin,c.startSpeedConstantMax=e.startSpeedConstantMax,c.threeDStartSize=e.threeDStartSize,c.startSizeType=e.startSizeType,c.startSizeConstant=e.startSizeConstant;var h=e.startSizeConstantSeparate,d=c.startSizeConstantSeparate;d.x=h[0],d.y=h[1],d.z=h[2],c.startSizeConstantMin=e.startSizeConstantMin,c.startSizeConstantMax=e.startSizeConstantMax;var f=e.startSizeConstantMinSeparate,m=c.startSizeConstantMinSeparate;m.x=f[0],m.y=f[1],m.z=f[2];var p=e.startSizeConstantMaxSeparate,v=c.startSizeConstantMaxSeparate;v.x=p[0],v.y=p[1],v.z=p[2],c.threeDStartRotation=e.threeDStartRotation,c.startRotationType=e.startRotationType,c.startRotationConstant=e.startRotationConstant*s;var E=e.startRotationConstantSeparate,T=c.startRotationConstantSeparate;T.x=E[0]*s,T.y=E[1]*s,T.z=E[2]*s,c.startRotationConstantMin=e.startRotationConstantMin*s,c.startRotationConstantMax=e.startRotationConstantMax*s;var g=e.startRotationConstantMinSeparate,y=c.startRotationConstantMinSeparate;y.x=g[0]*s,y.y=g[1]*s,y.z=g[2]*s;var S=e.startRotationConstantMaxSeparate,R=c.startRotationConstantMaxSeparate;R.x=S[0]*s,R.y=S[1]*s,R.z=S[2]*s,c.randomizeRotationDirection=e.randomizeRotationDirection,c.startColorType=e.startColorType;var C=e.startColorConstant,A=c.startColorConstant;A.x=C[0],A.y=C[1],A.z=C[2],A.w=C[3];var I=e.startColorConstantMin,x=c.startColorConstantMin;x.x=I[0],x.y=I[1],x.z=I[2],x.w=I[3];var M=e.startColorConstantMax,L=c.startColorConstantMax;L.x=M[0],L.y=M[1],L.z=M[2],L.w=M[3],c.gravityModifier=e.gravityModifier,c.simulationSpace=e.simulationSpace,void 0!==e.simulationSpeed&&(c.simulationSpeed=e.simulationSpeed),c.scaleMode=e.scaleMode,c.playOnAwake=e.playOnAwake,c.maxParticles=e.maxParticles;var O=e.autoRandomSeed;null!=O&&(c.autoRandomSeed=O);var N=e.randomSeed;null!=N&&(c.randomSeed[0]=N);var P=e.emission,b=c.emission;if(P){b.emissionRate=P.emissionRate;var w=P.bursts;if(w)for(n=0,i=w.length;n<i;n++){var k=w[n];b.addBurst(new uo(k.time,k.min,k.max))}b.enable=P.enable}else b.enable=!1;var V=e.shape;if(V){var B;switch(V.shapeType){case 0:var F;B=F=new Io,F.radius=V.sphereRadius,F.emitFromShell=V.sphereEmitFromShell,F.randomDirection=V.sphereRandomDirection;break;case 1:var U;B=U=new Ao,U.radius=V.hemiSphereRadius,U.emitFromShell=V.hemiSphereEmitFromShell,U.randomDirection=V.hemiSphereRandomDirection;break;case 2:var G;B=G=new Co,G.angle=V.coneAngle*s,G.radius=V.coneRadius,G.length=V.coneLength,G.emitType=V.coneEmitType,G.randomDirection=V.coneRandomDirection;break;case 3:var H;B=H=new So,H.x=V.boxX,H.y=V.boxY,H.z=V.boxZ,H.randomDirection=V.boxRandomDirection;break;case 7:var z;B=z=new Ro,z.radius=V.circleRadius,z.arc=V.circleArc*s,z.emitFromEdge=V.circleEmitFromEdge,z.randomDirection=V.circleRandomDirection;break;default:var W;B=W=new Ro,W.radius=V.circleRadius,W.arc=V.circleArc*s,W.emitFromEdge=V.circleEmitFromEdge,W.randomDirection=V.circleRandomDirection}B.enable=V.enable,c.shape=B}var X=e.velocityOverLifetime;if(X){var Y,j=X.velocity;switch(j.type){case 0:var Z=j.constant;Y=Eo.createByConstant(new D(Z[0],Z[1],Z[2]));break;case 1:Y=Eo.createByGradient(this._initParticleVelocity(j.gradientX),this._initParticleVelocity(j.gradientY),this._initParticleVelocity(j.gradientZ));break;case 2:var q=j.constantMin,Q=j.constantMax;Y=Eo.createByRandomTwoConstant(new D(q[0],q[1],q[2]),new D(Q[0],Q[1],Q[2]));break;case 3:Y=Eo.createByRandomTwoGradient(this._initParticleVelocity(j.gradientXMin),this._initParticleVelocity(j.gradientXMax),this._initParticleVelocity(j.gradientYMin),this._initParticleVelocity(j.gradientYMax),this._initParticleVelocity(j.gradientZMin),this._initParticleVelocity(j.gradientZMax))}var K=new Lo(Y);K.space=X.space,K.enable=X.enable,c.velocityOverLifetime=K}var J=e.colorOverLifetime;if(J){var $,ee=J.color;switch(ee.type){case 0:var te=ee.constant;$=_o.createByConstant(new o(te[0],te[1],te[2],te[3]));break;case 1:$=_o.createByGradient(this._initParticleColor(ee.gradient));break;case 2:var ne=ee.constantMin,ie=ee.constantMax;$=_o.createByRandomTwoConstant(new o(ne[0],ne[1],ne[2],ne[3]),new o(ie[0],ie[1],ie[2],ie[3]));break;case 3:$=_o.createByRandomTwoGradient(this._initParticleColor(ee.gradientMin),this._initParticleColor(ee.gradientMax))}var re=new co($);re.enable=J.enable,c.colorOverLifetime=re}var ae=e.sizeOverLifetime;if(ae){var oe,se=ae.size;switch(se.type){case 0:oe=se.separateAxes?vo.createByGradientSeparate(this._initParticleSize(se.gradientX),this._initParticleSize(se.gradientY),this._initParticleSize(se.gradientZ)):vo.createByGradient(this._initParticleSize(se.gradient));break;case 1:if(se.separateAxes){var le=se.constantMinSeparate,ue=se.constantMaxSeparate;oe=vo.createByRandomTwoConstantSeparate(new D(le[0],le[1],le[2]),new D(ue[0],ue[1],ue[2]))}else oe=vo.createByRandomTwoConstant(se.constantMin,se.constantMax);break;case 2:oe=se.separateAxes?vo.createByRandomTwoGradientSeparate(this._initParticleSize(se.gradientXMin),this._initParticleSize(se.gradientYMin),this._initParticleSize(se.gradientZMin),this._initParticleSize(se.gradientXMax),this._initParticleSize(se.gradientYMax),this._initParticleSize(se.gradientZMax)):vo.createByRandomTwoGradient(this._initParticleSize(se.gradientMin),this._initParticleSize(se.gradientMax))}var _e=new xo(oe);_e.enable=ae.enable,c.sizeOverLifetime=_e}var ce=e.rotationOverLifetime;if(ce){var he,de=ce.angularVelocity;switch(de.type){case 0:if(de.separateAxes){var fe=de.constantSeparate;he=fo.createByConstantSeparate(new D(fe[0]*s,fe[1]*s,fe[2]*s))}else he=fo.createByConstant(de.constant*s);break;case 1:he=de.separateAxes?fo.createByGradientSeparate(this._initParticleRotation(de.gradientX),this._initParticleRotation(de.gradientY),this._initParticleRotation(de.gradientZ)):fo.createByGradient(this._initParticleRotation(de.gradient));break;case 2:if(de.separateAxes){var me=de.constantMinSeparate,pe=de.constantMaxSeparate;he=fo.createByRandomTwoConstantSeparate(new D(me[0]*s,me[1]*s,me[2]*s),new D(pe[0]*s,pe[1]*s,pe[2]*s))}else he=fo.createByRandomTwoConstant(de.constantMin*s,de.constantMax*s);break;case 3:de.separateAxes||(he=fo.createByRandomTwoGradient(this._initParticleRotation(de.gradientMin),this._initParticleRotation(de.gradientMax)))}var ve=new To(he);ve.enable=ce.enable,c.rotationOverLifetime=ve}var Ee=e.textureSheetAnimation;if(Ee){var Te,ge=Ee.frame;switch(ge.type){case 0:Te=ho.createByConstant(ge.constant);break;case 1:Te=ho.createByOverTime(this._initParticleFrame(ge.overTime));break;case 2:Te=ho.createByRandomTwoConstant(ge.constantMin,ge.constantMax);break;case 3:Te=ho.createByRandomTwoOverTime(this._initParticleFrame(ge.overTimeMin),this._initParticleFrame(ge.overTimeMax))}var ye,Se=Ee.startFrame;switch(Se.type){case 0:ye=Do.createByConstant(Se.constant);break;case 1:ye=Do.createByRandomTwoConstant(Se.constantMin,Se.constantMax)}var Re=new Mo(Te,ye);Re.enable=Ee.enable;var Ce=Ee.tiles;Re.tiles=new r(Ce[0],Ce[1]),Re.type=Ee.type,Re.randomRow=Ee.randomRow;var Ae=Ee.rowIndex;void 0!==Ae&&(Re.rowIndex=Ae),Re.cycles=Ee.cycles,c.textureSheetAnimation=Re}}},{key:"_initParticleColor",value:function(e){var t=new lo(4,4);if(e){var n,i,r=e.alphas;if(r)for(n=0,i=r.length;n<i;n++){3==n&&i>4&&(n=i-1,console.warn("GradientDataColor warning:alpha data length is large than 4, will ignore the middle data."));var a=r[n];t.addColorAlpha(a.key,a.value)}else t.addColorAlpha(0,1),t.addColorAlpha(1,1);var o=e.rgbs;if(o)for(n=0,i=o.length;n<i;n++){3==n&&i>4&&(n=i-1,console.warn("GradientDataColor warning:rgb data length is large than 4, will ignore the middle data."));var s=o[n],l=s.value;t.addColorRGB(s.key,new ta(l[0],l[1],l[2],1))}else t.addColorRGB(0,new ta(1,1,1,1)),t.addColorRGB(1,new ta(1,1,1,1))}else t.addColorAlpha(0,1),t.addColorAlpha(1,1),t.addColorRGB(0,new ta(1,1,1,1)),t.addColorRGB(1,new ta(1,1,1,1));return t}},{key:"_initParticleFrame",value:function(e){var t=new mo;if(e)for(var n=e.frames,i=0,r=n.length;i<r;i++){var a=n[i];t.add(a.key,a.value)}else t.add(0,0),t.add(1,1);return t}},{key:"_initParticleVelocity",value:function(e){for(var t=new po,n=e.velocitys,i=0,r=n.length;i<r;i++){var a=n[i];t.add(a.key,a.value)}return t}},{key:"_initParticleSize",value:function(e){var t=new po;if(e)for(var n=e.sizes,i=0,r=n.length;i<r;i++){var a=n[i];t.add(a.key,a.value)}else t.add(0,0),t.add(1,1);return t}},{key:"_initParticleRotation",value:function(e){for(var t=new po,n=e.angularVelocitys,i=0,r=n.length;i<r;i++){var a=n[i];t.add(a.key,a.value/180*Math.PI)}return t}},{key:"particleSystem",get:function(){return this._particleSystem}},{key:"particleRenderer",get:function(){return this._render}}],[{key:"__init__",value:function(){Oo.SHADERDEFINE_RENDERMODE_BILLBOARD=xn.getDefineByName("SPHERHBILLBOARD"),Oo.SHADERDEFINE_RENDERMODE_STRETCHEDBILLBOARD=xn.getDefineByName("STRETCHEDBILLBOARD"),Oo.SHADERDEFINE_RENDERMODE_HORIZONTALBILLBOARD=xn.getDefineByName("HORIZONTALBILLBOARD"),Oo.SHADERDEFINE_RENDERMODE_VERTICALBILLBOARD=xn.getDefineByName("VERTICALBILLBOARD"),Oo.SHADERDEFINE_COLOROVERLIFETIME=xn.getDefineByName("COLOROVERLIFETIME"),Oo.SHADERDEFINE_RANDOMCOLOROVERLIFETIME=xn.getDefineByName("RANDOMCOLOROVERLIFETIME"),Oo.SHADERDEFINE_VELOCITYOVERLIFETIMECONSTANT=xn.getDefineByName("VELOCITYOVERLIFETIMECONSTANT"),Oo.SHADERDEFINE_VELOCITYOVERLIFETIMECURVE=xn.getDefineByName("VELOCITYOVERLIFETIMECURVE"),Oo.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCONSTANT=xn.getDefineByName("VELOCITYOVERLIFETIMERANDOMCONSTANT"),Oo.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCURVE=xn.getDefineByName("VELOCITYOVERLIFETIMERANDOMCURVE"),Oo.SHADERDEFINE_TEXTURESHEETANIMATIONCURVE=xn.getDefineByName("TEXTURESHEETANIMATIONCURVE"),Oo.SHADERDEFINE_TEXTURESHEETANIMATIONRANDOMCURVE=xn.getDefineByName("TEXTURESHEETANIMATIONRANDOMCURVE"),Oo.SHADERDEFINE_ROTATIONOVERLIFETIME=xn.getDefineByName("ROTATIONOVERLIFETIME"),Oo.SHADERDEFINE_ROTATIONOVERLIFETIMESEPERATE=xn.getDefineByName("ROTATIONOVERLIFETIMESEPERATE"),Oo.SHADERDEFINE_ROTATIONOVERLIFETIMECONSTANT=xn.getDefineByName("ROTATIONOVERLIFETIMECONSTANT"),Oo.SHADERDEFINE_ROTATIONOVERLIFETIMECURVE=xn.getDefineByName("ROTATIONOVERLIFETIMECURVE"),Oo.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCONSTANTS=xn.getDefineByName("ROTATIONOVERLIFETIMERANDOMCONSTANTS"),Oo.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCURVES=xn.getDefineByName("ROTATIONOVERLIFETIMERANDOMCURVES"),Oo.SHADERDEFINE_SIZEOVERLIFETIMECURVE=xn.getDefineByName("SIZEOVERLIFETIMECURVE"),Oo.SHADERDEFINE_SIZEOVERLIFETIMECURVESEPERATE=xn.getDefineByName("SIZEOVERLIFETIMECURVESEPERATE"),Oo.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVES=xn.getDefineByName("SIZEOVERLIFETIMERANDOMCURVES"),Oo.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVESSEPERATE=xn.getDefineByName("SIZEOVERLIFETIMERANDOMCURVESSEPERATE"),Oo.SHADERDEFINE_RENDERMODE_MESH=xn.getDefineByName("RENDERMODE_MESH"),Oo.SHADERDEFINE_SHAPE=xn.getDefineByName("SHAPE")}},{key:"_initStartLife",value:function(e){for(var t=new po,n=e.startLifetimes,i=0,r=n.length;i<r;i++){var a=n[i];t.add(a.key,a.value)}return t}}]),_r}(),Ho=function cr(){_classCallCheck(this,cr)},zo=function(n){function dr(e){var t;return _classCallCheck(this,dr),(t=_possibleConstructorReturn(this,_getPrototypeOf(dr).call(this,e)))._bones=[],t._skinnedDataLoopMarks=[],t._localBounds=new va(D._ZERO,D._ZERO),t._cacheAnimationNode=[],t}return _inherits(dr,no),_createClass(dr,[{key:"_computeSkinnedData",value:function(){if(this._cacheMesh&&this._cacheAvatar||this._cacheMesh&&!this._cacheAvatar)for(var e=this._cacheMesh._inverseBindPoses,t=this._cacheMesh._skinnedMatrixCaches,n=0,i=this._cacheMesh.subMeshCount;n<i;n++)for(var r=this._cacheMesh.getSubMesh(n)._boneIndicesList,a=this._skinnedData[n],o=0,s=r.length;o<s;o++){var l=r[o];this._computeSubSkinnedData(e,l,a[o],t)}}},{key:"_computeSubSkinnedData",value:function(e,n,i,r){for(var a=0,o=n.length;a<o;a++){var s=n[a];if(this._skinnedDataLoopMarks[s]===t.Stat.loopCount)for(var l=r[s],u=this._skinnedData[l.subMeshIndex][l.batchIndex],_=16*l.batchBoneIndex,c=16*a,h=0;h<16;h++)i[c+h]=u[_+h];else this._cacheAvatar?gt._mulMatrixArray(this._cacheAnimationNode[s].transform.getWorldMatrix(),e[s].elements,0,i,16*a):gt._mulMatrixArray(this._bones[s].transform.worldMatrix.elements,e[s].elements,0,i,16*a),this._skinnedDataLoopMarks[s]=t.Stat.loopCount}}},{key:"_onWorldMatNeedChange",value:function(e){this._boundsChange=!0,this._octreeNode&&(this._cacheAvatar?-1===this._indexInOctreeMotionList&&this._octreeNode._octree.addMotionObject(this):(e&=oe.TRANSFORM_WORLDPOSITION|oe.TRANSFORM_WORLDQUATERNION|oe.TRANSFORM_WORLDSCALE)&&-1===this._indexInOctreeMotionList&&this._octreeNode._octree.addMotionObject(this))}},{key:"_createRenderElement",value:function(){return new ci}},{key:"_onMeshChange",value:function(e){_get(_getPrototypeOf(dr.prototype),"_onMeshChange",this).call(this,e),this._cacheMesh=e;var t=e.subMeshCount;this._skinnedData=[],this._skinnedDataLoopMarks.length=e._inverseBindPoses.length;for(var n=0;n<t;n++)for(var i=e.getSubMesh(n)._boneIndicesList,r=i.length,a=this._skinnedData[n]=[],o=0;o<r;o++)a[o]=new Float32Array(16*i[o].length);this._cacheAvatar&&e&&this._getCacheAnimationNodes()}},{key:"_setCacheAnimator",value:function(e){this._cacheAnimator=e,this._shaderValues.addDefine(Ho.SHADERDEFINE_BONE),this._setRootNode()}},{key:"_calculateBoundingBox",value:function(){if(this._cacheAvatar)if(this._cacheAnimator&&this._rootBone){var e=dr._tempMatrix4x4;gt.matrix4x4MultiplyMFM(this._cacheAnimator.owner.transform.worldMatrix,this._cacheRootAnimationNode.transform.getWorldMatrix(),e),this._localBounds._tranform(e,this._bounds)}else _get(_getPrototypeOf(dr.prototype),"_calculateBoundingBox",this).call(this);else this._cacheRootBone?this._localBounds._tranform(this._cacheRootBone.transform.worldMatrix,this._bounds):this._localBounds._tranform(this._owner.transform.worldMatrix,this._bounds)}},{key:"_renderUpdate",value:function(t,n){if(this._cacheAnimator)if(this._computeSkinnedData(),this._cacheAvatar){var i=this._cacheAnimator.owner._transform;this._shaderValues.setMatrix4x4(Nn.WORLDMATRIX,i.worldMatrix)}else this._shaderValues.setMatrix4x4(Nn.WORLDMATRIX,q.DEFAULT);else this._shaderValues.setMatrix4x4(Nn.WORLDMATRIX,n.worldMatrix);this._probReflection&&(this._reflectionMode==e.ReflectionProbeMode.off?(this._shaderValues.removeDefine(Si.SHADERDEFINE_SPECCUBE_BOX_PROJECTION),this._shaderValues.setVector(ya.REFLECTIONCUBE_HDR_PARAMS,Da.defaultTextureHDRDecodeValues),this._shaderValues.setTexture(ya.REFLECTIONTEXTURE,ha.blackTexture)):(this._probReflection.boxProjection?(this._shaderValues.addDefine(Si.SHADERDEFINE_SPECCUBE_BOX_PROJECTION),this._shaderValues.setVector3(ya.REFLECTIONCUBE_PROBEPOSITION,this._probReflection.probePosition),this._shaderValues.setVector3(ya.REFLECTIONCUBE_PROBEBOXMAX,this._probReflection.boundsMax),this._shaderValues.setVector3(ya.REFLECTIONCUBE_PROBEBOXMIN,this._probReflection.boundsMin)):this._shaderValues.removeDefine(Si.SHADERDEFINE_SPECCUBE_BOX_PROJECTION),this._shaderValues.setTexture(ya.REFLECTIONTEXTURE,this._probReflection.reflectionTexture),this._shaderValues.setVector(ya.REFLECTIONCUBE_HDR_PARAMS,this._probReflection.reflectionHDRParams)))}},{key:"_renderUpdateWithCamera",value:function(e,t){var n=e.projectionViewMatrix;if(this._cacheAnimator)if(this._cacheAvatar){var i=this._cacheAnimator.owner._transform;q.multiply(n,i.worldMatrix,this._projectionViewWorldMatrix),this._shaderValues.setMatrix4x4(Nn.MVPMATRIX,this._projectionViewWorldMatrix)}else this._shaderValues.setMatrix4x4(Nn.MVPMATRIX,n);else q.multiply(n,t.worldMatrix,this._projectionViewWorldMatrix),this._shaderValues.setMatrix4x4(Nn.MVPMATRIX,this._projectionViewWorldMatrix)}},{key:"_destroy",value:function(){_get(_getPrototypeOf(dr.prototype),"_destroy",this).call(this),this._cacheAvatar?this._cacheRootAnimationNode&&this._cacheRootAnimationNode.transform.off(t.Event.TRANSFORM_CHANGED,this,this._onWorldMatNeedChange):this._cacheRootBone?!this._cacheRootBone.destroyed&&this._cacheRootBone.transform.off(t.Event.TRANSFORM_CHANGED,this,this._onWorldMatNeedChange):this._owner&&!this._owner.destroyed&&this._owner.transform.off(t.Event.TRANSFORM_CHANGED,this,this._onWorldMatNeedChange)}},{key:"_setRootBone",value:function(e){this._rootBone=e,this._setRootNode()}},{key:"_setRootNode",value:function(){var e;e=this._cacheAnimator&&this._rootBone&&this._cacheAvatar?this._cacheAnimator._avatarNodeMap[this._rootBone]:null,this._cacheRootAnimationNode!=e&&(this._onWorldMatNeedChange(oe.TRANSFORM_WORLDPOSITION|oe.TRANSFORM_WORLDQUATERNION|oe.TRANSFORM_WORLDSCALE),this._owner.transform.off(t.Event.TRANSFORM_CHANGED,this,this._onWorldMatNeedChange),this._cacheRootAnimationNode&&this._cacheRootAnimationNode.transform.off(t.Event.TRANSFORM_CHANGED,this,this._onWorldMatNeedChange),e&&e.transform.on(t.Event.TRANSFORM_CHANGED,this,this._onWorldMatNeedChange),this._cacheRootAnimationNode=e)}},{key:"_getCacheAnimationNodes",value:function(){var e=this._cacheMesh._boneNames,t=this._cacheMesh._inverseBindPoses.length;this._cacheAnimationNode.length=t;for(var n=this._cacheAnimator._avatarNodeMap,i=0;i<t;i++){var r=n[e[i]];this._cacheAnimationNode[i]=r}}},{key:"_setCacheAvatar",value:function(e){this._cacheAvatar!==e&&(this._cacheMesh?(this._cacheAvatar=e,e&&(this._shaderValues.addDefine(Ho.SHADERDEFINE_BONE),this._getCacheAnimationNodes())):this._cacheAvatar=e,this._setRootNode())}},{key:"localBounds",get:function(){return this._localBounds},set:function(e){this._localBounds=e}},{key:"rootBone",get:function(){return this._cacheRootBone},set:function(e){this._cacheRootBone!=e&&(this._cacheRootBone?this._cacheRootBone.transform.off(t.Event.TRANSFORM_CHANGED,this,this._onWorldMatNeedChange):this._owner.transform.off(t.Event.TRANSFORM_CHANGED,this,this._onWorldMatNeedChange),e?e.transform.on(t.Event.TRANSFORM_CHANGED,this,this._onWorldMatNeedChange):this._owner.transform.on(t.Event.TRANSFORM_CHANGED,this,this._onWorldMatNeedChange),this._cacheRootBone=e,this._onWorldMatNeedChange(oe.TRANSFORM_WORLDPOSITION|oe.TRANSFORM_WORLDQUATERNION|oe.TRANSFORM_WORLDSCALE))}},{key:"bones",get:function(){return this._bones}},{key:"bounds",get:function(){return(this._boundsChange||this._cacheAvatar)&&(this._calculateBoundingBox(),this._boundsChange=!1),this._bounds}}]),dr}();zo._tempMatrix4x4=new q;var Wo=function(e){function ur(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return _classCallCheck(this,ur),(e=_possibleConstructorReturn(this,_getPrototypeOf(ur).call(this,n)))._meshFilter=new io(_assertThisInitialized(e)),e._render=new zo(_assertThisInitialized(e)),t&&(e._meshFilter.sharedMesh=t),e}return _inherits(ur,ya),_createClass(ur,[{key:"_parse",value:function(e,n){_get(_getPrototypeOf(ur.prototype),"_parse",this).call(this,e,n);var i=this.skinnedMeshRenderer,r=e.lightmapIndex;null!=r&&(i.lightmapIndex=r);var a,s=e.lightmapScaleOffset;if(s&&(i.lightmapScaleOffset=new o(s[0],s[1],s[2],s[3])),null!=e.enableRender&&(i.enable=e.enableRender),null!=e.receiveShadows&&(i.receiveShadow=e.receiveShadows),null!=e.castShadow&&(i.castShadow=e.castShadow),a=e.meshPath){var l=t.Loader.getRes(a);l&&(this.meshFilter.sharedMesh=l)}var u=e.materials;if(u){var _=i.sharedMaterials,c=u.length;_.length=c;for(var h=0;h<c;h++)_[h]=t.Loader.getRes(u[h].path);i.sharedMaterials=_}var d=e.boundBox,f=d.min,m=d.max;if(i.localBounds.setMin(new D(f[0],f[1],f[2])),i.localBounds.setMax(new D(m[0],m[1],m[2])),n){var p=e.rootBone;i.rootBone=n[p];var v,E=e.bones;for(h=0,v=E.length;h<v;h++)i.bones.push(n[E[h]])}else e.rootBone&&i._setRootBone(e.rootBone)}},{key:"_changeHierarchyAnimator",value:function(e){_get(_getPrototypeOf(ur.prototype),"_changeHierarchyAnimator",this).call(this,e),this.skinnedMeshRenderer._setCacheAnimator(e)}},{key:"_changeAnimatorAvatar",value:function(e){this.skinnedMeshRenderer._setCacheAvatar(e)}},{key:"_cloneTo",value:function(e,t,n){var i=e;i.meshFilter.sharedMesh=this.meshFilter.sharedMesh;var r=this._render,a=i._render;a.enable=r.enable,a.sharedMaterials=r.sharedMaterials,a.castShadow=r.castShadow;var o=r.lightmapScaleOffset;o&&(a.lightmapScaleOffset=o.clone()),a.receiveShadow=r.receiveShadow,a.sortingFudge=r.sortingFudge,a._rootBone=r._rootBone;var s=r.bones,l=a.bones,u=s.length;l.length=u;var _=r.rootBone;if(_){var c=gt._getHierarchyPath(t,_,ur._tempArray0);a.rootBone=c?gt._getNodeByHierarchyPath(n,c):_}for(var h=0;h<s.length;h++)c=gt._getHierarchyPath(t,s[h],ur._tempArray0),l[h]=c?gt._getNodeByHierarchyPath(n,c):s[h];var d=r.localBounds;d&&d.cloneTo(a.localBounds),_get(_getPrototypeOf(ur.prototype),"_cloneTo",this).call(this,e,t,n)}},{key:"destroy",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];this.destroyed||(_get(_getPrototypeOf(ur.prototype),"destroy",this).call(this,e),this._meshFilter.destroy())}},{key:"_create",value:function(){return new ur}},{key:"meshFilter",get:function(){return this._meshFilter}},{key:"skinnedMeshRenderer",get:function(){return this._render}}],[{key:"__init__",value:function(){Ho.SHADERDEFINE_BONE=xn.getDefineByName("BONE"),Ho.SHADERDEFINE_SIMPLEBONE=xn.getDefineByName("SIMPLEBONE")}}]),ur}();Wo._tempArray0=[],Wo.BONES=xn.propertyNameToID("u_Bones"),Wo.SIMPLE_SIMPLEANIMATORTEXTURE=xn.propertyNameToID("u_SimpleAnimatorTexture"),Wo.SIMPLE_SIMPLEANIMATORPARAMS=xn.propertyNameToID("u_SimpleAnimatorParams"),Wo.SIMPLE_SIMPLEANIMATORTEXTURESIZE=xn.propertyNameToID("u_SimpleAnimatorTextureSize");var Xo=function(e){function mr(){var e;return _classCallCheck(this,mr),(e=_possibleConstructorReturn(this,_getPrototypeOf(mr).call(this))).setShaderName("Trail"),e._color=new o(1,1,1,1),e._shaderValues.setVector(mr.TILINGOFFSET,new o(1,1,0,0)),e._shaderValues.setVector(mr.TINTCOLOR,new o(1,1,1,1)),e.renderMode=mr.RENDERMODE_ALPHABLENDED,e}return _inherits(mr,Gi),_createClass(mr,[{key:"clone",value:function(){var e=new mr;return this.cloneTo(e),e}},{key:"_TintColorR",get:function(){return this._color.x},set:function(e){this._color.x=e,this.color=this._color}},{key:"_TintColorG",get:function(){return this._color.y},set:function(e){this._color.y=e,this.color=this._color}},{key:"_TintColorB",get:function(){return this._color.z},set:function(e){this._color.z=e,this.color=this._color}},{key:"_TintColorA",get:function(){return this._color.w},set:function(e){this._color.w=e,this.color=this._color}},{key:"_MainTex_STX",get:function(){return this._shaderValues.getVector(mr.TILINGOFFSET).x},set:function(e){var t=this._shaderValues.getVector(mr.TILINGOFFSET);t.x=e,this.tilingOffset=t}},{key:"_MainTex_STY",get:function(){return this._shaderValues.getVector(mr.TILINGOFFSET).y},set:function(e){var t=this._shaderValues.getVector(mr.TILINGOFFSET);t.y=e,this.tilingOffset=t}},{key:"_MainTex_STZ",get:function(){return this._shaderValues.getVector(mr.TILINGOFFSET).z},set:function(e){var t=this._shaderValues.getVector(mr.TILINGOFFSET);t.z=e,this.tilingOffset=t}},{key:"_MainTex_STW",get:function(){return this._shaderValues.getVector(mr.TILINGOFFSET).w},set:function(e){var t=this._shaderValues.getVector(mr.TILINGOFFSET);t.w=e,this.tilingOffset=t}},{key:"renderMode",set:function(e){switch(e){case mr.RENDERMODE_ADDTIVE:this.renderQueue=Gi.RENDERQUEUE_TRANSPARENT,this.alphaTest=!1,this.depthWrite=!1,this.cull=Wi.CULL_NONE,this.blend=Wi.BLEND_ENABLE_ALL,this.blendSrc=Wi.BLENDPARAM_SRC_ALPHA,this.blendDst=Wi.BLENDPARAM_ONE,this.depthTest=Wi.DEPTHTEST_LESS,this._shaderValues.addDefine(mr.SHADERDEFINE_ADDTIVEFOG);break;case mr.RENDERMODE_ALPHABLENDED:this.renderQueue=Gi.RENDERQUEUE_TRANSPARENT,this.alphaTest=!1,this.depthWrite=!1,this.cull=Wi.CULL_NONE,this.blend=Wi.BLEND_ENABLE_ALL,this.blendSrc=Wi.BLENDPARAM_SRC_ALPHA,this.blendDst=Wi.BLENDPARAM_ONE_MINUS_SRC_ALPHA,this.depthTest=Wi.DEPTHTEST_LESS,this._shaderValues.removeDefine(mr.SHADERDEFINE_ADDTIVEFOG);break;default:throw new Error("TrailMaterial : renderMode value error.")}}},{key:"colorR",get:function(){return this._TintColorR},set:function(e){this._TintColorR=e}},{key:"colorG",get:function(){return this._TintColorG},set:function(e){this._TintColorG=e}},{key:"colorB",get:function(){return this._TintColorB},set:function(e){this._TintColorB=e}},{key:"colorA",get:function(){return this._TintColorA},set:function(e){this._TintColorA=e}},{key:"color",get:function(){return this._shaderValues.getVector(mr.TINTCOLOR)},set:function(e){this._shaderValues.setVector(mr.TINTCOLOR,e)}},{key:"texture",get:function(){return this._shaderValues.getTexture(mr.MAINTEXTURE)},set:function(e){e?this._shaderValues.addDefine(mr.SHADERDEFINE_MAINTEXTURE):this._shaderValues.removeDefine(mr.SHADERDEFINE_MAINTEXTURE),this._shaderValues.setTexture(mr.MAINTEXTURE,e)}},{key:"tilingOffsetX",get:function(){return this._MainTex_STX},set:function(e){this._MainTex_STX=e}},{key:"tilingOffsetY",get:function(){return this._MainTex_STY},set:function(e){this._MainTex_STY=e}},{key:"tilingOffsetZ",get:function(){return this._MainTex_STZ},set:function(e){this._MainTex_STZ=e}},{key:"tilingOffsetW",get:function(){return this._MainTex_STW},set:function(e){this._MainTex_STW=e}},{key:"tilingOffset",get:function(){return this._shaderValues.getVector(mr.TILINGOFFSET)},set:function(e){e?this._shaderValues.setVector(mr.TILINGOFFSET,e):this._shaderValues.getVector(mr.TILINGOFFSET).setValue(1,1,0,0)}}],[{key:"__initDefine__",value:function(){mr.SHADERDEFINE_MAINTEXTURE=xn.getDefineByName("MAINTEXTURE"),mr.SHADERDEFINE_ADDTIVEFOG=xn.getDefineByName("ADDTIVEFOG")}}]),mr}();Xo.RENDERMODE_ALPHABLENDED=0,Xo.RENDERMODE_ADDTIVE=1,Xo.MAINTEXTURE=xn.propertyNameToID("u_MainTexture"),Xo.TINTCOLOR=xn.propertyNameToID("u_MainColor"),Xo.TILINGOFFSET=xn.propertyNameToID("u_TilingOffset");var Yo=function fr(){_classCallCheck(this,fr)};Yo.Stretch=0,Yo.Tile=1,(qa=e.TrailAlignment||(e.TrailAlignment={}))[qa.View=0]="View",qa[qa.TransformZ=1]="TransformZ";var jo=function(){function Tr(){_classCallCheck(this,Tr)}return _createClass(Tr,[{key:"vertexDeclaration",get:function(){return Tr._vertexDeclaration1}}],[{key:"__init__",value:function(){Tr._vertexDeclaration1=new Tn(32,[new gn(0,vn.Vector3,Tr.TRAIL_POSITION0),new gn(12,vn.Vector3,Tr.TRAIL_OFFSETVECTOR),new gn(24,vn.Single,Tr.TRAIL_TIME0),new gn(28,vn.Single,Tr.TRAIL_TEXTURECOORDINATE0Y)]),Tr._vertexDeclaration2=new Tn(20,[new gn(0,vn.Single,Tr.TRAIL_TEXTURECOORDINATE0X),new gn(4,vn.Color,Tr.TRAIL_COLOR)])}},{key:"vertexDeclaration1",get:function(){return Tr._vertexDeclaration1}},{key:"vertexDeclaration2",get:function(){return Tr._vertexDeclaration2}}]),Tr}();jo.TRAIL_POSITION0=0,jo.TRAIL_OFFSETVECTOR=1,jo.TRAIL_TIME0=2,jo.TRAIL_TEXTURECOORDINATE0Y=3,jo.TRAIL_TEXTURECOORDINATE0X=4,jo.TRAIL_COLOR=5;var Zo=function(n){function Er(e){var t;_classCallCheck(this,Er),(t=_possibleConstructorReturn(this,_getPrototypeOf(Er).call(this)))._floatCountPerVertices1=8,t._floatCountPerVertices2=5,t._increaseSegementCount=16,t._activeIndex=0,t._endIndex=0,t._needAddFirstVertex=!1,t._isTempEndVertex=!1,t._vertices1=null,t._vertices2=null,t._lastFixedVertexPosition=new D,t._bufferState=new yn,t.tmpColor=new ta,t._disappearBoundsMode=!1,t._owner=e,t._segementCount=t._increaseSegementCount,t._resizeData(t._segementCount,t._bufferState);var n=t._owner._owner.trailRenderer.bounds,i=t._owner._owner.transform.position;return n.setMin(i),n.setMax(i),t}return _inherits(Er,Ea),_createClass(Er,[{key:"_resizeData",value:function(e,n){this._subBirthTime=new Float32Array(e),this._subDistance=new Float64Array(e);var i=t.LayaGL.instance,r=2*e,a=jo.vertexDeclaration1,o=jo.vertexDeclaration2,s=[],l=r*a.vertexStride,u=r*o.vertexStride,_=l+u;this._vertices1=new Float32Array(r*this._floatCountPerVertices1),this._vertices2=new Float32Array(r*this._floatCountPerVertices2),this._vertexBuffer1=new pn(l,i.STATIC_DRAW,!1),this._vertexBuffer1.vertexDeclaration=a,this._vertexBuffer2=new pn(u,i.DYNAMIC_DRAW,!1),this._vertexBuffer2.vertexDeclaration=o,s.push(this._vertexBuffer1),s.push(this._vertexBuffer2),n.bind(),n.applyVertexBuffers(s),n.unBind(),t.Resource._addMemory(_,_)}},{key:"_resetData",value:function(){var e=this._endIndex-this._activeIndex,n=new Float32Array(this._vertices1.buffer,2*this._floatCountPerVertices1*this._activeIndex*4,2*this._floatCountPerVertices1*e),i=new Float32Array(this._vertices2.buffer,2*this._floatCountPerVertices2*this._activeIndex*4,2*this._floatCountPerVertices2*e),r=new Float64Array(this._subDistance.buffer,8*this._activeIndex,e),a=new Float32Array(this._subBirthTime.buffer,4*this._activeIndex,e);if(e===this._segementCount){var o=this._vertexBuffer1._byteLength+this._vertexBuffer2._byteLength;t.Resource._addMemory(-o,-o),this._vertexBuffer1.destroy(),this._vertexBuffer2.destroy(),this._segementCount+=this._increaseSegementCount,this._resizeData(this._segementCount,this._bufferState)}this._vertices1.set(n,0),this._vertices2.set(i,0),this._subDistance.set(r,0),this._subBirthTime.set(a,0),this._endIndex=e,this._activeIndex=0,this._vertexBuffer1.setData(this._vertices1.buffer,0,2*this._floatCountPerVertices1*this._activeIndex*4,2*this._floatCountPerVertices1*e*4),this._vertexBuffer2.setData(this._vertices2.buffer,0,2*this._floatCountPerVertices2*this._activeIndex*4,2*this._floatCountPerVertices2*e*4)}},{key:"_updateTrail",value:function(e,t,n){D.equals(t,n)||(this._endIndex-this._activeIndex==0?this._addTrailByFirstPosition(e,n):this._addTrailByNextPosition(e,n))}},{key:"_addTrailByFirstPosition",value:function(e,t){this._endIndex===this._segementCount&&this._resetData(),this._subDistance[this._endIndex]=0,this._subBirthTime[this._endIndex]=this._owner._curtime,this._endIndex++,t.cloneTo(this._lastFixedVertexPosition),this._needAddFirstVertex=!0}},{key:"_addTrailByNextPosition",value:function(t,n){var r=Er._tempVector30,a=Er._tempVector31;switch(this._owner.alignment){case e.TrailAlignment.View:var o=t.viewMatrix;D.transformCoordinate(n,o,Er._tempVector33),D.transformCoordinate(this._lastFixedVertexPosition,o,Er._tempVector34),D.subtract(Er._tempVector33,Er._tempVector34,r),D.cross(Er._tempVector33,r,a);break;case e.TrailAlignment.TransformZ:D.subtract(n,this._lastFixedVertexPosition,r);var s=Er._tempVector32;this._owner._owner.transform.getForward(s),D.cross(r,s,a)}D.normalize(a,a),D.scale(a,this._owner.widthMultiplier/2,a);var l,u,_=D.scalarLength(r);this._needAddFirstVertex&&(this._updateVerticesByPositionData(n,a,this._endIndex-1),this._needAddFirstVertex=!1),_-this._owner.minVertexDistance>=i.zeroTolerance?(this._isTempEndVertex?(l=this._endIndex-1,u=_-this._subDistance[l],this._updateVerticesByPosition(n,a,_,l),this._owner._totalLength+=u):(this._endIndex===this._segementCount&&this._resetData(),this._updateVerticesByPosition(n,a,_,this._endIndex),this._owner._totalLength+=_,this._endIndex++),n.cloneTo(this._lastFixedVertexPosition),this._isTempEndVertex=!1):(this._isTempEndVertex?(l=this._endIndex-1,u=_-this._subDistance[l],this._updateVerticesByPosition(n,a,_,l),this._owner._totalLength+=u):(this._endIndex===this._segementCount&&this._resetData(),this._updateVerticesByPosition(n,a,_,this._endIndex),this._owner._totalLength+=_,this._endIndex++),this._isTempEndVertex=!0)}},{key:"_updateVerticesByPositionData",value:function(e,t,n){var i=2*this._floatCountPerVertices1*n,r=this._owner._curtime;this._vertices1[i]=e.x,this._vertices1[i+1]=e.y,this._vertices1[i+2]=e.z,this._vertices1[i+3]=-t.x,this._vertices1[i+4]=-t.y,this._vertices1[i+5]=-t.z,this._vertices1[i+6]=r,this._vertices1[i+7]=1,this._vertices1[i+8]=e.x,this._vertices1[i+9]=e.y,this._vertices1[i+10]=e.z,this._vertices1[i+11]=t.x,this._vertices1[i+12]=t.y,this._vertices1[i+13]=t.z,this._vertices1[i+14]=r,this._vertices1[i+15]=0;var a=this._owner._owner.trailRenderer.bounds,o=a.getMin(),s=a.getMax(),l=Er._tempVector35,u=Er._tempVector36,_=Er._tempVector32;D.add(e,t,l),D.subtract(e,t,u),D.min(u,l,_),D.min(o,_,o),a.setMin(o),D.max(l,u,_),D.max(s,_,s),a.setMax(s);var c=2*this._floatCountPerVertices1;this._vertexBuffer1.setData(this._vertices1.buffer,4*i,4*i,4*c)}},{key:"_updateVerticesByPosition",value:function(e,t,n,i){this._updateVerticesByPositionData(e,t,i),this._subDistance[i]=n,this._subBirthTime[i]=this._owner._curtime}},{key:"_updateVertexBufferUV",value:function(){var e,t,n;if(this._disappearBoundsMode){e=this._owner._owner.trailRenderer.bounds;var i=this._owner._owner.transform.position;e.setMin(i),e.setMax(i),t=e.getMin(),n=e.getMax()}for(var r=this._endIndex,a=0,o=this._owner.colorGradient,s=o.colorAlphaKeysCount-1,l=o.colorRGBKeysCount-1,u=this._owner._totalLength,_=2*this._floatCountPerVertices2,c=this._activeIndex;c<r;c++){var h,d;c!==this._activeIndex&&(a+=this._subDistance[c]),this._owner.textureMode==Yo.Stretch?d=h=1-a/u:(d=1-a/u,h=1-(u-a)),l=o.evaluateColorRGB(d,this.tmpColor,l,!0),s=o.evaluateColorAlpha(d,this.tmpColor,s,!0);var f=c*_;if(this._vertices2[f+0]=h,this._vertices2[f+1]=this.tmpColor.r,this._vertices2[f+2]=this.tmpColor.g,this._vertices2[f+3]=this.tmpColor.b,this._vertices2[f+4]=this.tmpColor.a,this._vertices2[f+5]=h,this._vertices2[f+6]=this.tmpColor.r,this._vertices2[f+7]=this.tmpColor.g,this._vertices2[f+8]=this.tmpColor.b,this._vertices2[f+9]=this.tmpColor.a,this._disappearBoundsMode){var m=2*this._floatCountPerVertices1*c,p=Er._tempVector32,v=Er._tempVector33,E=Er._tempVector34;p.setValue(this._vertices1[m+0],this._vertices1[m+1],this._vertices1[m+2]),v.setValue(this._vertices1[m+3],this._vertices1[m+4],this._vertices1[m+5]),D.add(p,v,E),D.min(E,t,t),D.max(E,n,n),D.subtract(p,v,E),D.min(E,t,t),D.max(E,n,n)}}this._disappearBoundsMode&&(e.setMin(t),e.setMax(n),this._disappearBoundsMode=!1);var T=this._activeIndex*_;this._vertexBuffer2.setData(this._vertices2.buffer,4*T,4*T,4*(r*_-T))}},{key:"_updateDisappear",value:function(){for(var e=this._endIndex,t=this._activeIndex;t<e&&this._owner._curtime-this._subBirthTime[t]>=this._owner.time+i.zeroTolerance;t++){var n=t+1;if(n!==e&&(this._owner._totalLength-=this._subDistance[n]),this._isTempEndVertex&&n===e-1){var r=this._lastFixedVertexPosition;r.x=this._vertices1[0],r.y=this._vertices1[1],r.z=this._vertices1[2],this._isTempEndVertex=!1}this._activeIndex++,this._disappearBoundsMode=!0}}},{key:"_getType",value:function(){return Er._type}},{key:"_prepareRender",value:function(e){return this._endIndex-this._activeIndex>1}},{key:"_render",value:function(e){this._bufferState.bind();var n=t.LayaGL.instance,i=2*this._activeIndex,r=2*this._endIndex-i;n.drawArrays(n.TRIANGLE_STRIP,i,r),t.Stat.renderBatches++,t.Stat.trianglesFaces+=r-2}},{key:"destroy",value:function(){_get(_getPrototypeOf(Er.prototype),"destroy",this).call(this);var e=this._vertexBuffer1._byteLength+this._vertexBuffer2._byteLength;t.Resource._addMemory(-e,-e),this._bufferState.destroy(),this._vertexBuffer1.destroy(),this._vertexBuffer2.destroy(),this._bufferState=null,this._vertices1=null,this._vertexBuffer1=null,this._vertices2=null,this._vertexBuffer2=null,this._subBirthTime=null,this._subDistance=null,this._lastFixedVertexPosition=null,this._disappearBoundsMode=!1}},{key:"clear",value:function(){this._activeIndex=0,this._endIndex=0,this._disappearBoundsMode=!1,this._subBirthTime.fill(0),this._subDistance.fill(0),this._segementCount=0,this._isTempEndVertex=!1,this._needAddFirstVertex=!1,this._lastFixedVertexPosition.setValue(0,0,0)}}]),Er}();Zo.ALIGNMENT_VIEW=0,Zo.ALIGNMENT_TRANSFORM_Z=1,Zo._tempVector30=new D,Zo._tempVector31=new D,Zo._tempVector32=new D,Zo._tempVector33=new D,Zo._tempVector34=new D,Zo._tempVector35=new D,Zo._tempVector36=new D,Zo._type=Ea._typeCounter++;var qo=function(){function pr(e){_classCallCheck(this,pr),this._totalLength=0,this._lastPosition=new D,this._curtime=0,this.alignment=pr.ALIGNMENT_VIEW,this._owner=e,this._initDefaultData(),this.addRenderElement()}return _createClass(pr,[{key:"addRenderElement",value:function(){var e=this._owner._render,t=e._renderElements,n=e.sharedMaterials[0];n||(n=Xo.defaultMaterial);var i=new ci;i.setTransform(this._owner._transform),i.render=e,i.material=n,this._trialGeometry=new Zo(this),i.setGeometry(this._trialGeometry),t.push(i)}},{key:"_update",value:function(e){var t=this._owner._render;this._curtime+=e.scene.timer._delta/1e3,t._shaderValues.setNumber(pr.CURTIME,this._curtime);var n=this._owner.transform.position,i=t._renderElements[0]._geometry;i._updateDisappear(),i._updateTrail(e.camera,this._lastPosition,n),i._updateVertexBufferUV(),n.cloneTo(this._lastPosition)}},{key:"_initDefaultData",value:function(){this.time=5,this.minVertexDistance=.1,this.widthMultiplier=1,this.textureMode=Yo.Stretch;var e=[],t=new Bt;t.time=0,t.inTangent=0,t.outTangent=0,t.value=1,e.push(t);var n=new Bt;n.time=1,n.inTangent=0,n.outTangent=0,n.value=1,e.push(n),this.widthCurve=e;var i=new lo(2,2);i.mode=so.Blend,i.addColorRGB(0,ta.WHITE),i.addColorRGB(1,ta.WHITE),i.addColorAlpha(0,1),i.addColorAlpha(1,1),this.colorGradient=i}},{key:"destroy",value:function(){this._trialGeometry.destroy(),this._trialGeometry=null,this._widthCurve=null,this._colorGradient=null}},{key:"clear",value:function(){this._trialGeometry.clear(),this._lastPosition.setValue(0,0,0),this._curtime=0,this._totalLength=0}},{key:"time",get:function(){return this._time},set:function(e){this._time=e,this._owner._render._shaderValues.setNumber(pr.LIFETIME,e)}},{key:"minVertexDistance",get:function(){return this._minVertexDistance},set:function(e){this._minVertexDistance=e}},{key:"widthMultiplier",get:function(){return this._widthMultiplier},set:function(e){this._widthMultiplier=e}},{key:"widthCurve",get:function(){return this._widthCurve},set:function(e){this._widthCurve=e;var t,n,i=new Float32Array(4*e.length),r=0;for(t=0,n=e.length;t<n;t++)i[r++]=e[t].time,i[r++]=e[t].inTangent,i[r++]=e[t].outTangent,i[r++]=e[t].value;this._owner._render._shaderValues.setBuffer(pr.WIDTHCURVE,i),this._owner._render._shaderValues.setInt(pr.WIDTHCURVEKEYLENGTH,e.length)}},{key:"colorGradient",get:function(){return this._colorGradient},set:function(e){this._colorGradient=e}},{key:"textureMode",get:function(){return this._textureMode},set:function(e){this._textureMode=e}}]),pr}();qo.CURTIME=xn.propertyNameToID("u_CurTime"),qo.LIFETIME=xn.propertyNameToID("u_LifeTime"),qo.WIDTHCURVE=xn.propertyNameToID("u_WidthCurve"),qo.WIDTHCURVEKEYLENGTH=xn.propertyNameToID("u_WidthCurveKeyLength"),qo.ALIGNMENT_VIEW=0,qo.ALIGNMENT_TRANSFORM_Z=1;var Qo=function(e){function gr(e){var t;return _classCallCheck(this,gr),(t=_possibleConstructorReturn(this,_getPrototypeOf(gr).call(this,e)))._projectionViewWorldMatrix=new q,t}return _inherits(gr,Ma),_createClass(gr,[{key:"_calculateBoundingBox",value:function(){}},{key:"_needRender",value:function(e,t){return this._owner.trailFilter._update(t),!e||e.intersects(this.bounds._getBoundBox())}},{key:"_updateForNative",value:function(e){this._owner.trailFilter._update(e)}},{key:"_renderUpdate",value:function(e,t){_get(_getPrototypeOf(gr.prototype),"_renderUpdate",this).call(this,e,t)}},{key:"_renderUpdateWithCamera",value:function(e,t){var n=e.projectionViewMatrix;t?(q.multiply(n,t.worldMatrix,this._projectionViewWorldMatrix),this._shaderValues.setMatrix4x4(Nn.MVPMATRIX,this._projectionViewWorldMatrix)):this._shaderValues.setMatrix4x4(Nn.MVPMATRIX,n)}}]),gr}(),Ko=function(e){function Sr(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;return _classCallCheck(this,Sr),(e=_possibleConstructorReturn(this,_getPrototypeOf(Sr).call(this,t)))._render=new Qo(_assertThisInitialized(e)),e._geometryFilter=new qo(_assertThisInitialized(e)),e}return _inherits(Sr,ya),_createClass(Sr,[{key:"_parse",value:function(e,n){_get(_getPrototypeOf(Sr.prototype),"_parse",this).call(this,e,n);var i,r,a=this._render,o=this._geometryFilter,s=e.materials;if(s){var l=a.sharedMaterials,u=s.length;for(l.length=u,i=0;i<u;i++)l[i]=t.Loader.getRes(s[i].path);a.sharedMaterials=l}o.time=e.time,o.minVertexDistance=e.minVertexDistance,o.widthMultiplier=e.widthMultiplier,o.textureMode=e.textureMode,null!=e.alignment&&(o.alignment=e.alignment);var _=[],c=e.widthCurve;for(i=0,r=c.length;i<r;i++){var h=new Bt;h.time=c[i].time,h.inTangent=c[i].inTangent,h.outTangent=c[i].outTangent,h.value=c[i].value,_.push(h)}o.widthCurve=_;var d=e.colorGradient,f=d.colorKeys,m=d.alphaKeys,p=new lo(f.length,m.length);for(p.mode=d.mode,i=0,r=f.length;i<r;i++){var v=f[i];p.addColorRGB(v.time,new ta(v.value[0],v.value[1],v.value[2],1))}for(i=0,r=m.length;i<r;i++){var E=m[i];p.addColorAlpha(E.time,E.value)}o.colorGradient=p}},{key:"_onActive",value:function(){_get(_getPrototypeOf(Sr.prototype),"_onActive",this).call(this),this._transform.position.cloneTo(this._geometryFilter._lastPosition)}},{key:"_cloneTo",value:function(e,t,n){var i,r;_get(_getPrototypeOf(Sr.prototype),"_cloneTo",this).call(this,e,t,n);var a=e,o=a.trailFilter;o.time=this.trailFilter.time,o.minVertexDistance=this.trailFilter.minVertexDistance,o.widthMultiplier=this.trailFilter.widthMultiplier,o.textureMode=this.trailFilter.textureMode,o.alignment=this.trailFilter.alignment;var s=this.trailFilter.widthCurve,l=[];for(i=0,r=s.length;i<r;i++){var u=new Bt;s[i].cloneTo(u),l.push(u)}o.widthCurve=l;var _=new lo(this.trailFilter.colorGradient.maxColorRGBKeysCount,this.trailFilter.colorGradient.maxColorAlphaKeysCount);this.trailFilter.colorGradient.cloneTo(_),o.colorGradient=_,a.trailRenderer.sharedMaterial=this.trailRenderer.sharedMaterial}},{key:"destroy",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];this.destroyed||(_get(_getPrototypeOf(Sr.prototype),"destroy",this).call(this,e),this._geometryFilter.destroy(),this._geometryFilter=null)}},{key:"clear",value:function(){this._geometryFilter.clear()}},{key:"_create",value:function(){return new Sr}},{key:"trailFilter",get:function(){return this._geometryFilter}},{key:"trailRenderer",get:function(){return this._render}}],[{key:"__init__",value:function(){}}]),Sr}(),Jo=function(){function Rr(e,t,n,i){_classCallCheck(this,Rr),this._position=e,this._normal=t,this._textureCoord0=n,this._textureCoord1=i}return _createClass(Rr,[{key:"position",get:function(){return this._position}},{key:"normal",get:function(){return this._normal}},{key:"textureCoord0",get:function(){return this._textureCoord0}},{key:"textureCoord1",get:function(){return this._textureCoord1}},{key:"vertexDeclaration",get:function(){return Rr._vertexDeclaration}}],[{key:"__init__",value:function(){Rr._vertexDeclaration=new Tn(40,[new gn(0,vn.Vector3,Rr.TERRAIN_POSITION0),new gn(12,vn.Vector3,Rr.TERRAIN_NORMAL0),new gn(24,vn.Vector2,Rr.TERRAIN_TEXTURECOORDINATE0),new gn(32,vn.Vector2,Rr.TERRAIN_TEXTURECOORDINATE1)])}},{key:"vertexDeclaration",get:function(){return Rr._vertexDeclaration}}]),Rr}();Jo.TERRAIN_POSITION0=0,Jo.TERRAIN_NORMAL0=1,Jo.TERRAIN_TEXTURECOORDINATE0=2,Jo.TERRAIN_TEXTURECOORDINATE1=3;var $o=function vr(){_classCallCheck(this,vr)};$o._interactive={getWorldTransform:function(e,t){},setWorldTransform:function(e,t){var n=ze._physicObjectsMap[e];n._simulation._updatedRigidbodies++,n._updateTransformComponent(t)}};var es=function(e){function Ar(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:ce.COLLISIONFILTERGROUP_DEFAULTFILTER,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:ce.COLLISIONFILTERGROUP_ALLFILTER;return _classCallCheck(this,Ar),(e=_possibleConstructorReturn(this,_getPrototypeOf(Ar).call(this,t,n)))._enableProcessCollisions=!1,e}return _inherits(Ar,St),_createClass(Ar,[{key:"_addToSimulation",value:function(){this._simulation._addPhysicsCollider(this,this._collisionGroup,this._canCollideWith)}},{key:"_removeFromSimulation",value:function(){this._simulation._removePhysicsCollider(this)}},{key:"_parse",value:function(e){null!=e.friction&&(this.friction=e.friction),null!=e.rollingFriction&&(this.rollingFriction=e.rollingFriction),null!=e.restitution&&(this.restitution=e.restitution),null!=e.isTrigger&&(this.isTrigger=e.isTrigger),_get(_getPrototypeOf(Ar.prototype),"_parse",this).call(this,e),this._parseShape(e.shapes)}},{key:"_onAdded",value:function(){var e=Ct._bullet,t=e.btCollisionObject_create();e.btCollisionObject_setUserIndex(t,this.id),e.btCollisionObject_forceActivationState(t,ze.ACTIVATIONSTATE_DISABLE_SIMULATION);var n=e.btCollisionObject_getCollisionFlags(t);this.owner.isStatic?((n&ze.COLLISIONFLAGS_KINEMATIC_OBJECT)>0&&(n^=ze.COLLISIONFLAGS_KINEMATIC_OBJECT),n|=ze.COLLISIONFLAGS_STATIC_OBJECT):((n&ze.COLLISIONFLAGS_STATIC_OBJECT)>0&&(n^=ze.COLLISIONFLAGS_STATIC_OBJECT),n|=ze.COLLISIONFLAGS_KINEMATIC_OBJECT),e.btCollisionObject_setCollisionFlags(t,n),this._btColliderObject=t,_get(_getPrototypeOf(Ar.prototype),"_onAdded",this).call(this)}}]),Ar}(),ts=function(n){function xr(e){var t;return _classCallCheck(this,xr),(t=_possibleConstructorReturn(this,_getPrototypeOf(xr).call(this)))._id=++xr._uniqueIDCounter,t._mesh=e,t._boneIndicesList=[],t._subIndexBufferStart=[],t._subIndexBufferCount=[],t}return _inherits(xr,Ea),_createClass(xr,[{key:"_setIndexRange",value:function(t,n){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:e.IndexFormat.UInt16;this._indexStart=t,this._indexCount=n,i==e.IndexFormat.UInt16?this._indices=new Uint16Array(this._indexBuffer.getData().buffer,2*t,n):this._indices=new Uint32Array(this._indexBuffer.getData().buffer,4*t,n)}},{key:"_getType",value:function(){return xr._type}},{key:"_prepareRender",value:function(e){return this._mesh._uploadVerticesData(),!0}},{key:"_render",value:function(n){var i=this._mesh;if(i.indexFormat!==e.IndexFormat.UInt32||t.LayaGL.layaGPUInstance.supportElementIndexUint32()){var r,a,o=t.LayaGL.instance,s=n.renderElement?n.renderElement.render._skinnedData:null;switch(i.indexFormat){case e.IndexFormat.UInt32:r=o.UNSIGNED_INT,a=4;break;case e.IndexFormat.UInt16:r=o.UNSIGNED_SHORT,a=2;break;case e.IndexFormat.UInt8:r=o.UNSIGNED_BYTE,a=1}if(i._bufferState.bind(),s)for(var l=s[this._indexInMesh],u=0,_=this._boneIndicesList.length;u<_;u++)n.shader.uploadCustomUniform(Wo.BONES,l[u]),o.drawElements(o.TRIANGLES,this._subIndexBufferCount[u],r,this._subIndexBufferStart[u]*a);else o.drawElements(o.TRIANGLES,this._indexCount,r,this._indexStart*a);t.Stat.trianglesFaces+=this._indexCount/3,t.Stat.renderBatches++}else console.warn("SubMesh:this device do not support IndexFormat.UInt32.")}},{key:"getIndices",value:function(){if(this._mesh._isReadable)return this._indices.slice();throw"SubMesh:can't get indices on subMesh,mesh's isReadable must be true."}},{key:"setIndices",value:function(e){this._indexBuffer.setData(e,this._indexStart,0,this._indexCount)}},{key:"destroy",value:function(){this._destroyed||(_get(_getPrototypeOf(xr.prototype),"destroy",this).call(this),this._indexBuffer.destroy(),this._indexBuffer=null,this._mesh=null,this._boneIndicesList=null,this._subIndexBufferStart=null,this._subIndexBufferCount=null,this._skinAnimationDatas=null)}},{key:"indexCount",get:function(){return this._indexCount}}]),xr}();ts._uniqueIDCounter=0,ts._type=Ea._typeCounter++;var ns=function Ir(e,t,n){_classCallCheck(this,Ir),this.subMeshIndex=e,this.batchIndex=t,this.batchBoneIndex=n},is=function(n){function Dr(){var t,n=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];return _classCallCheck(this,Dr),(t=_possibleConstructorReturn(this,_getPrototypeOf(Dr).call(this)))._tempVector30=new D,t._tempVector31=new D,t._tempVector32=new D,t._minVerticesUpdate=-1,t._maxVerticesUpdate=-1,t._needUpdateBounds=!0,t._bounds=new va(new D,new D),t._bufferState=new yn,t._instanceBufferState=new yn,t._instanceBufferStateType=0,t._vertexBuffer=null,t._indexBuffer=null,t._skinnedMatrixCaches=[],t._vertexCount=0,t._indexFormat=e.IndexFormat.UInt16,t._isReadable=n,t._subMeshes=[],t}return _inherits(Dr,t.Resource),_createClass(Dr,[{key:"_getPositionElement",value:function(e){for(var t=e.vertexDeclaration._vertexElements,n=0,i=t.length;n<i;n++){var r=t[n];if(r._elementFormat===vn.Vector3&&r._elementUsage===Xn.MESH_POSITION0)return r}return null}},{key:"_getVerticeElementData",value:function(e,t){e.length=this._vertexCount;var n=this._vertexBuffer.vertexDeclaration,i=n.getVertexElementByUsage(t);if(i){var a=this._vertexBuffer.getUint8Data(),s=this._vertexBuffer.getFloat32Data(),l=n.vertexStride,u=l/4,_=i._offset,c=_/4;switch(t){case Xn.MESH_TEXTURECOORDINATE0:case Xn.MESH_TEXTURECOORDINATE1:for(var h=0;h<this._vertexCount;h++){var d=u*h+c;e[h]=new r(s[d],s[d+1])}break;case Xn.MESH_POSITION0:case Xn.MESH_NORMAL0:for(h=0;h<this._vertexCount;h++)d=u*h+c,e[h]=new D(s[d],s[d+1],s[d+2]);break;case Xn.MESH_TANGENT0:case Xn.MESH_BLENDWEIGHT0:for(h=0;h<this._vertexCount;h++)d=u*h+c,e[h]=new o(s[d],s[d+1],s[d+2],s[d+3]);break;case Xn.MESH_COLOR0:for(h=0;h<this._vertexCount;h++)d=u*h+c,e[h]=new ta(s[d],s[d+1],s[d+2],s[d+3]);break;case Xn.MESH_BLENDINDICES0:for(h=0;h<this._vertexCount;h++)d=l*h+_,e[h]=new o(a[d],a[d+1],a[d+2],a[d+3]);break;default:throw"Mesh:Unknown elementUsage."}}}},{key:"_setVerticeElementData",value:function(e,t){var n=this._vertexBuffer.vertexDeclaration,i=n.getVertexElementByUsage(t);if(i){var r=this._vertexBuffer.getUint8Data(),a=this._vertexBuffer.getFloat32Data(),o=n.vertexStride,s=o/4,l=i._offset,u=l/4;switch(t){case Xn.MESH_TEXTURECOORDINATE0:case Xn.MESH_TEXTURECOORDINATE1:for(var _=0,c=e.length;_<c;_++){var h=s*_+u,d=e[_];a[h]=d.x,a[h+1]=d.y}break;case Xn.MESH_POSITION0:case Xn.MESH_NORMAL0:for(_=0,c=e.length;_<c;_++){h=s*_+u;var f=e[_];a[h]=f.x,a[h+1]=f.y,a[h+2]=f.z}break;case Xn.MESH_TANGENT0:case Xn.MESH_BLENDWEIGHT0:for(_=0,c=e.length;_<c;_++){h=s*_+u;var m=e[_];a[h]=m.x,a[h+1]=m.y,a[h+2]=m.z,a[h+3]=m.w}break;case Xn.MESH_COLOR0:for(_=0,c=e.length;_<c;_++){h=s*_+u;var p=e[_];a[h]=p.r,a[h+1]=p.g,a[h+2]=p.b,a[h+3]=p.a}break;case Xn.MESH_BLENDINDICES0:for(_=0,c=e.length;_<c;_++)h=o*_+l,m=e[_],r[h]=m.x,r[h+1]=m.y,r[h+2]=m.z,r[h+3]=m.w;break;default:throw"Mesh:Unknown elementUsage."}this._minVerticesUpdate=0,this._maxVerticesUpdate=Number.MAX_SAFE_INTEGER}else console.warn("Mesh: the mesh don't have  this VertexElement.")}},{key:"_disposeResource",value:function(){for(var e=0,t=this._subMeshes.length;e<t;e++)this._subMeshes[e].destroy();this._btTriangleMesh&&Ct._bullet.btStridingMeshInterface_destroy(this._btTriangleMesh),this._vertexBuffer.destroy(),this._indexBuffer.destroy(),this._bufferState.destroy(),this._instanceBufferState.destroy(),this._setCPUMemory(0),this._setGPUMemory(0),this._bufferState=null,this._instanceBufferState=null,this._vertexBuffer=null,this._indexBuffer=null,this._subMeshes=null,this._btTriangleMesh=null,this._indexBuffer=null,this._boneNames=null,this._inverseBindPoses=null}},{key:"_setSubMeshes",value:function(e){this._subMeshes=e;for(var t=0,n=e.length;t<n;t++)e[t]._indexInMesh=t}},{key:"_setBuffer",value:function(e,t){var n=this._bufferState;n.bind(),n.applyVertexBuffer(e),n.applyIndexBuffer(t),n.unBind()}},{key:"_setInstanceBuffer",value:function(e){var t=this._instanceBufferState;switch(t.bind(),t.applyVertexBuffer(this._vertexBuffer),t.applyInstanceVertexBuffer(Ra.instance.instanceWorldMatrixBuffer),e){case Dr.MESH_INSTANCEBUFFER_TYPE_SIMPLEANIMATOR:t.applyInstanceVertexBuffer(Ra.instance.instanceSimpleAnimatorBuffer)}t.applyIndexBuffer(this._indexBuffer),t.unBind()}},{key:"_getPhysicMesh",value:function(){if(!this._btTriangleMesh){for(var e=Ct._bullet,t=e.btTriangleMesh_create(),n=Dr._nativeTempVector30,i=Dr._nativeTempVector31,r=Dr._nativeTempVector32,a=this._tempVector30,o=this._tempVector31,s=this._tempVector32,l=this._vertexBuffer,u=this._getPositionElement(l),_=l.getFloat32Data(),c=l.vertexDeclaration.vertexStride/4,h=u._offset/4,d=this._indexBuffer.getData(),f=0,m=d.length;f<m;f+=3){var p=d[f]*c+h,v=d[f+1]*c+h,E=d[f+2]*c+h;a.setValue(_[p],_[p+1],_[p+2]),o.setValue(_[v],_[v+1],_[v+2]),s.setValue(_[E],_[E+1],_[E+2]),gt._convertToBulletVec3(a,n,!0),gt._convertToBulletVec3(o,i,!0),gt._convertToBulletVec3(s,r,!0),e.btTriangleMesh_addTriangle(t,n,i,r,!0)}this._btTriangleMesh=t}return this._btTriangleMesh}},{key:"_uploadVerticesData",value:function(){var e=this._minVerticesUpdate,t=this._maxVerticesUpdate;if(-1!==e&&-1!==t){var n=e;this._vertexBuffer.setData(this._vertexBuffer.getUint8Data().buffer,n,n,t-e),this._minVerticesUpdate=-1,this._maxVerticesUpdate=-1}}},{key:"getSubMesh",value:function(e){return this._subMeshes[e]}},{key:"getPositions",value:function(e){if(!this._isReadable)throw"Mesh:can't get positions on mesh,isReadable must be true.";this._getVerticeElementData(e,Xn.MESH_POSITION0)}},{key:"setPositions",value:function(e){if(!this._isReadable)throw"Mesh:setPosition() need isReadable must be true or use setVertices().";this._setVerticeElementData(e,Xn.MESH_POSITION0),this._needUpdateBounds=!0}},{key:"getColors",value:function(e){if(!this._isReadable)throw"Mesh:can't get colors on mesh,isReadable must be true.";this._getVerticeElementData(e,Xn.MESH_COLOR0)}},{key:"setColors",value:function(e){if(!this._isReadable)throw"Mesh:setColors() need isReadable must be true or use setVertices().";this._setVerticeElementData(e,Xn.MESH_COLOR0)}},{key:"getUVs",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;if(!this._isReadable)throw"Mesh:can't get uvs on mesh,isReadable must be true.";switch(t){case 0:this._getVerticeElementData(e,Xn.MESH_TEXTURECOORDINATE0);break;case 1:this._getVerticeElementData(e,Xn.MESH_TEXTURECOORDINATE1);break;default:throw"Mesh:Invalid channel."}}},{key:"setUVs",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;if(!this._isReadable)throw"Mesh:setUVs() need isReadable must be true or use setVertices().";switch(t){case 0:this._setVerticeElementData(e,Xn.MESH_TEXTURECOORDINATE0);break;case 1:this._setVerticeElementData(e,Xn.MESH_TEXTURECOORDINATE1);break;default:throw"Mesh:Invalid channel."}}},{key:"getNormals",value:function(e){if(!this._isReadable)throw"Mesh:can't get colors on mesh,isReadable must be true.";this._getVerticeElementData(e,Xn.MESH_NORMAL0)}},{key:"setNormals",value:function(e){if(!this._isReadable)throw"Mesh:setNormals() need must be true or use setVertices().";this._setVerticeElementData(e,Xn.MESH_NORMAL0)}},{key:"getTangents",value:function(e){if(!this._isReadable)throw"Mesh:can't get colors on mesh,isReadable must be true.";this._getVerticeElementData(e,Xn.MESH_TANGENT0)}},{key:"setTangents",value:function(e){if(!this._isReadable)throw"Mesh:setTangents() need isReadable must be true or use setVertices().";this._setVerticeElementData(e,Xn.MESH_TANGENT0)}},{key:"getBoneWeights",value:function(e){if(!this._isReadable)throw"Mesh:can't get boneWeights on mesh,isReadable must be true.";this._getVerticeElementData(e,Xn.MESH_BLENDWEIGHT0)}},{key:"setBoneWeights",value:function(e){if(!this._isReadable)throw"Mesh:setBoneWeights() need isReadable must be true or use setVertices().";this._setVerticeElementData(e,Xn.MESH_BLENDWEIGHT0)}},{key:"getBoneIndices",value:function(e){if(!this._isReadable)throw"Mesh:can't get boneIndices on mesh,isReadable must be true.";this._getVerticeElementData(e,Xn.MESH_BLENDINDICES0)}},{key:"setBoneIndices",value:function(e){if(!this._isReadable)throw"Mesh:setBoneIndices() need isReadable must be true or use setVertices().";this._setVerticeElementData(e,Xn.MESH_BLENDINDICES0)}},{key:"markAsUnreadbale",value:function(){this._uploadVerticesData(),this._vertexBuffer.markAsUnreadbale(),this._isReadable=!1}},{key:"getVertexDeclaration",value:function(){return this._vertexBuffer._vertexDeclaration}},{key:"getVertices",value:function(){if(this._isReadable)return this._vertexBuffer.getUint8Data().buffer.slice(0);throw"Mesh:can't get vertices on mesh,isReadable must be true."}},{key:"setVertices",value:function(e){this._vertexBuffer.setData(e),this._needUpdateBounds=!0}},{key:"getIndices",value:function(){if(this._isReadable)return this._indexBuffer.getData().slice();throw"Mesh:can't get indices on subMesh,mesh's isReadable must be true."}},{key:"setIndices",value:function(n){var i;n instanceof Uint32Array?i=e.IndexFormat.UInt32:n instanceof Uint16Array?i=e.IndexFormat.UInt16:n instanceof Uint8Array&&(i=e.IndexFormat.UInt8);var r=this._indexBuffer;this._indexFormat===i&&r.indexCount===n.length||(r.destroy(),this._indexBuffer=r=new Wn(i,n.length,t.LayaGL.instance.STATIC_DRAW,this._isReadable)),r.setData(n),this._indexFormat=i}},{key:"calculateBounds",value:function(){if(!this._isReadable)throw"Mesh:can't calculate bounds on subMesh,mesh's isReadable must be true.";if(this._needUpdateBounds){var e=this._tempVector30,t=this._tempVector31;e.x=e.y=e.z=Number.MAX_VALUE,t.x=t.y=t.z=-Number.MAX_VALUE;for(var n=this._vertexBuffer,i=this._getPositionElement(n),r=n.getFloat32Data(),a=n.vertexDeclaration.vertexStride/4,o=i._offset/4,s=0,l=r.length;s<l;s+=a){var u=s+o,_=r[u],c=r[u+1],h=r[u+2];e.x=Math.min(e.x,_),e.y=Math.min(e.y,c),e.z=Math.min(e.z,h),t.x=Math.max(t.x,_),t.y=Math.max(t.y,c),t.z=Math.max(t.z,h)}this._bounds.setMin(e),this._bounds.setMax(t),this._needUpdateBounds=!1}}},{key:"cloneTo",value:function(t){var n=t,i=this._vertexBuffer,r=new pn(i._byteLength,i.bufferUsage,i.canRead);r.vertexDeclaration=i.vertexDeclaration,r.setData(i.getUint8Data().slice().buffer),n._vertexBuffer=r,n._vertexCount=this._vertexCount;var a,o=this._indexBuffer,s=new Wn(e.IndexFormat.UInt16,o.indexCount,o.bufferUsage,o.canRead);s.setData(o.getData().slice()),n._indexBuffer=s,n._setBuffer(n._vertexBuffer,s),n._setInstanceBuffer(this._instanceBufferStateType),n._setCPUMemory(this.cpuMemory),n._setGPUMemory(this.gpuMemory);var l=this._boneNames;if(l){var u=n._boneNames=[];for(a=0;a<l.length;a++)u[a]=l[a]}var _=this._inverseBindPoses;if(_){var c=n._inverseBindPoses=[];for(a=0;a<_.length;a++)c[a]=_[a]}var h=this._skinnedMatrixCaches.length;for(n._skinnedMatrixCaches.length=h,a=0;a<h;a++){var d=this._skinnedMatrixCaches[a];n._skinnedMatrixCaches[a]=new ns(d.subMeshIndex,d.batchIndex,d.batchBoneIndex)}for(a=0;a<this.subMeshCount;a++){var f=this._subMeshes[a],m=f._subIndexBufferStart,p=f._subIndexBufferCount,v=f._boneIndicesList,E=new ts(n);E._subIndexBufferStart.length=m.length,E._subIndexBufferCount.length=p.length,E._boneIndicesList.length=v.length;for(var T=0;T<m.length;T++)E._subIndexBufferStart[T]=m[T];for(T=0;T<p.length;T++)E._subIndexBufferCount[T]=p[T];for(T=0;T<v.length;T++)E._boneIndicesList[T]=new Uint16Array(v[T]);E._indexBuffer=s,E._indexStart=f._indexStart,E._indexCount=f._indexCount,E._indices=new Uint16Array(s.getData().buffer,2*f._indexStart,f._indexCount);var g=n._vertexBuffer;E._vertexBuffer=g,n._subMeshes.push(E)}n._setSubMeshes(n._subMeshes)}},{key:"clone",value:function(){var e=new Dr;return this.cloneTo(e),e}},{key:"inverseAbsoluteBindPoses",get:function(){return this._inverseBindPoses}},{key:"vertexCount",get:function(){return this._vertexCount}},{key:"indexCount",get:function(){return this._indexBuffer.indexCount}},{key:"subMeshCount",get:function(){return this._subMeshes.length}},{key:"bounds",get:function(){return this._bounds},set:function(e){this._bounds!==e&&e.cloneTo(this._bounds)}},{key:"indexFormat",get:function(){return this._indexFormat}}],[{key:"__init__",value:function(){var e=Ct._bullet;e&&(Dr._nativeTempVector30=e.btVector3_create(0,0,0),Dr._nativeTempVector31=e.btVector3_create(0,0,0),Dr._nativeTempVector32=e.btVector3_create(0,0,0))}},{key:"load",value:function(e,n){t.ILaya.loader.create(e,n,null,Dr.MESH)}}]),Dr}();is.MESH="MESH",is.MESH_INSTANCEBUFFER_TYPE_NORMAL=0,is.MESH_INSTANCEBUFFER_TYPE_SIMPLEANIMATOR=1;var rs=function(){function Cr(){_classCallCheck(this,Cr)}return _createClass(Cr,null,[{key:"__init__",value:function(){}},{key:"_createMesh",value:function(n,i,r){var a=t.LayaGL.instance,o=new is,s=new ts(o),l=new pn(4*i.length,a.STATIC_DRAW,!0);l.vertexDeclaration=n,l.setData(i.buffer),o._vertexBuffer=l,o._vertexCount=l._byteLength/n.vertexStride;var u=new Wn(e.IndexFormat.UInt16,r.length,a.STATIC_DRAW,!0);u.setData(r),o._indexBuffer=u,o._setBuffer(l,u),o._setInstanceBuffer(o._instanceBufferStateType),s._vertexBuffer=l,s._indexBuffer=u,s._setIndexRange(0,u.indexCount);var _=s._subIndexBufferStart,c=s._subIndexBufferCount,h=s._boneIndicesList;_.length=1,c.length=1,h.length=1,_[0]=0,c[0]=u.indexCount;var d=[];d.push(s),o._setSubMeshes(d),o.calculateBounds();var f=l._byteLength+u._byteLength;return o._setCPUMemory(f),o._setGPUMemory(f),o}},{key:"createBox",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1,i=Xn.getVertexDeclaration("POSITION,NORMAL,UV"),r=e/2,a=t/2,o=n/2,s=new Float32Array([-r,a,-o,0,1,0,0,0,r,a,-o,0,1,0,1,0,r,a,o,0,1,0,1,1,-r,a,o,0,1,0,0,1,-r,-a,-o,0,-1,0,0,1,r,-a,-o,0,-1,0,1,1,r,-a,o,0,-1,0,1,0,-r,-a,o,0,-1,0,0,0,-r,a,-o,-1,0,0,0,0,-r,a,o,-1,0,0,1,0,-r,-a,o,-1,0,0,1,1,-r,-a,-o,-1,0,0,0,1,r,a,-o,1,0,0,1,0,r,a,o,1,0,0,0,0,r,-a,o,1,0,0,0,1,r,-a,-o,1,0,0,1,1,-r,a,o,0,0,1,0,0,r,a,o,0,0,1,1,0,r,-a,o,0,0,1,1,1,-r,-a,o,0,0,1,0,1,-r,a,-o,0,0,-1,1,0,r,a,-o,0,0,-1,0,0,r,-a,-o,0,0,-1,0,1,-r,-a,-o,0,0,-1,1,1]),l=new Uint16Array([0,1,2,2,3,0,4,7,6,6,5,4,8,9,10,10,11,8,12,15,14,14,13,12,16,17,18,18,19,16,20,23,22,22,21,20]);return Cr._createMesh(i,s,l)}},{key:"createCapsule",value:function(){var e,t,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:.5,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:2,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:16,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:32,o=(r+1)*(a+1)*2+2*(a+1),s=3*r*(a+1)*2*2+2*a*3,l=Xn.getVertexDeclaration("POSITION,NORMAL,UV"),u=l.vertexStride/4,_=new Float32Array(o*u),c=new Uint16Array(s),h=Math.PI/2/r,d=2*Math.PI/a,f=i/2-n,m=0,p=0,v=0,E=0,T=0,g=0;for(e=0;e<=r;e++)for(t=0;t<=a;t++)m=n*Math.cos(e*h)*Math.cos(t*d+Math.PI),p=n*Math.sin(e*h),v=n*Math.cos(e*h)*Math.sin(t*d+Math.PI),_[E++]=m,_[E++]=p+f,_[E++]=v,_[E++]=m,_[E++]=p,_[E++]=v,_[E++]=1-t/a,_[E++]=(1-e/r)*(Math.PI*n/2/(i+Math.PI*n)),e<r&&(c[T++]=e*(a+1)+t+(a+1),c[T++]=e*(a+1)+t,c[T++]=e*(a+1)+t+1,c[T++]=e*(a+1)+t+a,c[T++]=e*(a+1)+t,c[T++]=e*(a+1)+t+(a+1));for(g+=(r+1)*(a+1),e=0;e<=r;e++)for(t=0;t<=a;t++)m=n*Math.cos(e*h)*Math.cos(t*d+Math.PI),p=n*Math.sin(-e*h),v=n*Math.cos(e*h)*Math.sin(t*d+Math.PI),_[E++]=m,_[E++]=p-f,_[E++]=v,_[E++]=m,_[E++]=p,_[E++]=v,_[E++]=1-t/a,_[E++]=(e/r*(Math.PI*n/2)+(i+Math.PI*n/2))/(i+Math.PI*n),e<r&&(c[T++]=g+e*(a+1)+t,c[T++]=g+e*(a+1)+t+(a+1),c[T++]=g+e*(a+1)+t+1,c[T++]=g+e*(a+1)+t,c[T++]=g+e*(a+1)+t+a,c[T++]=g+e*(a+1)+t+(a+1));for(g+=(r+1)*(a+1),t=0;t<=a;t++)m=n*Math.cos(t*d+Math.PI),p=f,v=n*Math.sin(t*d+Math.PI),_[E++]=m,_[E+8*(a+1)-1]=m,_[E++]=p,_[E+8*(a+1)-1]=-p,_[E++]=v,_[E+8*(a+1)-1]=v,_[E++]=m,_[E+8*(a+1)-1]=m,_[E++]=0,_[E+8*(a+1)-1]=0,_[E++]=v,_[E+8*(a+1)-1]=v,_[E++]=1-1*t/a,_[E+8*(a+1)-1]=1-1*t/a,_[E++]=Math.PI*n/2/(i+Math.PI*n),_[E+8*(a+1)-1]=(Math.PI*n/2+i)/(i+Math.PI*n);for(t=0;t<a;t++)c[T++]=t+g+(a+1),c[T++]=t+g+1,c[T++]=t+g,c[T++]=t+g+(a+1),c[T++]=t+g+(a+1)+1,c[T++]=t+g+1;return g+=2*(a+1),Cr._createMesh(l,_,c)}},{key:"createCone",value:function(){for(var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:.5,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:32,r=i+1+1+2*(i+1),a=6*i+3*i,o=Xn.getVertexDeclaration("POSITION,NORMAL,UV"),s=o.vertexStride/4,l=new Float32Array(r*s),u=new Uint16Array(a),_=2*Math.PI/i,c=n/2,h=0,d=0,f=0,m=0,p=0,v=new D,E=new D(0,-1,0),T=new D(0,c,0),g=new D,y=new D,S=new Z,R=new D,C=0,A=0,I=0;I<=i;I++)h=I*_,f=Math.cos(h+Math.PI)*t,m=c,p=Math.sin(h+Math.PI)*t,l[C++]=0,l[C+8*(i+1)-1]=f,l[C++]=m,l[C+8*(i+1)-1]=-m,l[C++]=0,l[C+8*(i+1)-1]=p,v.x=f,v.y=0,v.z=p,g.x=f,g.y=-m,g.z=p,D.subtract(g,T,y),D.normalize(y,y),e=Math.acos(D.dot(E,y)),D.cross(E,y,R),D.normalize(R,R),Z.createFromAxisAngle(R,e,S),D.normalize(v,v),D.transformQuat(v,S,v),D.normalize(v,v),l[C++]=v.x,l[C+8*(i+1)-1]=v.x,l[C++]=v.y,l[C+8*(i+1)-1]=v.y,l[C++]=v.z,l[C+8*(i+1)-1]=v.z,l[C++]=1-1*I/i,l[C+8*(i+1)-1]=1-1*I/i,l[C++]=0,l[C+8*(i+1)-1]=1;C+=8*(i+1);for(var x=0;x<i;x++)u[A++]=x+d+(i+1),u[A++]=x+d+1,u[A++]=x+d,u[A++]=x+d+(i+1),u[A++]=x+d+(i+1)+1,u[A++]=x+d+1;d+=2*(i+1);for(var M=0;M<=i;M++)0===M&&(l[C++]=0,l[C++]=-c,l[C++]=0,l[C++]=0,l[C++]=-1,l[C++]=0,l[C++]=.5,l[C++]=.5),h=M*_,f=Math.cos(h+Math.PI)*t,m=-c,p=Math.sin(h+Math.PI)*t,l[C++]=f,l[C++]=m,l[C++]=p,l[C++]=0,l[C++]=-1,l[C++]=0,l[C++]=.5+.5*Math.cos(h),l[C++]=.5+.5*Math.sin(h);for(var L=0;L<i;L++)u[A++]=0+d,u[A++]=L+2+d,u[A++]=L+1+d;return d+=i+1+1,Cr._createMesh(o,l,u)}},{key:"createCylinder",value:function(){for(var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:.5,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:2,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:32,i=n+1+1+2*(n+1)+(n+1+1),r=3*n+6*n+3*n,a=Xn.getVertexDeclaration("POSITION,NORMAL,UV"),o=a.vertexStride/4,s=new Float32Array(i*o),l=new Uint16Array(r),u=2*Math.PI/n,_=t/2,c=0,h=0,d=0,f=0,m=0,p=0,v=0,E=0;E<=n;E++)0===E&&(s[p++]=0,s[p++]=_,s[p++]=0,s[p++]=0,s[p++]=1,s[p++]=0,s[p++]=.5,s[p++]=.5),c=E*u,d=Math.cos(c)*e,f=_,m=Math.sin(c)*e,s[p++]=d,s[p++]=f,s[p++]=m,s[p++]=0,s[p++]=1,s[p++]=0,s[p++]=.5+.5*Math.cos(c),s[p++]=.5+.5*Math.sin(c);for(var T=0;T<n;T++)l[v++]=0,l[v++]=T+1,l[v++]=T+2;h+=n+1+1;for(var g=0;g<=n;g++)c=g*u,d=Math.cos(c+Math.PI)*e,f=_,m=Math.sin(c+Math.PI)*e,s[p++]=d,s[p+8*(n+1)-1]=d,s[p++]=f,s[p+8*(n+1)-1]=-f,s[p++]=m,s[p+8*(n+1)-1]=m,s[p++]=d,s[p+8*(n+1)-1]=d,s[p++]=0,s[p+8*(n+1)-1]=0,s[p++]=m,s[p+8*(n+1)-1]=m,s[p++]=1-1*g/n,s[p+8*(n+1)-1]=1-1*g/n,s[p++]=0,s[p+8*(n+1)-1]=1;p+=8*(n+1);for(var y=0;y<n;y++)l[v++]=y+h+(n+1),l[v++]=y+h+1,l[v++]=y+h,l[v++]=y+h+(n+1),l[v++]=y+h+(n+1)+1,l[v++]=y+h+1;h+=2*(n+1);for(var S=0;S<=n;S++)0===S&&(s[p++]=0,s[p++]=-_,s[p++]=0,s[p++]=0,s[p++]=-1,s[p++]=0,s[p++]=.5,s[p++]=.5),c=S*u,d=Math.cos(c+Math.PI)*e,f=-_,m=Math.sin(c+Math.PI)*e,s[p++]=d,s[p++]=f,s[p++]=m,s[p++]=0,s[p++]=-1,s[p++]=0,s[p++]=.5+.5*Math.cos(c),s[p++]=.5+.5*Math.sin(c);for(var R=0;R<n;R++)l[v++]=0+h,l[v++]=R+2+h,l[v++]=R+1+h;return h+=n+1+1,Cr._createMesh(a,s,l)}},{key:"createPlane",value:function(){for(var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:10,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:10,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:10,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:10,r=(n+1)*(i+1),a=new Uint16Array(n*i*2*3),o=Xn.getVertexDeclaration("POSITION,NORMAL,UV"),s=o.vertexStride/4,l=new Float32Array(r*s),u=e/2,_=t/2,c=e/n,h=t/i,d=0,f=0;f<=i;f++)for(var m=0;m<=n;m++)l[d++]=m*c-u,l[d++]=0,l[d++]=f*h-_,l[d++]=0,l[d++]=1,l[d++]=0,l[d++]=1*m/n,l[d++]=1*f/i;var p=0;for(f=0;f<i;f++)for(m=0;m<n;m++)a[p++]=(f+1)*(n+1)+m,a[p++]=f*(n+1)+m,a[p++]=(f+1)*(n+1)+m+1,a[p++]=f*(n+1)+m,a[p++]=f*(n+1)+m+1,a[p++]=(f+1)*(n+1)+m+1;return Cr._createMesh(o,l,a)}},{key:"createQuad",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,n=Xn.getVertexDeclaration("POSITION,NORMAL,UV"),i=e/2,r=t/2,a=new Float32Array([-i,r,0,0,0,1,0,0,i,r,0,0,0,1,1,0,-i,-r,0,0,0,1,0,1,i,-r,0,0,0,1,1,1]),o=new Uint16Array([0,1,2,3,2,1]);return Cr._createMesh(n,a,o)}},{key:"createSphere",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:.5,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:32,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:32,i=(t+1)*(n+1),r=3*t*(n+1)*2,a=new Uint16Array(r),o=Xn.getVertexDeclaration("POSITION,NORMAL,UV"),s=o.vertexStride/4,l=new Float32Array(i*s),u=Math.PI/t,_=2*Math.PI/n,c=0;i=0,r=0;for(var h=0;h<t+1;h++)for(var d=Math.sin(h*u),f=Math.cos(h*u),m=0;m<n+1;m++){var p=d*Math.sin(m*_+1*Math.PI/2),v=d*Math.cos(m*_+1*Math.PI/2);l[i+0]=p*e,l[i+1]=f*e,l[i+2]=v*e,l[i+3]=p,l[i+4]=f,l[i+5]=v,l[i+6]=m/n,l[i+7]=h/t,i+=s,h!=t-1&&(a[r++]=c+(n+1),a[r++]=c,a[r++]=c+1,a[r++]=c+n,a[r++]=c,a[r++]=c+(n+1),c++)}return Cr._createMesh(o,l,a)}}]),Cr}(),as='#include "Lighting.glsl";\n#if defined(GL_FRAGMENT_PRECISION_HIGH)//ifdefined\n\tprecision highp float;\n#else\n\tprecision mediump float;\n#endif\nattribute vec4 a_PositionTexcoord;\nvarying vec2 v_Texcoord0;\n\nvoid main() {\n\tgl_Position = vec4(a_PositionTexcoord.xy, 0.0, 1.0);\n\tv_Texcoord0 = a_PositionTexcoord.zw;\n\tgl_Position = remapGLPositionZ(gl_Position);\n}',os=function(){function yr(){_classCallCheck(this,yr)}return _createClass(yr,null,[{key:"__init__",value:function(){xn.SHADERDEFINE_LEGACYSINGALLIGHTING=xn.getDefineByName("LEGACYSINGLELIGHTING"),xn.SHADERDEFINE_GRAPHICS_API_GLES2=xn.getDefineByName("GRAPHICS_API_GLES2"),xn.SHADERDEFINE_GRAPHICS_API_GLES3=xn.getDefineByName("GRAPHICS_API_GLES3"),xn.addInclude("Lighting.glsl","#ifdef GRAPHICS_API_GLES3\n\t#define INVERSE_MAT(mat) inverse(mat)\n#else\n\t#define INVERSE_MAT(mat) inverseMat(mat)\n#endif\n\nstruct DirectionLight {\n\tvec3 color;\n\tvec3 direction;\n};\n\nstruct PointLight {\n\tvec3 color;\n\tvec3 position;\n\tfloat range;\n};\n\nstruct SpotLight {\n\tvec3 color;\n\tvec3 position;\n\tfloat range;\n\tvec3 direction;\n\tfloat spot;\n};\n\nstruct LayaGI{\n\tvec3 diffuse;\n\tvec3 specular;\n};\n\nstruct LayaLight{\n\tvec3 color;\n\tvec3 dir;\n};\n\nconst int c_ClusterBufferWidth = CLUSTER_X_COUNT*CLUSTER_Y_COUNT;\nconst int c_ClusterBufferHeight = CLUSTER_Z_COUNT*(1+int(ceil(float(MAX_LIGHT_COUNT_PER_CLUSTER)/4.0)));\nconst int c_ClusterBufferFloatWidth = c_ClusterBufferWidth*4;\n\n#ifndef GRAPHICS_API_GLES3\n\tmat3 inverseMat(mat3 m) {\n\t\tfloat a00 = m[0][0], a01 = m[0][1], a02 = m[0][2];\n\t\tfloat a10 = m[1][0], a11 = m[1][1], a12 = m[1][2];\n\t\tfloat a20 = m[2][0], a21 = m[2][1], a22 = m[2][2];\n\n\t\tfloat b01 = a22 * a11 - a12 * a21;\n\t\tfloat b11 = -a22 * a10 + a12 * a20;\n\t\tfloat b21 = a21 * a10 - a11 * a20;\n\n\t\tfloat det = a00 * b01 + a01 * b11 + a02 * b21;\n\n\t\treturn mat3(b01, (-a22 * a01 + a02 * a21), (a12 * a01 - a02 * a11),\n\t\t\t\t\tb11, (a22 * a00 - a02 * a20), (-a12 * a00 + a02 * a10),\n\t\t\t\t\tb21, (-a21 * a00 + a01 * a20), (a11 * a00 - a01 * a10)) / det;\n\t}\n#endif\n\n\t#ifdef THICKNESSMAP\n\t\tuniform sampler2D u_ThinknessTexture;\n\t#endif\n#ifdef ENABLETRANSMISSION\n\tuniform float u_TransmissionRate;\n\tuniform float u_BackDiffuse;\n\tuniform float u_BackScale;\n\tuniform vec4 u_TransmissionColor;\n\n\n\tvec3 SubSurfaceIBack(vec3 lightDir,vec3 viewDir,float thinknessFactor){\n\t\tvec3 H = normalize(lightDir);\n\t\tfloat VdotH = pow(clamp(dot(viewDir,H),0.0,1.0),u_BackDiffuse)*u_BackScale;\n\t\tvec3 I;\n\t\t#ifdef THICKNESSMAP\n\t\t\tI = u_TransmissionColor.rgb*VdotH*thinknessFactor;\n\t\t#else\n\t\t\tI = u_TransmissionColor.rgb*VdotH;\n\t\t#endif\n\t\treturn I;\n\t}\n#endif\n\nivec4 getClusterInfo(sampler2D clusterBuffer,mat4 viewMatrix,vec4 viewport,vec3 position,vec4 fragCoord,vec4 projectParams)\n{\n\tvec3 viewPos = vec3(viewMatrix*vec4(position, 1.0)); //position in viewspace\n\n\tint clusterXIndex = int(floor(fragCoord.x/ (float(viewport.z)/float(CLUSTER_X_COUNT))));\n    int clusterYIndex = int(floor((viewport.w * (projectParams.z <0.0? 0.0 : 1.0) - fragCoord.y * projectParams.z)/ (float(viewport.w)/float(CLUSTER_Y_COUNT))));//Maybe Flipped ProjectMatrix\n\tfloat zSliceParam =float(CLUSTER_Z_COUNT)/log2(projectParams.y / projectParams.x);\n \tint clusterZIndex = int(floor(log2(-viewPos.z) * zSliceParam- log2(projectParams.x) * zSliceParam));//projectParams x:cameraNear y:cameraFar\n\n\tvec2 uv= vec2((float(clusterXIndex + clusterYIndex * CLUSTER_X_COUNT)+0.5)/float(c_ClusterBufferWidth),\n\t\t\t\t(float(clusterZIndex)+0.5)/float(c_ClusterBufferHeight));\n\tvec4 clusterPixel=texture2D(clusterBuffer, uv);\n\treturn ivec4(clusterPixel);//X:Point Count Y:Spot Count ZW:Light Offset\n}\n\n\nint getLightIndex(sampler2D clusterBuffer,int offset,int index) \n{\n\tint totalOffset=offset+index;\n\tint row=totalOffset/c_ClusterBufferFloatWidth;\n\tint lastRowFloat=totalOffset-row*c_ClusterBufferFloatWidth;\n\tint col=lastRowFloat/4;\n\tvec2 uv=vec2((float(col)+0.5)/float(c_ClusterBufferWidth),\n\t\t\t\t(float(row)+0.5)/float(c_ClusterBufferHeight));\n\tvec4 texel = texture2D(clusterBuffer, uv);\n    int pixelComponent = lastRowFloat-col*4;\n    if (pixelComponent == 0) \n      return int(texel.x);\n    else if (pixelComponent == 1) \n      return int(texel.y);\n    else if (pixelComponent == 2) \n      return int(texel.z);\n    else //pixelComponent==3\n      return int(texel.w);\n}\n\nDirectionLight getDirectionLight(sampler2D lightBuffer,int index) \n{\n    DirectionLight light;\n    float v = (float(index)+0.5)/ float(MAX_LIGHT_COUNT);\n    vec4 p1 = texture2D(lightBuffer, vec2(0.125,v));\n    vec4 p2 = texture2D(lightBuffer, vec2(0.375,v));\n\tlight.color=p1.rgb;\n    light.direction = p2.rgb;\n    return light;\n}\n\nPointLight getPointLight(sampler2D lightBuffer,sampler2D clusterBuffer,ivec4 clusterInfo,int index) \n{\n    PointLight light;\n\tint pointIndex=getLightIndex(clusterBuffer,clusterInfo.z*c_ClusterBufferFloatWidth+clusterInfo.w,index);\n    float v = (float(pointIndex)+0.5)/ float(MAX_LIGHT_COUNT);\n    vec4 p1 = texture2D(lightBuffer, vec2(0.125,v));\n    vec4 p2 = texture2D(lightBuffer, vec2(0.375,v));\n\tlight.color=p1.rgb;\n\tlight.range = p1.a;\n    light.position = p2.rgb;\n    return light;\n}\n\nSpotLight getSpotLight(sampler2D lightBuffer,sampler2D clusterBuffer,ivec4 clusterInfo,int index) \n{\n    SpotLight light;\n\tint spoIndex=getLightIndex(clusterBuffer,clusterInfo.z*c_ClusterBufferFloatWidth+clusterInfo.w,clusterInfo.x+index);\n    float v = (float(spoIndex)+0.5)/ float(MAX_LIGHT_COUNT);\n    vec4 p1 = texture2D(lightBuffer, vec2(0.125,v));\n    vec4 p2 = texture2D(lightBuffer, vec2(0.375,v));\n\tvec4 p3 = texture2D(lightBuffer, vec2(0.625,v));\n    light.color = p1.rgb;\n\tlight.range=p1.a;\n    light.position = p2.rgb;\n\tlight.spot = p2.a;\n\tlight.direction = p3.rgb;\n    return light;\n}\n\n// Laya\nfloat LayaAttenuation(in vec3 L,in float invLightRadius) {\n\tfloat fRatio = clamp(length(L) * invLightRadius,0.0,1.0);\n\tfRatio *= fRatio;\n\treturn 1.0 / (1.0 + 25.0 * fRatio)* clamp(4.0*(1.0 - fRatio),0.0,1.0); //fade to black as if 4 pixel texture\n}\n\n// Same as Just Cause 2 and Crysis 2 (you can read GPU Pro 1 book for more information)\nfloat BasicAttenuation(in vec3 L,in float invLightRadius) {\n\tvec3 distance = L * invLightRadius;\n\tfloat attenuation = clamp(1.0 - dot(distance, distance),0.0,1.0); // Equals float attenuation = saturate(1.0f - dot(L, L) / (lightRadius *  lightRadius));\n\treturn attenuation * attenuation;\n}\n\n// Inspired on http://fools.slindev.com/viewtopic.php?f=11&t=21&view=unread#unread\nfloat NaturalAttenuation(in vec3 L,in float invLightRadius) {\n\tfloat attenuationFactor = 30.0;\n\tvec3 distance = L * invLightRadius;\n\tfloat attenuation = dot(distance, distance); // Equals float attenuation = dot(L, L) / (lightRadius *  lightRadius);\n\tattenuation = 1.0 / (attenuation * attenuationFactor + 1.0);\n\t// Second we move down the function therewith it reaches zero at abscissa 1:\n\tattenuationFactor = 1.0 / (attenuationFactor + 1.0); //attenuationFactor contains now the value we have to subtract\n\tattenuation = max(attenuation - attenuationFactor, 0.0); // The max fixes a bug.\n\t// Finally we expand the equation along the y-axis so that it starts with a function value of 1 again.\n\tattenuation /= 1.0 - attenuationFactor;\n\treturn attenuation;\n}\n\nvoid LayaAirBlinnPhongLight (in vec3 specColor,in float specColorIntensity,in vec3 normal,in vec3 gloss, in vec3 viewDir,in vec3 lightColor, in vec3 lightVec,out vec3 diffuseColor,out vec3 specularColor) {\n\tmediump vec3 h = normalize(viewDir-lightVec);\n\tlowp float ln = max (0.0, dot (-lightVec,normal));\n\tfloat nh = max (0.0, dot (h,normal));\n\tdiffuseColor=lightColor * ln;\n\tspecularColor=lightColor *specColor*pow (nh, specColorIntensity*128.0) * gloss;\n}\n\nvoid LayaAirBlinnPhongDiectionLight (in vec3 specColor,in float specColorIntensity,in vec3 normal,in vec3 gloss, in vec3 viewDir, in DirectionLight light,float thinknessFactor,out vec3 diffuseColor,out vec3 specularColor,out vec3 transmisColor) {\n\tvec3 lightVec=normalize(light.direction);\n\tLayaAirBlinnPhongLight(specColor,specColorIntensity,normal,gloss,viewDir,light.color,lightVec,diffuseColor,specularColor);\n\t#ifdef ENABLETRANSMISSION\n\t\tdiffuseColor *= u_TransmissionRate;\n\t\ttransmisColor = SubSurfaceIBack(lightVec, viewDir,thinknessFactor)*light.color.rgb*(1.0-u_TransmissionRate);\n\t#endif\n}\n\n\nvoid LayaAirBlinnPhongDiectionLight (in vec3 specColor,in float specColorIntensity,in vec3 normal,in vec3 gloss, in vec3 viewDir, in DirectionLight light,out vec3 diffuseColor,out vec3 specularColor) {\n\tvec3 lightVec=normalize(light.direction);\n\tLayaAirBlinnPhongLight(specColor,specColorIntensity,normal,gloss,viewDir,light.color,lightVec,diffuseColor,specularColor);\n}\n\n\nvoid LayaAirBlinnPhongPointLight (in vec3 pos,in vec3 specColor,in float specColorIntensity,in vec3 normal,in vec3 gloss, in vec3 viewDir, in PointLight light,float thinknessFactor,out vec3 diffuseColor,out vec3 specularColor,out vec3 transmisColor) {\n\tvec3 lightVec =  pos-light.position;\n\tLayaAirBlinnPhongLight(specColor,specColorIntensity,normal,gloss,viewDir,light.color,lightVec/length(lightVec),diffuseColor,specularColor);\n\tfloat attenuate = LayaAttenuation(lightVec, 1.0/light.range);\n\tdiffuseColor *= attenuate;\n\tspecularColor*= attenuate;\n\t#ifdef ENABLETRANSMISSION\n\t\tdiffuseColor *= u_TransmissionRate;\n\t\ttransmisColor = SubSurfaceIBack(lightVec, viewDir,thinknessFactor)*light.color.rgb*(1.0-u_TransmissionRate)*attenuate;\n\t#endif\n}\n\nvoid LayaAirBlinnPhongPointLight (in vec3 pos,in vec3 specColor,in float specColorIntensity,in vec3 normal,in vec3 gloss, in vec3 viewDir, in PointLight light,out vec3 diffuseColor,out vec3 specularColor) {\n\tvec3 lightVec =  pos-light.position;\n\tLayaAirBlinnPhongLight(specColor,specColorIntensity,normal,gloss,viewDir,light.color,lightVec/length(lightVec),diffuseColor,specularColor);\n\tfloat attenuate = LayaAttenuation(lightVec, 1.0/light.range);\n\tdiffuseColor *= attenuate;\n\tspecularColor*= attenuate;\n}\n\nvoid LayaAirBlinnPhongSpotLight (in vec3 pos,in vec3 specColor,in float specColorIntensity,in vec3 normal,in vec3 gloss, in vec3 viewDir, in SpotLight light,float thinknessFactor,out vec3 diffuseColor,out vec3 specularColor,out vec3 transmisColor) {\n\tvec3 lightVec =  pos-light.position;\n\tvec3 normalLightVec=lightVec/length(lightVec);\n\tLayaAirBlinnPhongLight(specColor,specColorIntensity,normal,gloss,viewDir,light.color,normalLightVec,diffuseColor,specularColor);\n\tvec2 cosAngles=cos(vec2(light.spot,light.spot*0.5)*0.5);//ConeAttenuation\n\tfloat dl=dot(normalize(light.direction),normalLightVec);\n\tdl*=smoothstep(cosAngles[0],cosAngles[1],dl);\n\tfloat attenuate = LayaAttenuation(lightVec, 1.0/light.range)*dl;\n\tdiffuseColor *=attenuate;\n\tspecularColor *=attenuate;\n\t#ifdef ENABLETRANSMISSION\n\t\tdiffuseColor *= u_TransmissionRate;\n\t\ttransmisColor = SubSurfaceIBack(lightVec, viewDir,thinknessFactor)*light.color.rgb*(1.0-u_TransmissionRate)*attenuate;\n\t#endif\n}\n\nvoid LayaAirBlinnPhongSpotLight (in vec3 pos,in vec3 specColor,in float specColorIntensity,in vec3 normal,in vec3 gloss, in vec3 viewDir, in SpotLight light,out vec3 diffuseColor,out vec3 specularColor) {\n\tvec3 lightVec =  pos-light.position;\n\tvec3 normalLightVec=lightVec/length(lightVec);\n\tLayaAirBlinnPhongLight(specColor,specColorIntensity,normal,gloss,viewDir,light.color,normalLightVec,diffuseColor,specularColor);\n\tvec2 cosAngles=cos(vec2(light.spot,light.spot*0.5)*0.5);//ConeAttenuation\n\tfloat dl=dot(normalize(light.direction),normalLightVec);\n\tdl*=smoothstep(cosAngles[0],cosAngles[1],dl);\n\tfloat attenuate = LayaAttenuation(lightVec, 1.0/light.range)*dl;\n\tdiffuseColor *=attenuate;\n\tspecularColor *=attenuate;\n}\n\n\n\n\nvec3 NormalSampleToWorldSpace(vec3 normalMapSample, vec3 unitNormal, vec3 tangent,vec3 binormal) {\n\tvec3 normalT =vec3(2.0*normalMapSample.x - 1.0,1.0-2.0*normalMapSample.y,2.0*normalMapSample.z - 1.0);\n\tmediump vec3 N = unitNormal;\n\tmediump vec3 T = tangent;\n\tmediump vec3 B = binormal;\n\tmat3 TBN = mat3(T, B, N);\n\n\t// Transform from tangent space to world space.\n\tvec3 bumpedNormal =normalize(TBN*normalT);\n\treturn bumpedNormal;\n}\n\nvec3 NormalSampleToWorldSpace1(vec4 normalMapSample, vec3 tangent, vec3 binormal, vec3 unitNormal) {\n\tvec3 normalT;\n\tnormalT.x = 2.0 * normalMapSample.x - 1.0;\n\tnormalT.y = 1.0 - 2.0 * normalMapSample.y;\n\tnormalT.z = sqrt(1.0 - clamp(dot(normalT.xy, normalT.xy), 0.0, 1.0));\n\n\tvec3 T = normalize(tangent);\n\tvec3 B = normalize(binormal);\n\tvec3 N = normalize(unitNormal);\n\tmat3 TBN = mat3(T, B, N);\n\n\t// Transform from tangent space to world space.\n\tvec3 bumpedNormal = TBN * normalize(normalT);\n\n\treturn bumpedNormal;\n}\n\nvec3 DecodeLightmap(vec4 color) {\n\treturn color.rgb*color.a*5.0;\n}\n\nvec3 decodeHDR(vec4 color,float range) {\n\treturn color.rgb*color.a*range;\n}\n\nvec2 TransformUV(vec2 texcoord,vec4 tilingOffset) {\n\tvec2 transTexcoord=vec2(texcoord.x,texcoord.y-1.0)*tilingOffset.xy+vec2(tilingOffset.z,-tilingOffset.w);\n\ttransTexcoord.y+=1.0;\n\treturn transTexcoord;\n}\n\nvec4 remapGLPositionZ(vec4 position) {\n\tposition.z=position.z * 2.0 - position.w;\n\treturn position;\n}\n\nmediump vec3 layaLinearToGammaSpace (mediump vec3 linRGB)\n{\n    linRGB = max(linRGB, vec3(0.0));\n    // An almost-perfect approximation from http://chilliant.blogspot.com.au/2012/08/srgb-approximations-for-hlsl.html?m=1\n    return max(1.055 * pow(linRGB,vec3(0.416666667)) - 0.055, 0.0);   \n}\n\nLayaLight layaDirectionLightToLight(in DirectionLight light,in float attenuate)\n{\n\tLayaLight relight;\n\trelight.color = light.color*attenuate;\n\trelight.dir = light.direction;\n\treturn relight;\n}\n\nLayaLight layaPointLightToLight(in vec3 pos,in vec3 normal, in PointLight light,in float attenuate)\n{\n\tLayaLight relight;\n\tvec3 lightVec =  pos-light.position;\n\tattenuate *= LayaAttenuation(lightVec, 1.0/light.range);\n\trelight.color = light.color*attenuate;\n\trelight.dir = normalize(lightVec);\n\treturn relight;\n}\n\nLayaLight layaSpotLightToLight(in vec3 pos,in vec3 normal, in SpotLight light,in float attenuate)\n{\n\tLayaLight relight;\n\tvec3 lightVec =  pos-light.position;\n\tvec3 normalLightVec=lightVec/length(lightVec);\n\tvec2 cosAngles=cos(vec2(light.spot,light.spot*0.5)*0.5);//ConeAttenuation\n\tfloat dl=dot(normalize(light.direction),normalLightVec);\n\tdl*=smoothstep(cosAngles[0],cosAngles[1],dl);\n\tattenuate *= LayaAttenuation(lightVec, 1.0/light.range)*dl;\n\trelight.dir = normalLightVec;\n\trelight.color = light.color*attenuate;\n\treturn relight;\n}\n\n\n\n\n"),xn.addInclude("ShadowSampleTent.glsl",'// ------------------------------------------------------------------\n//  PCF Filtering Tent Functions\n// ------------------------------------------------------------------\n\n// Assuming a isoceles right angled triangle of height "triangleHeight" (as drawn below).\n// This function return the area of the triangle above the first texel(in Y the first texel).\n//\n// |\\      <-- 45 degree slop isosceles right angled triangle\n// | \\\n// ----    <-- length of this side is "triangleHeight"\n// _ _ _ _ <-- texels\nfloat sampleShadowGetIRTriangleTexelArea(float triangleHeight)\n{\n    return triangleHeight - 0.5;\n}\n\n// Assuming a isoceles triangle of 1.5 texels height and 3 texels wide lying on 4 texels.\n// This function return the area of the triangle above each of those texels.\n//    |    <-- offset from -0.5 to 0.5, 0 meaning triangle is exactly in the center\n//   / \\   <-- 45 degree slop isosceles triangle (ie tent projected in 2D)\n//  /   \\\n// _ _ _ _ <-- texels\n// X Y Z W <-- result indices (in computedArea.xyzw and computedAreaUncut.xyzw)\n// Top point at (right,top) in a texel,left bottom point at (middle,middle) in a texel,right bottom point at (middle,middle) in a texel.\nvoid sampleShadowGetTexelAreasTent3x3(float offset, out vec4 computedArea, out vec4 computedAreaUncut)\n{\n    // Compute the exterior areas,a and h is same.\n    float a = offset + 0.5;\n    float offsetSquaredHalved = a * a * 0.5;\n    computedAreaUncut.x = computedArea.x = offsetSquaredHalved - offset;\n    computedAreaUncut.w = computedArea.w = offsetSquaredHalved;\n\n    // Compute the middle areas\n    // For Y : We find the area in Y of as if the left section of the isoceles triangle would\n    // intersect the axis between Y and Z (ie where offset = 0).\n    computedAreaUncut.y = sampleShadowGetIRTriangleTexelArea(1.5 - offset);\n    // This area is superior to the one we are looking for if (offset < 0) thus we need to\n    // subtract the area of the triangle defined by (0,1.5-offset), (0,1.5+offset), (-offset,1.5).\n    float clampedOffsetLeft = min(offset,0.0);\n    float areaOfSmallLeftTriangle = clampedOffsetLeft * clampedOffsetLeft;\n    computedArea.y = computedAreaUncut.y - areaOfSmallLeftTriangle;\n\n    // We do the same for the Z but with the right part of the isoceles triangle\n    computedAreaUncut.z = sampleShadowGetIRTriangleTexelArea(1.5 + offset);\n    float clampedOffsetRight = max(offset,0.0);\n    float areaOfSmallRightTriangle = clampedOffsetRight * clampedOffsetRight;\n    computedArea.z = computedAreaUncut.z - areaOfSmallRightTriangle;\n}\n\n// Assuming a isoceles triangle of 2.5 texel height and 5 texels wide lying on 6 texels.\n// This function return the weight of each texels area relative to the full triangle area.\n//  /       \\\n// _ _ _ _ _ _ <-- texels\n// 0 1 2 3 4 5 <-- computed area indices (in texelsWeights[])\n// Top point at (right,top) in a texel,left bottom point at (middle,middle) in a texel,right bottom point at (middle,middle) in a texel.\nvoid sampleShadowGetTexelWeightsTent5x5(float offset, out vec3 texelsWeightsA, out vec3 texelsWeightsB)\n{\n    vec4 areaFrom3texelTriangle;\n    vec4 areaUncutFrom3texelTriangle;\n    sampleShadowGetTexelAreasTent3x3(offset, areaFrom3texelTriangle, areaUncutFrom3texelTriangle);\n\n    // Triangle slope is 45 degree thus we can almost reuse the result of the 3 texel wide computation.\n    // the 5 texel wide triangle can be seen as the 3 texel wide one but shifted up by one unit/texel.\n    // 0.16 is 1/(the triangle area)\n    texelsWeightsA.x = 0.16 * (areaFrom3texelTriangle.x);\n    texelsWeightsA.y = 0.16 * (areaUncutFrom3texelTriangle.y);\n    texelsWeightsA.z = 0.16 * (areaFrom3texelTriangle.y + 1.0);\n    texelsWeightsB.x = 0.16 * (areaFrom3texelTriangle.z + 1.0);\n    texelsWeightsB.y = 0.16 * (areaUncutFrom3texelTriangle.z);\n    texelsWeightsB.z = 0.16 * (areaFrom3texelTriangle.w);\n}\n\n// 5x5 Tent filter (45 degree sloped triangles in U and V)\nvoid sampleShadowComputeSamplesTent5x5(vec4 shadowMapTextureTexelSize, vec2 coord, out float fetchesWeights[9], out vec2 fetchesUV[9])\n{\n    // tent base is 5x5 base thus covering from 25 to 36 texels, thus we need 9 bilinear PCF fetches\n    vec2 tentCenterInTexelSpace = coord.xy * shadowMapTextureTexelSize.zw;\n    vec2 centerOfFetchesInTexelSpace = floor(tentCenterInTexelSpace + 0.5);\n    vec2 offsetFromTentCenterToCenterOfFetches = tentCenterInTexelSpace - centerOfFetchesInTexelSpace;\n\n    // find the weight of each texel based on the area of a 45 degree slop tent above each of them.\n    vec3 texelsWeightsUA, texelsWeightsUB;\n    vec3 texelsWeightsVA, texelsWeightsVB;\n    sampleShadowGetTexelWeightsTent5x5(offsetFromTentCenterToCenterOfFetches.x, texelsWeightsUA, texelsWeightsUB);\n    sampleShadowGetTexelWeightsTent5x5(offsetFromTentCenterToCenterOfFetches.y, texelsWeightsVA, texelsWeightsVB);\n\n    // each fetch will cover a group of 2x2 texels, the weight of each group is the sum of the weights of the texels\n    vec3 fetchesWeightsU = vec3(texelsWeightsUA.xz, texelsWeightsUB.y) + vec3(texelsWeightsUA.y, texelsWeightsUB.xz);\n    vec3 fetchesWeightsV = vec3(texelsWeightsVA.xz, texelsWeightsVB.y) + vec3(texelsWeightsVA.y, texelsWeightsVB.xz);\n\n    // move the PCF bilinear fetches to respect texels weights\n    vec3 fetchesOffsetsU = vec3(texelsWeightsUA.y, texelsWeightsUB.xz) / fetchesWeightsU.xyz + vec3(-2.5,-0.5,1.5);\n    vec3 fetchesOffsetsV = vec3(texelsWeightsVA.y, texelsWeightsVB.xz) / fetchesWeightsV.xyz + vec3(-2.5,-0.5,1.5);\n    fetchesOffsetsU *= shadowMapTextureTexelSize.xxx;\n    fetchesOffsetsV *= shadowMapTextureTexelSize.yyy;\n\n    vec2 bilinearFetchOrigin = centerOfFetchesInTexelSpace * shadowMapTextureTexelSize.xy;\n    fetchesUV[0] = bilinearFetchOrigin + vec2(fetchesOffsetsU.x, fetchesOffsetsV.x);\n    fetchesUV[1] = bilinearFetchOrigin + vec2(fetchesOffsetsU.y, fetchesOffsetsV.x);\n    fetchesUV[2] = bilinearFetchOrigin + vec2(fetchesOffsetsU.z, fetchesOffsetsV.x);\n    fetchesUV[3] = bilinearFetchOrigin + vec2(fetchesOffsetsU.x, fetchesOffsetsV.y);\n    fetchesUV[4] = bilinearFetchOrigin + vec2(fetchesOffsetsU.y, fetchesOffsetsV.y);\n    fetchesUV[5] = bilinearFetchOrigin + vec2(fetchesOffsetsU.z, fetchesOffsetsV.y);\n    fetchesUV[6] = bilinearFetchOrigin + vec2(fetchesOffsetsU.x, fetchesOffsetsV.z);\n    fetchesUV[7] = bilinearFetchOrigin + vec2(fetchesOffsetsU.y, fetchesOffsetsV.z);\n    fetchesUV[8] = bilinearFetchOrigin + vec2(fetchesOffsetsU.z, fetchesOffsetsV.z);\n\n    fetchesWeights[0] = fetchesWeightsU.x * fetchesWeightsV.x;\n    fetchesWeights[1] = fetchesWeightsU.y * fetchesWeightsV.x;\n    fetchesWeights[2] = fetchesWeightsU.z * fetchesWeightsV.x;\n    fetchesWeights[3] = fetchesWeightsU.x * fetchesWeightsV.y;\n    fetchesWeights[4] = fetchesWeightsU.y * fetchesWeightsV.y;\n    fetchesWeights[5] = fetchesWeightsU.z * fetchesWeightsV.y;\n    fetchesWeights[6] = fetchesWeightsU.x * fetchesWeightsV.z;\n    fetchesWeights[7] = fetchesWeightsU.y * fetchesWeightsV.z;\n    fetchesWeights[8] = fetchesWeightsU.z * fetchesWeightsV.z;\n}'),xn.addInclude("GlobalIllumination.glsl",'struct LayaGIInput\n{\n\tvec2 lightmapUV;\n\tvec3 worldPos;\n};\n\n#define LAYA_SPECCUBE_LOD_STEPS 6.0\n\nuniform vec3 u_AmbientColor;\n\n#if defined(GI_AMBIENT_SH)\n\tuniform vec4 u_AmbientSHAr;\n\tuniform vec4 u_AmbientSHAg;\n\tuniform vec4 u_AmbientSHAb;\n\tuniform vec4 u_AmbientSHBr;\n\tuniform vec4 u_AmbientSHBg;\n\tuniform vec4 u_AmbientSHBb;\n\tuniform vec4 u_AmbientSHC;\n#endif\n\nuniform samplerCube u_ReflectTexture;\nuniform vec4 u_ReflectCubeHDRParams;\n\n#ifdef SPECCUBE_BOX_PROJECTION\n\tuniform vec3 u_SpecCubeProbePosition;\n\tuniform vec3 u_SpecCubeBoxMax;\n\tuniform vec3 u_SpecCubeBoxMin;\n#endif\n\n\n#ifdef GI_AMBIENT_SH\n\tmediump vec3 shEvalLinearL0L1(mediump vec4 normal)\n\t{\n\t\tmediump vec3 x;\n\t\t// Linear (L1) + constant (L0) polynomial terms\n\t\tx.r = dot(u_AmbientSHAr, normal);\n\t\tx.g = dot(u_AmbientSHAg, normal);\n\t\tx.b = dot(u_AmbientSHAb, normal);\n\t\treturn x;\n\t}\n\n\tmediump vec3 shEvalLinearL2(mediump vec4 normal)\n\t{\n\t\tmediump vec3 x1,x2;\n\t\t// 4 of the quadratic (L2) polynomials\n\t\tmediump vec4 vB = normal.xyzz * normal.yzzx;\n\t\tx1.r = dot(u_AmbientSHBr, vB);\n\t\tx1.g = dot(u_AmbientSHBg, vB);\n\t\tx1.b = dot(u_AmbientSHBb, vB);\n\n\t\t// Final (5th) quadratic (L2) polynomial\n\t\tmediump float vC = normal.x*normal.x - normal.y*normal.y;\n\t\tx2 = u_AmbientSHC.rgb * vC;\n\n\t\treturn x1 + x2;\n\t}\n\t\n\tmediump vec3 shadeSHPerPixel(mediump vec3 normal)\n\t{\n\t\tmediump vec3 ambientContrib;\n\t\tmediump vec4 normalV4=vec4(-normal.x,normal.yz, 1.0);//Note:SH Data is left-hand,so x need inverse\n\t\tambientContrib = shEvalLinearL0L1(normalV4);\n\t\tambientContrib += shEvalLinearL2(normalV4);\n\t\tmediump vec3 ambient = max(vec3(0.0), ambientContrib);\n\t\tambient = layaLinearToGammaSpace(ambient);\n\t\treturn ambient;\n\t}\n#endif\n\n\n\n mediump vec3 BoxProjectedCubemapDirection(mediump vec3 worldRefl,mediump vec3 worldPos,mediump vec3 cubemapCenter,mediump vec3 boxMin,mediump vec3 boxMax){\n\t mediump vec3 nrdir = normalize(worldRefl);\n\t mediump vec3 rbmax = (boxMax - worldPos);\n\t mediump vec3 rbmin = (boxMin - worldPos);\n\t mediump vec3 select = step(vec3(0.0), worldRefl);\n\t mediump vec3 rbminmax = mix(rbmin, rbmax, select);\n\trbminmax = rbminmax / nrdir;\n\tmediump float scalar = min(min(rbminmax.x, rbminmax.y), rbminmax.z);\n\t mediump vec3 worldChangeRefl = nrdir * scalar + (worldPos - cubemapCenter);\n\treturn worldChangeRefl;\n}\n\n\nmediump vec3 layaDecodeDirectionalLightmap (mediump vec3 color, lowp vec4 dirTex, mediump vec3 normalWorld)\n{\n    // In directional (non-specular) mode Enlighten bakes dominant light direction\n    // in a way, that using it for half Lambert and then dividing by a "rebalancing coefficient"\n    // gives a result close to plain diffuse response lightmaps, but normalmapped.\n\n    // Note that dir is not unit length on purpose. Its length is "directionality", like\n    // for the directional specular lightmaps.\n\tlowp vec3 directional=dirTex.xyz - 0.5;\n\tdirectional.x=-directional.x;//NOTE:because coord System\n    mediump float halfLambert = dot(normalWorld,directional) + 0.5;\n\n    return color * halfLambert / max(1e-4, dirTex.w);\n}\n\nvec3 layaGIBase(LayaGIInput giInput,mediump float occlusion, mediump vec3 normalWorld)\n{\n\tvec3 indirectDiffuse;\n\t#ifdef LIGHTMAP\t\n\t\tmediump vec3 bakedColor =decodeHDR(texture2D(u_LightMap, giInput.lightmapUV),5.0);\n\t\t#ifdef LIGHTMAP_DIRECTIONAL\n\t\t\tlowp vec4 bakedDirTex = texture2D (u_LightMapDirection, giInput.lightmapUV);\n            indirectDiffuse = layaDecodeDirectionalLightmap (bakedColor, bakedDirTex, normalWorld);\n\t\t#else //unDirectional lightmap\n\t\t\tindirectDiffuse = bakedColor;\n\t\t#endif\n\t#else\n\t\t#ifdef GI_AMBIENT_SH\n\t\t\tindirectDiffuse = shadeSHPerPixel(normalWorld);\n\t\t#else\n\t\t\tindirectDiffuse = u_AmbientColor; //already in gamma space\n\t\t#endif\n\t#endif\n\n\tindirectDiffuse*=occlusion;\n\treturn indirectDiffuse;\n}\n\nmediump vec3 layaGlossyEnvironment(mediump vec4 glossIn)\n{\n\tmediump float perceptualRoughness = glossIn.a;\n\n\t// use approximation to solve,below is more reasonable,but maybe slow. \n\t// float m = perceptualRoughnessToRoughness(perceptualRoughness); // m is the real roughness parameter\n    // const float fEps = 1.192092896e-07F;        // smallest such that 1.0+FLT_EPSILON != 1.0  (+1e-4h is NOT good here. is visibly very wrong)\n    // float n =  (2.0/max(fEps, m*m))-2.0;        // remap to spec power. See eq. 21 in --\x3e https://dl.dropboxusercontent.com/u/55891920/papers/mm_brdf.pdf\n    // n /= 4;                                     // remap from n_dot_h formulatino to n_dot_r. See section "Pre-convolved Cube Maps vs Path Tracers" --\x3e https://s3.amazonaws.com/docs.knaldtech.com/knald/1.0.0/lys_power_drops.html\n    // perceptualRoughness = pow( 2/(n+2), 0.25);  // remap back to square root of real roughness (0.25 include both the sqrt root of the conversion and sqrt for going from roughness to perceptualRoughness)\n\tperceptualRoughness = perceptualRoughness * (1.7 - 0.7*perceptualRoughness);//just a approximation,but fast.\n \n\tmediump float mip = perceptualRoughness * LAYA_SPECCUBE_LOD_STEPS;\n\tmediump vec3 uvw = glossIn.rgb;\n\tuvw.x=-uvw.x;//Note:reflectCube is left-hand,so x need inverse\n\tmediump vec4 rgbm=textureCubeLodEXT(u_ReflectTexture,uvw,mip);\n\treturn decodeHDR(rgbm,u_ReflectCubeHDRParams.x);\n}\n\nmediump vec3 layaGIIndirectSpecular(LayaGIInput giInput,mediump float occlusion, vec4 glossIn)\n{\n\t#ifdef SPECCUBE_BOX_PROJECTION\n\t\tvec3 originalReflUVW = glossIn.xyz;\n\t\tglossIn.xyz =BoxProjectedCubemapDirection(originalReflUVW,giInput.worldPos,u_SpecCubeProbePosition,u_SpecCubeBoxMin,u_SpecCubeBoxMax);\n\t#endif\n\tmediump vec3 specular = layaGlossyEnvironment(glossIn);\n\treturn specular * occlusion;\n}\n\n\nLayaGI layaGlobalIllumination(LayaGIInput giInput,mediump float occlusion, mediump vec3 normalWorld,mediump vec4 uvwRoughness)\n{\n\tLayaGI gi;\n\tgi.diffuse = layaGIBase(giInput,occlusion, normalWorld);\n\tgi.specular = layaGIIndirectSpecular(giInput,occlusion, uvwRoughness);\n\treturn gi;\n}\n\n\n'),xn.addInclude("Shadow.glsl",'#ifndef GRAPHICS_API_GLES3\n\t#define NO_NATIVE_SHADOWMAP\n#endif\n\n#if defined(NO_NATIVE_SHADOWMAP)\n\t#define TEXTURE2D_SHADOW(textureName) uniform mediump sampler2D textureName\n\t#define SAMPLE_TEXTURE2D_SHADOW(textureName, coord3) (texture2D(textureName,coord3.xy).r<coord3.z?0.0:1.0)\n\t#define TEXTURE2D_SHADOW_PARAM(shadowMap) mediump sampler2D shadowMap\n#else\n\t#define TEXTURE2D_SHADOW(textureName) uniform mediump sampler2DShadow textureName\n\t#define SAMPLE_TEXTURE2D_SHADOW(textureName, coord3) textureLod(textureName,coord3,0.0)\n\t#define TEXTURE2D_SHADOW_PARAM(shadowMap) mediump sampler2DShadow shadowMap\n#endif\n\n#if defined(RECEIVESHADOW)&&defined(SHADOW)\n    #define CALCULATE_SHADOWS\n#endif\n\n#if defined(RECEIVESHADOW)&&defined(SHADOW_SPOT)\n\t#define CALCULATE_SPOTSHADOWS\n#endif\n\nuniform vec4 u_ShadowBias; // x: depth bias, y: normal bias\n\n#if defined(CALCULATE_SHADOWS)||defined(CALCULATE_SPOTSHADOWS)\n\t#include "ShadowSampleTent.glsl"\n\tuniform vec4 u_ShadowMapSize;\n\tuniform vec4 u_SpotShadowMapSize;\n\tuniform vec4 u_ShadowParams; // x: shadowStrength y: ShadowSpotLightStrength\n\t\n\tfloat sampleShdowMapFiltered4(TEXTURE2D_SHADOW_PARAM(shadowMap),vec3 shadowCoord,vec4 shadowMapSize)\n\t{\n\t\tfloat attenuation;\n\t\tvec4 attenuation4;\n\t\tvec2 offset=shadowMapSize.xy/2.0;\n\t\tvec3 shadowCoord0=shadowCoord + vec3(-offset,0.0);\n\t\tvec3 shadowCoord1=shadowCoord + vec3(offset.x,-offset.y,0.0);\n\t\tvec3 shadowCoord2=shadowCoord + vec3(-offset.x,offset.y,0.0);\n\t\tvec3 shadowCoord3=shadowCoord + vec3(offset,0.0);\n\t\tattenuation4.x = SAMPLE_TEXTURE2D_SHADOW(shadowMap, shadowCoord0);\n\t\tattenuation4.y = SAMPLE_TEXTURE2D_SHADOW(shadowMap, shadowCoord1);\n\t\tattenuation4.z = SAMPLE_TEXTURE2D_SHADOW(shadowMap, shadowCoord2);\n\t\tattenuation4.w = SAMPLE_TEXTURE2D_SHADOW(shadowMap, shadowCoord3);\n\t\tattenuation = dot(attenuation4, vec4(0.25));\n\t\treturn attenuation;\n\t}\n\n\tfloat sampleShdowMapFiltered9(TEXTURE2D_SHADOW_PARAM(shadowMap),vec3 shadowCoord,vec4 shadowmapSize)\n\t{\n\t\tfloat attenuation;\n\t\tfloat fetchesWeights[9];\n\t\tvec2 fetchesUV[9];\n\t\tsampleShadowComputeSamplesTent5x5(shadowmapSize, shadowCoord.xy, fetchesWeights, fetchesUV);\n\t\tattenuation = fetchesWeights[0] * SAMPLE_TEXTURE2D_SHADOW(shadowMap, vec3(fetchesUV[0].xy, shadowCoord.z));\n\t\tattenuation += fetchesWeights[1] * SAMPLE_TEXTURE2D_SHADOW(shadowMap, vec3(fetchesUV[1].xy, shadowCoord.z));\n\t\tattenuation += fetchesWeights[2] * SAMPLE_TEXTURE2D_SHADOW(shadowMap, vec3(fetchesUV[2].xy, shadowCoord.z));\n\t\tattenuation += fetchesWeights[3] * SAMPLE_TEXTURE2D_SHADOW(shadowMap, vec3(fetchesUV[3].xy, shadowCoord.z));\n\t\tattenuation += fetchesWeights[4] * SAMPLE_TEXTURE2D_SHADOW(shadowMap, vec3(fetchesUV[4].xy, shadowCoord.z));\n\t\tattenuation += fetchesWeights[5] * SAMPLE_TEXTURE2D_SHADOW(shadowMap, vec3(fetchesUV[5].xy, shadowCoord.z));\n\t\tattenuation += fetchesWeights[6] * SAMPLE_TEXTURE2D_SHADOW(shadowMap, vec3(fetchesUV[6].xy, shadowCoord.z));\n\t\tattenuation += fetchesWeights[7] * SAMPLE_TEXTURE2D_SHADOW(shadowMap, vec3(fetchesUV[7].xy, shadowCoord.z));\n\t\tattenuation += fetchesWeights[8] * SAMPLE_TEXTURE2D_SHADOW(shadowMap, vec3(fetchesUV[8].xy, shadowCoord.z));\n\t\treturn attenuation;\n\t}\n\n#endif\n\n\n\n\n#if defined(CALCULATE_SHADOWS)\n\n\tTEXTURE2D_SHADOW(u_ShadowMap);\n\n\tuniform mat4 u_ShadowMatrices[4];\n\tuniform vec4 u_ShadowSplitSpheres[4];// max cascade is 4\n\n\tmediump int computeCascadeIndex(vec3 positionWS)\n\t{\n\t\tvec3 fromCenter0 = positionWS - u_ShadowSplitSpheres[0].xyz;\n\t\tvec3 fromCenter1 = positionWS - u_ShadowSplitSpheres[1].xyz;\n\t\tvec3 fromCenter2 = positionWS - u_ShadowSplitSpheres[2].xyz;\n\t\tvec3 fromCenter3 = positionWS - u_ShadowSplitSpheres[3].xyz;\n\n\t\tmediump vec4 comparison = vec4(\n\t\t\tdot(fromCenter0, fromCenter0)<u_ShadowSplitSpheres[0].w,\n\t\t\tdot(fromCenter1, fromCenter1)<u_ShadowSplitSpheres[1].w,\n\t\t\tdot(fromCenter2, fromCenter2)<u_ShadowSplitSpheres[2].w,\n\t\t\tdot(fromCenter3, fromCenter3)<u_ShadowSplitSpheres[3].w);\n\t\tcomparison.yzw = clamp(comparison.yzw - comparison.xyz,0.0,1.0);//keep the nearest\n\t\tmediump vec4 indexCoefficient = vec4(4.0,3.0,2.0,1.0);\n\t\tmediump int index = 4 - int(dot(comparison, indexCoefficient));\n\t\treturn index;\n\t}\n\n\tvec4 getShadowCoord(vec4 positionWS)\n\t{\n\t\t#ifdef SHADOW_CASCADE\n\t\t\tmediump int cascadeIndex = computeCascadeIndex(positionWS.xyz);\n\t\t\tif(cascadeIndex > 3)// out of shadow range cascadeIndex is 4.\n\t\t\t\treturn vec4(0.0);\n\t\t\t\n\t\t\t#ifdef GRAPHICS_API_GLES3\n\t\t\t\treturn u_ShadowMatrices[cascadeIndex] * positionWS;\n\t\t\t#else\n\t\t\t\tmat4 shadowMat;\n\t\t\t\tif(cascadeIndex == 0)\n\t\t\t\t\tshadowMat = u_ShadowMatrices[0];\n\t\t\t\telse if(cascadeIndex == 1)\n\t\t\t\t\tshadowMat = u_ShadowMatrices[1];\n\t\t\t\telse if(cascadeIndex == 2)\n\t\t\t\t\tshadowMat = u_ShadowMatrices[2];\n\t\t\t\telse\n\t\t\t\t\tshadowMat = u_ShadowMatrices[3];\n\t\t\t\treturn shadowMat * positionWS;\n\t\t\t#endif\n\t\t#else\n\t\t\treturn u_ShadowMatrices[0] * positionWS;\n\t\t#endif\n\t}\n\n\tfloat sampleShadowmap(vec4 shadowCoord)\n\t{\n\t\tshadowCoord.xyz /= shadowCoord.w;\n\t\tfloat attenuation = 1.0;\n\t\tif(shadowCoord.z > 0.0 && shadowCoord.z < 1.0)\n\t\t{\n\t\t\t#if defined(SHADOW_SOFT_SHADOW_HIGH)\n\t\t\t\tattenuation = sampleShdowMapFiltered9(u_ShadowMap,shadowCoord.xyz,u_ShadowMapSize);\n\t\t\t#elif defined(SHADOW_SOFT_SHADOW_LOW)\n\t\t\t\tattenuation = sampleShdowMapFiltered4(u_ShadowMap,shadowCoord.xyz,u_ShadowMapSize);\n\t\t\t#else\n\t\t\t\tattenuation = SAMPLE_TEXTURE2D_SHADOW(u_ShadowMap,shadowCoord.xyz);\n\t\t\t#endif\n\t\t\tattenuation = mix(1.0,attenuation,u_ShadowParams.x);//shadowParams.x:shadow strength\n\t\t}\n\t\treturn attenuation;\n\t}\n#endif\n\n#if defined(CALCULATE_SPOTSHADOWS)//shaderifdef if defined\n\tTEXTURE2D_SHADOW(u_SpotShadowMap);\n\tuniform mat4 u_SpotViewProjectMatrix;\n\tfloat sampleSpotShadowmap(vec4 shadowCoord)\n\t{\n\t\tshadowCoord.xyz /= shadowCoord.w;\n\t\tfloat attenuation = 1.0;\n\t\tshadowCoord.xy +=1.0;\n\t\tshadowCoord.xy/=2.0; \n\t\tif(shadowCoord.z > 0.0 && shadowCoord.z < 1.0)\n\t\t{\n\t\t\t#if defined(SHADOW_SPOT_SOFT_SHADOW_HIGH)\n\t\t\t\tattenuation = sampleShdowMapFiltered9(u_SpotShadowMap,shadowCoord.xyz,u_SpotShadowMapSize);\n\t\t\t#elif defined(SHADOW_SPOT_SOFT_SHADOW_LOW)\n\t\t\t\tattenuation = sampleShdowMapFiltered4(u_SpotShadowMap,shadowCoord.xyz,u_SpotShadowMapSize);\n\t\t\t#else\n\t\t\t\tattenuation = SAMPLE_TEXTURE2D_SHADOW(u_SpotShadowMap,shadowCoord.xyz);\n\t\t\t#endif\n\t\t\tattenuation = mix(1.0,attenuation,u_ShadowParams.y);//shadowParams.y:shadow strength\n\t\t}\n\t\treturn attenuation;\n\t}\n#endif\n\nvec3 applyShadowBias(vec3 positionWS, vec3 normalWS, vec3 lightDirection)\n{\n    float invNdotL = 1.0 - clamp(dot(-lightDirection, normalWS),0.0,1.0);\n    float scale = invNdotL * u_ShadowBias.y;\n\n    // normal bias is negative since we want to apply an inset normal offset\n    positionWS += -lightDirection * u_ShadowBias.xxx;\n    positionWS += normalWS * vec3(scale);\n    return positionWS;\n}\n'),xn.addInclude("ShadowCasterVS.glsl",'#include "Lighting.glsl";\n#include "Shadow.glsl"\n\nattribute vec4 a_Position;\nattribute vec3 a_Normal;\n\n#ifdef BONE\n\tconst int c_MaxBoneCount = 24;\n\tattribute vec4 a_BoneIndices;\n\tattribute vec4 a_BoneWeights;\n\tuniform mat4 u_Bones[c_MaxBoneCount];\n#endif\n\n#ifdef GPU_INSTANCE\n\tattribute mat4 a_WorldMat;\n#else\n\tuniform mat4 u_WorldMat;\n#endif\n\nuniform mat4 u_ViewProjection;\n\n#ifdef SHADOW\n\tuniform vec3 u_ShadowLightDirection;\n#endif\n\n\nvec4 shadowCasterVertex()\n{\n\tmat4 worldMat;\n\t#ifdef GPU_INSTANCE\n\t\tworldMat = a_WorldMat;\n\t#else\n\t\tworldMat = u_WorldMat;\n\t#endif\n\t\n\t#ifdef BONE\n\t\tmat4 skinTransform;\n\t \t#ifdef SIMPLEBONE\n\t\t\tfloat currentPixelPos;\n\t\t\t#ifdef GPU_INSTANCE\n\t\t\t\tcurrentPixelPos = a_SimpleTextureParams.x+a_SimpleTextureParams.y;\n\t\t\t#else\n\t\t\t\tcurrentPixelPos = u_SimpleAnimatorParams.x+u_SimpleAnimatorParams.y;\n\t\t\t#endif\n\t\t\tfloat offset = 1.0/u_SimpleAnimatorTextureSize;\n\t\t\tskinTransform =  loadMatFromTexture(currentPixelPos,int(a_BoneIndices.x),offset) * a_BoneWeights.x;\n\t\t\tskinTransform += loadMatFromTexture(currentPixelPos,int(a_BoneIndices.y),offset) * a_BoneWeights.y;\n\t\t\tskinTransform += loadMatFromTexture(currentPixelPos,int(a_BoneIndices.z),offset) * a_BoneWeights.z;\n\t\t\tskinTransform += loadMatFromTexture(currentPixelPos,int(a_BoneIndices.w),offset) * a_BoneWeights.w;\n\t\t#else\n\t\t\tskinTransform =  u_Bones[int(a_BoneIndices.x)] * a_BoneWeights.x;\n\t\t\tskinTransform += u_Bones[int(a_BoneIndices.y)] * a_BoneWeights.y;\n\t\t\tskinTransform += u_Bones[int(a_BoneIndices.z)] * a_BoneWeights.z;\n\t\t\tskinTransform += u_Bones[int(a_BoneIndices.w)] * a_BoneWeights.w;\n\t\t#endif\n\t\tworldMat = worldMat * skinTransform;\n\t#endif\n\n\tvec4 positionWS = worldMat * a_Position;\n\tmat3 worldInvMat;\n\t#ifdef BONE\n\t\tworldInvMat=INVERSE_MAT(mat3(worldMat*skinTransform));\n\t#else\n\t\tworldInvMat=INVERSE_MAT(mat3(worldMat));\n\t#endif  \n\n\tvec3 normalWS = normalize(a_Normal*worldInvMat);//if no normalize will cause precision problem\n\t#ifdef SHADOW\n\t\tpositionWS.xyz = applyShadowBias(positionWS.xyz,normalWS,u_ShadowLightDirection);\n\t#endif\n\n\tvec4 positionCS = u_ViewProjection * positionWS;\n\t#ifdef SHADOW_SPOT\n\t\tpositionCS.z = positionCS.z-u_ShadowBias.x/positionCS.w;\n\t#endif\n\tpositionCS.z = max(positionCS.z, 0.0);//min ndc z is 0.0\n\t\n\t// //TODOUV\n\t// #if defined(DIFFUSEMAP)&&defined(ALPHATEST)\n\t// \tv_Texcoord0=a_Texcoord0;\n\t// #endif\n    return positionCS;\n}\n'),xn.addInclude("ShadowCasterFS.glsl","vec4 shadowCasterFragment()\n{\n    return vec4(0.0);\n}\n"),xn.addInclude("Colors.glsl",'#include "StdLib.glsl";\n\n#define EPSILON 1.0e-4\n\n// Quadratic color thresholding\n// curve = (threshold - knee, knee * 2, 0.25 / knee)\nmediump vec4 quadraticThreshold(mediump vec4 color, mediump float threshold, mediump vec3 curve) {\n\t// Pixel brightness\n\tmediump float br = max3(color.r, color.g, color.b);\n\n\t// Under-threshold part: quadratic curve\n\tmediump float rq = clamp(br - curve.x, 0.0, curve.y);\n\trq = curve.z * rq * rq;\n\n\t// Combine and apply the brightness response curve.\n\tcolor *= max(rq, br - threshold) / max(br, EPSILON);\n\n\treturn color;\n}\n\n\n\n//\n// sRGB transfer functions\n// Fast path ref: http://chilliant.blogspot.com.au/2012/08/srgb-approximations-for-hlsl.html?m=1\n//\nmediump vec3 sRGBToLinear(mediump vec3 c) {\n\t#ifdef USE_VERY_FAST_SRGB\n\t\treturn c * c;\n\t#elif defined(USE_FAST_SRGB)\n\t\treturn c * (c * (c * 0.305306011 + 0.682171111) + 0.012522878);\n\t#else\n\t\tmediump vec3 linearRGBLo = c / 12.92;\n\t\tmediump vec3 power=vec3(2.4, 2.4, 2.4);\n\t\tmediump vec3 linearRGBHi = positivePow((c + 0.055) / 1.055, power);\n\t\tmediump vec3 linearRGB =vec3((c.r<=0.04045) ? linearRGBLo.r : linearRGBHi.r,(c.g<=0.04045) ? linearRGBLo.g : linearRGBHi.g,(c.b<=0.04045) ? linearRGBLo.b : linearRGBHi.b);\n\t\treturn linearRGB;\n\t#endif\n}\n\nmediump vec4 sRGBToLinear(mediump vec4 c){\n    return vec4(sRGBToLinear(c.rgb), c.a);\n}\n\n\n\nmediump vec3 linearToSRGB(mediump vec3 c) {\n\t#ifdef USE_VERY_FAST_SRGB\n\t\treturn sqrt(c);\n\t#elif defined(USE_FAST_SRGB)\n\t\treturn max(1.055 * PositivePow(c, 0.416666667) - 0.055, 0.0);\n\t#else\n\t\tmediump vec3 sRGBLo = c * 12.92;\n\t\tmediump vec3 power=vec3(1.0 / 2.4, 1.0 / 2.4, 1.0 / 2.4);\n\t\tmediump vec3 sRGBHi = (positivePow(c, power) * 1.055) - 0.055;\n\t\tmediump vec3 sRGB =vec3((c.r<=0.0031308) ? sRGBLo.r : sRGBHi.r,(c.g<=0.0031308) ? sRGBLo.g : sRGBHi.g,(c.b<=0.0031308) ? sRGBLo.b : sRGBHi.b);\n\t\treturn sRGB;\n\t#endif\n}\n\nmediump vec4 linearToSRGB(mediump vec4 c){\n    return vec4(linearToSRGB(c.rgb), c.a);\n}'),xn.addInclude("Sampling.glsl","// Better, temporally stable box filtering\n// [Jimenez14] http://goo.gl/eomGso\n// . . . . . . .\n// . A . B . C .\n// . . D . E . .\n// . F . G . H .\n// . . I . J . .\n// . K . L . M .\n// . . . . . . .\nmediump vec4 downsampleBox13Tap(sampler2D tex, vec2 uv, vec2 texelSize)\n{\n    mediump vec4 A = texture2D(tex, uv + texelSize * vec2(-1.0, -1.0));\n    mediump vec4 B = texture2D(tex, uv + texelSize * vec2( 0.0, -1.0));\n    mediump vec4 C = texture2D(tex, uv + texelSize * vec2( 1.0, -1.0));\n    mediump vec4 D = texture2D(tex, uv + texelSize * vec2(-0.5, -0.5));\n    mediump vec4 E = texture2D(tex, uv + texelSize * vec2( 0.5, -0.5));\n    mediump vec4 F = texture2D(tex, uv + texelSize * vec2(-1.0,  0.0));\n    mediump vec4 G = texture2D(tex, uv);\n    mediump vec4 H = texture2D(tex, uv + texelSize * vec2( 1.0,  0.0));\n    mediump vec4 I = texture2D(tex, uv + texelSize * vec2(-0.5,  0.5));\n    mediump vec4 J = texture2D(tex, uv + texelSize * vec2( 0.5,  0.5));\n    mediump vec4 K = texture2D(tex, uv + texelSize * vec2(-1.0,  1.0));\n    mediump vec4 L = texture2D(tex, uv + texelSize * vec2( 0.0,  1.0));\n    mediump vec4 M = texture2D(tex, uv + texelSize * vec2( 1.0,  1.0));\n\n\tmediump vec2 scale= vec2(0.5, 0.125);\n    mediump vec2 div = (1.0 / 4.0) * scale;\n\n    mediump vec4 o = (D + E + I + J) * div.x;\n    o += (A + B + G + F) * div.y;\n    o += (B + C + H + G) * div.y;\n    o += (F + G + L + K) * div.y;\n    o += (G + H + M + L) * div.y;\n\n    return o;\n}\n\n// Standard box filtering\nmediump vec4 downsampleBox4Tap(sampler2D tex, vec2 uv, vec2 texelSize)\n{\n    vec4 d = texelSize.xyxy * vec4(-1.0, -1.0, 1.0, 1.0);\n\n    mediump vec4 s =  texture2D(tex, uv + d.xy);\n    s += texture2D(tex, uv + d.zy);\n    s += texture2D(tex, uv + d.xw);\n    s += texture2D(tex, uv + d.zw);\n\n    return s * (1.0 / 4.0);\n}\n\n// 9-tap bilinear upsampler (tent filter)\n// . . . . . . .\n// . 1 . 2 . 1 .\n// . . . . . . .\n// . 2 . 4 . 2 .\n// . . . . . . .\n// . 1 . 2 . 1 .\n// . . . . . . .\nmediump vec4 upsampleTent(sampler2D tex, vec2 uv, vec2 texelSize, vec4 sampleScale)\n{\n    vec4 d = texelSize.xyxy * vec4(1.0, 1.0, -1.0, 0.0) * sampleScale;\n\n    mediump vec4 s =  texture2D(tex, uv - d.xy);\n    s += texture2D(tex, uv - d.wy) * 2.0;\n    s += texture2D(tex, uv - d.zy);\n\n    s += texture2D(tex, uv + d.zw) * 2.0;\n    s += texture2D(tex, uv) * 4.0;\n    s += texture2D(tex,\tuv + d.xw) * 2.0;\n\n    s += texture2D(tex, uv + d.zy);\n    s += texture2D(tex, uv + d.wy) * 2.0;\n    s += texture2D(tex, uv + d.xy);\n\n    return s * (1.0 / 16.0);\n}\n\n// Standard box filtering\nmediump vec4 upsampleBox(sampler2D tex, vec2 uv, vec2 texelSize, vec4 sampleScale)\n{\n    vec4 d = texelSize.xyxy * vec4(-1.0, -1.0, 1.0, 1.0) * 0.5 * sampleScale;\n\n    mediump vec4 s =  texture2D(tex, uv + d.xy);\n    s += texture2D(tex, uv + d.zy);\n    s += texture2D(tex, uv + d.xw);\n    s += texture2D(tex, uv + d.zw);\n\n    return s * (1.0 / 4.0);\n}"),xn.addInclude("StdLib.glsl","#define HALF_MAX       65504.0 // (2 - 2^-10) * 2^15\n\n#define FLT_EPSILON    1.192092896e-07 // Smallest positive number, such that 1.0 + FLT_EPSILON != 1.0\n\nmediump vec4 safeHDR(mediump vec4 c)\n{\n    return min(c, HALF_MAX);\n}\n\nfloat max3(float a, float b, float c)\n{\n    return max(max(a, b), c);\n}\n\nvec3 positivePow(vec3 base, vec3 power)\n{\n    return pow(max(abs(base), vec3(FLT_EPSILON, FLT_EPSILON, FLT_EPSILON)), power);\n}"),xn.addInclude("PBRVSInput.glsl","attribute vec4 a_Position;\n\n#ifdef GPU_INSTANCE\n\tuniform mat4 u_ViewProjection;\n\tattribute mat4 a_WorldMat;\n#else\n\tuniform mat4 u_MvpMatrix;\n\tuniform mat4 u_WorldMat;\n#endif\n\n#ifdef BONE\n\tconst int c_MaxBoneCount = 24;\n\tattribute vec4 a_BoneIndices;\n\tattribute vec4 a_BoneWeights;\n\tuniform mat4 u_Bones[c_MaxBoneCount];\n#endif\n\nattribute vec3 a_Normal;\nvarying vec3 v_Normal; \n\n#if defined(NORMALTEXTURE)||defined(PARALLAXTEXTURE)\n\tattribute vec4 a_Tangent0;\n\tvarying vec3 v_Tangent;\n\tvarying vec3 v_Binormal;\n    #ifdef PARALLAXTEXTURE\n\t    varying vec3 v_ViewDirForParallax;\n    #endif\n#endif\n\n#if defined(ALBEDOTEXTURE)||defined(METALLICGLOSSTEXTURE)||defined(NORMALTEXTURE)||defined(EMISSIONTEXTURE)||defined(OCCLUSIONTEXTURE)||defined(PARALLAXTEXTURE)||(defined(LIGHTMAP)&&defined(UV))\n\tattribute vec2 a_Texcoord0;\n\tvarying vec2 v_Texcoord0;\n#endif\n\n#if defined(LIGHTMAP)&&defined(UV1)\n\tattribute vec2 a_Texcoord1;\n#endif\n\n#ifdef LIGHTMAP\n\tuniform vec4 u_LightmapScaleOffset;\n\tvarying vec2 v_LightMapUV;\n#endif\n\nuniform vec3 u_CameraPos;\nvarying vec3 v_EyeVec;\nvarying vec3 v_PositionWorld;\nvarying float v_posViewZ;\n\n#if defined(CALCULATE_SHADOWS)&&!defined(SHADOW_CASCADE)\n\tvarying vec4 v_ShadowCoord;\n#endif\n\n#if defined(CALCULATE_SPOTSHADOWS)//shaderifdef if defined\n\tvarying vec4 v_SpotShadowCoord;\n#endif\n\nuniform vec4 u_TilingOffset;\n"),xn.addInclude("PBRFSInput.glsl","#ifdef ALPHATEST\n\tuniform float u_AlphaTestValue;\n#endif\n\nuniform vec4 u_AlbedoColor;\n\n#ifdef NORMALTEXTURE\n\tuniform sampler2D u_NormalTexture;\n\tuniform float u_NormalScale;\n#endif\n\n#ifdef ALBEDOTEXTURE\n\tuniform sampler2D u_AlbedoTexture;\n#endif\n\n#ifdef METALLICGLOSSTEXTURE\n\tuniform sampler2D u_MetallicGlossTexture;\n#endif\nuniform float u_Metallic;\n\n#ifdef SPECULARGLOSSTEXTURE\n\tuniform sampler2D u_SpecGlossTexture;\n#endif\nuniform vec3 u_SpecularColor;\n\nuniform float u_Smoothness;\nuniform float u_SmoothnessScale;\n\n#ifdef PARALLAXTEXTURE\n\tuniform sampler2D u_ParallaxTexture;\n\tuniform float u_ParallaxScale;\n\tvarying vec3 v_ViewDirForParallax;\n#endif\n\n#ifdef OCCLUSIONTEXTURE\n\tuniform sampler2D u_OcclusionTexture;\n\tuniform float u_occlusionStrength;\n#endif\n\n#ifdef EMISSION \n\t#ifdef EMISSIONTEXTURE\n\t\tuniform sampler2D u_EmissionTexture;\n\t#endif\n\tuniform vec4 u_EmissionColor;\n#endif\n\n#if defined(ALBEDOTEXTURE)||defined(METALLICGLOSSTEXTURE)||defined(NORMALTEXTURE)||defined(EMISSIONTEXTURE)||defined(OCCLUSIONTEXTURE)||defined(PARALLAXTEXTURE)\n\tvarying vec2 v_Texcoord0;\n#endif\n\n#ifdef LIGHTMAP\n\tvarying vec2 v_LightMapUV;\n\tuniform sampler2D u_LightMap;\n\t#ifdef LIGHTMAP_DIRECTIONAL\n\t\tuniform sampler2D u_LightMapDirection;\n\t#endif\n#endif\n\nvarying vec3 v_Normal; \n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n\t#ifdef LEGACYSINGLELIGHTING\n\t\t#ifdef DIRECTIONLIGHT\n\t\t\tuniform DirectionLight u_DirectionLight;\n\t\t#endif\n\t\t#ifdef POINTLIGHT\n\t\t\tuniform PointLight u_PointLight;\n\t\t#endif\n\t\t#ifdef SPOTLIGHT\n\t\t\tuniform SpotLight u_SpotLight;\n\t\t#endif\n\t#else\n\t\tuniform mat4 u_View;\n\t\tuniform vec4 u_ProjectionParams;\n\t\tuniform vec4 u_Viewport;\n\t\tuniform int u_DirationLightCount;\n\t\tuniform sampler2D u_LightBuffer;\n\t\tuniform sampler2D u_LightClusterBuffer;\n\t#endif\n#endif\n\nvarying vec3 v_EyeVec;\n\n#ifdef NORMALTEXTURE\n\tvarying vec3 v_Tangent;\n\tvarying vec3 v_Binormal;\n#endif\n\n#ifdef FOG\n\tuniform float u_FogStart;\n\tuniform float u_FogRange;\n\tuniform vec3 u_FogColor;\n#endif\n\n\n//TODO\nvarying vec3 v_PositionWorld;\n\n#if defined(CALCULATE_SHADOWS)&&!defined(SHADOW_CASCADE)\n\tvarying vec4 v_ShadowCoord;\n#endif\n\n#if defined(CALCULATE_SPOTSHADOWS)//shaderifdef if defined\n\tvarying vec4 v_SpotShadowCoord;\n#endif\n\nmediump float lerpOneTo(mediump float b, mediump float t)\n{\n    mediump float oneMinusT = 1.0 - t;\n    return oneMinusT + b * t;\n}\n\n#ifdef EMISSION \n\tvec3 emission(vec2 uv)\n\t{\n\t\t#ifdef EMISSIONTEXTURE\n\t\t\treturn texture2D(u_EmissionTexture, uv).rgb * u_EmissionColor.rgb;\n\t\t#else\n\t\t\treturn u_EmissionColor.rgb;\n\t\t#endif\n\t}\n#endif\n\nmediump float getAlpha(vec2 uv)\n{\n\t#ifdef SMOOTHNESSSOURCE_ALBEDOTEXTURE_ALPHA\n\t\treturn u_AlbedoColor.a;\n\t#else\n\t\t#ifdef ALBEDOTEXTURE\n\t\t\treturn texture2D(u_AlbedoTexture, uv).a * u_AlbedoColor.a;\n\t\t#else\n\t\t\treturn u_AlbedoColor.a;\n\t\t#endif\n\t#endif\n}\n\nmediump float getOcclusion(vec2 uv)\n{\n\t#ifdef OCCLUSIONTEXTURE\n\t\tmediump float occ = texture2D(u_OcclusionTexture, uv).g;\n\t\treturn lerpOneTo(occ, u_occlusionStrength);\n\t#else\n\t\treturn 1.0;\n\t#endif\n}\n\nmediump vec3 albedo(vec2 uv)\n{\n\t#ifdef ALBEDOTEXTURE\n\t\treturn u_AlbedoColor.rgb * texture2D(u_AlbedoTexture, uv).rgb;\n\t#else\n\t\treturn u_AlbedoColor.rgb;\n\t#endif\n\t//TODO:Detail Texture\n}\n\nmediump vec2 getMetallicGloss(vec2 uv)\n{\n\tmediump vec2 ms;//x is metallic,y is smoothness\n\t#ifdef METALLICGLOSSTEXTURE\n\t\t#ifdef SMOOTHNESSSOURCE_ALBEDOTEXTURE_ALPHA\n\t\t\tms.x = texture2D(u_MetallicGlossTexture, uv).r;\n\t\t\t#ifdef ALBEDOTEXTURE\n\t\t\t\tms.y = texture2D(u_AlbedoTexture, uv).a*u_SmoothnessScale;\n\t\t\t#else\n\t\t\t\tms.y = u_SmoothnessScale;\n\t\t\t#endif\n\t\t#else\n\t\t\tms = texture2D(u_MetallicGlossTexture, uv).ra;\n\t\t\tms.y *= u_SmoothnessScale;\n\t\t#endif\n\t#else\n\t\tms.x = u_Metallic;\n\t\t#ifdef SMOOTHNESSSOURCE_ALBEDOTEXTURE_ALPHA\n\t\t\t#ifdef ALBEDOTEXTURE\n\t\t\t\tms.y = texture2D(u_AlbedoTexture, uv).a * u_SmoothnessScale;\n\t\t\t#else\n\t\t\t\tms.y = u_SmoothnessScale;\n\t\t\t#endif\n\t\t#else\n\t\t\tms.y = u_Smoothness;\n\t\t#endif\n\t#endif\n\treturn ms;\n}\n\nmediump vec4 specularGloss(vec2 uv)\n{\n\tmediump vec4 sg;\n\t#ifdef SPECULARGLOSSTEXTURE\n\t\t#ifdef SMOOTHNESSSOURCE_ALBEDOTEXTURE_ALPHA\n\t\t\tsg.rgb = texture2D(u_SpecGlossTexture, uv).rgb;\n\t\t\t#ifdef ALBEDOTEXTURE\n\t\t\t\tsg.a = texture2D(u_AlbedoTexture, uv).a*u_SmoothnessScale;\n\t\t\t#else\n\t\t\t\tsg.a = u_SmoothnessScale;\n\t\t\t#endif\n\t\t#else\n\t\t\tsg = texture2D(u_SpecGlossTexture, uv);\n\t\t\tsg.a *= u_SmoothnessScale;\n\t\t#endif\n\t#else\n\t\tsg.rgb = u_SpecularColor.rgb;\n\t\t#ifdef SMOOTHNESSSOURCE_ALBEDOTEXTURE_ALPHA\n\t\t\t#ifdef ALBEDOTEXTURE\n\t\t\t\tsg.a = texture2D(u_AlbedoTexture, uv).a * u_SmoothnessScale;\n\t\t\t#else\n\t\t\t\tsg.a = u_SmoothnessScale;\n\t\t\t#endif\n\t\t#else\n\t\t\tsg.a = u_Smoothness;\n\t\t#endif\n\t#endif\n\t\treturn sg;\n}\n\n\n#ifdef NORMALTEXTURE\n\tmediump vec3 unpackScaleNormal(mediump vec3 packednormal, mediump float bumpScale)\n\t{\n\t\tmediump vec3 normal = packednormal.xyz * 2.0 - 1.0;\n\t\tnormal.y=-normal.y;//NOTE:because unity to LayaAir coordSystem.\n\t\tnormal.xy *= bumpScale;\n\t\treturn normal;\n\t}\n\t\n\tmediump vec3 normalInTangentSpace(vec2 texcoords)\n\t{\n\t\tmediump vec3 normalTangent = unpackScaleNormal(texture2D(u_NormalTexture, texcoords).rgb,u_NormalScale);\n\t\treturn normalTangent;\n\t}\n#endif\n\n#ifdef PARALLAXTEXTURE\n\tmediump vec2 parallaxOffset1Step(mediump float h, mediump float height, mediump vec3 viewDir)\n\t{\n\t\th = h * height - height / 2.0;\n\t\tviewDir.z += 0.42;\n\t\treturn h * (viewDir.xy / viewDir.z);\n\t}\n\n\tvec2 parallax(vec2 texcoords, mediump vec3 viewDir)\n\t{\n\t\tmediump float h = texture2D(u_ParallaxTexture, texcoords.xy).g;\n\t\tvec2 offset = parallaxOffset1Step(h, u_ParallaxScale, viewDir);\n\t\treturn texcoords+offset;\n\t}\n#endif\n\n\n\n\n\n\n\n\n"),xn.addInclude("LayaPBRBRDF.glsl",'// allow to explicitly override LAYA_BRDF_GI and LAYA_BRDF_LIGHT in custom shader,default is layaBRDFHighGI and layaBRDFHighLight\n#if !defined (LAYA_BRDF_GI) \n\t#if defined(LAYA_PBR_BRDF_LOW)\n\t\t#define LAYA_BRDF_GI layaBRDFLowGI\n\t#elif defined(LAYA_PBR_BRDF_HIGH)\n\t\t#define LAYA_BRDF_GI layaBRDFHighGI\n\t#endif\n#endif\n#if !defined (LAYA_BRDF_LIGHT)\n\t#if defined(LAYA_PBR_BRDF_LOW)\n\t\t#define LAYA_BRDF_LIGHT layaBRDFLowLight\n\t#elif defined(LAYA_PBR_BRDF_HIGH)\n\t\t#define LAYA_BRDF_LIGHT layaBRDFHighLight\n\t#endif\n#endif\n\n#define PI 3.14159265359\n#define INV_PI 0.31830988618\n\nmediump float pow4(mediump float x)\n{\n\treturn x * x * x * x;\n}\n\nmediump float pow5(mediump float x)\n{\n\treturn x * x * x * x * x;\n}\n\nmediump vec3 fresnelLerp(mediump vec3 F0,mediump vec3 F90,mediump float cosA)\n{\n\tfloat t = pow5(1.0 - cosA);   // ala Schlick interpoliation\n\treturn mix(F0, F90, t);\n}\n\nmediump vec3 fresnelTerm(mediump vec3 F0,mediump float cosA)\n{\n\tfloat t = pow5(1.0 - cosA);   // ala Schlick interpoliation\n\treturn F0 + (vec3(1.0) - F0) * t;\n}\n\n// approximage Schlick with ^4 instead of ^5\nmediump vec3 fresnelLerpFast (mediump vec3 F0, mediump vec3 F90,mediump float cosA)\n{\n    mediump float t = pow4 (1.0 - cosA);\n    return mix (F0, F90, t);\n}\n\nfloat smoothnessToPerceptualRoughness(float smoothness)\n{\n    return 1.0 - smoothness;\n}\n\nfloat perceptualRoughnessToRoughness(float perceptualRoughness)\n{\n    return perceptualRoughness * perceptualRoughness;\n}\n\nvec3 safeNormalize(vec3 inVec)\n{\n\tfloat dp3 = max(0.001,dot(inVec,inVec));\n\treturn inVec * inversesqrt(dp3);\n}\n\n// Note: Disney diffuse must be multiply by diffuseAlbedo / PI. This is done outside of this function.\nmediump float disneyDiffuse(mediump float NdotV,mediump float NdotL,mediump float LdotH,mediump float perceptualRoughness)\n{\n\t//https://www.cnblogs.com/herenzhiming/articles/5790389.html\n\tmediump float fd90 = 0.5 + 2.0 * LdotH * LdotH * perceptualRoughness;\n\t// Two schlick fresnel term\n\tmediump float lightScatter = (1.0 + (fd90 - 1.0) * pow5(1.0 - NdotL));\n\tmediump float viewScatter = (1.0 + (fd90 - 1.0) * pow5(1.0 - NdotV));\n\n\treturn lightScatter * viewScatter;\n}\n\n// Ref: http://jcgt.org/published/0003/02/03/paper.pdf\nfloat smithJointGGXVisibilityTerm(float NdotL, float NdotV, float roughness)\n{\n\t// Original formulation:\n    // lambda_v    = (-1 + sqrt(a2 * (1 - NdotL2) / NdotL2 + 1)) * 0.5f;\n    // lambda_l    = (-1 + sqrt(a2 * (1 - NdotV2) / NdotV2 + 1)) * 0.5f;\n    // G           = 1 / (1 + lambda_v + lambda_l);\n\n\t// scientific code implement:\n\t// Reorder code to be more optimal\n    // half a          = roughness;\n    // half a2         = a * a;\n\n    // half lambdaV    = NdotL * sqrt((-NdotV * a2 + NdotV) * NdotV + a2);\n    // half lambdaL    = NdotV * sqrt((-NdotL * a2 + NdotL) * NdotL + a2);\n\n    // Simplify visibility term: (2.0f * NdotL * NdotV) /  ((4.0f * NdotL * NdotV) * (lambda_v + lambda_l + 1e-5f));\n    // return 0.5f / (lambdaV + lambdaL + 1e-5f);  \n\t// This function is not intended to be running on Mobile,therefore epsilon is smaller than can be represented by half\n\n\t// Approximation of the above formulation (simplify the sqrt, not mathematically correct but close enough)\n\tfloat a = roughness;\n\tfloat lambdaV = NdotL * (NdotV * (1.0 - a) + a);\n\tfloat lambdaL = NdotV * (NdotL * (1.0 - a) + a);\n\treturn 0.5 / (lambdaV + lambdaL + 1e-5);\n}\n\nfloat ggxTerm(float NdotH, float roughness)\n{\n\tfloat a2 = roughness * roughness;\n\tfloat d = (NdotH * a2 - NdotH) * NdotH + 1.0; // 2 mad\n\treturn INV_PI * a2 / (d * d + 1e-7); // This function is not intended to be running on Mobile,therefore epsilon is smaller than what can be represented by half//half\n}\n\n// BRDF1-------------------------------------------------------------------------------------\n\n// Note: BRDF entry points use smoothness and oneMinusReflectivity for optimization purposes,\n// mostly for DX9 SM2.0 level. Most of the math is being done on these (1-x) values, and that saves a few precious ALU slots.\n\n// Main Physically Based BRDF\n// Derived from Disney work and based on Torrance-Sparrow micro-facet model\n//\n// BRDF = kD / pi + kS * (D * V * F) / 4\n// I = BRDF * NdotL\n//\n// *NDF GGX:\n// *Smith for Visiblity term\n// *Schlick approximation for Fresnel\nmediump vec4 layaBRDFHighLight(mediump vec3 diffColor, mediump vec3 specColor, mediump float oneMinusReflectivity, float perceptualRoughness,float roughness,mediump float nv,vec3 normal, vec3 viewDir,LayaLight light)\n{\n\tvec3 halfDir = safeNormalize(viewDir-light.dir);\n\n\tfloat nl = clamp(dot(normal, -light.dir),0.0,1.0);\n\tfloat nh = clamp(dot(normal, halfDir),0.0,1.0);\n\tmediump float lv = clamp(dot(light.dir, viewDir),0.0,1.0);\n\tmediump float lh = clamp(dot(light.dir, -halfDir),0.0,1.0);\n\n\t// Diffuse term\n\tmediump float diffuseTerm = disneyDiffuse(nv, nl, lh, perceptualRoughness) * nl;\n\n\t// Specular term\n    // HACK: theoretically we should divide diffuseTerm by Pi and not multiply specularTerm!\n    // BUT that will make shader look significantly darker than Legacy ones\n\n\t// GGX with roughtness to 0 would mean no specular at all, using max(roughness, 0.002) here to match HDrenderloop roughtness remapping.\n\troughness = max(roughness, 0.002);\n\tfloat V = smithJointGGXVisibilityTerm(nl, nv, roughness);\n\tfloat D = ggxTerm(nh, roughness);\n\n\tfloat specularTerm = V * D * PI; // Torrance-Sparrow model, Fresnel is applied later\n\n\t//#ifdef LAYA_COLORSPACE_GAMMA\n\tspecularTerm = sqrt(max(1e-4, specularTerm));\n\t//#endif\n\tspecularTerm = max(0.0, specularTerm * nl);\n\t\t\n\tmediump vec3 color = diffColor * light.color * diffuseTerm + specularTerm * light.color * fresnelTerm(specColor, lh);\n\treturn vec4(color, 1.0);\n}\n\nvec4 layaBRDFHighGI(mediump vec3 diffColor,mediump vec3 specColor,mediump float oneMinusReflectivity,float smoothness ,float perceptualRoughness,float roughness,mediump float nv,vec3 normal, vec3 viewDir,LayaGI gi)\n{\n\t// surfaceReduction = Int D(NdotH) * NdotH * Id(NdotL>0) dH = 1/(roughness^2+1)\n\tfloat surfaceReduction;\n\tsurfaceReduction = 1.0 - 0.28*roughness*perceptualRoughness;// 1-0.28*x^3 as approximation for (1/(x^4+1))^(1/2.2) on the domain [0;1]\n\tfloat grazingTerm = clamp(smoothness + (1.0 - oneMinusReflectivity),0.0,1.0);\n\tmediump vec3 color =diffColor * gi.diffuse + surfaceReduction * gi.specular * fresnelLerp(specColor,vec3(grazingTerm), nv);\n\treturn vec4(color,1.0);\n}\n// BRDF1-------------------------------------------------------------------------------------\n\n\n// BRDF2-------------------------------------------------------------------------------------\n// Based on Minimalist CookTorrance BRDF\n// Implementation is slightly different from original derivation: http://www.thetenthplanet.de/archives/255\n//\n// *NDF [Modified] GGX:\n// *Modified Kelemen and Szirmay-Kalos for Visibility term\n// *Fresnel approximated with 1/LdotH\nmediump vec4 layaBRDFLowLight (mediump vec3 diffColor, mediump vec3 specColor,mediump float oneMinusReflectivity,float perceptualRoughness,float roughness,mediump float nv,vec3 normal,vec3 viewDir,LayaLight light)\n{\n    vec3 halfDir = safeNormalize (viewDir-light.dir);\n    mediump float nl = clamp(dot(normal, -light.dir),0.0,1.0);\n    float nh = clamp(dot(normal, halfDir),0.0,1.0);\n    float lh = clamp(dot(-light.dir, halfDir),0.0,1.0);\n\n    // GGX Distribution multiplied by combined approximation of Visibility and Fresnel\n    // See "Optimizing PBR for Mobile" from Siggraph 2015 moving mobile graphics course\n    // https://community.arm.com/events/1155\n    mediump float a = roughness;\n    float a2 = a*a;\n\n    float d = nh * nh * (a2 - 1.0) + 1.00001;\n\t// #ifdef LAYA_COLORSPACE_GAMMA\n\t\t// Tighter approximation for Gamma only rendering mode!\n\t\t// DVF = sqrt(DVF);\n\t\t// DVF = (a * sqrt(.25)) / (max(sqrt(0.1), lh)*sqrt(roughness + .5) * d);\n\t\tfloat specularTerm = a / (max(0.32, lh) * (1.5 + roughness) * d);\n\t// #else\n\t// \tfloat specularTerm = a2 / (max(0.1f, lh*lh) * (roughness + 0.5f) * (d * d) * 4);\n\t// #endif\n\n    // on mobiles (where half actually means something) denominator have risk of overflow\n    // clamp below was added specifically to "fix" that, but dx compiler (we convert bytecode to metal/gles)\n    // sees that specularTerm have only non-negative terms, so it skips max(0,..) in clamp (leaving only min(100,...))\n\n\t//#if defined (SHADER_API_MOBILE)\n    specularTerm = specularTerm - 1e-4;\n\t//#endif\n\n\t// #else\n\t\t// // Legacy\n\t\t// half specularPower = PerceptualRoughnessToSpecPower(perceptualRoughness);\n\t\t// // Modified with approximate Visibility function that takes roughness into account\n\t\t// // Original ((n+1)*N.H^n) / (8*Pi * L.H^3) didn\'t take into account roughness\n\t\t// // and produced extremely bright specular at grazing angles\n\n\t\t// half invV = lh * lh * smoothness + perceptualRoughness * perceptualRoughness; // approx ModifiedKelemenVisibilityTerm(lh, perceptualRoughness);\n\t\t// half invF = lh;\n\n\t\t// half specularTerm = ((specularPower + 1) * pow (nh, specularPower)) / (8 * invV * invF + 1e-4h);\n\n\t\t// #ifdef LAYA_COLORSPACE_GAMMA\n\t\t// \tspecularTerm = sqrt(max(1e-4f, specularTerm));\n\t\t// #endif\n\t// #endif\n\n\t// #if defined (SHADER_API_MOBILE)\n\t\tspecularTerm = clamp(specularTerm, 0.0, 100.0); // Prevent FP16 overflow on mobiles\n\t// #endif\n    \n    mediump vec3 color = (diffColor + specularTerm * specColor) * light.color * nl;\n\n    return vec4(color, 1.0);\n}\n\nmediump vec4 layaBRDFLowGI (mediump vec3 diffColor, mediump vec3 specColor,mediump float oneMinusReflectivity,mediump float smoothness,float perceptualRoughness,float roughness,mediump float nv,vec3 normal,vec3 viewDir,LayaGI gi)\n{\n\t// surfaceReduction = Int D(NdotH) * NdotH * Id(NdotL>0) dH = 1/(realRoughness^2+1)\n\n    // 1-0.28*x^3 as approximation for (1/(x^4+1))^(1/2.2) on the domain [0;1]\n    // 1-x^3*(0.6-0.08*x)   approximation for 1/(x^4+1)\n\t// #ifdef LAYA_COLORSPACE_GAMMA\n\t\tmediump float surfaceReduction = 0.28;\n\t// #else\n\t\t// mediump float surfaceReduction = (0.6-0.08*perceptualRoughness);\n\t// #endif\n\n    surfaceReduction = 1.0 - roughness*perceptualRoughness*surfaceReduction;\n\n\tmediump float grazingTerm = clamp(smoothness + (1.0-oneMinusReflectivity),0.0,1.0);\n\tmediump vec3 color =gi.diffuse * diffColor+ surfaceReduction * gi.specular * fresnelLerpFast (specColor, vec3(grazingTerm), nv);\n\n    return vec4(color, 1.0);\n}\n// BRDF2-------------------------------------------------------------------------------------'),xn.addInclude("PBRCore.glsl","struct FragmentCommonData{\n\tvec3 diffColor;\n\tvec3 specColor;\n\tfloat oneMinusReflectivity;\n\tfloat smoothness;\n\t//vec3 eyeVec;TODO:maybe can remove\n\t//float alpha;\n\t//vec3 reflUVW;\n};\n\n#if !defined(SETUP_BRDF_INPUT)//shader#ifdef#if Layashader\n    #define SETUP_BRDF_INPUT metallicSetup//default is metallicSetup,also can be other. \n#endif\n\nconst mediump vec4 dielectricSpecularColor = vec4(0.220916301, 0.220916301, 0.220916301, 1.0 - 0.220916301);\n\nmediump vec3 diffuseAndSpecularFromMetallic(mediump vec3 albedo,mediump float metallic, out mediump vec3 specColor, out mediump float oneMinusReflectivity)\n{\n\tspecColor = mix(dielectricSpecularColor.rgb, albedo, metallic);\n\toneMinusReflectivity= dielectricSpecularColor.a*(1.0-metallic);//diffuse proportion\n\treturn albedo * oneMinusReflectivity;\n}\n\nmediump float specularStrength(mediump vec3 specular)\n{\n    return max (max (specular.r, specular.g), specular.b);\n}\n\n// Diffuse/Spec Energy conservation\nmediump vec3 energyConservationBetweenDiffuseAndSpecular (mediump vec3 albedo, mediump vec3 specColor, out mediump float oneMinusReflectivity)\n{\n\toneMinusReflectivity = 1.0 - specularStrength(specColor);\n    return albedo * (vec3(1.0) - specColor);\n}\n\n#ifdef TRANSPARENTBLEND\n\tmediump vec3 preMultiplyAlpha (mediump vec3 diffColor, mediump float alpha, mediump float oneMinusReflectivity,out mediump float modifiedAlpha)\n\t{\n\t\t// Transparency 'removes' from Diffuse component\n\t\tdiffColor *= alpha;\n\t\t// Reflectivity 'removes' from the rest of components, including Transparency\n\t\t// modifiedAlpha = 1.0-(1.0-alpha)*(1.0-reflectivity) = 1.0-(oneMinusReflectivity - alpha*oneMinusReflectivity) = 1.0-oneMinusReflectivity + alpha*oneMinusReflectivity\n\t\tmodifiedAlpha = 1.0 - oneMinusReflectivity + alpha*oneMinusReflectivity;\n\t\treturn diffColor;\n\t}\n#endif\n\nFragmentCommonData metallicSetup(vec2 uv)\n{\n\tmediump vec2 metallicGloss = getMetallicGloss(uv);\n\tmediump float metallic = metallicGloss.x;\n\tmediump float smoothness = metallicGloss.y; // this is 1 minus the square root of real roughness m.\n\tmediump float oneMinusReflectivity;\n\tmediump vec3 specColor;\n\tmediump vec3 diffColor = diffuseAndSpecularFromMetallic(albedo(uv), metallic,/*out*/specColor,/*out*/oneMinusReflectivity);\n\n\tFragmentCommonData o;\n\to.diffColor = diffColor;\n\to.specColor = specColor;\n\to.oneMinusReflectivity = oneMinusReflectivity;\n\to.smoothness = smoothness;\n\treturn o;\n}\n\nFragmentCommonData specularSetup(vec2 uv)\n{\n    mediump vec4 specGloss = specularGloss(uv);\n    mediump vec3 specColor = specGloss.rgb;\n    mediump float smoothness = specGloss.a;\n\n    mediump float oneMinusReflectivity;\n    mediump vec3 diffColor = energyConservationBetweenDiffuseAndSpecular (albedo(uv), specColor, /*out*/ oneMinusReflectivity);\n\n    FragmentCommonData o;\n    o.diffColor = diffColor;\n    o.specColor = specColor;\n    o.oneMinusReflectivity = oneMinusReflectivity;\n    o.smoothness = smoothness;\n    return o;\n}\n\nLayaGI fragmentGI(float smoothness,vec3 eyeVec,mediump float occlusion,mediump vec2 lightmapUV,vec3 worldnormal,vec3 worldPos)\n{\n\tLayaGIInput giInput;\n\t#ifdef LIGHTMAP\n\t\tgiInput.lightmapUV=lightmapUV;\n\t#endif\n\tgiInput.worldPos = worldPos;\n\n\tvec3 worldViewDir = -eyeVec;\n\tmediump vec4 uvwRoughness;\n\tuvwRoughness.rgb = reflect(worldViewDir, worldnormal);//reflectUVW\n\tuvwRoughness.a= smoothnessToPerceptualRoughness(smoothness);//perceptualRoughness\n\n\treturn layaGlobalIllumination(giInput,occlusion, worldnormal, uvwRoughness);\n}\n\n\nvec3 perPixelWorldNormal(vec2 uv,vec3 normal,vec3 binormal,vec3 tangent)\n{\n\t#ifdef NORMALTEXTURE\n\t\tmediump vec3 normalTangent=normalInTangentSpace(uv);\n\t\tvec3 normalWorld = normalize(tangent * normalTangent.x + binormal * normalTangent.y + normal * normalTangent.z);\n\t#else\n\t\tvec3 normalWorld = normalize(normal);\n\t#endif\n\t\treturn normalWorld;\n}\n\nvoid fragmentForward()\n{\n\tvec2 uv;\n\t#if defined(ALBEDOTEXTURE)||defined(METALLICGLOSSTEXTURE)||defined(NORMALTEXTURE)||defined(EMISSIONTEXTURE)||defined(OCCLUSIONTEXTURE)||defined(PARALLAXTEXTURE)\n\t\t#ifdef PARALLAXTEXTURE\n\t\t\tuv = parallax(v_Texcoord0,normalize(v_ViewDirForParallax));\n\t\t#else\n\t\t\tuv = v_Texcoord0;\n\t\t#endif\n\t#endif\n\n\tmediump float alpha = getAlpha(uv);\n\t#ifdef ALPHATEST\n\t\tif(alpha<u_AlphaTestValue)\n\t\t\tdiscard;\n\t#endif\n\n\tFragmentCommonData o = SETUP_BRDF_INPUT(uv);\n\t\n\tvec3 binormal;\n\tvec3 tangent;\n\t#ifdef NORMALTEXTURE\n\t\ttangent = v_Tangent;\n\t\tbinormal = v_Binormal;\n\t#endif\n\n\tvec3 normal = v_Normal;\n\tvec3 normalWorld = perPixelWorldNormal(uv,normal,binormal,tangent);//In FS if the normal use mediump before normalize will cause precision prolem in mobile device.\n\tvec3 eyeVec = normalize(v_EyeVec);\n\tvec3 posworld = v_PositionWorld;\n\n\t#ifdef TRANSPARENTBLEND\n\t\to.diffColor=preMultiplyAlpha(o.diffColor,alpha,o.oneMinusReflectivity,/*out*/alpha);// shader relies on pre-multiply alpha-blend (srcBlend = One, dstBlend = OneMinusSrcAlpha)\n\t#endif\n\n\tmediump float occlusion = getOcclusion(uv);\n\tmediump vec2 lightMapUV;\n\t#ifdef LIGHTMAP\n\t\tlightMapUV=v_LightMapUV;\n\t#endif\n\tfloat perceptualRoughness = smoothnessToPerceptualRoughness(o.smoothness);\n\tfloat roughness = perceptualRoughnessToRoughness(perceptualRoughness);\n\tfloat nv = abs(dot(normalWorld, eyeVec));\n\tLayaGI gi =fragmentGI(o.smoothness,eyeVec,occlusion,lightMapUV,normalWorld,posworld);\n\tvec4 color = LAYA_BRDF_GI(o.diffColor,o.specColor,o.oneMinusReflectivity,o.smoothness,perceptualRoughness,roughness,nv,normalWorld,eyeVec,gi);\n\t\n\tfloat shadowAttenuation = 1.0;\n\t#ifdef LEGACYSINGLELIGHTING\n\t\t#ifdef DIRECTIONLIGHT\n\t\t\t#if defined(CALCULATE_SHADOWS)//shaderifdef if defined\n\t\t\t\t#ifdef SHADOW_CASCADE\n\t\t\t\t\tvec4 shadowCoord = getShadowCoord(vec4(v_PositionWorld,1.0));\n\t\t\t\t#else\n\t\t\t\t\tvec4 shadowCoord = v_ShadowCoord;\n\t\t\t\t#endif\n\t\t\t\tshadowAttenuation=sampleShadowmap(shadowCoord);\n\t\t\t#endif\n\t\t\tLayaLight dirLight = layaDirectionLightToLight(u_DirectionLight,shadowAttenuation);\n\t\t\tcolor+= LAYA_BRDF_LIGHT(o.diffColor,o.specColor,o.oneMinusReflectivity,perceptualRoughness,roughness,nv,normalWorld,eyeVec,dirLight);\n\t\t#endif\n\t\n\t\t#ifdef POINTLIGHT\n\t\t\tshadowAttenuation = 1.0;\n\t\t\tLayaLight poiLight = layaPointLightToLight(posworld,normalWorld,u_PointLight,shadowAttenuation);\n\t\t\tcolor+= LAYA_BRDF_LIGHT(o.diffColor,o.specColor,o.oneMinusReflectivity,perceptualRoughness,roughness,nv,normalWorld,eyeVec,poiLight);\n\t\t#endif\n\t\t\n\t\t#ifdef SPOTLIGHT\n\t\t\tshadowAttenuation = 1.0;\n\t\t\t#if defined(CALCULATE_SPOTSHADOWS)//shaderifdef if defined\n\t\t\t\tvec4 spotShadowcoord = v_SpotShadowCoord;\n\t\t\t\tshadowAttenuation = sampleSpotShadowmap(spotShadowcoord);\n\t\t\t#endif\n\t\t    LayaLight spoLight = layaSpotLightToLight(posworld,normalWorld,u_SpotLight,shadowAttenuation);\n\t\t\tcolor+= LAYA_BRDF_LIGHT(o.diffColor,o.specColor,o.oneMinusReflectivity,perceptualRoughness,roughness,nv,normalWorld,eyeVec,spoLight);\n\t\t#endif\n\t#else\n\t \t#ifdef DIRECTIONLIGHT\n\t\t\tfor (int i = 0; i < MAX_LIGHT_COUNT; i++) \n\t\t\t{\n\t\t\t\tshadowAttenuation = 1.0;\n\t\t\t\tif(i >= u_DirationLightCount)\n\t\t\t\t\tbreak;\n\t\t\t\t#if defined(CALCULATE_SHADOWS)//shaderifdef if defined\n\t\t\t\t\tif(i == 0)\n\t\t\t\t\t{\n\t\t\t\t\t\t#ifdef SHADOW_CASCADE\n\t\t\t\t\t\t\tvec4 shadowCoord = getShadowCoord(vec4(v_PositionWorld,1.0));\n\t\t\t\t\t\t#else\n\t\t\t\t\t\t\tvec4 shadowCoord = v_ShadowCoord;\n\t\t\t\t\t\t#endif\n\t\t\t\t\t\tshadowAttenuation *= sampleShadowmap(shadowCoord);\n\t\t\t\t\t}\n\t\t\t\t#endif\n\t\t\t\tDirectionLight directionLight = getDirectionLight(u_LightBuffer,i);\n\t\t\t\tLayaLight dirLight = layaDirectionLightToLight(directionLight,shadowAttenuation);\n\t\t\t \tcolor+=LAYA_BRDF_LIGHT(o.diffColor,o.specColor,o.oneMinusReflectivity,perceptualRoughness,roughness,nv,normalWorld,eyeVec,dirLight);\n\t\t\t}\n\t \t#endif\n\t\t#if defined(POINTLIGHT)||defined(SPOTLIGHT)\n\t\t\tivec4 clusterInfo =getClusterInfo(u_LightClusterBuffer,u_View,u_Viewport, v_PositionWorld,gl_FragCoord,u_ProjectionParams);\n\t\t\t#ifdef POINTLIGHT\n\t\t\t\tfor (int i = 0; i < MAX_LIGHT_COUNT; i++) \n\t\t\t\t{\n\t\t\t\t\tshadowAttenuation = 1.0;\n\t\t\t\t\tif(i >= clusterInfo.x)//PointLightCount\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tPointLight pointLight = getPointLight(u_LightBuffer,u_LightClusterBuffer,clusterInfo,i);\n\t\t\t\t\tLayaLight poiLight = layaPointLightToLight(posworld,normalWorld,pointLight,shadowAttenuation);\n\t\t\t\t\tcolor+= LAYA_BRDF_LIGHT(o.diffColor,o.specColor,o.oneMinusReflectivity,perceptualRoughness,roughness,nv,normalWorld,eyeVec,poiLight);\n\t\t\t\t}\n\t\t\t#endif\n\t\t\t#ifdef SPOTLIGHT\n\t\t\t\tfor (int i = 0; i < MAX_LIGHT_COUNT; i++) \n\t\t\t\t{\n\t\t\t\t\tshadowAttenuation = 1.0;\n\t\t\t\t\tif(i >= clusterInfo.y)//SpotLightCount\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t#if defined(CALCULATE_SPOTSHADOWS)//shaderifdef if defined\n\t\t\t\t\t\tif(i == 0)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tvec4 spotShadowcoord = v_SpotShadowCoord;\n\t\t\t\t\t\t\tshadowAttenuation= sampleSpotShadowmap(spotShadowcoord);\n\t\t\t\t\t\t}\n\t\t\t\t\t#endif\n\t\t\t\t\tSpotLight spotLight = getSpotLight(u_LightBuffer,u_LightClusterBuffer,clusterInfo,i);\n\t\t\t\t\tLayaLight spoLight = layaSpotLightToLight(posworld,normalWorld,spotLight,shadowAttenuation);\n\t\t\t\t\tcolor+= LAYA_BRDF_LIGHT(o.diffColor,o.specColor,o.oneMinusReflectivity,perceptualRoughness,roughness,nv,normalWorld,eyeVec,spoLight);\n\t\t\t\t}\n\t\t\t#endif\n\t\t#endif\n\t #endif\n\n\t#ifdef EMISSION\n\t\tcolor.rgb += emission(uv);\n\t#endif\n\n\t#ifdef FOG\n\t\tfloat lerpFact=clamp((1.0/gl_FragCoord.w-u_FogStart)/u_FogRange,0.0,1.0);\n\t\tcolor.rgb=mix(color.rgb,u_FogColor,lerpFact);\n\t#endif\n\t\n\tgl_FragColor=vec4(color.rgb,alpha);\n}\n\n\n\n"),xn.addInclude("PBRVertex.glsl","vec2 transformLightMapUV(in vec2 texcoord,in vec4 lightmapScaleOffset)\n{\n\tvec2 lightMapUV=vec2(texcoord.x,1.0-texcoord.y)*lightmapScaleOffset.xy+lightmapScaleOffset.zw;\n\tlightMapUV.y=1.0-lightMapUV.y;\n\treturn lightMapUV; \n}\n\nvoid vertexForward()\n{\n\tvec4 position;\n\t#ifdef BONE\n\t\tmat4 skinTransform;\n\t \t#ifdef SIMPLEBONE\n\t\t\tfloat currentPixelPos;\n\t\t\t#ifdef GPU_INSTANCE\n\t\t\t\tcurrentPixelPos = a_SimpleTextureParams.x+a_SimpleTextureParams.y;\n\t\t\t#else\n\t\t\t\tcurrentPixelPos = u_SimpleAnimatorParams.x+u_SimpleAnimatorParams.y;\n\t\t\t#endif\n\t\t\tfloat offset = 1.0/u_SimpleAnimatorTextureSize;\n\t\t\tskinTransform =  loadMatFromTexture(currentPixelPos,int(a_BoneIndices.x),offset) * a_BoneWeights.x;\n\t\t\tskinTransform += loadMatFromTexture(currentPixelPos,int(a_BoneIndices.y),offset) * a_BoneWeights.y;\n\t\t\tskinTransform += loadMatFromTexture(currentPixelPos,int(a_BoneIndices.z),offset) * a_BoneWeights.z;\n\t\t\tskinTransform += loadMatFromTexture(currentPixelPos,int(a_BoneIndices.w),offset) * a_BoneWeights.w;\n\t\t#else\n\t\t\tskinTransform =  u_Bones[int(a_BoneIndices.x)] * a_BoneWeights.x;\n\t\t\tskinTransform += u_Bones[int(a_BoneIndices.y)] * a_BoneWeights.y;\n\t\t\tskinTransform += u_Bones[int(a_BoneIndices.z)] * a_BoneWeights.z;\n\t\t\tskinTransform += u_Bones[int(a_BoneIndices.w)] * a_BoneWeights.w;\n\t\t#endif\n\t\tposition=skinTransform*a_Position;\n\t #else\n\t\tposition=a_Position;\n\t#endif\n\n\tmat4 worldMat;\n\t#ifdef GPU_INSTANCE\n\t\tworldMat = a_WorldMat;\n\t#else\n\t\tworldMat = u_WorldMat;\n\t#endif\n\n\t#ifdef GPU_INSTANCE\n\t\tgl_Position = u_ViewProjection * worldMat * position;\n\t#else\n\t\tgl_Position = u_MvpMatrix * position;\n\t#endif\n\n\t\n\n\tv_PositionWorld=(worldMat*position).xyz;\n\n\t#if defined(ALBEDOTEXTURE)||defined(METALLICGLOSSTEXTURE)||defined(NORMALTEXTURE)||defined(EMISSIONTEXTURE)||defined(OCCLUSIONTEXTURE)||defined(PARALLAXTEXTURE)\n\t\tv_Texcoord0=TransformUV(a_Texcoord0,u_TilingOffset);\n\t#endif\n\n\tv_EyeVec =u_CameraPos-v_PositionWorld;//will normalize per-pixel\n\n\t#ifdef LIGHTMAP\n\t\tvec2 texcoord;\n\t\t#ifdef UV1\n\t\t\ttexcoord=a_Texcoord1;\n\t\t#else\n\t\t\ttexcoord=a_Texcoord0;\n\t\t#endif\n\t\tv_LightMapUV=transformLightMapUV(texcoord,u_LightmapScaleOffset);\n\t#endif\n\n\tmat3 worldInvMat;\n\t#ifdef BONE\n\t\tworldInvMat=INVERSE_MAT(mat3(worldMat*skinTransform));\n\t#else\n\t\tworldInvMat=INVERSE_MAT(mat3(worldMat));\n\t#endif\n\n\tv_Normal=normalize(a_Normal*worldInvMat);//if no normalize will cause precision problem.\n\n\t#ifdef NORMALTEXTURE\n\t\tv_Tangent=normalize(a_Tangent0.xyz*worldInvMat);\n\t\tv_Binormal=cross(v_Normal,v_Tangent)*a_Tangent0.w;\n\t#endif\n\n\t#ifdef PARALLAXTEXTURE\n\t\tvec3 binormal = cross(a_Normal, a_Tangent0.xyz)*a_Tangent0.w;\n\t\tmat3 objectTBN = mat3(a_Tangent0.xyz, binormal, a_Normal);\n\t\tv_ViewDirForParallax =(u_CameraPos*worldInvMat-position.xyz)*objectTBN;\n\t#endif\n\n\t#if defined(CALCULATE_SHADOWS)&&!defined(SHADOW_CASCADE)\n\t\tv_ShadowCoord = getShadowCoord(vec4(v_PositionWorld,1.0));\n\t#endif\n\n\t#if defined(CALCULATE_SPOTSHADOWS)//shaderifdef if defined\n\t\tv_SpotShadowCoord = u_SpotViewProjectMatrix*vec4(v_PositionWorld,1.0);\n\t#endif\n}"),xn.addInclude("LayaUtile.glsl","\n\n//SimpleSkinnedMesh\n#ifdef SIMPLEBONE\n\t#ifdef GPU_INSTANCE\n\t\tattribute vec4 a_SimpleTextureParams;\n\t#else\n\t\tuniform vec4 u_SimpleAnimatorParams;\n\t#endif\n\tuniform sampler2D u_SimpleAnimatorTexture;\n\n\tuniform float u_SimpleAnimatorTextureSize; \n#endif\n\n\n#ifdef SIMPLEBONE\n\tmat4 loadMatFromTexture(float FramePos,int boneIndices,float offset)\n\t{\n\t\tvec2 uv;\n\t\tfloat PixelPos = FramePos+float(boneIndices)*4.0;\n\t\tfloat halfOffset = offset * 0.5;\n\t\tfloat uvoffset = PixelPos/u_SimpleAnimatorTextureSize;\n\t\tuv.y = floor(uvoffset)*offset+halfOffset;\n\t\tuv.x = mod(float(PixelPos),u_SimpleAnimatorTextureSize)*offset+halfOffset;\n\t\tvec4 mat0row = texture2D(u_SimpleAnimatorTexture,uv);\n\t\tuv.x+=offset;\n\t\tvec4 mat1row = texture2D(u_SimpleAnimatorTexture,uv);\n\t\tuv.x+=offset;\n\t\tvec4 mat2row = texture2D(u_SimpleAnimatorTexture,uv);\n\t\tuv.x+=offset;\n\t\tvec4 mat3row = texture2D(u_SimpleAnimatorTexture,uv);\n\t\tmat4 m =mat4(mat0row.x,mat0row.y,mat0row.z,mat0row.w,\n\t\t\t\tmat1row.x,mat1row.y,mat1row.z,mat1row.w,\n\t\t\t\tmat2row.x,mat2row.y,mat2row.z,mat2row.w,\n\t\t\t\tmat3row.x,mat3row.y,mat3row.z,mat3row.w);\n\t\treturn m;\n\t}\n#endif\n\n"),xn.addInclude("DepthNormalUtil.glsl","#define SAMPLE_DEPTH_TEXTURE(textureName,coord2) (texture2D(textureName,coord2).r)\n//\n\n/*camera Texture*/\nuniform sampler2D u_CameraDepthTexture;\nuniform vec4 u_ZBufferParams;\nuniform sampler2D u_CameraDepthNormalsTexture;\n\n// Encoding/decoding view space normals into 2D 0..1 vector\nvec2 EncodeViewNormalStereo( vec3 n )\n{\n    n.z = abs(n.z);\n    float kScale = 1.7777;\n    vec2 enc;\n    enc = n.xy / (n.z+1.0);\n    enc /= kScale;\n    enc = enc*0.5+0.5;\n    return enc;\n}\n\nvec3 DecodeViewNormalStereo( vec4 enc4 )\n{\n    float kScale = 1.7777;\n    vec3 nn = enc4.xyz*vec3(2.0*kScale,2.0*kScale,0.0) + vec3(-kScale,-kScale,1.0);\n    float g = 2.0 / dot(nn.xyz,nn.xyz);\n    vec3 n;\n    n.xy = g*nn.xy;\n    n.z = g-1.0;\n    return n;\n}\n\n\n// Encoding/decoding [0..1) floats into 8 bit/channel RG. Note that 1.0 will not be encoded properly.\nvec2 EncodeFloatRG( float v )\n{\n    vec2 kEncodeMul = vec2(1.0, 255.0);\n    float kEncodeBit = 1.0/255.0;\n    vec2 enc = kEncodeMul * v;\n    enc = fract(enc);\n    enc.x -= enc.y * kEncodeBit;\n    return enc;\n}\n\n\n\nfloat DecodeFloatRG( vec2 enc )\n{\n    vec2 kDecodeDot = vec2(1.0, 1.0/255.0);\n    return dot( enc, kDecodeDot );\n}\n\nvec4 EncodeDepthNormal(float depth,vec3 normals){\n\tvec4 encode;\n\tencode.xy = EncodeViewNormalStereo(normals);\n\tencode.zw = EncodeFloatRG(depth);\n    return encode;\n}\n\nvoid DecodeDepthNormal( vec4 enc, out float depth, out vec3 normal )\n{\n    depth = DecodeFloatRG (enc.zw);\n    normal = DecodeViewNormalStereo (enc);\n}\n\n\n\nvec4 depthNormalsFragment(vec4 depthNormal)\n{\n    return EncodeDepthNormal(depthNormal.w,depthNormal.xyz);\n}\n\n\n// Z buffer to linear 0..1 depth\nfloat Linear01Depth(float z,vec4 zbufferParams)\n{\n    return 1.0 / (zbufferParams.x * z + zbufferParams.y);\n}\n// Z buffer to linear depth\nfloat LinearEyeDepth(float z,vec4 zbufferParams)\n{\n    return 1.0 / (zbufferParams.z * z + zbufferParams.w);\n}\n");var e={a_Position:Xn.MESH_POSITION0,a_Color:Xn.MESH_COLOR0,a_Normal:Xn.MESH_NORMAL0,a_Texcoord0:Xn.MESH_TEXTURECOORDINATE0,a_Texcoord1:Xn.MESH_TEXTURECOORDINATE1,a_BoneWeights:Xn.MESH_BLENDWEIGHT0,a_BoneIndices:Xn.MESH_BLENDINDICES0,a_Tangent0:Xn.MESH_TANGENT0,a_WorldMat:Xn.MESH_WORLDMATRIX_ROW0,a_SimpleTextureParams:Xn.MESH_SIMPLEANIMATOR},t={u_Bones:xn.PERIOD_CUSTOM,u_DiffuseTexture:xn.PERIOD_MATERIAL,u_SpecularTexture:xn.PERIOD_MATERIAL,u_NormalTexture:xn.PERIOD_MATERIAL,u_AlphaTestValue:xn.PERIOD_MATERIAL,u_DiffuseColor:xn.PERIOD_MATERIAL,u_MaterialSpecular:xn.PERIOD_MATERIAL,u_Shininess:xn.PERIOD_MATERIAL,u_TilingOffset:xn.PERIOD_MATERIAL,u_TransmissionRate:xn.PERIOD_MATERIAL,u_BackDiffuse:xn.PERIOD_MATERIAL,u_BackScale:xn.PERIOD_MATERIAL,u_ThinknessTexture:xn.PERIOD_MATERIAL,u_TransmissionColor:xn.PERIOD_MATERIAL,u_WorldMat:xn.PERIOD_SPRITE,u_MvpMatrix:xn.PERIOD_SPRITE,u_LightmapScaleOffset:xn.PERIOD_SPRITE,u_LightMap:xn.PERIOD_SPRITE,u_LightMapDirection:xn.PERIOD_SPRITE,u_SimpleAnimatorTexture:xn.PERIOD_SPRITE,u_SimpleAnimatorParams:xn.PERIOD_SPRITE,u_SimpleAnimatorTextureSize:xn.PERIOD_SPRITE,u_CameraPos:xn.PERIOD_CAMERA,u_Viewport:xn.PERIOD_CAMERA,u_ProjectionParams:xn.PERIOD_CAMERA,u_View:xn.PERIOD_CAMERA,u_ViewProjection:xn.PERIOD_CAMERA,u_ReflectTexture:xn.PERIOD_SCENE,u_FogStart:xn.PERIOD_SCENE,u_FogRange:xn.PERIOD_SCENE,u_FogColor:xn.PERIOD_SCENE,u_DirationLightCount:xn.PERIOD_SCENE,u_LightBuffer:xn.PERIOD_SCENE,u_LightClusterBuffer:xn.PERIOD_SCENE,u_AmbientColor:xn.PERIOD_SCENE,u_ShadowBias:xn.PERIOD_SCENE,u_ShadowLightDirection:xn.PERIOD_SCENE,u_ShadowMap:xn.PERIOD_SCENE,u_ShadowParams:xn.PERIOD_SCENE,u_ShadowSplitSpheres:xn.PERIOD_SCENE,u_ShadowMatrices:xn.PERIOD_SCENE,u_ShadowMapSize:xn.PERIOD_SCENE,u_SpotShadowMap:xn.PERIOD_SCENE,u_SpotViewProjectMatrix:xn.PERIOD_SCENE,u_ShadowLightPosition:xn.PERIOD_SCENE,u_AmbientSHAr:xn.PERIOD_SCENE,u_AmbientSHAg:xn.PERIOD_SCENE,u_AmbientSHAb:xn.PERIOD_SCENE,u_AmbientSHBr:xn.PERIOD_SCENE,u_AmbientSHBg:xn.PERIOD_SCENE,u_AmbientSHBb:xn.PERIOD_SCENE,u_AmbientSHC:xn.PERIOD_SCENE,"u_DirectionLight.color":xn.PERIOD_SCENE,"u_DirectionLight.direction":xn.PERIOD_SCENE,"u_PointLight.position":xn.PERIOD_SCENE,"u_PointLight.range":xn.PERIOD_SCENE,"u_PointLight.color":xn.PERIOD_SCENE,"u_SpotLight.position":xn.PERIOD_SCENE,"u_SpotLight.direction":xn.PERIOD_SCENE,"u_SpotLight.range":xn.PERIOD_SCENE,"u_SpotLight.spot":xn.PERIOD_SCENE,"u_SpotLight.color":xn.PERIOD_SCENE},n={s_Cull:xn.RENDER_STATE_CULL,s_Blend:xn.RENDER_STATE_BLEND,s_BlendSrc:xn.RENDER_STATE_BLEND_SRC,s_BlendDst:xn.RENDER_STATE_BLEND_DST,s_DepthTest:xn.RENDER_STATE_DEPTH_TEST,s_DepthWrite:xn.RENDER_STATE_DEPTH_WRITE},i=xn.add("BLINNPHONG",null,null,!0),r=new Ya(e,t);i.addSubShader(r),r.addShaderPass('#if defined(GL_FRAGMENT_PRECISION_HIGH)//ifdefined\n\tprecision highp float;\n\tprecision highp int;\n#else\n\tprecision mediump float;\n\tprecision mediump int;\n#endif\n#include "Lighting.glsl";\n#include "LayaUtile.glsl"\n#include "Shadow.glsl";\n\n\nattribute vec4 a_Position;\n\n#ifdef GPU_INSTANCE\n\tuniform mat4 u_ViewProjection;\n#else\n\tuniform mat4 u_MvpMatrix;\n#endif\n\n#if defined(DIFFUSEMAP)||defined(THICKNESSMAP)||((defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT))&&(defined(SPECULARMAP)||defined(NORMALMAP)))||(defined(LIGHTMAP)&&defined(UV))\n\tattribute vec2 a_Texcoord0;\n\tvarying vec2 v_Texcoord0;\n#endif\n\n#if defined(LIGHTMAP)&&defined(UV1)\n\tattribute vec2 a_Texcoord1;\n#endif\n\n#ifdef LIGHTMAP\n\tuniform vec4 u_LightmapScaleOffset;\n\tvarying vec2 v_LightMapUV;\n#endif\n\n#ifdef COLOR\n\tattribute vec4 a_Color;\n\tvarying vec4 v_Color;\n#endif\n\n#ifdef BONE\n\tconst int c_MaxBoneCount = 24;\n\tattribute vec4 a_BoneIndices;\n\tattribute vec4 a_BoneWeights;\n\tuniform mat4 u_Bones[c_MaxBoneCount];\n#endif\n\nattribute vec3 a_Normal;\nvarying vec3 v_Normal; \n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n\tuniform vec3 u_CameraPos;\n\tvarying vec3 v_ViewDir; \n#endif\n\n#if defined(NORMALMAP)\n\tattribute vec4 a_Tangent0;\n\tvarying vec3 v_Tangent;\n\tvarying vec3 v_Binormal;\n#endif\n\n#ifdef GPU_INSTANCE\n\tattribute mat4 a_WorldMat;\n#else\n\tuniform mat4 u_WorldMat;\n#endif\n\n#if defined(POINTLIGHT)||defined(SPOTLIGHT)||(defined(CALCULATE_SHADOWS)&&defined(SHADOW_CASCADE))||defined(CALCULATE_SPOTSHADOWS)\n\tvarying vec3 v_PositionWorld;\n#endif\n\n#if defined(CALCULATE_SHADOWS)&&!defined(SHADOW_CASCADE)\n\tvarying vec4 v_ShadowCoord;\n#endif\n\n#if defined(CALCULATE_SPOTSHADOWS)//shaderifdef if defined\n\tvarying vec4 v_SpotShadowCoord;\n#endif\n\nuniform vec4 u_TilingOffset;\n\nvoid main()\n{\n\tvec4 position;\n\t#ifdef BONE\n\t\tmat4 skinTransform;\n\t \t#ifdef SIMPLEBONE\n\t\t\tfloat currentPixelPos;\n\t\t\t#ifdef GPU_INSTANCE\n\t\t\t\tcurrentPixelPos = a_SimpleTextureParams.x+a_SimpleTextureParams.y;\n\t\t\t#else\n\t\t\t\tcurrentPixelPos = u_SimpleAnimatorParams.x+u_SimpleAnimatorParams.y;\n\t\t\t#endif\n\t\t\tfloat offset = 1.0/u_SimpleAnimatorTextureSize;\n\t\t\tskinTransform =  loadMatFromTexture(currentPixelPos,int(a_BoneIndices.x),offset) * a_BoneWeights.x;\n\t\t\tskinTransform += loadMatFromTexture(currentPixelPos,int(a_BoneIndices.y),offset) * a_BoneWeights.y;\n\t\t\tskinTransform += loadMatFromTexture(currentPixelPos,int(a_BoneIndices.z),offset) * a_BoneWeights.z;\n\t\t\tskinTransform += loadMatFromTexture(currentPixelPos,int(a_BoneIndices.w),offset) * a_BoneWeights.w;\n\t\t#else\n\t\t\tskinTransform =  u_Bones[int(a_BoneIndices.x)] * a_BoneWeights.x;\n\t\t\tskinTransform += u_Bones[int(a_BoneIndices.y)] * a_BoneWeights.y;\n\t\t\tskinTransform += u_Bones[int(a_BoneIndices.z)] * a_BoneWeights.z;\n\t\t\tskinTransform += u_Bones[int(a_BoneIndices.w)] * a_BoneWeights.w;\n\t\t#endif\n\t\tposition=skinTransform*a_Position;\n\t #else\n\t\tposition=a_Position;\n\t#endif\n\n\n\t\n\tmat4 worldMat;\n\t#ifdef GPU_INSTANCE\n\t\tworldMat = a_WorldMat;\n\t#else\n\t\tworldMat = u_WorldMat;\n\t#endif\n\n\t#ifdef GPU_INSTANCE\n\t\tgl_Position = u_ViewProjection * worldMat * position;\n\t#else\n\t\tgl_Position = u_MvpMatrix * position;\n\t#endif\n\n\tmat3 worldInvMat;\n\t#ifdef BONE\n\t\tworldInvMat=INVERSE_MAT(mat3(worldMat*skinTransform));\n\t#else\n\t\tworldInvMat=INVERSE_MAT(mat3(worldMat));\n\t#endif  \n\tv_Normal=normalize(a_Normal*worldInvMat);\n\t#if defined(NORMALMAP)\n\t\tv_Tangent=normalize(a_Tangent0.xyz*worldInvMat);\n\t\tv_Binormal=cross(v_Normal,v_Tangent)*a_Tangent0.w;\n\t#endif\n\n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||(defined(CALCULATE_SHADOWS)&&defined(SHADOW_CASCADE))||defined(CALCULATE_SPOTSHADOWS)\n\t\tvec3 positionWS=(worldMat*position).xyz;\n\t\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n\t\t\tv_ViewDir = u_CameraPos-positionWS;\n\t\t#endif\n\t\t#if defined(POINTLIGHT)||defined(SPOTLIGHT)||(defined(CALCULATE_SHADOWS)&&defined(SHADOW_CASCADE))||defined(CALCULATE_SPOTSHADOWS)\n\t\t\tv_PositionWorld = positionWS;\n\t\t#endif\n\t#endif\n\n\t#if defined(DIFFUSEMAP)||defined(THICKNESSMAP)||((defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT))&&(defined(SPECULARMAP)||defined(NORMALMAP)))\n\t\tv_Texcoord0=TransformUV(a_Texcoord0,u_TilingOffset);\n\t#endif\n\n\t#ifdef LIGHTMAP\n\t\t#ifdef UV1\n\t\t\tv_LightMapUV=vec2(a_Texcoord1.x,1.0-a_Texcoord1.y)*u_LightmapScaleOffset.xy+u_LightmapScaleOffset.zw;\n\t\t#else\n\t\t\tv_LightMapUV=vec2(a_Texcoord0.x,1.0-a_Texcoord0.y)*u_LightmapScaleOffset.xy+u_LightmapScaleOffset.zw;\n\t\t#endif \n\t\tv_LightMapUV.y=1.0-v_LightMapUV.y;\n\t#endif\n\n\t#if defined(COLOR)&&defined(ENABLEVERTEXCOLOR)\n\t\tv_Color=a_Color;\n\t#endif\n\n\t#if defined(CALCULATE_SHADOWS)&&!defined(SHADOW_CASCADE)\n\t\tv_ShadowCoord =getShadowCoord(vec4(positionWS,1.0));\n\t#endif\n\n\t#if defined(CALCULATE_SPOTSHADOWS)//shaderifdef if defined\n\t\tv_SpotShadowCoord = u_SpotViewProjectMatrix*vec4(positionWS,1.0);\n\t#endif\n\n\tgl_Position=remapGLPositionZ(gl_Position);\n}','#if defined(GL_FRAGMENT_PRECISION_HIGH)//ifdefined\n\tprecision highp float;\n\tprecision highp int;\n#else\n\tprecision mediump float;\n\tprecision mediump int;\n#endif\n\n\n#include "Lighting.glsl";\n#include "Shadow.glsl"\n\nuniform vec4 u_DiffuseColor;\n\n#if defined(COLOR)&&defined(ENABLEVERTEXCOLOR)\n\tvarying vec4 v_Color;\n#endif\n\n#ifdef ALPHATEST\n\tuniform float u_AlphaTestValue;\n#endif\n\n#ifdef DIFFUSEMAP\n\tuniform sampler2D u_DiffuseTexture;\n#endif\n\n\n#if defined(DIFFUSEMAP)||defined(THICKNESSMAP)||((defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT))&&(defined(SPECULARMAP)||defined(NORMALMAP)))\n\tvarying vec2 v_Texcoord0;\n#endif\n\n#ifdef LIGHTMAP\n\tvarying vec2 v_LightMapUV;\n\tuniform sampler2D u_LightMap;\n\t#ifdef LIGHTMAP_DIRECTIONAL\n\t\tuniform sampler2D u_LightMapDirection;\n\t#endif\n#endif\n\nvarying vec3 v_Normal;\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n\tvarying vec3 v_ViewDir; \n\n\tuniform vec3 u_MaterialSpecular;\n\tuniform float u_Shininess;\n\n\t#ifdef LEGACYSINGLELIGHTING\n\t\t#ifdef DIRECTIONLIGHT\n\t\t\tuniform DirectionLight u_DirectionLight;\n\t\t#endif\n\t\t#ifdef POINTLIGHT\n\t\t\tuniform PointLight u_PointLight;\n\t\t#endif\n\t\t#ifdef SPOTLIGHT\n\t\t\tuniform SpotLight u_SpotLight;\n\t\t#endif\n\t#else\n\t\tuniform mat4 u_View;\n\t\tuniform vec4 u_ProjectionParams;\n\t\tuniform vec4 u_Viewport;\n\t\tuniform int u_DirationLightCount;\n\t\tuniform sampler2D u_LightBuffer;\n\t\tuniform sampler2D u_LightClusterBuffer;\n\t#endif\n\n\t#ifdef SPECULARMAP \n\t\tuniform sampler2D u_SpecularTexture;\n\t#endif\n#endif\n\n#ifdef NORMALMAP \n\tuniform sampler2D u_NormalTexture;\n\tvarying vec3 v_Tangent;\n\tvarying vec3 v_Binormal;\n#endif\n\n#ifdef FOG\n\tuniform float u_FogStart;\n\tuniform float u_FogRange;\n\tuniform vec3 u_FogColor;\n#endif\n\n#if defined(POINTLIGHT)||defined(SPOTLIGHT)||(defined(CALCULATE_SHADOWS)&&defined(SHADOW_CASCADE))||defined(CALCULATE_SPOTSHADOWS)\n\tvarying vec3 v_PositionWorld;\n#endif\n\n\n#include "GlobalIllumination.glsl";//"GlobalIllumination.glsl use uniform should at front of this\n\n#if defined(CALCULATE_SHADOWS)&&!defined(SHADOW_CASCADE)\n\tvarying vec4 v_ShadowCoord;\n#endif\n\n#if defined(CALCULATE_SPOTSHADOWS)//shaderifdef if defined\n\tvarying vec4 v_SpotShadowCoord;\n#endif\n\n\nvoid main()\n{\n\tvec3 normal;//light and SH maybe use normal\n\t#if defined(NORMALMAP)\n\t\tvec3 normalMapSample = texture2D(u_NormalTexture, v_Texcoord0).rgb;\n\t\tnormal = normalize(NormalSampleToWorldSpace(normalMapSample, v_Normal, v_Tangent,v_Binormal));\n\t#else\n\t\tnormal = normalize(v_Normal);\n\t#endif\n\n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n\t\tvec3 viewDir= normalize(v_ViewDir);\n\t#endif\n\n\tLayaGIInput giInput;\n\t#ifdef LIGHTMAP\t\n\t\tgiInput.lightmapUV=v_LightMapUV;\n\t#endif\n\tvec3 globalDiffuse=layaGIBase(giInput,1.0,normal);\n\t\n\tvec4 mainColor=u_DiffuseColor;\n\t#ifdef DIFFUSEMAP\n\t\tvec4 difTexColor=texture2D(u_DiffuseTexture, v_Texcoord0);\n\t\tmainColor=mainColor*difTexColor;\n\t#endif \n\t#if defined(COLOR)&&defined(ENABLEVERTEXCOLOR)\n\t\tmainColor=mainColor*v_Color;\n\t#endif \n    \n\t#ifdef ALPHATEST\n\t\tif(mainColor.a<u_AlphaTestValue)\n\t\t\tdiscard;\n\t#endif\n  \n\t\n\tvec3 diffuse = vec3(0.0);\n\tvec3 specular= vec3(0.0);\n\tvec3 transmissionDiffuse = vec3(0.0);\n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n\t\tvec3 dif,spe,transmis;\n\t\tfloat transmissionFactor;\n\t\t#ifdef SPECULARMAP\n\t\t\tvec3 gloss=texture2D(u_SpecularTexture, v_Texcoord0).rgb;\n\t\t#else\n\t\t\t#ifdef DIFFUSEMAP\n\t\t\t\tvec3 gloss=vec3(difTexColor.a);\n\t\t\t#else\n\t\t\t\tvec3 gloss=vec3(1.0);\n\t\t\t#endif\n\t\t#endif\n\t\t#ifdef THICKNESSMAP\n\t\t\ttransmissionFactor = texture2D(u_ThinknessTexture, v_Texcoord0).r;\n\t\t#endif\n\t#endif\n\n\t\n\t\n\t#ifdef LEGACYSINGLELIGHTING\n\t\t#ifdef DIRECTIONLIGHT\n\t\t\tLayaAirBlinnPhongDiectionLight(u_MaterialSpecular,u_Shininess,normal,gloss,viewDir,u_DirectionLight,transmissionFactor,dif,spe,transmis);\n\t\t\t#if defined(CALCULATE_SHADOWS)//shaderifdef if defined\n\t\t\t\t#ifdef SHADOW_CASCADE\n\t\t\t\t\tvec4 shadowCoord = getShadowCoord(vec4(v_PositionWorld,1.0));\n\t\t\t\t#else\n\t\t\t\t\tvec4 shadowCoord = v_ShadowCoord;\n\t\t\t\t#endif\n\t\t\t\tfloat shadowAttenuation=sampleShadowmap(shadowCoord);\n\t\t\t\tdif *= shadowAttenuation;\n\t\t\t\tspe *= shadowAttenuation;\n\t\t\t\ttransmis *=shadowAttenuation;\n\t\t\t#endif\n\t\t\tdiffuse+=dif;\n\t\t\tspecular+=spe;\n\t\t\ttransmissionDiffuse+=transmis;\n\t\t#endif\n\t\n\t\t#ifdef POINTLIGHT\n\t\t\tLayaAirBlinnPhongPointLight(v_PositionWorld,u_MaterialSpecular,u_Shininess,normal,gloss,viewDir,u_PointLight,transmissionFactor,dif,spe,transmis);\n\t\t\tdiffuse+=dif;\n\t\t\tspecular+=spe;\n\t\t\ttransmissionDiffuse+=transmis;\n\t\t#endif\n\n\t\t#ifdef SPOTLIGHT\n\t\t\tLayaAirBlinnPhongSpotLight(v_PositionWorld,u_MaterialSpecular,u_Shininess,normal,gloss,viewDir,u_SpotLight,transmissionFactor,dif,spe,transmis);\n\t\t\t#if defined(CALCULATE_SPOTSHADOWS)//shaderifdef if defined\n\t\t\t\tvec4 spotShadowcoord = v_SpotShadowCoord;\n\t\t\t\tfloat spotShadowAttenuation = sampleSpotShadowmap(spotShadowcoord);\n\t\t\t\tdif *= spotShadowAttenuation;\n\t\t\t\tspe *= spotShadowAttenuation;\n\t\t\t\ttransmis *=spotShadowAttenuation;\n\t\t\t#endif\n\t\t\tdiffuse+=dif;\n\t\t\tspecular+=spe;\n\t\t\ttransmissionDiffuse+=transmis;\n\t\t#endif\n\t#else\n\t\t#ifdef DIRECTIONLIGHT\n\t\t\tfor (int i = 0; i < MAX_LIGHT_COUNT; i++) \n\t\t\t{\n\t\t\t\tif(i >= u_DirationLightCount)\n\t\t\t\t\tbreak;\n\t\t\t\tDirectionLight directionLight = getDirectionLight(u_LightBuffer,i);\n\t\t\t\t#if defined(CALCULATE_SHADOWS)//shaderifdef if defined\n\t\t\t\t\tif(i == 0)\n\t\t\t\t\t{\n\t\t\t\t\t\t#ifdef SHADOW_CASCADE\n\t\t\t\t\t\t\tvec4 shadowCoord = getShadowCoord(vec4(v_PositionWorld,1.0));\n\t\t\t\t\t\t#else\n\t\t\t\t\t\t\tvec4 shadowCoord = v_ShadowCoord;\n\t\t\t\t\t\t#endif\n\t\t\t\t\t\tdirectionLight.color *= sampleShadowmap(shadowCoord);\n\t\t\t\t\t}\n\t\t\t\t#endif\n\t\t\t\tLayaAirBlinnPhongDiectionLight(u_MaterialSpecular,u_Shininess,normal,gloss,viewDir,directionLight,transmissionFactor,dif,spe,transmis);\n\t\t\t\tdiffuse+=dif;\n\t\t\t\tspecular+=spe;\n\t\t\t\ttransmissionDiffuse+=transmis;\n\t\t\t}\n\t\t#endif\n\t\t#if defined(POINTLIGHT)||defined(SPOTLIGHT)\n\t\t\tivec4 clusterInfo =getClusterInfo(u_LightClusterBuffer,u_View,u_Viewport, v_PositionWorld,gl_FragCoord,u_ProjectionParams);\n\t\t\t#ifdef POINTLIGHT\n\t\t\t\tfor (int i = 0; i < MAX_LIGHT_COUNT; i++) \n\t\t\t\t{\n\t\t\t\t\tif(i >= clusterInfo.x)//PointLightCount\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tPointLight pointLight = getPointLight(u_LightBuffer,u_LightClusterBuffer,clusterInfo,i);\n\t\t\t\t\tLayaAirBlinnPhongPointLight(v_PositionWorld,u_MaterialSpecular,u_Shininess,normal,gloss,viewDir,pointLight,transmissionFactor,dif,spe,transmis);\n\t\t\t\t\tdiffuse+=dif;\n\t\t\t\t\tspecular+=spe;\n\t\t\t\t\ttransmissionDiffuse+=transmis;\n\t\t\t\t}\n\t\t\t#endif\n\t\t\t#ifdef SPOTLIGHT\n\t\t\t\tfor (int i = 0; i < MAX_LIGHT_COUNT; i++) \n\t\t\t\t{\n\t\t\t\t\tif(i >= clusterInfo.y)//SpotLightCount\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tSpotLight spotLight = getSpotLight(u_LightBuffer,u_LightClusterBuffer,clusterInfo,i);\n\t\t\t\t\t#if defined(CALCULATE_SPOTSHADOWS)//shaderifdef if defined\n\t\t\t\t\t\tif(i == 0)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tvec4 spotShadowcoord = v_SpotShadowCoord;\n\t\t\t\t\t\t\tspotLight.color *= sampleSpotShadowmap(spotShadowcoord);\n\t\t\t\t\t\t}\n\t\t\t\t\t#endif\n\t\t\t\t\tLayaAirBlinnPhongSpotLight(v_PositionWorld,u_MaterialSpecular,u_Shininess,normal,gloss,viewDir,spotLight,transmissionFactor,dif,spe,transmis);\n\t\t\t\t\tdiffuse+=dif;\n\t\t\t\t\tspecular+=spe;\n\t\t\t\t\ttransmissionDiffuse+=transmis;\n\t\t\t\t}\n\t\t\t#endif\n\t\t#endif\n\t#endif\n\n\tgl_FragColor =vec4(mainColor.rgb*(globalDiffuse + diffuse),mainColor.a);\n\n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n\t\tgl_FragColor.rgb+=specular;\n\t#endif\n\n\t#ifdef ENABLETRANSMISSION\n\t\tgl_FragColor.rgb+= transmissionDiffuse;\n\t#endif\n\n\t  \n\t#ifdef FOG\n\t\tfloat lerpFact=clamp((1.0/gl_FragCoord.w-u_FogStart)/u_FogRange,0.0,1.0);\n\t\tgl_FragColor.rgb=mix(gl_FragColor.rgb,u_FogColor,lerpFact);\n\t#endif\n\n\t//gl_FragColor.rgb =transmissionDiffuse;\n}\n\n',n,"Forward"),r.addShaderPass('#include "ShadowCasterVS.glsl"\n\nvoid main()\n{\n\tvec4 positionCS =  shadowCasterVertex();\n\tgl_Position=remapGLPositionZ(positionCS);\n}','#if defined(GL_FRAGMENT_PRECISION_HIGH)//ifdefined\n\tprecision highp float;\n\tprecision highp int;\n#else\n\tprecision mediump float;\n\tprecision mediump int;\n#endif\n\n#include "ShadowCasterFS.glsl"\n\nvoid main()\n{\n\tgl_FragColor=shadowCasterFragment();\n}',n,"ShadowCaster"),r.addShaderPass(Mr,Ur,n,"DepthNormal"),e={a_Position:Xn.MESH_POSITION0,a_Color:Xn.MESH_COLOR0},t={u_MvpMatrix:xn.PERIOD_SPRITE,u_Color:xn.PERIOD_MATERIAL},n={s_Cull:xn.RENDER_STATE_CULL,s_Blend:xn.RENDER_STATE_BLEND,s_BlendSrc:xn.RENDER_STATE_BLEND_SRC,s_BlendDst:xn.RENDER_STATE_BLEND_DST,s_DepthTest:xn.RENDER_STATE_DEPTH_TEST,s_DepthWrite:xn.RENDER_STATE_DEPTH_WRITE},i=xn.add("LineShader"),r=new Ya(e,t),i.addSubShader(r),r.addShaderPass('#if defined(GL_FRAGMENT_PRECISION_HIGH)//ifdefined\nprecision highp float;\n#else\nprecision mediump float;\n#endif\n\n#include "Lighting.glsl";\n\nattribute vec4 a_Position;\nuniform mat4 u_MvpMatrix;\nuniform vec4 u_Color;\nattribute vec4 a_Color;\nvarying vec4 v_Color;\n\n\nvoid main()\n{\n\tgl_Position = u_MvpMatrix * a_Position;\n\tv_Color=a_Color*u_Color;\n\tgl_Position=remapGLPositionZ(gl_Position);\n}',"#if defined(GL_FRAGMENT_PRECISION_HIGH)//ifdefined\nprecision highp float;\n#else\nprecision mediump float;\n#endif\n\nvarying vec4 v_Color;\nuniform vec4 u_Color;\n\nvoid main()\n{\n  gl_FragColor = v_Color * u_Color; \n}\n\n",n),e={a_Position:Xn.MESH_POSITION0,a_Color:Xn.MESH_COLOR0,a_Texcoord0:Xn.MESH_TEXTURECOORDINATE0,a_BoneWeights:Xn.MESH_BLENDWEIGHT0,a_BoneIndices:Xn.MESH_BLENDINDICES0,a_WorldMat:Xn.MESH_WORLDMATRIX_ROW0},t={u_Bones:xn.PERIOD_CUSTOM,u_AlbedoTexture:xn.PERIOD_MATERIAL,u_AlbedoColor:xn.PERIOD_MATERIAL,u_TilingOffset:xn.PERIOD_MATERIAL,u_AlphaTestValue:xn.PERIOD_MATERIAL,u_MvpMatrix:xn.PERIOD_SPRITE,u_ViewProjection:xn.PERIOD_CAMERA,u_SimpleAnimatorTexture:xn.PERIOD_SPRITE,u_SimpleAnimatorParams:xn.PERIOD_SPRITE,u_SimpleAnimatorTextureSize:xn.PERIOD_SPRITE,u_FogStart:xn.PERIOD_SCENE,u_FogRange:xn.PERIOD_SCENE,u_FogColor:xn.PERIOD_SCENE},n={s_Cull:xn.RENDER_STATE_CULL,s_Blend:xn.RENDER_STATE_BLEND,s_BlendSrc:xn.RENDER_STATE_BLEND_SRC,s_BlendDst:xn.RENDER_STATE_BLEND_DST,s_DepthTest:xn.RENDER_STATE_DEPTH_TEST,s_DepthWrite:xn.RENDER_STATE_DEPTH_WRITE},i=xn.add("Unlit",null,null,!0),r=new Ya(e,t),i.addSubShader(r),r.addShaderPass('#if defined(GL_FRAGMENT_PRECISION_HIGH)//ifdefined\n\tprecision highp float;\n#else\n\tprecision mediump float;\n#endif\n#include "Lighting.glsl";\n#include "LayaUtile.glsl";\n\nattribute vec4 a_Position;\n\nattribute vec2 a_Texcoord0;\n\n#ifdef GPU_INSTANCE\n\tuniform mat4 u_ViewProjection;\n\tattribute mat4 a_WorldMat;\n#else\n\tuniform mat4 u_MvpMatrix;\n#endif\n\nattribute vec4 a_Color;\nvarying vec4 v_Color;\nvarying vec2 v_Texcoord0;\n\nuniform vec4 u_TilingOffset;\n\n#ifdef BONE\n\tconst int c_MaxBoneCount = 24;\n\tattribute vec4 a_BoneIndices;\n\tattribute vec4 a_BoneWeights;\n\tuniform mat4 u_Bones[c_MaxBoneCount];\n#endif\n\nvoid main() {\n\tvec4 position;\n\t#ifdef BONE\n\t\tmat4 skinTransform;\n\t \t#ifdef SIMPLEBONE\n\t\t\tfloat currentPixelPos;\n\t\t\t#ifdef GPU_INSTANCE\n\t\t\t\tcurrentPixelPos = a_SimpleTextureParams.x+a_SimpleTextureParams.y;\n\t\t\t#else\n\t\t\t\tcurrentPixelPos = u_SimpleAnimatorParams.x+u_SimpleAnimatorParams.y;\n\t\t\t#endif\n\t\t\tfloat offset = 1.0/u_SimpleAnimatorTextureSize;\n\t\t\tskinTransform =  loadMatFromTexture(currentPixelPos,int(a_BoneIndices.x),offset) * a_BoneWeights.x;\n\t\t\tskinTransform += loadMatFromTexture(currentPixelPos,int(a_BoneIndices.y),offset) * a_BoneWeights.y;\n\t\t\tskinTransform += loadMatFromTexture(currentPixelPos,int(a_BoneIndices.z),offset) * a_BoneWeights.z;\n\t\t\tskinTransform += loadMatFromTexture(currentPixelPos,int(a_BoneIndices.w),offset) * a_BoneWeights.w;\n\t\t#else\n\t\t\tskinTransform =  u_Bones[int(a_BoneIndices.x)] * a_BoneWeights.x;\n\t\t\tskinTransform += u_Bones[int(a_BoneIndices.y)] * a_BoneWeights.y;\n\t\t\tskinTransform += u_Bones[int(a_BoneIndices.z)] * a_BoneWeights.z;\n\t\t\tskinTransform += u_Bones[int(a_BoneIndices.w)] * a_BoneWeights.w;\n\t\t#endif\n\t\tposition=skinTransform*a_Position;\n\t #else\n\t\tposition=a_Position;\n\t#endif\n\t#ifdef GPU_INSTANCE\n\t\tgl_Position =u_ViewProjection * a_WorldMat * position;\n\t#else\n\t\tgl_Position = u_MvpMatrix * position;\n\t#endif\n\n\tv_Texcoord0=TransformUV(a_Texcoord0,u_TilingOffset);\n\n\t#if defined(COLOR)&&defined(ENABLEVERTEXCOLOR)\n\t\tv_Color = a_Color;\n\t#endif\n\tgl_Position=remapGLPositionZ(gl_Position);\n}',"#if defined(GL_FRAGMENT_PRECISION_HIGH)//ifdefined\n\tprecision highp float;\n#else\n\tprecision mediump float;\n#endif\n\n#if defined(COLOR)&&defined(ENABLEVERTEXCOLOR)\n\tvarying vec4 v_Color;\n#endif\n\n#ifdef ALBEDOTEXTURE\n\tuniform sampler2D u_AlbedoTexture;\n\tvarying vec2 v_Texcoord0;\n#endif\n\nuniform vec4 u_AlbedoColor;\n\n#ifdef ALPHATEST\n\tuniform float u_AlphaTestValue;\n#endif\n\n#ifdef FOG\n\tuniform float u_FogStart;\n\tuniform float u_FogRange;\n\t#ifdef ADDTIVEFOG\n\t#else\n\t\tuniform vec3 u_FogColor;\n\t#endif\n#endif\n\nvoid main()\n{\n\tvec4 color =  u_AlbedoColor;\n\t#ifdef ALBEDOTEXTURE\n\t\tcolor *= texture2D(u_AlbedoTexture, v_Texcoord0);\n\t#endif\n\t#if defined(COLOR)&&defined(ENABLEVERTEXCOLOR)\n\t\tcolor *= v_Color;\n\t#endif\n\t\n\t#ifdef ALPHATEST\n\t\tif(color.a < u_AlphaTestValue)\n\t\t\tdiscard;\n\t#endif\n\t\n\tgl_FragColor = color;\n\t\n\t#ifdef FOG\n\t\tfloat lerpFact = clamp((1.0 / gl_FragCoord.w - u_FogStart) / u_FogRange, 0.0, 1.0);\n\t\t#ifdef ADDTIVEFOG\n\t\t\tgl_FragColor.rgb = mix(gl_FragColor.rgb, vec3(0.0), lerpFact);\n\t\t#else\n\t\t\tgl_FragColor.rgb = mix(gl_FragColor.rgb, u_FogColor, lerpFact);\n\t\t#endif\n\t#endif\n\t\n}\n\n",n),e={a_Position:Xn.MESH_POSITION0,a_Texcoord0:Xn.MESH_TEXTURECOORDINATE0,a_BoneWeights:Xn.MESH_BLENDWEIGHT0,a_BoneIndices:Xn.MESH_BLENDINDICES0,a_WorldMat:Xn.MESH_WORLDMATRIX_ROW0},t={u_Bones:xn.PERIOD_CUSTOM,u_AlbedoTexture:xn.PERIOD_MATERIAL,u_AlbedoColor:xn.PERIOD_MATERIAL,u_TilingOffset:xn.PERIOD_MATERIAL,u_AlphaTestValue:xn.PERIOD_MATERIAL,u_ViewProjection:xn.PERIOD_CAMERA,u_MvpMatrix:xn.PERIOD_SPRITE,u_SimpleAnimatorTexture:xn.PERIOD_SPRITE,u_SimpleAnimatorParams:xn.PERIOD_SPRITE,u_SimpleAnimatorTextureSize:xn.PERIOD_SPRITE,u_FogStart:xn.PERIOD_SCENE,u_FogRange:xn.PERIOD_SCENE,u_FogColor:xn.PERIOD_SCENE},n={s_Cull:xn.RENDER_STATE_CULL,s_Blend:xn.RENDER_STATE_BLEND,s_BlendSrc:xn.RENDER_STATE_BLEND_SRC,s_BlendDst:xn.RENDER_STATE_BLEND_DST,s_DepthTest:xn.RENDER_STATE_DEPTH_TEST,s_DepthWrite:xn.RENDER_STATE_DEPTH_WRITE},i=xn.add("Effect",null,null,!0),r=new Ya(e,t),i.addSubShader(r),r.addShaderPass('#if defined(GL_FRAGMENT_PRECISION_HIGH)//ifdefined\n\tprecision highp float;\n#else\n\tprecision mediump float;\n#endif\n#include "Lighting.glsl";\n#include "LayaUtile.glsl";\n\nattribute vec4 a_Position;\nattribute vec4 a_Color;\nattribute vec2 a_Texcoord0;\n\n#ifdef GPU_INSTANCE\n\tuniform mat4 u_ViewProjection;\n\tattribute mat4 a_WorldMat;\n#else\n\tuniform mat4 u_MvpMatrix;\n#endif\n\n#ifdef COLOR\n\tvarying vec4 v_Color;\n#endif\nvarying vec2 v_Texcoord0;\n\nuniform vec4 u_TilingOffset;\n\n#ifdef BONE\n\tconst int c_MaxBoneCount = 24;\n\tattribute vec4 a_BoneIndices;\n\tattribute vec4 a_BoneWeights;\n\tuniform mat4 u_Bones[c_MaxBoneCount];\n#endif\n\n\nvoid main()\n{\n\tvec4 position;\n\t#ifdef BONE\n\t\tmat4 skinTransform;\n\t \t#ifdef SIMPLEBONE\n\t\t\tfloat currentPixelPos;\n\t\t\t#ifdef GPU_INSTANCE\n\t\t\t\tcurrentPixelPos = a_SimpleTextureParams.x+a_SimpleTextureParams.y;\n\t\t\t#else\n\t\t\t\tcurrentPixelPos = u_SimpleAnimatorParams.x+u_SimpleAnimatorParams.y;\n\t\t\t#endif\n\t\t\tfloat offset = 1.0/u_SimpleAnimatorTextureSize;\n\t\t\tskinTransform =  loadMatFromTexture(currentPixelPos,int(a_BoneIndices.x),offset) * a_BoneWeights.x;\n\t\t\tskinTransform += loadMatFromTexture(currentPixelPos,int(a_BoneIndices.y),offset) * a_BoneWeights.y;\n\t\t\tskinTransform += loadMatFromTexture(currentPixelPos,int(a_BoneIndices.z),offset) * a_BoneWeights.z;\n\t\t\tskinTransform += loadMatFromTexture(currentPixelPos,int(a_BoneIndices.w),offset) * a_BoneWeights.w;\n\t\t#else\n\t\t\tskinTransform =  u_Bones[int(a_BoneIndices.x)] * a_BoneWeights.x;\n\t\t\tskinTransform += u_Bones[int(a_BoneIndices.y)] * a_BoneWeights.y;\n\t\t\tskinTransform += u_Bones[int(a_BoneIndices.z)] * a_BoneWeights.z;\n\t\t\tskinTransform += u_Bones[int(a_BoneIndices.w)] * a_BoneWeights.w;\n\t\t#endif\n\t\tposition=skinTransform*a_Position;\n\t #else\n\t\tposition=a_Position;\n\t#endif\n\t#ifdef GPU_INSTANCE\n\t\tgl_Position = u_ViewProjection * a_WorldMat * position;\n\t#else\n\t\tgl_Position = u_MvpMatrix * position;\n\t#endif\n\t\n\tv_Texcoord0=TransformUV(a_Texcoord0,u_TilingOffset);\n\t\t\n\t#ifdef COLOR\n\t\tv_Color = a_Color;\n\t#endif\n\tgl_Position=remapGLPositionZ(gl_Position);\n}',"#if defined(GL_FRAGMENT_PRECISION_HIGH)//ifdefined\n\tprecision highp float;\n#else\n\tprecision mediump float;\n#endif\n\n#ifdef COLOR\n\tvarying vec4 v_Color;\n#endif\nvarying vec2 v_Texcoord0;\n\n#ifdef MAINTEXTURE\n\tuniform sampler2D u_AlbedoTexture;\n#endif\n\nuniform vec4 u_AlbedoColor;\n\n#ifdef FOG\n\tuniform float u_FogStart;\n\tuniform float u_FogRange;\n\t#ifdef ADDTIVEFOG\n\t#else\n\t\tuniform vec3 u_FogColor;\n\t#endif\n#endif\n\nvoid main()\n{\n\tvec4 color =  2.0 * u_AlbedoColor;\n\t#ifdef COLOR\n\t\tcolor *= v_Color;\n\t#endif\n\t#ifdef MAINTEXTURE\n\t\tcolor *= texture2D(u_AlbedoTexture, v_Texcoord0);\n\t#endif\n\t\n\tgl_FragColor = color;\n\t\n\t#ifdef FOG\n\t\tfloat lerpFact = clamp((1.0 / gl_FragCoord.w - u_FogStart) / u_FogRange, 0.0, 1.0);\n\t\t#ifdef ADDTIVEFOG\n\t\t\tgl_FragColor.rgb = mix(gl_FragColor.rgb, vec3(0.0), lerpFact);\n\t\t#else\n\t\t\tgl_FragColor.rgb = mix(gl_FragColor.rgb, u_FogColor, lerpFact);\n\t\t#endif\n\t#endif\n}\n\n",n),e={a_CornerTextureCoordinate:bo.PARTICLE_CORNERTEXTURECOORDINATE0,a_MeshPosition:bo.PARTICLE_POSITION0,a_MeshColor:bo.PARTICLE_COLOR0,a_MeshTextureCoordinate:bo.PARTICLE_TEXTURECOORDINATE0,a_ShapePositionStartLifeTime:bo.PARTICLE_SHAPEPOSITIONSTARTLIFETIME,a_DirectionTime:bo.PARTICLE_DIRECTIONTIME,a_StartColor:bo.PARTICLE_STARTCOLOR0,a_EndColor:bo.PARTICLE_ENDCOLOR0,a_StartSize:bo.PARTICLE_STARTSIZE,a_StartRotation0:bo.PARTICLE_STARTROTATION,a_StartSpeed:bo.PARTICLE_STARTSPEED,a_Random0:bo.PARTICLE_RANDOM0,a_Random1:bo.PARTICLE_RANDOM1,a_SimulationWorldPostion:bo.PARTICLE_SIMULATIONWORLDPOSTION,a_SimulationWorldRotation:bo.PARTICLE_SIMULATIONWORLDROTATION},t={u_Tintcolor:xn.PERIOD_MATERIAL,u_TilingOffset:xn.PERIOD_MATERIAL,u_texture:xn.PERIOD_MATERIAL,u_WorldPosition:xn.PERIOD_SPRITE,u_WorldRotation:xn.PERIOD_SPRITE,u_PositionScale:xn.PERIOD_SPRITE,u_SizeScale:xn.PERIOD_SPRITE,u_ScalingMode:xn.PERIOD_SPRITE,u_Gravity:xn.PERIOD_SPRITE,u_ThreeDStartRotation:xn.PERIOD_SPRITE,u_StretchedBillboardLengthScale:xn.PERIOD_SPRITE,u_StretchedBillboardSpeedScale:xn.PERIOD_SPRITE,u_SimulationSpace:xn.PERIOD_SPRITE,u_CurrentTime:xn.PERIOD_SPRITE,u_ColorOverLifeGradientAlphas:xn.PERIOD_SPRITE,u_ColorOverLifeGradientColors:xn.PERIOD_SPRITE,u_MaxColorOverLifeGradientAlphas:xn.PERIOD_SPRITE,u_MaxColorOverLifeGradientColors:xn.PERIOD_SPRITE,u_VOLVelocityConst:xn.PERIOD_SPRITE,u_VOLVelocityGradientX:xn.PERIOD_SPRITE,u_VOLVelocityGradientY:xn.PERIOD_SPRITE,u_VOLVelocityGradientZ:xn.PERIOD_SPRITE,u_VOLVelocityConstMax:xn.PERIOD_SPRITE,u_VOLVelocityGradientMaxX:xn.PERIOD_SPRITE,u_VOLVelocityGradientMaxY:xn.PERIOD_SPRITE,u_VOLVelocityGradientMaxZ:xn.PERIOD_SPRITE,u_VOLSpaceType:xn.PERIOD_SPRITE,u_SOLSizeGradient:xn.PERIOD_SPRITE,u_SOLSizeGradientX:xn.PERIOD_SPRITE,u_SOLSizeGradientY:xn.PERIOD_SPRITE,u_SOLSizeGradientZ:xn.PERIOD_SPRITE,u_SOLSizeGradientMax:xn.PERIOD_SPRITE,u_SOLSizeGradientMaxX:xn.PERIOD_SPRITE,u_SOLSizeGradientMaxY:xn.PERIOD_SPRITE,u_SOLSizeGradientMaxZ:xn.PERIOD_SPRITE,u_ROLAngularVelocityConst:xn.PERIOD_SPRITE,u_ROLAngularVelocityConstSeprarate:xn.PERIOD_SPRITE,u_ROLAngularVelocityGradient:xn.PERIOD_SPRITE,u_ROLAngularVelocityGradientX:xn.PERIOD_SPRITE,u_ROLAngularVelocityGradientY:xn.PERIOD_SPRITE,u_ROLAngularVelocityGradientZ:xn.PERIOD_SPRITE,u_ROLAngularVelocityConstMax:xn.PERIOD_SPRITE,u_ROLAngularVelocityConstMaxSeprarate:xn.PERIOD_SPRITE,u_ROLAngularVelocityGradientMax:xn.PERIOD_SPRITE,u_ROLAngularVelocityGradientMaxX:xn.PERIOD_SPRITE,u_ROLAngularVelocityGradientMaxY:xn.PERIOD_SPRITE,u_ROLAngularVelocityGradientMaxZ:xn.PERIOD_SPRITE,u_ROLAngularVelocityGradientMaxW:xn.PERIOD_SPRITE,u_TSACycles:xn.PERIOD_SPRITE,u_TSASubUVLength:xn.PERIOD_SPRITE,u_TSAGradientUVs:xn.PERIOD_SPRITE,u_TSAMaxGradientUVs:xn.PERIOD_SPRITE,u_CameraPos:xn.PERIOD_CAMERA,u_CameraDirection:xn.PERIOD_CAMERA,u_CameraUp:xn.PERIOD_CAMERA,u_View:xn.PERIOD_CAMERA,u_Projection:xn.PERIOD_CAMERA,u_FogStart:xn.PERIOD_SCENE,u_FogRange:xn.PERIOD_SCENE,u_FogColor:xn.PERIOD_SCENE},n={s_Cull:xn.RENDER_STATE_CULL,s_Blend:xn.RENDER_STATE_BLEND,s_BlendSrc:xn.RENDER_STATE_BLEND_SRC,s_BlendDst:xn.RENDER_STATE_BLEND_DST,s_DepthTest:xn.RENDER_STATE_DEPTH_TEST,s_DepthWrite:xn.RENDER_STATE_DEPTH_WRITE},i=xn.add("PARTICLESHURIKEN"),r=new Ya(e,t),i.addSubShader(r),r.addShaderPass('// #include "Lighting.glsl";\n\n//\nvec2 TransformUV(vec2 texcoord,vec4 tilingOffset) {\n\tvec2 transTexcoord=vec2(texcoord.x,texcoord.y-1.0)*tilingOffset.xy+vec2(tilingOffset.z,-tilingOffset.w);\n\ttransTexcoord.y+=1.0;\n\treturn transTexcoord;\n}\n\nvec4 remapGLPositionZ(vec4 position) {\n\tposition.z=position.z * 2.0 - position.w;\n\treturn position;\n}\n\n#if defined(GL_FRAGMENT_PRECISION_HIGH)\n  precision highp float;\n#else\n  precision mediump float;\n#endif\n\n#if defined(SPHERHBILLBOARD)||defined(STRETCHEDBILLBOARD)||defined(HORIZONTALBILLBOARD)||defined(VERTICALBILLBOARD)\n\tattribute vec4 a_CornerTextureCoordinate;\n#endif\n#ifdef RENDERMODE_MESH\n\tattribute vec3 a_MeshPosition;\n\tattribute vec4 a_MeshColor;\n\tattribute vec2 a_MeshTextureCoordinate;\n\tvarying vec4 v_MeshColor;\n#endif\n\nattribute vec4 a_ShapePositionStartLifeTime;\nattribute vec4 a_DirectionTime;\nattribute vec4 a_StartColor;\nattribute vec3 a_StartSize;\nattribute vec3 a_StartRotation0;\nattribute float a_StartSpeed;\n#if defined(COLOROVERLIFETIME)||defined(RANDOMCOLOROVERLIFETIME)||defined(SIZEOVERLIFETIMERANDOMCURVES)||defined(SIZEOVERLIFETIMERANDOMCURVESSEPERATE)||defined(ROTATIONOVERLIFETIMERANDOMCONSTANTS)||defined(ROTATIONOVERLIFETIMERANDOMCURVES)\n  attribute vec4 a_Random0;\n#endif\n#if defined(TEXTURESHEETANIMATIONRANDOMCURVE)||defined(VELOCITYOVERLIFETIMERANDOMCONSTANT)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)\n  attribute vec4 a_Random1;\n#endif\nattribute vec3 a_SimulationWorldPostion;\nattribute vec4 a_SimulationWorldRotation;\n\nvarying vec4 v_Color;\n#ifdef DIFFUSEMAP\n\tvarying vec2 v_TextureCoordinate;\n#endif\n\nuniform float u_CurrentTime;\nuniform vec3 u_Gravity;\n\nuniform vec3 u_WorldPosition;\nuniform vec4 u_WorldRotation;\nuniform bool u_ThreeDStartRotation;\nuniform int u_ScalingMode;\nuniform vec3 u_PositionScale;\nuniform vec3 u_SizeScale;\nuniform mat4 u_View;\nuniform mat4 u_Projection;\n\n#ifdef STRETCHEDBILLBOARD\n\tuniform vec3 u_CameraPos;\n#endif\nuniform vec3 u_CameraDirection;//TODO:\nuniform vec3 u_CameraUp;\n\nuniform  float u_StretchedBillboardLengthScale;\nuniform  float u_StretchedBillboardSpeedScale;\nuniform int u_SimulationSpace;\n\n#if defined(VELOCITYOVERLIFETIMECONSTANT)||defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCONSTANT)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)\n  uniform  int  u_VOLSpaceType;\n#endif\n#if defined(VELOCITYOVERLIFETIMECONSTANT)||defined(VELOCITYOVERLIFETIMERANDOMCONSTANT)\n  uniform  vec3 u_VOLVelocityConst;\n#endif\n#if defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)\n  uniform  vec2 u_VOLVelocityGradientX[4];//xkey,y\n  uniform  vec2 u_VOLVelocityGradientY[4];//xkey,y\n  uniform  vec2 u_VOLVelocityGradientZ[4];//xkey,y\n#endif\n#ifdef VELOCITYOVERLIFETIMERANDOMCONSTANT\n  uniform  vec3 u_VOLVelocityConstMax;\n#endif\n#ifdef VELOCITYOVERLIFETIMERANDOMCURVE\n  uniform  vec2 u_VOLVelocityGradientMaxX[4];//xkey,y\n  uniform  vec2 u_VOLVelocityGradientMaxY[4];//xkey,y\n  uniform  vec2 u_VOLVelocityGradientMaxZ[4];//xkey,y\n#endif\n\n#ifdef COLOROVERLIFETIME\n  uniform  vec4 u_ColorOverLifeGradientColors[4];//xkey,yzwColor\n  uniform  vec2 u_ColorOverLifeGradientAlphas[4];//xkey,yAlpha\n#endif\n#ifdef RANDOMCOLOROVERLIFETIME\n  uniform  vec4 u_ColorOverLifeGradientColors[4];//xkey,yzwColor\n  uniform  vec2 u_ColorOverLifeGradientAlphas[4];//xkey,yAlpha\n  uniform  vec4 u_MaxColorOverLifeGradientColors[4];//xkey,yzwColor\n  uniform  vec2 u_MaxColorOverLifeGradientAlphas[4];//xkey,yAlpha\n#endif\n\n\n#if defined(SIZEOVERLIFETIMECURVE)||defined(SIZEOVERLIFETIMERANDOMCURVES)\n  uniform  vec2 u_SOLSizeGradient[4];//xkey,y\n#endif\n#ifdef SIZEOVERLIFETIMERANDOMCURVES\n  uniform  vec2 u_SOLSizeGradientMax[4];//xkey,y\n#endif\n#if defined(SIZEOVERLIFETIMECURVESEPERATE)||defined(SIZEOVERLIFETIMERANDOMCURVESSEPERATE)\n  uniform  vec2 u_SOLSizeGradientX[4];//xkey,y\n  uniform  vec2 u_SOLSizeGradientY[4];//xkey,y\n  uniform  vec2 u_SOLSizeGradientZ[4];//xkey,y\n#endif\n#ifdef SIZEOVERLIFETIMERANDOMCURVESSEPERATE\n  uniform  vec2 u_SOLSizeGradientMaxX[4];//xkey,y\n  uniform  vec2 u_SOLSizeGradientMaxY[4];//xkey,y\n  uniform  vec2 u_SOLSizeGradientMaxZ[4];//xkey,y\n#endif\n\n\n#ifdef ROTATIONOVERLIFETIME\n  #if defined(ROTATIONOVERLIFETIMECONSTANT)||defined(ROTATIONOVERLIFETIMERANDOMCONSTANTS)\n    uniform  float u_ROLAngularVelocityConst;\n  #endif\n  #ifdef ROTATIONOVERLIFETIMERANDOMCONSTANTS\n    uniform  float u_ROLAngularVelocityConstMax;\n  #endif\n  #if defined(ROTATIONOVERLIFETIMECURVE)||defined(ROTATIONOVERLIFETIMERANDOMCURVES)\n    uniform  vec2 u_ROLAngularVelocityGradient[4];//xkey,y\n  #endif\n  #ifdef ROTATIONOVERLIFETIMERANDOMCURVES\n    uniform  vec2 u_ROLAngularVelocityGradientMax[4];//xkey,y\n  #endif\n#endif\n#ifdef ROTATIONOVERLIFETIMESEPERATE\n  #if defined(ROTATIONOVERLIFETIMECONSTANT)||defined(ROTATIONOVERLIFETIMERANDOMCONSTANTS)\n    uniform  vec3 u_ROLAngularVelocityConstSeprarate;\n  #endif\n  #ifdef ROTATIONOVERLIFETIMERANDOMCONSTANTS\n    uniform  vec3 u_ROLAngularVelocityConstMaxSeprarate;\n  #endif\n  #if defined(ROTATIONOVERLIFETIMECURVE)||defined(ROTATIONOVERLIFETIMERANDOMCURVES)\n    uniform  vec2 u_ROLAngularVelocityGradientX[4];\n    uniform  vec2 u_ROLAngularVelocityGradientY[4];\n    uniform  vec2 u_ROLAngularVelocityGradientZ[4];\n  #endif\n  #ifdef ROTATIONOVERLIFETIMERANDOMCURVES\n    uniform  vec2 u_ROLAngularVelocityGradientMaxX[4];\n    uniform  vec2 u_ROLAngularVelocityGradientMaxY[4];\n    uniform  vec2 u_ROLAngularVelocityGradientMaxZ[4];\n\tuniform  vec2 u_ROLAngularVelocityGradientMaxW[4];\n  #endif\n#endif\n\n#if defined(TEXTURESHEETANIMATIONCURVE)||defined(TEXTURESHEETANIMATIONRANDOMCURVE)\n  uniform  float u_TSACycles;\n  uniform  vec2 u_TSASubUVLength;\n  uniform  vec2 u_TSAGradientUVs[4];//xkey,yframe\n#endif\n#ifdef TEXTURESHEETANIMATIONRANDOMCURVE\n  uniform  vec2 u_TSAMaxGradientUVs[4];//xkey,yframe\n#endif\n\nuniform vec4 u_TilingOffset;\n\nvec3 rotationByEuler(in vec3 vector,in vec3 rot)\n{\n\tfloat halfRoll = rot.z * 0.5;\n    float halfPitch = rot.x * 0.5;\n\tfloat halfYaw = rot.y * 0.5;\n\n\tfloat sinRoll = sin(halfRoll);\n\tfloat cosRoll = cos(halfRoll);\n\tfloat sinPitch = sin(halfPitch);\n\tfloat cosPitch = cos(halfPitch);\n\tfloat sinYaw = sin(halfYaw);\n\tfloat cosYaw = cos(halfYaw);\n\n\tfloat quaX = (cosYaw * sinPitch * cosRoll) + (sinYaw * cosPitch * sinRoll);\n\tfloat quaY = (sinYaw * cosPitch * cosRoll) - (cosYaw * sinPitch * sinRoll);\n\tfloat quaZ = (cosYaw * cosPitch * sinRoll) - (sinYaw * sinPitch * cosRoll);\n\tfloat quaW = (cosYaw * cosPitch * cosRoll) + (sinYaw * sinPitch * sinRoll);\n\t\n\t//vec4 q=vec4(quaX,quaY,quaZ,quaW);\n\t//vec3 temp = cross(q.xyz, vector) + q.w * vector;\n\t//return (cross(temp, -q.xyz) + dot(q.xyz,vector) * q.xyz + q.w * temp);\n\t\n\tfloat x = quaX + quaX;\n    float y = quaY + quaY;\n    float z = quaZ + quaZ;\n    float wx = quaW * x;\n    float wy = quaW * y;\n    float wz = quaW * z;\n\tfloat xx = quaX * x;\n    float xy = quaX * y;\n\tfloat xz = quaX * z;\n    float yy = quaY * y;\n    float yz = quaY * z;\n    float zz = quaZ * z;\n\n    return vec3(((vector.x * ((1.0 - yy) - zz)) + (vector.y * (xy - wz))) + (vector.z * (xz + wy)),\n                ((vector.x * (xy + wz)) + (vector.y * ((1.0 - xx) - zz))) + (vector.z * (yz - wx)),\n                ((vector.x * (xz - wy)) + (vector.y * (yz + wx))) + (vector.z * ((1.0 - xx) - yy)));\n\t\n}\n\n//axis\nvec3 rotationByAxis(in vec3 vector,in vec3 axis, in float angle)\n{\n\tfloat halfAngle = angle * 0.5;\n\tfloat sin = sin(halfAngle);\n\t\n\tfloat quaX = axis.x * sin;\n\tfloat quaY = axis.y * sin;\n\tfloat quaZ = axis.z * sin;\n\tfloat quaW = cos(halfAngle);\n\t\n\t//vec4 q=vec4(quaX,quaY,quaZ,quaW);\n\t//vec3 temp = cross(q.xyz, vector) + q.w * vector;\n\t//return (cross(temp, -q.xyz) + dot(q.xyz,vector) * q.xyz + q.w * temp);\n\t\n\tfloat x = quaX + quaX;\n    float y = quaY + quaY;\n    float z = quaZ + quaZ;\n    float wx = quaW * x;\n    float wy = quaW * y;\n    float wz = quaW * z;\n\tfloat xx = quaX * x;\n    float xy = quaX * y;\n\tfloat xz = quaX * z;\n    float yy = quaY * y;\n    float yz = quaY * z;\n    float zz = quaZ * z;\n\n    return vec3(((vector.x * ((1.0 - yy) - zz)) + (vector.y * (xy - wz))) + (vector.z * (xz + wy)),\n                ((vector.x * (xy + wz)) + (vector.y * ((1.0 - xx) - zz))) + (vector.z * (yz - wx)),\n                ((vector.x * (xz - wy)) + (vector.y * (yz + wx))) + (vector.z * ((1.0 - xx) - yy)));\n\t\n}\n\nvec3 rotationByQuaternions(in vec3 v,in vec4 q) \n{\n\treturn v + 2.0 * cross(q.xyz, cross(q.xyz, v) + q.w * v);\n}\n\n \n#if defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)||defined(SIZEOVERLIFETIMECURVE)||defined(SIZEOVERLIFETIMECURVESEPERATE)||defined(SIZEOVERLIFETIMERANDOMCURVES)||defined(SIZEOVERLIFETIMERANDOMCURVESSEPERATE)\nfloat getCurValueFromGradientFloat(in vec2 gradientNumbers[4],in float normalizedAge)\n{\n\tfloat curValue;\n\tfor(int i=1;i<4;i++)\n\t{\n\t\tvec2 gradientNumber=gradientNumbers[i];\n\t\tfloat key=gradientNumber.x;\n\t\tif(key>=normalizedAge)\n\t\t{\n\t\t\tvec2 lastGradientNumber=gradientNumbers[i-1];\n\t\t\tfloat lastKey=lastGradientNumber.x;\n\t\t\tfloat age=(normalizedAge-lastKey)/(key-lastKey);\n\t\t\tcurValue=mix(lastGradientNumber.y,gradientNumber.y,age);\n\t\t\tbreak;\n\t\t}\n\t}\n\treturn curValue;\n}\n#endif\n\n#if defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)||defined(ROTATIONOVERLIFETIMECURVE)||defined(ROTATIONOVERLIFETIMERANDOMCURVES)\nfloat getTotalValueFromGradientFloat(in vec2 gradientNumbers[4],in float normalizedAge)\n{\n\tfloat totalValue=0.0;\n\tfor(int i=1;i<4;i++)\n\t{\n\t\tvec2 gradientNumber=gradientNumbers[i];\n\t\tfloat key=gradientNumber.x;\n\t\tvec2 lastGradientNumber=gradientNumbers[i-1];\n\t\tfloat lastValue=lastGradientNumber.y;\n\t\t\n\t\tif(key>=normalizedAge){\n\t\t\tfloat lastKey=lastGradientNumber.x;\n\t\t\tfloat age=(normalizedAge-lastKey)/(key-lastKey);\n\t\t\ttotalValue+=(lastValue+mix(lastValue,gradientNumber.y,age))/2.0*a_ShapePositionStartLifeTime.w*(normalizedAge-lastKey);\n\t\t\tbreak;\n\t\t}\n\t\telse{\n\t\t\ttotalValue+=(lastValue+gradientNumber.y)/2.0*a_ShapePositionStartLifeTime.w*(key-lastGradientNumber.x);\n\t\t}\n\t}\n\treturn totalValue;\n}\n#endif\n\n#if defined(COLOROVERLIFETIME)||defined(RANDOMCOLOROVERLIFETIME)\nvec4 getColorFromGradient(in vec2 gradientAlphas[4],in vec4 gradientColors[4],in float normalizedAge)\n{\n\tvec4 overTimeColor;\n\tfor(int i=1;i<4;i++)\n\t{\n\t\tvec2 gradientAlpha=gradientAlphas[i];\n\t\tfloat alphaKey=gradientAlpha.x;\n\t\tif(alphaKey>=normalizedAge)\n\t\t{\n\t\t\tvec2 lastGradientAlpha=gradientAlphas[i-1];\n\t\t\tfloat lastAlphaKey=lastGradientAlpha.x;\n\t\t\tfloat age=(normalizedAge-lastAlphaKey)/(alphaKey-lastAlphaKey);\n\t\t\toverTimeColor.a=mix(lastGradientAlpha.y,gradientAlpha.y,age);\n\t\t\tbreak;\n\t\t}\n\t}\n\t\n\tfor(int i=1;i<4;i++)\n\t{\n\t\tvec4 gradientColor=gradientColors[i];\n\t\tfloat colorKey=gradientColor.x;\n\t\tif(colorKey>=normalizedAge)\n\t\t{\n\t\t\tvec4 lastGradientColor=gradientColors[i-1];\n\t\t\tfloat lastColorKey=lastGradientColor.x;\n\t\t\tfloat age=(normalizedAge-lastColorKey)/(colorKey-lastColorKey);\n\t\t\toverTimeColor.rgb=mix(gradientColors[i-1].yzw,gradientColor.yzw,age);\n\t\t\tbreak;\n\t\t}\n\t}\n\treturn overTimeColor;\n}\n#endif\n\n\n#if defined(TEXTURESHEETANIMATIONCURVE)||defined(TEXTURESHEETANIMATIONRANDOMCURVE)\nfloat getFrameFromGradient(in vec2 gradientFrames[4],in float normalizedAge)\n{\n\tfloat overTimeFrame;\n\tfor(int i=1;i<4;i++)\n\t{\n\t\tvec2 gradientFrame=gradientFrames[i];\n\t\tfloat key=gradientFrame.x;\n\t\tif(key>=normalizedAge)\n\t\t{\n\t\t\tvec2 lastGradientFrame=gradientFrames[i-1];\n\t\t\tfloat lastKey=lastGradientFrame.x;\n\t\t\tfloat age=(normalizedAge-lastKey)/(key-lastKey);\n\t\t\toverTimeFrame=mix(lastGradientFrame.y,gradientFrame.y,age);\n\t\t\tbreak;\n\t\t}\n\t}\n\treturn floor(overTimeFrame);\n}\n#endif\n\n#if defined(VELOCITYOVERLIFETIMECONSTANT)||defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCONSTANT)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)\nvec3 computeParticleLifeVelocity(in float normalizedAge)\n{\n  vec3 outLifeVelocity;\n  #ifdef VELOCITYOVERLIFETIMECONSTANT\n\t outLifeVelocity=u_VOLVelocityConst; \n  #endif\n  #ifdef VELOCITYOVERLIFETIMECURVE\n     outLifeVelocity= vec3(getCurValueFromGradientFloat(u_VOLVelocityGradientX,normalizedAge),getCurValueFromGradientFloat(u_VOLVelocityGradientY,normalizedAge),getCurValueFromGradientFloat(u_VOLVelocityGradientZ,normalizedAge));\n  #endif\n  #ifdef VELOCITYOVERLIFETIMERANDOMCONSTANT\n\t outLifeVelocity=mix(u_VOLVelocityConst,u_VOLVelocityConstMax,vec3(a_Random1.y,a_Random1.z,a_Random1.w)); \n  #endif\n  #ifdef VELOCITYOVERLIFETIMERANDOMCURVE\n     outLifeVelocity=vec3(mix(getCurValueFromGradientFloat(u_VOLVelocityGradientX,normalizedAge),getCurValueFromGradientFloat(u_VOLVelocityGradientMaxX,normalizedAge),a_Random1.y),\n\t                 mix(getCurValueFromGradientFloat(u_VOLVelocityGradientY,normalizedAge),getCurValueFromGradientFloat(u_VOLVelocityGradientMaxY,normalizedAge),a_Random1.z),\n\t\t\t\t\t mix(getCurValueFromGradientFloat(u_VOLVelocityGradientZ,normalizedAge),getCurValueFromGradientFloat(u_VOLVelocityGradientMaxZ,normalizedAge),a_Random1.w));\n  #endif\n\t\t\t\t\t\n  return outLifeVelocity;\n} \n#endif\n\nvec3 computeParticlePosition(in vec3 startVelocity, in vec3 lifeVelocity,in float age,in float normalizedAge,vec3 gravityVelocity,vec4 worldRotation)\n{\n   vec3 startPosition;\n   vec3 lifePosition;\n   #if defined(VELOCITYOVERLIFETIMECONSTANT)||defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCONSTANT)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)\n\t#ifdef VELOCITYOVERLIFETIMECONSTANT\n\t\t  startPosition=startVelocity*age;\n\t\t  lifePosition=lifeVelocity*age;\n\t#endif\n\t#ifdef VELOCITYOVERLIFETIMECURVE\n\t\t  startPosition=startVelocity*age;\n\t\t  lifePosition=vec3(getTotalValueFromGradientFloat(u_VOLVelocityGradientX,normalizedAge),getTotalValueFromGradientFloat(u_VOLVelocityGradientY,normalizedAge),getTotalValueFromGradientFloat(u_VOLVelocityGradientZ,normalizedAge));\n\t#endif\n\t#ifdef VELOCITYOVERLIFETIMERANDOMCONSTANT\n\t\t  startPosition=startVelocity*age;\n\t\t  lifePosition=lifeVelocity*age;\n\t#endif\n\t#ifdef VELOCITYOVERLIFETIMERANDOMCURVE\n\t\t  startPosition=startVelocity*age;\n\t\t  lifePosition=vec3(mix(getTotalValueFromGradientFloat(u_VOLVelocityGradientX,normalizedAge),getTotalValueFromGradientFloat(u_VOLVelocityGradientMaxX,normalizedAge),a_Random1.y)\n\t      ,mix(getTotalValueFromGradientFloat(u_VOLVelocityGradientY,normalizedAge),getTotalValueFromGradientFloat(u_VOLVelocityGradientMaxY,normalizedAge),a_Random1.z)\n\t      ,mix(getTotalValueFromGradientFloat(u_VOLVelocityGradientZ,normalizedAge),getTotalValueFromGradientFloat(u_VOLVelocityGradientMaxZ,normalizedAge),a_Random1.w));\n\t#endif\n\t\n\tvec3 finalPosition;\n\tif(u_VOLSpaceType==0){\n\t  if(u_ScalingMode!=2)\n\t   finalPosition =rotationByQuaternions(u_PositionScale*(a_ShapePositionStartLifeTime.xyz+startPosition+lifePosition),worldRotation);\n\t  else\n\t   finalPosition =rotationByQuaternions(u_PositionScale*a_ShapePositionStartLifeTime.xyz+startPosition+lifePosition,worldRotation);\n\t}\n\telse{\n\t  if(u_ScalingMode!=2)\n\t    finalPosition = rotationByQuaternions(u_PositionScale*(a_ShapePositionStartLifeTime.xyz+startPosition),worldRotation)+lifePosition;\n\t  else\n\t    finalPosition = rotationByQuaternions(u_PositionScale*a_ShapePositionStartLifeTime.xyz+startPosition,worldRotation)+lifePosition;\n\t}\n  #else\n\t startPosition=startVelocity*age;\n\t vec3 finalPosition;\n\t if(u_ScalingMode!=2)\n\t\t\tfinalPosition = rotationByQuaternions(u_PositionScale*(a_ShapePositionStartLifeTime.xyz+startPosition),worldRotation);\n\t else\n\t   \tfinalPosition = rotationByQuaternions(u_PositionScale*a_ShapePositionStartLifeTime.xyz+startPosition,worldRotation);\n  #endif\n  \n  if(u_SimulationSpace==0)\n    finalPosition=finalPosition+a_SimulationWorldPostion;\n  else if(u_SimulationSpace==1) \n    finalPosition=finalPosition+u_WorldPosition;\n  \n  finalPosition+=0.5*gravityVelocity*age;\n \n  return  finalPosition;\n}\n\n\nvec4 computeParticleColor(in vec4 color,in float normalizedAge)\n{\n\t#ifdef COLOROVERLIFETIME\n\t  color*=getColorFromGradient(u_ColorOverLifeGradientAlphas,u_ColorOverLifeGradientColors,normalizedAge);\n\t#endif\n\t\n\t#ifdef RANDOMCOLOROVERLIFETIME\n\t  color*=mix(getColorFromGradient(u_ColorOverLifeGradientAlphas,u_ColorOverLifeGradientColors,normalizedAge),getColorFromGradient(u_MaxColorOverLifeGradientAlphas,u_MaxColorOverLifeGradientColors,normalizedAge),a_Random0.y);\n\t#endif\n\n    return color;\n}\n\nvec2 computeParticleSizeBillbard(in vec2 size,in float normalizedAge)\n{\n\t#ifdef SIZEOVERLIFETIMECURVE\n\t\tsize*=getCurValueFromGradientFloat(u_SOLSizeGradient,normalizedAge);\n\t#endif\n\t#ifdef SIZEOVERLIFETIMERANDOMCURVES\n\t    size*=mix(getCurValueFromGradientFloat(u_SOLSizeGradient,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientMax,normalizedAge),a_Random0.z); \n\t#endif\n\t#ifdef SIZEOVERLIFETIMECURVESEPERATE\n\t\tsize*=vec2(getCurValueFromGradientFloat(u_SOLSizeGradientX,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientY,normalizedAge));\n\t#endif\n\t#ifdef SIZEOVERLIFETIMERANDOMCURVESSEPERATE\n\t    size*=vec2(mix(getCurValueFromGradientFloat(u_SOLSizeGradientX,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientMaxX,normalizedAge),a_Random0.z)\n\t    ,mix(getCurValueFromGradientFloat(u_SOLSizeGradientY,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientMaxY,normalizedAge),a_Random0.z));\n\t#endif\n\treturn size;\n}\n\n#ifdef RENDERMODE_MESH\nvec3 computeParticleSizeMesh(in vec3 size,in float normalizedAge)\n{\n\t#ifdef SIZEOVERLIFETIMECURVE\n\t\tsize*=getCurValueFromGradientFloat(u_SOLSizeGradient,normalizedAge);\n\t#endif\n\t#ifdef SIZEOVERLIFETIMERANDOMCURVES\n\t    size*=mix(getCurValueFromGradientFloat(u_SOLSizeGradient,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientMax,normalizedAge),a_Random0.z); \n\t#endif\n\t#ifdef SIZEOVERLIFETIMECURVESEPERATE\n\t\tsize*=vec3(getCurValueFromGradientFloat(u_SOLSizeGradientX,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientY,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientZ,normalizedAge));\n\t#endif\n\t#ifdef SIZEOVERLIFETIMERANDOMCURVESSEPERATE\n\t    size*=vec3(mix(getCurValueFromGradientFloat(u_SOLSizeGradientX,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientMaxX,normalizedAge),a_Random0.z)\n\t    ,mix(getCurValueFromGradientFloat(u_SOLSizeGradientY,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientMaxY,normalizedAge),a_Random0.z)\n\t\t,mix(getCurValueFromGradientFloat(u_SOLSizeGradientZ,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientMaxZ,normalizedAge),a_Random0.z));\n\t#endif\n\treturn size;\n}\n#endif\n\nfloat computeParticleRotationFloat(in float rotation,in float age,in float normalizedAge)\n{ \n\t#ifdef ROTATIONOVERLIFETIME\n\t\t#ifdef ROTATIONOVERLIFETIMECONSTANT\n\t\t\tfloat ageRot=u_ROLAngularVelocityConst*age;\n\t        rotation+=ageRot;\n\t\t#endif\n\t\t#ifdef ROTATIONOVERLIFETIMECURVE\n\t\t\trotation+=getTotalValueFromGradientFloat(u_ROLAngularVelocityGradient,normalizedAge);\n\t\t#endif\n\t\t#ifdef ROTATIONOVERLIFETIMERANDOMCONSTANTS\n\t\t\tfloat ageRot=mix(u_ROLAngularVelocityConst,u_ROLAngularVelocityConstMax,a_Random0.w)*age;\n\t        rotation+=ageRot;\n\t    #endif\n\t\t#ifdef ROTATIONOVERLIFETIMERANDOMCURVES\n\t\t\trotation+=mix(getTotalValueFromGradientFloat(u_ROLAngularVelocityGradient,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientMax,normalizedAge),a_Random0.w);\n\t\t#endif\n\t#endif\n\t#ifdef ROTATIONOVERLIFETIMESEPERATE\n\t\t#ifdef ROTATIONOVERLIFETIMECONSTANT\n\t\t\tfloat ageRot=u_ROLAngularVelocityConstSeprarate.z*age;\n\t        rotation+=ageRot;\n\t\t#endif\n\t\t#ifdef ROTATIONOVERLIFETIMECURVE\n\t\t\trotation+=getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientZ,normalizedAge);\n\t\t#endif\n\t\t#ifdef ROTATIONOVERLIFETIMERANDOMCONSTANTS\n\t\t\tfloat ageRot=mix(u_ROLAngularVelocityConstSeprarate.z,u_ROLAngularVelocityConstMaxSeprarate.z,a_Random0.w)*age;\n\t        rotation+=ageRot;\n\t    #endif\n\t\t#ifdef ROTATIONOVERLIFETIMERANDOMCURVES\n\t\t\trotation+=mix(getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientZ,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientMaxZ,normalizedAge),a_Random0.w));\n\t\t#endif\n\t#endif\n\treturn rotation;\n}\n\n#if defined(RENDERMODE_MESH)&&(defined(ROTATIONOVERLIFETIME)||defined(ROTATIONOVERLIFETIMESEPERATE))\nvec3 computeParticleRotationVec3(in vec3 rotation,in float age,in float normalizedAge)\n{ \n\t#ifdef ROTATIONOVERLIFETIME\n\t#ifdef ROTATIONOVERLIFETIMECONSTANT\n\t\t\tfloat ageRot=u_ROLAngularVelocityConst*age;\n\t        rotation+=ageRot;\n\t\t#endif\n\t\t#ifdef ROTATIONOVERLIFETIMECURVE\n\t\t\trotation+=getTotalValueFromGradientFloat(u_ROLAngularVelocityGradient,normalizedAge);\n\t\t#endif\n\t\t#ifdef ROTATIONOVERLIFETIMERANDOMCONSTANTS\n\t\t\tfloat ageRot=mix(u_ROLAngularVelocityConst,u_ROLAngularVelocityConstMax,a_Random0.w)*age;\n\t        rotation+=ageRot;\n\t    #endif\n\t\t#ifdef ROTATIONOVERLIFETIMERANDOMCURVES\n\t\t\trotation+=mix(getTotalValueFromGradientFloat(u_ROLAngularVelocityGradient,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientMax,normalizedAge),a_Random0.w);\n\t\t#endif\n\t#endif\n\t#ifdef ROTATIONOVERLIFETIMESEPERATE\n\t\t#ifdef ROTATIONOVERLIFETIMECONSTANT\n\t\t\tvec3 ageRot=u_ROLAngularVelocityConstSeprarate*age;\n\t        rotation+=ageRot;\n\t\t#endif\n\t\t#ifdef ROTATIONOVERLIFETIMECURVE\n\t\t\trotation+=vec3(getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientX,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientY,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientZ,normalizedAge));\n\t\t#endif\n\t\t#ifdef ROTATIONOVERLIFETIMERANDOMCONSTANTS\n\t\t\tvec3 ageRot=mix(u_ROLAngularVelocityConstSeprarate,u_ROLAngularVelocityConstMaxSeprarate,a_Random0.w)*age;\n\t        rotation+=ageRot;\n\t    #endif\n\t\t#ifdef ROTATIONOVERLIFETIMERANDOMCURVES\n\t\t\trotation+=vec3(mix(getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientX,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientMaxX,normalizedAge),a_Random0.w)\n\t        ,mix(getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientY,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientMaxY,normalizedAge),a_Random0.w)\n\t        ,mix(getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientZ,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientMaxZ,normalizedAge),a_Random0.w));\n\t\t#endif\n\t#endif\n\treturn rotation;\n}\n#endif\n\nvec2 computeParticleUV(in vec2 uv,in float normalizedAge)\n{ \n\t#ifdef TEXTURESHEETANIMATIONCURVE\n\t\tfloat cycleNormalizedAge=normalizedAge*u_TSACycles;\n\t\tfloat frame=getFrameFromGradient(u_TSAGradientUVs,cycleNormalizedAge-floor(cycleNormalizedAge));\n\t\tfloat totalULength=frame*u_TSASubUVLength.x;\n\t\tfloat floorTotalULength=floor(totalULength);\n\t    uv.x+=totalULength-floorTotalULength;\n\t\tuv.y+=floorTotalULength*u_TSASubUVLength.y;\n    #endif\n\t#ifdef TEXTURESHEETANIMATIONRANDOMCURVE\n\t\tfloat cycleNormalizedAge=normalizedAge*u_TSACycles;\n\t\tfloat uvNormalizedAge=cycleNormalizedAge-floor(cycleNormalizedAge);\n\t    float frame=floor(mix(getFrameFromGradient(u_TSAGradientUVs,uvNormalizedAge),getFrameFromGradient(u_TSAMaxGradientUVs,uvNormalizedAge),a_Random1.x));\n\t\tfloat totalULength=frame*u_TSASubUVLength.x;\n\t\tfloat floorTotalULength=floor(totalULength);\n\t    uv.x+=totalULength-floorTotalULength;\n\t\tuv.y+=floorTotalULength*u_TSASubUVLength.y;\n    #endif\n\treturn uv;\n}\n\nvoid main()\n{\n\tfloat age = u_CurrentTime - a_DirectionTime.w;\n\tfloat normalizedAge = age/a_ShapePositionStartLifeTime.w;\n\tvec3 lifeVelocity;\n\tif(normalizedAge<1.0)\n\t{ \n\t\tvec3 startVelocity=a_DirectionTime.xyz*a_StartSpeed;\n\t\t#if defined(VELOCITYOVERLIFETIMECONSTANT)||defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCONSTANT)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)\n\t\t\tlifeVelocity= computeParticleLifeVelocity(normalizedAge);//\n\t\t#endif \n\t\tvec3 gravityVelocity=u_Gravity*age;\n\t\t\n\t\tvec4 worldRotation;\n\t\tif(u_SimulationSpace==0)\n\t\t\tworldRotation=a_SimulationWorldRotation;\n\t\telse\n\t\t\tworldRotation=u_WorldRotation;\n\t\t\n\t\tvec3 center=computeParticlePosition(startVelocity, lifeVelocity, age, normalizedAge,gravityVelocity,worldRotation);//\n\t\n\t\n\t\t#ifdef SPHERHBILLBOARD\n\t\t\tvec2 corner=a_CornerTextureCoordinate.xy;//Billboardz\n\t\t\tvec3 cameraUpVector =normalize(u_CameraUp);//TODO:\n\t\t\tvec3 sideVector = normalize(cross(u_CameraDirection,cameraUpVector));\n\t\t\tvec3 upVector = normalize(cross(sideVector,u_CameraDirection));\n\t\t\tcorner*=computeParticleSizeBillbard(a_StartSize.xy,normalizedAge);\n\t\t\t#if defined(ROTATIONOVERLIFETIME)||defined(ROTATIONOVERLIFETIMESEPERATE)\n\t\t\t\tif(u_ThreeDStartRotation){\n\t\t\t\t\tvec3 rotation=vec3(a_StartRotation0.xy,computeParticleRotationFloat(a_StartRotation0.z,age,normalizedAge));\n\t\t\t\t\tcenter += u_SizeScale.xzy*rotationByEuler(corner.x*sideVector+corner.y*upVector,rotation);\n\t\t\t\t}\n\t\t\t\telse{\n\t\t\t\t\tfloat rot = computeParticleRotationFloat(a_StartRotation0.x, age,normalizedAge);\n\t\t\t\t\tfloat c = cos(rot);\n\t\t\t\t\tfloat s = sin(rot);\n\t\t\t\t\tmat2 rotation= mat2(c, -s, s, c);\n\t\t\t\t\tcorner=rotation*corner;\n\t\t\t\t\tcenter += u_SizeScale.xzy*(corner.x*sideVector+corner.y*upVector);\n\t\t\t\t}\n\t\t\t#else\n\t\t\t\tif(u_ThreeDStartRotation){\n\t\t\t\t\tcenter += u_SizeScale.xzy*rotationByEuler(corner.x*sideVector+corner.y*upVector,a_StartRotation0);\n\t\t\t\t}\n\t\t\t\telse{\n\t\t\t\t\tfloat c = cos(a_StartRotation0.x);\n\t\t\t\t\tfloat s = sin(a_StartRotation0.x);\n\t\t\t\t\tmat2 rotation= mat2(c, -s, s, c);\n\t\t\t\t\tcorner=rotation*corner;\n\t\t\t\t\tcenter += u_SizeScale.xzy*(corner.x*sideVector+corner.y*upVector);\n\t\t\t\t}\n\t\t\t#endif\n\t\t#endif\n\t\n\t\t#ifdef STRETCHEDBILLBOARD\n\t\t\tvec2 corner=a_CornerTextureCoordinate.xy;//Billboardz\n\t\t\tvec3 velocity;\n\t\t\t#if defined(VELOCITYOVERLIFETIMECONSTANT)||defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCONSTANT)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)\n\t\t\t\tif(u_VOLSpaceType==0)\n\t\t\t\tvelocity=rotationByQuaternions(u_SizeScale*(startVelocity+lifeVelocity),worldRotation)+gravityVelocity;\n\t\t\t\telse\n\t\t\t\tvelocity=rotationByQuaternions(u_SizeScale*startVelocity,worldRotation)+lifeVelocity+gravityVelocity;\n\t\t\t#else\n\t\t\t\tvelocity= rotationByQuaternions(u_SizeScale*startVelocity,worldRotation)+gravityVelocity;\n\t\t\t#endif\t\n\t\t\tvec3 cameraUpVector = normalize(velocity);\n\t\t\tvec3 direction = normalize(center-u_CameraPos);\n\t\t\tvec3 sideVector = normalize(cross(direction,normalize(velocity)));\n\t\t\t\n\t\t\tsideVector=u_SizeScale.xzy*sideVector;\n\t\t\tcameraUpVector=length(vec3(u_SizeScale.x,0.0,0.0))*cameraUpVector;\n\t\t\t\n\t\t\tvec2 size=computeParticleSizeBillbard(a_StartSize.xy,normalizedAge);\n\t\t\t\n\t\t\tconst mat2 rotaionZHalfPI=mat2(0.0, -1.0, 1.0, 0.0);\n\t\t\tcorner=rotaionZHalfPI*corner;\n\t\t\tcorner.y=corner.y-abs(corner.y);\n\t\t\t\n\t\t\tfloat speed=length(velocity);//TODO:\n\t\t\tcenter +=sign(u_SizeScale.x)*(sign(u_StretchedBillboardLengthScale)*size.x*corner.x*sideVector+(speed*u_StretchedBillboardSpeedScale+size.y*u_StretchedBillboardLengthScale)*corner.y*cameraUpVector);\n\t\t#endif\n\t\n\t\t#ifdef HORIZONTALBILLBOARD\n\t\t\tvec2 corner=a_CornerTextureCoordinate.xy;//Billboardz\n\t\t\tconst vec3 cameraUpVector=vec3(0.0,0.0,1.0);\n\t\t\tconst vec3 sideVector = vec3(-1.0,0.0,0.0);\n\t\t\t\n\t\t\tfloat rot = computeParticleRotationFloat(a_StartRotation0.x, age,normalizedAge);\n\t\t\tfloat c = cos(rot);\n\t\t\tfloat s = sin(rot);\n\t\t\tmat2 rotation= mat2(c, -s, s, c);\n\t\t\tcorner=rotation*corner*cos(0.78539816339744830961566084581988);//TODO:cos45,U3D\n\t\t\tcorner*=computeParticleSizeBillbard(a_StartSize.xy,normalizedAge);\n\t\t\tcenter +=u_SizeScale.xzy*(corner.x*sideVector+ corner.y*cameraUpVector);\n\t\t#endif\n\t\n\t\t#ifdef VERTICALBILLBOARD\n\t\t\tvec2 corner=a_CornerTextureCoordinate.xy;//Billboardz\n\t\t\tconst vec3 cameraUpVector =vec3(0.0,1.0,0.0);\n\t\t\tvec3 sideVector = normalize(cross(u_CameraDirection,cameraUpVector));\n\t\t\t\n\t\t\tfloat rot = computeParticleRotationFloat(a_StartRotation0.x, age,normalizedAge);\n\t\t\tfloat c = cos(rot);\n\t\t\tfloat s = sin(rot);\n\t\t\tmat2 rotation= mat2(c, -s, s, c);\n\t\t\tcorner=rotation*corner*cos(0.78539816339744830961566084581988);//TODO:cos45,U3D\n\t\t\tcorner*=computeParticleSizeBillbard(a_StartSize.xy,normalizedAge);\n\t\t\tcenter +=u_SizeScale.xzy*(corner.x*sideVector+ corner.y*cameraUpVector);\n\t\t#endif\n\t\n\t\t#ifdef RENDERMODE_MESH\n\t\t\tvec3 size=computeParticleSizeMesh(a_StartSize,normalizedAge);\n\t\t\t#if defined(ROTATIONOVERLIFETIME)||defined(ROTATIONOVERLIFETIMESEPERATE)\n\t\t\t\tif(u_ThreeDStartRotation){\n\t\t\t\t\tvec3 rotation=vec3(a_StartRotation0.xy,computeParticleRotationFloat(a_StartRotation0.z, age,normalizedAge));\n\t\t\t\t\tcenter+= rotationByQuaternions(u_SizeScale*rotationByEuler(a_MeshPosition*size,rotation),worldRotation);\n\t\t\t\t}\n\t\t\t\telse{\n\t\t\t\t\t#ifdef ROTATIONOVERLIFETIME\n\t\t\t\t\t\tfloat angle=computeParticleRotationFloat(a_StartRotation0.x, age,normalizedAge);\n\t\t\t\t\t\tif(a_ShapePositionStartLifeTime.x!=0.0||a_ShapePositionStartLifeTime.y!=0.0){\n\t\t\t\t\t\t\tcenter+= (rotationByQuaternions(rotationByAxis(u_SizeScale*a_MeshPosition*size,normalize(cross(vec3(0.0,0.0,1.0),vec3(a_ShapePositionStartLifeTime.xy,0.0))),angle),worldRotation));//\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse{\n\t\t\t\t\t\t\t#ifdef SHAPE\n\t\t\t\t\t\t\t\tcenter+= u_SizeScale.xzy*(rotationByQuaternions(rotationByAxis(a_MeshPosition*size,vec3(0.0,-1.0,0.0),angle),worldRotation));\n\t\t\t\t\t\t\t#else\n\t\t\t\t\t\t\t\tif(u_SimulationSpace==0)\n\t\t\t\t\t\t\t\t\tcenter+=rotationByAxis(u_SizeScale*a_MeshPosition*size,vec3(0.0,0.0,-1.0),angle);//\n\t\t\t\t\t\t\t\telse if(u_SimulationSpace==1)\n\t\t\t\t\t\t\t\t\tcenter+=rotationByQuaternions(u_SizeScale*rotationByAxis(a_MeshPosition*size,vec3(0.0,0.0,-1.0),angle),worldRotation);//\n\t\t\t\t\t\t\t#endif\n\t\t\t\t\t\t}\n\t\t\t\t\t#endif\n\t\t\t\t\t#ifdef ROTATIONOVERLIFETIMESEPERATE\n\t\t\t\t\t\t//TODO:if(u_ThreeDStartRotation),\n\t\t\t\t\t\tvec3 angle=computeParticleRotationVec3(vec3(0.0,0.0,-a_StartRotation0.x), age,normalizedAge);\n\t\t\t\t\t\tcenter+= (rotationByQuaternions(rotationByEuler(u_SizeScale*a_MeshPosition*size,vec3(angle.x,angle.y,angle.z)),worldRotation));//\n\t\t\t\t\t#endif\t\t\n\t\t\t\t}\n\t\t\t#else\n\t\t\t\tif(u_ThreeDStartRotation){\n\t\t\t\t\tcenter+= rotationByQuaternions(u_SizeScale*rotationByEuler(a_MeshPosition*size,a_StartRotation0),worldRotation);//\n\t\t\t\t}\n\t\t\t\telse{\n\t\t\t\t\tif(a_ShapePositionStartLifeTime.x!=0.0||a_ShapePositionStartLifeTime.y!=0.0){\n\t\t\t\t\t\tif(u_SimulationSpace==0)\n\t\t\t\t\t\t\tcenter+= rotationByAxis(u_SizeScale*a_MeshPosition*size,normalize(cross(vec3(0.0,0.0,1.0),vec3(a_ShapePositionStartLifeTime.xy,0.0))),a_StartRotation0.x);\n\t\t\t\t\t\telse if(u_SimulationSpace==1)\n\t\t\t\t\t\t\tcenter+= (rotationByQuaternions(u_SizeScale*rotationByAxis(a_MeshPosition*size,normalize(cross(vec3(0.0,0.0,1.0),vec3(a_ShapePositionStartLifeTime.xy,0.0))),a_StartRotation0.x),worldRotation));//\n\t\t\t\t\t}\n\t\t\t\t\telse{\n\t\t\t\t\t\t#ifdef SHAPE\n\t\t\t\t\t\t\tif(u_SimulationSpace==0)\n\t\t\t\t\t\t\t\tcenter+= u_SizeScale*rotationByAxis(a_MeshPosition*size,vec3(0.0,-1.0,0.0),a_StartRotation0.x);\n\t\t\t\t\t\t\telse if(u_SimulationSpace==1)\n\t\t\t\t\t\t\t\tcenter+= rotationByQuaternions(u_SizeScale*rotationByAxis(a_MeshPosition*size,vec3(0.0,-1.0,0.0),a_StartRotation0.x),worldRotation);\t\n\t\t\t\t\t\t#else\n\t\t\t\t\t\t\tif(u_SimulationSpace==0)\n\t\t\t\t\t\t\t\tcenter+= rotationByAxis(u_SizeScale*a_MeshPosition*size,vec3(0.0,0.0,-1.0),a_StartRotation0.x);\n\t\t\t\t\t\t\telse if(u_SimulationSpace==1)\n\t\t\t\t\t\t\t\tcenter+= rotationByQuaternions(u_SizeScale*rotationByAxis(a_MeshPosition*size,vec3(0.0,0.0,-1.0),a_StartRotation0.x),worldRotation);//\n\t\t\t\t\t\t#endif\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t#endif\n\t\t\tv_MeshColor=a_MeshColor;\n\t\t#endif\n\t\n\t\tgl_Position=u_Projection*u_View*vec4(center,1.0);\n\t\tv_Color = computeParticleColor(a_StartColor, normalizedAge);\n\t\t#ifdef DIFFUSEMAP\n\t\t\t#if defined(SPHERHBILLBOARD)||defined(STRETCHEDBILLBOARD)||defined(HORIZONTALBILLBOARD)||defined(VERTICALBILLBOARD)\n\t\t\t\tv_TextureCoordinate =computeParticleUV(a_CornerTextureCoordinate.zw, normalizedAge);\n\t\t\t#endif\n\t\t\t#ifdef RENDERMODE_MESH\n\t\t\t\tv_TextureCoordinate =computeParticleUV(a_MeshTextureCoordinate, normalizedAge);\n\t\t\t#endif\n\t\t\t\n\t\t\tv_TextureCoordinate=TransformUV(v_TextureCoordinate,u_TilingOffset);\n\t\t#endif\n   \t}\n   \telse\n\t{\n\t\tgl_Position=vec4(2.0,2.0,2.0,1.0);//Discard use out of X(-1,1),Y(-1,1),Z(0,1)\n\t}\n\tgl_Position=remapGLPositionZ(gl_Position);\n}\n\n',"#if defined(GL_FRAGMENT_PRECISION_HIGH)//ifdefined\n  precision highp float;\n#else\n  precision mediump float;\n#endif\n\nvarying vec4 v_Color;\nvarying vec2 v_TextureCoordinate;\nuniform sampler2D u_texture;\nuniform vec4 u_Tintcolor;\n\n#ifdef RENDERMODE_MESH\n\tvarying vec4 v_MeshColor;\n#endif\n\n#ifdef FOG\n\tuniform float u_FogStart;\n\tuniform float u_FogRange;\n\t#ifdef ADDTIVEFOG\n\t#else\n\t\tuniform vec3 u_FogColor;\n\t#endif\n#endif\n\n\nvoid main()\n{\t\n\t#ifdef RENDERMODE_MESH\n\t\tgl_FragColor=v_MeshColor;\n\t#else\n\t\tgl_FragColor=vec4(1.0);\t\n\t#endif\n\t\t\n\t#ifdef DIFFUSEMAP\n\t\t#ifdef TINTCOLOR\n\t\t\tgl_FragColor*=texture2D(u_texture,v_TextureCoordinate)*u_Tintcolor*2.0*v_Color;\n\t\t#else\n\t\t\tgl_FragColor*=texture2D(u_texture,v_TextureCoordinate)*v_Color;\n\t\t#endif\n\t#else\n\t\t#ifdef TINTCOLOR\n\t\t\tgl_FragColor*=u_Tintcolor*2.0*v_Color;\n\t\t#else\n\t\t\tgl_FragColor*=v_Color;\n\t\t#endif\n\t#endif\n\t\n\t#ifdef FOG\n\t\tfloat lerpFact=clamp((1.0/gl_FragCoord.w-u_FogStart)/u_FogRange,0.0,1.0);\n\t\t#ifdef ADDTIVEFOG\n\t\t\tgl_FragColor.rgb=mix(gl_FragColor.rgb,vec3(0.0,0.0,0.0),lerpFact);\n\t\t#else\n\t\t\tgl_FragColor.rgb=mix(gl_FragColor.rgb,u_FogColor,lerpFact);\n\t\t#endif\n\t#endif\n}",n),e={a_Position:Xn.MESH_POSITION0},t={u_TintColor:xn.PERIOD_MATERIAL,u_Exposure:xn.PERIOD_MATERIAL,u_Rotation:xn.PERIOD_MATERIAL,u_CubeTexture:xn.PERIOD_MATERIAL,u_ViewProjection:xn.PERIOD_CAMERA},i=xn.add("SkyBox"),r=new Ya(e,t),i.addSubShader(r),r.addShaderPass('#if defined(GL_FRAGMENT_PRECISION_HIGH)//ifdefined\nprecision highp float;\n#else\nprecision mediump float;\n#endif\n#include "Lighting.glsl";\n\nattribute vec4 a_Position;\nuniform mat4 u_ViewProjection;\nuniform float u_Rotation;\nvarying vec3 v_Texcoord;\n\n\nvec4 rotateAroundYInDegrees (vec4 vertex, float degrees)\n{\n\tfloat angle = degrees * 3.141593 / 180.0;\n\tfloat sina=sin(angle);\n\tfloat cosa=cos(angle);\n\tmat2 m = mat2(cosa, -sina, sina, cosa);\n\treturn vec4(m*vertex.xz, vertex.yw).xzyw;\n}\n\t\t\nvoid main()\n{\n\tvec4 position=rotateAroundYInDegrees(a_Position,u_Rotation);\n\tgl_Position = u_ViewProjection*position;\n\tv_Texcoord=vec3(-a_Position.x,a_Position.yz);//\n\tgl_Position=remapGLPositionZ(gl_Position);\n}\n',"#if defined(GL_FRAGMENT_PRECISION_HIGH)//ifdefined\nprecision highp float;\n#else\nprecision mediump float;\n#endif\n\nvarying vec3 v_Texcoord;\n\nuniform samplerCube u_CubeTexture;\nuniform float u_Exposure;\nuniform vec4 u_TintColor;\n\n\nvoid main()\n{\t\n\tvec3 color=textureCube(u_CubeTexture, v_Texcoord).rgb*u_TintColor.rgb*u_Exposure*2.0;\n\tgl_FragColor=vec4(color,1.0);\n}\n\n"),e={a_Position:Xn.MESH_POSITION0},t={u_SunSize:xn.PERIOD_MATERIAL,u_SunSizeConvergence:xn.PERIOD_MATERIAL,u_AtmosphereThickness:xn.PERIOD_MATERIAL,u_SkyTint:xn.PERIOD_MATERIAL,u_GroundTint:xn.PERIOD_MATERIAL,u_Exposure:xn.PERIOD_MATERIAL,u_ViewProjection:xn.PERIOD_CAMERA,"u_SunLight.direction":xn.PERIOD_SCENE,"u_SunLight.color":xn.PERIOD_SCENE},i=xn.add("SkyBoxProcedural"),r=new Ya(e,t),i.addSubShader(r),r.addShaderPass("#if defined(GL_FRAGMENT_PRECISION_HIGH)//ifdefined\n\tprecision highp float;\n#else\n\tprecision mediump float;\n#endif\n\n#include \"Lighting.glsl\";\n\n#define OUTER_RADIUS 1.025\n#define RAYLEIGH (mix(0.0, 0.0025, pow(u_AtmosphereThickness,2.5)))// Rayleigh constant Rayleigh\n#define MIE 0.0010             // Mie constant \n#define SUN_BRIGHTNESS 20.0    // Sun brightness\n#define MAX_SCATTER 50.0 // Maximum scattering value, to prevent math overflows on Adrenos\n\nconst float SKY_GROUND_THRESHOLD = 0.02;\nconst float outerRadius = OUTER_RADIUS;\nconst float outerRadius2 = OUTER_RADIUS*OUTER_RADIUS;\nconst float innerRadius = 1.0;\nconst float innerRadius2 = 1.0;\nconst float cameraHeight = 0.0001;\n\nconst float HDSundiskIntensityFactor = 15.0;\nconst float simpleSundiskIntensityFactor = 27.0;\n\nconst float sunScale = 400.0 * SUN_BRIGHTNESS;\nconst float kmESun = MIE * SUN_BRIGHTNESS;\nconst float km4PI = MIE * 4.0 * 3.14159265;\nconst float scale = 1.0 / (OUTER_RADIUS - 1.0);\nconst float scaleDepth = 0.25;\nconst float scaleOverScaleDepth = (1.0 / (OUTER_RADIUS - 1.0)) / 0.25;\nconst float samples = 2.0; // THIS IS UNROLLED MANUALLY, DON'T TOUCH\n\n// RGB wavelengths        .35 (.62=158), .43 (.68=174), .525 (.75=190)\nconst vec3 c_DefaultScatteringWavelength = vec3(0.65, 0.57, 0.475);//\nconst vec3 c_VariableRangeForScatteringWavelength = vec3(0.15, 0.15, 0.15);//\n\nattribute vec4 a_Position;\n\nuniform mat4 u_ViewProjection;\nuniform vec3 u_SkyTint;\nuniform vec3 u_GroundTint;\nuniform float u_Exposure;\nuniform float u_AtmosphereThickness;\nuniform DirectionLight u_SunLight;\n\nvarying vec3 v_GroundColor;\nvarying vec3 v_SkyColor;\n\n#ifdef SUN_HIGH_QUALITY\n\tvarying vec3 v_Vertex;\n#elif defined(SUN_SIMPLE)\n\tvarying vec3 v_RayDir;\n#else\n\tvarying float v_SkyGroundFactor;\n#endif\n\n#if defined(SUN_HIGH_QUALITY)||defined(SUN_SIMPLE)\n\tvarying vec3 v_SunColor;\n#endif\n\n// Calculates the Rayleigh phase function\nfloat getRayleighPhase(vec3 light, vec3 ray) \n{\n\tfloat eyeCos = dot(light, ray);\n\treturn 0.75 + 0.75*eyeCos*eyeCos;\n}\n\nfloat scaleAngle(float inCos)\n{\n\tfloat x = 1.0 - inCos;\n\treturn 0.25 * exp(-0.00287 + x*(0.459 + x*(3.83 + x*(-6.80 + x*5.25))));\n}\n\n\nvoid main () {\n\tgl_Position = u_ViewProjection*a_Position;\n\n\tvec3 skyTintInGammaSpace = u_SkyTint;//GAMMA\n\tvec3 scatteringWavelength = mix(c_DefaultScatteringWavelength-c_VariableRangeForScatteringWavelength,c_DefaultScatteringWavelength+c_VariableRangeForScatteringWavelength,vec3(1.0) - skyTintInGammaSpace); // using Tint in sRGB+ gamma allows for more visually linear interpolation and to keep (0.5) at (128, gray in sRGB) point\n\tvec3 invWavelength = 1.0 / pow(scatteringWavelength, vec3(4.0));\n\n\tfloat krESun = RAYLEIGH * SUN_BRIGHTNESS;\n\tfloat kr4PI = RAYLEIGH * 4.0 * 3.14159265;\n\n\tvec3 cameraPos = vec3(0.0,innerRadius + cameraHeight,0.0); // The camera's current position\n\n\t// Get the ray from the camera to the vertex and its length (which is the far point of the ray passing through the atmosphere)\n\tvec3 eyeRay = normalize(a_Position.xyz);\n\n\tfloat far = 0.0;\n\tvec3 cIn, cOut;\n\tif (eyeRay.y >= 0.0) {// Sky\n\t\t// Calculate the length of the \"atmosphere\"\n\t\tfar = sqrt(outerRadius2 + innerRadius2 * eyeRay.y * eyeRay.y - innerRadius2) - innerRadius * eyeRay.y;\n\n\t\t// Calculate the ray's starting position, then calculate its scattering offset\n\t\tfloat height = innerRadius + cameraHeight;\n\t\tfloat depth = exp(scaleOverScaleDepth * -cameraHeight);\n\t\tfloat startAngle = dot(eyeRay, cameraPos) / height;\n\t\tfloat startOffset = depth*scaleAngle(startAngle);\n\n\t\t// Initialize the scattering loop variables\n\t\tfloat sampleLength = far / samples;\n\t\tfloat scaledLength = sampleLength * scale;\n\t\tvec3 sampleRay = eyeRay * sampleLength;\n\t\tvec3 samplePoint = cameraPos + sampleRay * 0.5;\n\n\t\tvec3 frontColor = vec3(0.0);\n\t\t//unrolling this manually to avoid some platform for loop slow\n\t\t{\n\t\t\tfloat height = length(samplePoint);\n\t\t\tfloat depth = exp(scaleOverScaleDepth * (innerRadius - height));\n\t\t\tfloat lightAngle = dot(-u_SunLight.direction, samplePoint) / height;\n\t\t\tfloat cameraAngle = dot(eyeRay, samplePoint) / height;\n\t\t\tfloat scatter = (startOffset + depth*(scaleAngle(lightAngle) - scaleAngle(cameraAngle)));\n\t\t\tvec3 attenuate = exp(-clamp(scatter, 0.0, MAX_SCATTER) * (invWavelength * kr4PI + km4PI));\n\n\t\t\tfrontColor += attenuate * (depth * scaledLength);\n\t\t\tsamplePoint += sampleRay;\n\t\t}\n\t\t{\n\t\t\tfloat height = length(samplePoint);\n\t\t\tfloat depth = exp(scaleOverScaleDepth * (innerRadius - height));\n\t\t\tfloat lightAngle = dot(-u_SunLight.direction, samplePoint) / height;\n\t\t\tfloat cameraAngle = dot(eyeRay, samplePoint) / height;\n\t\t\tfloat scatter = (startOffset + depth*(scaleAngle(lightAngle) - scaleAngle(cameraAngle)));\n\t\t\tvec3 attenuate = exp(-clamp(scatter, 0.0, MAX_SCATTER) * (invWavelength * kr4PI + km4PI));\n\n\t\t\tfrontColor += attenuate * (depth * scaledLength);\n\t\t\tsamplePoint += sampleRay;\n\t\t}\n\n\t\t// Finally, scale the Mie and Rayleigh colors and set up the varying variables for the pixel shader\n\t\tcIn = frontColor * (invWavelength * krESun);\n\t\tcOut = frontColor * kmESun;\n\t} else {// Ground\n\t\tfar = (-cameraHeight) / (min(-0.001, eyeRay.y));\n\t\tvec3 pos = cameraPos + far * eyeRay;\n\n\t\t// Calculate the ray's starting position, then calculate its scattering offset\n\t\tfloat depth = exp((-cameraHeight) * (1.0/scaleDepth));\n\t\tfloat cameraAngle = dot(-eyeRay, pos);\n\t\tfloat lightAngle = dot(-u_SunLight.direction, pos);\n\t\tfloat cameraScale = scaleAngle(cameraAngle);\n\t\tfloat lightScale = scaleAngle(lightAngle);\n\t\tfloat cameraOffset = depth*cameraScale;\n\t\tfloat temp = lightScale + cameraScale;\n\n\t\t// Initialize the scattering loop variables\n\t\tfloat sampleLength = far / samples;\n\t\tfloat scaledLength = sampleLength * scale;\n\t\tvec3 sampleRay = eyeRay * sampleLength;\n\t\tvec3 samplePoint = cameraPos + sampleRay * 0.5;\n\n\t\t// Now loop through the sample rays\n\t\tvec3 frontColor = vec3(0.0, 0.0, 0.0);\n\t\tvec3 attenuate;\n\n\t\t// Loop removed because we kept hitting SM2.0 temp variable limits. Doesn't affect the image too much.\n\t\t{\n\t\t\tfloat height = length(samplePoint);\n\t\t\tfloat depth = exp(scaleOverScaleDepth * (innerRadius - height));\n\t\t\tfloat scatter = depth*temp - cameraOffset;\n\t\t\tattenuate = exp(-clamp(scatter, 0.0, MAX_SCATTER) * (invWavelength * kr4PI + km4PI));\n\t\t\tfrontColor += attenuate * (depth * scaledLength);\n\t\t\tsamplePoint += sampleRay;\n\t\t}\n\n\t\tcIn = frontColor * (invWavelength * krESun + kmESun);\n\t\tcOut = clamp(attenuate, 0.0, 1.0);\n\t}\n\n\t#ifdef SUN_HIGH_QUALITY\n\t\tv_Vertex = -a_Position.xyz;\n\t#elif defined(SUN_SIMPLE) \n\t\tv_RayDir = -eyeRay;\n\t#else\n\t\tv_SkyGroundFactor = -eyeRay.y / SKY_GROUND_THRESHOLD;\n\t#endif\n\n\t// if we want to calculate color in vprog:\n\t// in case of linear: multiply by _Exposure in here (even in case of lerp it will be common multiplier, so we can skip mul in fshader)\n\tv_GroundColor = u_Exposure * (cIn + u_GroundTint*u_GroundTint * cOut);//u_GroundColor*u_GroundColor is gamma space convert to linear space\n\tv_SkyColor    = u_Exposure * (cIn * getRayleighPhase(-u_SunLight.direction, -eyeRay));\n\n\t\n\t// The sun should have a stable intensity in its course in the sky. Moreover it should match the highlight of a purely specular material.\n\t// This matching was done using the Unity3D standard shader BRDF1 on the 5/31/2017\n\t// Finally we want the sun to be always bright even in LDR thus the normalization of the lightColor for low intensity.\n\tfloat lightColorIntensity = clamp(length(u_SunLight.color), 0.25, 1.0);\n\n\t#ifdef SUN_HIGH_QUALITY \n\t\tv_SunColor = HDSundiskIntensityFactor * clamp(cOut,0.0,1.0) * u_SunLight.color / lightColorIntensity;\n\t#elif defined(SUN_SIMPLE) \n\t\tv_SunColor = simpleSundiskIntensityFactor * clamp(cOut * sunScale,0.0,1.0) * u_SunLight.color / lightColorIntensity;\n\t#endif\n\tgl_Position=remapGLPositionZ(gl_Position);\n}\n",'#if defined(GL_FRAGMENT_PRECISION_HIGH)//ifdefined\n\tprecision highp float;\n#else\n\tprecision mediump float;\n#endif\n\n#include "Lighting.glsl";\n\nconst float MIE_G = -0.990;\nconst float MIE_G2 = 0.9801;\nconst float SKY_GROUND_THRESHOLD = 0.02;\n\nuniform float u_SunSize;\nuniform float u_SunSizeConvergence;\nuniform DirectionLight u_SunLight;\n\n\nvarying vec3 v_GroundColor;\nvarying vec3 v_SkyColor;\n\n\n#ifdef SUN_HIGH_QUALITY\n\tvarying vec3 v_Vertex;\n#elif defined(SUN_SIMPLE)\n\tvarying vec3 v_RayDir;\n#else\n\tvarying float v_SkyGroundFactor;\n#endif\n\n#if defined(SUN_HIGH_QUALITY)||defined(SUN_SIMPLE)\n\tvarying vec3 v_SunColor;\n#endif\n\n// Calculates the Mie phase function\nfloat getMiePhase(float eyeCos, float eyeCos2) {\n\tfloat temp = 1.0 + MIE_G2 - 2.0 * MIE_G * eyeCos;\n\ttemp = pow(temp, pow(u_SunSize,0.65) * 10.0);\n\ttemp = max(temp,1.0e-4); // prevent division by zero, esp. in half precision\n\ttemp = 1.5 * ((1.0 - MIE_G2) / (2.0 + MIE_G2)) * (1.0 + eyeCos2) / temp;\n\treturn temp;\n}\n\n// Calculates the sun shape\nfloat calcSunAttenuation(vec3 lightPos, vec3 ray) {\n\t#ifdef SUN_HIGH_QUALITY\n\t\tfloat focusedEyeCos = pow(clamp(dot(lightPos, ray),0.0,1.0), u_SunSizeConvergence);\n\t\treturn getMiePhase(-focusedEyeCos, focusedEyeCos * focusedEyeCos);\n\t#else //SUN_SIMPLE\n\t\tvec3 delta = lightPos - ray;\n\t\tfloat dist = length(delta);\n\t\tfloat spot = 1.0 - smoothstep(0.0, u_SunSize, dist);\n\t\treturn spot * spot;\n\t#endif\n}\n\nvoid main() {\n\t// if y > 1 [eyeRay.y < -SKY_GROUND_THRESHOLD] - ground\n\t// if y >= 0 and < 1 [eyeRay.y <= 0 and > -SKY_GROUND_THRESHOLD] - horizon\n\t// if y < 0 [eyeRay.y > 0] - sky\n\tvec3 col = vec3(0.0, 0.0, 0.0);\n\n\t#ifdef SUN_HIGH_QUALITY\n\t\tvec3 ray = normalize(v_Vertex);\n\t\tfloat y = ray.y / SKY_GROUND_THRESHOLD;\n\t#elif defined(SUN_SIMPLE) \n\t\tvec3 ray = v_RayDir;\n\t\tfloat y = ray.y / SKY_GROUND_THRESHOLD;\t\n\t#else\n\t\tfloat y = v_SkyGroundFactor;\n\t#endif\n\n\t// if we did precalculate color in vprog: just do lerp between them\n\tcol = mix(v_SkyColor, v_GroundColor, clamp(y,0.0,1.0));\n\n\t#if defined(SUN_HIGH_QUALITY)||defined(SUN_SIMPLE)\n\t\tif (y < 0.0)\n\t\t\tcol += v_SunColor * calcSunAttenuation(-u_SunLight.direction, -ray);\n\t#endif\n\n\tcol = sqrt(col);//linear space convert to gamma space\n\tgl_FragColor=vec4(col,1.0);\n}\n\n'),e={a_Position:Xn.MESH_POSITION0,a_Normal:Xn.MESH_NORMAL0,a_Texcoord0:Xn.MESH_TEXTURECOORDINATE0},t={u_MvpMatrix:xn.PERIOD_SPRITE,u_WorldMat:xn.PERIOD_SPRITE,u_CameraPos:xn.PERIOD_CAMERA,u_Viewport:xn.PERIOD_CAMERA,u_ProjectionParams:xn.PERIOD_CAMERA,u_View:xn.PERIOD_CAMERA,u_LightmapScaleOffset:xn.PERIOD_SPRITE,u_LightMap:xn.PERIOD_SPRITE,u_SplatAlphaTexture:xn.PERIOD_MATERIAL,u_DiffuseTexture1:xn.PERIOD_MATERIAL,u_DiffuseTexture2:xn.PERIOD_MATERIAL,u_DiffuseTexture3:xn.PERIOD_MATERIAL,u_DiffuseTexture4:xn.PERIOD_MATERIAL,u_DiffuseTexture5:xn.PERIOD_MATERIAL,u_DiffuseScaleOffset1:xn.PERIOD_MATERIAL,u_DiffuseScaleOffset2:xn.PERIOD_MATERIAL,u_DiffuseScaleOffset3:xn.PERIOD_MATERIAL,u_DiffuseScaleOffset4:xn.PERIOD_MATERIAL,u_DiffuseScaleOffset5:xn.PERIOD_MATERIAL,u_FogStart:xn.PERIOD_SCENE,u_FogRange:xn.PERIOD_SCENE,u_FogColor:xn.PERIOD_SCENE,u_DirationLightCount:xn.PERIOD_SCENE,u_LightBuffer:xn.PERIOD_SCENE,u_LightClusterBuffer:xn.PERIOD_SCENE,u_AmbientColor:xn.PERIOD_SCENE,u_ShadowMap:xn.PERIOD_SCENE,u_shadowMap2:xn.PERIOD_SCENE,u_shadowMap3:xn.PERIOD_SCENE,u_ShadowSplitSpheres:xn.PERIOD_SCENE,u_ShadowMatrices:xn.PERIOD_SCENE,u_ShadowMapSize:xn.PERIOD_SCENE,"u_DirectionLight.color":xn.PERIOD_SCENE,"u_DirectionLight.direction":xn.PERIOD_SCENE,"u_PointLight.position":xn.PERIOD_SCENE,"u_PointLight.range":xn.PERIOD_SCENE,"u_PointLight.color":xn.PERIOD_SCENE,"u_SpotLight.position":xn.PERIOD_SCENE,"u_SpotLight.direction":xn.PERIOD_SCENE,"u_SpotLight.range":xn.PERIOD_SCENE,"u_SpotLight.spot":xn.PERIOD_SCENE,"u_SpotLight.color":xn.PERIOD_SCENE},n={s_Cull:xn.RENDER_STATE_CULL,s_Blend:xn.RENDER_STATE_BLEND,s_BlendSrc:xn.RENDER_STATE_BLEND_SRC,s_BlendDst:xn.RENDER_STATE_BLEND_DST,s_DepthTest:xn.RENDER_STATE_DEPTH_TEST,s_DepthWrite:xn.RENDER_STATE_DEPTH_WRITE},i=xn.add("ExtendTerrain"),r=new Ya(e,t),i.addSubShader(r),r.addShaderPass('#include "Lighting.glsl";\n\nattribute vec4 a_Position;\nattribute vec2 a_Texcoord0;\n\nuniform mat4 u_MvpMatrix;\n\nvarying vec2 v_Texcoord0;\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(LIGHTMAP)\n\tattribute vec3 a_Normal;\n\tvarying vec3 v_Normal;\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(FOG)||(defined(CALCULATE_SHADOWS)&&defined(SHADOWMAP_PSSM1))\n\tuniform mat4 u_WorldMat;\n\tvarying vec3 v_PositionWorld;\n#endif\n\n#ifdef LIGHTMAP\n\tvarying vec2 v_LightMapUV;\n\tuniform vec4 u_LightmapScaleOffset;\n#endif\n\n#if defined(CALCULATE_SHADOWS)//shaderifdef if defined\n\tvarying vec4 v_ShadowCoord;\n#endif\n\nvoid main()\n{\n\tgl_Position = u_MvpMatrix * a_Position;\n  \n\tv_Texcoord0 = a_Texcoord0;\n  \n\t#ifdef LIGHTMAP\n\t\tv_LightMapUV = vec2(a_Texcoord0.x, 1.0 - a_Texcoord0.y) * u_LightmapScaleOffset.xy + u_LightmapScaleOffset.zw;\n\t\tv_LightMapUV.y = 1.0 - v_LightMapUV.y;\n\t#endif\n  \n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n\t\tv_Normal = a_Normal;\n\t#endif\n\n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(FOG)||(defined(CALCULATE_SHADOWS)&&defined(SHADOWMAP_PSSM1))\n\t\tv_PositionWorld=(u_WorldMat*a_Position).xyz;\n\t#endif\n\n\t#if defined(CALCULATE_SHADOWS)//shaderifdef if defined\n\t\tv_ShadowCoord = getShadowCoord(vec4(v_PositionWorld));\n\t#endif\n\tgl_Position=remapGLPositionZ(gl_Position);\n}','#if defined(GL_FRAGMENT_PRECISION_HIGH)//ifdefined\n\tprecision highp float;\n#else\n\tprecision mediump float;\n#endif\n\n#include "Lighting.glsl";\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(FOG)\n\tuniform vec3 u_CameraPos;\n\tvarying vec3 v_Normal;\n\tvarying vec3 v_PositionWorld;\n#endif\n\n#ifdef FOG\n\tuniform float u_FogStart;\n\tuniform float u_FogRange;\n\tuniform vec3 u_FogColor;\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n\t#ifdef LEGACYSINGLELIGHTING\n\t\t#ifdef DIRECTIONLIGHT\n\t\t\tuniform DirectionLight u_DirectionLight;\n\t\t#endif\n\t\t#ifdef POINTLIGHT\n\t\t\tuniform PointLight u_PointLight;\n\t\t#endif\n\t\t#ifdef SPOTLIGHT\n\t\t\tuniform SpotLight u_SpotLight;\n\t\t#endif\n\t#else\n\t\tuniform mat4 u_View;\n\t\tuniform vec4 u_ProjectionParams;\n\t\tuniform vec4 u_Viewport;\n\t\tuniform int u_DirationLightCount;\n\t\tuniform sampler2D u_LightBuffer;\n\t\tuniform sampler2D u_LightClusterBuffer;\n\t#endif\n#endif\n\n#include "Shadow.glsl"\n#if defined(CALCULATE_SHADOWS)//shaderifdef if defined\n\tvarying vec4 v_ShadowCoord;\n#endif\nvarying float v_posViewZ;\n\nuniform vec3 u_AmbientColor;\n\nuniform sampler2D u_SplatAlphaTexture;\n\nuniform sampler2D u_DiffuseTexture1;\nuniform sampler2D u_DiffuseTexture2;\nuniform sampler2D u_DiffuseTexture3;\nuniform sampler2D u_DiffuseTexture4;\nuniform sampler2D u_DiffuseTexture5;\n\nuniform vec4 u_DiffuseScaleOffset1;\nuniform vec4 u_DiffuseScaleOffset2;\nuniform vec4 u_DiffuseScaleOffset3;\nuniform vec4 u_DiffuseScaleOffset4;\nuniform vec4 u_DiffuseScaleOffset5;\n\nvarying vec2 v_Texcoord0;\n\n#ifdef LIGHTMAP\n\tuniform sampler2D u_LightMap;\n\tvarying vec2 v_LightMapUV;\n#endif\n\nvoid main()\n{\n\tvec4 splatAlpha = vec4(1.0);\n\t#ifdef ExtendTerrain_DETAIL_NUM1\n\t\tsplatAlpha = texture2D(u_SplatAlphaTexture, v_Texcoord0);\n\t\tvec4 color1 = texture2D(u_DiffuseTexture1, v_Texcoord0 * u_DiffuseScaleOffset1.xy);\n\t\tgl_FragColor.xyz = color1.xyz * splatAlpha.r;\n\t#endif\n\t#ifdef ExtendTerrain_DETAIL_NUM2\n\t\tsplatAlpha = texture2D(u_SplatAlphaTexture, v_Texcoord0);\n\t\tvec4 color1 = texture2D(u_DiffuseTexture1, v_Texcoord0 * u_DiffuseScaleOffset1.xy);\n\t\tvec4 color2 = texture2D(u_DiffuseTexture2, v_Texcoord0 * u_DiffuseScaleOffset2.xy);\n\t\tgl_FragColor.xyz = color1.xyz * splatAlpha.r + color2.xyz * (1.0 - splatAlpha.r);\n\t#endif\n\t#ifdef ExtendTerrain_DETAIL_NUM3\n\t\tsplatAlpha = texture2D(u_SplatAlphaTexture, v_Texcoord0);\n\t\tvec4 color1 = texture2D(u_DiffuseTexture1, v_Texcoord0 * u_DiffuseScaleOffset1.xy);\n\t\tvec4 color2 = texture2D(u_DiffuseTexture2, v_Texcoord0 * u_DiffuseScaleOffset2.xy);\n\t\tvec4 color3 = texture2D(u_DiffuseTexture3, v_Texcoord0 * u_DiffuseScaleOffset3.xy);\n\t\tgl_FragColor.xyz = color1.xyz * splatAlpha.r  + color2.xyz * splatAlpha.g + color3.xyz * (1.0 - splatAlpha.r - splatAlpha.g);\n\t#endif\n\t#ifdef ExtendTerrain_DETAIL_NUM4\n\t\tsplatAlpha = texture2D(u_SplatAlphaTexture, v_Texcoord0);\n\t\tvec4 color1 = texture2D(u_DiffuseTexture1, v_Texcoord0 * u_DiffuseScaleOffset1.xy);\n\t\tvec4 color2 = texture2D(u_DiffuseTexture2, v_Texcoord0 * u_DiffuseScaleOffset2.xy);\n\t\tvec4 color3 = texture2D(u_DiffuseTexture3, v_Texcoord0 * u_DiffuseScaleOffset3.xy);\n\t\tvec4 color4 = texture2D(u_DiffuseTexture4, v_Texcoord0 * u_DiffuseScaleOffset4.xy);\n\t\tgl_FragColor.xyz = color1.xyz * splatAlpha.r  + color2.xyz * splatAlpha.g + color3.xyz * splatAlpha.b + color4.xyz * (1.0 - splatAlpha.r - splatAlpha.g - splatAlpha.b);\n\t#endif\n\t#ifdef ExtendTerrain_DETAIL_NUM5\n\t\tsplatAlpha = texture2D(u_SplatAlphaTexture, v_Texcoord0);\n\t\tvec4 color1 = texture2D(u_DiffuseTexture1, v_Texcoord0 * u_DiffuseScaleOffset1.xy);\n\t\tvec4 color2 = texture2D(u_DiffuseTexture2, v_Texcoord0 * u_DiffuseScaleOffset2.xy);\n\t\tvec4 color3 = texture2D(u_DiffuseTexture3, v_Texcoord0 * u_DiffuseScaleOffset3.xy);\n\t\tvec4 color4 = texture2D(u_DiffuseTexture4, v_Texcoord0 * u_DiffuseScaleOffset4.xy);\n\t\tvec4 color5 = texture2D(u_DiffuseTexture5, v_Texcoord0 * u_DiffuseScaleOffset5.xy);\n\t\tgl_FragColor.xyz = color1.xyz * splatAlpha.r  + color2.xyz * splatAlpha.g + color3.xyz * splatAlpha.b + color4.xyz * splatAlpha.a + color5.xyz * (1.0 - splatAlpha.r - splatAlpha.g - splatAlpha.b - splatAlpha.a);\n\t#endif\n\t\tgl_FragColor.w = splatAlpha.a;\n\t\t\n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n\t\tvec3 normal = v_Normal;\n\t\tvec3 dif, spe;\n\t#endif\n\n\tvec3 diffuse = vec3(0.0);\n\tvec3 specular= vec3(0.0);\n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(FOG)\n\t\tvec3 toEye;\n\t\t#ifdef FOG\n\t\t\ttoEye=u_CameraPos-v_PositionWorld;\n\t\t\tfloat toEyeLength=length(toEye);\n\t\t\ttoEye/=toEyeLength;\n\t\t#else\n\t\t\ttoEye=normalize(u_CameraPos-v_PositionWorld);\n\t\t#endif\n\t#endif\n\n\t#ifdef LEGACYSINGLELIGHTING\n\t\t#ifdef DIRECTIONLIGHT\n\t\t\tLayaAirBlinnPhongDiectionLight(vec3(0.0),1.0,normal,vec3(1.0),toEye,u_DirectionLight,dif,spe);\n\t\t\tdiffuse+=dif;\n\t\t\tspecular+=spe;\n\t\t#endif\n\t\n\t\t#ifdef POINTLIGHT\n\t\t\tLayaAirBlinnPhongPointLight(v_PositionWorld,vec3(0.0),1.0,normal,vec3(1.0),toEye,u_PointLight,dif,spe);\n\t\t\tdiffuse+=dif;\n\t\t\tspecular+=spe;\n\t\t#endif\n\n\t\t#ifdef SPOTLIGHT\n\t\t\tLayaAirBlinnPhongSpotLight(v_PositionWorld,vec3(0.0),1.0,normal,vec3(1.0),toEye,u_SpotLight,dif,spe);\n\t\t\tdiffuse+=dif;\n\t\t\tspecular+=spe;\n\t\t#endif\n\t#else\n\t\t#ifdef DIRECTIONLIGHT\n\t\t\tfor (int i = 0; i < MAX_LIGHT_COUNT; i++) \n\t\t\t{\n\t\t\t\tif(i >= u_DirationLightCount)\n\t\t\t\t\tbreak;\n\t\t\t\tDirectionLight directionLight = getDirectionLight(u_LightBuffer,i);\n\t\t\t\tLayaAirBlinnPhongDiectionLight(vec3(0.0),1.0,normal,vec3(1.0),toEye,directionLight,dif,spe);\n\t\t\t\tdiffuse+=dif;\n\t\t\t\tspecular+=spe;\n\t\t\t}\n\t\t#endif\n\t\t#if defined(POINTLIGHT)||defined(SPOTLIGHT)\n\t\t\tivec4 clusterInfo =getClusterInfo(u_LightClusterBuffer,u_View,u_Viewport, v_PositionWorld,gl_FragCoord,u_ProjectionParams);\n\t\t\t#ifdef POINTLIGHT\n\t\t\t\tfor (int i = 0; i < MAX_LIGHT_COUNT; i++) \n\t\t\t\t{\n\t\t\t\t\tif(i >= clusterInfo.x)//PointLightCount\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tPointLight pointLight = getPointLight(u_LightBuffer,u_LightClusterBuffer,clusterInfo,i);\n\t\t\t\t\tLayaAirBlinnPhongPointLight(v_PositionWorld,vec3(0.0),1.0,normal,vec3(1.0),toEye,pointLight,dif,spe);\n\t\t\t\t\tdiffuse+=dif;\n\t\t\t\t\tspecular+=spe;\n\t\t\t\t}\n\t\t\t#endif\n\t\t\t#ifdef SPOTLIGHT\n\t\t\t\tfor (int i = 0; i < MAX_LIGHT_COUNT; i++) \n\t\t\t\t{\n\t\t\t\t\tif(i >= clusterInfo.y)//SpotLightCount\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tSpotLight spotLight = getSpotLight(u_LightBuffer,u_LightClusterBuffer,clusterInfo,i);\n\t\t\t\t\tLayaAirBlinnPhongSpotLight(v_PositionWorld,vec3(0.0),1.0,normal,vec3(1.0),toEye\t,spotLight,dif,spe);\n\t\t\t\t\tdiffuse+=dif;\n\t\t\t\t\tspecular+=spe;\n\t\t\t\t}\n\t\t\t#endif\n\t\t#endif\n\t#endif\n\nvec3 globalDiffuse = u_AmbientColor;\n#ifdef LIGHTMAP\n\tglobalDiffuse += decodeHDR(texture2D(u_LightMap, v_LightMapUV),5.0);\n#endif\n\n#if defined(CALCULATE_SHADOWS)//shaderifdef if defined\n\tfloat shadowValue = shadowValue = sampleShadowmap(v_ShadowCoord);\n\tgl_FragColor = vec4(gl_FragColor.rgb * (globalDiffuse + diffuse) * shadowValue, gl_FragColor.a);\n#else\n\tgl_FragColor = vec4(gl_FragColor.rgb * (globalDiffuse + diffuse), gl_FragColor.a);\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n\t#if defined(CALCULATE_SHADOWS)//shaderifdef if defined\n\t\tgl_FragColor.rgb += specular * shadowValue;\n\t#else\n\t\tgl_FragColor.rgb += specular;\n\t#endif\n#endif\n\n#ifdef FOG\n\tfloat lerpFact=clamp((toEyeLength-u_FogStart)/u_FogRange,0.0,1.0);\n\tgl_FragColor.rgb=mix(gl_FragColor.rgb,u_FogColor,lerpFact);\n#endif\n}\n\n\n\n\n\n',n),e={a_Position:jo.TRAIL_POSITION0,a_OffsetVector:jo.TRAIL_OFFSETVECTOR,a_Texcoord0X:jo.TRAIL_TEXTURECOORDINATE0X,a_Texcoord0Y:jo.TRAIL_TEXTURECOORDINATE0Y,a_BirthTime:jo.TRAIL_TIME0,a_Color:jo.TRAIL_COLOR},t={u_MvpMatrix:xn.PERIOD_SPRITE,u_View:xn.PERIOD_CAMERA,u_Projection:xn.PERIOD_CAMERA,u_TilingOffset:xn.PERIOD_MATERIAL,u_MainTexture:xn.PERIOD_MATERIAL,u_MainColor:xn.PERIOD_MATERIAL,u_CurTime:xn.PERIOD_SPRITE,u_LifeTime:xn.PERIOD_SPRITE,u_WidthCurve:xn.PERIOD_SPRITE,u_WidthCurveKeyLength:xn.PERIOD_SPRITE,u_GradientColorkey:xn.PERIOD_SPRITE,u_GradientAlphakey:xn.PERIOD_SPRITE},n={s_Cull:xn.RENDER_STATE_CULL,s_Blend:xn.RENDER_STATE_BLEND,s_BlendSrc:xn.RENDER_STATE_BLEND_SRC,s_BlendDst:xn.RENDER_STATE_BLEND_DST,s_DepthTest:xn.RENDER_STATE_DEPTH_TEST,s_DepthWrite:xn.RENDER_STATE_DEPTH_WRITE},i=xn.add("Trail"),r=new Ya(e,t),i.addSubShader(r),r.addShaderPass('#if defined(GL_FRAGMENT_PRECISION_HIGH)//ifdefined\n\tprecision highp float;\n#else\n\tprecision mediump float;\n#endif\n#include "Lighting.glsl";\n\nattribute vec3 a_Position;\nattribute vec3 a_OffsetVector;\nattribute vec4 a_Color;\nattribute float a_Texcoord0X;\nattribute float a_Texcoord0Y;\nattribute float a_BirthTime;\n\nuniform mat4 u_View;\nuniform mat4 u_Projection;\n\nuniform vec4 u_TilingOffset;\n\nuniform float u_CurTime;\nuniform float u_LifeTime;\nuniform vec4 u_WidthCurve[10];\nuniform int u_WidthCurveKeyLength;\n\nvarying vec2 v_Texcoord0;\nvarying vec4 v_Color;\n\nfloat hermiteInterpolate(float t, float outTangent, float inTangent, float duration, float value1, float value2)\n{\n\tfloat t2 = t * t;\n\tfloat t3 = t2 * t;\n\tfloat a = 2.0 * t3 - 3.0 * t2 + 1.0;\n\tfloat b = t3 - 2.0 * t2 + t;\n\tfloat c = t3 - t2;\n\tfloat d = -2.0 * t3 + 3.0 * t2;\n\treturn a * value1 + b * outTangent * duration + c * inTangent * duration + d * value2;\n}\n\nfloat getCurWidth(in float normalizeTime)\n{\n\tfloat width;\n\tif(normalizeTime == 0.0){\n\t\twidth=u_WidthCurve[0].w;\n\t}\n\telse if(normalizeTime >= 1.0){\n\t\twidth=u_WidthCurve[u_WidthCurveKeyLength - 1].w;\n\t}\n\telse{\n\t\tfor(int i = 0; i < 10; i ++ )\n\t\t{\n\t\t\tif(normalizeTime == u_WidthCurve[i].x){\n\t\t\t\twidth=u_WidthCurve[i].w;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\t\n\t\t\tvec4 lastFrame = u_WidthCurve[i];\n\t\t\tvec4 nextFrame = u_WidthCurve[i + 1];\n\t\t\tif(normalizeTime > lastFrame.x && normalizeTime < nextFrame.x)\n\t\t\t{\n\t\t\t\tfloat duration = nextFrame.x - lastFrame.x;\n\t\t\t\tfloat t = (normalizeTime - lastFrame.x) / duration;\n\t\t\t\tfloat outTangent = lastFrame.z;\n\t\t\t\tfloat inTangent = nextFrame.y;\n\t\t\t\tfloat value1 = lastFrame.w;\n\t\t\t\tfloat value2 = nextFrame.w;\n\t\t\t\twidth=hermiteInterpolate(t, outTangent, inTangent, duration, value1, value2);\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t}\n\treturn width;\n}\t\n\nvoid main()\n{\n\tfloat normalizeTime = (u_CurTime - a_BirthTime) / u_LifeTime;\n\t\n\tv_Texcoord0 = vec2(a_Texcoord0X, 1.0 - a_Texcoord0Y) * u_TilingOffset.xy + u_TilingOffset.zw;\n\t\n\tv_Color = a_Color;\n\t\n\tvec3 cameraPos = (u_View*vec4(a_Position,1.0)).rgb;\n\tgl_Position = u_Projection * vec4(cameraPos+a_OffsetVector * getCurWidth(normalizeTime),1.0);\n\n\tgl_Position=remapGLPositionZ(gl_Position);\n}\n',"#if defined(GL_FRAGMENT_PRECISION_HIGH)//ifdefined\n\tprecision highp float;\n#else\n\tprecision mediump float;\n#endif\n\nuniform sampler2D u_MainTexture;\nuniform vec4 u_MainColor;\n\nvarying vec2 v_Texcoord0;\nvarying vec4 v_Color;\n\nvoid main()\n{\n\tvec4 color = 2.0 * u_MainColor * v_Color;\n\t#ifdef MAINTEXTURE\n\t\tvec4 mainTextureColor = texture2D(u_MainTexture, v_Texcoord0);\n\t\tcolor *= mainTextureColor;\n\t#endif\n\tgl_FragColor = color;\n}\n\n     ",n),e={a_Position:Xn.MESH_POSITION0,a_Normal:Xn.MESH_NORMAL0,a_Tangent0:Xn.MESH_TANGENT0},t={u_MvpMatrix:xn.PERIOD_SPRITE,u_WorldMat:xn.PERIOD_SPRITE,u_CameraPos:xn.PERIOD_CAMERA,u_Time:xn.PERIOD_SCENE,u_MainTexture:xn.PERIOD_MATERIAL,u_NormalTexture:xn.PERIOD_MATERIAL,u_HorizonColor:xn.PERIOD_MATERIAL,u_WaveScale:xn.PERIOD_MATERIAL,u_WaveSpeed:xn.PERIOD_MATERIAL},i=xn.add("WaterPrimary"),r=new Ya(e,t),i.addSubShader(r),r.addShaderPass('#include "Lighting.glsl";\n\nattribute vec4 a_Position;\nattribute vec3 a_Normal;\nattribute vec4 a_Tangent0;\n\nuniform mat4 u_MvpMatrix;\nuniform mat4 u_WorldMat;\nuniform vec3 u_CameraPos;\nuniform float u_WaveScale;\nuniform vec4 u_WaveSpeed;\nuniform float u_Time;\n\nvarying vec3 v_Normal;\nvarying vec3 v_Tangent;\nvarying vec3 v_Binormal;\nvarying vec3 v_ViewDir;\nvarying vec2 v_Texcoord0;\nvarying vec2 v_Texcoord1;\n\nvoid main()\n{\n\tvec4 positionWorld = u_WorldMat * a_Position;\n\tvec4 position = u_MvpMatrix * a_Position;\n\t\n\tvec4 temp = vec4(positionWorld.x, positionWorld.z, positionWorld.x, positionWorld.z) * u_WaveScale + u_WaveSpeed * u_WaveScale * u_Time;\n\t\n\tv_Texcoord0 = temp.xy * vec2(0.4, 0.45);\n\tv_Texcoord1 = temp.wz;\n\t\n\tmat3 worldMat = mat3(u_WorldMat);\n\tv_Normal = worldMat * a_Normal;\n\tv_Tangent = worldMat * a_Tangent0.xyz;\n\tv_Binormal = cross(v_Normal, v_Tangent) * a_Tangent0.w;\n\t\n\tv_ViewDir = u_CameraPos - positionWorld.xyz;\n\tgl_Position = position;\n\tgl_Position=remapGLPositionZ(gl_Position);\n}','#if defined(GL_FRAGMENT_PRECISION_HIGH)//ifdefined\n\tprecision highp float;\n#else\n\tprecision mediump float;\n#endif\n\n#ifdef MAINTEXTURE\n\tuniform sampler2D u_MainTexture;\n#endif\n\n#ifdef NORMALTEXTURE\n\tuniform sampler2D u_NormalTexture;\n#endif\n\nuniform vec4 u_HorizonColor;\n\nvarying vec3 v_Normal;\nvarying vec3 v_Tangent;\nvarying vec3 v_Binormal;\nvarying vec3 v_ViewDir;\nvarying vec2 v_Texcoord0;\nvarying vec2 v_Texcoord1;\n\n\n#include "Lighting.glsl"\n\n\n\nvec3 NormalSampleToWorldSpace(vec4 normalMapSample) {\n\tvec3 normalT;\n\tnormalT.x = 2.0 * normalMapSample.x - 1.0;\n\tnormalT.y = 1.0 - 2.0 * normalMapSample.y;\n\tnormalT.z = sqrt(1.0 - clamp(dot(normalT.xy, normalT.xy), 0.0, 1.0));\n\n\tvec3 bumpedNormal = normalize(normalT);\n\n\treturn bumpedNormal;\n}\n\n\nvoid main()\n{\n\tvec4 bumpColor1 = texture2D(u_NormalTexture, v_Texcoord0);\n\tvec4 bumpColor2 = texture2D(u_NormalTexture, v_Texcoord1);\n\n\tvec3 normal1 = NormalSampleToWorldSpace(bumpColor1);\n\tvec3 normal2 = NormalSampleToWorldSpace(bumpColor2);\n\t\n\tvec3 normal = normalize((normal1 + normal2) * 0.5);\n\tvec3 viewDir = normalize(v_ViewDir);\n\tfloat fresnel = dot(viewDir, normal);\n\t\n\tvec4 waterColor = texture2D(u_MainTexture, vec2(fresnel, fresnel));\n\t\n\tvec4 color;\n\tcolor.rgb = mix(waterColor.rgb, u_HorizonColor.rgb, vec3(waterColor.a));\n\tcolor.a = u_HorizonColor.a;\n\t\n\tgl_FragColor = color;\n}\n\n\n'),e={a_PositionTexcoord:Xn.MESH_POSITION0},t={u_MainTex:xn.PERIOD_MATERIAL,u_OffsetScale:xn.PERIOD_MATERIAL},i=xn.add("BlitScreen"),r=new Ya(e,t),i.addSubShader(r);var a=r.addShaderPass('#include "Lighting.glsl";\n#if defined(GL_FRAGMENT_PRECISION_HIGH)//ifdefined\n\tprecision highp float;\n#else\n\tprecision mediump float;\n#endif\nattribute vec4 a_PositionTexcoord;\nuniform vec4 u_OffsetScale;\nvarying vec2 v_Texcoord0;\n\nvoid main() {\t\n\tgl_Position = vec4(u_OffsetScale.x*2.0-1.0+(a_PositionTexcoord.x+1.0)*u_OffsetScale.z,(1.0-((u_OffsetScale.y*2.0-1.0+(-a_PositionTexcoord.y+1.0)*u_OffsetScale.w)+1.0)/2.0)*2.0-1.0, 0.0, 1.0);\t\n\tv_Texcoord0 = a_PositionTexcoord.zw;\n\tgl_Position = remapGLPositionZ(gl_Position);\n}',"#if defined(GL_FRAGMENT_PRECISION_HIGH)//ifdefined\n\tprecision highp float;\n#else\n\tprecision mediump float;\n#endif\n\nuniform sampler2D u_MainTex;\nvarying vec2 v_Texcoord0;\n\nvoid main() {\n\tgl_FragColor = texture2D(u_MainTex, v_Texcoord0);\n}\n\n").renderState;a.depthTest=Wi.DEPTHTEST_ALWAYS,a.depthWrite=!1,a.cull=Wi.CULL_NONE,a.blend=Wi.BLEND_DISABLE,e={a_PositionTexcoord:Xn.MESH_POSITION0},t={u_MainTex:xn.PERIOD_MATERIAL,u_BloomTex:xn.PERIOD_MATERIAL,u_AutoExposureTex:xn.PERIOD_MATERIAL,u_MainTex_TexelSize:xn.PERIOD_MATERIAL,u_SampleScale:xn.PERIOD_MATERIAL,u_Threshold:xn.PERIOD_MATERIAL,u_Params:xn.PERIOD_MATERIAL},i=xn.add("PostProcessBloom"),r=new Ya(e,t),i.addSubShader(r),(a=r.addShaderPass(as,'#if defined(GL_FRAGMENT_PRECISION_HIGH)//ifdefined\n\tprecision highp float;\n#else\n\tprecision mediump float;\n#endif\n\n#include "Colors.glsl";\n#include "Sampling.glsl";\n\nvarying vec2 v_Texcoord0;\n\nuniform sampler2D u_MainTex;\nuniform sampler2D u_AutoExposureTex;\nuniform vec4 u_MainTex_TexelSize;\nuniform vec4 u_Threshold; // x: threshold value (linear), y: threshold - knee, z: knee * 2, w: 0.25 / knee\nuniform vec4 u_Params; // x: clamp, yzw: unused\n\nmediump vec4 prefilter(mediump vec4 color, vec2 uv) {\n\tmediump float autoExposure = texture2D(u_AutoExposureTex, uv).r;\n\tcolor *= autoExposure;\n\tcolor = min(vec4(u_Params.x), color); // clamp to max\n\tcolor = quadraticThreshold(color, u_Threshold.x, u_Threshold.yzw);\n\treturn color;\n}\n\nvoid fragPrefilter13() {\n\tmediump vec4 color = downsampleBox13Tap(u_MainTex, v_Texcoord0, u_MainTex_TexelSize.xy);\n\tgl_FragColor = prefilter(safeHDR(color), v_Texcoord0);\n}\n\nvoid main() {\n\tfragPrefilter13();\n}').renderState).depthTest=Wi.DEPTHTEST_ALWAYS,a.depthWrite=!1,a.cull=Wi.CULL_NONE,a.blend=Wi.BLEND_DISABLE,r=new Ya(e,t),i.addSubShader(r),(a=r.addShaderPass(as,'#if defined(GL_FRAGMENT_PRECISION_HIGH)//ifdefined\n\tprecision highp float;\n#else\n\tprecision mediump float;\n#endif\n\n#include "Colors.glsl";\n#include "Sampling.glsl";\n\nvarying vec2 v_Texcoord0;\n\nuniform sampler2D u_MainTex;\nuniform sampler2D u_AutoExposureTex;\nuniform vec4 u_MainTex_TexelSize;\nuniform vec4 u_Threshold; // x: threshold value (linear), y: threshold - knee, z: knee * 2, w: 0.25 / knee\nuniform vec4 u_Params; // x: clamp, yzw: unused\n\nmediump vec4 prefilter(mediump vec4 color, vec2 uv) {\n\tmediump float autoExposure = texture2D(u_AutoExposureTex, uv).r;\n\tcolor *= autoExposure;\n\tcolor = min(vec4(u_Params.x), color); // clamp to max\n\tcolor = quadraticThreshold(color, u_Threshold.x, u_Threshold.yzw);\n\treturn color;\n}\n\nvoid fragPrefilter4() {\n\tmediump vec4 color = downsampleBox4Tap(u_MainTex, v_Texcoord0, u_MainTex_TexelSize.xy);\n\tgl_FragColor = prefilter(safeHDR(color), v_Texcoord0);\n}\n\nvoid main() {\n\tfragPrefilter4();\n}').renderState).depthTest=Wi.DEPTHTEST_ALWAYS,a.depthWrite=!1,a.cull=Wi.CULL_NONE,a.blend=Wi.BLEND_DISABLE,r=new Ya(e,t),i.addSubShader(r),(a=r.addShaderPass(as,'#if defined(GL_FRAGMENT_PRECISION_HIGH)//ifdefined\n\tprecision highp float;\n#else\n\tprecision mediump float;\n#endif\n\n#include "Colors.glsl";\n#include "Sampling.glsl";\n\nvarying vec2 v_Texcoord0;\n\nuniform sampler2D u_MainTex;\nuniform vec4 u_MainTex_TexelSize;\n\nvoid fragDownsample13() {\n\tmediump vec4 color = downsampleBox13Tap(u_MainTex, v_Texcoord0, u_MainTex_TexelSize.xy);\n\tgl_FragColor = color;\n}\n\nvoid main() {\n\tfragDownsample13();\n}').renderState).depthTest=Wi.DEPTHTEST_ALWAYS,a.depthWrite=!1,a.cull=Wi.CULL_NONE,a.blend=Wi.BLEND_DISABLE,r=new Ya(e,t),i.addSubShader(r),(a=r.addShaderPass(as,'#if defined(GL_FRAGMENT_PRECISION_HIGH)//ifdefined\n\tprecision highp float;\n#else\n\tprecision mediump float;\n#endif\n\n#include "Colors.glsl";\n#include "Sampling.glsl";\n\nvarying vec2 v_Texcoord0;\n\nuniform sampler2D u_MainTex;\nuniform vec4 u_MainTex_TexelSize;\n\nvoid fragDownsample4() {\n\tmediump vec4 color = downsampleBox4Tap(u_MainTex, v_Texcoord0, u_MainTex_TexelSize.xy);\n\tgl_FragColor = color;\n}\n\nvoid main() {\n\tfragDownsample4();\n}').renderState).depthTest=Wi.DEPTHTEST_ALWAYS,a.depthWrite=!1,a.cull=Wi.CULL_NONE,a.blend=Wi.BLEND_DISABLE,r=new Ya(e,t),i.addSubShader(r),(a=r.addShaderPass(as,'#if defined(GL_FRAGMENT_PRECISION_HIGH)//ifdefined\n\tprecision highp float;\n#else\n\tprecision mediump float;\n#endif\n\n#include "Colors.glsl";\n#include "Sampling.glsl";\n\nvarying vec2 v_Texcoord0;\n\nuniform sampler2D u_MainTex;\nuniform sampler2D u_BloomTex;\n\nuniform vec4 u_MainTex_TexelSize;\nuniform float u_SampleScale;\n\nmediump vec4 combine(mediump vec4 bloom, vec2 uv) {\n\tmediump vec4 color = texture2D(u_BloomTex, uv);\n\treturn bloom + color;\n}\n\nvoid fragUpsampleTent() {\n\tmediump vec4 bloom = upsampleTent(u_MainTex, v_Texcoord0, u_MainTex_TexelSize.xy, vec4(u_SampleScale));\n\tgl_FragColor = combine(bloom, v_Texcoord0);\n}\n\nvoid main() {\n\tfragUpsampleTent();\n}').renderState).depthTest=Wi.DEPTHTEST_ALWAYS,a.depthWrite=!1,a.cull=Wi.CULL_NONE,a.blend=Wi.BLEND_DISABLE,r=new Ya(e,t),i.addSubShader(r),(a=r.addShaderPass(as,'#if defined(GL_FRAGMENT_PRECISION_HIGH)//ifdefined\n\tprecision highp float;\n#else\n\tprecision mediump float;\n#endif\n\n#include "Colors.glsl";\n#include "Sampling.glsl";\n\nvarying vec2 v_Texcoord0;\n\nuniform sampler2D u_MainTex;\nuniform sampler2D u_BloomTex;\n\nuniform vec4 u_MainTex_TexelSize;\nuniform float u_SampleScale;\n\nmediump vec4 combine(mediump vec4 bloom, vec2 uv) {\n\tmediump vec4 color = texture2D(u_BloomTex, uv);\n\treturn bloom + color;\n}\n\nvoid fragUpsampleBox() {\n\tmediump vec4 bloom = upsampleBox(u_MainTex, v_Texcoord0, u_MainTex_TexelSize.xy, vec4(u_SampleScale));\n\tgl_FragColor = combine(bloom, v_Texcoord0);\n}\n\nvoid main() {\n\tfragUpsampleBox();\n}').renderState).depthTest=Wi.DEPTHTEST_ALWAYS,a.depthWrite=!1,a.cull=Wi.CULL_NONE,a.blend=Wi.BLEND_DISABLE,e={a_PositionTexcoord:Xn.MESH_POSITION0},t={u_MainTex:xn.PERIOD_MATERIAL,u_BloomTex:xn.PERIOD_MATERIAL,u_AutoExposureTex:xn.PERIOD_MATERIAL,u_Bloom_DirtTileOffset:xn.PERIOD_MATERIAL,u_Bloom_DirtTex:xn.PERIOD_MATERIAL,u_BloomTex_TexelSize:xn.PERIOD_MATERIAL,u_Bloom_Settings:xn.PERIOD_MATERIAL,u_Bloom_Color:xn.PERIOD_MATERIAL},i=xn.add("PostProcessComposite"),r=new Ya(e,t),i.addSubShader(r),(a=r.addShaderPass('#include "Lighting.glsl";\n\nattribute vec4 a_PositionTexcoord;\nvarying vec2 v_Texcoord0;\n\nvoid main() {\n\tgl_Position = vec4(a_PositionTexcoord.xy, 0.0, 1.0);\n\tv_Texcoord0 = a_PositionTexcoord.zw;\n\tgl_Position = remapGLPositionZ(gl_Position);\n}','#if defined(GL_FRAGMENT_PRECISION_HIGH)//ifdefined\n\tprecision highp float;\n#else\n\tprecision mediump float;\n#endif\n\n#include "Colors.glsl";\n#include "Sampling.glsl";\n\nvarying vec2 v_Texcoord0;\n\nuniform sampler2D u_MainTex;\nuniform sampler2D u_BloomTex;\n\nuniform sampler2D u_AutoExposureTex;\nuniform sampler2D u_Bloom_DirtTex;\nuniform vec4 u_BloomTex_TexelSize;\nuniform vec4 u_Bloom_DirtTileOffset; // xy: tiling, zw: offset\nuniform mediump vec3 u_Bloom_Settings;// x: sampleScale, y: intensity, z: dirt intensity\nuniform mediump vec3 u_Bloom_Color;\n\nvoid main() {\n\tmediump float autoExposure = texture2D(u_AutoExposureTex, v_Texcoord0).r;\n\tmediump vec4 color=vec4(0.0);\n\tcolor = texture2D(u_MainTex, v_Texcoord0);\n\t\n\tcolor = sRGBToLinear(color);\n\tcolor.rgb *= autoExposure;\n\t\n\t#if defined(BLOOM)||defined(BLOOM_LOW)\n\t\t#ifdef BLOOM\n\t\t\tmediump vec4 bloom = upsampleTent(u_BloomTex, v_Texcoord0, u_BloomTex_TexelSize.xy, vec4(u_Bloom_Settings.x));\n\t\t#else\n\t\t\tmediump vec4 bloom = upsampleBox(u_BloomTex, v_Texcoord0, u_BloomTex_TexelSize.xy, vec4(u_Bloom_Settings.x));\n\t\t#endif\n\n\t\t// UVs should be Distort(uv * u_Bloom_DirtTileOffset.xy + u_Bloom_DirtTileOffset.zw)\n\t\t// but considering we use a cover-style scale on the dirt texture the difference\n\t\t// isn\'t massive so we chose to save a few ALUs here instead in case lens distortion\n\t\t// is active\n\t\tmediump vec4 dirt =vec4(texture2D(u_Bloom_DirtTex, v_Texcoord0 * u_Bloom_DirtTileOffset.xy + u_Bloom_DirtTileOffset.zw).rgb, 0.0);\n\n\t\t// Additive bloom (artist friendly)\n\t\tbloom *= u_Bloom_Settings.y;\n\t\tdirt *= u_Bloom_Settings.z;\n\t\tmediump vec4 bloomColor=vec4(u_Bloom_Color, 1.0);\n\t\tcolor += bloom * bloomColor;\n\t\tcolor += dirt * bloom;\n\t#endif\n\t\n\tmediump vec4 finalColor = color;\n\tfinalColor = linearToSRGB(finalColor);\n\t//finalColor.rgb = Dither(finalColor.rgb, v_Texcoord0);//TODO:\n\tgl_FragColor = finalColor;\n}').renderState).depthTest=Wi.DEPTHTEST_ALWAYS,a.depthWrite=!1,a.cull=Wi.CULL_NONE,a.blend=Wi.BLEND_DISABLE}}]),yr}(),ss=function(t){function Lr(){var t;return _classCallCheck(this,Lr),(t=_possibleConstructorReturn(this,_getPrototypeOf(Lr).call(this)))._direction=new D,t._shadowCascadesMode=e.ShadowCascadesMode.NoCascades,t._shadowTwoCascadeSplits=1/3,t._shadowFourCascadeSplits=new D(1/15,.2,7/15),t._lightType=e.LightType.Directional,t}return _inherits(Lr,Kn),_createClass(Lr,[{key:"_addToLightQueue",value:function(){this._scene._directionLights.add(this)}},{key:"_removeFromLightQueue",value:function(){this._scene._directionLights.remove(this)}},{key:"_create",value:function(){return new Lr}},{key:"shadowCascadesMode",get:function(){return this._shadowCascadesMode},set:function(e){this._shadowCascadesMode=e}},{key:"shadowTwoCascadeSplits",get:function(){return this._shadowTwoCascadeSplits},set:function(e){this._shadowTwoCascadeSplits=e}},{key:"shadowFourCascadeSplits",get:function(){return this._shadowFourCascadeSplits},set:function(e){if(e.x>e.y||e.y>e.z||e.z>1)throw"DiretionLight:Invalid value.";e.cloneTo(this._shadowFourCascadeSplits)}}]),Lr}(),ls=function(t){function Or(){var t;return _classCallCheck(this,Or),(t=_possibleConstructorReturn(this,_getPrototypeOf(Or).call(this)))._range=6,t._lightType=e.LightType.Point,t}return _inherits(Or,Kn),_createClass(Or,[{key:"_addToLightQueue",value:function(){this._scene._pointLights.add(this)}},{key:"_removeFromLightQueue",value:function(){this._scene._pointLights.remove(this)}},{key:"_parse",value:function(e,t){_get(_getPrototypeOf(Or.prototype),"_parse",this).call(this,e,t),this.range=e.range}},{key:"_cloneTo",value:function(t,n,i){_get(_getPrototypeOf(Or.prototype),"_cloneTo",this).call(this,t,n,i);var r=t;r.range=this.range,r._lightType=e.LightType.Point}},{key:"_create",value:function(){return new Or}},{key:"range",get:function(){return this._range},set:function(e){this._range=e}}]),Or}(),us=function(t){function Nr(){var t;return _classCallCheck(this,Nr),(t=_possibleConstructorReturn(this,_getPrototypeOf(Nr).call(this)))._spotAngle=30,t._range=10,t._direction=new D,t._lightType=e.LightType.Spot,t}return _inherits(Nr,Kn),_createClass(Nr,[{key:"_addToLightQueue",value:function(){this._scene._spotLights.add(this)}},{key:"_removeFromLightQueue",value:function(){this._scene._spotLights.remove(this)}},{key:"_parse",value:function(e,t){_get(_getPrototypeOf(Nr.prototype),"_parse",this).call(this,e,t),this.range=e.range,this.spotAngle=e.spotAngle}},{key:"_cloneTo",value:function(e,t,n){_get(_getPrototypeOf(Nr.prototype),"_cloneTo",this).call(this,e,t,n);var i=e;i.range=this.range,i.spotAngle=this.spotAngle}},{key:"_create",value:function(){return new Nr}},{key:"spotAngle",get:function(){return this._spotAngle},set:function(e){this._spotAngle=Math.max(Math.min(e,179),0)}},{key:"range",get:function(){return this._range},set:function(e){this._range=e}}]),Nr}(),_s=function(e){function Pr(e){var t;return _classCallCheck(this,Pr),(t=_possibleConstructorReturn(this,_getPrototypeOf(Pr).call(this,e)))._simpleAnimatorParams=new o,t._simpleAnimatorOffset=new r,t._shaderValues.addDefine(Ho.SHADERDEFINE_SIMPLEBONE),t._shaderValues.addDefine(Ho.SHADERDEFINE_BONE),t}return _inherits(Pr,zo),_createClass(Pr,[{key:"_computeAnimatorParamsData",value:function(){this._cacheMesh&&(this._simpleAnimatorParams.x=this._simpleAnimatorOffset.x,this._simpleAnimatorParams.y=Math.round(this._simpleAnimatorOffset.y)*this._bonesNums*4)}},{key:"_createRenderElement",value:function(){return new Ca}},{key:"_setCacheAnimator",value:function(e){this._cacheAnimator=e,this._shaderValues.addDefine(Ho.SHADERDEFINE_SIMPLEBONE)}},{key:"_onMeshChange",value:function(e){_get(_getPrototypeOf(Pr.prototype),"_onMeshChange",this).call(this,e),this._cacheMesh=e}},{key:"_renderUpdate",value:function(e,t){var n=e.renderElement;switch(n.renderType){case ci.RENDERTYPE_NORMAL:if(this._cacheAnimator){var i=this._cacheAnimator.owner.transform.worldMatrix;this._shaderValues.setMatrix4x4(Nn.WORLDMATRIX,i)}else this._shaderValues.setMatrix4x4(Nn.WORLDMATRIX,t.worldMatrix);this._computeAnimatorParamsData(),this._shaderValues.setVector(Pr.SIMPLE_SIMPLEANIMATORPARAMS,this._simpleAnimatorParams);break;case ci.RENDERTYPE_INSTANCEBATCH:var r=Ra.instance.instanceWorldMatrixData,a=n.instanceBatchElementList,o=a.elements,s=a.length;if(this._cacheAnimator)for(var l=0;l<s;l++){var u=o[l].render._cacheAnimator.owner._transform.worldMatrix;r.set(u.elements,16*l)}else for(l=0;l<s;l++)r.set(o[l]._transform.worldMatrix.elements,16*l);var _=Ra.instance.instanceWorldMatrixBuffer;_.orphanStorage(),_.setData(r.buffer,0,0,16*s*4),this._shaderValues.addDefine(Si.SHADERDEFINE_GPU_INSTANCE);var c=Ra.instance.instanceSimpleAnimatorData;if(this._cacheAnimator)for(l=0;l<s;l++){var h=o[l].render;h._computeAnimatorParamsData();var d=h._simpleAnimatorParams,f=4*l;c[f]=d.x,c[f+1]=d.y}else for(l=0;l<s;l++)c[f]=0,c[f+1]=0;var m=Ra.instance.instanceSimpleAnimatorBuffer;m.orphanStorage(),m.setData(c.buffer,0,0,4*s*4)}}},{key:"_renderUpdateWithCamera",value:function(e,t){var n=e.projectionViewMatrix;if(n)switch(e.renderElement.renderType){case ci.RENDERTYPE_NORMAL:if(this._cacheAnimator){var i=this._cacheAnimator.owner._transform.worldMatrix;q.multiply(n,i,this._projectionViewWorldMatrix),this._shaderValues.setMatrix4x4(Nn.MVPMATRIX,this._projectionViewWorldMatrix)}else q.multiply(n,t.worldMatrix,this._projectionViewWorldMatrix),this._shaderValues.setMatrix4x4(Nn.MVPMATRIX,this._projectionViewWorldMatrix)}}},{key:"_destroy",value:function(){this._cacheRootBone&&!this._cacheRootBone.destroyed&&this._cacheRootBone.transform.off(t.Event.TRANSFORM_CHANGED,this,this._onWorldMatNeedChange),this._simpleAnimatorTexture&&this._simpleAnimatorTexture._removeReference(),this._simpleAnimatorTexture=null}},{key:"simpleAnimatorTexture",get:function(){return this._simpleAnimatorTexture},set:function(e){this._simpleAnimatorTexture=e,this._simpleAnimatorTextureSize=e.width,this._shaderValues.setTexture(Pr.SIMPLE_SIMPLEANIMATORTEXTURE,e),e._addReference(),this._shaderValues.setNumber(Pr.SIMPLE_SIMPLEANIMATORTEXTURESIZE,this._simpleAnimatorTextureSize)}},{key:"simpleAnimatorOffset",get:function(){return this._simpleAnimatorOffset},set:function(e){e.cloneTo(this._simpleAnimatorOffset)}}]),Pr}(),cs=function(e){function br(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return _classCallCheck(this,br),(e=_possibleConstructorReturn(this,_getPrototypeOf(br).call(this,n)))._meshFilter=new io(_assertThisInitialized(e)),e._render=new _s(_assertThisInitialized(e)),t&&(e._meshFilter.sharedMesh=t),e}return _inherits(br,ya),_createClass(br,[{key:"_parse",value:function(e,n){_get(_getPrototypeOf(br.prototype),"_parse",this).call(this,e,n);var i=this.simpleSkinnedMeshRenderer,r=e.lightmapIndex;null!=r&&(i.lightmapIndex=r);var a,s=e.lightmapScaleOffset;if(s&&(i.lightmapScaleOffset=new o(s[0],s[1],s[2],s[3])),null!=e.enableRender&&(i.enable=e.enableRender),null!=e.receiveShadows&&(i.receiveShadow=e.receiveShadows),null!=e.castShadow&&(i.castShadow=e.castShadow),a=e.meshPath){var l=t.Loader.getRes(a);l&&(this.meshFilter.sharedMesh=l)}var u=e.materials;if(u){var _=i.sharedMaterials,c=u.length;_.length=c;for(var h=0;h<c;h++)_[h]=t.Loader.getRes(u[h].path);i.sharedMaterials=_}var d=e.boundBox,f=d.min,m=d.max;if(i.localBounds.setMin(new D(f[0],f[1],f[2])),i.localBounds.setMax(new D(m[0],m[1],m[2])),n){var p=e.rootBone;i.rootBone=n[p];var v,E=e.bones;for(h=0,v=E.length;h<v;h++)i.bones.push(n[E[h]]);i._bonesNums=e.bonesNums?e.bonesNums:i.bones.length}else e.rootBone&&i._setRootBone(e.rootBone);var T=e.animatorTexture;if(T){var g=t.Loader.getRes(T);i.simpleAnimatorTexture=g}}},{key:"_changeHierarchyAnimator",value:function(e){_get(_getPrototypeOf(br.prototype),"_changeHierarchyAnimator",this).call(this,e),this.simpleSkinnedMeshRenderer._setCacheAnimator(e)}},{key:"_cloneTo",value:function(e,t,n){var i=e;i.meshFilter.sharedMesh=this.meshFilter.sharedMesh;var r=this._render,a=i._render;a.enable=r.enable,a.sharedMaterials=r.sharedMaterials,a.castShadow=r.castShadow;var o=r.lightmapScaleOffset;o&&(a.lightmapScaleOffset=o.clone()),a.receiveShadow=r.receiveShadow,a.sortingFudge=r.sortingFudge,a._rootBone=r._rootBone;var s=r.bones,l=a.bones,u=s.length;l.length=u;var _=r.rootBone;if(_){var c=gt._getHierarchyPath(t,_,br._tempArray0);a.rootBone=c?gt._getNodeByHierarchyPath(n,c):_}for(var h=0;h<s.length;h++)c=gt._getHierarchyPath(t,s[h],br._tempArray0),l[h]=c?gt._getNodeByHierarchyPath(n,c):s[h];var d=r.localBounds;d&&d.cloneTo(a.localBounds),a.simpleAnimatorOffset=r.simpleAnimatorOffset,a.simpleAnimatorTexture=r.simpleAnimatorTexture,a._bonesNums=r._bonesNums,_get(_getPrototypeOf(br.prototype),"_cloneTo",this).call(this,e,t,n)}},{key:"destroy",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];this.destroyed||(_get(_getPrototypeOf(br.prototype),"destroy",this).call(this,e),this._meshFilter.destroy())}},{key:"_create",value:function(){return new br}},{key:"meshFilter",get:function(){return this._meshFilter}},{key:"simpleSkinnedMeshRenderer",get:function(){return this._render}}],[{key:"__init__",value:function(){_s.SIMPLE_SIMPLEANIMATORPARAMS=br.SIMPLE_SIMPLEANIMATORPARAMS,_s.SIMPLE_SIMPLEANIMATORTEXTURE=br.SIMPLE_SIMPLEANIMATORTEXTURE,_s.SIMPLE_SIMPLEANIMATORTEXTURESIZE=br.SIMPLE_SIMPLEANIMATORTEXTURESIZE}}]),br}();cs._tempArray0=[],cs.SIMPLE_SIMPLEANIMATORTEXTURE=xn.propertyNameToID("u_SimpleAnimatorTexture"),cs.SIMPLE_SIMPLEANIMATORPARAMS=xn.propertyNameToID("u_SimpleAnimatorParams"),cs.SIMPLE_SIMPLEANIMATORTEXTURESIZE=xn.propertyNameToID("u_SimpleAnimatorTextureSize");var hs=function(){function wr(){_classCallCheck(this,wr)}return _createClass(wr,null,[{key:"_createSprite3DInstance",value:function(e,t,n){var i;switch(e.type){case"Scene3D":i=new Wa;break;case"Sprite3D":i=new Nn;break;case"MeshSprite3D":i=new oo,n&&e.props.isStatic&&n.push(i);break;case"SkinnedMeshSprite3D":i=new Wo;break;case"SimpleSkinnedMeshSprite3D":i=new cs;break;case"ShuriKenParticle3D":i=new Go;break;case"Camera":i=new si;break;case"DirectionLight":i=new ss;break;case"PointLight":i=new ls;break;case"SpotLight":i=new us;break;case"TrailSprite3D":i=new Ko;break;case"ReflectionProbe":i=new Da;break;default:throw new Error("Utils3D:unidentified class type in (.lh) file.")}var r=e.child;if(r)for(var a=0,o=r.length;a<o;a++){var s=wr._createSprite3DInstance(r[a],t,n);i.addChild(s)}return t[e.instanceID]=i,i}},{key:"_createComponentInstance",value:function(e,n,i){var r=n[e.instanceID];r._parse(e.props,n);var a=e.child;if(a)for(var o=0,s=a.length;o<s;o++)wr._createComponentInstance(a[o],n,i);var l=e.components;if(l)for(var u=0,_=l.length;u<_;u++){var c=l[u],h=t.ClassUtils.getRegClass(c.type);h?r.addComponent(h)._parse(c,i):console.warn("Unkown component type.")}}},{key:"_createNodeByJson02",value:function(e,t){var n={},i={component:[],data:[]},r=wr._createSprite3DInstance(e,n,t);return wr._createComponentInstance(e,n,i),wr._createInteractInstance(i,n),r}},{key:"_createInteractInstance",value:function(e,t){for(var n=e.component,i=e.data,r=0,a=n.length;r<a;r++)n[r]._parseInteractive(i[r],t)}},{key:"_parse",value:function(e){arguments.length>1&&void 0!==arguments[1]&&arguments[1],arguments.length>2&&void 0!==arguments[2]&&arguments[2];var t,n=e.data,i=[];switch(e.version){case"LAYAHIERARCHY:02":t=wr._createNodeByJson02(n,i);break;default:t=wr._createNodeByJson(n,i)}return Aa.combine(t,i),t}},{key:"_parseScene",value:function(e){arguments.length>1&&void 0!==arguments[1]&&arguments[1],arguments.length>2&&void 0!==arguments[2]&&arguments[2];var t,n=e.data,i=[];switch(e.version){case"LAYASCENE3D:02":t=wr._createNodeByJson02(n,i);break;default:t=wr._createNodeByJson(n,i)}return Aa.combine(null,i),t}},{key:"_createNodeByJson",value:function(e,n){var i;switch(e.type){case"Scene3D":i=new Wa;break;case"Sprite3D":i=new Nn;break;case"MeshSprite3D":i=new oo,n&&e.props.isStatic&&n.push(i);break;case"SkinnedMeshSprite3D":i=new Wo;break;case"ShuriKenParticle3D":i=new Go;break;case"Camera":i=new si;break;case"DirectionLight":i=new ss;break;case"PointLight":i=new ls;break;case"SpotLight":i=new us;break;case"TrailSprite3D":i=new Ko;break;default:throw new Error("Utils3D:unidentified class type in (.lh) file.")}var r=e.child;if(r)for(var a=0,o=r.length;a<o;a++){var s=wr._createNodeByJson(r[a],n);i.addChild(s)}var l=e.components;if(l)for(var u=0,_=l.length;u<_;u++){var c=l[u],h=t.ClassUtils.getRegClass(c.type);h?i.addComponent(h)._parse(c):console.warn("Unkown component type.")}return i._parse(e.props,null),i}}]),wr}(),ds=function(){function Vr(){_classCallCheck(this,Vr)}return _createClass(Vr,null,[{key:"parse",value:function(e,t,n,i){Vr._mesh=n,Vr._subMeshes=i,Vr._version=t,Vr._readData=e,Vr.READ_DATA(),Vr.READ_BLOCK(),Vr.READ_STRINGS();for(var r=0,a=Vr._BLOCK.count;r<a;r++){Vr._readData.pos=Vr._BLOCK.blockStarts[r];var o=Vr._readData.getUint16(),s=Vr._strings[o],l=Vr["READ_"+s];if(null==l)throw new Error("model file err,no this function:"+o+" "+s);l.call(null)}Vr._strings.length=0,Vr._readData=null,Vr._version=null,Vr._mesh=null,Vr._subMeshes=null}},{key:"_readString",value:function(){return Vr._strings[Vr._readData.getUint16()]}},{key:"READ_DATA",value:function(){Vr._DATA.offset=Vr._readData.getUint32(),Vr._DATA.size=Vr._readData.getUint32()}},{key:"READ_BLOCK",value:function(){for(var e=Vr._BLOCK.count=Vr._readData.getUint16(),t=Vr._BLOCK.blockStarts=[],n=Vr._BLOCK.blockLengths=[],i=0;i<e;i++)t.push(Vr._readData.getUint32()),n.push(Vr._readData.getUint32())}},{key:"READ_STRINGS",value:function(){var e=Vr._readData.getUint32(),t=Vr._readData.getUint16(),n=Vr._readData.pos;Vr._readData.pos=e+Vr._DATA.offset;for(var i=0;i<t;i++)Vr._strings[i]=Vr._readData.readUTFString();Vr._readData.pos=n}},{key:"READ_MESH",value:function(){var n,i=t.LayaGL.instance,r=(Vr._readString(),Vr._readData.__getBuffer()),a=0,o=Vr._readData.getInt16(),s=Vr._DATA.offset;for(n=0;n<o;n++){var l,u=s+Vr._readData.getUint32(),_=Vr._readData.getUint32(),c=r.slice(u,u+_),h=new Float32Array(c),d=Vr._readString();switch(Vr._version){case"LAYAMODEL:0301":case"LAYAMODEL:0400":l=Xn.getVertexDeclaration(d);break;case"LAYAMODEL:0401":l=Xn.getVertexDeclaration(d,!1);break;default:throw new Error("LoadModelV03: unknown version.")}if(!l)throw new Error("LoadModelV03: unknown vertexDeclaration.");var f=new pn(4*h.length,i.STATIC_DRAW,!0);f.vertexDeclaration=l,f.setData(h.buffer),Vr._mesh._vertexBuffer=f,Vr._mesh._vertexCount+=f._byteLength/l.vertexStride,a+=4*h.length}var m=s+Vr._readData.getUint32(),p=Vr._readData.getUint32(),v=new Uint16Array(r.slice(m,m+p)),E=new Wn(e.IndexFormat.UInt16,p/2,i.STATIC_DRAW,!0);E.setData(v),Vr._mesh._indexBuffer=E,a+=2*E.indexCount,Vr._mesh._setBuffer(Vr._mesh._vertexBuffer,E),Vr._mesh._setCPUMemory(a),Vr._mesh._setGPUMemory(a);var T=Vr._mesh._boneNames=[],g=Vr._readData.getUint16();for(T.length=g,n=0;n<g;n++)T[n]=Vr._strings[Vr._readData.getUint16()];Vr._readData.pos+=8;var y=Vr._readData.getUint32(),S=Vr._readData.getUint32(),R=new Float32Array(r.slice(s+y,s+y+S)),C=R.length,A=Vr._mesh._inverseBindPosesBuffer=new ArrayBuffer(4*C);for(Vr._mesh._inverseBindPoses=[],Vr._mesh._instanceBufferStateType=0!=C?is.MESH_INSTANCEBUFFER_TYPE_SIMPLEANIMATOR:is.MESH_INSTANCEBUFFER_TYPE_NORMAL,Vr._mesh._setInstanceBuffer(Vr._mesh._instanceBufferStateType),n=0;n<C;n+=16){var I=new q(R[n+0],R[n+1],R[n+2],R[n+3],R[n+4],R[n+5],R[n+6],R[n+7],R[n+8],R[n+9],R[n+10],R[n+11],R[n+12],R[n+13],R[n+14],R[n+15],new Float32Array(A,4*n,16));Vr._mesh._inverseBindPoses[n/16]=I}return!0}},{key:"READ_SUBMESH",value:function(){var e=Vr._readData.__getBuffer(),t=new ts(Vr._mesh);Vr._readData.getInt16(),Vr._readData.getUint32(),Vr._readData.getUint32();var n=Vr._readData.getUint32(),i=Vr._readData.getUint32(),r=Vr._mesh._indexBuffer;t._indexBuffer=r,t._setIndexRange(n,i);var a=Vr._mesh._vertexBuffer;t._vertexBuffer=a;var o=Vr._DATA.offset,s=t._subIndexBufferStart,l=t._subIndexBufferCount,u=t._boneIndicesList,_=Vr._readData.getUint16();s.length=_,l.length=_,u.length=_;var c=Vr._mesh._skinnedMatrixCaches,h=Vr._subMeshes.length;c.length=Vr._mesh._inverseBindPoses.length;for(var d=0;d<_;d++){s[d]=Vr._readData.getUint32(),l[d]=Vr._readData.getUint32();for(var f=Vr._readData.getUint32(),m=Vr._readData.getUint32(),p=u[d]=new Uint16Array(e.slice(o+f,o+f+m)),v=p.length,E=0;E<v;E++){var T=p[E];c[T]||(c[T]=new ns(h,d,E))}}return Vr._subMeshes.push(t),!0}}]),Vr}();ds._BLOCK={count:0},ds._DATA={offset:0,size:0},ds._strings=[];var fs=function(){function Br(){_classCallCheck(this,Br)}return _createClass(Br,null,[{key:"parse",value:function(e,t,n,i){Br._mesh=n,Br._subMeshes=i,Br._version=t,Br._readData=e,Br.READ_DATA(),Br.READ_BLOCK(),Br.READ_STRINGS();for(var r=0,a=Br._BLOCK.count;r<a;r++){Br._readData.pos=Br._BLOCK.blockStarts[r];var o=Br._readData.getUint16(),s=Br._strings[o],l=Br["READ_"+s];if(null==l)throw new Error("model file err,no this function:"+o+" "+s);l.call(null)}Br._strings.length=0,Br._readData=null,Br._version=null,Br._mesh=null,Br._subMeshes=null}},{key:"_readString",value:function(){return Br._strings[Br._readData.getUint16()]}},{key:"READ_DATA",value:function(){Br._DATA.offset=Br._readData.getUint32(),Br._DATA.size=Br._readData.getUint32()}},{key:"READ_BLOCK",value:function(){for(var e=Br._BLOCK.count=Br._readData.getUint16(),t=Br._BLOCK.blockStarts=[],n=Br._BLOCK.blockLengths=[],i=0;i<e;i++)t.push(Br._readData.getUint32()),n.push(Br._readData.getUint32())}},{key:"READ_STRINGS",value:function(){var e=Br._readData.getUint32(),t=Br._readData.getUint16(),n=Br._readData.pos;Br._readData.pos=e+Br._DATA.offset;for(var i=0;i<t;i++)Br._strings[i]=Br._readData.readUTFString();Br._readData.pos=n}},{key:"READ_MESH",value:function(){var n,i=t.LayaGL.instance,r=0,a=(Br._readString(),Br._readData),o=a.__getBuffer(),s=a.getInt16(),l=Br._DATA.offset;for(n=0;n<s;n++){var u,_,c,h=l+a.getUint32(),d=a.getUint32(),f=Br._readString(),m=Xn.getVertexDeclaration(f,!1),p=m.vertexStride,v=f.split(","),E=v.length,T=Br._mesh;switch(Br._version){case"LAYAMODEL:05":case"LAYAMODEL:0501":u=o.slice(h,h+d*p),_=new Float32Array(u),c=new Uint8Array(u);break;case"LAYAMODEL:COMPRESSION_05":case"LAYAMODEL:COMPRESSION_0501":u=new ArrayBuffer(p*d),_=new Float32Array(u),c=new Uint8Array(u);var g=a.pos;a.pos=h;for(var y=0;y<d;y++)for(var S,R=y*p,C=0;C<E;C++)switch(v[C]){case"POSITION":_[S=R/4]=t.HalfFloatUtils.convertToNumber(a.getUint16()),_[S+1]=t.HalfFloatUtils.convertToNumber(a.getUint16()),_[S+2]=t.HalfFloatUtils.convertToNumber(a.getUint16()),R+=12;break;case"NORMAL":_[S=R/4]=a.getUint8()/127.5-1,_[S+1]=a.getUint8()/127.5-1,_[S+2]=a.getUint8()/127.5-1,R+=12;break;case"COLOR":_[S=R/4]=a.getUint8()/255,_[S+1]=a.getUint8()/255,_[S+2]=a.getUint8()/255,_[S+3]=a.getUint8()/255,R+=16;break;case"UV":case"UV1":_[S=R/4]=t.HalfFloatUtils.convertToNumber(a.getUint16()),_[S+1]=t.HalfFloatUtils.convertToNumber(a.getUint16()),R+=8;break;case"BLENDWEIGHT":_[S=R/4]=a.getUint8()/255,_[S+1]=a.getUint8()/255,_[S+2]=a.getUint8()/255,_[S+3]=a.getUint8()/255,R+=16;break;case"BLENDINDICES":c[R]=a.getUint8(),c[R+1]=a.getUint8(),c[R+2]=a.getUint8(),c[R+3]=a.getUint8(),R+=4;break;case"TANGENT":_[S=R/4]=a.getUint8()/127.5-1,_[S+1]=a.getUint8()/127.5-1,_[S+2]=a.getUint8()/127.5-1,_[S+3]=a.getUint8()/127.5-1,R+=16}a.pos=g}var A=new pn(u.byteLength,i.STATIC_DRAW,!0);A.vertexDeclaration=m,A.setData(u),d=A._byteLength/m.vertexStride,T._indexFormat=d>65535?e.IndexFormat.UInt32:e.IndexFormat.UInt16,T._vertexBuffer=A,T._vertexCount+=d,r+=4*_.length}var I,x=l+a.getUint32(),D=a.getUint32();I=T.indexFormat==e.IndexFormat.UInt32?new Uint32Array(o.slice(x,x+D)):new Uint16Array(o.slice(x,x+D));var M=new Wn(T.indexFormat,I.length,i.STATIC_DRAW,!0);if(M.setData(I),T._indexBuffer=M,T._setBuffer(T._vertexBuffer,M),r+=2*M.indexCount,T._setCPUMemory(r),T._setGPUMemory(r),"LAYAMODEL:0501"==Br._version||"LAYAMODEL:COMPRESSION_0501"==Br._version){var L=T.bounds,O=L.getMin(),N=L.getMax();O.setValue(a.getFloat32(),a.getFloat32(),a.getFloat32()),N.setValue(a.getFloat32(),a.getFloat32(),a.getFloat32()),L.setMin(O),L.setMax(N),T.bounds=L}var P=T._boneNames=[],b=a.getUint16();for(P.length=b,n=0;n<b;n++)P[n]=Br._strings[a.getUint16()];var w=a.getUint32(),k=a.getUint32(),V=new Float32Array(o.slice(l+w,l+w+k)),B=V.length,F=T._inverseBindPosesBuffer=new ArrayBuffer(4*B);for(T._inverseBindPoses=[],T._instanceBufferStateType=0!=B?is.MESH_INSTANCEBUFFER_TYPE_SIMPLEANIMATOR:is.MESH_INSTANCEBUFFER_TYPE_NORMAL,T._setInstanceBuffer(T._instanceBufferStateType),n=0;n<B;n+=16){var U=new q(V[n+0],V[n+1],V[n+2],V[n+3],V[n+4],V[n+5],V[n+6],V[n+7],V[n+8],V[n+9],V[n+10],V[n+11],V[n+12],V[n+13],V[n+14],V[n+15],new Float32Array(F,4*n,16));T._inverseBindPoses[n/16]=U}return!0}},{key:"READ_SUBMESH",value:function(){var e=Br._readData,t=e.__getBuffer(),n=new ts(Br._mesh);e.getInt16();var i=e.getUint32(),r=e.getUint32(),a=Br._mesh._indexBuffer;n._indexBuffer=a,n._setIndexRange(i,r);var o=Br._mesh._vertexBuffer;n._vertexBuffer=o;var s=Br._DATA.offset,l=n._subIndexBufferStart,u=n._subIndexBufferCount,_=n._boneIndicesList,c=e.getUint16();l.length=c,u.length=c,_.length=c;var h=Br._mesh._skinnedMatrixCaches,d=Br._subMeshes.length;h.length=Br._mesh._inverseBindPoses.length;for(var f=0;f<c;f++){l[f]=e.getUint32(),u[f]=e.getUint32();for(var m=e.getUint32(),p=e.getUint32(),v=_[f]=new Uint16Array(t.slice(s+m,s+m+p)),E=0,T=v.length;E<T;E++){var g=v[E];h[g]||(h[g]=new ns(d,f,E))}}return Br._subMeshes.push(n),!0}}]),Br}();fs._BLOCK={count:0},fs._DATA={offset:0,size:0},fs._strings=[];var ms,ps=function(){function Fr(){_classCallCheck(this,Fr)}return _createClass(Fr,null,[{key:"_parse",value:function(e){arguments.length>1&&void 0!==arguments[1]&&arguments[1],arguments.length>2&&void 0!==arguments[2]&&arguments[2];var t=new is;return Fr.read(e,t,t._subMeshes),t}},{key:"read",value:function(e,n,i){var r=new t.Byte(e);r.pos=0;var a=r.readUTFString();switch(a){case"LAYAMODEL:0301":case"LAYAMODEL:0400":case"LAYAMODEL:0401":ds.parse(r,a,n,i);break;case"LAYAMODEL:05":case"LAYAMODEL:COMPRESSION_05":case"LAYAMODEL:0501":case"LAYAMODEL:COMPRESSION_0501":fs.parse(r,a,n,i);break;default:throw new Error("MeshReader: unknown mesh version.")}n._setSubMeshes(i),"LAYAMODEL:0501"!=a&&"LAYAMODEL:COMPRESSION_0501"!=a&&n.calculateBounds()}}]),Fr}(),vs=function(e){function Gr(){var e;_classCallCheck(this,Gr),(e=_possibleConstructorReturn(this,_getPrototypeOf(Gr).call(this)))._exposure=1,e._textureDecodeFormat=t.TextureDecodeFormat.Normal,e._textureHDRParams=new o(1,0,0,1),e.setShaderName("SkyPanoramic");var n=e._shaderValues;return n.setVector(Gr.TINTCOLOR,new o(.5,.5,.5,.5)),n.setNumber(Gr.ROTATION,0),n.setVector(Gr.TEXTURE_HDR_PARAMS,e._textureHDRParams),e}return _inherits(Gr,Gi),_createClass(Gr,[{key:"tintColor",get:function(){return this._shaderValues.getVector(Gr.TINTCOLOR)},set:function(e){this._shaderValues.setVector(Gr.TINTCOLOR,e)}},{key:"exposure",get:function(){return this._exposure},set:function(e){this._exposure!==e&&(this._exposure=e,this._textureDecodeFormat==t.TextureDecodeFormat.RGBM?this._textureHDRParams.x=e*t.BaseTexture._rgbmRange:this._textureHDRParams.x=e)}},{key:"rotation",get:function(){return this._shaderValues.getNumber(Gr.ROTATION)},set:function(e){this._shaderValues.setNumber(Gr.ROTATION,e)}},{key:"panoramicTexture",get:function(){return this._shaderValues.getTexture(Gr.TEXTURE)},set:function(e){this._shaderValues.setTexture(Gr.TEXTURE,e)}},{key:"panoramicTextureDecodeFormat",get:function(){return this._textureDecodeFormat},set:function(e){this._textureDecodeFormat!==e&&(this._textureDecodeFormat=e,e==t.TextureDecodeFormat.RGBM?this._textureHDRParams.x=this._exposure*t.BaseTexture._rgbmRange:this._textureHDRParams.x=this._exposure)}}],[{key:"__init__",value:function(){var e={a_Position:Xn.MESH_POSITION0},t={u_TintColor:xn.PERIOD_MATERIAL,u_TextureHDRParams:xn.PERIOD_MATERIAL,u_Rotation:xn.PERIOD_MATERIAL,u_Texture:xn.PERIOD_MATERIAL,u_ViewProjection:xn.PERIOD_CAMERA},n=xn.add("SkyPanoramic"),i=new Ya(e,t);n.addSubShader(i),i.addShaderPass('#include "Lighting.glsl";\n\n#define PI 3.14159265359\n\nattribute vec4 a_Position;\n\nuniform mat4 u_ViewProjection;\nuniform float u_Rotation;\n\nvarying vec3 v_Texcoord;\nvarying vec2 v_Image180ScaleAndCutoff;\nvarying vec4 v_Layout3DScaleAndOffset;\n\nvec4 rotateAroundYInDegrees (vec4 vertex, float degrees)\n{\n\tfloat angle = degrees * PI / 180.0;\n\tfloat sina=sin(angle);\n\tfloat cosa=cos(angle);\n\tmat2 m = mat2(cosa, -sina, sina, cosa);\n\treturn vec4(m*vertex.xz, vertex.yw).xzyw;\n}\n\n\t\t\nvoid main()\n{\n\tvec4 position = rotateAroundYInDegrees(a_Position, u_Rotation);\n\tgl_Position = u_ViewProjection*position;\n\n\tv_Texcoord=vec3(-a_Position.x,-a_Position.y,a_Position.z);// NOTE: -a_Position.x convert coords system\n\n\t// Calculate constant horizontal scale and cutoff for 180 (vs 360) image type\n\tv_Image180ScaleAndCutoff = vec2(1.0, 1.0);// 360 degree mode\n\n\t// Calculate constant scale and offset for 3D layouts\n\tv_Layout3DScaleAndOffset = vec4(0,0,1,1);\n}\n','#if defined(GL_FRAGMENT_PRECISION_HIGH)//ifdefined\n\tprecision highp float;\n#else\n\tprecision mediump float;\n#endif\n\n#define PI 3.14159265359\n#include "Lighting.glsl";\n\nuniform sampler2D u_Texture;\nuniform vec4 u_TextureHDRParams;\nuniform vec4 u_TintColor;\n\nvarying vec3 v_Texcoord;\nvarying vec2 v_Image180ScaleAndCutoff;\nvarying vec4 v_Layout3DScaleAndOffset;\n\nvec2 ToRadialCoords(vec3 coords)\n{\n\tvec3 normalizedCoords = normalize(coords);\n\tfloat latitude = acos(normalizedCoords.y);\n\tfloat longitude = atan(normalizedCoords.z,normalizedCoords.x);\n\tvec2 sphereCoords = vec2(longitude, latitude) * vec2(0.5/PI, 1.0/PI);\n\treturn vec2(0.5,1.0) - sphereCoords;\n}\n\n\nvoid main()\n{\t\n\tvec2 tc = ToRadialCoords(v_Texcoord);\n\tif (tc.x > v_Image180ScaleAndCutoff.y)\n\t\tgl_FragColor=vec4(0,0,0,1);\n\ttc.x = mod(tc.x*v_Image180ScaleAndCutoff.x, 1.0);\n\ttc = (tc + v_Layout3DScaleAndOffset.xy) * v_Layout3DScaleAndOffset.zw;\n\n\tmediump vec4 tex = texture2D (u_Texture, tc);\n\tmediump vec3 c = decodeHDR (tex, u_TextureHDRParams.x);\n\tc = c * u_TintColor.rgb * 2.0;//Gamma Space is 2.0,linear space is 4.59479380\n\tgl_FragColor=vec4(c, 1.0);\n}\n\n')}}]),Gr}();vs.TINTCOLOR=xn.propertyNameToID("u_TintColor"),vs.EXPOSURE=xn.propertyNameToID("u_Exposure"),vs.ROTATION=xn.propertyNameToID("u_Rotation"),vs.TEXTURE=xn.propertyNameToID("u_Texture"),vs.TEXTURE_HDR_PARAMS=xn.propertyNameToID("u_TextureHDRParams");var Es=function(e){function Hr(e){var t;_classCallCheck(this,Hr),(t=_possibleConstructorReturn(this,_getPrototypeOf(Hr).call(this)))._anchor=new D,t._connectAnchor=new D,t._feedbackEnabled=!1,t._getJointFeedBack=!1,t._currentForce=new D,t._currentTorque=new D,t._constraintType=e;var n=Ct._bullet;return t._btframATrans=n.btTransform_create(),t._btframBTrans=n.btTransform_create(),n.btTransform_setIdentity(t._btframATrans),n.btTransform_setIdentity(t._btframBTrans),t._btframAPos=n.btVector3_create(0,0,0),t._btframBPos=n.btVector3_create(0,0,0),n.btTransform_setOrigin(t._btframATrans,t._btframAPos),n.btTransform_setOrigin(t._btframBTrans,t._btframBPos),t._breakForce=-1,t._breakTorque=-1,t}return _inherits(Hr,t.Component),_createClass(Hr,[{key:"setOverrideNumSolverIterations",value:function(e){Ct._bullet.btTypedConstraint_setOverrideNumSolverIterations(this._btConstraint,e)}},{key:"setConstraintEnabled",value:function(e){Ct._bullet.btTypedConstraint_setEnabled(this._btConstraint,e)}},{key:"_onEnable",value:function(){_get(_getPrototypeOf(Hr.prototype),"_onEnable",this).call(this),this.enabled=!0}},{key:"_onDisable",value:function(){_get(_getPrototypeOf(Hr.prototype),"_onDisable",this).call(this),this.enabled=!1}},{key:"setFrames",value:function(){var e=Ct._bullet;e.btVector3_setValue(this._btframAPos,-this._anchor.x,this.anchor.y,this.anchor.z),e.btVector3_setValue(this._btframBPos,-this._connectAnchor.x,this._connectAnchor.y,this._connectAnchor.z),e.btTransform_setOrigin(this._btframATrans,this._btframAPos),e.btTransform_setOrigin(this._btframBTrans,this._btframBPos)}},{key:"_addToSimulation",value:function(){}},{key:"_removeFromSimulation",value:function(){}},{key:"_createConstraint",value:function(){}},{key:"setConnectRigidBody",value:function(e,t){var n=e&&!!(e._simulation&&e._enabled&&e.colliderShape),i=t&&!!(t._simulation&&t._enabled&&t.colliderShape);if(!n||!i)throw"ownerRigid or connectRigidBody is not in Simulation";e==this._ownBody&&t==this._connectedBody||(!(!this.enabled||!this._simulation)&&this._removeFromSimulation(),this._ownBody=e,this._connectedBody=t,this._ownBody.constaintRigidbodyA=this,this._connectedBody.constaintRigidbodyB=this,this._createConstraint())}},{key:"getcurrentForce",value:function(e){if(!this._btJointFeedBackObj)throw"this Constraint is not simulation";var t=Ct._bullet,n=t.btJointFeedback_getAppliedForceBodyA(this._btJointFeedBackObj);e.setValue(t.btVector3_x(n),t.btVector3_y(n),t.btVector3_z(n))}},{key:"getcurrentTorque",value:function(e){if(!this._btJointFeedBackObj)throw"this Constraint is not simulation";var t=Ct._bullet,n=t.btJointFeedback_getAppliedTorqueBodyA(this._btJointFeedBackObj);e.setValue(t.btVector3_x(n),t.btVector3_y(n),t.btVector3_z(n))}},{key:"_onDestroy",value:function(){var e=Ct._bullet;this._simulation&&this._removeFromSimulation(),this._btConstraint&&this._btJointFeedBackObj&&this._simulation&&(e.btTypedConstraint_destroy(this._btConstraint),e.btJointFeedback_destroy(this._btJointFeedBackObj),this._btJointFeedBackObj=null,this._btConstraint=null),_get(_getPrototypeOf(Hr.prototype),"_onDisable",this).call(this)}},{key:"_isBreakConstrained",value:function(){if(this._getJointFeedBack=!1,-1==this.breakForce&&-1==this.breakTorque)return!1;this._getFeedBackInfo();var e=-1!=this._breakForce&&D.scalarLength(this._currentForce)>this._breakForce,t=-1!=this._breakTorque&&D.scalarLength(this._currentTorque)>this._breakTorque;return!(!e&&!t||(this._breakConstrained(),0))}},{key:"_parse",value:function(e){this._anchor.fromArray(e.anchor),this._connectAnchor.fromArray(e.connectAnchor),this.setFrames()}},{key:"_getFeedBackInfo",value:function(){var e=Ct._bullet,t=e.btJointFeedback_getAppliedForceBodyA(this._btJointFeedBackObj),n=e.btJointFeedback_getAppliedTorqueBodyA(this._btJointFeedBackObj);this._currentTorque.setValue(e.btVector3_x(n),e.btVector3_y(n),e.btVector3_z(n)),this._currentForce.setValue(e.btVector3_x(t),e.btVector3_y(t),e.btVector3_z(t)),this._getJointFeedBack=!0}},{key:"_breakConstrained",value:function(){this.ownBody.constaintRigidbodyA=null,this.connectedBody&&(this.connectedBody.constaintRigidbodyB=null),this.destroy()}},{key:"enabled",get:function(){return _get(_getPrototypeOf(Hr.prototype),"enabled",this)},set:function(e){_set(_getPrototypeOf(Hr.prototype),"enabled",e,this,!0)}},{key:"appliedImpulse",get:function(){return this._feedbackEnabled||(this._btConstraint.EnableFeedback(!0),this._feedbackEnabled=!0),this._btConstraint.AppliedImpulse}},{key:"connectedBody",set:function(e){this._connectedBody=e,e&&(e.constaintRigidbodyB=this)},get:function(){return this._connectedBody}},{key:"ownBody",get:function(){return this._ownBody},set:function(e){this._ownBody=e,e.constaintRigidbodyA=this}},{key:"currentForce",get:function(){return this._getJointFeedBack||this._getFeedBackInfo(),this._currentForce}},{key:"currentTorque",get:function(){return this._getJointFeedBack||this._getFeedBackInfo(),this._currentTorque}},{key:"breakForce",get:function(){return this._breakForce},set:function(e){this._breakForce=e}},{key:"breakTorque",get:function(){return this._breakTorque},set:function(e){this._breakTorque=e}},{key:"anchor",set:function(e){e.cloneTo(this._anchor),this.setFrames()},get:function(){return this._anchor}},{key:"connectAnchor",set:function(e){e.cloneTo(this._connectAnchor),this.setFrames()},get:function(){return this._connectAnchor}}]),Hr}();Es.CONSTRAINT_POINT2POINT_CONSTRAINT_TYPE=3,Es.CONSTRAINT_HINGE_CONSTRAINT_TYPE=4,Es.CONSTRAINT_CONETWIST_CONSTRAINT_TYPE=5,Es.CONSTRAINT_D6_CONSTRAINT_TYPE=6,Es.CONSTRAINT_SLIDER_CONSTRAINT_TYPE=7,Es.CONSTRAINT_CONTACT_CONSTRAINT_TYPE=8,Es.CONSTRAINT_D6_SPRING_CONSTRAINT_TYPE=9,Es.CONSTRAINT_GEAR_CONSTRAINT_TYPE=10,Es.CONSTRAINT_FIXED_CONSTRAINT_TYPE=11,Es.CONSTRAINT_MAX_CONSTRAINT_TYPE=12,Es.CONSTRAINT_CONSTRAINT_ERP=1,Es.CONSTRAINT_CONSTRAINT_STOP_ERP=2,Es.CONSTRAINT_CONSTRAINT_CFM=3,Es.CONSTRAINT_CONSTRAINT_STOP_CFM=4,Es.tempForceV3=new D;var Ts=function(e){function zr(){var e;return _classCallCheck(this,zr),(e=_possibleConstructorReturn(this,_getPrototypeOf(zr).call(this,Es.CONSTRAINT_FIXED_CONSTRAINT_TYPE))).breakForce=-1,e.breakTorque=-1,e}return _inherits(zr,Es),_createClass(zr,[{key:"_addToSimulation",value:function(){this._simulation&&this._simulation.addConstraint(this,this.enabled)}},{key:"_removeFromSimulation",value:function(){this._simulation.removeConstraint(this),this._simulation=null}},{key:"_createConstraint",value:function(){if(this.ownBody&&this.ownBody._simulation&&this.connectedBody&&this.connectedBody._simulation){var e=Ct._bullet;this._btConstraint=e.btFixedConstraint_create(this.ownBody.btColliderObject,this._btframATrans,this.connectedBody.btColliderObject,this._btframBTrans),this._btJointFeedBackObj=e.btJointFeedback_create(this._btConstraint),e.btTypedConstraint_setJointFeedback(this._btConstraint,this._btJointFeedBackObj),this._simulation=this.owner._scene.physicsSimulation,this._addToSimulation(),Ct._bullet.btTypedConstraint_setEnabled(this._btConstraint,!0)}}},{key:"_onAdded",value:function(){_get(_getPrototypeOf(zr.prototype),"_onAdded",this).call(this)}},{key:"_onEnable",value:function(){this._btConstraint&&(_get(_getPrototypeOf(zr.prototype),"_onEnable",this).call(this),this._btConstraint&&Ct._bullet.btTypedConstraint_setEnabled(this._btConstraint,!0))}},{key:"_onDisable",value:function(){_get(_getPrototypeOf(zr.prototype),"_onDisable",this).call(this),this.connectedBody||this._removeFromSimulation(),this._btConstraint&&Ct._bullet.btTypedConstraint_setEnabled(this._btConstraint,!1)}},{key:"_onDestroy",value:function(){_get(_getPrototypeOf(zr.prototype),"_onDestroy",this).call(this)}},{key:"_parse",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;_get(_getPrototypeOf(zr.prototype),"_parse",this).call(this,e),-1!=e.rigidbodyID&&-1!=e.connectRigidbodyID&&(t.component.push(this),t.data.push(e)),null!=e.breakForce&&(this.breakForce=e.breakForce),null!=e.breakTorque&&(this.breakTorque=e.breakTorque)}},{key:"_parseInteractive",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=t[e.rigidbodyID].getComponent(Rt),i=t[e.connectRigidbodyID].getComponent(Rt);this.ownBody=n,this.connectedBody=i}}]),zr}(),gs=function(e){function kr(){var e;_classCallCheck(this,kr),(e=_possibleConstructorReturn(this,_getPrototypeOf(kr).call(this,Es.CONSTRAINT_D6_SPRING_CONSTRAINT_TYPE)))._axis=new D,e._secondaryAxis=new D,e._minLinearLimit=new D,e._maxLinearLimit=new D,e._minAngularLimit=new D,e._maxAngularLimit=new D,e._linearLimitSpring=new D,e._angularLimitSpring=new D,e._linearBounce=new D,e._angularBounce=new D,e._linearDamp=new D,e._angularDamp=new D,e._xMotion=0,e._yMotion=0,e._zMotion=0,e._angularXMotion=0,e._angularYMotion=0,e._angularZMotion=0;var t=Ct._bullet;return e._btAxis=t.btVector3_create(-1,0,0),e._btSecondaryAxis=t.btVector3_create(0,1,0),e}return _inherits(kr,Es),_createClass(kr,[{key:"setAxis",value:function(e,t){if(this._btConstraint){var n=Ct._bullet;this._axis.setValue(e.x,e.y,e.y),this._secondaryAxis.setValue(t.x,t.y,t.z),this._btAxis=n.btVector3_setValue(-e.x,e.y,e.z),this._btSecondaryAxis=n.btVector3_setValue(-t.x,t.y,t.z),n.btGeneric6DofSpring2Constraint_setAxis(this._btConstraint,this._btAxis,this._btSecondaryAxis)}}},{key:"setLimit",value:function(e,t,n,i){if(this._btConstraint){var r=Ct._bullet;switch(t){case kr.CONFIG_MOTION_TYPE_LOCKED:r.btGeneric6DofSpring2Constraint_setLimit(this._btConstraint,e,0,0);break;case kr.CONFIG_MOTION_TYPE_LIMITED:n<i&&r.btGeneric6DofSpring2Constraint_setLimit(this._btConstraint,e,n,i);break;case kr.CONFIG_MOTION_TYPE_FREE:r.btGeneric6DofSpring2Constraint_setLimit(this._btConstraint,e,1,0);break;default:throw"No Type of Axis Motion"}}}},{key:"setSpring",value:function(e,t){var n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];if(this._btConstraint){var i=Ct._bullet,r=t>0;i.btGeneric6DofSpring2Constraint_enableSpring(this._btConstraint,e,r),r&&i.btGeneric6DofSpring2Constraint_setStiffness(this._btConstraint,e,t,n)}}},{key:"setBounce",value:function(e,t){this._btConstraint&&(t=t<=0?0:t,Ct._bullet.btGeneric6DofSpring2Constraint_setBounce(this._btConstraint,e,t))}},{key:"setDamping",value:function(e,t){var n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];this._btConstraint&&(t=t<=0?0:t,Ct._bullet.btGeneric6DofSpring2Constraint_setDamping(this._btConstraint,e,t,n))}},{key:"setEquilibriumPoint",value:function(e,t){Ct._bullet.btGeneric6DofSpring2Constraint_setEquilibriumPoint(this._btConstraint,e,t)}},{key:"enableMotor",value:function(e,t){Ct._bullet.btGeneric6DofSpring2Constraint_enableMotor(this._btConstraint,e,t)}},{key:"setServo",value:function(e,t){Ct._bullet.btGeneric6DofSpring2Constraint_setServo(this._btConstraint,e,t)}},{key:"setTargetVelocity",value:function(e,t){Ct._bullet.btGeneric6DofSpring2Constraint_setTargetVelocity(this._btConstraint,e,t)}},{key:"setTargetPosition",value:function(e,t){Ct._bullet.btGeneric6DofSpring2Constraint_setServoTarget(this._btConstraint,e,t)}},{key:"setMaxMotorForce",value:function(e,t){Ct._bullet.btGeneric6DofSpring2Constraint_setMaxMotorForce(this._btConstraint,e,t)}},{key:"setParam",value:function(e,t,n){Ct._bullet.btTypedConstraint_setParam(this._btConstraint,e,t,n)}},{key:"setFrames",value:function(){_get(_getPrototypeOf(kr.prototype),"setFrames",this).call(this);var e=Ct._bullet;this._btConstraint&&e.btGeneric6DofSpring2Constraint_setFrames(this._btConstraint,this._btframATrans,this._btframBTrans)}},{key:"_addToSimulation",value:function(){this._simulation&&this._simulation.addConstraint(this,this.enabled)}},{key:"_removeFromSimulation",value:function(){this._simulation.removeConstraint(this),this._simulation=null}},{key:"_createConstraint",value:function(){var e=Ct._bullet;this._btConstraint=e.btGeneric6DofSpring2Constraint_create(this.ownBody.btColliderObject,this._btframAPos,this.connectedBody.btColliderObject,this._btframBPos,kr.RO_XYZ),this._btJointFeedBackObj=e.btJointFeedback_create(this._btConstraint),e.btTypedConstraint_setJointFeedback(this._btConstraint,this._btJointFeedBackObj),this._simulation=this.owner._scene.physicsSimulation,this._initAllConstraintInfo(),this._addToSimulation(),Ct._bullet.btTypedConstraint_setEnabled(this._btConstraint,!0)}},{key:"_initAllConstraintInfo",value:function(){this.setLimit(kr.MOTION_LINEAR_INDEX_X,this._xMotion,-this._maxLinearLimit.x,-this._minLinearLimit.x),this.setLimit(kr.MOTION_LINEAR_INDEX_Y,this._yMotion,this._minLinearLimit.y,this._maxLinearLimit.y),this.setLimit(kr.MOTION_LINEAR_INDEX_Z,this._zMotion,this._minLinearLimit.z,this._maxLinearLimit.z),this.setLimit(kr.MOTION_ANGULAR_INDEX_X,this._angularXMotion,-this._maxAngularLimit.x,-this._minAngularLimit.x),this.setLimit(kr.MOTION_ANGULAR_INDEX_Y,this._angularYMotion,this._minAngularLimit.y,this._maxAngularLimit.y),this.setLimit(kr.MOTION_ANGULAR_INDEX_Z,this._angularZMotion,this._minAngularLimit.z,this._maxAngularLimit.z),this.setSpring(kr.MOTION_LINEAR_INDEX_X,this._linearLimitSpring.x),this.setSpring(kr.MOTION_LINEAR_INDEX_Y,this._linearLimitSpring.y),this.setSpring(kr.MOTION_LINEAR_INDEX_Z,this._linearLimitSpring.z),this.setSpring(kr.MOTION_ANGULAR_INDEX_X,this._angularLimitSpring.x),this.setSpring(kr.MOTION_ANGULAR_INDEX_Y,this._angularLimitSpring.y),this.setSpring(kr.MOTION_ANGULAR_INDEX_Z,this._angularLimitSpring.z),this.setBounce(kr.MOTION_LINEAR_INDEX_X,this._linearBounce.x),this.setBounce(kr.MOTION_LINEAR_INDEX_Y,this._linearBounce.y),this.setBounce(kr.MOTION_LINEAR_INDEX_Z,this._linearBounce.z),this.setBounce(kr.MOTION_ANGULAR_INDEX_X,this._angularBounce.x),this.setBounce(kr.MOTION_ANGULAR_INDEX_Y,this._angularBounce.y),this.setBounce(kr.MOTION_ANGULAR_INDEX_Z,this._angularBounce.z),this.setDamping(kr.MOTION_LINEAR_INDEX_X,this._linearDamp.x),this.setDamping(kr.MOTION_LINEAR_INDEX_Y,this._linearDamp.y),this.setDamping(kr.MOTION_LINEAR_INDEX_Z,this._linearDamp.z),this.setDamping(kr.MOTION_ANGULAR_INDEX_X,this._angularDamp.x),this.setDamping(kr.MOTION_ANGULAR_INDEX_Y,this._angularDamp.y),this.setDamping(kr.MOTION_ANGULAR_INDEX_Z,this._angularDamp.z),this.setFrames(),this.setEquilibriumPoint(0,0)}},{key:"_onAdded",value:function(){_get(_getPrototypeOf(kr.prototype),"_onAdded",this).call(this)}},{key:"_onEnable",value:function(){this._btConstraint&&(_get(_getPrototypeOf(kr.prototype),"_onEnable",this).call(this),this._btConstraint&&Ct._bullet.btTypedConstraint_setEnabled(this._btConstraint,!0))}},{key:"_onDisable",value:function(){_get(_getPrototypeOf(kr.prototype),"_onDisable",this).call(this),!this.connectedBody&&this._simulation&&this._removeFromSimulation(),this._btConstraint&&Ct._bullet.btTypedConstraint_setEnabled(this._btConstraint,!1)}},{key:"_parse",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;_get(_getPrototypeOf(kr.prototype),"_parse",this).call(this,e),this._axis.fromArray(e.axis),this._secondaryAxis.fromArray(e.secondaryAxis);var n=e.linearLimit;this._minLinearLimit.setValue(-n,-n,-n),this._maxLinearLimit.setValue(n,n,n);var i=e.linearLimitSpring;this._linearLimitSpring.setValue(i,i,i);var r=e.linearLimitDamper;this._linearDamp.setValue(r,r,r);var a=e.linearLimitBounciness;this._linearBounce.setValue(a,a,a);var o=e.lowAngularXLimit,s=e.highAngularXLimit,l=e.angularYLimit,u=e.angularZLimit;this._minAngularLimit.setValue(o,-l,-u),this._maxAngularLimit.setValue(s,l,u);var _=e.highAngularXLimitBounciness,c=e.angularYLimitBounciness,h=e.angularZLimitBounciness;this._angularBounce.setValue(_,c,h);var d=e.angularXLimitSpring,f=e.angularYZLimitSpring;this._angularLimitSpring.setValue(d,f,f);var m=e.angularXLimitDamper,p=e.angularYZLimitDamper;this._angularDamp.setValue(m,p,p),this.XMotion=e.xMotion,this.YMotion=e.yMotion,this.ZMotion=e.zMotion,this.angularXMotion=e.angularXMotion,this.angularYMotion=e.angularYMotion,this.angularZMotion=e.angularZMotion,-1!=e.rigidbodyID&&-1!=e.connectRigidbodyID&&(t.component.push(this),t.data.push(e)),null!=e.breakForce&&(this.breakForce=e.breakForce),null!=e.breakTorque&&(this.breakTorque=e.breakTorque)}},{key:"_parseInteractive",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=t[e.rigidbodyID].getComponent(Rt),i=t[e.connectRigidbodyID].getComponent(Rt);this.ownBody=n,this.connectedBody=i}},{key:"_onDestroy",value:function(){_get(_getPrototypeOf(kr.prototype),"_onDestroy",this).call(this)}},{key:"axis",get:function(){return this._axis}},{key:"secondaryAxis",get:function(){return this._secondaryAxis}},{key:"maxAngularLimit",set:function(e){e.cloneTo(this._maxAngularLimit)},get:function(){return this._maxAngularLimit}},{key:"minAngularLimit",set:function(e){e.cloneTo(this._minAngularLimit)},get:function(){return this._minAngularLimit}},{key:"maxLinearLimit",set:function(e){e.cloneTo(this._maxLinearLimit)},get:function(){return this._maxLinearLimit}},{key:"minLinearLimit",set:function(e){e.cloneTo(this._minLinearLimit)},get:function(){return this._minLinearLimit}},{key:"XMotion",set:function(e){this._xMotion!=e&&(this._xMotion=e,this.setLimit(kr.MOTION_LINEAR_INDEX_X,e,-this._maxLinearLimit.x,-this._minLinearLimit.x))},get:function(){return this._xMotion}},{key:"YMotion",set:function(e){this._yMotion!=e&&(this._yMotion=e,this.setLimit(kr.MOTION_LINEAR_INDEX_Y,e,this._minLinearLimit.y,this._maxLinearLimit.y))},get:function(){return this._yMotion}},{key:"ZMotion",set:function(e){this._zMotion!=e&&(this._zMotion=e,this.setLimit(kr.MOTION_LINEAR_INDEX_Z,e,this._minLinearLimit.z,this._maxLinearLimit.z))},get:function(){return this._zMotion}},{key:"angularXMotion",set:function(e){this._angularXMotion!=e&&(this._angularXMotion=e,this.setLimit(kr.MOTION_ANGULAR_INDEX_X,e,-this._maxAngularLimit.x,-this._minAngularLimit.x))},get:function(){return this._angularXMotion}},{key:"angularYMotion",set:function(e){this._angularYMotion!=e&&(this._angularYMotion=e,this.setLimit(kr.MOTION_ANGULAR_INDEX_Y,e,this._minAngularLimit.y,this._maxAngularLimit.y))},get:function(){return this._angularYMotion}},{key:"angularZMotion",set:function(e){this._angularZMotion!=e&&(this._angularZMotion=e,this.setLimit(kr.MOTION_ANGULAR_INDEX_Z,e,this._minAngularLimit.z,this._maxAngularLimit.z))},get:function(){return this._angularZMotion}},{key:"linearLimitSpring",set:function(e){D.equals(this._linearLimitSpring,e)||(e.cloneTo(this._linearLimitSpring),this.setSpring(kr.MOTION_LINEAR_INDEX_X,e.x),this.setSpring(kr.MOTION_LINEAR_INDEX_Y,e.y),this.setSpring(kr.MOTION_LINEAR_INDEX_Z,e.z))},get:function(){return this._linearLimitSpring}},{key:"angularLimitSpring",set:function(e){D.equals(this._angularLimitSpring,e)||(e.cloneTo(this._angularLimitSpring),this.setSpring(kr.MOTION_ANGULAR_INDEX_X,e.x),this.setSpring(kr.MOTION_ANGULAR_INDEX_Y,e.y),this.setSpring(kr.MOTION_ANGULAR_INDEX_Z,e.z))},get:function(){return this._angularLimitSpring}},{key:"linearBounce",set:function(e){D.equals(this._linearBounce,e)||(e.cloneTo(this._linearBounce),this.setBounce(kr.MOTION_LINEAR_INDEX_X,e.x),this.setBounce(kr.MOTION_LINEAR_INDEX_Y,e.y),this.setBounce(kr.MOTION_LINEAR_INDEX_Z,e.z))},get:function(){return this._linearBounce}},{key:"angularBounce",set:function(e){D.equals(this._angularBounce,e)||(e.cloneTo(this._angularBounce),this.setBounce(kr.MOTION_ANGULAR_INDEX_X,e.x),this.setBounce(kr.MOTION_ANGULAR_INDEX_Y,e.y),this.setBounce(kr.MOTION_ANGULAR_INDEX_Z,e.z))},get:function(){return this._angularBounce}},{key:"linearDamp",set:function(e){D.equals(this._linearDamp,e)||(e.cloneTo(this._linearDamp),this.setDamping(kr.MOTION_LINEAR_INDEX_X,e.x),this.setDamping(kr.MOTION_LINEAR_INDEX_Y,e.y),this.setDamping(kr.MOTION_LINEAR_INDEX_Z,e.z))},get:function(){return this._linearDamp}},{key:"angularDamp",set:function(e){D.equals(this._angularDamp,e)||(e.cloneTo(this._angularDamp),this.setDamping(kr.MOTION_ANGULAR_INDEX_X,e.x),this.setDamping(kr.MOTION_ANGULAR_INDEX_Y,e.y),this.setDamping(kr.MOTION_ANGULAR_INDEX_Z,e.z))},get:function(){return this._angularDamp}},{key:"anchor",set:function(e){e.cloneTo(this._anchor),this.setFrames()},get:function(){return this._anchor}},{key:"connectAnchor",set:function(e){e.cloneTo(this._connectAnchor),this.setFrames()},get:function(){return this._connectAnchor}}]),kr}();gs.CONFIG_MOTION_TYPE_LOCKED=0,gs.CONFIG_MOTION_TYPE_LIMITED=1,gs.CONFIG_MOTION_TYPE_FREE=2,gs.MOTION_LINEAR_INDEX_X=0,gs.MOTION_LINEAR_INDEX_Y=1,gs.MOTION_LINEAR_INDEX_Z=2,gs.MOTION_ANGULAR_INDEX_X=3,gs.MOTION_ANGULAR_INDEX_Y=4,gs.MOTION_ANGULAR_INDEX_Z=5,gs.RO_XYZ=0,gs.RO_XZY=1,gs.RO_YXZ=2,gs.RO_YZX=3,gs.RO_ZXY=4,gs.RO_ZYX=5;var ys=function(){function Wr(){_classCallCheck(this,Wr)}return _createClass(Wr,null,[{key:"_cancelLoadByUrl",value:function(e){t.Laya.loader.cancelLoadByUrl(e),Wr._innerFirstLevelLoaderManager.cancelLoadByUrl(e),Wr._innerSecondLevelLoaderManager.cancelLoadByUrl(e),Wr._innerThirdLevelLoaderManager.cancelLoadByUrl(e),Wr._innerFourthLevelLoaderManager.cancelLoadByUrl(e)}},{key:"_changeWebGLSize",value:function(e,n){t.WebGL.onStageResize(e,n),dn.clientWidth=e,dn.clientHeight=n}},{key:"__init__",value:function(n,i,r){if(t.Config.isAntialias=r.isAntialias,t.Config.isAlpha=r.isAlpha,t.Config.premultipliedAlpha=r.premultipliedAlpha,t.Config.isStencil=r.isStencil,t.WebGL.enable()){t.RunDriver.changeWebGLSize=Wr._changeWebGLSize,t.Render.is3DMode=!0,t.Laya.init(n,i),t.Render.supportWebGLPlusRendering||(t.LayaGL.instance=t.WebGLContext.mainContext,t.LayaGL.instance.createCommandEncoder=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:128,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:64,i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return new t.CommandEncoder(this,e,n,i)}),r._multiLighting=r.enableMultiLight&&t.SystemUtils.supportTextureFormat(t.TextureFormat.R32G32B32A32),F.Shader3D=xn,F.Scene3D=Wa,F.MeshRenderStaticBatchManager=xa,F.MeshRenderDynamicBatchManager=ao,F.SubMeshDynamicBatch=ro,F.Laya3D=Wr,F.Matrix4x4=q,F.Physics3D=Ct,F.ShadowLightType=e.ShadowLightType,Wr.enableNative3D(),r.isUseCannonPhysicsEngine&&Ct.__cannoninit__(),Ct.__bulletinit__(),vn.__init__(),Xn.__init__(),wo.__init__(),ko.__init__(),_a.__init__(),jo.__init__(),Jo.__init__(),Ta.__init__(),Ra.__init__(),ro.__init__(),os.__init__(),Jn.init(),or.__init__(),Ka.__init__(),Qa.__init__(),vs.__init__(),is.__init__(),rs.__init__(),Nn.__init__(),ya.__init__(),oo.__init__(),Wo.__init__(),cs.__init__(),Go.__init__(),Ko.__init__(),Vi.__init__(),Wa.__init__(),xa.__init__(),Gi.__initDefine__(),Hi.__initDefine__(),Ki.__initDefine__(),$a.__initDefine__(),eo.__initDefine__(),Xo.__initDefine__(),er.__initDefine__(),to.__initDefine__(),No.__initDefine__(),rr.__initDefine__(),ma.__initDefine__(),Ja.__initDefine__(),Dn.__init__(),t.ClassUtils.regClass("Laya.SkyPanoramicMaterial",vs),t.ClassUtils.regClass("Laya.EffectMaterial",er),t.ClassUtils.regClass("Laya.UnlitMaterial",eo),t.ClassUtils.regClass("Laya.BlinnPhongMaterial",Ki),t.ClassUtils.regClass("Laya.SkyProceduralMaterial",$a),t.ClassUtils.regClass("Laya.PBRStandardMaterial",Ka),t.ClassUtils.regClass("Laya.PBRSpecularMaterial",Qa),t.ClassUtils.regClass("Laya.SkyBoxMaterial",Ja),t.ClassUtils.regClass("Laya.WaterPrimaryMaterial",to),t.ClassUtils.regClass("Laya.ExtendTerrainMaterial",rr),t.ClassUtils.regClass("Laya.ShurikenParticleMaterial",No),t.ClassUtils.regClass("Laya.TrailMaterial",Xo),t.ClassUtils.regClass("Laya.PhysicsCollider",es),t.ClassUtils.regClass("Laya.Rigidbody3D",Rt),t.ClassUtils.regClass("Laya.CharacterController",yt),t.ClassUtils.regClass("Laya.Animator",hn),t.ClassUtils.regClass("PhysicsCollider",es),t.ClassUtils.regClass("CharacterController",yt),t.ClassUtils.regClass("Animator",hn),t.ClassUtils.regClass("Rigidbody3D",Rt),t.ClassUtils.regClass("FixedConstraint",Ts),t.ClassUtils.regClass("ConfigurableConstraint",gs),ma.defaultMaterial=new ma,Ki.defaultMaterial=new Ki,er.defaultMaterial=new er,eo.defaultMaterial=new eo,No.defaultMaterial=new No,Xo.defaultMaterial=new Xo,$a.defaultMaterial=new $a,Ja.defaultMaterial=new Ja,to.defaultMaterial=new to,ma.defaultMaterial.lock=!0,Ki.defaultMaterial.lock=!0,er.defaultMaterial.lock=!0,eo.defaultMaterial.lock=!0,No.defaultMaterial.lock=!0,Xo.defaultMaterial.lock=!0,$a.defaultMaterial.lock=!0,Ja.defaultMaterial.lock=!0,to.defaultMaterial.lock=!0,t.Texture2D.__init__(),ha.__init__(),jn.__init__(),ca.__init__(),Sn.__init__(),Rn.__init__(),ra.__init__(),t.HalfFloatUtils.__init__();var a=t.LoaderManager.createMap;a.lh=[Wr.HIERARCHY,hs._parse],a.ls=[Wr.HIERARCHY,hs._parseScene],a.lm=[Wr.MESH,ps._parse],a.lmat=[Wr.MATERIAL,Gi._parse],a.jpg=[Wr.TEXTURE2D,t.Texture2D._parse],a.jpeg=[Wr.TEXTURE2D,t.Texture2D._parse],a.bmp=[Wr.TEXTURE2D,t.Texture2D._parse],a.gif=[Wr.TEXTURE2D,t.Texture2D._parse],a.png=[Wr.TEXTURE2D,t.Texture2D._parse],a.dds=[Wr.TEXTURE2D,t.Texture2D._parse],a.ktx=[Wr.TEXTURE2D,t.Texture2D._parse],a.pvr=[Wr.TEXTURE2D,t.Texture2D._parse],a.lani=[Wr.ANIMATIONCLIP,sn._parse],a.lav=[Wr.AVATAR,Ui._parse],a.ltc=[Wr.TEXTURECUBE,ha._parse],a.ltcb=[Wr.TEXTURECUBEBIN,ha._parseBin],a["ltcb.ls"]=[Wr.TEXTURECUBEBIN,ha._parseBin],a["lanit.ls"]=[Wr.TEXTURE2D,t.Texture2D._SimpleAnimatorTextureParse];var o=t.Loader.parserMap;o[Wr.HIERARCHY]=Wr._loadHierarchy,o[Wr.MESH]=Wr._loadMesh,o[Wr.MATERIAL]=Wr._loadMaterial,o[Wr.TEXTURECUBE]=Wr._loadTextureCube,o[Wr.TEXTURECUBEBIN]=Wr._loadTextureCubeBin,o[Wr.TEXTURE2D]=Wr._loadTexture2D,o[Wr.ANIMATIONCLIP]=Wr._loadAnimationClip,o[Wr.AVATAR]=Wr._loadAvatar,o[Wr.SIMPLEANIMATORBIN]=Wr._loadSimpleAnimator,Wr._innerFirstLevelLoaderManager.on(t.Event.ERROR,null,Wr._eventLoadManagerError),Wr._innerSecondLevelLoaderManager.on(t.Event.ERROR,null,Wr._eventLoadManagerError),Wr._innerThirdLevelLoaderManager.on(t.Event.ERROR,null,Wr._eventLoadManagerError),Wr._innerFourthLevelLoaderManager.on(t.Event.ERROR,null,Wr._eventLoadManagerError)}else alert("Laya3D init error,must support webGL!")}},{key:"enableNative3D",value:function(){var e=En,n=qr;t.Render.supportWebGLPlusRendering&&(e.prototype._initData=e.prototype._initDataForNative,e.prototype.setBool=e.prototype.setBoolForNative,e.prototype.getBool=e.prototype.getBoolForNative,e.prototype.setInt=e.prototype.setIntForNative,e.prototype.getInt=e.prototype.getIntForNative,e.prototype.setNumber=e.prototype.setNumberForNative,e.prototype.getNumber=e.prototype.getNumberForNative,e.prototype.setVector=e.prototype.setVectorForNative,e.prototype.getVector=e.prototype.getVectorForNative,e.prototype.setVector2=e.prototype.setVector2ForNative,e.prototype.getVector2=e.prototype.getVector2ForNative,e.prototype.setVector3=e.prototype.setVector3ForNative,e.prototype.getVector3=e.prototype.getVector3ForNative,e.prototype.setQuaternion=e.prototype.setQuaternionForNative,e.prototype.getQuaternion=e.prototype.getQuaternionForNative,e.prototype.setMatrix4x4=e.prototype.setMatrix4x4ForNative,e.prototype.getMatrix4x4=e.prototype.getMatrix4x4ForNative,e.prototype.setBuffer=e.prototype.setBufferForNative,e.prototype.getBuffer=e.prototype.getBufferForNative,e.prototype.setTexture=e.prototype.setTextureForNative,e.prototype.getTexture=e.prototype.getTextureForNative,e.prototype.setAttribute=e.prototype.setAttributeForNative,e.prototype.getAttribute=e.prototype.getAttributeForNative,e.prototype.cloneTo=e.prototype.cloneToForNative,e.prototype.getData=e.prototype.getDataForNative,n.prototype._uniformMatrix2fv=n.prototype._uniformMatrix2fvForNative,n.prototype._uniformMatrix3fv=n.prototype._uniformMatrix3fvForNative,n.prototype._uniformMatrix4fv=n.prototype._uniformMatrix4fvForNative,t.LayaGLRunner.uploadShaderUniforms=t.LayaGLRunner.uploadShaderUniformsForNative)}},{key:"formatRelativePath",value:function(e,t){var n;if(n=e+t,"."===t.charAt(0)){for(var i=n.split("/"),r=0,a=i.length;r<a;r++)if(".."==i[r]){var o=r-1;o>0&&".."!==i[o]&&(i.splice(o,2),r-=2)}n=i.join("/")}return n}},{key:"_endLoad",value:function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;if(i)for(var r=0,a=i.length;r<a;r++){var o=t.Loader.getRes(i[r]);o&&o._removeReference()}e.endLoad(n)}},{key:"_eventLoadManagerError",value:function(e){t.Laya.loader.event(t.Event.ERROR,e)}},{key:"_addHierarchyInnerUrls",value:function(e,t,n,i,r,a){var o=arguments.length>6&&void 0!==arguments[6]?arguments[6]:null,s=arguments.length>7&&void 0!==arguments[7]?arguments[7]:null,l=Wr.formatRelativePath(i,r);return n&&(l+=n),e.push({url:l,type:a,constructParams:o,propertyParams:s}),t.push(l),l}},{key:"_getSprite3DHierarchyInnerUrls",value:function(e,t,n,i,r,a,o,s){var l,u,_=e.props;switch(e.type){case"Scene3D":var c=_.lightmaps;for(l=0,u=c.length;l<u;l++){var h=c[l];if(h.path)h.path=Wr._addHierarchyInnerUrls(r,a,o,s,h.path,Wr.TEXTURE2D,h.constructParams,h.propertyParams);else{var d=h.color;d.path=Wr._addHierarchyInnerUrls(r,a,o,s,d.path,Wr.TEXTURE2D,d.constructParams,d.propertyParams);var f=h.direction;f&&(f.path=Wr._addHierarchyInnerUrls(r,a,o,s,f.path,Wr.TEXTURE2D,f.constructParams,f.propertyParams))}}var m=_.reflectionTexture;m&&(_.reflection=Wr._addHierarchyInnerUrls(i,a,o,s,m,Wr.TEXTURECUBE));var p=_.reflection;if(p&&(_.reflection=Wr._addHierarchyInnerUrls(r,a,o,s,p,Wr.TEXTURECUBEBIN)),_.sky){var v=_.sky.material;v&&(v.path=Wr._addHierarchyInnerUrls(n,a,o,s,v.path,Wr.MATERIAL))}break;case"Camera":var E=_.skyboxMaterial;E&&(E.path=Wr._addHierarchyInnerUrls(n,a,o,s,E.path,Wr.MATERIAL));break;case"TrailSprite3D":case"MeshSprite3D":case"SkinnedMeshSprite3D":case"SimpleSkinnedMeshSprite3D":var T=_.meshPath;T&&(_.meshPath=Wr._addHierarchyInnerUrls(t,a,o,s,T,Wr.MESH));var g=_.materials;if(g)for(l=0,u=g.length;l<u;l++)g[l].path=Wr._addHierarchyInnerUrls(n,a,o,s,g[l].path,Wr.MATERIAL);"SimpleSkinnedMeshSprite3D"==e.type&&_.animatorTexture&&(_.animatorTexture=Wr._addHierarchyInnerUrls(r,a,o,s,_.animatorTexture,Wr.SIMPLEANIMATORBIN));break;case"ShuriKenParticle3D":if(_.main){var y=_.renderer.resources,S=y.mesh,R=y.material;S&&(y.mesh=Wr._addHierarchyInnerUrls(t,a,o,s,S,Wr.MESH)),R&&(y.material=Wr._addHierarchyInnerUrls(n,a,o,s,R,Wr.MATERIAL))}else{var C=_.meshPath;C&&(_.meshPath=Wr._addHierarchyInnerUrls(t,a,o,s,C,Wr.MESH)),_.material.path=Wr._addHierarchyInnerUrls(n,a,o,s,_.material.path,Wr.MATERIAL)}break;case"Terrain":Wr._addHierarchyInnerUrls(r,a,o,s,_.dataPath,Wr.TERRAINRES);break;case"ReflectionProbe":var A=_.reflection;A&&(_.reflection=Wr._addHierarchyInnerUrls(t,a,o,s,A,Wr.TEXTURECUBEBIN))}var I=e.components;if(I)for(var x=0,D=I.length;x<D;x++){var M=I[x];switch(M.type){case"Animator":M.avatarPath;var L=M.avatar;L&&(L.path=Wr._addHierarchyInnerUrls(r,a,o,s,L.path,Wr.AVATAR));var O=M.clipPaths;if(O)for(l=0,u=O.length;l<u;l++)O[l]=Wr._addHierarchyInnerUrls(r,a,o,s,O[l],Wr.ANIMATIONCLIP);else{var N=M.layers;for(l=0;l<N.length;l++)for(var P=N[l].states,b=0,w=P.length;b<w;b++){var k=P[b].clipPath;k&&(P[b].clipPath=Wr._addHierarchyInnerUrls(r,a,o,s,k,Wr.ANIMATIONCLIP))}}break;case"PhysicsCollider":case"Rigidbody3D":case"CharacterController":var V=M.shapes;for(l=0;l<V.length;l++){var B=V[l];"MeshColliderShape"===B.type&&(S=B.mesh)&&(B.mesh=Wr._addHierarchyInnerUrls(t,a,o,s,S,Wr.MESH))}}}var F=e.child;for(l=0,u=F.length;l<u;l++)Wr._getSprite3DHierarchyInnerUrls(F[l],t,n,i,r,a,o,s)}},{key:"_loadHierarchy",value:function(e){e._originType=e.type,e.on(t.Event.LOADED,null,Wr._onHierarchylhLoaded,[e]),e.load(e.url,t.Loader.JSON,!1,null,!0)}},{key:"_onHierarchylhLoaded",value:function(e,n){var i=e.url,r=gt.getURLVerion(i),a=t.URL.getPath(i),o=[],s=[],l=[],u=[],_=[];Wr._getSprite3DHierarchyInnerUrls(n.data,o,s,l,u,_,r,a);var c=o.length+s.length+u.length,h=c+1,d=1/h;if(Wr._onProcessChange(e,0,d,1),u.length>0){var f=c/h,m=t.Handler.create(null,Wr._onProcessChange,[e,d,f],!1);Wr._innerFourthLevelLoaderManager._create(u,!1,t.Handler.create(null,Wr._onHierarchyInnerForthLevResouLoaded,[e,m,n,_,o,s,l,d+f*u.length,f]),m,null,null,null,1,!0)}else Wr._onHierarchyInnerForthLevResouLoaded(e,null,n,_,o,s,l,d,f)}},{key:"_onHierarchyInnerForthLevResouLoaded",value:function(e,n,i,r,a,o,s,l,u){if(n&&n.recover(),s.length>0){var _=t.Handler.create(null,Wr._onProcessChange,[e,l,u],!1);Wr._innerThirdLevelLoaderManager._create(s,!1,t.Handler.create(null,Wr._onHierarchyInnerThirdLevResouLoaded,[e,_,i,r,a,o,l+u*o.length,u]),n,null,null,null,1,!0)}else Wr._onHierarchyInnerThirdLevResouLoaded(e,null,i,r,a,o,l,u)}},{key:"_onHierarchyInnerThirdLevResouLoaded",value:function(e,n,i,r,a,o,s,l){if(n&&n.recover(),o.length>0){var u=t.Handler.create(null,Wr._onProcessChange,[e,s,l],!1);Wr._innerSecondLevelLoaderManager._create(o,!1,t.Handler.create(null,Wr._onHierarchyInnerSecondLevResouLoaded,[e,u,i,r,a,s+l*o.length,l]),n,null,null,null,1,!0)}else Wr._onHierarchyInnerSecondLevResouLoaded(e,null,i,r,a,s,l)}},{key:"_onHierarchyInnerSecondLevResouLoaded",value:function(e,n,i,r,a,o,s){if(n&&n.recover(),a.length>0){var l=t.Handler.create(null,Wr._onProcessChange,[e,o,s],!1);Wr._innerFirstLevelLoaderManager._create(a,!1,t.Handler.create(null,Wr._onHierarchyInnerFirstLevResouLoaded,[e,l,i,r]),n,null,null,null,1,!0)}else Wr._onHierarchyInnerFirstLevResouLoaded(e,null,i,r)}},{key:"_onHierarchyInnerFirstLevResouLoaded",value:function(e,t,n,i){t&&t.recover(),e._cache=e._createCache;var r="Scene3D"===n.data.type?hs._parseScene(n,e._propertyParams,e._constructParams):hs._parse(n,e._propertyParams,e._constructParams);Wr._endLoad(e,r,i)}},{key:"_loadMesh",value:function(e){e.on(t.Event.LOADED,null,Wr._onMeshLmLoaded,[e]),e.load(e.url,t.Loader.BUFFER,!1,null,!0)}},{key:"_onMeshLmLoaded",value:function(e,t){e._cache=e._createCache;var n=ps._parse(t,e._propertyParams,e._constructParams);Wr._endLoad(e,n)}},{key:"_loadMaterial",value:function(e){e.on(t.Event.LOADED,null,Wr._onMaterilLmatLoaded,[e]),e.load(e.url,t.Loader.JSON,!1,null,!0)}},{key:"_onMaterilLmatLoaded",value:function(e,n){var i,r=e.url,a=gt.getURLVerion(r),o=t.URL.getPath(r),s=[],l=[];switch(n.customProps,n.version){case"LAYAMATERIAL:01":case"LAYAMATERIAL:02":var u,_,c=n.props.textures;if(c)for(u=0,_=c.length;u<_;u++){var h=c[u],d=h.path;d&&(i=Wr.formatRelativePath(o,d),a&&(i+=a),s.push({url:i,constructParams:h.constructParams,propertyParams:h.propertyParams}),l.push(i),h.path=i)}break;default:throw new Error("Laya3D:unkonwn version.")}var f=s.length,m=f+1,p=1/m;if(Wr._onProcessChange(e,0,p,1),f>0){var v=t.Handler.create(null,Wr._onProcessChange,[e,p,f/m],!1);Wr._innerFourthLevelLoaderManager._create(s,!1,t.Handler.create(null,Wr._onMateialTexturesLoaded,[e,v,n,l]),v,null,null,null,1,!0)}else Wr._onMateialTexturesLoaded(e,null,n,null)}},{key:"_onMateialTexturesLoaded",value:function(e,t,n,i){e._cache=e._createCache;var r=Gi._parse(n,e._propertyParams,e._constructParams);Wr._endLoad(e,r,i),t&&t.recover()}},{key:"_loadAvatar",value:function(e){e.on(t.Event.LOADED,null,function(t){e._cache=e._createCache;var n=Ui._parse(t,e._propertyParams,e._constructParams);Wr._endLoad(e,n)}),e.load(e.url,t.Loader.JSON,!1,null,!0)}},{key:"_loadSimpleAnimator",value:function(e){e.on(t.Event.LOADED,null,function(n){e._cache=e._createCache;var i=t.Texture2D._SimpleAnimatorTextureParse(n,e._propertyParams,e._constructParams);Wr._endLoad(e,i)}),e.load(e.url,t.Loader.BUFFER,!1,null,!0)}},{key:"_loadAnimationClip",value:function(e){e.on(t.Event.LOADED,null,function(t){e._cache=e._createCache;var n=sn._parse(t);Wr._endLoad(e,n)}),e.load(e.url,t.Loader.BUFFER,!1,null,!0)}},{key:"_loadTexture2D",value:function(e){var n,i=e.url,r=i.lastIndexOf(".")+1,a=i.indexOf("?"),o=-1==a?i.length:a;switch(i.substr(r,o-r)){case"jpg":case"jpeg":case"bmp":case"gif":case"png":n="nativeimage";break;case"dds":case"ktx":case"pvr":n=t.Loader.BUFFER}e.on(t.Event.LOADED,null,function(n){e._cache=e._createCache;var i=t.Texture2D._parse(n,e._propertyParams,e._constructParams);Wr._endLoad(e,i)}),e.load(e.url,n,!1,null,!0)}},{key:"_loadTextureCube",value:function(e){e.on(t.Event.LOADED,null,Wr._onTextureCubeLtcLoaded,[e]),e.load(e.url,t.Loader.JSON,!1,null,!0)}},{key:"_loadTextureCubeBin",value:function(e){e.on(t.Event.LOADED,null,function(n){e._cache=e._createCache;var i=new t.Byte(n);if("LAYATEXTURECUBE:0000"!==i.readUTFString())throw"Laya3D:unknow version.";var r=i.readUint8(),a=i.getUint8(),o=i.readUint16(),s=i.getUint8(),l=i.getUint8(),u=i.getUint8(),_=i.getUint8(),c=new ha(o,r,a>1);c.filterMode=s,c.wrapModeU=l,c.wrapModeV=u,c.anisoLevel=_;for(var h=i.pos,d=o,f=0;f<a;f++){for(var m=new Array(6),p=d*d*c._getFormatByteCount(),v=0;v<6;v++)m[v]=new Uint8Array(n,h,p),h+=p;c.setSixSidePixels(m,f),d/=2}Wr._endLoad(e,c)}),e.load(e.url,t.Loader.BUFFER,!1,null,!0)}},{key:"_onTextureCubeLtcLoaded",value:function(e,n){var i=t.URL.getPath(e.url),r=[Wr.formatRelativePath(i,n.front),Wr.formatRelativePath(i,n.back),Wr.formatRelativePath(i,n.left),Wr.formatRelativePath(i,n.right),Wr.formatRelativePath(i,n.up),Wr.formatRelativePath(i,n.down)];Wr._onProcessChange(e,0,1/7,1);var a=t.Handler.create(null,Wr._onProcessChange,[e,1/7,6/7],!1);Wr._innerFourthLevelLoaderManager.load(r,t.Handler.create(null,Wr._onTextureCubeImagesLoaded,[e,r,a]),a,"nativeimage")}},{key:"_onTextureCubeImagesLoaded",value:function(e,n,i){for(var r=new Array(6),a=0;a<6;a++)r[a]=t.Loader.getRes(n[a]);e._cache=e._createCache;var o=ha._parse(r,e._propertyParams,e._constructParams);for(i.recover(),a=0;a<6;a++)t.Loader.clearRes(n[a]);Wr._endLoad(e,o)}},{key:"_onProcessChange",value:function(e,n,i,r){(r=n+r*i)<1&&e.event(t.Event.PROGRESS,2*r/3+1/3)}},{key:"init",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;if(Wr._isInit)i&&i.run();else{Wr._isInit=!0,n&&n.cloneTo(It._config),n=It._config,ra.debugFrustumCulling=n.debugFrustumCulling,Wr._editerEnvironment=n._editerEnvironment,Wa.octreeCulling=n.octreeCulling,Wa.octreeInitialSize=n.octreeInitialSize,Wa.octreeInitialCenter=n.octreeInitialCenter,Wa.octreeMinNodeSize=n.octreeMinNodeSize,Wa.octreeLooseness=n.octreeLooseness;var r=window.Physics3D;null==r||n.isUseCannonPhysicsEngine?(Ct._enablePhysics=!1,Wr.__init__(e,t,n),i&&i.run()):(Ct._enablePhysics=!0,r(16*n.defaultPhysicsMemory,$o._interactive).then(function(){Wr.__init__(e,t,n),i&&i.run()}))}}},{key:"enablePhysics",get:function(){return Ct._enablePhysics}}]),Wr}();ys.HIERARCHY="HIERARCHY",ys.MESH="MESH",ys.MATERIAL="MATERIAL",ys.TEXTURE2D="TEXTURE2D",ys.TEXTURECUBE="TEXTURECUBE",ys.TEXTURECUBEBIN="TEXTURECUBEBIN",ys.ANIMATIONCLIP="ANIMATIONCLIP",ys.AVATAR="AVATAR",ys.TERRAINHEIGHTDATA="TERRAINHEIGHTDATA",ys.TERRAINRES="TERRAIN",ys.SIMPLEANIMATORBIN="SIMPLEANIMATOR",ys._innerFirstLevelLoaderManager=new t.LoaderManager,ys._innerSecondLevelLoaderManager=new t.LoaderManager,ys._innerThirdLevelLoaderManager=new t.LoaderManager,ys._innerFourthLevelLoaderManager=new t.LoaderManager,ys._isInit=!1,ys._editerEnvironment=!1,ys.physicsSettings=new ua,window.Laya3D=ys;var Ss=function(e){function Xr(){var e;return _classCallCheck(this,Xr),(e=_possibleConstructorReturn(this,_getPrototypeOf(Xr).apply(this,arguments)))._indexInPool=-1,e}return _inherits(Xr,t.Component),_createClass(Xr,[{key:"_checkProcessTriggers",value:function(){var e=Xr.prototype;return this.onTriggerEnter!==e.onTriggerEnter||this.onTriggerStay!==e.onTriggerStay||this.onTriggerExit!==e.onTriggerExit}},{key:"_checkProcessCollisions",value:function(){var e=Xr.prototype;return this.onCollisionEnter!==e.onCollisionEnter||this.onCollisionStay!==e.onCollisionStay||this.onCollisionExit!==e.onCollisionExit}},{key:"_onAwake",value:function(){this.onAwake(),this.onStart!==Xr.prototype.onStart&&t.Laya.startTimer.callLater(this,this.onStart)}},{key:"_onEnable",value:function(){this.owner._scene._addScript(this),this.onEnable()}},{key:"_onDisable",value:function(){this.owner._scene._removeScript(this),this.owner.offAllCaller(this),this.onDisable()}},{key:"_onDestroy",value:function(){var e=this.owner._scripts;e.splice(e.indexOf(this),1);var t=this.owner;t._needProcessTriggers=!1;for(var n=0,i=e.length;n<i;n++)if(e[n]._checkProcessTriggers()){t._needProcessTriggers=!0;break}for(t._needProcessCollisions=!1,n=0,i=e.length;n<i;n++)if(e[n]._checkProcessCollisions()){t._needProcessCollisions=!0;break}this.onDestroy()}},{key:"_isScript",value:function(){return!0}},{key:"_onAdded",value:function(){var e=this.owner,t=e._scripts;t||(e._scripts=t=[]),t.push(this),e._needProcessCollisions||(e._needProcessCollisions=this._checkProcessCollisions()),e._needProcessTriggers||(e._needProcessTriggers=this._checkProcessTriggers())}},{key:"onAwake",value:function(){}},{key:"onEnable",value:function(){}},{key:"onStart",value:function(){}},{key:"onTriggerEnter",value:function(e){}},{key:"onTriggerStay",value:function(e){}},{key:"onTriggerExit",value:function(e){}},{key:"onCollisionEnter",value:function(e){}},{key:"onCollisionStay",value:function(e){}},{key:"onCollisionExit",value:function(e){}},{key:"onJointBreak",value:function(){}},{key:"onMouseDown",value:function(){}},{key:"onMouseDrag",value:function(){}},{key:"onMouseClick",value:function(){}},{key:"onMouseUp",value:function(){}},{key:"onMouseEnter",value:function(){}},{key:"onMouseOver",value:function(){}},{key:"onMouseOut",value:function(){}},{key:"onUpdate",value:function(){}},{key:"onLateUpdate",value:function(){}},{key:"onPreRender",value:function(){}},{key:"onPostRender",value:function(){}},{key:"onDisable",value:function(){}},{key:"onDestroy",value:function(){}},{key:"isSingleton",get:function(){return!1}}]),Xr}(),Rs=function(){function Yr(e,t,n,i){_classCallCheck(this,Yr),this._datas=[],this._w=e,this._h=t,this._minHeight=n,this._maxHeight=i}return _createClass(Yr,[{key:"_inBounds",value:function(e,t){return e>=0&&e<this._h&&t>=0&&t<this._w}},{key:"getHeight",value:function(e,t){return this._inBounds(e,t)?this._datas[e][t]:NaN}},{key:"width",get:function(){return this._w}},{key:"height",get:function(){return this._h}},{key:"maxHeight",get:function(){return this._maxHeight}},{key:"minHeight",get:function(){return this._minHeight}}],[{key:"creatFromMesh",value:function(e,t,n,i){for(var r=[],a=[],o=e.subMeshCount,s=0;s<o;s++){for(var l=e.getSubMesh(s),u=l._vertexBuffer,_=u.getFloat32Data(),c=[],h=0;h<_.length;h+=u.vertexDeclaration.vertexStride/4){var d=new D(_[h+0],_[h+1],_[h+2]);c.push(d)}r.push(c);var f=l._indexBuffer;a.push(f.getData())}var m=e.bounds,p=m.getMin().x,v=m.getMin().z,E=m.getMax().x,T=m.getMax().z,g=m.getMin().y,y=m.getMax().y,S=E-p,R=T-v,C=i.x=S/(t-1),A=i.y=R/(n-1),I=new Yr(t,n,g,y),x=Yr._tempRay,M=x.direction;M.x=0,M.y=-1,M.z=0;var L=y+.1;x.origin.y=L;for(var O=0;O<n;O++){var N=v+O*A;I._datas[O]=[];for(var P=0;P<t;P++){var b=p+P*C,w=x.origin;w.x=b,w.z=N;var k=Yr._getPosition(x,r,a);I._datas[O][P]=k===Number.MAX_VALUE?NaN:L-k}}return I}},{key:"createFromImage",value:function(e,t,n){for(var i=e.width,r=e.height,a=new Yr(i,r,t,n),o=(n-t)/254,s=e.getPixels(),l=0,u=0;u<r;u++)for(var _=a._datas[u]=[],c=0;c<i;c++){var h=s[l++],d=s[l++],f=s[l++],m=s[l++];_[c]=255==h&&255==d&&255==f&&255==m?NaN:(h+d+f)/3*o+t}return a}},{key:"_getPosition",value:function(e,t,n){for(var i=Number.MAX_VALUE,r=0;r<t.length;r++)for(var a=t[r],o=n[r],s=0;s<o.length;s+=3){var l=a[o[s+0]],u=a[o[s+1]],_=a[o[s+2]],c=zn.rayIntersectsTriangle(e,l,u,_);!isNaN(c)&&c<i&&(i=c)}return i}}]),Yr}();Rs._tempRay=new Bn(new D,new D);var Cs=function(e){function jr(e,t){var n,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;return _classCallCheck(this,jr),(n=_possibleConstructorReturn(this,_getPrototypeOf(jr).call(this,e,i)))._heightMap=t,n._cellSize=new r,n}return _inherits(jr,oo),_createClass(jr,[{key:"_disableRotation",value:function(){var e=this.transform.rotation;e.x=0,e.y=0,e.z=0,e.w=1,this.transform.rotation=e}},{key:"_getScaleX",value:function(){var e=this.transform.worldMatrix.elements,t=e[0],n=e[1],i=e[2];return Math.sqrt(t*t+n*n+i*i)}},{key:"_getScaleZ",value:function(){var e=this.transform.worldMatrix.elements,t=e[8],n=e[9],i=e[10];return Math.sqrt(t*t+n*n+i*i)}},{key:"_initCreateFromMesh",value:function(e,t){this._heightMap=Rs.creatFromMesh(this.meshFilter.sharedMesh,e,t,this._cellSize);var n=this.meshFilter.sharedMesh.bounds.getMin();this._minX=n.x,this._minZ=n.z}},{key:"_initCreateFromMeshHeightMap",value:function(e,t,n){var i=this.meshFilter.sharedMesh.bounds;this._heightMap=Rs.createFromImage(e,t,n),this._computeCellSize(i);var r=i.getMin();this._minX=r.x,this._minZ=r.z}},{key:"_computeCellSize",value:function(e){var t=e.getMin(),n=e.getMax(),i=t.x,r=t.z,a=n.x-i,o=n.z-r;this._cellSize.x=a/(this._heightMap.width-1),this._cellSize.y=o/(this._heightMap.height-1)}},{key:"_update",value:function(e){this._disableRotation()}},{key:"getHeight",value:function(e,t){jr._tempVector3.x=e,jr._tempVector3.y=0,jr._tempVector3.z=t,this._disableRotation();var n=this.transform.worldMatrix;n.invert(jr._tempMatrix4x4),D.transformCoordinate(jr._tempVector3,jr._tempMatrix4x4,jr._tempVector3),e=jr._tempVector3.x,t=jr._tempVector3.z;var i=(e-this._minX)/this._cellSize.x,r=(t-this._minZ)/this._cellSize.y,a=Math.floor(r),o=Math.floor(i),s=i-o,l=r-a,u=n.elements,_=u[4],c=u[5],h=u[6],d=Math.sqrt(_*_+c*c+h*h),f=u[13],m=this._heightMap.getHeight(a,o+1),p=this._heightMap.getHeight(a+1,o);if(isNaN(m)||isNaN(p))return NaN;if(s+l<=1){var v=this._heightMap.getHeight(a,o);return isNaN(v)?NaN:(v+s*(m-v)+l*(p-v))*d+f}var E=this._heightMap.getHeight(a+1,o+1);return isNaN(E)?NaN:(E+(1-s)*(p-E)+(1-l)*(m-E))*d+f}},{key:"minX",get:function(){var e=this.transform.worldMatrix.elements;return this._minX*this._getScaleX()+e[12]}},{key:"minZ",get:function(){var e=this.transform.worldMatrix.elements;return this._minZ*this._getScaleZ()+e[14]}},{key:"width",get:function(){return(this._heightMap.width-1)*this._cellSize.x*this._getScaleX()}},{key:"depth",get:function(){return(this._heightMap.height-1)*this._cellSize.y*this._getScaleZ()}}],[{key:"createFromMesh",value:function(e,t,n){var i=new jr(e,null,arguments.length>3&&void 0!==arguments[3]?arguments[3]:null);return i._initCreateFromMesh(t,n),i}},{key:"createFromMeshAndHeightMap",value:function(e,t,n,i){var r=new jr(e,null,arguments.length>4&&void 0!==arguments[4]?arguments[4]:null);return r._initCreateFromMeshHeightMap(t,n,i),r}}]),jr}();Cs._tempVector3=new D,Cs._tempMatrix4x4=new q;var As=function(){function Zr(){_classCallCheck(this,Zr),this._currentLength=0,this._elements=new Float32Array(12)}return _createClass(Zr,[{key:"add",value:function(e,t){this._currentLength<8?(6===this._currentLength&&1!==e&&(e=1,console.log("GradientDataVector2 warning:the forth key is  be force set to 1.")),this._elements[this._currentLength++]=e,this._elements[this._currentLength++]=t.x,this._elements[this._currentLength++]=t.y):console.log("GradientDataVector2 warning:data count must lessEqual than 4")}},{key:"cloneTo",value:function(e){var t=e;t._currentLength=this._currentLength;for(var n=t._elements,i=0,r=this._elements.length;i<r;i++)n[i]=this._elements[i]}},{key:"clone",value:function(){var e=new Zr;return this.cloneTo(e),e}},{key:"gradientCount",get:function(){return this._currentLength/3}}]),Zr}(),Is=function(){function qr(){_classCallCheck(this,qr)}return _createClass(qr,[{key:"render",value:function(e){}}]),qr}(),xs=function(e){function Qr(){var e;return _classCallCheck(this,Qr),(e=_possibleConstructorReturn(this,_getPrototypeOf(Qr).call(this)))._shader=null,e._shaderData=new En,e._linearColor=new ta,e._bloomTextureTexelSize=new o,e._shaderThreshold=new o,e._shaderParams=new o,e._pyramid=null,e._intensity=0,e._threshold=1,e._softKnee=.5,e._diffusion=7,e._anamorphicRatio=0,e._dirtIntensity=0,e._shaderSetting=new o,e._dirtTileOffset=new o,e.clamp=65472,e.color=new ta(1,1,1,1),e.fastMode=!1,e.dirtTexture=null,e._shader=xn.find("PostProcessBloom"),e._pyramid=new Array(2*Qr.MAXPYRAMIDSIZE),e}return _inherits(Qr,Is),_createClass(Qr,[{key:"render",value:function(e){var n=e.command,i=e.camera.viewport;this._shaderData.setTexture(Qr.SHADERVALUE_AUTOEXPOSURETEX,t.Texture2D.whiteTexture);var r,a=this._anamorphicRatio,s=a<0?-a:0,l=a>0?a:0,u=Math.floor(i.width/(2-s)),_=Math.floor(i.height/(2-l)),c=Math.max(u,_);r=Math.log2(c)+this._diffusion-10;var h=Math.floor(r),d=Math.min(Math.max(h,1),Qr.MAXPYRAMIDSIZE),f=.5+r-h;this._shaderData.setNumber(Qr.SHADERVALUE_SAMPLESCALE,f);var m=ta.gammaToLinearSpace(this.threshold),p=m*this._softKnee+1e-5;this._shaderThreshold.setValue(m,m-p,2*p,.25/p),this._shaderData.setVector(Qr.SHADERVALUE_THRESHOLD,this._shaderThreshold);var v=ta.gammaToLinearSpace(this.clamp);this._shaderParams.setValue(v,0,0,0),this._shaderData.setVector(Qr.SHADERVALUE_PARAMS,this._shaderParams);for(var E=this.fastMode?1:0,T=e.source,g=0;g<d;g++){var y=2*g,S=y+1,R=0==g?Qr.SUBSHADER_PREFILTER13+E:Qr.SUBSHADER_DOWNSAMPLE13+E,C=fn.createFromPool(u,_,t.RenderTextureFormat.R8G8B8,t.RenderTextureDepthFormat.DEPTHSTENCIL_NONE);if(C.filterMode=t.FilterMode.Bilinear,this._pyramid[y]=C,g!==d-1){var A=fn.createFromPool(u,_,t.RenderTextureFormat.R8G8B8,t.RenderTextureDepthFormat.DEPTHSTENCIL_NONE);A.filterMode=t.FilterMode.Bilinear,this._pyramid[S]=A}n.blitScreenTriangle(T,C,null,this._shader,this._shaderData,R),T=C,u=Math.max(Math.floor(u/2),1),_=Math.max(Math.floor(_/2),1)}var I=this._pyramid[2*(d-1)];for(g=d-2;g>=0;g--)S=1+(y=2*g),C=this._pyramid[y],A=this._pyramid[S],n.setShaderDataTexture(this._shaderData,Qr.SHADERVALUE_BLOOMTEX,C),n.blitScreenTriangle(I,A,null,this._shader,this._shaderData,Qr.SUBSHADER_UPSAMPLETENT+E),I=A;var x=this._linearColor;this.color.toLinear(x);var D=Math.pow(2,this._intensity/10)-1,M=this._shaderSetting;this._shaderSetting.setValue(f,D,this._dirtIntensity,d);var L=this.dirtTexture?this.dirtTexture:t.Texture2D.blackTexture,O=L.width/L.height,N=i.width/i.height,P=this._dirtTileOffset;O>N?P.setValue(N/O,1,.5*(1-P.x),0):O<N&&P.setValue(1,O/N,0,.5*(1-P.y));var b=e.compositeShaderData;for(this.fastMode?b.addDefine(Vi.SHADERDEFINE_BLOOM_LOW):b.addDefine(Vi.SHADERDEFINE_BLOOM),this._bloomTextureTexelSize.setValue(1/I.width,1/I.height,I.width,I.height),b.setVector(Vi.SHADERVALUE_BLOOM_DIRTTILEOFFSET,P),b.setVector(Vi.SHADERVALUE_BLOOM_SETTINGS,M),b.setVector(Vi.SHADERVALUE_BLOOM_COLOR,new o(x.r,x.g,x.b,x.a)),b.setTexture(Vi.SHADERVALUE_BLOOM_DIRTTEX,L),b.setTexture(Vi.SHADERVALUE_BLOOMTEX,I),b.setVector(Vi.SHADERVALUE_BLOOMTEX_TEXELSIZE,this._bloomTextureTexelSize),g=0;g<d;g++)S=1+(y=2*g),fn.recoverToPool(this._pyramid[y]),0!==g&&g!==d-1&&fn.recoverToPool(this._pyramid[S]);e.deferredReleaseTextures.push(I)}},{key:"intensity",get:function(){return this._intensity},set:function(e){this._intensity=Math.max(e,0)}},{key:"threshold",get:function(){return this._threshold},set:function(e){this._threshold=Math.max(e,0)}},{key:"softKnee",get:function(){return this._softKnee},set:function(e){this._softKnee=Math.min(Math.max(e,0),1)}},{key:"diffusion",get:function(){return this._diffusion},set:function(e){this._diffusion=Math.min(Math.max(e,1),10)}},{key:"anamorphicRatio",get:function(){return this._anamorphicRatio},set:function(e){this._anamorphicRatio=Math.min(Math.max(e,-1),1)}},{key:"dirtIntensity",get:function(){return this._dirtIntensity},set:function(e){this._dirtIntensity=Math.max(e,0)}}]),Qr}();xs.SHADERVALUE_MAINTEX=xn.propertyNameToID("u_MainTex"),xs.SHADERVALUE_AUTOEXPOSURETEX=xn.propertyNameToID("u_AutoExposureTex"),xs.SHADERVALUE_SAMPLESCALE=xn.propertyNameToID("u_SampleScale"),xs.SHADERVALUE_THRESHOLD=xn.propertyNameToID("u_Threshold"),xs.SHADERVALUE_PARAMS=xn.propertyNameToID("u_Params"),xs.SHADERVALUE_BLOOMTEX=xn.propertyNameToID("u_BloomTex"),xs.SUBSHADER_PREFILTER13=0,xs.SUBSHADER_PREFILTER4=1,xs.SUBSHADER_DOWNSAMPLE13=2,xs.SUBSHADER_DOWNSAMPLE4=3,xs.SUBSHADER_UPSAMPLETENT=4,xs.SUBSHADER_UPSAMPLEBOX=5,xs.MAXPYRAMIDSIZE=16;var Ds=function(){function Kr(){_classCallCheck(this,Kr),this._isNeedUpdate=!1}return _createClass(Kr,[{key:"createInstanceVertexBuffer3D",value:function(){var e=t.LayaGL.instance;this._instanceData=new Float32Array(Oi.maxInstanceCount*this._vertexStride),this._vertexBuffer=new pn(4*this._instanceData.length,e.DYNAMIC_DRAW),this._vertexBuffer.vertexDeclaration=this._vertexDeclaration}},{key:"updateVertexBufferData",value:function(e){if(this._isNeedUpdate){var t=this._instanceData,n=this._value,i=this._value.length,r=this._vertexStride,a=0;switch(this._value instanceof Float32Array||(a=1),a){case 0:t.set(n,0);break;case 1:for(var o=0;o<i;o++)n[o].toArray(t,o*r)}this._vertexBuffer.orphanStorage(),this._vertexBuffer.setData(t.buffer,0,0,4*e*(a?r:1))}}}]),Kr}();(ms=e.InstanceLocation||(e.InstanceLocation={}))[ms.CUSTOME0=12]="CUSTOME0",ms[ms.CUSTOME1=13]="CUSTOME1",ms[ms.CUSTOME2=14]="CUSTOME2",ms[ms.CUSTOME3=15]="CUSTOME3";var Ms=function(){function Jr(){_classCallCheck(this,Jr),this._type=0,this._propertyMap={}}return _createClass(Jr,[{key:"_checkPropertyLegal",value:function(e,t,n,i){if(i._vertexDeclaration._vertexElements[0]._elementFormat!==e)throw"Data exists and format does not match";if(i._name!==t)throw"You cannot add a new property to an existing attributeLocation,Please use another attributeLocation"}},{key:"_creatProperty",value:function(e,t,n,i,r){var a=this._propertyMap[r]=new Ds;a._name=e,a._value=t,a._vertexDeclaration=new Tn(n,[new gn(0,i,r)]),a._isNeedUpdate=!0,a._vertexStride=n/4,a.createInstanceVertexBuffer3D()}},{key:"setVectorArray",value:function(e,t,n){var i=this._propertyMap[n];i?(this._checkPropertyLegal(vn.Vector4,e,n,i),i._value=t,i._isNeedUpdate=!0):this._creatProperty(e,t,16,vn.Vector4,n)}},{key:"setVector3Array",value:function(e,t,n){var i=this._propertyMap[n];i?(this._checkPropertyLegal(vn.Vector3,e,n,i),i._value=t,i._isNeedUpdate=!0):this._creatProperty(e,t,12,vn.Vector3,n)}},{key:"setVector2Array",value:function(e,t,n){var i=this._propertyMap[n];i?(this._checkPropertyLegal(vn.Vector2,e,n,i),i._value=t,i._isNeedUpdate=!0):this._creatProperty(e,t,8,vn.Vector2,n)}},{key:"setNumberArray",value:function(e,t,n){var i=this._propertyMap[n];i?(this._checkPropertyLegal(vn.Single,e,n,i),i._value=t,i._isNeedUpdate=!0):this._creatProperty(e,t,4,vn.Single,n)}},{key:"getPropertyArray",value:function(e){var t=this._propertyMap[e];return t?t._value:null}},{key:"clear",value:function(){this._propertyMap={}}}]),Jr}();Ms.INSTANCETYPE_ATTRIBUTE=0,Ms.INSTANCETYPE_UNIFORMBUFFER=1;var Ls=function(){function $r(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;_classCallCheck(this,$r);var r=this.elements=new Float32Array(4);r[0]=e,r[1]=t,r[2]=n,r[3]=i}return _createClass($r,[{key:"fromArray",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;this.elements[0]=e[t+0],this.elements[1]=e[t+1],this.elements[2]=e[t+2],this.elements[3]=e[t+3]}},{key:"cloneTo",value:function(e){var t=e.elements,n=this.elements;t[0]=n[0],t[1]=n[1],t[2]=n[2],t[3]=n[3]}},{key:"clone",value:function(){var e=new $r;return this.cloneTo(e),e}},{key:"length",value:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}},{key:"lengthSquared",value:function(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}},{key:"x",get:function(){return this.elements[0]},set:function(e){this.elements[0]=e}},{key:"y",get:function(){return this.elements[1]},set:function(e){this.elements[1]=e}},{key:"z",get:function(){return this.elements[2]},set:function(e){this.elements[2]=e}},{key:"w",get:function(){return this.elements[3]},set:function(e){this.elements[3]=e}}],[{key:"lerp",value:function(e,t,n,i){var r=i.elements,a=e.elements,o=t.elements,s=a[0],l=a[1],u=a[2],_=a[3];r[0]=s+n*(o[0]-s),r[1]=l+n*(o[1]-l),r[2]=u+n*(o[2]-u),r[3]=_+n*(o[3]-_)}},{key:"transformByM4x4",value:function(e,t,n){var i=e.elements,r=i[0],a=i[1],o=i[2],s=i[3],l=t.elements,u=n.elements;u[0]=r*l[0]+a*l[4]+o*l[8]+s*l[12],u[1]=r*l[1]+a*l[5]+o*l[9]+s*l[13],u[2]=r*l[2]+a*l[6]+o*l[10]+s*l[14],u[3]=r*l[3]+a*l[7]+o*l[11]+s*l[15]}},{key:"equals",value:function(e,t){var n=e.elements,r=t.elements;return i.nearEqual(Math.abs(n[0]),Math.abs(r[0]))&&i.nearEqual(Math.abs(n[1]),Math.abs(r[1]))&&i.nearEqual(Math.abs(n[2]),Math.abs(r[2]))&&i.nearEqual(Math.abs(n[3]),Math.abs(r[3]))}},{key:"normalize",value:function(e,t){var n=e.elements,i=t.elements,r=e.length();r>0&&(i[0]=n[0]*r,i[1]=n[1]*r,i[2]=n[2]*r,i[3]=n[3]*r)}},{key:"add",value:function(e,t,n){var i=n.elements,r=e.elements,a=t.elements;i[0]=r[0]+a[0],i[1]=r[1]+a[1],i[2]=r[2]+a[2],i[3]=r[3]+a[3]}},{key:"subtract",value:function(e,t,n){var i=n.elements,r=e.elements,a=t.elements;i[0]=r[0]-a[0],i[1]=r[1]-a[1],i[2]=r[2]-a[2],i[3]=r[3]-a[3]}},{key:"multiply",value:function(e,t,n){var i=n.elements,r=e.elements,a=t.elements;i[0]=r[0]*a[0],i[1]=r[1]*a[1],i[2]=r[2]*a[2],i[3]=r[3]*a[3]}},{key:"scale",value:function(e,t,n){var i=n.elements,r=e.elements;i[0]=r[0]*t,i[1]=r[1]*t,i[2]=r[2]*t,i[3]=r[3]*t}},{key:"Clamp",value:function(e,t,n,i){var r=e.elements,a=r[0],o=r[1],s=r[2],l=r[3],u=t.elements,_=u[0],c=u[1],h=u[2],d=u[3],f=n.elements,m=f[0],p=f[1],v=f[2],E=f[3],T=i.elements;a=(a=a>m?m:a)<_?_:a,o=(o=o>p?p:o)<c?c:o,s=(s=s>v?v:s)<h?h:s,l=(l=l>E?E:l)<d?d:l,T[0]=a,T[1]=o,T[2]=s,T[3]=l}},{key:"distanceSquared",value:function(e,t){var n=e.elements,i=t.elements,r=n[0]-i[0],a=n[1]-i[1],o=n[2]-i[2],s=n[3]-i[3];return r*r+a*a+o*o+s*s}},{key:"distance",value:function(e,t){var n=e.elements,i=t.elements,r=n[0]-i[0],a=n[1]-i[1],o=n[2]-i[2],s=n[3]-i[3];return Math.sqrt(r*r+a*a+o*o+s*s)}},{key:"dot",value:function(e,t){var n=e.elements,i=t.elements;return n[0]*i[0]+n[1]*i[1]+n[2]*i[2]+n[3]*i[3]}},{key:"min",value:function(e,t,n){var i=n.elements,r=e.elements,a=t.elements;i[0]=Math.min(r[0],a[0]),i[1]=Math.min(r[1],a[1]),i[2]=Math.min(r[2],a[2]),i[3]=Math.min(r[3],a[3])}},{key:"max",value:function(e,t,n){var i=n.elements,r=e.elements,a=t.elements;i[0]=Math.max(r[0],a[0]),i[1]=Math.max(r[1],a[1]),i[2]=Math.max(r[2],a[2]),i[3]=Math.max(r[3],a[3])}}]),$r}();Ls.ZERO=new Ls,Ls.ONE=new Ls(1,1,1,1),Ls.UnitX=new Ls(1,0,0,0),Ls.UnitY=new Ls(0,1,0,0),Ls.UnitZ=new Ls(0,0,1,0),Ls.UnitW=new Ls(0,0,0,1);var Os=function(){function en(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;_classCallCheck(this,en),e=r||new Float32Array(3),this.elements=e,e[0]=t,e[1]=n,e[2]=i}return _createClass(en,[{key:"setValue",value:function(e,t,n){this.elements[0]=e,this.elements[1]=t,this.elements[2]=n}},{key:"fromArray",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;this.elements[0]=e[t+0],this.elements[1]=e[t+1],this.elements[2]=e[t+2]}},{key:"cloneTo",value:function(e){var t=e.elements,n=this.elements;t[0]=n[0],t[1]=n[1],t[2]=n[2]}},{key:"clone",value:function(){var e=new en;return this.cloneTo(e),e}},{key:"toDefault",value:function(){this.elements[0]=0,this.elements[1]=0,this.elements[2]=0}},{key:"x",get:function(){return this.elements[0]},set:function(e){this.elements[0]=e}},{key:"y",get:function(){return this.elements[1]},set:function(e){this.elements[1]=e}},{key:"z",get:function(){return this.elements[2]},set:function(e){this.elements[2]=e}}],[{key:"distanceSquared",value:function(e,t){var n=e.elements,i=t.elements,r=n[0]-i[0],a=n[1]-i[1],o=n[2]-i[2];return r*r+a*a+o*o}},{key:"distance",value:function(e,t){var n=e.elements,i=t.elements,r=n[0]-i[0],a=n[1]-i[1],o=n[2]-i[2];return Math.sqrt(r*r+a*a+o*o)}},{key:"min",value:function(e,t,n){var i=n.elements,r=e.elements,a=t.elements;i[0]=Math.min(r[0],a[0]),i[1]=Math.min(r[1],a[1]),i[2]=Math.min(r[2],a[2])}},{key:"max",value:function(e,t,n){var i=n.elements,r=e.elements,a=t.elements;i[0]=Math.max(r[0],a[0]),i[1]=Math.max(r[1],a[1]),i[2]=Math.max(r[2],a[2])}},{key:"transformQuat",value:function(e,t,n){var i=n.elements,r=e.elements,a=t.elements,o=r[0],s=r[1],l=r[2],u=a[0],_=a[1],c=a[2],h=a[3],d=h*o+_*l-c*s,f=h*s+c*o-u*l,m=h*l+u*s-_*o,p=-u*o-_*s-c*l;i[0]=d*h+p*-u+f*-c-m*-_,i[1]=f*h+p*-_+m*-u-d*-c,i[2]=m*h+p*-c+d*-_-f*-u}},{key:"scalarLength",value:function(e){var t=e.elements,n=t[0],i=t[1],r=t[2];return Math.sqrt(n*n+i*i+r*r)}},{key:"scalarLengthSquared",value:function(e){var t=e.elements,n=t[0],i=t[1],r=t[2];return n*n+i*i+r*r}},{key:"normalize",value:function(e,t){var n=e.elements,i=t.elements,r=n[0],a=n[1],o=n[2],s=r*r+a*a+o*o;s>0&&(s=1/Math.sqrt(s),i[0]=n[0]*s,i[1]=n[1]*s,i[2]=n[2]*s)}},{key:"multiply",value:function(e,t,n){var i=n.elements,r=e.elements,a=t.elements;i[0]=r[0]*a[0],i[1]=r[1]*a[1],i[2]=r[2]*a[2]}},{key:"scale",value:function(e,t,n){var i=n.elements,r=e.elements;i[0]=r[0]*t,i[1]=r[1]*t,i[2]=r[2]*t}},{key:"lerp",value:function(e,t,n,i){var r=i.elements,a=e.elements,o=t.elements,s=a[0],l=a[1],u=a[2];r[0]=s+n*(o[0]-s),r[1]=l+n*(o[1]-l),r[2]=u+n*(o[2]-u)}},{key:"transformV3ToV3",value:function(e,t,n){var i=en._tempVector4;en.transformV3ToV4(e,t,i);var r=i.elements,a=n.elements;a[0]=r[0],a[1]=r[1],a[2]=r[2]}},{key:"transformV3ToV4",value:function(e,t,n){var i=e.elements,r=i[0],a=i[1],o=i[2],s=t.elements,l=n.elements;l[0]=r*s[0]+a*s[4]+o*s[8]+s[12],l[1]=r*s[1]+a*s[5]+o*s[9]+s[13],l[2]=r*s[2]+a*s[6]+o*s[10]+s[14],l[3]=r*s[3]+a*s[7]+o*s[11]+s[15]}},{key:"TransformNormal",value:function(e,t,n){var i=e.elements,r=i[0],a=i[1],o=i[2],s=t.elements,l=n.elements;l[0]=r*s[0]+a*s[4]+o*s[8],l[1]=r*s[1]+a*s[5]+o*s[9],l[2]=r*s[2]+a*s[6]+o*s[10]}},{key:"transformCoordinate",value:function(e,t,n){var i=e.elements,r=i[0],a=i[1],o=i[2],s=t.elements,l=r*s[3]+a*s[7]+o*s[11]+s[15],u=n.elements;u[0]=r*s[0]+a*s[4]+o*s[8]+s[12]/l,u[1]=r*s[1]+a*s[5]+o*s[9]+s[13]/l,u[2]=r*s[2]+a*s[6]+o*s[10]+s[14]/l}},{key:"Clamp",value:function(e,t,n,i){var r=e.elements,a=r[0],o=r[1],s=r[2],l=t.elements,u=l[0],_=l[1],c=l[2],h=n.elements,d=h[0],f=h[1],m=h[2],p=i.elements;a=(a=a>d?d:a)<u?u:a,o=(o=o>f?f:o)<_?_:o,s=(s=s>m?m:s)<c?c:s,p[0]=a,p[1]=o,p[2]=s}},{key:"add",value:function(e,t,n){var i=n.elements,r=e.elements,a=t.elements;i[0]=r[0]+a[0],i[1]=r[1]+a[1],i[2]=r[2]+a[2]}},{key:"subtract",value:function(e,t,n){var i=n.elements,r=e.elements,a=t.elements;i[0]=r[0]-a[0],i[1]=r[1]-a[1],i[2]=r[2]-a[2]}},{key:"cross",value:function(e,t,n){var i=e.elements,r=t.elements,a=n.elements,o=i[0],s=i[1],l=i[2],u=r[0],_=r[1],c=r[2];a[0]=s*c-l*_,a[1]=l*u-o*c,a[2]=o*_-s*u}},{key:"dot",value:function(e,t){var n=e.elements,i=t.elements;return n[0]*i[0]+n[1]*i[1]+n[2]*i[2]}},{key:"equals",value:function(e,t){var n=e.elements,r=t.elements;return i.nearEqual(n[0],r[0])&&i.nearEqual(n[1],r[1])&&i.nearEqual(n[2],r[2])}}]),en}();Os._tempVector4=new Ls,Os.ZERO=new Os(0,0,0),Os.ONE=new Os(1,1,1),Os.NegativeUnitX=new Os(-1,0,0),Os.UnitX=new Os(1,0,0),Os.UnitY=new Os(0,1,0),Os.UnitZ=new Os(0,0,1),Os.ForwardRH=new Os(0,0,-1),Os.ForwardLH=new Os(0,0,1),Os.Up=new Os(0,1,0),Os.NAN=new Os(NaN,NaN,NaN);var Ns=function(){function tn(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;_classCallCheck(this,tn),(e=a||new Float32Array(4))[0]=t,e[1]=n,e[2]=i,e[3]=r,this.elements=e}return _createClass(tn,[{key:"scaling",value:function(e,t){var n=t.elements,i=this.elements;n[0]=i[0]*e,n[1]=i[1]*e,n[2]=i[2]*e,n[3]=i[3]*e}},{key:"normalize",value:function(e){tn._normalizeArray(this.elements,e.elements)}},{key:"length",value:function(){var e=this.elements,t=e[0],n=e[1],i=e[2],r=e[3];return Math.sqrt(t*t+n*n+i*i+r*r)}},{key:"rotateX",value:function(e,t){var n=t.elements,i=this.elements;e*=.5;var r=i[0],a=i[1],o=i[2],s=i[3],l=Math.sin(e),u=Math.cos(e);n[0]=r*u+s*l,n[1]=a*u+o*l,n[2]=o*u-a*l,n[3]=s*u-r*l}},{key:"rotateY",value:function(e,t){var n=t.elements,i=this.elements;e*=.5;var r=i[0],a=i[1],o=i[2],s=i[3],l=Math.sin(e),u=Math.cos(e);n[0]=r*u-o*l,n[1]=a*u+s*l,n[2]=o*u+r*l,n[3]=s*u-a*l}},{key:"rotateZ",value:function(e,t){var n=t.elements,i=this.elements;e*=.5;var r=i[0],a=i[1],o=i[2],s=i[3],l=Math.sin(e),u=Math.cos(e);n[0]=r*u+a*l,n[1]=a*u-r*l,n[2]=o*u+s*l,n[3]=s*u-o*l}},{key:"getYawPitchRoll",value:function(e){Os.transformQuat(Os.ForwardRH,this,tn.TEMPVector31),Os.transformQuat(Os.Up,this,tn.TEMPVector32);var t=tn.TEMPVector32.elements;tn.angleTo(Os.ZERO,tn.TEMPVector31,tn.TEMPVector33);var n=tn.TEMPVector33.elements;n[0]==Math.PI/2?(n[1]=tn.arcTanAngle(t[2],t[0]),n[2]=0):n[0]==-Math.PI/2?(n[1]=tn.arcTanAngle(-t[2],-t[0]),n[2]=0):(q.createRotationY(-n[1],tn.TEMPMatrix0),q.createRotationX(-n[0],tn.TEMPMatrix1),Os.transformCoordinate(tn.TEMPVector32,tn.TEMPMatrix0,tn.TEMPVector32),Os.transformCoordinate(tn.TEMPVector32,tn.TEMPMatrix1,tn.TEMPVector32),n[2]=tn.arcTanAngle(t[1],-t[0])),n[1]<=-Math.PI&&(n[1]=Math.PI),n[2]<=-Math.PI&&(n[2]=Math.PI),n[1]>=Math.PI&&n[2]>=Math.PI&&(n[1]=0,n[2]=0,n[0]=Math.PI-n[0]);var i=e.elements;i[0]=n[1],i[1]=n[0],i[2]=n[2]}},{key:"invert",value:function(e){var t=e.elements,n=this.elements,i=n[0],r=n[1],a=n[2],o=n[3],s=i*i+r*r+a*a+o*o,l=s?1/s:0;t[0]=-i*l,t[1]=-r*l,t[2]=-a*l,t[3]=o*l}},{key:"identity",value:function(){var e=this.elements;e[0]=0,e[1]=0,e[2]=0,e[3]=1}},{key:"fromArray",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;this.elements[0]=e[t+0],this.elements[1]=e[t+1],this.elements[2]=e[t+2],this.elements[3]=e[t+3]}},{key:"cloneTo",value:function(e){var t,n,i;if((n=this.elements)!==(i=e.elements))for(t=0;t<4;++t)i[t]=n[t]}},{key:"clone",value:function(){var e=new tn;return this.cloneTo(e),e}},{key:"equals",value:function(e){var t=this.elements,n=e.elements;return i.nearEqual(t[0],n[0])&&i.nearEqual(t[1],n[1])&&i.nearEqual(t[2],n[2])&&i.nearEqual(t[3],n[3])}},{key:"lengthSquared",value:function(){var e=this.elements[0],t=this.elements[1],n=this.elements[2],i=this.elements[3];return e*e+t*t+n*n+i*i}},{key:"x",get:function(){return this.elements[0]},set:function(e){this.elements[0]=e}},{key:"y",get:function(){return this.elements[1]},set:function(e){this.elements[1]=e}},{key:"z",get:function(){return this.elements[2]},set:function(e){this.elements[2]=e}},{key:"w",get:function(){return this.elements[3]},set:function(e){this.elements[3]=e}}],[{key:"_dotArray",value:function(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]+e[3]*t[3]}},{key:"_normalizeArray",value:function(e,t){var n=e[0],i=e[1],r=e[2],a=e[3],o=n*n+i*i+r*r+a*a;o>0&&(o=1/Math.sqrt(o),t[0]=n*o,t[1]=i*o,t[2]=r*o,t[3]=a*o)}},{key:"_lerpArray",value:function(e,t,n,i){var r=1-n;tn._dotArray(e,t)>=0?(i[0]=r*e[0]+n*t[0],i[1]=r*e[1]+n*t[1],i[2]=r*e[2]+n*t[2],i[3]=r*e[3]+n*t[3]):(i[0]=r*e[0]-n*t[0],i[1]=r*e[1]-n*t[1],i[2]=r*e[2]-n*t[2],i[3]=r*e[3]-n*t[3]),tn._normalizeArray(i,i)}},{key:"createFromYawPitchRoll",value:function(e,t,n,i){var r=.5*n,a=.5*t,o=.5*e,s=Math.sin(r),l=Math.cos(r),u=Math.sin(a),_=Math.cos(a),c=Math.sin(o),h=Math.cos(o),d=i.elements;d[0]=h*u*l+c*_*s,d[1]=c*_*l-h*u*s,d[2]=h*_*s-c*u*l,d[3]=h*_*l+c*u*s}},{key:"multiply",value:function(e,t,n){var i=e.elements,r=t.elements,a=n.elements,o=i[0],s=i[1],l=i[2],u=i[3],_=r[0],c=r[1],h=r[2],d=r[3],f=s*h-l*c,m=l*_-o*h,p=o*c-s*_,v=o*_+s*c+l*h;a[0]=o*d+_*u+f,a[1]=s*d+c*u+m,a[2]=l*d+h*u+p,a[3]=u*d-v}},{key:"arcTanAngle",value:function(e,t){return 0==e?1==t?Math.PI/2:-Math.PI/2:e>0?Math.atan(t/e):e<0?t>0?Math.atan(t/e)+Math.PI:Math.atan(t/e)-Math.PI:0}},{key:"angleTo",value:function(e,t,n){Os.subtract(t,e,tn.TEMPVector30),Os.normalize(tn.TEMPVector30,tn.TEMPVector30),n.elements[0]=Math.asin(tn.TEMPVector30.y),n.elements[1]=tn.arcTanAngle(-tn.TEMPVector30.z,-tn.TEMPVector30.x)}},{key:"createFromAxisAngle",value:function(e,t,n){var i=n.elements,r=e.elements;t*=.5;var a=Math.sin(t);i[0]=a*r[0],i[1]=a*r[1],i[2]=a*r[2],i[3]=Math.cos(t)}},{key:"createFromMatrix3x3",value:function(e,t){var n,i=t.elements,r=e.elements,a=r[0]+r[4]+r[8];if(a>0)n=Math.sqrt(a+1),i[3]=.5*n,n=.5/n,i[0]=(r[5]-r[7])*n,i[1]=(r[6]-r[2])*n,i[2]=(r[1]-r[3])*n;else{var o=0;r[4]>r[0]&&(o=1),r[8]>r[3*o+o]&&(o=2);var s=(o+1)%3,l=(o+2)%3;n=Math.sqrt(r[3*o+o]-r[3*s+s]-r[3*l+l]+1),i[o]=.5*n,n=.5/n,i[3]=(r[3*s+l]-r[3*l+s])*n,i[s]=(r[3*s+o]+r[3*o+s])*n,i[l]=(r[3*l+o]+r[3*o+l])*n}}},{key:"createFromMatrix4x4",value:function(e,t){var n,i,r=e.elements,a=t.elements,o=r[0]+r[5]+r[10];o>0?(n=Math.sqrt(o+1),a[3]=.5*n,n=.5/n,a[0]=(r[6]-r[9])*n,a[1]=(r[8]-r[2])*n,a[2]=(r[1]-r[4])*n):r[0]>=r[5]&&r[0]>=r[10]?(i=.5/(n=Math.sqrt(1+r[0]-r[5]-r[10])),a[0]=.5*n,a[1]=(r[1]+r[4])*i,a[2]=(r[2]+r[8])*i,a[3]=(r[6]-r[9])*i):r[5]>r[10]?(i=.5/(n=Math.sqrt(1+r[5]-r[0]-r[10])),a[0]=(r[4]+r[1])*i,a[1]=.5*n,a[2]=(r[9]+r[6])*i,a[3]=(r[8]-r[2])*i):(i=.5/(n=Math.sqrt(1+r[10]-r[0]-r[5])),a[0]=(r[8]+r[2])*i,a[1]=(r[9]+r[6])*i,a[2]=.5*n,a[3]=(r[1]-r[4])*i)}},{key:"slerp",value:function(e,t,n,i){var r,a,o,s,l,u=e.elements,_=t.elements,c=i.elements,h=u[0],d=u[1],f=u[2],m=u[3],p=_[0],v=_[1],E=_[2],T=_[3];return(a=h*p+d*v+f*E+m*T)<0&&(a=-a,p=-p,v=-v,E=-E,T=-T),1-a>1e-6?(r=Math.acos(a),o=Math.sin(r),s=Math.sin((1-n)*r)/o,l=Math.sin(n*r)/o):(s=1-n,l=n),c[0]=s*h+l*p,c[1]=s*d+l*v,c[2]=s*f+l*E,c[3]=s*m+l*T,c}},{key:"lerp",value:function(e,t,n,i){tn._lerpArray(e.elements,t.elements,n,i.elements)}},{key:"add",value:function(e,t,n){var i=n.elements,r=e.elements,a=t.elements;i[0]=r[0]+a[0],i[1]=r[1]+a[1],i[2]=r[2]+a[2],i[3]=r[3]+a[3]}},{key:"dot",value:function(e,t){return tn._dotArray(e.elements,t.elements)}},{key:"rotationLookAt",value:function(e,t,n){tn.lookAt(Os.ZERO,e,t,n)}},{key:"lookAt",value:function(e,t,n,i){b.lookAt(e,t,n,tn._tempMatrix3x3),tn.rotationMatrix(tn._tempMatrix3x3,i)}},{key:"invert",value:function(e,t){var n=e.elements,r=t.elements,a=e.lengthSquared();i.isZero(a)||(a=1/a,r[0]=-n[0]*a,r[1]=-n[1]*a,r[2]=-n[2]*a,r[3]=n[3]*a)}},{key:"rotationMatrix",value:function(e,t){var n,i,r=e.elements,a=r[0],o=r[1],s=r[2],l=r[3],u=r[4],_=r[5],c=r[6],h=r[7],d=r[8],f=t.elements,m=a+u+d;m>0?(n=Math.sqrt(m+1),f[3]=.5*n,n=.5/n,f[0]=(_-h)*n,f[1]=(c-s)*n,f[2]=(o-l)*n):a>=u&&a>=d?(i=.5/(n=Math.sqrt(1+a-u-d)),f[0]=.5*n,f[1]=(o+l)*i,f[2]=(s+c)*i,f[3]=(_-h)*i):u>d?(i=.5/(n=Math.sqrt(1+u-a-d)),f[0]=(l+o)*i,f[1]=.5*n,f[2]=(h+_)*i,f[3]=(c-s)*i):(i=.5/(n=Math.sqrt(1+d-a-u)),f[0]=(c+s)*i,f[1]=(h+_)*i,f[2]=.5*n,f[3]=(o-l)*i)}}]),tn}();Ns.TEMPVector30=new Os,Ns.TEMPVector31=new Os,Ns.TEMPVector32=new Os,Ns.TEMPVector33=new Os,Ns.TEMPMatrix0=new q,Ns.TEMPMatrix1=new q,Ns._tempMatrix3x3=new b,Ns.DEFAULT=new Ns,Ns.NAN=new Ns(NaN,NaN,NaN,NaN);var Ps=function(){function rn(e){if(_classCallCheck(this,rn),!(e instanceof Array)||4!==e.length)throw new Error("Rand:Seed must be an array with 4 numbers");this._state0U=0|e[0],this._state0L=0|e[1],this._state1U=0|e[2],this._state1L=0|e[3]}return _createClass(rn,[{key:"randomint",value:function(){var e=this._state0U,t=this._state0L,n=this._state1U,i=this._state1L,r=(i>>>0)+(t>>>0),a=n+e+(r/2>>>31)>>>0,o=r>>>0;this._state0U=n,this._state0L=i;var s=0,l=0;return s=(e^=s=e<<23|(-512&t)>>>9)^n,l=(t^=l=t<<23)^i,s^=e>>>18,l^=t>>>18|(262143&e)<<14,s^=n>>>5,l^=i>>>5|(31&n)<<27,this._state1U=s,this._state1L=l,[a,o]}},{key:"random",value:function(){var e=this.randomint(),t=e[0],n=1023<<20|t>>>12,i=e[1]>>>12|(4095&t)<<20|0;return rn._CONVERTION_BUFFER.setUint32(0,n,!1),rn._CONVERTION_BUFFER.setUint32(4,i,!1),rn._CONVERTION_BUFFER.getFloat64(0,!1)-1}}]),rn}();Ps._CONVERTION_BUFFER=new DataView(new ArrayBuffer(8)),Ps.defaultRand=new Ps([0,Date.now()/65536,0,Date.now()%65536]);var bs=function(){function nn(e,t){_classCallCheck(this,nn),this._width=0,this._height=0,this._width=e,this._height=t}return _createClass(nn,[{key:"width",get:function(){return-1===this._width?dn.clientWidth:this._width}},{key:"height",get:function(){return-1===this._height?dn.clientHeight:this._height}}],[{key:"fullScreen",get:function(){return new nn(-1,-1)}}]),nn}();e.AlternateLightQueue=fa,e.AnimationClip=sn,e.AnimationClipParser03=rn,e.AnimationClipParser04=an,e.AnimationEvent=Lt,e.AnimationNode=Fi,e.AnimationTransform3D=Bi,e.Animator=hn,e.AnimatorControllerLayer=un,e.AnimatorPlayState=ln,e.AnimatorState=_n,e.AnimatorStateScript=function(){function _class2(){_classCallCheck(this,_class2)}return _createClass(_class2,[{key:"onStateEnter",value:function(){}},{key:"onStateUpdate",value:function(){}},{key:"onStateExit",value:function(){}}]),_class2}(),e.Avatar=Ui,e.BaseCamera=qn,e.BaseMaterial=Hi,e.BaseRender=Ma,e.BaseShape=go,e.BatchMark=Sa,e.BlinnPhongMaterial=Ki,e.BlitScreenQuadCMD=Mn,e.BloomEffect=xs,e.BoundBox=pa,e.BoundFrustum=Gn,e.BoundSphere=Va,e.Bounds=va,e.BoundsOctree=wa,e.BoundsOctreeNode=Pa,e.BoxColliderShape=he,e.BoxShape=So,e.BufferState=yn,e.BulletInteractive=$o,e.Burst=uo,e.Camera=si,e.CameraCullInfo=na,e.CapsuleColliderShape=Te,e.CastShadowList=function(e){function _class3(){return _classCallCheck(this,_class3),_possibleConstructorReturn(this,_getPrototypeOf(_class3).call(this))}return _inherits(_class3,Ye),_createClass(_class3,[{key:"add",value:function(e){if(-1!==e._indexInCastShadowList)throw"CastShadowList:element has  in  CastShadowList.";this._add(e),e._indexInCastShadowList=this.length++}},{key:"remove",value:function(e){var t=e._indexInCastShadowList;if(this.length--,t!==this.length){var n=this.elements[this.length];this.elements[t]=n,n._indexInCastShadowList=t}e._indexInCastShadowList=-1}}]),_class3}(),e.CharacterController=yt,e.CircleShape=Ro,e.ClearRenderTextureCMD=bn,e.Cluster=kn,e.ColliderShape=Q,e.Collision=pt,e.CollisionTool=vt,e.CollisionUtils=Un,e.Color=ta,e.ColorOverLifetime=co,e.Command=Dn,e.CommandBuffer=Pi,e.CompoundColliderShape=ie,e.ConchQuaternion=Ns,e.ConchVector3=Os,e.ConchVector4=Ls,e.ConeColliderShape=Se,e.ConeShape=Co,e.Config3D=It,e.ConfigurableConstraint=gs,e.Constraint3D=function(){return function _class4(){_classCallCheck(this,_class4)}}(),e.ConstraintComponent=Es,e.ContactPoint=rt,e.ContainmentType=Fn,e.CylinderColliderShape=Oe,e.DefineDatas=mn,e.DepthPass=$n,e.DirectionLight=ss,e.DrawMeshCMD=Pn,e.DrawMeshInstancedCMD=Oi,e.DrawRenderCMD=pi,e.DynamicBatchManager=Ga,e.EffectMaterial=er,e.Emission=Bo,e.ExtendTerrainMaterial=rr,e.FixedConstraint=Ts,e.FloatKeyframe=Bt,e.FrameOverTime=ho,e.FrustumCulling=ra,e.GeometryElement=Ea,e.Gradient=lo,e.GradientAngularVelocity=fo,e.GradientColor=_o,e.GradientDataInt=mo,e.GradientDataNumber=po,e.GradientDataVector2=As,e.GradientMode=so,e.GradientSize=vo,e.GradientVelocity=Eo,e.HeightMap=Rs,e.HemisphereShape=Ao,e.HitResult=ft,e.ILaya3D=F,e.IndexBuffer3D=Wn,e.Input3D=la,e.Keyframe=Pt,e.KeyframeNode=Dt,e.KeyframeNodeList=on,e.KeyframeNodeOwner=cn,e.Laya3D=ys,e.LightQueue=da,e.LightSprite=Kn,e.Lightmap=ka,e.LoadModelV04=ds,e.LoadModelV05=fs,e.Material=Gi,e.MaterialInstanceProperty=Ds,e.MaterialInstancePropertyBlock=Ms,e.MathUtils3D=i,e.Matrix3x3=b,e.Matrix4x4=q,e.Mesh=is,e.MeshColliderShape=be,e.MeshFilter=io,e.MeshReader=ps,e.MeshRenderDynamicBatchManager=ao,e.MeshRenderStaticBatchManager=xa,e.MeshRenderer=no,e.MeshSprite3D=oo,e.MeshSprite3DShaderDeclaration=Si,e.MeshTerrainSprite3D=Cs,e.MouseTouch=oa,e.OctreeMotionList=ba,e.PBRMaterial=or,e.PBRSpecularMaterial=Qa,e.PBRStandardMaterial=Ka,e.Physics3D=Ct,e.Physics3DUtils=ce,e.PhysicsCollider=es,e.PhysicsComponent=ze,e.PhysicsSettings=ua,e.PhysicsSimulation=Et,e.PhysicsTriggerComponent=St,e.PhysicsUpdateList=et,e.Picker=zn,e.PixelLineData=function(){function _class5(){_classCallCheck(this,_class5),this.startPosition=new D,this.endPosition=new D,this.startColor=new ta,this.endColor=new ta}return _createClass(_class5,[{key:"cloneTo",value:function(e){this.startPosition.cloneTo(e.startPosition),this.endPosition.cloneTo(e.endPosition),this.startColor.cloneTo(e.startColor),this.endColor.cloneTo(e.endColor)}}]),_class5}(),e.PixelLineFilter=ga,e.PixelLineMaterial=ma,e.PixelLineRenderer=La,e.PixelLineSprite3D=Oa,e.PixelLineVertex=Ta,e.Plane=Vn,e.PointLight=ls,e.PostProcess=Vi,e.PostProcessEffect=Is,e.PostProcessRenderContext=bi,e.PrimitiveMesh=rs,e.Quaternion=Z,e.QuaternionKeyframe=zt,e.Rand=Vo,e.RandX=Ps,e.Ray=Bn,e.ReflectionProbe=Da,e.ReflectionProbeList=Ha,e.ReflectionProbeManager=za,e.RenderContext3D=dn,e.RenderElement=ci,e.RenderQueue=Na,e.RenderState=Wi,e.RenderTexture=fn,e.RenderableSprite3D=ya,e.Rigidbody3D=Rt,e.RotationOverLifetime=To,e.Scene3D=Wa,e.Scene3DShaderDeclaration=Qn,e.Scene3DUtils=hs,e.ScreenQuad=Sn,e.ScreenTriangle=Rn,e.Script3D=Ss,e.SetGlobalShaderDataCMD=gi,e.SetRenderTargetCMD=Ln,e.SetShaderDataCMD=On,e.Shader3D=xn,e.ShaderData=En,e.ShaderDefine=Cn,e.ShaderInit3D=os,e.ShaderInstance=qr,e.ShaderPass=Xa,e.ShaderVariable=Zr,e.ShaderVariant=An,e.ShaderVariantCollection=In,e.ShadowCasterPass=Ua,e.ShadowCullInfo=ia,e.ShadowSliceData=Ba,e.ShadowSpotData=Fa,e.ShadowUtils=Jn,e.ShapeUtils=yo,e.ShuriKenParticle3D=Go,e.ShuriKenParticle3DShaderDeclaration=Oo,e.ShurikenParticleData=Fo,e.ShurikenParticleMaterial=No,e.ShurikenParticleRenderer=Po,e.ShurikenParticleSystem=Uo,e.SimpleSingletonList=ea,e.SimpleSkinnedMeshRenderer=_s,e.SimpleSkinnedMeshSprite3D=cs,e.SingletonList=Ye,e.Size=bs,e.SizeOverLifetime=xo,e.SkinnedMeshRenderer=zo,e.SkinnedMeshSprite3D=Wo,e.SkinnedMeshSprite3DShaderDeclaration=Ho,e.SkyBox=jn,e.SkyBoxMaterial=Ja,e.SkyDome=ca,e.SkyMesh=Yn,e.SkyPanoramicMaterial=vs,e.SkyProceduralMaterial=$a,e.SkyRenderer=Zn,e.SphereColliderShape=we,e.SphereShape=Io,e.SphericalHarmonicsL2=aa,e.SpotLight=us,e.Sprite3D=Nn,e.StartFrame=Do,e.StaticBatchManager=Aa,e.StaticPlaneColliderShape=ne,e.SubMesh=ts,e.SubMeshDynamicBatch=ro,e.SubMeshInstanceBatch=Ra,e.SubMeshRenderElement=Ca,e.SubMeshStaticBatch=Ia,e.SubShader=Ya,e.TextMesh=function(){function _class6(){_classCallCheck(this,_class6)}return _createClass(_class6,[{key:"text",get:function(){return this._text},set:function(e){this._text=e}},{key:"fontSize",get:function(){return this._fontSize},set:function(e){this._fontSize=e}},{key:"color",get:function(){return this._color},set:function(e){this._color=e}}]),_class6}(),e.TextureCube=ha,e.TextureGenerator=Tt,e.TextureMode=Yo,e.TextureSheetAnimation=Mo,e.Touch=sa,e.TrailFilter=qo,e.TrailGeometry=Zo,e.TrailMaterial=Xo,e.TrailRenderer=Qo,e.TrailSprite3D=Ko,e.Transform3D=oe,e.UnlitMaterial=eo,e.Utils3D=gt,e.Vector2=r,e.Vector3=D,e.Vector3Keyframe=Yt,e.Vector4=o,e.VelocityOverLifetime=Lo,e.VertexBuffer3D=pn,e.VertexDeclaration=Tn,e.VertexElement=gn,e.VertexElementFormat=vn,e.VertexMesh=Xn,e.VertexPositionTerrain=Jo,e.VertexPositionTexture0=_a,e.VertexShuriKenParticle=bo,e.VertexShurikenParticleBillboard=wo,e.VertexShurikenParticleMesh=ko,e.VertexTrail=jo,e.Viewport=Hn,e.WaterPrimaryMaterial=to,e.skinnedMatrixCache=ns}(window.Laya=window.Laya||{},Laya);