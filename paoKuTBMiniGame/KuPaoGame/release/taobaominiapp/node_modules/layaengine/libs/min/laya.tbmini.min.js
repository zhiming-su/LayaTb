var window = $global.window;
var document = window.document;
var XMLHttpRequest = window.XMLHttpRequest;
var Laya = window.Laya;
var Laya3D = window.Laya3D;
var performance = window.performance;
var CANNON = window.CANNON;
"use strict";function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _possibleConstructorReturn(e,t){return!t||"object"!==_typeof(t)&&"function"!=typeof t?_assertThisInitialized(e):t}function _assertThisInitialized(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function _get(e,t,i){return(_get="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,i){var n=_superPropBase(e,t);if(n){var o=Object.getOwnPropertyDescriptor(n,t);return o.get?o.get.call(i):o.value}})(e,t,i||e)}function _superPropBase(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=_getPrototypeOf(e)););return e}function _getPrototypeOf(e){return(_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&_setPrototypeOf(e,t)}function _setPrototypeOf(e,t){return(_setPrototypeOf=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function _createClass(e,t,i){return t&&_defineProperties(e.prototype,t),i&&_defineProperties(e,i),e}window.tbMiniGame=function(e,t){var c=function(){function i(){_classCallCheck(this,i)}return _createClass(i,null,[{key:"isLocalNativeFile",value:function(e){for(var t=0,i=g.nativefiles.length;t<i;t++)if(-1!=e.indexOf(g.nativefiles[t]))return!0;return!1}},{key:"isSubNativeFile",value:function(e){for(var t=0,i=g.subNativeheads.length;t<i;t++)if(-1!=e.indexOf(g.subNativeheads[t]))return!0;return!1}},{key:"isNetFile",value:function(e){return(-1!=e.indexOf("http://")||-1!=e.indexOf("https://"))&&-1==e.indexOf(g.window.my.env.USER_DATA_PATH)}},{key:"getFileInfo",value:function(e){var t=e,n=i.fakeObj[t];return null==n?null:n}},{key:"read",value:function(e){var n,o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"utf8",a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,l=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"",r=arguments.length>4&&void 0!==arguments[4]&&arguments[4],s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:"";n=""==l||-1==l.indexOf("http://")&&-1==l.indexOf("https://")?e:i.getFileNativePath(e),n=t.URL.getAdptedFilePath(n),i.fs.readFile({filePath:n,encoding:o,success:function(e){null!=a&&a.runWith([0,e])},fail:function(e){e&&""!=l?i.downFiles(g.safeEncodeURI(l),o,a,l,r,s):null!=a&&a.runWith([1])}})}},{key:"isFile",value:function(e){var t;try{t=i.fs.statSync(e)}catch(e){return!1}return t.isFile()}},{key:"downFiles",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"utf8",n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"",a=arguments.length>4&&void 0!==arguments[4]&&arguments[4],l=arguments.length>5&&void 0!==arguments[5]?arguments[5]:"",r=!(arguments.length>6&&void 0!==arguments[6])||arguments[6];i.wxdown({url:e,success:function(s){s.hasOwnProperty("statusCode")||(s.statusCode=200),200===s.statusCode?i.readFile(s.apFilePath,t,n,o,a,l,r):403===s.statusCode?null!=n&&n.runWith([0,e]):null!=n&&n.runWith([1,s])},fail:function(e){console.log("downloadfile fail:",o,e),null!=n&&n.runWith([1,e])}}).onProgressUpdate(function(e){null!=n&&n.runWith([2,e.progress])})}},{key:"readFile",value:function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"utf8",o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"",l=arguments.length>4&&void 0!==arguments[4]&&arguments[4],r=(arguments.length>5&&void 0!==arguments[5]&&arguments[5],!(arguments.length>6&&void 0!==arguments[6])||arguments[6]);e=t.URL.getAdptedFilePath(e),i.fs.readFile({filePath:e,encoding:n,success:function(t){!e.indexOf(g.window.my.env.USER_DATA_PATH)||-1==e.indexOf("http://")&&-1==e.indexOf("https://")?null!=o&&o.runWith([0,t]):l?(null!=o&&o.runWith([0,t]),i.copyTOCache(e,a,null,n,r)):null!=o&&o.runWith([0,t])},fail:function(e){e&&null!=o&&o.runWith([1,e])}})}},{key:"downOtherFiles",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"",o=arguments.length>3&&void 0!==arguments[3]&&arguments[3],a=!(arguments.length>4&&void 0!==arguments[4])||arguments[4];i.wxdown({url:e,success:function(e){e.hasOwnProperty("statusCode")||(e.statusCode=200),200===e.statusCode?o&&-1==n.indexOf(".php")?(null!=t&&t.runWith([0,e.apFilePath]),i.copyTOCache(e.apFilePath,n,null,"",a)):null!=t&&t.runWith([0,e.apFilePath]):null!=t&&t.runWith([1,e])},fail:function(e){console.log("downloadfile fail:",n,e),null!=t&&t.runWith([1,e])}})}},{key:"copyFile",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;i.fs.copyFile({srcPath:e,destPath:t,success:function(){n&&n.runWith(0)},fail:function(e){n&&n.runWith([1,e])}})}},{key:"downLoadFile",value:function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"utf8",l=arguments.length>4&&void 0!==arguments[4]&&arguments[4];window.navigator.userAgent.indexOf("AlipayMiniGame")<0?t.Laya.loader.load(e,o):n==t.Loader.IMAGE||n==t.Loader.SOUND?i.downOtherFiles(g.safeEncodeURI(e),o,e,l,!1):i.downFiles(g.safeEncodeURI(e),a,o,e,!0,n,l)}},{key:"copyTOCache",value:function(e,n,o){var a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"",l=!(arguments.length>4&&void 0!==arguments[4])||arguments[4],r=e.split("/"),s=r[r.length-1],u=n,d=i.getFileInfo(n),c=i.getFileNativePath(s);i.fakeObj[u]={md5:s,readyUrl:n,size:0,times:t.Browser.now(),encoding:a,tempFilePath:e};var f=g.sizeLimit,h=i.getCacheUseSize();d?d.readyUrl!=n?i.fs.getFileInfo({filePath:e,success:function(t){l&&h+4194304+t.size>=f&&(t.size>g.minClearSize&&(g.minClearSize=t.size),i.onClearCacheRes()),i.deleteFile(e,n,o,a,t.size)},fail:function(e){null!=o&&o.runWith([1,e])}}):null!=o&&o.runWith([0]):i.fs.getFileInfo({filePath:e,success:function(t){l&&h+4194304+t.size>=f&&(t.size>g.minClearSize&&(g.minClearSize=t.size),i.onClearCacheRes()),i.fs.copyFile({srcPath:e,destPath:c,success:function(e){i.onSaveFile(n,s,!0,a,o,t.size)},fail:function(e){null!=o&&o.runWith([1,e])}})},fail:function(e){null!=o&&o.runWith([1,e])}})}},{key:"onClearCacheRes",value:function(){var e=g.minClearSize,t=[];for(var n in i.filesListObj)"fileUsedSize"!=n&&t.push(i.filesListObj[n]);i.sortOn(t,"times",i.NUMERIC);for(var o=0,a=1,l=t.length;a<l;a++){var r=t[a];if(o>=e)break;o+=r.size,i.deleteFile("",r.readyUrl)}}},{key:"sortOn",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return n==i.NUMERIC?e.sort(function(e,i){return e[t]-i[t]}):n==(i.NUMERIC|i.DESCENDING)?e.sort(function(e,i){return i[t]-e[t]}):e.sort(function(e,i){return e[t]-i[t]})}},{key:"getFileNativePath",value:function(e){return i.fileNativeDir+"/"+e}},{key:"deleteFile",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"",a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,l=i.getFileInfo(t),r=i.getFileNativePath(l.md5);i.fs.unlink({filePath:r,success:function(l){if(""!=e){var r=i.getFileNativePath(e);i.fs.copyFile({srcPath:e,destPath:r,success:function(l){i.onSaveFile(t,e,!0,o,n,a)},fail:function(e){null!=n&&n.runWith([1,e])}})}else i.onSaveFile(t,e,!1,o,n,a)},fail:function(e){null!=n&&n.runWith([1,e])}})}},{key:"deleteAll",value:function(){var e=[];for(var t in i.filesListObj)"fileUsedSize"!=t&&e.push(i.filesListObj[t]);for(var n=1,o=e.length;n<o;n++){var a=e[n];i.deleteFile("",a.readyUrl)}i.filesListObj&&i.filesListObj.fileUsedSize&&(i.filesListObj.fileUsedSize=0),i.writeFilesList("",JSON.stringify({}),!1)}},{key:"onSaveFile",value:function(e,n){var o=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"",l=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,r=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,s=e;if(null==i.filesListObj.fileUsedSize&&(i.filesListObj.fileUsedSize=0),o){var u=i.getFileNativePath(n);i.filesListObj[s]={md5:n,readyUrl:e,size:r,times:t.Browser.now(),encoding:a,tempFilePath:u},i.filesListObj.fileUsedSize=parseInt(i.filesListObj.fileUsedSize)+r,i.writeFilesList(s,JSON.stringify(i.filesListObj),!0),null!=l&&l.runWith([0])}else if(i.filesListObj[s]){var d=parseInt(i.filesListObj[s].size);i.filesListObj.fileUsedSize=parseInt(i.filesListObj.fileUsedSize)-d,i.fakeObj[s].md5==i.filesListObj[s].md5&&delete i.fakeObj[s],delete i.filesListObj[s],i.writeFilesList(s,JSON.stringify(i.filesListObj),!1),null!=l&&l.runWith([0])}}},{key:"writeFilesList",value:function(e,t,n){var o=i.fileNativeDir+"/"+i.fileListName;i.fs.writeFile({filePath:o,encoding:"utf8",data:t,success:function(e){},fail:function(e){}}),!g.isZiYu&&g.isPosMsgYu&&g.window.my.postMessage&&g.window.my.postMessage({url:e,data:i.filesListObj[e],isLoad:"filenative",isAdd:n})}},{key:"getCacheUseSize",value:function(){return i.filesListObj&&i.filesListObj.fileUsedSize?i.filesListObj.fileUsedSize:0}},{key:"getCacheList",value:function(e,t){var n;try{n=i.fs.statSync(e)}catch(e){n=null}n?i.readSync(i.fileListName,"utf8",t):(i.fs.mkdirSync(e,!0),t&&t.runWith([1]))}},{key:"existDir",value:function(e,t){i.fs.mkdir({dirPath:e,success:function(e){null!=t&&t.runWith([0,{data:JSON.stringify({})}])},fail:function(e){10025==e.error?i.readSync(i.fileListName,"utf8",t):null!=t&&t.runWith([1,e])}})}},{key:"readSync",value:function(e){var t,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"utf8",o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,a=(arguments.length>3&&void 0!==arguments[3]&&arguments[3],i.getFileNativePath(e));try{i.fs.readFile({filePath:a,encoding:n,success:function(e){t=e.data,null!=o&&o.runWith([0,{data:t}])},fail:function(){null!=o&&o.runWith([1])}})}catch(e){null!=o&&o.runWith([1])}}},{key:"setNativeFileDir",value:function(e){i.fileNativeDir=g.window.my.env.USER_DATA_PATH+e}}]),i}();c.fs=window.my.getFileSystemManager(),c.wxdown=window.my.downloadFile,c.filesListObj={},c.fakeObj={},c.fileListName="layaairfiles.txt",c.ziyuFileData={},c.ziyuFileTextureData={},c.loadPath="",c.DESCENDING=2,c.NUMERIC=16;var f=function(e){function n(e){var t;return _classCallCheck(this,n),(t=_possibleConstructorReturn(this,_getPrototypeOf(n).call(this)))._sound=e,t._audio=e._sound,t._onCanplay=t.onCanPlay.bind(_assertThisInitialized(t)),t._onError=t.onError.bind(_assertThisInitialized(t)),t._onEnd=t.__onEnd.bind(_assertThisInitialized(t)),t.addEventListener(),t}return _inherits(n,t.SoundChannel),_createClass(n,[{key:"addEventListener",value:function(){this._audio.onError(this._onError),this._audio.onCanplay(this._onCanplay)}},{key:"offEventListener",value:function(){this._audio.offError(this._onError),this._audio.offCanplay(this._onCanplay),this._audio.offEnded(this._onEnd)}},{key:"onError",value:function(e){console.log("-----1---------------minisound-----url:",this.url),console.log(e),this.event(t.Event.ERROR),this._audio&&(this._sound.dispose(),this.offEventListener(),this._sound=this._audio=null)}},{key:"onCanPlay",value:function(){this._audio&&(this.event(t.Event.COMPLETE),this.offEventListener(),this._audio.onEnded(this._onEnd),this.isStopped?this.stop():this.play())}},{key:"__onEnd",value:function(){if(1==this.loops)return this.completeHandler&&(t.Laya.systemTimer.once(10,this,this.__runComplete,[this.completeHandler],!1),this.completeHandler=null),this.stop(),void this.event(t.Event.COMPLETE);this.loops>0&&this.loops--,this.startTime=0,this.play()}},{key:"play",value:function(){this.isStopped=!1,t.SoundManager.addChannel(this),this._audio&&this._audio.play()}},{key:"stop",value:function(){_get(_getPrototypeOf(n.prototype),"stop",this).call(this),this.isStopped=!0,t.SoundManager.removeChannel(this),this.completeHandler=null,this._audio&&(this._audio.stop(),this.loop||(this.offEventListener(),this._sound.dispose(),this._sound=null,this._audio=null))}},{key:"pause",value:function(){this.isStopped=!0,this._audio&&this._audio.pause()}},{key:"resume",value:function(){this.isStopped=!1,t.SoundManager.addChannel(this),this._audio&&this._audio.play()}},{key:"startTime",set:function(e){this._audio&&(this._audio.startTime=e)}},{key:"autoplay",set:function(e){this._audio&&(this._audio.autoplay=e)},get:function(){return!!this._audio&&this._audio.autoplay}},{key:"position",get:function(){return this._audio?this._audio.currentTime:0}},{key:"duration",get:function(){return this._audio?this._audio.duration:0}},{key:"loop",get:function(){return!!this._audio&&this._audio.loop},set:function(e){this._audio&&(this._audio.loop=e)}},{key:"volume",set:function(e){this._audio&&(this._audio.volume=e)},get:function(){return this._audio?this._audio.volume:0}}]),n}(),h=function(e){function a(){var e;return _classCallCheck(this,a),(e=_possibleConstructorReturn(this,_getPrototypeOf(a).call(this))).loaded=!1,e._sound=a._createSound(),e}return _inherits(a,t.EventDispatcher),_createClass(a,[{key:"load",value:function(e){if(c.isLocalNativeFile(e)){if(-1==e.indexOf(g.window.my.env.USER_DATA_PATH)&&(-1!=e.indexOf("http://")||-1!=e.indexOf("https://")))if(""!=c.loadPath)e=e.split(c.loadPath)[1];else{var i=""!=t.URL.rootPath?t.URL.rootPath:t.URL._basePath;""!=i&&(e=e.split(i)[1])}}else e=t.URL.formatURL(e);if(this.url=e,this.readyUrl=e,g.autoCacheFile&&c.getFileInfo(e))this.onDownLoadCallBack(e,0);else if(g.autoCacheFile)if(c.isLocalNativeFile(e)){if(g.subNativeFiles&&0==g.subNativeheads.length)for(var n in g.subNativeFiles){var o=g.subNativeFiles[n];g.subNativeheads=g.subNativeheads.concat(o);for(var a=0;a<o.length;a++)g.subMaps[o[a]]=n+"/"+o[a]}if(g.subNativeFiles&&-1!=e.indexOf("/")){var l=e.split("/")[0]+"/";if(l&&-1!=g.subNativeheads.indexOf(l)){var r=g.subMaps[l];e=e.replace(l,r)}}this.onDownLoadCallBack(e,0)}else-1==e.indexOf("http://")&&-1==e.indexOf("https://")||-1!=e.indexOf(g.window.my.env.USER_DATA_PATH)?this.onDownLoadCallBack(e,0):c.downOtherFiles(e,t.Handler.create(this,this.onDownLoadCallBack,[e]),e,g.autoCacheFile);else this.onDownLoadCallBack(e,0)}},{key:"onDownLoadCallBack",value:function(e,i){var n,o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;if(!i&&this._sound)if(g.autoCacheFile){if(o)n=o;else if(c.isLocalNativeFile(e)){var a=""!=t.URL.rootPath?t.URL.rootPath:t.URL._basePath,l=e;""==a||-1==e.indexOf("http://")&&-1==e.indexOf("https://")||(n=e.split(a)[1]),n||(n=l),n=c.isSubNativeFile(n)?n:g.baseDir+n}else{var r=c.getFileInfo(e);if(r&&r.md5){var s=r.md5;n=c.getFileNativePath(s)}else n=-1==e.indexOf("http://")&&-1==e.indexOf("https://")&&-1==e.indexOf(g.window.my.env.USER_DATA_PATH)?g.baseDir+e:e}this._sound.src=this.readyUrl=n}else(c.isLocalNativeFile(e)||-1==e.indexOf("http://")&&-1==e.indexOf("https://")&&-1==e.indexOf(g.window.my.env.USER_DATA_PATH)&&!c.isSubNativeFile(n))&&(e=g.baseDir+e),this._sound.src=this.readyUrl=e;else this.event(t.Event.ERROR)}},{key:"play",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;if(!this.url)return null;var n=new f(this);return n.url=this.url,n.loops=i,n.loop=0===i,n.startTime=e,n.isStopped=!1,t.SoundManager.addChannel(n),n}},{key:"dispose",value:function(){this._sound&&(a.cachePool.push(this._sound),this._sound=null,this.readyUrl=this.url=null)}},{key:"duration",get:function(){return this._sound.duration}}],[{key:"__init__",value:function(){for(var e=0;e<10;e++){var t=g.window.my.createInnerAudioContext();a.cachePool.push(t)}}},{key:"_createSound",value:function(){return a.cachePool.length?a.cachePool.pop():g.window.my.createInnerAudioContext()}}]),a}();h.cachePool=[];var v=function(){function s(){_classCallCheck(this,s)}return _createClass(s,null,[{key:"_createInputElement",value:function(){t.Input._initInput(t.Input.area=t.Browser.createElement("textarea")),t.Input._initInput(t.Input.input=t.Browser.createElement("input")),t.Input.inputContainer=t.Browser.createElement("div"),t.Input.inputContainer.style.position="absolute",t.Input.inputContainer.style.zIndex=1e5,t.Browser.container.appendChild(t.Input.inputContainer),t.SoundManager._soundClass=h,t.SoundManager._musicClass=h;var e=g.systemInfo.model,i=g.systemInfo.system;-1!=e.indexOf("iPhone")&&(t.Browser.onIPhone=!0,t.Browser.onIOS=!0,t.Browser.onIPad=!0,t.Browser.onAndroid=!1),-1==i.indexOf("Android")&&-1==i.indexOf("Adr")||(t.Browser.onAndroid=!0,t.Browser.onIPhone=!1,t.Browser.onIOS=!1,t.Browser.onIPad=!1)}},{key:"_onStageResize",value:function(){t.Laya.stage._canvasTransform.identity().scale(t.Browser.width/t.Render.canvas.width/t.Browser.pixelRatio,t.Browser.height/t.Render.canvas.height/t.Browser.pixelRatio)}},{key:"wxinputFocus",value:function(e){}},{key:"inputEnter",value:function(){t.Input.inputElement.target.focus=!1}},{key:"wxinputblur",value:function(){s.hideKeyboard()}},{key:"hideKeyboard",value:function(){}}]),s}(),y=function(e){function o(){return _classCallCheck(this,o),_possibleConstructorReturn(this,_getPrototypeOf(o).call(this))}return _inherits(o,t.EventDispatcher),_createClass(o,[{key:"_loadResourceFilter",value:function(e,i){if(this.sourceUrl=t.URL.formatURL(i),c.isNetFile(i))if(""!=c.loadPath)i=i.split(c.loadPath)[1];else{var n=""!=t.URL.rootPath?t.URL.rootPath:t.URL._basePath,a=i;""!=n&&(i=i.split(n)[1]),i||(i=a)}if(g.subNativeFiles&&0==g.subNativeheads.length)for(var l in g.subNativeFiles){var r=g.subNativeFiles[l];g.subNativeheads=g.subNativeheads.concat(r);for(var s=0;s<r.length;s++)g.subMaps[r[s]]=l+"/"+r[s]}if(g.subNativeFiles&&-1!=i.indexOf("/")){var u=i.split("/")[0]+"/";if(u&&-1!=g.subNativeheads.indexOf(u)){var d=g.subMaps[u];i=i.replace(u,d)}}switch(e){case t.Loader.IMAGE:case"htmlimage":case"nativeimage":o._transformImgUrl(i,e,this);break;case t.Loader.SOUND:this._loadSound(i);break;default:this._loadResource(e,i)}}},{key:"_loadSound",value:function(e){if(g.autoCacheFile){var i=t.URL.formatURL(e);c.getFileInfo(i)?o.onDownLoadCallBack(e,this,0):c.isLocalNativeFile(e)?-1!=i.indexOf(g.window.my.env.USER_DATA_PATH)||c.isSubNativeFile(e)?o.onDownLoadCallBack(e,this,0):o.onDownLoadCallBack(g.baseDir+e,this,0):c.isNetFile(i)?c.downOtherFiles(g.safeEncodeURI(i),t.Handler.create(o,o.onDownLoadCallBack,[i,this]),i,g.autoCacheFile):o.onDownLoadCallBack(g.baseDir+e,this,0)}else o.onDownLoadCallBack(e,this,0)}},{key:"complete",value:function(e){e instanceof t.Resource?e._setCreateURL(this.sourceUrl):e instanceof t.Texture&&e.bitmap instanceof t.Resource&&e.bitmap._setCreateURL(this.sourceUrl),this.originComplete(e)}},{key:"_loadHttpRequestWhat",value:function(e,i){var n=g.getUrlEncode(e,i);if(t.Loader.preLoadedMap[e])this.onLoaded(t.Loader.preLoadedMap[e]);else{var a=t.URL.formatURL(e),l=c.getFileInfo(a);if(l){l.encoding=null==l.encoding?"utf8":l.encoding;var r=l.tempFilePath||c.getFileNativePath(l.md5);c.readFile(r,n,new t.Handler(o,o.onReadNativeCallBack,[e,i,this]),e)}else-1==a.indexOf("http://")&&-1==a.indexOf("https://")||c.isLocalNativeFile(e)?-1!=a.indexOf(g.window.my.env.USER_DATA_PATH)||c.isSubNativeFile(e)?c.readFile(e,n,new t.Handler(o,o.onReadNativeCallBack,[e,i,this]),e):c.readFile(g.baseDir+e,n,new t.Handler(o,o.onReadNativeCallBack,[e,i,this]),e):c.downFiles(g.safeEncodeURI(a),n,new t.Handler(o,o.onReadNativeCallBack,[e,i,this]),a,g.AutoCacheDownFile)}}}],[{key:"onDownLoadCallBack",value:function(e,i,n){var o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;if(n)i.event(t.Event.ERROR,"Load sound failed");else{var a;if(g.autoCacheFile)if(o)a=o;else if(c.isLocalNativeFile(e))a=e;else{var l=c.getFileInfo(e);a=l&&l.md5?l.tempFilePath||c.getFileNativePath(l.md5):e}else a=t.URL.formatURL(e);e=a;var r=new t.SoundManager._soundClass;r.load(g.safeEncodeURI(e)),i.onLoaded(r)}}},{key:"bindToThis",value:function(e,t){return e.bind(t)}},{key:"onReadNativeCallBack",value:function(e){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;if(o)1==o&&n.onError&&n.onError(a);else try{var l;l=i==t.Loader.JSON||i==t.Loader.ATLAS||i==t.Loader.PREFAB||i==t.Loader.PLF?g.getJson(a.data):i==t.Loader.XML?t.Utils.parseXMLFromString(a.data):a.data,n.onLoaded(l)}catch(e){n.onError&&n.onError(a)}}},{key:"_transformImgUrl",value:function(e,i,n){var a=t.URL.formatURL(e);c.isLocalNativeFile(e)||-1==a.indexOf("http://")&&-1==a.indexOf("https://")?-1==a.indexOf(g.window.my.env.USER_DATA_PATH)?o.onCreateImage(e,n,!0):o.onCreateImage(e,n,!1,e):o.onCreateImage(e,n,!1,a)}},{key:"onCreateImage",value:function(e,t){var i,n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"";i=n?c.isSubNativeFile(e)?e:g.baseDir+e:""!=o?o:e,t._loadImage(g.safeEncodeURI(i),!1)}}]),o}(),p=function(){function l(){_classCallCheck(this,l)}return _createClass(l,null,[{key:"__init__",value:function(){l.items=l}},{key:"setItem",value:function(e,t){g.window.my.setStorageSync({key:e,data:t})}},{key:"getItem",value:function(e){return g.window.my.getStorageSync({key:e}).data}},{key:"setJSON",value:function(e,t){try{l.setItem(e,JSON.stringify(t))}catch(e){console.warn("set localStorage failed",e)}}},{key:"getJSON",value:function(e){return JSON.parse(l.getItem(e))}},{key:"removeItem",value:function(e){g.window.my.removeStorageSync({key:e})}},{key:"clear",value:function(){g.window.my.clearStorageSync()}},{key:"getStorageInfoSync",value:function(){try{var e=g.window.my.getStorageInfoSync();return console.log(e.keys),console.log(e.currentSize),console.log(e.limitSize),e}catch(e){}return null}}]),l}();p.support=!0;var g=function(){function r(){_classCallCheck(this,r)}return _createClass(r,null,[{key:"getJson",value:function(e){return JSON.parse(e)}},{key:"enable",value:function(){r.init(t.Laya.isWXPosMsg,t.Laya.isWXOpenDataContext)}},{key:"init",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],i=arguments.length>1&&void 0!==arguments[1]&&arguments[1];r._inited||(r._inited=!0,r.window=window,r.window.hasOwnProperty("my")&&(r.isZiYu=i,r.isPosMsgYu=e,r.EnvConfig={},r.isZiYu||(c.setNativeFileDir("/layaairGame"),c.getCacheList(c.fileNativeDir,t.Handler.create(r,r.onMkdirCallBack))),r.systemInfo=r.window.my.getSystemInfoSync(),r.window.focus=function(){},t.Laya._getUrlPath=function(){return""},r.window.logtime=function(e){},r.window.alertTimeLog=function(e){},r.window.resetShareInfo=function(){},r.window.CanvasRenderingContext2D=function(){},t.HttpRequest._urlEncode=r.safeEncodeURI,r._preCreateElement=t.Browser.createElement,r.window.CanvasRenderingContext2D.prototype=r._preCreateElement("canvas").getContext("2d").__proto__,r.window.document.body.appendChild=function(){},t.Browser.createElement=r.createElement,t.RunDriver.createShaderCondition=r.createShaderCondition,t.Utils.parseXMLFromString=r.parseXMLFromString,t.Input._createInputElement=v._createInputElement,t.Loader.prototype._loadResourceFilter=y.prototype._loadResourceFilter,t.Loader.prototype._loadSound=y.prototype._loadSound,t.Loader.prototype.originComplete=t.Loader.prototype.complete,t.Loader.prototype.complete=y.prototype.complete,t.Loader.prototype._loadHttpRequestWhat=y.prototype._loadHttpRequestWhat,t.Config.useRetinalCanvas=!0,t.LocalStorage._baseClass=p,p.__init__(),h.__init__(),r.window.my.onMessage&&r.window.my.onMessage(r._onMessage)))}},{key:"_onMessage",value:function(e){switch(e.type){case"changeMatrix":t.Laya.stage.transform.identity(),t.Laya.stage._width=e.w,t.Laya.stage._height=e.h,t.Laya.stage._canvasTransform=new t.Matrix(e.a,e.b,e.c,e.d,e.tx,e.ty);break;case"display":t.Laya.stage.frameRate=e.rate||t.Stage.FRAME_FAST;break;case"undisplay":t.Laya.stage.frameRate=t.Stage.FRAME_SLEEP}"opendatacontext"==e.isLoad?e.url&&(c.ziyuFileData[e.url]=e.atlasdata,c.ziyuFileTextureData[e.imgReadyUrl]=e.imgNativeUrl):"openJsondatacontext"==e.isLoad?e.url&&(c.ziyuFileData[e.url]=e.atlasdata):"openJsondatacontextPic"==e.isLoad&&(c.ziyuFileTextureData[e.imgReadyUrl]=e.imgNativeUrl)}},{key:"getUrlEncode",value:function(e,t){return"arraybuffer"==t?"":"utf8"}},{key:"downLoadFile",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"utf8";c.getFileInfo(e)?null!=i&&i.runWith([0]):c.downLoadFile(r.safeEncodeURI(e),t,i,n)}},{key:"remove",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;c.deleteFile("",e,t,"",0)}},{key:"removeAll",value:function(){c.deleteAll()}},{key:"hasNativeFile",value:function(e){return c.isLocalNativeFile(e)}},{key:"getFileInfo",value:function(e){return c.getFileInfo(e)}},{key:"getFileList",value:function(){return c.filesListObj}},{key:"exitMiniProgram",value:function(){r.window.my.exitMiniProgram()}},{key:"onMkdirCallBack",value:function(e,t){e?(c.fakeObj={},c.filesListObj={}):(c.filesListObj=JSON.parse(t.data),c.fakeObj=JSON.parse(t.data)||{});var i=c.fs.readdirSync(c.fileNativeDir);if(i&&i.length){var n,o,a={};for(var l in c.filesListObj)"fileUsedSize"!=l&&(a[(n=c.filesListObj[l]).md5]=n.readyUrl);for(var r=0,s=i.length;r<s;r++)if((o=i[r])!=c.fileListName){if(!a[o]){var u=c.getFileNativePath(o);c.fs.unlink({filePath:u,success:function(e){console.log("删除无引用的磁盘文件:"+o)}})}delete a[o]}for(var d in a)delete c.filesListObj[a[d]],delete c.fakeObj[a[d]],console.log("删除错误记录：",a[d])}}},{key:"pixelRatio",value:function(){if(!r.EnvConfig.pixelRatioInt)try{return r.EnvConfig.pixelRatioInt=r.systemInfo.pixelRatio,r.systemInfo.pixelRatio}catch(e){}return r.EnvConfig.pixelRatioInt}},{key:"createElement",value:function(e){if("canvas"==e){var t;if(1==r.idx){if(t=r.window.canvas.getRealCanvas(),!my.isIDE){var i=t.getContext;t.getContext=function(e){var n=i.apply(t,[e]);return n.pixelStorei(n.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),n}}}else t=r._preCreateElement(e);return!t.style&&(t.style={}),r.idx++,t}if("textarea"==e||"input"==e)return r.onCreateInput(e);if("div"==e){var n=r._preCreateElement(e);return n.contains=function(e){return null},n.removeChild=function(e){},n}return r._preCreateElement(e)}},{key:"onCreateInput",value:function(e){var t=r._preCreateElement(e);return t.focus=v.wxinputFocus,t.blur=v.wxinputblur,t.value=0,t.placeholder={},t.type={},t.setColor=function(e){},t.setType=function(e){},t.setFontFace=function(e){},t.contains=function(e){return null},t}},{key:"createShaderCondition",value:function(e){return function(){return this[e.replace("this.","")]}}}]),r}();g.IGNORE=new RegExp("[-_.!~*'();/?:@&=+$,#%]|[0-9|A-Z|a-z]"),g.safeEncodeURI=function(e){for(var t="",i=e.length,n=0;n<i;n++){var o=e[n];if(g.IGNORE.test(o))t+=o;else try{t+=encodeURI(o)}catch(e){console.log("errorInfo",">>>"+o)}}return t},g._inited=!1,g.autoCacheFile=!0,g.minClearSize=5242880,g.sizeLimit=52428800,g.nativefiles=["layaNativeDir"],g.subNativeFiles=[],g.subNativeheads=[],g.subMaps=[],g.AutoCacheDownFile=!1,g.baseDir="pages/index/",g.parseXMLFromString=function(e){var t;e=e.replace(/>\s+</g,"><");try{t=(new g.window.Parser.DOMParser).parseFromString(e,"text/xml")}catch(e){throw"需要引入xml解析库文件"}return t},g.idx=1;var _=function(e){function d(){return _classCallCheck(this,d),_possibleConstructorReturn(this,_getPrototypeOf(d).call(this))}return _inherits(d,t.EventDispatcher),_createClass(d,[{key:"on",value:function(e,t,i){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;return _get(_getPrototypeOf(d.prototype),"on",this).call(this,e,t,i,n),d.startListen(this.onDeviceOrientationChange),this}},{key:"off",value:function(e,t,i){var n=arguments.length>3&&void 0!==arguments[3]&&arguments[3];return this.hasListener(e)||d.stopListen(),_get(_getPrototypeOf(d.prototype),"off",this).call(this,e,t,i,n)}}],[{key:"__init__",value:function(){try{var e;if(!(e=t.Accelerator))return;e.prototype.on=d.prototype.on,e.prototype.off=d.prototype.off}catch(e){}}},{key:"startListen",value:function(e){if(d._callBack=e,!d._isListening){d._isListening=!0;try{g.window.my.onAccelerometerChange(d.onAccelerometerChange)}catch(e){}}}},{key:"stopListen",value:function(){d._isListening=!1;try{g.window.my.stopAccelerometer({})}catch(e){}}},{key:"onAccelerometerChange",value:function(e){var t;(t={}).acceleration=e,t.accelerationIncludingGravity=e,t.rotationRate={},null!=d._callBack&&d._callBack(t)}}]),d}();_._isListening=!1;var m=function(){function u(){_classCallCheck(this,u)}return _createClass(u,null,[{key:"__init__",value:function(){g.window.navigator.geolocation.getCurrentPosition=u.getCurrentPosition,g.window.navigator.geolocation.watchPosition=u.watchPosition,g.window.navigator.geolocation.clearWatch=u.clearWatch}},{key:"getCurrentPosition",value:function(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;arguments.length>2&&void 0!==arguments[2]&&arguments[2];(e={}).success=function(e){null!=t&&t(e)},e.fail=i,g.window.my.getLocation(e)}},{key:"watchPosition",value:function(){var e,i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;arguments.length>2&&void 0!==arguments[2]&&arguments[2];return u._curID++,(e={}).success=i,e.error=n,u._watchDic[u._curID]=e,t.Laya.systemTimer.loop(1e3,null,u._myLoop),u._curID}},{key:"clearWatch",value:function(e){delete u._watchDic[e],u._hasWatch()||t.Laya.systemTimer.clear(null,u._myLoop)}},{key:"_hasWatch",value:function(){var e;for(e in u._watchDic)if(u._watchDic[e])return!0;return!1}},{key:"_myLoop",value:function(){u.getCurrentPosition(u._mySuccess,u._myError)}},{key:"_mySuccess",value:function(e){var i,n={};for(i in n.coords=e,n.timestamp=t.Browser.now(),u._watchDic)u._watchDic[i].success&&u._watchDic[i].success(n)}},{key:"_myError",value:function(e){var t;for(t in u._watchDic)u._watchDic[t].error&&u._watchDic[t].error(e)}}]),u}();m._watchDic={},m._curID=0,e.MiniAccelerator=_,e.MiniFileMgr=c,e.MiniInput=v,e.MiniLoader=y,e.MiniLocalStorage=p,e.MiniLocation=m,e.MiniSound=h,e.MiniSoundChannel=f,e.MiniVideo=function(){function _class(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:320,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:240;_classCallCheck(this,_class),this.videoend=!1,this.videourl="",this.videoElement=g.window.my.createVideo({width:e,height:t,autoplay:!0})}return _createClass(_class,[{key:"on",value:function(e,t,i){"loadedmetadata"==e?(this.onPlayFunc=i.bind(t),this.videoElement.onPlay=this.onPlayFunction.bind(this)):"ended"==e&&(this.onEndedFunC=i.bind(t),this.videoElement.onEnded=this.onEndedFunction.bind(this)),this.videoElement.onTimeUpdate=this.onTimeUpdateFunc.bind(this)}},{key:"onTimeUpdateFunc",value:function(e){this.position=e.position,this._duration=e.duration}},{key:"onPlayFunction",value:function(){this.videoElement&&(this.videoElement.readyState=200),console.log("=====视频加载完成========"),null!=this.onPlayFunc&&this.onPlayFunc()}},{key:"onEndedFunction",value:function(){this.videoElement&&(this.videoend=!0,console.log("=====视频播放完毕========"),null!=this.onEndedFunC&&this.onEndedFunC())}},{key:"off",value:function(e,t,i){"loadedmetadata"==e?(this.onPlayFunc=i.bind(t),this.videoElement.offPlay=this.onPlayFunction.bind(this)):"ended"==e&&(this.onEndedFunC=i.bind(t),this.videoElement.offEnded=this.onEndedFunction.bind(this))}},{key:"load",value:function(e){this.videoElement&&(this.videoElement.src=e)}},{key:"play",value:function(){this.videoElement&&(this.videoend=!1,this.videoElement.play())}},{key:"pause",value:function(){this.videoElement&&(this.videoend=!0,this.videoElement.pause())}},{key:"size",value:function(e,t){this.videoElement&&(this.videoElement.width=e,this.videoElement.height=t)}},{key:"destroy",value:function(){this.videoElement&&this.videoElement.destroy(),this.videoElement=null,this.onEndedFunC=null,this.onPlayFunc=null,this.videoend=!1,this.videourl=null}},{key:"reload",value:function(){this.videoElement&&(this.videoElement.src=this.videourl)}},{key:"duration",get:function(){return this._duration}},{key:"currentTime",get:function(){return this.videoElement?this.videoElement.initialTime:0},set:function(e){this.videoElement&&(this.videoElement.initialTime=e)}},{key:"videoWidth",get:function(){return this.videoElement?this.videoElement.width:0}},{key:"videoHeight",get:function(){return this.videoElement?this.videoElement.height:0}},{key:"ended",get:function(){return this.videoend}},{key:"loop",get:function(){return!!this.videoElement&&this.videoElement.loop},set:function(e){this.videoElement&&(this.videoElement.loop=e)}},{key:"playbackRate",get:function(){return this.videoElement?this.videoElement.playbackRate:0},set:function(e){this.videoElement&&(this.videoElement.playbackRate=e)}},{key:"muted",get:function(){return!!this.videoElement&&this.videoElement.muted},set:function(e){this.videoElement&&(this.videoElement.muted=e)}},{key:"paused",get:function(){return!!this.videoElement&&this.videoElement.paused}},{key:"x",get:function(){return this.videoElement?this.videoElement.x:0},set:function(e){this.videoElement&&(this.videoElement.x=e)}},{key:"y",get:function(){return this.videoElement?this.videoElement.y:0},set:function(e){this.videoElement&&(this.videoElement.y=e)}},{key:"currentSrc",get:function(){return this.videoElement.src}}],[{key:"__init__",value:function(){}}]),_class}(),e.TBMiniAdapter=g};