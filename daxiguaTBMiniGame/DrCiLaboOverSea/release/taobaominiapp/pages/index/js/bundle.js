var window = $global.window;
var document = window.document;
var XMLHttpRequest = window.XMLHttpRequest;
var Laya = window.Laya;
var Config = window.Config;
var Config3D = window.Config3D;
var Laya3D = window.Laya3D;
var performance = window.performance;
var CANNON = window.CANNON;
"use strict";function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var a=0;a<t.length;a++){var i=t[a];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function _createClass(e,t,a){return t&&_defineProperties(e.prototype,t),a&&_defineProperties(e,a),e}function _possibleConstructorReturn(e,t){return!t||"object"!==_typeof(t)&&"function"!=typeof t?_assertThisInitialized(e):t}function _assertThisInitialized(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function _getPrototypeOf(e){return(_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&_setPrototypeOf(e,t)}function _setPrototypeOf(e,t){return(_setPrototypeOf=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}!function(){var e=function(e){function GameOverView(){return _classCallCheck(this,GameOverView),_possibleConstructorReturn(this,_getPrototypeOf(GameOverView).call(this))}return _inherits(GameOverView,Laya.Scene),_createClass(GameOverView,[{key:"onOpened",value:function(e){this.txt_Score&&(this.txt_Score.text=e.score,this.scoreDecsLabel.text="本次游戏获得的"+e.scoreName,this.remark.text="*继续挑战有机会冲刺"+e.maxLevelPrizeName,this.remark2.text="累积到一定"+e.scoreName+"可参与兑换活动",e.isMaxElement&&(this.tipsLabel.text="已合成 城野医生美肌所",this.gameOverLabel.text="游戏结束"))}}]),GameOverView}(),t=function(e){function Fruit(){var e;return _classCallCheck(this,Fruit),(e=_possibleConstructorReturn(this,_getPrototypeOf(Fruit).call(this))).xx=null,e.fruitId=-1,e.isFall=!1,e.gameManager=null,e._tween=null,e}return _inherits(Fruit,Laya.Script),_createClass(Fruit,[{key:"onAwake",value:function(){}},{key:"Init",value:function(e){this.fruitId=e,this.gameManager=this.owner.parent.getComponent(i),this._tween=new Laya.Tween}},{key:"onTriggerEnter",value:function(e,t){if(this.isFall=!0,!this.gameManager.isGameOver){if(this.fruitId>=this.gameManager.fruitPreArr.length-1)return this.gameManager.isMaxElement=!0,void Laya.stage.event("GameOver");if(null!=e.owner.getComponent(Fruit)&&e.owner.getComponent(Fruit).fruitId==this.fruitId&&t.owner.active&&e.owner.active)if(this.gameManager.addScore(this.gameManager.elementScore[this.fruitId+1]),t.owner.active=!1,e.owner.active=!1,t.owner.y>=e.owner.y){var a=t.owner.x,i=t.owner.y;this._tween.to(e.owner,{x:a,y:i},100,Laya.Ease.linearNone),Laya.timer.once(80,this,this.completeSelf,[e,t])}else{var n=e.owner.x,r=e.owner.y;this._tween.to(t.owner,{x:n,y:r},100,Laya.Ease.linearNone),Laya.timer.once(80,this,this.completeOther,[e,t])}else e.owner.getComponent(Laya.RigidBody).gravityScale=5}}},{key:"completeSelf",value:function(e,t){this._tween.clear(),t.owner.visible=!1,e.owner.visible=!1,Laya.Pool.recover("fruit"+this.fruitId.toString(),e.owner),Laya.Pool.recover("fruit"+this.fruitId.toString(),t.owner),Laya.stage.event("CreateFruit",[this.fruitId+1,t.owner.x,t.owner.y,"dynamic",5,0]),Laya.stage.event("CreateBombEffect",[this.fruitId+1,t.owner.x,t.owner.y])}},{key:"completeOther",value:function(e,t){this._tween.clear(),e.owner.visible=!1,t.owner.visible=!1,Laya.Pool.recover("fruit"+this.fruitId.toString(),e.owner),Laya.Pool.recover("fruit"+this.fruitId.toString(),t.owner),Laya.stage.event("CreateFruit",[this.fruitId+1,e.owner.x,e.owner.y,"dynamic",5,0]),Laya.stage.event("CreateBombEffect",[this.fruitId+1,e.owner.x,e.owner.y])}}]),Fruit}(),a=function GlobalGameData(e){if(_classCallCheck(this,GlobalGameData),"object"===_typeof(GlobalGameData.instance))return GlobalGameData.instance;GlobalGameData.instance=this,this.isNewPlayer=e.isNewPlayer,this.scoreName=e.scoreName,this.maxLevelPrizeName=e.maxlevelPrizeName},i=function(e){function GameManager(){var e;return _classCallCheck(this,GameManager),(e=_possibleConstructorReturn(this,_getPrototypeOf(GameManager).call(this))).targetLine=null,e.scoreSprit=null,e.gameOverPanel=null,e.curFruit=null,e.isMouseDown=!1,e.bombEffectPre=null,e.isGameOver=!1,e.score=0,e.isMaxElement=!1,e.bombData=[],e.destroyFruitArray=[],e.fruitPreArr=new Array,e.initFruitElement=[{url:"prefab/element_01.json",type:Laya.Loader.PREFAB},{url:"prefab/element_02.json",type:Laya.Loader.PREFAB},{url:"prefab/element_03.json",type:Laya.Loader.PREFAB},{url:"prefab/element_04.json",type:Laya.Loader.PREFAB},{url:"prefab/element_05.json",type:Laya.Loader.PREFAB},{url:"prefab/element_06.json",type:Laya.Loader.PREFAB},{url:"prefab/element_07.json",type:Laya.Loader.PREFAB},{url:"prefab/element_08.json",type:Laya.Loader.PREFAB},{url:"prefab/element_09.json",type:Laya.Loader.PREFAB}],e.elementScore=[0,5,10,20,30,40,50,60,100],e.globalData=null,e.effectIndex=0,e}return _inherits(GameManager,Laya.Script),_createClass(GameManager,[{key:"onAwake",value:function(){this.globalData=new a,this.scoreSprit.getChildByName("scoreName").text=this.globalData.scoreName,this.targetLine.visible=!1,this.loadFruitElement(),Laya.stage.on("CreateBombEffect",this,this.createBombEffect),this.gameOverEvent(),this.createFruitEvent(),Laya.stage.on(Laya.Event.MOUSE_DOWN,this,this.mouseDown),Laya.stage.on(Laya.Event.MOUSE_UP,this,this.mouseUp),Laya.stage.on(Laya.Event.MOUSE_MOVE,this,this.mouseMove)}},{key:"loadFruitElement",value:function(){var e=this.initFruitElement;Laya.loader.load(e,Laya.Handler.create(this,function(t){for(var a=0;a<e.length;a++)this.fruitPreArr[a]=Laya.loader.getRes(e[a].url);this.curFruit=this.randomCreateFruit(this.owner.width/2,280)})),Laya.loader.load("prefab/bomb.json",Laya.Handler.create(this,function(e){this.bombEffectPre=e}),null,Laya.Loader.PREFAB),Laya.loader.load("res/atlas/effect.atlas",Laya.Handler.create(this,function(e){}),null,Laya.Loader.ATLAS)}},{key:"gameOverEvent",value:function(){var e=this;Laya.stage.on("GameOver",this,function(){e.isGameOver=!0,e.getAllFruit(),e.playBombAni()})}},{key:"getAllFruit",value:function(){var e=this;this.destroyFruitArray=[],this.effectArray=[];for(var a=0;a<this.owner.numChildren;a++){var i=this.owner.getChildAt(a);if(null!=i.getComponent(t)&&i.visible){this.destroyFruitArray.push(i);var n=Laya.Pool.getItemByCreateFun("BombEffect",function(){return this.bombEffectPre.create()},this);this.effectIndex+=1,n.name=this.effectIndex.toString(),n.visible=!1,n.active=!1,n.pos(i.x,i.y),n.on(Laya.Event.COMPLETE,this,function(){e.onEffectPlayComplete(n)}),this.owner.addChild(n),this.effectArray.push(n)}}}},{key:"playBombAni",value:function(){if(this.destroyFruitArray.length>0){var e=this.effectArray.pop();e.visible=!0,e.active=!0,e.play(7,!1)}else this.openGameOverView()}},{key:"onEffectPlayComplete",value:function(e){if(0!=this.destroyFruitArray.length){e.off(Laya.Event.COMPLETE,this,this.onEffectPlayComplete);var a=this.destroyFruitArray.pop();e.visible=!1,e.active=!1,e.removeSelf(),a&&(a.visible=!1,a.active=!1,a.removeSelf(),Laya.Pool.recover("fruit"+a.getComponent(t).fruitId.toString(),a)),e.name="0",Laya.Pool.recover("BombEffect",e),this.playBombAni()}}},{key:"openGameOverView",value:function(){var e=this,t={};t.scoreName=this.globalData.scoreName,t.maxLevelPrizeName=this.globalData.maxLevelPrizeName,t.score=this.score,t.isMaxElement=this.isMaxElement,Laya.Scene.open("GameOver.json",!1,t,Laya.Handler.create(this,function(t){e.gameOverPanel=t,e.playAgainEvent(),e.goHomeEvent(),window.platform.updateScore(e.score)}))}},{key:"playAgainEvent",value:function(){this.gameOverPanel.getChildByName("gameOverBox").getChildByName("playAgainBtn").on(Laya.Event.CLICK,this,this.playAgain)}},{key:"playAgain",value:function(){var e=this;window.platform.getRest().then(function(a){if(1==a.success){e.gameOverPanel.visible=!1,e.addScore(-e.score);for(var i=0;i<e.owner.numChildren;i++){var n=e.owner.getChildAt(i);null!=n.getComponent(t)&&n.visible&&(n.visible=!1,n.active=!1,Laya.Pool.recover("fruit"+n.getComponent(t).fruitId.toString(),n))}e.isGameOver=!1,e.targetLine.visible=!1,e.curFruit=e.randomCreateFruit(e.owner.width/2,280),e.removePlayAgainEvent(),e.removeGoHomeEvent(),e.gameOverPanel.close()}})}},{key:"removePlayAgainEvent",value:function(){this.gameOverPanel.getChildByName("gameOverBox").getChildByName("playAgainBtn").off(Laya.Event.CLICK,this,this.playAgain)}},{key:"goHomeEvent",value:function(){this.gameOverPanel.getChildByName("gameOverBox").getChildByName("closeBtn").on(Laya.Event.CLICK,this,this.goHome)}},{key:"goHome",value:function(){this.addScore(-this.score);for(var e=0;e<this.owner.numChildren;e++){var a=this.owner.getChildAt(e);null!=a.getComponent(t)&&a.visible&&(a.visible=!1,a.active=!1,Laya.Pool.recover("fruit"+a.getComponent(t).fruitId.toString(),a))}this.removePlayAgainEvent(),this.removeGoHomeEvent(),this.gameOverPanel.close(),Laya.Browser.onTBMiniGame?window.platform.goHome():console.log("goHome")}},{key:"removeGoHomeEvent",value:function(){this.gameOverPanel.getChildByName("gameOverBox").getChildByName("closeBtn").off(Laya.Event.CLICK,this,this.goHome)}},{key:"createFruitEvent",value:function(){Laya.stage.on("CreateFruit",this,function(e,a,i,n,r,o){this.createFruit(e,a,i,n,r,o).getComponent(t).isFall=!0})}},{key:"mouseDown",value:function(e){this.isGameOver||(this.isMouseDown=!0,null!=this.curFruit&&(this.curFruit.x=Laya.stage.mouseX,this.targetLine.x=Laya.stage.mouseX))}},{key:"mouseUp",value:function(){this.isGameOver||null!=this.curFruit&&this.playMoveFruitXAni(this.curFruit)}},{key:"playMoveFruitXAni",value:function(e){var t=this;null!=this.curFruit&&this.isMouseDown&&(this.isMouseDown=!1,this.fallDownFruit(),this.curFruit=null,this.targetLine.visible=!1,Laya.timer.once(800,this,function(){t.isGameOver||(t.curFruit=t.randomCreateFruit(t.owner.width/2,280))}))}},{key:"fallDownFruit",value:function(){this.curFruit.getComponent(Laya.RigidBody).gravityScale=1,this.curFruit.getComponent(Laya.RigidBody).type="dynamic",this.curFruit.getComponent(Laya.RigidBody).linearVelocity={x:0,y:30},this.curFruit.getComponent(Laya.RigidBody).bullet=!1,this.curFruit.getComponent(Laya.RigidBody).allowSleep=!1,this.curFruit.getComponent(Laya.CircleCollider).friction=1,this.curFruit.getComponent(Laya.CircleCollider).restitution=.2}},{key:"mouseMove",value:function(e){this.isGameOver||null!=this.curFruit&&this.isMouseDown&&(this.curFruit.x=e.stageX,this.targetLine.pos(this.curFruit.x,this.curFruit.y),this.curFruit.x<this.curFruit.width/2&&(this.curFruit.x=this.curFruit.width/2),this.curFruit.x>this.owner.width-this.curFruit.width/2&&(this.curFruit.x=this.owner.width-this.curFruit.width/2))}},{key:"createFruit",value:function(e,a,i){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"static",r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,s=Laya.Pool.getItemByCreateFun("fruit"+e.toString(),function(){return this.fruitPreArr[e].create()},this);return s.active=!0,s.visible=!0,this.owner.addChild(s),s.getComponent(Laya.RigidBody).gravityScale=r,s.getComponent(Laya.RigidBody).angularDampin=.1,s.getComponent(Laya.RigidBody).bullet=!1,s.getComponent(Laya.RigidBody).allowSleep=!1,s.getComponent(Laya.RigidBody).friction=1,s.getComponent(Laya.RigidBody).angularVelocity=o,s.getComponent(Laya.RigidBody).type=n,s.pos(a,i),s.getComponent(t).Init(e),s}},{key:"createBombEffect",value:function(e,t,a){var i=Laya.Pool.getItemByCreateFun("BombEffect",function(){return this.effectIndex+=1,this.bombEffectPre.name=this.effectIndex.toString(),this.bombEffectPre.create()},this);this.owner.addChild(i),i.visible=!0,i.active=!0,i.pos(t,a),i.play(0,!1),Laya.timer.once(500,this,function(){i.visible=!1,i.active=!1,i.name="0",Laya.Pool.recover("BombEffect",i)})}},{key:"randomCreateFruit",value:function(e,a){if(!this.isGameOver){this.targetLine.pos(e,a);var i=this.getRandomValue(0,5);a=this.owner.getChildByName("GameOverLine").y-this.fruitPreArr[i].json.props.height/2-20;var n=this.createFruit(i,e,a);return n.getComponent(t).isFall=!1,n}}},{key:"getRandomValue",value:function(e,t){var a=Math.random()*(t-e-1);return(a=Math.round(a))+e}},{key:"addScore",value:function(e){this.score+=e,this.scoreSprit.getChildByName("scoreText").text=this.score}}]),GameManager}(),n=function(e){function CheckWarning(){var e;return _classCallCheck(this,CheckWarning),(e=_possibleConstructorReturn(this,_getPrototypeOf(CheckWarning).call(this))).warningText=null,e.reduce=!1,e.add=!1,e.warningDelayTime=1,e}return _inherits(CheckWarning,Laya.Script),_createClass(CheckWarning,[{key:"onAwake",value:function(){}},{key:"onUpdate",value:function(){}},{key:"textAnimation",value:function(){this.warningText.alpha>=1&&(this.reduce=!0,this.add=!1),this.warningText.alpha<=0&&(this.reduce=!1,this.add=!0),this.reduce&&(this.warningText.alpha-=.05),this.add&&(this.warningText.alpha+=.05)}}]),CheckWarning}(),r=function(e){function CheckGameOver(){var e;return _classCallCheck(this,CheckGameOver),(e=_possibleConstructorReturn(this,_getPrototypeOf(CheckGameOver).call(this))).xx=null,e.GameOverLine=null,e.warningDelayTime=1,e}return _inherits(CheckGameOver,Laya.Script),_createClass(CheckGameOver,[{key:"onAwake",value:function(){this.GameOverLine.y=Laya.stage.height/2-300}},{key:"onUpdate",value:function(){if(!this.owner.parent.getComponent(i).isGameOver){if(this.warningDelayTime<=0)return this.warningDelayTime=1,void Laya.stage.event("GameOver");for(var e=0;e<this.owner.parent.numChildren;e++){var a=this.owner.parent.getChildAt(e);if(a.visible&&null!=a.getComponent(t)&&a.getComponent(t).isFall&&Math.abs(this.owner.y-a.y)<a.width/2)return void(this.warningDelayTime-=Laya.timer.delta/1e3)}this.warningDelayTime=1}}}]),CheckGameOver}(),o=function(e){function FixScreen(){var e;return _classCallCheck(this,FixScreen),(e=_possibleConstructorReturn(this,_getPrototypeOf(FixScreen).call(this))).collider_Down=null,e.collider_Right=null,e.collider_Left=null,e.bg=null,e.disableMouse=null,e}return _inherits(FixScreen,Laya.Script),_createClass(FixScreen,[{key:"onAwake",value:function(){this.collider_Down.y=Laya.stage.height-80,this.collider_Down.getComponent(Laya.BoxCollider).width=Laya.stage.width,this.collider_Right.getComponent(Laya.BoxCollider).height=Laya.stage.height,this.collider_Left.getComponent(Laya.BoxCollider).height=Laya.stage.height,this.bg.height=Laya.stage.height,null!=this.disableMouse&&(this.disableMouse.y=Laya.stage.height-120,this.disableMouse.on(Laya.Event.MOUSE_DOWN,this,this.disableMouseEvent))}},{key:"onDisable",value:function(){null!=this.disableMouse&&this.disableMouse.off(Laya.Event.MOUSE_DOWN,this,this.disableMouseEvent)}},{key:"disableMouseEvent",value:function(e){e.stopPropagation()}}]),FixScreen}(),s=function(e){function Guide(){var e;return _classCallCheck(this,Guide),(e=_possibleConstructorReturn(this,_getPrototypeOf(Guide).call(this))).nextStepBtn=null,e.startGameBtn=null,e.skipBtn=null,e.stepBg=null,e.dotStep=null,e.initStep=1,e}return _inherits(Guide,Laya.Script),_createClass(Guide,[{key:"onAwake",value:function(){this.skipBtn.on(Laya.Event.CLICK,this,this.startGame),this.nextStepBtn.on(Laya.Event.CLICK,this,this.nextStep),this.startGameBtn.on(Laya.Event.CLICK,this,this.startGame)}},{key:"startGame",value:function(){Laya.Scene.open("Main.scene")}},{key:"nextStep",value:function(){this.initStep++,3==this.initStep&&(this.nextStepBtn.visible=!1,this.startGameBtn.visible=!0),this.dotStep.skin="res/dot_"+this.initStep+".png",this.stepBg.skin="res/step_"+this.initStep+".png"}}]),Guide}(),l=function(){function GameConfig(){_classCallCheck(this,GameConfig)}return _createClass(GameConfig,null,[{key:"init",value:function(){var a=Laya.ClassUtils.regClass;a("scripts/GameOverView.js",e),a("scripts/GameManager.js",i),a("scripts/CheckWarning.js",n),a("scripts/CheckGameOver.js",r),a("scripts/FixScreen.js",o),a("scripts/Guide.js",s),a("scripts/Fruit.js",t)}}]),GameConfig}();l.width=750,l.height=1624,l.scaleMode="fixedwidth",l.screenMode="vertical",l.alignV="middle",l.alignH="center",l.startScene="Main.scene",l.sceneRoot="",l.debug=!1,l.stat=!1,l.physicsDebug=!1,l.exportSceneToJson=!0,l.init(),new(function(){function Main(){_classCallCheck(this,Main),window.Laya3D?Laya3D.init(l.width,l.height):Laya.init(l.width,l.height,Laya.WebGL),Laya.Physics&&Laya.Physics.enable(),Laya.DebugPanel&&Laya.DebugPanel.enable(),Laya.stage.scaleMode=l.scaleMode,Laya.stage.screenMode=l.screenMode,Laya.stage.alignV=l.alignV,Laya.stage.alignH=l.alignH,Laya.stage.bgColor="#FFFFFF",Laya.URL.exportSceneToJson=l.exportSceneToJson,(l.debug||"true"==Laya.Utils.getQueryString("debug"))&&Laya.enableDebugPanel(),l.physicsDebug&&Laya.PhysicsDebugDraw&&Laya.PhysicsDebugDraw.enable(),l.stat&&Laya.Stat.show(),Laya.alertGlobalError(!0),Laya.ResourceVersion.enable("version.json",Laya.Handler.create(this,this.onVersionLoaded),Laya.ResourceVersion.FILENAME_VERSION)}return _createClass(Main,[{key:"onVersionLoaded",value:function(){Laya.AtlasInfoManager.enable("fileconfig.json",Laya.Handler.create(this,this.onConfigLoaded))}},{key:"onConfigLoaded",value:function(){Laya.loader.load("res/atlas/res.atlas",Laya.Handler.create(this,this.onStartGame),null,Laya.Loader.ATLAS)}},{key:"onStartGame",value:function(){window.platform.doInitActivity().then(function(e){e.success?(new a(e),e.isNewPlayer?Laya.Scene.open("NewGuide.scene"):Laya.Scene.open(l.startScene)):console.log("doInitActivity data return false")},function(e){console.log("doInitActivity data error")})}}]),Main}())}();