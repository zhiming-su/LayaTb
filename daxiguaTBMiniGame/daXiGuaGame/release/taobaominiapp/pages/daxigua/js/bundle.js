var window = $global.window;
var document = window.document;
var XMLHttpRequest = window.XMLHttpRequest;
var Laya = window.Laya;
var Config = window.Config;
var Config3D = window.Config3D;
var Laya3D = window.Laya3D;
var performance = window.performance;
var CANNON = window.CANNON;
"use strict";function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var a=0;a<t.length;a++){var i=t[a];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function _createClass(e,t,a){return t&&_defineProperties(e.prototype,t),a&&_defineProperties(e,a),e}function _possibleConstructorReturn(e,t){return!t||"object"!==_typeof(t)&&"function"!=typeof t?_assertThisInitialized(e):t}function _assertThisInitialized(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function _getPrototypeOf(e){return(_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&_setPrototypeOf(e,t)}function _setPrototypeOf(e,t){return(_setPrototypeOf=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}!function(){var e=function(e){function GameOverView(){return _classCallCheck(this,GameOverView),_possibleConstructorReturn(this,_getPrototypeOf(GameOverView).call(this))}return _inherits(GameOverView,Laya.Scene),_createClass(GameOverView,[{key:"onOpened",value:function(e){this.txt_Score&&(this.txt_Score.text=e)}}]),GameOverView}(),t=function(e){function Fruit(){var e;return _classCallCheck(this,Fruit),(e=_possibleConstructorReturn(this,_getPrototypeOf(Fruit).call(this))).xx=null,e.fruitId=-1,e.isFall=!1,e.gameManager=null,e._tween=null,e}return _inherits(Fruit,Laya.Script),_createClass(Fruit,[{key:"onAwake",value:function(){}},{key:"Init",value:function(e){this.fruitId=e,this.gameManager=this.owner.parent.getComponent(a),this._tween=new Laya.Tween}},{key:"onTriggerEnter",value:function(e,t){if(this.isFall=!0,!this.gameManager.isGameOver){if(this.fruitId>=this.gameManager.fruitPreArr.length-1)return this.gameManager.gameSound("res/sounds/victory.mp3"),this.gameManager.addScore(this.gameManager.extraScore),void Laya.stage.event("GameOver");if(null!=e.owner.getComponent(Fruit)&&e.owner.getComponent(Fruit).fruitId==this.fruitId&&t.owner.active&&e.owner.active)if(this.gameManager.addScore(2*(this.fruitId+1)),this.gameManager.gameSound("res/sounds/bomb.wav"),t.owner.active=!1,e.owner.active=!1,t.owner.y>=e.owner.y){var a=t.owner.x,i=t.owner.y;this._tween.to(e.owner,{x:a,y:i},100,Laya.Ease.linearNone),Laya.timer.once(80,this,this.completeSelf,[e,t])}else{var n=e.owner.x,r=e.owner.y;this._tween.to(t.owner,{x:n,y:r},100,Laya.Ease.linearNone),Laya.timer.once(80,this,this.completeOther,[e,t])}else e.owner.getComponent(Laya.RigidBody).gravityScale=5,e.owner.getComponent(Laya.RigidBody).linearDamping=5,e.owner.getComponent(Laya.RigidBody).angularDampin=2}}},{key:"completeSelf",value:function(e,t){this._tween.clear(),t.owner.visible=!1,e.owner.visible=!1,Laya.Pool.recover("fruit"+this.fruitId.toString(),e.owner),Laya.Pool.recover("fruit"+this.fruitId.toString(),t.owner),Laya.stage.event("CreateFruit",[this.fruitId+1,t.owner.x,t.owner.y,"dynamic",5,0]),Laya.stage.event("CreateBombEffect",[this.fruitId+1,t.owner.x,t.owner.y])}},{key:"completeOther",value:function(e,t){this._tween.clear(),e.owner.visible=!1,t.owner.visible=!1,Laya.Pool.recover("fruit"+this.fruitId.toString(),e.owner),Laya.Pool.recover("fruit"+this.fruitId.toString(),t.owner),Laya.stage.event("CreateFruit",[this.fruitId+1,e.owner.x,e.owner.y,"dynamic",5,0]),Laya.stage.event("CreateBombEffect",[this.fruitId+1,e.owner.x,e.owner.y])}}]),Fruit}(),a=function(e){function GameManager(){var e;return _classCallCheck(this,GameManager),(e=_possibleConstructorReturn(this,_getPrototypeOf(GameManager).call(this))).targetLine=null,e.scoreSprit=null,e.voiceState=null,e.gameOverPanel=null,e.curFruit=null,e.isMouseDown=!1,e.bombEffectPre=null,e.isGameOver=!1,e.isOpenSound=!0,e.extraScore=500,e.score=0,e.fruitPreArr=new Array,e.initFruitElement=[{url:"prefab/gold.json",type:Laya.Loader.PREFAB},{url:"prefab/coupon.json",type:Laya.Loader.PREFAB},{url:"prefab/redpacket.json",type:Laya.Loader.PREFAB},{url:"prefab/vipcard.json",type:Laya.Loader.PREFAB},{url:"prefab/blessbag.json",type:Laya.Loader.PREFAB},{url:"prefab/alipay.json",type:Laya.Loader.PREFAB},{url:"prefab/shopbag.json",type:Laya.Loader.PREFAB},{url:"prefab/giftbox.json",type:Laya.Loader.PREFAB},{url:"prefab/chestbox.json",type:Laya.Loader.PREFAB}],e}return _inherits(GameManager,Laya.Script),_createClass(GameManager,[{key:"onAwake",value:function(){this.targetLine.visible=!1,this.loadFruitElement(),Laya.stage.on("CreateBombEffect",this,this.createBombEffect),this.gameOverEvent(),this.changeVoiceState(),this.createFruitEvent(),Laya.stage.on(Laya.Event.MOUSE_DOWN,this,this.mouseDown),Laya.stage.on(Laya.Event.MOUSE_UP,this,this.mouseUp),Laya.stage.on(Laya.Event.MOUSE_MOVE,this,this.mouseMove)}},{key:"changeVoiceState",value:function(){this.voiceState.on(Laya.Event.CLICK,this,function(){this.isOpenSound=!this.isOpenSound,this.isOpenSound?this.voiceState.skin="res/voice.png":this.voiceState.skin="res/voice_close.png"})}},{key:"loadFruitElement",value:function(){var e=this.initFruitElement;Laya.loader.load(e,Laya.Handler.create(this,function(t){for(var a=0;a<e.length;a++)this.fruitPreArr[a]=Laya.loader.getRes(e[a].url);this.curFruit=this.randomCreateFruit(this.owner.width/2,280)})),Laya.loader.load("prefab/bomb.json",Laya.Handler.create(this,function(e){this.bombEffectPre=e}),null,Laya.Loader.PREFAB),Laya.loader.load("res/atlas/effect.atlas",Laya.Handler.create(this,function(e){}),null,Laya.Loader.ATLAS)}},{key:"gameOverEvent",value:function(){var e=this;Laya.stage.on("GameOver",this,function(){e.isGameOver=!0,Laya.Scene.open("GameOver.json",!1,e.score,Laya.Handler.create(e,function(t){e.gameOverPanel=t,e.playAgainEvent(),e.goHomeEvent(),window.platform.updateScore(e.score)}))})}},{key:"playAgainEvent",value:function(){this.gameOverPanel.getChildByName("gameOverBox").getChildByName("playAgainBtn").on(Laya.Event.CLICK,this,this.playAgain)}},{key:"playAgain",value:function(){var e=this;window.platform.getRest().then(function(a){if(1==a.success){e.gameOverPanel.visible=!1,e.addScore(-e.score);for(var i=0;i<e.owner.numChildren;i++){var n=e.owner.getChildAt(i);null!=n.getComponent(t)&&n.visible&&(n.visible=!1,n.active=!1,Laya.Pool.recover("fruit"+n.getComponent(t).fruitId.toString(),n))}e.isGameOver=!1,e.targetLine.visible=!1,e.curFruit=e.randomCreateFruit(e.owner.width/2,280),e.removePlayAgainEvent(),e.removeGoHomeEvent(),e.gameOverPanel.close()}})}},{key:"removePlayAgainEvent",value:function(){this.gameOverPanel.getChildByName("gameOverBox").getChildByName("playAgainBtn").off(Laya.Event.CLICK,this,this.playAgain)}},{key:"goHomeEvent",value:function(){this.gameOverPanel.getChildByName("gameOverBox").getChildByName("closeBtn").on(Laya.Event.CLICK,this,this.goHome)}},{key:"goHome",value:function(){this.addScore(-this.score);for(var e=0;e<this.owner.numChildren;e++){var a=this.owner.getChildAt(e);null!=a.getComponent(t)&&a.visible&&(a.visible=!1,a.active=!1,Laya.Pool.recover("fruit"+a.getComponent(t).fruitId.toString(),a))}this.removePlayAgainEvent(),this.removeGoHomeEvent(),this.gameOverPanel.close(),Laya.Browser.onTBMiniGame?window.platform.goHome():console.log("goHome")}},{key:"removeGoHomeEvent",value:function(){this.gameOverPanel.getChildByName("gameOverBox").getChildByName("closeBtn").off(Laya.Event.CLICK,this,this.goHome)}},{key:"createFruitEvent",value:function(){Laya.stage.on("CreateFruit",this,function(e,a,i,n,r,o){this.createFruit(e,a,i,n,r,o).getComponent(t).isFall=!0})}},{key:"mouseDown",value:function(e){this.isGameOver||"voiceState"!=e.target.name&&(this.isMouseDown=!0,null!=this.curFruit&&(this.curFruit.x=Laya.stage.mouseX,this.targetLine.x=Laya.stage.mouseX))}},{key:"mouseUp",value:function(){this.isGameOver||null!=this.curFruit&&(this.gameSound("res/sounds/spawn.mp3"),this.playMoveFruitXAni(this.curFruit))}},{key:"playMoveFruitXAni",value:function(e){var t=this;null!=this.curFruit&&this.isMouseDown&&(this.isMouseDown=!1,this.fallDownFruit(),this.curFruit=null,this.targetLine.visible=!1,Laya.timer.once(800,this,function(){t.isGameOver||(t.curFruit=t.randomCreateFruit(t.owner.width/2,280))}))}},{key:"fallDownFruit",value:function(){this.curFruit.getComponent(Laya.RigidBody).gravityScale=1,this.curFruit.getComponent(Laya.RigidBody).type="dynamic",this.curFruit.getComponent(Laya.RigidBody).linearVelocity={x:0,y:30},this.curFruit.getComponent(Laya.RigidBody).linearDamping=.05,this.curFruit.getComponent(Laya.RigidBody).angularDampin=.1,this.curFruit.getComponent(Laya.RigidBody).bullet=!1,this.curFruit.getComponent(Laya.RigidBody).allowSleep=!1,this.curFruit.getComponent(Laya.CircleCollider).friction=1,this.curFruit.getComponent(Laya.CircleCollider).restitution=.1}},{key:"mouseMove",value:function(e){this.isGameOver||null!=this.curFruit&&this.isMouseDown&&(this.curFruit.x=e.stageX,this.targetLine.pos(this.curFruit.x,this.curFruit.y),this.curFruit.x<this.curFruit.width/2&&(this.curFruit.x=this.curFruit.width/2),this.curFruit.x>this.owner.width-this.curFruit.width/2&&(this.curFruit.x=this.owner.width-this.curFruit.width/2))}},{key:"createFruit",value:function(e,a,i){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"static",r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,s=Laya.Pool.getItemByCreateFun("fruit"+e.toString(),function(){return this.fruitPreArr[e].create()},this);return s.active=!0,s.visible=!0,this.owner.addChild(s),s.getComponent(Laya.RigidBody).gravityScale=r,s.getComponent(Laya.RigidBody).angularDampin=.1,s.getComponent(Laya.RigidBody).bullet=!1,s.getComponent(Laya.RigidBody).allowSleep=!1,s.getComponent(Laya.RigidBody).friction=1,s.getComponent(Laya.RigidBody).angularVelocity=o,s.getComponent(Laya.RigidBody).type=n,s.pos(a,i),s.getComponent(t).Init(e),s}},{key:"createBombEffect",value:function(e,t,a){var i=Laya.Pool.getItemByCreateFun("BombEffect",function(){return this.bombEffectPre.create()},this);this.owner.addChild(i),i.visible=!0,i.active=!0,i.pos(t,a),i.scaleX=.15*(e+1),i.scaleY=.15*(e+1),i.play(0,!1),Laya.timer.once(500,this,function(){i.visible=!1,i.active=!1,Laya.Pool.recover("BombEffect",i)})}},{key:"randomCreateFruit",value:function(e,a){this.targetLine.pos(e,a);var i=this.getRandomValue(0,5);a=this.owner.getChildByName("GameOverLine").y-this.fruitPreArr[i].json.props.height/2-20;var n=this.createFruit(i,e,a);return n.getComponent(t).isFall=!1,n}},{key:"getRandomValue",value:function(e,t){var a=Math.random()*(t-e-1);return(a=Math.round(a))+e}},{key:"addScore",value:function(e){this.score+=e,this.scoreSprit.getChildByName("scoreText").text=this.score}},{key:"gameSound",value:function(e){this.isOpenSound&&(Laya.Browser.onTBMiniGame?window.platform.playSound(e):Laya.SoundManager.playSound(e,1))}}]),GameManager}(),i=function(e){function CheckWarning(){var e;return _classCallCheck(this,CheckWarning),(e=_possibleConstructorReturn(this,_getPrototypeOf(CheckWarning).call(this))).warningText=null,e.reduce=!1,e.add=!1,e.warningDelayTime=1,e}return _inherits(CheckWarning,Laya.Script),_createClass(CheckWarning,[{key:"onAwake",value:function(){}},{key:"onUpdate",value:function(){}},{key:"textAnimation",value:function(){this.warningText.alpha>=1&&(this.reduce=!0,this.add=!1),this.warningText.alpha<=0&&(this.reduce=!1,this.add=!0),this.reduce&&(this.warningText.alpha-=.05),this.add&&(this.warningText.alpha+=.05)}}]),CheckWarning}(),n=function(e){function CheckGameOver(){var e;return _classCallCheck(this,CheckGameOver),(e=_possibleConstructorReturn(this,_getPrototypeOf(CheckGameOver).call(this))).xx=null,e.warningDelayTime=1,e}return _inherits(CheckGameOver,Laya.Script),_createClass(CheckGameOver,[{key:"onUpdate",value:function(){if(!this.owner.parent.getComponent(a).isGameOver){if(this.warningDelayTime<=0)return this.warningDelayTime=1,void Laya.stage.event("GameOver");for(var e=0;e<this.owner.parent.numChildren;e++){var i=this.owner.parent.getChildAt(e);if(i.visible&&null!=i.getComponent(t)&&i.getComponent(t).isFall&&Math.abs(this.owner.y-i.y)<i.width/2)return void(this.warningDelayTime-=Laya.timer.delta/1e3)}this.warningDelayTime=1}}}]),CheckGameOver}(),r=function(e){function FixScreen(){var e;return _classCallCheck(this,FixScreen),(e=_possibleConstructorReturn(this,_getPrototypeOf(FixScreen).call(this))).collider_Down=null,e.collider_Right=null,e.collider_Left=null,e.bg=null,e}return _inherits(FixScreen,Laya.Script),_createClass(FixScreen,[{key:"onAwake",value:function(){this.collider_Down.y=Laya.stage.height-100,this.collider_Down.getComponent(Laya.BoxCollider).width=Laya.stage.width,this.collider_Right.getComponent(Laya.BoxCollider).height=Laya.stage.height,this.collider_Left.getComponent(Laya.BoxCollider).height=Laya.stage.height,this.bg.height=Laya.stage.height}}]),FixScreen}(),o=function(){function GameConfig(){_classCallCheck(this,GameConfig)}return _createClass(GameConfig,null,[{key:"init",value:function(){var o=Laya.ClassUtils.regClass;o("scripts/GameOverView.js",e),o("scripts/GameManager.js",a),o("scripts/CheckWarning.js",i),o("scripts/CheckGameOver.js",n),o("scripts/FixScreen.js",r),o("scripts/Fruit.js",t)}}]),GameConfig}();o.width=750,o.height=1334,o.scaleMode="fixedwidth",o.screenMode="vertical",o.alignV="middle",o.alignH="center",o.startScene="Main.scene",o.sceneRoot="",o.debug=!1,o.stat=!1,o.physicsDebug=!1,o.exportSceneToJson=!0,o.init(),new(function(){function Main(){_classCallCheck(this,Main),window.Laya3D?Laya3D.init(o.width,o.height):Laya.init(o.width,o.height,Laya.WebGL),Laya.Physics&&Laya.Physics.enable(),Laya.DebugPanel&&Laya.DebugPanel.enable(),Laya.stage.scaleMode=o.scaleMode,Laya.stage.screenMode=o.screenMode,Laya.stage.alignV=o.alignV,Laya.stage.alignH=o.alignH,Laya.stage.bgColor="#FFFFFF",Laya.URL.exportSceneToJson=o.exportSceneToJson,Laya.URL.basePath="https://draw-mb.oss-cn-zhangjiakou.aliyuncs.com/laya/compose/v1.0.0/",(o.debug||"true"==Laya.Utils.getQueryString("debug"))&&Laya.enableDebugPanel(),o.physicsDebug&&Laya.PhysicsDebugDraw&&Laya.PhysicsDebugDraw.enable(),o.stat&&Laya.Stat.show(),Laya.alertGlobalError(!0),Laya.ResourceVersion.enable("version.json",Laya.Handler.create(this,this.onVersionLoaded),Laya.ResourceVersion.FILENAME_VERSION)}return _createClass(Main,[{key:"onVersionLoaded",value:function(){Laya.AtlasInfoManager.enable("fileconfig.json",Laya.Handler.create(this,this.onConfigLoaded))}},{key:"onConfigLoaded",value:function(){o.startScene&&Laya.Scene.open(o.startScene)}}]),Main}())}();